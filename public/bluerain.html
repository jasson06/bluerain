<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blue Rain Real Estate | Portfolio</title>
  <meta name="description" content="Browse properties, units, photos, and availability. Apply online." />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400&display=swap" rel="stylesheet">
  <!-- Leaflet CSS for map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">

  <style>
    :root{
      --bg:#0b0d10;
      --text:#eaf0f7;
      --muted:#a9b4c2;
      --line:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --shadow2: 0 12px 40px rgba(0,0,0,.45);
      --accent:#cbb58b;
      --accent2:#6ee7ff;
      --good:#6ee7ff;
      --warn:#cbb58b;
      --bad:#ff7a7a;
      --radius:18px;
      --radius2:26px;
      --max:1370px;
    }
    *{box-sizing:border-box}
    .material-symbols-outlined{
      font-family:'Material Symbols Outlined';
      font-weight:400;
      font-style:normal;
      font-size:18px;
      line-height:1;
      letter-spacing:normal;
      text-transform:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      -webkit-font-smoothing:antialiased;
    }
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(203,181,139,.18), transparent 60%),
        radial-gradient(700px 500px at 90% 10%, rgba(110,231,255,.12), transparent 55%),
        linear-gradient(180deg, #07090c, var(--bg));
      color:var(--text);
      letter-spacing:-0.01em;
    }
    /* Dim background when modal is open (without affecting modal itself) */
    body.modal-open .topbar,
    body.modal-open main,
    body.modal-open footer{
      filter: brightness(.78) contrast(.98) saturate(.9);
      transition: filter .2s ease;
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:var(--max);margin:0 auto;padding:0 22px}

    .topbar{
      position:sticky;top:0;z-index:50;
      background: rgba(11,13,16,.88);
      border-bottom:1px solid var(--line);
      contain: paint;
    }
    .topbar-inner{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 0; gap:5px;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:220px}
    .logo{
      width:40px;height:40px;border-radius:12px;
      background: linear-gradient(135deg, rgba(203,181,139,.95), rgba(110,231,255,.30));
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
      position:relative; overflow:hidden;
    }
    .logo::after{
      content:""; position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), transparent 55%);
      transform: rotate(18deg);
    }
    .brand h1{font-size:14px;margin:0;font-weight:700;letter-spacing:.08em;text-transform:uppercase}
    .brand p{margin:2px 0 0 0;font-size:12px;color:var(--muted)}

    nav{display:flex;align-items:center;gap:18px}
    nav a{
      font-size:13px;color:var(--muted);
      padding:10px 10px;border-radius:12px;
      transition:.2s ease;
    }
    nav a:hover{color:var(--text);background:rgba(255,255,255,.06)}

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;border-radius:14px;
      font-size:13px;font-weight:600;
      transition:.2s ease;
      display:inline-flex;align-items:center;gap:8px;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.07)}
    .btn.primary{
      border-color: rgba(203,181,139,.35);
      background: linear-gradient(135deg, rgba(203,181,139,.22), rgba(110,231,255,.08));
      box-shadow: 0 10px 26px rgba(0,0,0,.32);
    }
    .btn.apply{
      border-color: rgba(110,231,255,.35);
      background: linear-gradient(135deg, rgba(110,231,255,.12), rgba(203,181,139,.10));
    }

    .hero{padding:64px 0 24px 0}
    .hero-grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:22px;
      align-items:stretch;
    }
    .hero-card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius: var(--radius2);
      box-shadow: var(--shadow2);
      overflow:hidden;
      position:relative;
    }
    .hero-card .inner{padding:34px; position:relative; z-index:2}
    .kicker{
      display:inline-flex;align-items:center;gap:10px;
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      padding:8px 12px;border-radius:999px;
      background: rgba(0,0,0,.18);
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 6px rgba(203,181,139,.12);
    }
    .hero h2{
      margin:16px 0 10px 0;
      font-size:40px; line-height:1.05;
      letter-spacing:-0.03em;
    }
    .hero h2 span{
      background: linear-gradient(135deg, var(--text), rgba(203,181,139,.85));
      -webkit-background-clip:text; background-clip:text;
      color:transparent;
    }
    .hero p{margin:0;color:var(--muted);font-size:15px;line-height:1.6;max-width:60ch}
    .hero-actions{display:flex;flex-wrap:wrap;gap:12px;margin-top:22px}
    .stats{
      display:grid; grid-template-columns: repeat(4, 1fr);
      gap:12px; margin-top:22px;
    }
    .stat{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius:16px;
      padding:14px 14px;
    }
    .stat b{display:block;font-size:18px}
    .stat span{color:var(--muted);font-size:12px}

    .hero-media{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      overflow:hidden;
      box-shadow: var(--shadow2);
      position:relative;
      min-height: 320px;
      background:
        radial-gradient(600px 400px at 30% 20%, rgba(203,181,139,.18), transparent 60%),
        radial-gradient(500px 360px at 70% 30%, rgba(110,231,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    }
    .hero-media img{width:100%;height:100%;object-fit:cover;opacity:1}
    .hero-media .badge{
      position:absolute;left:16px;bottom:16px;
      border:1px solid var(--line);
      background: rgba(10,12,15,.55);
      backdrop-filter: blur(10px);
      border-radius:16px;
      padding:12px 12px;
      max-width: 85%;
    }
    .badge b{display:block;font-size:13px}
    .badge span{display:block;color:var(--muted);font-size:12px;margin-top:2px}

    section{padding:26px 0}
    .section-head{display:flex;align-items:flex-end;justify-content:space-between;gap:16px;margin-bottom:14px}
    .section-head h3{margin:0;font-size:18px;letter-spacing:-0.02em}
    .section-head p{margin:0;color:var(--muted);font-size:13px}

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:14px;
      margin-top:14px;
    }
    .card{
      grid-column: span 4;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius2);
      overflow:hidden;
      box-shadow: var(--shadow);
      transition:.22s ease;
      cursor:pointer;
      position:relative;
      content-visibility: auto;
      contain-intrinsic-size: 320px;
    }
    .card:hover{transform: translateY(-3px); box-shadow: var(--shadow2)}
    .card .img{height:220px;background:#0c0f14;position:relative;overflow:hidden}
    .card .img img{width:100%;height:100%;object-fit:cover;opacity:1;transform:scale(1) translateX(0);transition:opacity .24s ease, transform .24s ease;will-change:opacity,transform}
    .card .img img.fade-out{opacity:0;transform:scale(.985) translateX(-6px)}
    .card .img img.fade-in{opacity:1;transform:scale(1) translateX(0)}
    .img-prev, .img-next{
      position:absolute;bottom:10px;z-index:4;
      width:36px;height:36px;
      display:flex;align-items:center;justify-content:center;
      border:1px solid var(--line);
      background: rgba(10,12,15,.55);
      backdrop-filter: blur(6px);
      color:var(--text);
      border-radius:999px;
      font-size:18px;line-height:1;
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
      cursor:pointer;
      transition: opacity .16s ease, transform .18s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease;
      opacity:0;
      pointer-events:none;
    }
    .card .img:hover .img-prev,
    .card .img:hover .img-next{
      opacity:1;
      pointer-events:auto;
    }
    .img-prev{left:10px}
    .img-next{right:10px}
    .img-prev:hover, .img-next:hover{ transform: translateY(-1px) scale(1.04); background: rgba(255,255,255,.08); box-shadow: 0 10px 24px rgba(0,0,0,.38); }
    .img-prev:active, .img-next:active{ transform: translateY(0) scale(0.98); }
    .img-prev:focus-visible, .img-next:focus-visible{ outline:none; border-color: rgba(203,181,139,.45); box-shadow: 0 0 0 2px rgba(203,181,139,.35), 0 10px 24px rgba(0,0,0,.38); }
    .img-dots{position:absolute;left:50%;bottom:12px;transform:translateX(-50%);display:flex;gap:6px;z-index:3;background:rgba(0,0,0,.25);padding:6px 8px;border-radius:999px;border:1px solid var(--line)}
    .img-dots .pip{width:7px;height:7px;border-radius:999px;background:rgba(234,240,247,.5)}
    .img-dots .pip.active{background:rgba(234,240,247,.95)}
    .pill{
      position:absolute;left:14px;top:14px;
      font-size:11px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(10,12,15,.55);
    }
    .pill.good{border-color:rgba(110,231,255,.35)}
    .pill.warn{border-color:rgba(203,181,139,.35)}
    .pill.bad{border-color:rgba(255,122,122,.35)}
    .pill.waitlist{border-color:rgba(203,181,139,.35)}
    .card .body{padding:16px 16px 18px 16px}
    .card .title{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .card h4{margin:0;font-size:14px;letter-spacing:-0.01em}
    .addr{margin:6px 0 0 0;color:var(--muted);font-size:12px}
    .meta{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{
      font-size:11px;color:rgba(234,240,247,.92);
      border:1px solid rgba(255,255,255,.10);
      padding:7px 9px;border-radius:999px;
      background: rgba(0,0,0,.18);
    }
    .card-actions{
      display:flex;gap:10px;flex-wrap:wrap;
      margin-top:12px;
    }

    .filters{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      padding:14px;
      display:grid;
      grid-template-columns: 1.3fr .7fr .7fr .7fr .7fr;
      gap:12px;
    }
    .field label{display:block;font-size:11px;color:var(--muted);margin-bottom:6px}
    .field input, .field select{
      width:100%;
      padding:11px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,12,15,.55);
      color:var(--text);
      outline:none;
    }
    .field input::placeholder{color:rgba(169,180,194,.65)}
    .field input:focus,.field select:focus{border-color: rgba(203,181,139,.40)}

    .units{
      margin-top:18px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius2);
      overflow:hidden;
    }
    .units .cards{display:none}
    table{width:100%;border-collapse: collapse;font-size:13px}
    th, td{padding:12px 14px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
    th{color:var(--muted);font-weight:600;background: rgba(0,0,0,.18)}
    tr:hover td{background: rgba(255,255,255,.02)}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      font-size:12px;
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .tag .mini-dot{width:7px;height:7px;border-radius:999px;background: var(--accent)}
    .tag.available .mini-dot{background: var(--good)}
    .tag.coming .mini-dot{background: var(--warn)}
    .tag.occupied .mini-dot{background: var(--bad)}
    .tag.waitlist .mini-dot{background: var(--warn)}
    .link{color:rgba(110,231,255,.95);font-weight:600;cursor:pointer}
    .link:hover{text-decoration:underline}

    .panel{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius2);
      padding:18px;
      box-shadow: var(--shadow);
      content-visibility: auto;
      contain-intrinsic-size: 200px;
    }
    /* Map */
    @media (hover: none) and (pointer: coarse){
      .img-prev, .img-next{display:none !important;}
    }
    #mapCanvas{
      height:420px;
      border:1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow2);
      overflow:hidden;
      background:#0b0e12;
    }
    .map-toolbar{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    @media (max-width:640px){
      #mapCanvas{height:360px}
    }

    .footer{
      padding:34px 0 54px 0;
      color:var(--muted);
      font-size:12px;
      border-top:1px solid var(--line);
      margin-top:22px;
    }

    /* Mobile menu */
    .mobile-btn{display:none}
    .mobile-menu{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.60);backdrop-filter:blur(8px);z-index:120;padding:20px}
    .mobile-menu.open{display:flex}
    .mobile-menu-card{width:min(420px,100%);border:1px solid var(--line);background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));border-radius:18px;box-shadow:var(--shadow2);overflow:hidden}
    .mobile-menu-head{display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid var(--line)}
    .mobile-menu-body{padding:14px;display:flex;flex-direction:column;gap:10px}
    .mobile-menu-body a{padding:12px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.03);font-weight:600;font-size:14px}

    /* Mobile availability cards */
    .unit-card{border:1px solid var(--line);background:rgba(255,255,255,.03);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
    .unit-card .head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .unit-card .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .unit-card .meta{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .unit-card .actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}


    /* Modal */
    .modal{
      position:fixed;inset:0;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;justify-content:center;
      padding:20px;
      z-index:1000;
    }
    .modal.open{display:flex}
    .modal-card{
      width:min(1100px, 100%);
      border-radius: var(--radius2);
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      box-shadow: var(--shadow2);
      overflow:hidden;
      max-height: 100vh; /* keep modal within viewport height */
    }
    .modal-top{display:flex;gap:0;flex-wrap:wrap}
    .modal-media{
      flex: 1.1; min-width:320px;
      background:#0b0e12; position:relative;
      min-height:340px;
    }
    .modal-media img{width:100%;height:100%;object-fit:scale-down;opacity:1;transform:scale(1) translateX(0);transition:opacity .24s ease, transform .24s ease;will-change:opacity,transform}
    .modal-media img.fade-out{opacity:0;transform:scale(.985) translateX(-8px)}
    .modal-media img.fade-in{opacity:1;transform:scale(1) translateX(0)}
    .modal-media .modal-nav{
      position:absolute;top:50%;transform:translateY(-50%);
      z-index:3;
      width:40px;height:40px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(10,12,15,.55);
      backdrop-filter: blur(6px);
      color:var(--text);
      display:flex;align-items:center;justify-content:center;
      font-size:20px;line-height:1;
      cursor:pointer;
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease;
      user-select:none;
    }
    .modal-media .modal-nav:hover{ transform:translateY(-50%) scale(1.04); background: rgba(255,255,255,.08); box-shadow: 0 10px 24px rgba(0,0,0,.38); }
    .modal-media .modal-nav:active{ transform:translateY(-50%) scale(0.98); }
    .modal-media .modal-nav:focus-visible{ outline:none; border-color: rgba(203,181,139,.45); box-shadow: 0 0 0 2px rgba(203,181,139,.35), 0 10px 24px rgba(0,0,0,.38); }
    .modal-media .modal-nav.prev{left:12px}
    .modal-media .modal-nav.next{right:12px}
    .modal-content{
      flex: 1.1; min-width:320px;
      padding:3px;
      border-left:1px solid var(--line);
      overflow:auto; /* scroll content when tall */
      max-height: 101vh; /* ensures right panel can scroll within modal */
      -webkit-overflow-scrolling: touch; /* smooth on iOS */
    }
    .modal-top{min-height:0}
    .modal-media,.modal-content{min-height:0}
    .modal-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .modal-head h4{margin:0;font-size:16px}
    .modal-head-actions{display:flex;align-items:center;gap:8px}
    .modal-back{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--muted);
      font-size:11px;
      padding:5px 10px;
      border-radius:999px;
      cursor:pointer;
      display:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .modal-back::before{
      content:"←";
      font-size:12px;
      opacity:.85;
    }
    .modal-back:hover{background:rgba(255,255,255,.08);color:var(--text);border-color:rgba(203,181,139,.45)}
    .modal-back:focus-visible{outline:none;border-color:rgba(203,181,139,.6);box-shadow:0 0 0 1px rgba(203,181,139,.35);}
    .close{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
    }
    .close:hover{background: rgba(255,255,255,.06)}
    .modal-sub{margin:6px 0 0 0;color:var(--muted);font-size:12px}
    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:14px;
    }
    .kv .box{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius:16px;
      padding:12px;
    }
    .kv .box span{display:block;color:var(--muted);font-size:11px}
    .kv .box b{display:block;margin-top:4px;font-size:14px}
    .kv .box b.apply-hint-clickable{cursor:pointer;color:var(--accent2);}
    .kv .box b.apply-hint-clickable:hover{text-decoration:underline}
    .modal-map{margin-top:14px;border-radius:16px;overflow:hidden;border:1px solid var(--line);background:#05070a}
    #mMap{width:100%;height:210px}
    .modal-actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
    .small{font-size:11px;color:var(--muted);margin:10px 0 0 0;line-height:1.5}

    /* Modal sections */
    .modal-section{margin-top:14px}
    .modal-section h5{margin:0 0 8px 0;font-size:13px;color:var(--text)}
    .hl-list{display:flex;flex-wrap:wrap;gap:8px}
    .hl-list .chip{display:inline-flex;align-items:center;gap:6px;background:rgba(0,0,0,.22);padding:4px 10px;border-radius:999px}
    .hl-list .chip-icon{font-size:16px;color:#fff}
    .avail-list{display:flex;flex-direction:column;gap:8px}
    .avail-row{display:flex;justify-content:space-between;gap:10px;align-items:center;border:1px solid var(--line);background:rgba(255,255,255,.03);border-radius:12px;padding:10px;transition: transform .16s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease}
    .avail-row:hover{transform: translateY(-2px); background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03)); border-color: rgba(203,181,139,.35); box-shadow: 0 8px 24px rgba(0,0,0,.32)}
    .avail-row:active{transform: translateY(0) scale(.99)}
    .avail-row:focus-within{outline:none; background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.035)); border-color: rgba(203,181,139,.45); box-shadow: 0 0 0 2px rgba(203,181,139,.25), 0 8px 24px rgba(0,0,0,.34)}
    .avail-row .left{display:flex;gap:10px;align-items:center}
    .avail-row .right{display:flex;gap:5px;align-items:center;flex-wrap:wrap}
    /* Constrain long unit lists inside modal */
    #mAvailList .avail-list{max-height:320px;overflow:auto;padding-right:6px;-webkit-overflow-scrolling: touch}

    /* Hide scrollbars but keep scrolling */
    .modal-content, #mAvailList .avail-list{ scrollbar-width: none; -ms-overflow-style: none; }
    .modal-content::-webkit-scrollbar, #mAvailList .avail-list::-webkit-scrollbar{ width:0; height:0; display:none; }

    /* Contact form */
    .form{margin-top:12px;border-top:1px solid var(--line);padding-top:12px}
    .form .row{display:grid;grid-template-columns: 1fr 1fr;gap:10px;margin-bottom:10px}
    .form input, .form textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,12,15,.55);
      color:var(--text);
      outline:none;
      font-size:13px;
    }
    textarea{min-height:84px;resize:vertical}

    @media (max-width: 980px){
      .hero-grid{grid-template-columns:1fr}
      .filters{grid-template-columns:1fr 1fr}
      .card{grid-column: span 6}
      .modal-content{border-left:none;border-top:1px solid var(--line)}
      .stats{grid-template-columns: repeat(2, 1fr)}
    }
    @media (max-width: 640px){
      nav{display:none}
      .mobile-btn{display:inline-flex}
      .filters{grid-template-columns:1fr}
      .card{grid-column: span 12}
      .stats{grid-template-columns:1fr}
      .form .row{grid-template-columns:1fr}
      /* Switch table to cards on mobile */
      .units table{display:none}
      .units .cards{display:grid;grid-template-columns:1fr;gap:12px;padding:12px}
    }
  </style>
  <style>
    /* Mobile-responsive modal adjustments */
    @media (max-width: 640px){
      .modal-card{width:100%;max-height:94vh;border-radius:16px}
      .modal-top{flex-direction:column}
      .modal-media{min-height:28vh}
      .modal-content{border-left:none;border-top:1px solid var(--line);max-height:calc(94vh - 44vh);overflow:auto;padding:14px}
      .modal-media .modal-nav{width:44px;height:44px}
      #mAvailList .avail-list{max-height:240px}
      /* Make Available units rows compact */
      #mAvailList .avail-row{padding:8px;gap:8px}
      #mAvailList .avail-row .left{gap:8px}
      #mAvailList .avail-row .left b{font-size:13px}
      #mAvailList .avail-row .right{gap:6px}
      #mAvailList .avail-row .right .btn{padding:8px 2px;border-radius:10px;font-size:12px}
      #mAvailList .avail-row .tag{font-size:11px;padding:6px 8px}
    }
  </style>
<style>
  /* Accessibility + polish */
  :focus-visible{ outline: 2px solid rgba(203,181,139,.65); outline-offset: 2px; }
  @media (prefers-reduced-motion: reduce){
    *{ scroll-behavior:auto !important; transition:none !important; animation:none !important; }
  }
  .form .field label{ display:block; font-size:11px; color:var(--muted); margin:0 0 6px 2px; }
  .link{ font: inherit; }
</style>
</head>

<body>
  <header class="topbar">
    <div class="container">
      <div class="topbar-inner">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>Blue Rain Real Estate</h1>
            <p>Properties • Photos • Availability</p>
          </div>
        </div>

        <nav>
          <a href="#map">Map</a>
          <a href="#multifamily">Multifamily</a>
          <a href="#singlefamily">Single-family</a>
        </nav>
        <button class="btn mobile-btn" id="mobileMenuBtn" aria-label="Open menu">Menu</button>
        <div style="display:flex;gap:10px;align-items:center;">
          <a class="btn apply" href="https://bluerainrealestate.com/blue-rain-rental-application.html" target="_blank" rel="noopener">Apply online</a>
          <button class="btn" id="btnScrollAvailability">View availability</button>
          <button class="btn primary" id="btnScrollContact">Schedule tour</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Mobile Menu Overlay -->
  <div class="mobile-menu" id="mobileMenu" role="dialog" aria-modal="true" aria-label="Menu">
    <div class="mobile-menu-card">
      <div class="mobile-menu-head">
        <b>Menu</b>
        <button class="close" id="mobileMenuClose" aria-label="Close">✕</button>
      </div>
      <div class="mobile-menu-body">
        <a href="#multifamily" id="mLinkMulti">Multifamily</a>
        <a href="#singlefamily" id="mLinkSFH">Single-family</a>
        <a href="#availability" id="mLinkAvail">Availability</a>
        <a href="#contact" id="mLinkContact">Schedule a tour</a>
      </div>
    </div>
  </div>

  <main>
    <section class="hero">
      <div class="container">
        <div class="hero-grid">
          <div class="hero-card">
            <div class="inner">
              <div class="kicker"><span class="dot"></span> San Antonio • Alamo Heights • Multifamily + Homes</div>
<h2>Modern homes with a <span>quiet-luxury</span> vibe.</h2>
<p>
  Clean lines, updated finishes, and spaces that just feel right.
  Explore our portfolio, view availability, and apply online or schedule a tour in minutes.
</p>


              <div class="hero-actions">
                <a class="btn primary apply" href="https://bluerainrealestate.com/blue-rain-rental-application.html" target="_blank" rel="noopener">Apply online</a>
                <button class="btn" id="btnExploreMulti">Explore multifamily</button>
                <button class="btn" id="btnExploreSFH">Explore single-family</button>
              </div>

              <div class="stats">
                <div class="stat">
                  <b id="statProperties">—</b>
                  <span>Properties</span>
                </div>
                <div class="stat">
                  <b id="statUnits">—</b>
                  <span>Total units</span>
                </div>
                <div class="stat">
                  <b id="statAvailable">—</b>
                  <span>Available now</span>
                </div>
                <div class="stat">
                  <b id="statComingSoon">—</b>
                  <span>Coming soon</span>
                </div>
              </div>
            </div>
          </div>

          <div class="hero-media">
            <img alt="Modern interior"
              src="images/image52.jpg" loading="eager" fetchpriority="high" decoding="async" />
            <div class="badge">
              <b>Apply is one click</b>
              <span>Apply online anytime, then we’ll follow up with next steps.</span>
            </div>
          </div>
        </div>
      </div>
    </section>



    <!-- Multifamily -->
    <section id="multifamily">
      <div class="container">
        <div class="section-head">
          <div>
            <h3>Multifamily</h3>
            <p>Tap a property to jump to its units in the Availability table.</p>
          </div>
        </div>
        <div class="grid" id="mfGrid"></div>
      </div>
    </section>

    <!-- Single Family -->
    <section id="singlefamily">
      <div class="container">
        <div class="section-head">
          <div>
            <h3>Single-family homes</h3>
            <p>Tap a home to view details.</p>
          </div>
        </div>
        <div class="grid" id="sfhGrid"></div>
      </div>
    </section>

    <!-- Availability -->
    <section id="availability">
      <div class="container">
        <div class="section-head">
          <div>
            <h3>Availability</h3>
            <p>Filter by type, beds, status, and price.</p>
          </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;"><span id="resultCount" style="color:var(--muted);font-size:12px;">—</span><button class="btn" type="button" id="btnClearFilters">Clear filters</button></div></div>

        <div class="filters" role="region" aria-label="Filters">
          <div class="field">
            <label for="q">Search</label>
            <input id="q" type="text" placeholder="Address, unit #, ZIP..." />
          </div>
          <div class="field">
            <label for="type">Type</label>
            <select id="type">
              <option value="">All</option>
              <option value="Multifamily">Multifamily</option>
              <option value="Single-family">Single-family</option>
            </select>
          </div>
          <div class="field">
            <label for="beds">Beds</label>
            <select id="beds">
              <option value="">Any</option>
              <option value="1">1+</option>
              <option value="2">2+</option>
              <option value="3">3+</option>
              <option value="4">4+</option>
              <option value="5">5+</option>
            </select>
          </div>
          <div class="field">
            <label for="status">Status</label>
            <select id="status">
              <option value="">Any</option>
              <option value="Available" selected>Available now</option>
              <option value="Coming Soon">Coming Soon</option>
              <option value="Waitlist">Waitlist</option>
            </select>
          </div>
          <div class="field">
            <label for="maxPrice">Max price</label>
            <input id="maxPrice" type="number" placeholder="e.g., 2200" min="0" step="50" />
          </div>
        </div>

        <div class="units" aria-label="Availability table">
          <table>
            <thead>
              <tr>
                <th>Type</th>
                <th>Unit / Home</th>
                <th>Address</th>
                <th>Beds/Baths</th>
                <th>Sq Ft</th>
                <th>Rent</th>
                <th>Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
          <div class="cards" id="rowsCards" aria-label="Availability cards"></div>
        </div>
      </div>
    </section>


        <!-- Map -->
    <section id="map">
      <div class="container">
        <div class="section-head">
          <div>
            <h3>Locations</h3>
            <p>Tap a pin to view units at that property.</p>
          </div>
        </div>
        <div class="map-toolbar">
          <label><input type="checkbox" id="toggleUnitPins"> Show unit-level pins</label>
        </div>
        <div id="mapCanvas" aria-label="Property locations"></div>
      </div>
    </section>

    <!-- Contact -->
    <section id="contact">
      <div class="container">
        <div class="section-head">
          <div>
            <h3>Schedule a tour</h3>
            <p>We’ll respond with next steps.</p>
          </div>
        </div>

        <div class="panel">
          <form id="contactForm" novalidate>
  <div class="form">
    <!-- Honeypot field (basic spam reduction) -->
    <div style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;" aria-hidden="true">
      <label for="companyWebsite">Company website</label>
      <input id="companyWebsite" name="companyWebsite" tabindex="-1" autocomplete="off" />
    </div>

    <div class="row">
      <div class="field">
        <label for="leadName">Full name</label>
        <input id="leadName" name="name" autocomplete="name" required />
      </div>
      <div class="field">
        <label for="leadPhone">Phone number</label>
        <input id="leadPhone" name="phone" type="tel" inputmode="tel" autocomplete="tel" required
               placeholder="(210) 555-1234" />
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label for="leadEmail">Email</label>
        <input id="leadEmail" name="email" type="email" autocomplete="email" required />
      </div>
      <div class="field">
        <label for="leadMoveIn">Preferred move-in date (optional)</label>
        <input id="leadMoveIn" name="moveIn" type="date" />
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label for="leadInterested">Interested unit/home (optional)</label>
        <input id="leadInterested" name="interested" autocomplete="off" />
      </div>
      <div class="field">
        <label for="leadBudget">Budget (optional)</label>
        <input id="leadBudget" name="budget" inputmode="numeric" autocomplete="off" placeholder="$2,200" />
      </div>
    </div>

    <div class="field">
      <label for="leadMsg">Anything you want us to know? (optional)</label>
      <textarea id="leadMsg" name="message" placeholder="Pets, timing, questions, etc."></textarea>
    </div>

    <div class="modal-actions" style="margin-top:12px;">
      <button class="btn primary" type="submit" id="contactSubmitBtn">Send request</button>
      <a class="btn apply" href="https://bluerainrealestate.com/blue-rain-rental-application.html" target="_blank" rel="noopener">Apply online</a>
    </div>

    <div id="contactStatus" role="status" aria-live="polite" style="margin-top:10px;color:var(--muted);font-size:12px;"></div>

    <p class="small">
      By submitting this form, you agree to our use of your information in accordance with our privacy policy.
      We will contact you regarding your inquiry.
    </p>
  </div>
</form>
        </div>
      </div>
    </section>

    <!-- Company Information -->
    <section id="company">
      <div class="container">
        <div class="section-head">
          <div>
            <h3>Company Information</h3>
            <p>Get in touch or visit our office.</p>
          </div>
        </div>

        <div class="panel">
          <div style="display:grid;grid-template-columns: 1fr 1fr;gap:14px;align-items:start;">
            <div>
              <b>Phone</b>
              <div style="margin-top:6px;"><a class="btn" href="tel:+12109819251">(210) 981-9251</a></div>
            </div>
            <div>
              <b>Email</b>
              <div style="margin-top:6px;"><a class="btn" href="mailto:bluerainrealestate@gmail.com">bluerainrealestate@gmail.com</a></div>
            </div>
            <div style="grid-column: span 2;">
              <b>Office</b>
              <div class="addr" style="margin-top:6px;white-space:pre-line;">
14546 BROOK HOLLOW BLVD
SUITE # 251
SAN ANTONIO, TX 78232-3810
United States
              </div>
            </div>
            <div style="grid-column: span 2;display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;">
              <a class="btn" href="https://www.facebook.com/profile.php?id=61567258626356&mibextid=wwXIfr&rdid=z2fwxfZOGxVBXege&share_url=https%3A%2F%2Fwww.facebook.com%2Fshare%2F17MLzuidQb%2F%3Fmibextid%3DwwXIfr#" target="_blank" rel="noopener">Facebook</a>
              <a class="btn" href="https://www.google.com/maps/search/?api=1&query=14546%20BROOK%20HOLLOW%20BLVD%20SUITE%20%23%20251%2C%20SAN%20ANTONIO%2C%20TX%2078232-3810%2C%20United%20States" target="_blank" rel="noopener">Open office in Google Maps</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer class="footer">
      <div class="container">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:18px;flex-wrap:wrap;">
          <div style="max-width:70ch;line-height:1.6;">
            <b style="color:var(--text);display:block;margin-bottom:8px;">Blue Rain Real Estate</b>
            Availability and pricing subject to change. Equal Housing Opportunity.
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <a class="btn" href="#multifamily">Multifamily</a>
            <a class="btn" href="#singlefamily">Single-family</a>
            <a class="btn" href="#availability">Availability</a>
            <a class="btn apply" href="https://bluerainrealestate.com/blue-rain-rental-application.html" target="_blank" rel="noopener">Apply online</a>
          </div>
        </div>
      </div>
    </footer>
  </main>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- Modal -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-label="Details">
    <div class="modal-card">
      <div class="modal-top">
        <div class="modal-media">
          <img id="mImg" alt="Photo" decoding="async" />
          <button class="modal-nav prev" id="mPrev" aria-label="Previous photo">‹</button>
          <button class="modal-nav next" id="mNext" aria-label="Next photo">›</button>
        </div>
        <div class="modal-content">
          <div class="modal-head">
            <div>
              <h4 id="mTitle">—</h4>
              <div class="modal-sub" id="mSub">—</div>
            </div>
            <div class="modal-head-actions">
              <button class="modal-back" id="mBack" type="button">Back to property</button>
              <button class="close" id="mClose" aria-label="Close">✕</button>
            </div>
          </div>

          <div class="kv">
            <div class="box"><span>Type</span><b id="mType">—</b></div>
            <div class="box"><span>Status</span><b id="mStatus">—</b></div>
            <div class="box"><span>Beds / Baths</span><b id="mBedsBaths">—</b></div>
            <div class="box"><span>Sq Ft</span><b id="mSqft">—</b></div>
            <div class="box"><span>Rent</span><b id="mRent">—</b></div>
            <div class="box"><span>Apply</span><b id="mApplyHint">—</b></div>
          </div>



          <div class="modal-section" id="mHighlights"></div>
          <div class="modal-section" id="mAvailList"></div>

           <div class="modal-map">
            <div id="mMap" aria-label="Property location"></div>
          </div>

          <p class="small" id="mNotes"></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    

"use strict";

// ========= Settings =========
const APP_VERSION = "2026-01-21";
const CONTACT_ENDPOINT = "/api/contact"; // your backend should implement POST {name,email,phone,details}
const GEO_RATE_LIMIT_MS = 1100;          // Nominatim-friendly pacing when geocoding (best: store lat/lon in data)

// ========= DOM helpers =========
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

function setText(id, value){
  const el = document.getElementById(id);
  if(el) el.textContent = value;
}

// ========= Formatting =========
function money(n){
  return (typeof n === "number")
    ? n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0})
    : "—";
}
function bedsBaths(b,ba){
  if(typeof b !== "number" || typeof ba !== "number") return "—";
  const btxt = (b===0 ? "Studio" : `${b} bd`);
  return `${btxt} / ${ba} ba`;
}
function notesForStatus(status){
  return status === "Waitlist" ? "Join the waitlist — apply online." :
         status === "Coming Soon" ? "Coming soon — apply online to get started." :
         "Available — apply online or request a tour.";
}
function pillForStatus(status){
  if(status === "Available") return { cls:"pill good", text:"Available" };
  if(status === "Coming Soon") return { cls:"pill warn", text:"Coming soon" };
  if(status === "Waitlist") return { cls:"pill waitlist", text:"Waitlist" };
  return { cls:"pill warn", text:String(status||"Waitlist") };
}
function tagClass(status){
  if(status === "Available") return "tag available";
  if(status === "Coming Soon") return "tag coming";
  if(status === "Waitlist") return "tag waitlist";
  return "tag waitlist";
}
function canApply(status){
  return status === "Available" || status === "Coming Soon" || status === "Waitlist";
}

// ========= Accessibility & UX helpers =========
function onActivate(el, fn){
  // Activate on click OR Enter/Space when focused
  el.addEventListener("click", (e)=>fn(e));
  el.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" || e.key === " "){
      e.preventDefault();
      fn(e);
    }
  });
}

function debounce(fn, delay){
  let t;
  return (...args)=>{
    window.clearTimeout(t);
    t = window.setTimeout(()=>fn(...args), delay);
  };
}

// Image swap helpers (kept, but hardened)
function preloadImage(src){
  return new Promise((resolve)=>{
    if(!src){ resolve(); return; }
    const i = new Image();
    i.src = src;
    if(i.complete) resolve();
    else{
      i.onload = ()=>resolve();
      i.onerror = ()=>resolve();
    }
  });
}
function waitTransition(el, timeout=420){
  return new Promise((resolve)=>{
    let done = false;
    const handler = (e)=>{
      if(e.target === el && (e.propertyName === "opacity" || e.propertyName === "transform")){
        if(!done){
          done = true;
          el.removeEventListener("transitionend", handler);
          resolve();
        }
      }
    };
    el.addEventListener("transitionend", handler);
    window.setTimeout(()=>{
      if(!done){
        done = true;
        el.removeEventListener("transitionend", handler);
        resolve();
      }
    }, timeout);
  });
}
async function smoothSwap(imgEl, nextSrc){
  if(!imgEl) return;
  await preloadImage(nextSrc);
  imgEl.classList.add("fade-out");
  await waitTransition(imgEl);
  imgEl.src = nextSrc || imgEl.src;
  imgEl.classList.remove("fade-out");
  imgEl.classList.add("fade-in");
  await waitTransition(imgEl);
  imgEl.classList.remove("fade-in");
}

// Body scroll lock (kept)
let __bodyScrollY = 0;
function lockBodyScroll(){
  __bodyScrollY = window.scrollY || window.pageYOffset || 0;
  document.body.style.position = "fixed";
  document.body.style.top = `-${__bodyScrollY}px`;
  document.body.style.left = "0";
  document.body.style.right = "0";
  document.body.style.width = "100%";
  document.body.classList.add("modal-open");
}
function unlockBodyScroll(){
  document.body.style.position = "";
  document.body.style.top = "";
  document.body.style.left = "";
  document.body.style.right = "";
  document.body.style.width = "";
  document.body.classList.remove("modal-open");
  window.scrollTo(0, __bodyScrollY || 0);
}

// Focus trap for modal + mobile menu
function createFocusTrap(containerEl){
  const selectors = [
    'a[href]','button:not([disabled])','textarea:not([disabled])',
    'input:not([disabled])','select:not([disabled])',
    '[tabindex]:not([tabindex="-1"])'
  ].join(",");

  function getFocusable(){
    return $$(selectors, containerEl).filter(el=>{
      const style = window.getComputedStyle(el);
      return style.visibility !== "hidden" && style.display !== "none";
    });
  }

  function onKeydown(e){
    if(e.key !== "Tab") return;
    const focusables = getFocusable();
    if(!focusables.length) return;

    const first = focusables[0];
    const last = focusables[focusables.length - 1];

    if(e.shiftKey && document.activeElement === first){
      e.preventDefault();
      last.focus();
    }else if(!e.shiftKey && document.activeElement === last){
      e.preventDefault();
      first.focus();
    }
  }

  return {
    activate(){
      containerEl.addEventListener("keydown", onKeydown);
    },
    deactivate(){
      containerEl.removeEventListener("keydown", onKeydown);
    }
  };
}

// ========= Persist filter state in URL =========
function getFiltersFromUrl(){
  const u = new URL(window.location.href);
  return {
    q: (u.searchParams.get("q") || ""),
    type: (u.searchParams.get("type") || ""),
    beds: (u.searchParams.get("beds") || ""),
    status: (u.searchParams.get("status") || ""),
    maxPrice: (u.searchParams.get("maxPrice") || ""),
  };
}
function setUrlFromFilters(filters){
  const u = new URL(window.location.href);
  const keys = ["q","type","beds","status","maxPrice"];
  keys.forEach(k=>{
    const v = (filters[k] ?? "").toString().trim();
    if(v) u.searchParams.set(k, v);
    else u.searchParams.delete(k);
  });
  window.history.replaceState({}, "", u.toString());
}

// ========= Data (preserved from your original file) =========

const APPLY_URL = "https://bluerainrealestate.com/blue-rain-rental-application.html";

    function buildApplyUrl(address, unitLabel){
      try{
        const url = new URL(APPLY_URL);
          if(address && address.trim()){
          url.searchParams.set('propertyAddress', address);
        }
          if(unitLabel && unitLabel.trim()){
          const cleanUnit = String(unitLabel).replace(/^Unit\s*/i,'').trim();
          url.searchParams.set('unitNumber', cleanUnit);
        }
        return url.toString();
      }catch(e){
        const parts = [];
          if(address && address.trim()){
          parts.push(`propertyAddress=${encodeURIComponent(address)}`);
        }
          if(unitLabel && unitLabel.trim()){
          const cleanUnit = String(unitLabel).replace(/^Unit\s*/i,'').trim();
          parts.push(`unitNumber=${encodeURIComponent(cleanUnit)}`);
        }
        if(!parts.length) return APPLY_URL;
        const sep = APPLY_URL.includes('?') ? '&' : '?';
        return APPLY_URL + sep + parts.join('&');
      }
    }

    // Placeholder photos (swap later with your real photos per property/unit)
    const placeholderPhotos = [
 //coming soon image 
      "https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?auto=format&fit=crop&w=1600&q=75",
      "https://images.unsplash.com/photo-1512918728675-ed5a9ecdebfd?auto=format&fit=crop&w=1600&q=75",
    ];

    // ========= YOUR DATA (wired exactly to what you provided) =========

    // Multifamily properties: most units share same rent/beds/baths/sqft per building,
    // except 401 Kendall which has per-unit sqft.
    const multifamily = [
      {
        id:"110-webb",
        name:"110 Webb St",
        address:"110 Webb St, San Antonio, TX 78223",
        units: ["101","102","201","202"],
        rent: 1700,
        beds: 3, baths: 1,
        sqftByUnit: { "101":1050,"102":1050,"201":1050,"202":1050 },
        statusByUnit: { "101":"Waitlist","102":"Waitlist","201":"Waitlist","202":"Available" },
        photosByUnit: {
          "101": ["images/image63.jpg","images/image64.jpg","images/image65.jpg","images/image66.jpg","images/image67.jpg","images/image68.jpg","images/image69.jpg","images/image70.jpg","images/image71.jpg","images/image72.jpg"],
          "102": ["images/image63.jpg","images/image64.jpg","images/image65.jpg","images/image66.jpg","images/image67.jpg","images/image68.jpg","images/image69.jpg","images/image70.jpg","images/image71.jpg","images/image72.jpg"],
          "201": ["images/image63.jpg","images/image64.jpg","images/image65.jpg","images/image66.jpg","images/image67.jpg","images/image68.jpg","images/image69.jpg","images/image70.jpg","images/image71.jpg","images/image72.jpg"],
          "202": ["images/image63.jpg","images/image64.jpg","images/image65.jpg","images/image66.jpg","images/image67.jpg","images/image68.jpg","images/image69.jpg","images/image70.jpg","images/image71.jpg","images/image72.jpg"]
        },
        status: "Available",
        heroPhotos: ["images/image51.jpg","images/image52.jpg","images/image113.jpg","images/image114.jpg","images/image115.jpg","images/image116.jpg","images/image63.jpg","images/image64.jpg","images/image65.jpg","images/image66.jpg","images/image67.jpg","images/image68.jpg","images/image69.jpg","images/image70.jpg","images/image71.jpg","images/image72.jpg"],
      },
      {
        id:"401-kendall",
        name:"401 Kendall St",
        address:"401 Kendall St, San Antonio, TX 78212",
        units: ["101","102","201","202"],
        rent: 2200,
        beds: 2, baths: 2,
        sqftByUnit: { "101":886,"102":914,"201":893,"202":954 },
        statusByUnit: { "101":"Coming Soon","102":"Coming Soon","201":"Coming Soon","202":"Coming Soon" },
                photosByUnit: {
          "101": ["images/image51.jpg","images/image52.jpg"],
          "102": ["images/image52.jpg","images/image51.jpg"],
          "201": ["images/image53.jpg","images/image52.jpg"],
          "202": ["images/image54.jpg","images/image52.jpg"]
        },
        status: "Coming Soon",
        hero: "images/image53.jpg",
      },
      {
        id:"413-nopal",
        name:"413 Nopal Street",
        address:"413 Nopal Street, San Antonio, TX 78210",
        units: ["101","102","201"],
        rent: 1600,
        rentByUnit: { "101": 1600, "102": 1600, "201": 1700 }, 
        beds: 2, baths: 1,
        sqftByUnit: { "101":743,"102":790,"201":883 },
        statusByUnit: { "101":"Available","102":"Available","201":"Waitlist" },
                photosByUnit: {
          "101": ["images/image132.jpg","images/image131.jpg","images/image134.jpg","images/image135.jpg","images/image136.jpg","images/image137.jpg","images/image138.jpg","images/image139.jpg","images/image140.jpg","images/image141.jpg","images/image144.jpg"],
          "102": ["images/image133.jpg","images/image131.jpg","images/image134.jpg","images/image135.jpg","images/image136.jpg","images/image137.jpg","images/image138.jpg","images/image139.jpg","images/image140.jpg","images/image141.jpg","images/image142.jpg"],
          "201": ["images/image130.jpg","images/image133.jpg","images/image134.jpg","images/image135.jpg","images/image136.jpg","images/image137.jpg","images/image138.jpg","images/image139.jpg","images/image140.jpg","images/image141.jpg","images/image141.jpg"],
        },
        status: "Available",
        heroPhotos: ["images/image123.jpg","images/image124.jpg","images/image125.jpg","images/image126.jpg","images/image127.jpg","images/image128.jpg","images/image129.jpg","images/image130.jpg","images/image133.jpg","images/image134.jpg","images/image135.jpg","images/image136.jpg","images/image137.jpg","images/image138.jpg","images/image139.jpg","images/image140.jpg","images/image141.jpg","images/image144.jpg"],
      },
      {
        id:"1635-mulberry",
        name:"1635 W Mulberry Ave",
        address:"1635 W Mulberry Ave, San Antonio, TX 78201",
        units: ["101","102","103","104","205","206","207","208"],
        rent: 1450,
        beds: 1, baths: 1,
        sqftByUnit: { "101":700,"102":700,"103":700,"104":700,"205":700,"206":700,"207":700,"208":700 },
        statusByUnit: { "101":"Waitlist","102":"Available","103":"Available","104":"Available","205":"Available","206":"Available","207":"Available","208":"Available" },
                photosByUnit: {
          "101": ["images/image159.jpg","images/image160.jpg","images/image161.jpg","images/image162.jpg","images/image163.jpg","images/image164.jpg","images/image165.jpg","images/image166.jpg","images/image167.jpg","images/image168.jpg","images/image169.jpg","images/image170.jpg","images/image171.jpg","images/image172.jpg","images/image173.jpg","images/image174.jpg","images/image175.jpg","images/image176.jpg","images/image177.jpg"],
          "102": ["images/image159.jpg","images/image160.jpg","images/image161.jpg","images/image162.jpg","images/image163.jpg","images/image164.jpg","images/image165.jpg","images/image166.jpg","images/image167.jpg","images/image168.jpg","images/image169.jpg","images/image170.jpg","images/image171.jpg","images/image172.jpg","images/image173.jpg","images/image174.jpg","images/image175.jpg","images/image176.jpg","images/image177.jpg"],
          "103": ["images/image159.jpg","images/image160.jpg","images/image161.jpg","images/image162.jpg","images/image163.jpg","images/image164.jpg","images/image165.jpg","images/image166.jpg","images/image167.jpg","images/image168.jpg","images/image169.jpg","images/image170.jpg","images/image171.jpg","images/image172.jpg","images/image173.jpg","images/image174.jpg","images/image175.jpg","images/image176.jpg","images/image177.jpg"],
          "104": ["images/image159.jpg","images/image160.jpg","images/image161.jpg","images/image162.jpg","images/image163.jpg","images/image164.jpg","images/image165.jpg","images/image166.jpg","images/image167.jpg","images/image168.jpg","images/image169.jpg","images/image170.jpg","images/image171.jpg","images/image172.jpg","images/image173.jpg","images/image174.jpg","images/image175.jpg","images/image176.jpg","images/image177.jpg"],
          "205": ["images/image159.jpg","images/image160.jpg","images/image161.jpg","images/image162.jpg","images/image163.jpg","images/image164.jpg","images/image165.jpg","images/image166.jpg","images/image167.jpg","images/image168.jpg","images/image169.jpg","images/image170.jpg","images/image171.jpg","images/image172.jpg","images/image173.jpg","images/image174.jpg","images/image175.jpg","images/image176.jpg","images/image177.jpg"],
          "206": ["images/image159.jpg","images/image160.jpg","images/image161.jpg","images/image162.jpg","images/image163.jpg","images/image164.jpg","images/image165.jpg","images/image166.jpg","images/image167.jpg","images/image168.jpg","images/image169.jpg","images/image170.jpg","images/image171.jpg","images/image172.jpg","images/image173.jpg","images/image174.jpg","images/image175.jpg","images/image176.jpg","images/image177.jpg"],
          "207": ["images/image159.jpg","images/image160.jpg","images/image161.jpg","images/image162.jpg","images/image163.jpg","images/image164.jpg","images/image165.jpg","images/image166.jpg","images/image167.jpg","images/image168.jpg","images/image169.jpg","images/image170.jpg","images/image171.jpg","images/image172.jpg","images/image173.jpg","images/image174.jpg","images/image175.jpg","images/image176.jpg","images/image177.jpg"],
          "208": ["images/image159.jpg","images/image160.jpg","images/image161.jpg","images/image162.jpg","images/image163.jpg","images/image164.jpg","images/image165.jpg","images/image166.jpg","images/image167.jpg","images/image168.jpg","images/image169.jpg","images/image170.jpg","images/image171.jpg","images/image172.jpg","images/image173.jpg","images/image174.jpg","images/image175.jpg","images/image176.jpg","images/image177.jpg"]
        },
        status: "Available",
        heroPhotos: ["images/image145.jpg","images/image146.jpg","images/image147.jpg","images/image148.jpg","images/image149.jpg","images/image150.jpg","images/image151.jpg","images/image152.jpg","images/image153.jpg","images/image154.jpg","images/image155.jpg","images/image156.jpg","images/image157.jpg","images/image158.jpg","images/image159.jpg","images/image160.jpg","images/image161.jpg","images/image162.jpg","images/image163.jpg","images/image164.jpg","images/image165.jpg","images/image166.jpg","images/image167.jpg","images/image168.jpg","images/image169.jpg","images/image170.jpg","images/image171.jpg","images/image172.jpg","images/image173.jpg","images/image174.jpg","images/image175.jpg","images/image176.jpg","images/image177.jpg"],
      },
      {
        id:"1301-townsend",
        name:"1301 Townsend Avenue",
        address:"1301 Townsend Avenue, Alamo Heights, TX 78209",
        units: ["1","2","3","4"],
        rent: 2200,
        beds: 2, baths: 1,
        sqftByUnit: { "1":750,"2":750,"3":750,"4":750 },
        statusByUnit: { "1":"Coming Soon","2":"Coming Soon","3":"Coming Soon","4":"Coming Soon" },
                photosByUnit: {
          "101": ["images/image51.jpg","images/image52.jpg"],
          "102": ["images/image52.jpg","images/image51.jpg"],
          "201": ["images/image53.jpg","images/image52.jpg"],
          "202": ["images/image54.jpg","images/image52.jpg"]
        },
        status: "Coming Soon",
        hero: "images/image53.jpg",
      },
      {
        id:"1644-mistletoe",
        name:"1644 W Mistletoe Ave",
        address:"1644 W Mistletoe Ave, San Antonio, TX 78201",
        units: ["101","102","201","202"],
        rent: 1750,
        beds: 2, baths: 2,
        sqftByUnit: { "101":836,"102":836,"201":836,"202":836 },
        statusByUnit: { "101":"Available","102":"Available","201":"Available","202":"Available" },
                photosByUnit: {
          "101": ["images/image73.jpg","images/image74.jpg","images/image75.jpg","images/image76.jpg","images/image77.jpg","images/image78.jpg","images/image79.jpg","images/image80.jpg","images/image81.jpg","images/image82.jpg"],
          "102": ["images/image73.jpg","images/image74.jpg","images/image75.jpg","images/image76.jpg","images/image77.jpg","images/image78.jpg","images/image79.jpg","images/image80.jpg","images/image81.jpg","images/image82.jpg"],
          "201": ["images/image73.jpg","images/image74.jpg","images/image75.jpg","images/image76.jpg","images/image77.jpg","images/image78.jpg","images/image79.jpg","images/image80.jpg","images/image81.jpg","images/image82.jpg"],
          "202": ["images/image73.jpg","images/image74.jpg","images/image75.jpg","images/image76.jpg","images/image77.jpg","images/image78.jpg","images/image79.jpg","images/image80.jpg","images/image81.jpg","images/image82.jpg"]
        },
        status: "Available",
        heroPhotos: ["images/image54.jpg","images/image117.jpg","images/image118.jpg","images/image119.jpg","images/image122.jpg","images/image121.jpg","images/image73.jpg","images/image74.jpg","images/image75.jpg","images/image76.jpg","images/image77.jpg","images/image78.jpg","images/image79.jpg","images/image80.jpg","images/image81.jpg","images/image82.jpg"],
      },
      {
        id:"1505-woodlawn",
        name:"1505 W Woodlawn Ave",
        address:"1505 W Woodlawn Ave, San Antonio, TX 78201",
        units: ["1","2","3","4"],
        rent: 1500,
        beds: 2, baths: 1,
        sqftByUnit: { "1":636,"2":636,"3":636,"4":636 },
        statusByUnit: { "1":"Waitlist","2":"Available","3":"Waitlist","4":"Available" },
                photosByUnit: {
          "1": ["images/image94.jpg","images/image95.jpg","images/image96.jpg","images/image97.jpg","images/image98.jpg","images/image99.jpg","images/image100.jpg","images/image101.jpg","images/image102.jpg","images/image103.jpg","images/image104.jpg","images/image105.jpg"],
          "2": ["images/image94.jpg","images/image95.jpg","images/image96.jpg","images/image97.jpg","images/image98.jpg","images/image99.jpg","images/image100.jpg","images/image101.jpg","images/image102.jpg","images/image103.jpg","images/image104.jpg","images/image105.jpg"],
          "3": ["images/image94.jpg","images/image95.jpg","images/image96.jpg","images/image97.jpg","images/image98.jpg","images/image99.jpg","images/image100.jpg","images/image101.jpg","images/image102.jpg","images/image103.jpg","images/image104.jpg","images/image105.jpg"],
          "4": ["images/image94.jpg","images/image95.jpg","images/image96.jpg","images/image97.jpg","images/image98.jpg","images/image99.jpg","images/image100.jpg","images/image101.jpg","images/image102.jpg","images/image103.jpg","images/image104.jpg","images/image105.jpg"]
        },
        status: "Available",
        heroPhotos: ["images/image55.jpg","images/image106.jpg","images/image107.jpg","images/image108.jpg","images/image109.jpg","images/image110.jpg","images/image111.jpg","images/image94.jpg","images/image95.jpg","images/image96.jpg","images/image97.jpg","images/image98.jpg","images/image99.jpg","images/image100.jpg","images/image101.jpg","images/image102.jpg","images/image103.jpg","images/image104.jpg","images/image105.jpg"],
      },
      {
        id:"402-ada",
        name:"402 Ada",
        address:"402 Ada, San Antonio, TX 78223",
        units: ["1","2"],
        rent: 1450,
        beds: 3, baths: 2,
        sqftByUnit: { "1":1100,"2":1100 },
        statusByUnit: { "1":"Waitlist","2":"Waitlist" },
                photosByUnit: {
          "101": ["images/image51.jpg","images/image52.jpg"],
          "102": ["images/image52.jpg","images/image51.jpg"],
          "201": ["images/image53.jpg","images/image52.jpg"],
          "202": ["images/image54.jpg","images/image52.jpg"]
        },
        status: "Waitlist",
        hero: "images/image56.jpg",
      },
      {
        id:"410-regina",
        name:"410 Regina St",
        address:"410 Regina St, San Antonio, TX 78223",
        units: ["1","2","3","4"],
        rent: 1450,
        beds: 3, baths: 1,
        sqftByUnit: { "1":864,"2":864,"3":864,"4":864 },
        statusByUnit: { "1":"Waitlist","2":"Waitlist","3":"Available","4":"Waitlist" },
                photosByUnit: {
          "1": ["images/image87.jpg","images/image88.jpg","images/image89.jpg","images/image90.jpg","images/image91.jpg","images/image83.jpg","images/image92.jpg","images/image93.jpg","images/image84.jpg","images/image86.jpg","images/image85.jpg"],
          "2": ["images/image87.jpg","images/image88.jpg","images/image89.jpg","images/image90.jpg","images/image91.jpg","images/image83.jpg","images/image92.jpg","images/image93.jpg","images/image84.jpg","images/image86.jpg","images/image85.jpg"],
          "3": ["images/image87.jpg","images/image88.jpg","images/image89.jpg","images/image90.jpg","images/image91.jpg","images/image83.jpg","images/image92.jpg","images/image93.jpg","images/image84.jpg","images/image86.jpg","images/image85.jpg"],
          "4": ["images/image87.jpg","images/image88.jpg","images/image89.jpg","images/image90.jpg","images/image91.jpg","images/image83.jpg","images/image92.jpg","images/image93.jpg","images/image84.jpg","images/image86.jpg","images/image85.jpg"]
        },
        status: "Available",
        heroPhotos: ["images/image57.jpg","images/image84.jpg","images/image86.jpg","images/image85.jpg","images/image87.jpg","images/image88.jpg","images/image89.jpg","images/image90.jpg","images/image91.jpg","images/image83.jpg","images/image92.jpg","images/image93.jpg"],
      },
      {
        id:"408-regina",
        name:"408 Regina St",
        address:"408 Regina St, San Antonio, TX 78223",
        units: ["1","2","3","4"],
        rent: 1450,
        beds: 3, baths: 1,
        sqftByUnit: { "1":864,"2":864,"3":864,"4":864 },
        statusByUnit: { "1":"Waitlist","2":"Available","3":"Waitlist","4":"Waitlist" },
                photosByUnit: {
          "1": ["images/image87.jpg","images/image88.jpg","images/image89.jpg","images/image90.jpg","images/image91.jpg","images/image83.jpg","images/image92.jpg","images/image93.jpg","images/image84.jpg","images/image86.jpg","images/image85.jpg"],
          "2": ["images/image87.jpg","images/image88.jpg","images/image89.jpg","images/image90.jpg","images/image91.jpg","images/image83.jpg","images/image92.jpg","images/image93.jpg","images/image84.jpg","images/image86.jpg","images/image85.jpg"],
          "3": ["images/image87.jpg","images/image88.jpg","images/image89.jpg","images/image90.jpg","images/image91.jpg","images/image83.jpg","images/image92.jpg","images/image93.jpg","images/image84.jpg","images/image86.jpg","images/image85.jpg"],
          "4": ["images/image87.jpg","images/image88.jpg","images/image89.jpg","images/image90.jpg","images/image91.jpg","images/image83.jpg","images/image92.jpg","images/image93.jpg","images/image84.jpg","images/image86.jpg","images/image85.jpg"]
        },
        status: "Available",
        heroPhotos: ["images/image57.jpg","images/image84.jpg","images/image86.jpg","images/image85.jpg","images/image87.jpg","images/image88.jpg","images/image89.jpg","images/image90.jpg","images/image91.jpg","images/image83.jpg","images/image92.jpg","images/image93.jpg"],
      },
    ].map((p,i)=>{
      const heroPhotos = Array.isArray(p.hero) ? p.hero
        : (Array.isArray(p.heroPhotos) && p.heroPhotos.length ? p.heroPhotos
        : (p.hero ? [p.hero]
        : (p.photos || placeholderPhotos)));
      return ({
      ...p,
      type:"Multifamily",
      // Default per-unit status to property status if none provided
      statusByUnit: p.statusByUnit || Object.fromEntries(p.units.map(u => [u, p.status])),
      // Default per-unit photos to property photos or placeholders
      photosByUnit: p.photosByUnit || Object.fromEntries(p.units.map(u => [u, p.photos || placeholderPhotos])),
      heroPhotos,
      hero: heroPhotos[0] || placeholderPhotos[i % placeholderPhotos.length],
      photos: p.photos || placeholderPhotos,
      tags: [
        `${p.beds} bd / ${p.baths} ba`,
        `${money(p.rent)}/mo`,
        p.status
      ],
      notes:
        p.status === "Waitlist" ? "Join the waitlist — apply online." :
        p.status === "Coming Soon" ? "Coming soon — apply online to get started." :
        "Available — apply online or request a tour."
    });
    });

    const singlefamily = [
      {
        id:"8030-bluewater",
        name:"8030 Bluewater Cove",
        address:"8030 Bluewater Cove, San Antonio, TX 78254",
        rent: 2850, sqft: 2601, beds: 5, baths: 2.5,
        status: "Waitlist",
        hero: "images/image62.jpg",
        photos: ["images/image62.jpg","images/image61.jpg","images/image60.jpg"],
      },
      {
        id:"106-regina",
        name:"106 Regina St",
        address:"106 Regina St, San Antonio, TX 78223",
        rent: 1700, sqft: 924, beds: 3, baths: 2,
        status: "Waitlist",
        hero: "images/image59.jpg",
        photos: ["images/image59.jpg","images/image58.jpg","images/image57.jpg"],
      },
      {
        id:"12851-limestone",
        name:"12851 Limestone Way",
        address:"12851 Limestone Way, San Antonio, TX 78253",
        rent: 2850, sqft: 2375, beds: 4, baths: 3,
        status: "Waitlist",
        hero: "images/image61.jpg",
        photos: ["images/image61.jpg","images/image62.jpg","images/image55.jpg"],
      },
      {
        id:"2007-magnolia",
        name:"2007 W Magnolia Ave",
        address:"2007 W Magnolia Ave, San Antonio, TX 78201",
        rent: 3000, sqft: 2500, beds: 3, baths: 2,
        status: "Waitlist",
        hero: "images/image60.jpg",
        photos: ["images/image60.jpg","images/image55.jpg","images/image54.jpg"],
      },
    ].map((h,i)=>{
      const heroPhotos = Array.isArray(h.hero) ? h.hero
        : (Array.isArray(h.heroPhotos) && h.heroPhotos.length ? h.heroPhotos
        : (h.hero ? [h.hero]
        : (h.photos || placeholderPhotos)));
      return ({
      ...h,
      type:"Single-family",
      heroPhotos,
      hero: heroPhotos[0] || ((h.photos && h.photos[0]) || placeholderPhotos[(i+1) % placeholderPhotos.length]),
      tags: [
        `${h.beds} bd / ${h.baths} ba`,
        `${money(h.rent)}/mo`,
        h.status
      ],
      notes: h.status === "Waitlist" ? "Join the waitlist — apply online." : "Apply online or request a tour.",
      photos: h.photos || placeholderPhotos
    });
    });

    // Build records used by Availability table + Modal
    const allRecords = [
      ...multifamily.flatMap(p => p.units.map(u => {
        const unitStatus = (p.statusByUnit && p.statusByUnit[u]) ? p.statusByUnit[u] : p.status;
        const unitRent = (p.rentByUnit && typeof p.rentByUnit[u] === 'number') ? p.rentByUnit[u] : p.rent;
        return ({
          key: `${p.id}::${u}`,
          type: "Multifamily",
          label: `Unit ${u}`,
          title: `${p.name} • Unit ${u}`,
          address: p.address,
          beds: p.beds, baths: p.baths,
          sqft: p.sqftByUnit?.[u] ?? null,
          rent: unitRent,
          status: unitStatus,
          notes: notesForStatus(unitStatus),
          photos: (p.photosByUnit && Array.isArray(p.photosByUnit[u]) && p.photosByUnit[u].length)
            ? p.photosByUnit[u]
            : (p.photos || placeholderPhotos)
        });
      })),
      ...singlefamily.map(h => ({
        key: `${h.id}::home`,
        type: "Single-family",
        label: "Home",
        title: h.name,
        address: h.address,
        beds: h.beds, baths: h.baths,
        sqft: h.sqft,
        rent: h.rent,
        status: h.status,
        notes: h.notes,
        photos: h.photos || placeholderPhotos
      }))
    ];


// ========= Map helpers =========
function buildPropertiesList(){
  const mf = multifamily.map(p=>({ id:p.id, name:p.name, address:p.address, type:"Multifamily", lat:p.lat, lon:p.lon }));
  const sf = singlefamily.map(h=>({ id:h.id, name:h.name, address:h.address, type:"Single-family", lat:h.lat, lon:h.lon }));
  return [...mf, ...sf];
}
function loadGeoCache(){
  try{ return JSON.parse(localStorage.getItem("geoCache")||"{}"); }catch{ return {}; }
}
function saveGeoCache(cache){
  try{ localStorage.setItem("geoCache", JSON.stringify(cache)); }catch{}
}
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

// NOTE: Best practice is to store coordinates (lat/lon) in your data.
// If not present, this uses Nominatim and paces requests to be respectful.
let _geoQueue = Promise.resolve();
async function geocodeAddress(address){
  if(!address) return null;

  const cache = loadGeoCache();
  if(cache[address]) return cache[address];

  _geoQueue = _geoQueue.then(async ()=>{
    await sleep(GEO_RATE_LIMIT_MS);
    try{
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
      const resp = await fetch(url, { headers: { "Accept":"application/json" } });
      const data = await resp.json();
      if(Array.isArray(data) && data.length){
        const lat = parseFloat(data[0].lat);
        const lon = parseFloat(data[0].lon);
        cache[address] = { lat, lon };
        saveGeoCache(cache);
        return cache[address];
      }
    }catch(e){
      console.warn("Geocode failed", address, e);
    }
    return null;
  });

  return _geoQueue;
}

function viewUnits(address, unitLabel){
  const q = $("#q");
  if(q) q.value = unitLabel ? `${address} ${unitLabel}` : address;
  document.getElementById("availability")?.scrollIntoView({behavior:"smooth"});
  applyFilters();
}

function scheduleTourFor(interested){
  document.getElementById("contact")?.scrollIntoView({behavior:"smooth"});
  const el = document.getElementById("leadInterested"); if(el) el.value = interested || "";
  const name = document.getElementById("leadName"); if(name) name.focus();
}

// ========= Modal =========
const modalEl = document.getElementById("modal");
const modalTrap = modalEl ? createFocusTrap(modalEl) : null;
let lastFocusEl = null;
const modalState = { mode:"unit", rec:null, photos:[], photoIndex:0, parentKind:null, parentId:null, applyAddress:null, applyUnitLabel:null, map:null, mapCoord:null };

function renderHighlights(bb){
  const mHL = document.getElementById("mHighlights");
  if(!mHL) return;

  const hl = [];
  if(bb && bb !== "—") hl.push({ icon:"bed", text: bb });
  hl.push(
    { icon:"weekend", text: "Open-concept living & kitchen area" },
    { icon:"auto_awesome", text: "High-end finishes and modern fixtures" },
    { icon:"restaurant", text: "Stainless steel appliances" },
    { icon:"local_laundry_service", text: "In-unit washer & dryer" },
    { icon:"local_parking", text: "On-site parking" },
    { icon:"pets", text: "Pet-friendly" },
    { icon:"local_shipping", text: "Move-in ready" }
  );

  mHL.innerHTML = `<h5>Highlights</h5><div class="hl-list">${hl.map(h=>`<span class="chip"><span class="chip-icon material-symbols-outlined">${h.icon}</span>${h.text}</span>`).join("")}</div>`;
}

async function renderModalMap(address){
  if(!window.L) return;
  const el = document.getElementById("mMap");
  if(!el) return;

  const coord = await geocodeAddress(address);
  if(!coord) return;

  modalState.mapCoord = coord;

  if(!modalState.map){
    modalState.map = L.map(el).setView([coord.lat, coord.lon], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(modalState.map);
    L.marker([coord.lat, coord.lon]).addTo(modalState.map);
  }else{
    modalState.map.setView([coord.lat, coord.lon], 14);
    // Clear existing markers and add a fresh one
    modalState.map.eachLayer(layer=>{
      if(layer instanceof L.Marker) modalState.map.removeLayer(layer);
    });
    L.marker([coord.lat, coord.lon]).addTo(modalState.map);
  }
}

function openModalShell(){
  lastFocusEl = document.activeElement;
  lockBodyScroll();
  modalEl?.classList.add("open");
  modalTrap?.activate();
  // Focus close button for keyboard users
  document.getElementById("mClose")?.focus();
}
function closeModal(){
  modalEl?.classList.remove("open");
  modalTrap?.deactivate();
  modalState.rec = null;
  modalState.photos = [];
  modalState.photoIndex = 0;
  modalState.parentKind = null;
  modalState.parentId = null;
  modalState.applyAddress = null;
  modalState.applyUnitLabel = null;
  modalState.mapCoord = null;
  unlockBodyScroll();
  // Restore focus
  if(lastFocusEl && typeof lastFocusEl.focus === "function"){
    lastFocusEl.focus();
  }
}

function setModalPhoto(idx){
  const photos = (modalState.photos || []);
  if(!photos.length) return;
  modalState.photoIndex = (idx + photos.length) % photos.length;
  const img = document.getElementById("mImg");
  smoothSwap(img, photos[modalState.photoIndex]);
}
function nextPhoto(){ setModalPhoto(modalState.photoIndex + 1); }
function prevPhoto(){ setModalPhoto(modalState.photoIndex - 1); }

function openUnitModal(key){
  const rec = allRecords.find(r=>r.key===key);
  if(!rec) return;

  modalState.mode = "unit";
  modalState.rec = rec;
  modalState.photos = (Array.isArray(rec.photos) && rec.photos.length) ? rec.photos : placeholderPhotos;
  modalState.photoIndex = 0;

  setText("mTitle", rec.title);
  setText("mSub", rec.address);
  setText("mType", rec.type);
  setText("mStatus", rec.status);
  const unitBB = bedsBaths(rec.beds, rec.baths);
  setText("mBedsBaths", unitBB);
  setText("mSqft", (typeof rec.sqft === "number") ? rec.sqft.toLocaleString() : "—");
  setText("mRent", money(rec.rent));
  setText("mNotes", rec.notes || "");
  const canUnitApply = canApply(rec.status);
  setText("mApplyHint", canUnitApply ? "Available to apply" : "Not accepting applications");
  const applyHintEl = document.getElementById("mApplyHint");
  if(applyHintEl){
    applyHintEl.classList.toggle("apply-hint-clickable", canUnitApply);
  }
  modalState.applyAddress = rec.address;
  modalState.applyUnitLabel = rec.label || "";
  renderHighlights(unitBB);
  const mAvail = document.getElementById("mAvailList"); if(mAvail) mAvail.innerHTML = "";

  const img = document.getElementById("mImg");
  if(img) img.src = modalState.photos[0] || placeholderPhotos[0];
  renderModalMap(rec.address);

  // Show back-to-property button when we have a parent property context
  const backBtn = document.getElementById("mBack");
  if(backBtn){
    if(modalState.parentId && modalState.parentKind){
      backBtn.style.display = "inline-flex";
      backBtn.onclick = ()=> openPropertyModal(modalState.parentKind, modalState.parentId);
    }else{
      backBtn.style.display = "none";
      backBtn.onclick = null;
    }
  }

  // Prefill contact form
  const interested = document.getElementById("leadInterested");
  if(interested) interested.value = rec.title;

  openModalShell();
}

function openPropertyModal(kind, id){
  let prop = null;
  if(kind === "Multifamily") prop = multifamily.find(p=>p.id===id);
  if(kind === "Single-family") prop = singlefamily.find(h=>h.id===id);
  if(!prop) return;

  modalState.mode = "property";
  modalState.rec = null;
  modalState.parentKind = kind;
  modalState.parentId = id;
  modalState.photos = (Array.isArray(prop.heroPhotos) && prop.heroPhotos.length) ? prop.heroPhotos : (prop.photos || placeholderPhotos);
  modalState.photoIndex = 0;

  setText("mTitle", prop.name);
  setText("mSub", prop.address);
  setText("mType", kind);
  setText("mStatus", prop.status || "—");
  const bb = (typeof prop.beds==="number" && typeof prop.baths==="number") ? `${prop.beds} bd / ${prop.baths} ba` : "—";
  setText("mBedsBaths", bb);
  setText("mSqft", "—");
  setText("mRent", money(prop.rent));
  const canPropApply = canApply(prop.status);
  setText("mApplyHint", canPropApply ? "Available to apply" : "Not accepting applications");
  const applyHintEl2 = document.getElementById("mApplyHint");
  if(applyHintEl2){
    applyHintEl2.classList.toggle("apply-hint-clickable", canPropApply);
  }
  modalState.applyAddress = prop.address;
  modalState.applyUnitLabel = (kind === "Single-family" ? "Home" : "");
  setText("mNotes", prop.notes || "");

  const img = document.getElementById("mImg");
  if(img) img.src = modalState.photos[0] || placeholderPhotos[0];

  // Hide back button in property view
  const backBtn = document.getElementById("mBack");
  if(backBtn){
    backBtn.style.display = "none";
    backBtn.onclick = null;
  }

  // Highlights
  renderHighlights(bb);
  renderModalMap(prop.address);

  // Available units list (property modal)
  const mAvail = document.getElementById("mAvailList");
  if(mAvail){
    if(kind === "Multifamily"){
      const items = (prop.units||[]).map(u=>{
        const st = (prop.statusByUnit && prop.statusByUnit[u]) ? prop.statusByUnit[u] : (prop.status||"Waitlist");
        const rowKey = `${prop.id}::${u}`;
        const can = canApply(st);
        return `
          <div class="avail-row">
            <div class="left"><b>Unit ${u}</b><span class="${tagClass(st)}"><span class="mini-dot"></span>${st}</span></div>
            <div class="right">
              <button class="btn" data-open="${rowKey}">View</button>
              <button class="btn" data-sch="${prop.name} • Unit ${u}">Schedule</button>
              ${can ? `<a class="btn apply" href="${buildApplyUrl(prop.address, "Unit " + u)}" target="_blank" rel="noopener">Apply</a>` : ""}
            </div>
          </div>`;
      }).join("");
      mAvail.innerHTML = `<h5>Available units</h5><div class="avail-list">${items || '<div style="color:var(--muted);font-size:13px">No units to show.</div>'}</div>`;
    }else{
      const rowKey = `${prop.id}::home`;
      const st = prop.status || "Waitlist";
      const can = canApply(st);
      mAvail.innerHTML = `
        <h5>Available units</h5>
        <div class="avail-list">
          <div class="avail-row">
            <div class="left"><b>Home</b><span class="${tagClass(st)}"><span class="mini-dot"></span>${st}</span></div>
            <div class="right">
              <button class="btn" data-open="${rowKey}">View details</button>
              <button class="btn" data-sch="${prop.name}">Schedule</button>
              ${can ? `<a class="btn apply" href="${buildApplyUrl(prop.address, "Home")}" target="_blank" rel="noopener">Apply</a>` : ""}
            </div>
          </div>
        </div>`;
    }
  }

  // Prefill contact form with property name
  const interested = document.getElementById("leadInterested");
  if(interested) interested.value = prop.name;

  openModalShell();
}

// ========= Cards =========
function attachCardKeyHandlers(cardEl, onOpen){
  onActivate(cardEl, (e)=>{
    // Ignore clicks on buttons inside the card
    if(e?.target?.closest?.(".btn") || e?.target?.closest?.(".img-next") || e?.target?.closest?.(".img-prev")) return;
    onOpen();
  });
}

function mountPhotoCycler({wrapEl, imgEl, photos}){
  if(!wrapEl || !imgEl || !Array.isArray(photos) || photos.length < 2) return;
  const nextBtn = wrapEl.querySelector(".img-next");
  const prevBtn = wrapEl.querySelector(".img-prev");
  let idx = 0;
  let anim = false;

  // Dots (max 3)
  const dotsTotal = Math.min(photos.length, 3);
  const dots = document.createElement("div");
  dots.className = "img-dots";
  const pips = [];
  for(let i=0;i<dotsTotal;i++){
    const s = document.createElement("span");
    s.className = "pip";
    dots.appendChild(s);
    pips.push(s);
  }
  wrapEl.appendChild(dots);

  function updateDots(){
    const clusterSize = Math.ceil(photos.length / dotsTotal);
    let active = Math.floor(idx / clusterSize);
    active = Math.max(0, Math.min(dotsTotal - 1, active));
    pips.forEach((el,i)=>el.classList.toggle("active", i===active));
  }
  updateDots();

  async function go(nextIdx){
    if(anim) return;
    anim = true;
    idx = (nextIdx + photos.length) % photos.length;
    await smoothSwap(imgEl, photos[idx]);
    anim = false;
    updateDots();
  }

  nextBtn?.addEventListener("click", (e)=>{ e.stopPropagation(); go(idx + 1); });
  prevBtn?.addEventListener("click", (e)=>{ e.stopPropagation(); go(idx - 1); });

  // Touch swipe
  let sx=0, sy=0;
  wrapEl.addEventListener("touchstart", (e)=>{
    const t = e.changedTouches[0];
    sx = t.clientX; sy = t.clientY;
  }, { passive:true });
  wrapEl.addEventListener("touchend", (e)=>{
    const t = e.changedTouches[0];
    const dx = t.clientX - sx;
    const dy = t.clientY - sy;
    if(Math.abs(dx) > 30 && Math.abs(dx) > Math.abs(dy)){
      e.preventDefault();
      e.stopPropagation();
      go(dx < 0 ? idx + 1 : idx - 1);
    }
  }, { passive:false });
}

function renderMF(){
  const grid = document.getElementById("mfGrid");
  if(!grid) return;
  grid.innerHTML = "";
  const frag = document.createDocumentFragment();

  const list = [...multifamily].sort((a,b)=>{
    const weight = (s)=> (s === "Available") ? 0 : (s === "Waitlist") ? 1 : (s === "Coming Soon") ? 2 : 3;
    const wa = weight(a.status);
    const wb = weight(b.status);
    if(wa !== wb) return wa - wb;
    return a.name.localeCompare(b.name);
  });

  list.forEach(p=>{
    const pill = pillForStatus(p.status);

    let rentDisplay = "";
    if(p.rentByUnit && typeof p.rentByUnit === "object"){
      const rents = (p.units||[]).map(u=>p.rentByUnit[u]).filter(r=>typeof r === "number");
      const unique = Array.from(new Set(rents));
      if(unique.length === 1) rentDisplay = `${money(unique[0])}/mo`;
      else if(unique.length > 1) rentDisplay = `${money(Math.min(...unique))} - ${money(Math.max(...unique))}/mo`;
      else rentDisplay = `${money(p.rent)}/mo`;
    }else{
      rentDisplay = `${money(p.rent)}/mo`;
    }

    const el = document.createElement("div");
    el.className = "card";
    el.tabIndex = 0;
    el.setAttribute("role","button");
    el.setAttribute("aria-label", `${p.name}, ${p.status}. Open details.`);

    el.innerHTML = `
      <div class="img">
        <img alt="${p.name}" src="${p.hero}" loading="lazy" decoding="async">
        ${Array.isArray(p.heroPhotos) && p.heroPhotos.length > 1 ? `<button class="img-prev" aria-label="Previous photo">‹</button><button class="img-next" aria-label="Next photo">›</button>` : ``}
        <div class="${pill.cls}">${pill.text}</div>
      </div>
      <div class="body">
        <div class="title">
          <div>
            <h4>${p.name}</h4>
            <p class="addr">${p.address}</p>
          </div>
          <div style="font-weight:700;font-size:12px;color:rgba(234,240,247,.9)">${rentDisplay}</div>
        </div>
        <div class="meta">
          <span class="chip">${p.beds} bd / ${p.baths} ba</span>
          <span class="chip">${(p.units||[]).length} units</span>
          <span class="chip">${p.status}</span>
        </div>
        <div class="card-actions">
          <button class="btn" type="button" data-jump="${p.address}">View units</button>
          ${canApply(p.status) ? `<a class="btn apply" href="${buildApplyUrl(p.address, "")}" target="_blank" rel="noopener">Apply</a>` : ``}
        </div>
      </div>
    `;

    // Property modal on click/keyboard
    attachCardKeyHandlers(el, ()=>openPropertyModal("Multifamily", p.id));

    // Jump-to-availability button
    el.querySelector("[data-jump]")?.addEventListener("click", (e)=>{
      e.stopPropagation();
      document.getElementById("availability")?.scrollIntoView({behavior:"smooth"});
      const q = document.getElementById("q");
      if(q) q.value = p.address;
      applyFilters();
    });

    mountPhotoCycler({
      wrapEl: el.querySelector(".img"),
      imgEl: el.querySelector(".img img"),
      photos: p.heroPhotos
    });

    frag.appendChild(el);
  });

  grid.appendChild(frag);
}

function renderSFH(){
  const grid = document.getElementById("sfhGrid");
  if(!grid) return;
  grid.innerHTML = "";
  const frag = document.createDocumentFragment();

  singlefamily.forEach(h=>{
    const pill = pillForStatus(h.status);
    const el = document.createElement("div");
    el.className = "card";
    el.tabIndex = 0;
    el.setAttribute("role","button");
    el.setAttribute("aria-label", `${h.name}, ${h.status}. Open details.`);

    el.innerHTML = `
      <div class="img">
        <img alt="${h.name}" src="${h.hero}" loading="lazy" decoding="async">
        ${Array.isArray(h.heroPhotos) && h.heroPhotos.length > 1 ? `<button class="img-prev" aria-label="Previous photo">‹</button><button class="img-next" aria-label="Next photo">›</button>` : ``}
        <div class="${pill.cls}">${pill.text}</div>
      </div>
      <div class="body">
        <div class="title">
          <div>
            <h4>${h.name}</h4>
            <p class="addr">${h.address}</p>
          </div>
          <div style="font-weight:700;font-size:12px;color:rgba(234,240,247,.9)">${money(h.rent)}/mo</div>
        </div>
        <div class="meta">
          <span class="chip">${h.beds} bd / ${h.baths} ba</span>
          <span class="chip">${(h.sqft||0).toLocaleString()} sq ft</span>
          <span class="chip">${h.status}</span>
        </div>
        <div class="card-actions">
          <button class="btn" type="button" data-open="${h.id}::home">View details</button>
          ${canApply(h.status) ? `<a class="btn apply" href="${buildApplyUrl(h.address, "Home")}" target="_blank" rel="noopener">Apply</a>` : ``}
        </div>
      </div>
    `;

    attachCardKeyHandlers(el, ()=>openPropertyModal("Single-family", h.id));

    el.querySelector("[data-open]")?.addEventListener("click", (e)=>{
      e.stopPropagation();
      openUnitModal(`${h.id}::home`);
    });

    mountPhotoCycler({
      wrapEl: el.querySelector(".img"),
      imgEl: el.querySelector(".img img"),
      photos: h.heroPhotos
    });

    frag.appendChild(el);
  });

  grid.appendChild(frag);
}

// ========= Availability =========
function updateResultCount(n){
  const el = document.getElementById("resultCount");
  if(!el) return;
  const label = n === 1 ? "result" : "results";
  el.textContent = `${n.toLocaleString()} ${label}`;
}

function renderTable(rows){
  const tbody = document.getElementById("rows");
  const cards = document.getElementById("rowsCards");
  if(!tbody || !cards) return;

  tbody.innerHTML = "";
  cards.innerHTML = "";

  updateResultCount(rows.length);

  if(!rows.length){
    const emptyMsg = "No matches. Try changing filters.";
    tbody.innerHTML = `<tr><td colspan="8" style="color:var(--muted);padding:18px 14px;">${emptyMsg}</td></tr>`;
    cards.innerHTML = `<div class="unit-card" style="color:var(--muted);">${emptyMsg}</div>`;
    return;
  }

  const frag = document.createDocumentFragment();
  const cfrag = document.createDocumentFragment();

  rows.forEach(r=>{
    const tr = document.createElement("tr");
    const applyCell = canApply(r.status)
      ? `<a class="btn apply" style="padding:8px 10px;border-radius:12px;" href="${buildApplyUrl(r.address, r.label)}" target="_blank" rel="noopener">Apply</a>`
      : `<span style="color:var(--muted);font-size:12px;">—</span>`;

    tr.innerHTML = `
      <td>${r.type}</td>
      <td><b>${r.label}</b></td>
      <td>
        <div style="font-weight:600">${r.title}</div>
        <div style="color:var(--muted);font-size:12px;margin-top:2px">${r.address}</div>
      </td>
      <td>${bedsBaths(r.beds,r.baths)}</td>
      <td>${(typeof r.sqft === "number") ? r.sqft.toLocaleString() : "—"}</td>
      <td><b>${money(r.rent)}</b></td>
      <td><span class="${tagClass(r.status)}"><span class="mini-dot"></span>${r.status}</span></td>
      <td style="display:flex;gap:10px;align-items:center;">
        <button class="link" type="button" data-open="${r.key}" style="background:none;border:none;padding:0;">View</button>
        ${applyCell}
      </td>
    `;
    frag.appendChild(tr);

    const card = document.createElement("div");
    card.className = "unit-card";
    const applyBtn = canApply(r.status)
      ? `<a class="btn apply" href="${buildApplyUrl(r.address, r.label)}" target="_blank" rel="noopener">Apply</a>`
      : "";
    card.innerHTML = `
      <div class="head">
        <div>
          <b>${r.label}</b>
          <div class="sub">${r.type}</div>
        </div>
        <div><span class="${tagClass(r.status)}"><span class="mini-dot"></span>${r.status}</span></div>
      </div>
      <div style="margin-top:10px;">
        <div style="font-weight:600">${r.title}</div>
        <div class="sub">${r.address}</div>
      </div>
      <div class="meta">
        <span class="chip">${bedsBaths(r.beds,r.baths)}</span>
        <span class="chip">${(typeof r.sqft === "number") ? r.sqft.toLocaleString()+" sq ft" : "Sq ft —"}</span>
        <span class="chip">${money(r.rent)}/mo</span>
      </div>
      <div class="actions">
        <button class="btn" type="button" data-open="${r.key}">View</button>
        ${applyBtn}
      </div>
    `;
    cfrag.appendChild(card);
  });

  tbody.appendChild(frag);
  cards.appendChild(cfrag);
}

function readFiltersFromUI(){
  return {
    q: ($("#q")?.value || "").trim(),
    type: ($("#type")?.value || ""),
    beds: ($("#beds")?.value || ""),
    status: ($("#status")?.value || ""),
    maxPrice: ($("#maxPrice")?.value || ""),
  };
}
function writeFiltersToUI(filters){
  if($("#q")) $("#q").value = filters.q || "";
  if($("#type")) $("#type").value = filters.type || "";
  if($("#beds")) $("#beds").value = filters.beds || "";
  if($("#status")) $("#status").value = filters.status || "";
  if($("#maxPrice")) $("#maxPrice").value = filters.maxPrice || "";
}

function applyFilters(){
  const filters = readFiltersFromUI();
  setUrlFromFilters(filters);

  const q = (filters.q || "").toLowerCase();
  const type = filters.type;
  const bedsMin = filters.beds ? parseInt(filters.beds, 10) : null;
  const status = filters.status;
  const maxPrice = parseInt(filters.maxPrice || "0", 10);

  let rows = [...allRecords];

  if(type) rows = rows.filter(r=>r.type===type);
  if(status) rows = rows.filter(r=>r.status===status);
  if(bedsMin !== null) rows = rows.filter(r=>typeof r.beds==="number" && r.beds >= bedsMin);
  if(maxPrice > 0) rows = rows.filter(r=>typeof r.rent==="number" && r.rent <= maxPrice);

  if(q){
    rows = rows.filter(r =>
      (r.address||"").toLowerCase().includes(q) ||
      (r.title||"").toLowerCase().includes(q) ||
      (r.label||"").toLowerCase().includes(q)
    );
  }

  renderTable(rows);
}

function clearFilters(){
  // Reset to the site default: Available now selected (matches your original intent)
  const defaults = { q:"", type:"", beds:"", status:"Available", maxPrice:"" };
  writeFiltersToUI(defaults);
  applyFilters();
}

// ========= Stats =========
function updateStats(){
  const totalProps = multifamily.length + singlefamily.length;
  const totalUnits = allRecords.filter(r=>r.type==="Multifamily").length;
  const available = allRecords.filter(r=>r.status==="Available").length;
  const coming = allRecords.filter(r=>r.status==="Coming Soon").length;

  setText("statProperties", totalProps);
  setText("statUnits", totalUnits);
  setText("statAvailable", available);
  setText("statComingSoon", coming);
}

    function escapeQuotes(s){ return String(s||'').replace(/"/g,'&quot;').replace(/'/g,"\\'"); }
    function viewUnits(address, unitLabel){
      const q = document.getElementById('q');
      if(q){ q.value = unitLabel ? `${address} ${unitLabel}` : address; }
      document.getElementById('availability').scrollIntoView({behavior:'smooth'});
      applyFilters();
    }


// ========= Map =========
async function initMap(){
      if(!window.L || !document.getElementById('mapCanvas')) return;
      const map = L.map('mapCanvas').setView([29.4237, -98.4934], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      const propertyMarkers = [];

      const props = buildPropertiesList();
      const coordsByAddress = {};
      for(const p of props){
        const c = await geocodeAddress(p.address);
        if(!c) continue;
        coordsByAddress[p.address] = c;
        const m = L.marker([c.lat, c.lon]);
        const gmaps = `https://www.google.com/maps/search/?api=1&query=${c.lat},${c.lon}`;
        const popup = `
          <b>${p.name}</b><br/>
          <span style="color:var(--muted);font-size:12px">${p.address}</span>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button style="color:var(--muted);" class="btn" onclick="viewUnits('${escapeQuotes(p.address)}')">View units</button>
            <button style="color:var(--muted);" class="btn" onclick="scheduleTourFor('${escapeQuotes(p.name)}')">Book a tour</button>
            <a class="btn" href="${gmaps}" target="_blank" rel="noopener">Open in Google Maps</a>
          </div>
        `;
        m.bindPopup(popup);
        m.addTo(map);
        propertyMarkers.push(m);
      }
      if(propertyMarkers.length){
        const group = L.featureGroup(propertyMarkers);
        map.fitBounds(group.getBounds(), { padding:[20,20] });
      }

      // Unit-level pins toggle
      const toggle = document.getElementById('toggleUnitPins');
      let unitPinsBuilt = false;
      let unitLayer = L.layerGroup();
      async function buildUnitPins(){
        unitLayer.clearLayers();
        for(const rec of allRecords){
          let coord = coordsByAddress[rec.address];
          if(!coord){ coord = await geocodeAddress(rec.address); if(coord) coordsByAddress[rec.address] = coord; }
          if(!coord) continue;
          const gmaps = `https://www.google.com/maps/search/?api=1&query=${coord.lat},${coord.lon}`;
          const popup = `
            <b>${rec.title}</b><br/>
            <span style="color:var(--muted);font-size:12px">${rec.address}</span>
            <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
              <button style="color:var(--muted);" class="btn" onclick="viewUnits('${escapeQuotes(rec.address)}','${escapeQuotes(rec.label)}')">View unit</button>
              <button style="color:var(--muted);" class="btn" onclick="scheduleTourFor('${escapeQuotes(rec.title)}')">Schedule tour</button>
              <a class="btn" href="${gmaps}" target="_blank" rel="noopener">Open in Google Maps</a>
            </div>
          `;
          const mr = L.marker([coord.lat, coord.lon], { title: rec.title });
          mr.bindPopup(popup);
          unitLayer.addLayer(mr);
        }
      }
      toggle?.addEventListener('change', async (e)=>{
        if(e.target.checked){
          if(!unitPinsBuilt){ await buildUnitPins(); unitPinsBuilt = true; }
          map.addLayer(unitLayer);
        }else{
          if(map.hasLayer(unitLayer)) map.removeLayer(unitLayer);
        }
      });
    }

// ========= Contact form =========
function validEmail(v){
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
}
function normalizePhone(v){
  const digits = (v || "").replace(/\D/g, "");
  if(digits.length === 11 && digits.startsWith("1")) return digits.slice(1);
  return digits;
}
function formatPhoneUS(v){
  const d = normalizePhone(v);
  if(d.length !== 10) return v;
  return `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`;
}

async function submitContactForm(e){
  e.preventDefault();
  const form = e.target;
  const statusEl = document.getElementById("contactStatus");
  const btn = document.getElementById("contactSubmitBtn");

  const honeypot = document.getElementById("companyWebsite")?.value?.trim();
  if(honeypot){ return; } // silent drop

  const name = document.getElementById("leadName")?.value?.trim() || "";
  const email = document.getElementById("leadEmail")?.value?.trim() || "";
  const phoneRaw = document.getElementById("leadPhone")?.value?.trim() || "";
  const phoneDigits = normalizePhone(phoneRaw);
  const interested = document.getElementById("leadInterested")?.value?.trim() || "";
  const budget = document.getElementById("leadBudget")?.value?.trim() || "";
  const moveIn = document.getElementById("leadMoveIn")?.value?.trim() || "";
  const msg = document.getElementById("leadMsg")?.value?.trim() || "";

  // Client-side validation (gentle)
  const errors = [];
  if(!name) errors.push("Name is required.");
  if(!validEmail(email)) errors.push("Please enter a valid email.");
  if(phoneDigits.length !== 10) errors.push("Please enter a 10-digit phone number.");

  if(errors.length){
    if(statusEl) statusEl.textContent = errors.join(" ");
    return;
  }

  // Pretty phone formatting back into input
  const phoneInput = document.getElementById("leadPhone");
  if(phoneInput) phoneInput.value = formatPhoneUS(phoneRaw);

  const detailLines = [
    interested ? `Interested: ${interested}` : null,
    budget ? `Budget: ${budget}` : null,
    moveIn ? `Preferred Move-in: ${moveIn}` : null,
    msg ? `Notes: ${msg}` : null
  ].filter(Boolean);

  if(!detailLines.length){
    detailLines.push("Contact request from website (no additional details provided).");
  }

  const details = detailLines.join("\n");

  try{
    if(btn){ btn.disabled = true; btn.textContent = "Sending..."; }
    if(statusEl) statusEl.textContent = "Sending…";

    const resp = await fetch(CONTACT_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ name, email, phone: phoneInput?.value || phoneRaw, details })
    });

    const data = await resp.json().catch(()=>({ success:false }));

    if(!resp.ok || !data.success){
      // Graceful fallback: mailto draft
      const mailto = new URL("mailto:bluerainrealestate@gmail.com");
      mailto.searchParams.set("subject", "Tour request / rental inquiry");
      mailto.searchParams.set("body", `Name: ${name}\nEmail: ${email}\nPhone: ${phoneInput?.value || phoneRaw}\n\n${details}`);
      if(statusEl){
        statusEl.innerHTML = `We couldn’t send the form right now. You can email us instead: <a class="btn" style="margin-left:8px" href="${mailto.toString()}">Email draft</a>`;
      }
      return;
    }

    if(statusEl) statusEl.textContent = alert("Request sent! We’ll follow up shortly.");
    form.reset();
  }catch(err){
    console.error(err);
    if(statusEl) statusEl.textContent = "Failed to send. Please verify your info and try again.";
  }finally{
    if(btn){ btn.disabled = false; btn.textContent = "Send request"; }
  }
}

// ========= Event wiring =========
function wireUI(){
  // Hero buttons
  document.getElementById("btnExploreMulti")?.addEventListener("click", ()=>document.getElementById("multifamily")?.scrollIntoView({behavior:"smooth"}));
  document.getElementById("btnExploreSFH")?.addEventListener("click", ()=>document.getElementById("singlefamily")?.scrollIntoView({behavior:"smooth"}));
  document.getElementById("btnScrollAvailability")?.addEventListener("click", ()=>document.getElementById("availability")?.scrollIntoView({behavior:"smooth"}));
  document.getElementById("btnScrollContact")?.addEventListener("click", ()=>document.getElementById("contact")?.scrollIntoView({behavior:"smooth"}));
  document.getElementById("btnClearFilters")?.addEventListener("click", clearFilters);

  // Filters (debounced input)
  const debounced = debounce(applyFilters, 150);
  ["q","type","beds","status","maxPrice"].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener("input", debounced);
    el.addEventListener("change", applyFilters);
  });

  // Availability: event delegation (prevents re-binding on re-render)
  const avail = document.getElementById("availability");
  avail?.addEventListener("click", (e)=>{
    const btn = e.target.closest("[data-open]");
    if(btn){
      const key = btn.getAttribute("data-open");
      if(key) openUnitModal(key);
    }
  });

  // Modal: available-units actions (View / Schedule)
  const modalAvail = document.getElementById("mAvailList");
  modalAvail?.addEventListener("click", (e)=>{
    const viewBtn = e.target.closest("[data-open]");
    if(viewBtn){
      const key = viewBtn.getAttribute("data-open");
      if(key){
        e.preventDefault();
        openUnitModal(key);
      }
      return;
    }

    const schedBtn = e.target.closest("[data-sch]");
    if(schedBtn){
      const label = schedBtn.getAttribute("data-sch") || "";
      const interested = document.getElementById("leadInterested");
      const msg = document.getElementById("leadMsg");
      if(interested && !interested.value) interested.value = label;
      if(msg && !msg.value) msg.value = `I'd like to schedule a tour for ${label}.`;

      closeModal();
      document.getElementById("contact")?.scrollIntoView({ behavior:"smooth" });
    }
  });

  // Modal: Apply hint behaves like Apply button
  const applyHint = document.getElementById("mApplyHint");
  applyHint?.addEventListener("click", ()=>{
    if(!modalState.applyAddress) return;
    const text = (applyHint.textContent || "").toLowerCase();
    if(text.includes("not accepting")) return;
    const url = buildApplyUrl(modalState.applyAddress, modalState.applyUnitLabel || "");
    window.open(url, "_blank");
  });

  // Modal close
  document.getElementById("mClose")?.addEventListener("click", closeModal);
  modalEl?.addEventListener("click", (e)=>{ if(e.target === modalEl) closeModal(); });
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && modalEl?.classList.contains("open")) closeModal();
    if(modalEl?.classList.contains("open")){
      if(e.key === "ArrowRight") nextPhoto();
      if(e.key === "ArrowLeft") prevPhoto();
    }
  });
  document.getElementById("mNext")?.addEventListener("click", (e)=>{ e.stopPropagation(); nextPhoto(); });
  document.getElementById("mPrev")?.addEventListener("click", (e)=>{ e.stopPropagation(); prevPhoto(); });

  // Mobile menu (focus trap)
  const menu = document.getElementById("mobileMenu");
  const menuTrap = menu ? createFocusTrap(menu) : null;
  const openBtn = document.getElementById("mobileMenuBtn");
  const closeBtn = document.getElementById("mobileMenuClose");

  openBtn?.addEventListener("click", ()=>{
    lastFocusEl = document.activeElement;
    menu?.classList.add("open");
    menuTrap?.activate();
    closeBtn?.focus();
  });
  closeBtn?.addEventListener("click", ()=>{
    menu?.classList.remove("open");
    menuTrap?.deactivate();
    if(lastFocusEl && typeof lastFocusEl.focus === "function") lastFocusEl.focus();
  });
  menu?.addEventListener("click", (e)=>{
    if(e.target === menu){
      menu.classList.remove("open");
      menuTrap?.deactivate();
      if(lastFocusEl && typeof lastFocusEl.focus === "function") lastFocusEl.focus();
    }
  });
  ["mLinkMulti","mLinkSFH","mLinkAvail","mLinkContact"].forEach(id=>{
    document.getElementById(id)?.addEventListener("click", ()=>{
      menu?.classList.remove("open");
      menuTrap?.deactivate();
    });
  });

  // Contact form
  document.getElementById("contactForm")?.addEventListener("submit", submitContactForm);

  // Nice-to-have: normalize phone formatting on blur
  document.getElementById("leadPhone")?.addEventListener("blur", (e)=>{
    const v = e.target.value.trim();
    if(v) e.target.value = formatPhoneUS(v);
  });
}

// ========= Boot =========
function boot(){
  // Apply URL params to filter inputs (shareable links)
  const urlFilters = getFiltersFromUrl();
  // If URL has no status param, keep your original default: Available
  if(!urlFilters.status) urlFilters.status = "Available";
  writeFiltersToUI(urlFilters);

  wireUI();
  initMap();
  renderMF();
  renderSFH();
  updateStats();
  applyFilters();
}

if(document.readyState === "loading"){
  document.addEventListener("DOMContentLoaded", boot);
}else{
  boot();
}

  </script>
</body>
</html>
