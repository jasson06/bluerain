<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project View</title>
    
<style>
        /* General Styling */
/* General Styling */
body {
    font-family: 'Poppins', sans-serif;
    background-color: #f4f4f9;
    margin: 0;
    padding: 20px;
    display: flex;
    justify-content: center;
}

/* Container Styling */
.container {
    width: 100%;
    max-width: 1200px;
    background: #ffffff;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
    border-radius: 10px;
    font-family: 'Poppins', sans-serif;
    margin: auto;
}

 /* Header */
 .project-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #007BFF;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }
    
    .project-header h2 {
        margin: 0;
        font-size: 24px;
        color: #007BFF;
    }

    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        background-color: orange;
        color: white;
        font-weight: bold;
        text-transform: uppercase;
        font-size: 14px;
    }

/* Project Info Grid */
.project-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        padding: 15px 0;
    }

    .project-info-item {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
        font-size: 14px;
    }

    h6{
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        border: 1px solid #ccc;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
        font-size: 14px;
        padding: 25px;
        
        
        
    }

    /* Color Box */
    .color-box {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 1px solid #ccc;
    }

    /* Description */
    .project-description {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-top: 10px;
    }
    
    .project-description h3 {
        margin-top: 0;
        font-size: 18px;
    }

/* Table Styling */

.line-items-container {
        background: rgb(255, 255, 255);
        padding: 10px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
        width: auto;
       
    } 


    
    .table {
        width: 380px;
        border-collapse: collapse;
        border-radius: 8px;
        overflow: hidden;
        background: white
        
    }

th, td {
    justify-content:space-between;
    display: flex;
    padding: 20px;
    text-align: left;
    border-bottom: 1px solid #ddd;
    border-radius: 4px;
    width: 1100px;
    
}



th {
    background-color: #007BFF;
    color: white;
    text-transform: uppercase;
}

tr:hover {
    background-color: #f1f1f1;
}

td {
    color: #333;
}
 
tr{
   width: 100%; 
  margin-top: 60px;
  
}


/* Status Labels */
.status-label {
    padding: 6px 14px;
    border-radius: 20px;
    font-weight: bold;
    display: inline-block;
    text-align: center;
}

.new {
    background-color: red;
    color: white;
}

.in-progress {
    background-color: orange;
    color: white;
}

.completed {
    background-color: green;
    color: white;
}


.approved {
    background-color: #007BFF;
    color: white;
}

/* Total Amount Styling */
.total-amount-box {
        text-align: right;
        font-size: 18px;
        font-weight: bold;
        margin-top: 10px;
        padding: 10px;
        background: #007BFF;
        color: white;
        border-radius: 5px;
    }



/* photo css  */
.photo-container {
    position: relative;
    width: 90%;
    overflow: hidden;
    max-width: 180px; /* Ensures proper width */
    border-radius: 8px;
}

.photo-preview {
  display: flex;
  flex-direction: row;
  gap: 100px;
  align-items: flex-start;
  justify-content: flex-start;
}

.photo-container img {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        object-fit: cover;
        transition: transform 0.3s ease-in-out;
    }
    
    .photo-container img:hover {
        transform: scale(1.1);
    }

    

.photo-wrapper {
    display: flex;
    transition: transform 0.5s ease-in-out;
    width: 100%;
}

.photo-slide {
    min-width: 100%;
    text-align: center;
    position: relative;
}

.photo-slide img {
    width: 100%;
    height: auto;
    object-fit: contain;
    display: block;
    margin: 0 auto;
}

/* ✅ Dots Indicator */
.photo-dots {
    display: flex;
    justify-content: center;
    margin-top: 5px;
}

.photo-dots span {
    width: 6px;
    height: 6px;
    margin: 0 3px;
    background-color: #bbb;
    border-radius: 50%;
    display: inline-block;
    transition: background-color 0.3s ease;
}

.photo-dots .active {
    background-color: #007bff;
}


/* ✅ Upload Button */
.upload-btn {
    display: block;
    margin-top: 5px;
    background: #007bff;
    color: white;
    border-radius: 50%;
    width: 10px;
    height: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 18px;
    cursor: pointer;
}

.upload-btn input {
    display: none;
}

button, .upload-btn {
        font-size: 14px;
        padding: 8px 12px;
        border-radius: 6px;
    }


/* ✅ Delete Button */
.delete-photo {
    position: absolute;
    top: 0px;
    right: 7px;
    background: none;
    color: rgb(255, 0, 0);
    border: none;
    border-radius: 50%;
    font-size: 18px;
    cursor: pointer;
    width: 20px;
    height: 20px;
    text-align: center;
    line-height: 20px;
}

.delete-photo:hover {
    background: none;
}


/* ✅ Fullscreen Photo Viewer */
.photo-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.85);
  justify-content: center;
  align-items: center;
  z-index: 9999;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  transition: opacity 0.3s ease;
  overflow: hidden;
}

/* Image Styling */
.photo-modal img {
  max-width: 92vw;
  max-height: 85vh;
  object-fit: contain;
  border-radius: 12px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
  transition: transform 0.3s ease;
}

/* Close Button */
.close-photo {
  position: absolute;
  top: 20px;
  right: 24px;
  color: #fff;
  font-size: 26px;
  background: rgba(0, 0, 0, 0.5);
  border-radius: 50%;
  padding: 10px 14px;
  cursor: pointer;
  transition: background 0.2s ease, transform 0.2s ease;
  z-index: 10000;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
  touch-action: manipulation;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
}

.close-photo:hover,
.close-photo:active {
  background: rgba(0, 0, 0, 0.8);
  transform: scale(1.1);
}

/* Nav Arrows */
#prev-photo,
#next-photo {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(255, 255, 255, 0.85);
  border: none;
  padding: 12px 18px;
  font-size: 26px;
  font-weight: bold;
  color: #333;
  border-radius: 8px;
  cursor: pointer;
  z-index: 10000;
  transition: background 0.2s ease;
}

#prev-photo:hover,
#next-photo:hover {
  background: #fff;
}

#prev-photo {
  left: 20px;
}
#next-photo {
  right: 20px;
}

/* Optional: Add swipe gesture hint for mobile */
@media (hover: none) and (pointer: coarse) {
  .photo-modal::after {
    content: "Swipe left/right to navigate";
    position: absolute;
    bottom: 24px;
    color: rgba(255, 255, 255, 0.7);
    font-size: 14px;
    text-align: center;
    width: 100%;
  }
}




/* ✅ General Mobile & Tablet Styles */
@media (max-width: 1024px) {
    /* Container Adjustments */
    .container {
        width: 100%;
        padding: 15px;
    }

    /* ✅ Adjust Table for Smaller Screens */
    table {
        width: 100%;
        display: block;
        overflow-x: auto;
        
    }

    th, td {
        padding: 8px;
        font-size: 14px;
    }
    tr{
        width: auto;
    }

    td {
        display:flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        font-weight:normal;
        width: 900px;
    }



    /* ✅ Make Buttons More Tap-Friendly */
    button, .upload-btn {
        font-size: 14px;
        padding: 8px 12px;
        border-radius: 6px;
    }

    /* ✅ Adjust Photo Upload Section */
    .photo-preview {
        display: flex;
        
        align-items: center;
    }

    .photo-section {
        width: 100%;
        text-align: center;
        margin-bottom: 10px;
    }

    .upload-btn {
        width: 10px;
        height: 10px;
        font-size: 18px;
    }

    /* ✅ Fix Image Size in Photo Slider */
    .photo-container {
        max-width: 100px;
        overflow: hidden;
        border-radius: 8px;
       
    }

    .photo-wrapper {
        display: flex;
        width: 100%;
        transition: transform 0.5s ease-in-out;
    }

    .photo-wrapper img {
        width: 100%;
        height: auto;
        object-fit: cover;
    }

    /* ✅ Dots Indicator Styling for Mobile */
    .photo-dots {
        margin-top: 5px;
    }

    .photo-dots span {
        width: 8px;
        height: 8px;
    }

    /* ✅ Total Amount Box */
    .total-amount-box {
        font-size: 16px;
        padding: 8px;
        text-align: center;
    }

    .delete-photo {
    position: absolute;
    top: -10px;
    right: 0px;
    background: none;
    color: rgb(253, 2, 2);
    border: none;
    border-radius: 50%;
    font-size: 14px;
    cursor: pointer;
    width: 20px;
    height: 20px;
    text-align: center;
    line-height: 20px;
}
}

/* ✅ Mobile-Specific Adjustments (Phones < 768px) */
.toggle-status-btn {
  background: linear-gradient(90deg, #007bff 60%, #0ea5e9 100%);
  color: #fff;
  border: none;
  border-radius: 7px;
  padding: 10px 22px;
  font-size: 16px;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(0,123,255,0.10);
  cursor: pointer;
  transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
  outline: none;
  margin-top: 8px;
  margin-bottom: 8px;
  letter-spacing: 0.5px;
  display: inline-block;
}
.toggle-status-btn:hover, .toggle-status-btn:focus {
  background: linear-gradient(90deg, #0056b3 60%, #0ea5e9 100%);
  box-shadow: 0 4px 16px rgba(0,123,255,0.18);
  transform: translateY(-2px) scale(1.04);
}
.toggle-status-btn:active {
  background: linear-gradient(90deg, #0056b3 60%, #0ea5e9 100%);
  box-shadow: 0 1px 4px rgba(0,123,255,0.10);
  transform: scale(0.98);
}
    
/* ✅ Mobile-Specific Adjustments (Phones < 768px) */
@media (max-width: 768px) {
    /* ✅ Stack Table Rows for Better Mobile View */
    table {
        display: block;
        width: auto;
        
    }

    
h2{
    font-size: 25px;
}

    tr {
        display: block;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 13px;
        
    

    }


    td {
        display:flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        font-weight:normal;
        width: 610px;
    }


    

    /* ✅ Photo Preview for Smaller Screens */
    .photo-preview {
        flex-direction: inline;
    }

    .photo-container {
        max-width: 90px;
display: inline-block;
    }

    /* ✅ Adjust Buttons for Mobile */
    button {
        font-size: 12px;
        padding: 6px 10px;
    }

    .upload-btn {
        width: 12px;
        height: 12px;
        font-size: 25px;
    }

    /* ✅ Adjust Photo Slider Size */
    .photo-wrapper img {
        max-width: 100%;
        height: auto;
    }

    /* ✅ Center Align Elements */
    .photo-section, .status-label, .toggle-status-btn {
        text-align: center;
    }

    .delete-photo {
        display: none;
    position: absolute;
    top: 0px;
    right: 10px;
    background: none;
    color: rgb(253, 2, 2);
    border: none;
    border-radius: 50%;
    font-size: 18px;
    cursor: pointer;
    width: 20px;
    height: 20px;
    text-align: center;
    line-height: 20px;
}

    
}

/* ✅ Mobile-Specific Adjustments (Phones < 768px) */
@media (max-width: 610px) {
    /* ✅ Stack Table Rows for Better Mobile View */
    table {
        display: inline;
        width: auto;
    }



    .line-items-container{
    background: white;
    padding: 0px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    margin-top: 20px;
    width:auto ;
    
}

.line-items-container {
  display: none; /* 🔒 Hidden until an invoice is selected */
}


td {
        display:flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        font-weight:normal;
        width: 485px;
        padding: 0px;
        margin: 0px;
    }

}


/* ✅ Mobile-Specific Adjustments (Phones < 768px) */
@media (max-width: 480px) {
    /* ✅ Stack Table Rows for Better Mobile View */
    table {
        display: inline;
        width: auto;
    }



    .line-items-container{
    background: white;
    padding: 0px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    margin-top: 20px;
    width:auto ;
    
}

td {
        display:flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
        font-weight:normal;
        width: 335px;
        padding: 0px;
        margin: 0px;
    }

}

.estimate-selector {
  margin-top: 30px;
  margin-bottom: 20px;
  text-align: left;
  padding: 20px;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0, 123, 255, 0.1);
  max-width: 400px;
}

.estimate-selector label {
  font-weight: 600;
  font-size: 16px;
  color: #333;
  display: block;
  margin-bottom: 10px;
}

.estimate-selector select {
  width: 100%;
  padding: 10px 14px;
  font-size: 15px;
  border: 1px solid #ccc;
  border-radius: 6px;
  background-color: #fff;
  transition: border-color 0.3s ease;
}

.estimate-selector select:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
}


#no-estimate-message {
  margin-top: 15px;
  font-style: italic;
  color: #6c757d;
  font-size: 14px;
}

.item-description {
  word-wrap: break-word;
  white-space: normal;
  font-size: 14px;
  font-weight: normal;
  padding: 10px;
  background-color: #f8f9fa;
  border-radius: 8px;
  margin: 10px 0;
}
.item-description ul {
  padding-left: 20px;
  margin: 0;
}
.item-description li {
  margin-bottom: 8px;
  line-height: 1.4;
}

.estimate-tabs-wrapper {
  margin: 20px 0;
}

.estimate-tabs {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}

.estimate-tab {
  padding: 10px 16px;
  background-color: #f1f5f9;
  border: 1px solid #ccc;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: background-color 0.3s ease, border-color 0.3s ease;
  position: relative;
}

.estimate-tab:hover {
  background-color: #e2e8f0;
  border-color: #007bff;
}

.estimate-tab.active {
  background-color: #007bff;
  color: white;
  font-weight: bold;
}

.tab-wrapper {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
}

.estimate-tab .new-badge {
  position: absolute;
  top: -6px;
  right: -6px;
  background-color: #e11d48;
  color: white;
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 999px;
  font-weight: bold;
}


.return-dashboard-btn {
    background-color: #0f4c75;
    color: white;
    padding: 10px 18px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s ease;
}

.return-dashboard-btn:hover {
    background-color: #0c3b5e;
}

.rework-notes {
    background-color: #ffebee;
    padding: 10px;
    border-left: 4px solid #f44336;
    border-radius: 8px;
    margin-top: 10px;
    font-weight: 500;
    color: #b71c1c;
}


.toggle-btn {
  background: #f1f5f9;
  color: #007bff;
  border: 1px solid #007bff;
  border-radius: 6px;
  padding: 8px 18px;
  margin-left: 8px;
  font-size: 15px;
  cursor: pointer;
  font-weight: 500;
  transition: background 0.2s, color 0.2s;
}
.toggle-btn.active {
  background: #007bff;
  color: #fff;
}

    .rework-badge-estimate {
    background-color: #dc2626;
    color: white;
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 0.9rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin-left: 8px;
    box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3);
    animation: pulse 2s infinite;
}
 </style>
</head>
<body>
    
    <div class="container">
        <header>
            
            <h1 id="project-name">Loading Project...</h1>
        </header>
       
    </a>
<!-- Project Information -->
<section id="project-details" class="project-details-container">
    <div class="project-header">
        <h2 id="project-name">Project Name</h2>
        <button class="return-dashboard-btn" onclick="window.location.href='/Subcontractor%20Page.html'">
            ⬅️ Return to Dashboard
          </button>
          
    </div>

    <div class="project-info-grid">
        <div class="project-info-item">
            <strong>Lockbox Code:</strong> <span id="project-code">####</span>
        </div>
        <div class="project-info-item">
            <strong>Type:</strong> <span id="project-type">Type</span>
        </div>
        <div class="project-info-item">
            <strong>Address:</strong> 
            <p><a href="#" id="project-address" target="_blank" style="color: #007BFF; text-decoration: underline;">Address will be here</a></p>
        </div>
        



</section>

<div class="estimate-tabs-wrapper">
    <label><strong>Select Work Order:</strong></label>
    <div class="estimate-tabs" id="estimateTabsContainer"></div>
  </div>
  
  

  <div id="no-estimate-message" style="padding: 20px; text-align: center; color: #777;">
  </div>  




  
  <div id="item-status-toggle" style="margin-bottom: 18px; text-align: right;">
  <button id="show-active-btn" class="toggle-btn active">Active Items</button>
  <button id="show-completed-btn" class="toggle-btn">Completed Items</button>
</div>
  
       <!-- Line Items Section -->
<!-- Line Items Section -->
<div class="line-items-container">
    <h2>Line Items</h2>
    <div class="table-wrapper">
        <table>
 
            <tbody id="line-items-list">
                <!-- Items will be inserted dynamically here -->
            </tbody>
        </table>
    </div>
    
    <!-- Grand Total Display -->
    <div id="total-amount" class="total-amount-box"></div>
</div>


</div>

     <!-- ✅ Fullscreen Photo Viewer Modal -->
     <div id="photo-viewer" class="photo-modal">
        <span class="close-photo" onclick="closePhotoViewer()">✖</span>
        <button id="prev-photo" onclick="changePhotoViewer(-1)">❮</button>
        <img id="viewer-image" src="" alt="Expanded Photo">
        <button id="next-photo" onclick="changePhotoViewer(1)">❯</button>
    </div>
    


    <!-- Toast Notification -->
<div id="toast" style="
position: fixed;
top: 30px;
left: 50%;
transform: translateX(-50%);
background: linear-gradient(to right, #0ea5e9, #3b82f6);
color: white;
padding: 14px 24px;
border-radius: 8px;
display: none;
z-index: 9999;
font-weight: 500;
font-size: 15px;
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
transition: opacity 0.3s ease, transform 0.3s ease;
pointer-events: none;
"></div>

<!-- Loader Spinner -->
<div id="loader" style="
position: fixed;
top: 0; left: 0;
width: 100%; height: 100%;
background: rgba(255, 255, 255, 0.6);
backdrop-filter: blur(2px);
z-index: 9999;
display: none;
justify-content: center;
align-items: center;
">
<div style="
  border: 5px solid #e5e7eb;
  border-top: 5px solid #3b82f6;
  border-radius: 50%;
  width: 45px;
  height: 45px;
  animation: spin 0.8s linear infinite;
"></div>
</div>

<!-- Add this to your <style> block or <head> -->
<style>
@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}
</style>

</body>
</html>

 <script> 

document.addEventListener("DOMContentLoaded", async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const projectId = urlParams.get("projectId");
    const vendorId = localStorage.getItem("vendorId");

    if (!vendorId || !projectId) {
        alert("Invalid project or vendor data.");
        window.location.href = "/sign-inpage.html";
        return;
    }

    console.log("📌 Fetching Project & Items for Project ID:", projectId);
    
    await fetchProjectDetails(projectId);
    


    // ✅ Fix: Initialize swipe using event delegation
    enableGlobalSwipeEvents();
});

// ✅ Enable Swipe Gesture (Supports Touch & Mouse Drag)
function enableGlobalSwipeEvents() {
    let startX = 0;
    let currentIndex = 0;
    let wrapper = null;
    let photos = [];
    let isMouseDown = false;

    document.body.addEventListener("touchstart", startSwipe);
    document.body.addEventListener("touchmove", moveSwipe);
    document.body.addEventListener("touchend", endSwipe);

    document.body.addEventListener("mousedown", (e) => {
        isMouseDown = true;
        startSwipe(e);
    });

    document.body.addEventListener("mousemove", (e) => {
        if (isMouseDown) moveSwipe(e);
    });

    document.body.addEventListener("mouseup", (e) => {
        if (isMouseDown) {
            endSwipe(e);
            isMouseDown = false;
        }
    });

    function startSwipe(e) {
        const event = e.touches ? e.touches[0] : e;
        const target = event.target.closest(".photo-wrapper");
        if (!target) return;

        wrapper = target;
        photos = JSON.parse(wrapper.getAttribute("data-photos"));
        currentIndex = parseInt(wrapper.getAttribute("data-index"), 10) || 0;

        startX = event.clientX;
        wrapper.style.transition = "none";
    }

    function moveSwipe(e) {
        if (!wrapper) return;
        const event = e.touches ? e.touches[0] : e;
        let moveX = event.clientX - startX;
        wrapper.style.transform = `translateX(calc(${-currentIndex * 100}% + ${moveX}px))`;
    }

    function endSwipe(e) {
        if (!wrapper) return;
        const event = e.changedTouches ? e.changedTouches[0] : e;
        let endX = event.clientX;
        let distance = startX - endX;

        wrapper.style.transition = "transform 0.4s ease";
        if (Math.abs(distance) > 50) {
            currentIndex = (distance > 0) 
                ? (currentIndex + 1) % photos.length 
                : (currentIndex - 1 + photos.length) % photos.length;
        }

        wrapper.style.transform = `translateX(-${currentIndex * 100}%)`;
        wrapper.setAttribute("data-index", currentIndex);

        updateDots(wrapper.id, currentIndex);
        wrapper = null;
    }
}

function showToast(message, type) {
  const toast = document.getElementById('toast');
  toast.textContent = ""; // Clear previous content

  // Default style
  toast.style.background = "linear-gradient(to right, #0ea5e9, #3b82f6)";
  toast.style.color = "white";
  toast.style.border = "none";
  toast.style.boxShadow = "0 4px 12px rgba(0,0,0,0.15)";
  toast.style.pointerEvents = "none";

  if (type === "warning") {
    toast.style.background = "linear-gradient(to right, #fbbf24, #f59e42)";
    toast.style.color = "white";
    toast.style.border = "1.5px solid #f59e42";
    toast.style.boxShadow = "0 4px 16px rgba(251,191,36,0.18)";
    toast.innerHTML = `<span style="font-size:18px;vertical-align:middle;margin-right:8px;">&#9888;</span> ${message}`;
  } else {
    toast.textContent = message;
  }

  toast.style.display = 'block';
  setTimeout(() => { toast.style.display = 'none'; }, 3000);
}

function showLoader() {
  document.getElementById('loader').style.display = 'flex';
}

function hideLoader() {
  document.getElementById('loader').style.display = 'none';
}


// ✅ Fix Dot Indicators (Now Correctly Updates)
function updateDots(wrapperId, activeIndex) {
    const parts = wrapperId.split("-");
    if (parts.length < 3) return;

    const type = parts[1];
    const itemId = parts[2];
    const dotsContainer = document.getElementById(`dots-${type}-${itemId}`);

    if (!dotsContainer) return;

    dotsContainer.querySelectorAll("span").forEach((dot, index) => {
        dot.classList.toggle("active", index === activeIndex);
    });
}

// ✅ Fetch Project Details
async function fetchProjectDetails(projectId) {
    showLoader(); // 👈 START
    try {
        const response = await fetch(`/api/details/projects/${projectId}?t=${Date.now()}`);
                         await fetchProjectEstimates(projectId);

        if (!response.ok) throw new Error("Failed to fetch project details.");

        const data = await response.json();
        console.log("📌 Project Details Response:", data);

        if (!data || !data.project) {
            throw new Error("Project data is missing.");
        }

        displayProjectDetails(data.project);
    } catch (error) {
        console.error("❌ Error fetching project details:", error);
        document.getElementById("project-name").innerText = "Failed to load project details.";
    } finally {
        hideLoader(); // 👈 END
    }
}


// Update the fetchProjectEstimates function
async function fetchProjectEstimates(projectId) {
  const vendorId = localStorage.getItem("vendorId");
  const tabsContainer = document.getElementById("estimateTabsContainer");
  showLoader();
  
  try {
    const res = await fetch(`/api/vendors/${vendorId}/assigned-items/${projectId}`);
    
    if (res.status === 404) {
      tabsContainer.innerHTML = `<p style="padding: 12px; color: gray;">No work order have been assigned to you yet.</p>`;
      return;
    }

    if (!res.ok) throw new Error("Failed to fetch assigned items.");
    const { items } = await res.json();

    const assignedMap = new Map();
    items.forEach(item => {
      if (item.estimateId) {
        if (!assignedMap.has(item.estimateId)) assignedMap.set(item.estimateId, []);
        assignedMap.get(item.estimateId).push(item);
      }
    });

    const estimateRes = await fetch(`/api/estimates?projectId=${projectId}`);
    if (!estimateRes.ok) throw new Error("Failed to fetch estimates.");
    const { estimates } = await estimateRes.json();

    tabsContainer.innerHTML = "";
    let firstTabSelected = false;
    let validEstimateFound = false;

    estimates.forEach(est => {
      const assignedItems = assignedMap.get(est._id);
      if (!assignedItems) return;

      validEstimateFound = true;

      const hasNewItem = assignedItems.some(item =>
        item.status === 'new' || (item.status === '' && !item.viewed)
      );

      const hasReworkItem = assignedItems.some(item => 
        item.status === 'rework' || item.qualityControl?.status === 'rework'
      );

      const label = est.title ? `${est.title} ` : est.invoiceNumber;

      const tab = document.createElement("button");
      tab.className = "estimate-tab";
      tab.dataset.estimateId = est._id;
      
      // Add appropriate badge based on status
      let badgeHtml = '';
      if (hasReworkItem) {
        badgeHtml = `
          <span class="rework-badge-estimate">
            <i class="fas fa-exclamation-circle"></i>
            <span class="message">Rework</span>
          </span>
        `;
      } else if (hasNewItem) {
        badgeHtml = '<span class="new-badge">NEW</span>';
      }

      tab.innerHTML = `
        <span>${label}</span>
        ${badgeHtml}
      `;

      tab.onclick = () => {
        document.querySelectorAll(".estimate-tab").forEach(btn => btn.classList.remove("active"));
        tab.classList.add("active");
        handleEstimateSelection(est._id);
      };

      tabsContainer.appendChild(tab);

      if (!firstTabSelected) {
        firstTabSelected = true;
        tab.click();
      }
    });

    if (!validEstimateFound) {
      tabsContainer.innerHTML = `<p style="padding: 12px; color: gray;">No assigned estimates found for this project.</p>`;
    }

  } catch (error) {
    console.error("❌ Error fetching project estimates:", error);
    tabsContainer.innerHTML = `<p style="color: red; padding: 10px;">Failed to load work orders.</p>`;
  } finally {
    hideLoader();
  }
}








async function handleEstimateSelection(estimateId) {
  const message = document.getElementById("no-estimate-message");
  const container = document.getElementById("line-items-list");
  const totalBox = document.getElementById("total-amount");
  const lineItemsSection = document.querySelector(".line-items-container");

  // Highlight selected tab
  document.querySelectorAll(".estimate-tab").forEach(tab => {
    tab.classList.remove("active");
    if (tab.dataset.estimateId === estimateId) {
      tab.classList.add("active");
    }
  });

  if (!estimateId) {
    message.style.display = "block";
    message.innerText = "Please select a Work Order to display line items.";
    container.innerHTML = "";
    totalBox.innerHTML = "";
    lineItemsSection.style.display = "none";
    return;
  }

  const vendorId = localStorage.getItem("vendorId");
  const projectId = new URLSearchParams(window.location.search).get("projectId");

  try {
    const res = await fetch(`/api/vendors/${vendorId}/assigned-items/${projectId}`);
    const data = await res.json();
    const allItems = data.items || [];

    const assignedItems = allItems.filter(
      item => item.estimateId?.toString() === estimateId
    );

    if (assignedItems.length === 0) {
      message.style.display = "block";
      message.innerText = "You have no assigned items in this estimate.";
      container.innerHTML = "";
      totalBox.innerHTML = "";
      lineItemsSection.style.display = "none";
    } else {
      message.style.display = "none";
      lineItemsSection.style.display = "block";
      displayAssignedItems(assignedItems);
    }
  } catch (err) {
    console.error("❌ Error loading assigned items:", err);
    showToast("Failed to load your assigned items.");
  }
}





// ✅ Fetch Assigned Items (Ensures Swipe Works After Refresh)
async function fetchAssignedItems(vendorId, projectId) {
    try {
        const response = await fetch(`/api/vendors/${vendorId}/assigned-items/${projectId}`);
        if (!response.ok) throw new Error("Failed to fetch assigned items.");

        const data = await response.json();
        console.log("📌 Assigned Items Response:", data.items);

        if (!data.items || data.items.length === 0) {
            document.getElementById("line-items-container").innerHTML = "<p>No line items assigned.</p>";
            return;
        }

        data.items.forEach(item => {
            if (!item.photos) {
                item.photos = { before: [], after: [] };
            }
        });

        displayAssignedItems(data.items);


    } catch (error) {
        console.error("❌ Error fetching assigned items:", error);
        document.getElementById("line-items-container").innerHTML = `<p style="color:red;">Failed to load line items.</p>`;
    }
}




// ✅ Render Project Details
function displayProjectDetails(project) {
    document.getElementById("project-name").innerText = project.name || "Unnamed Project";
    
    
    document.getElementById("project-type").innerText = project.type || "N/A";
    document.getElementById("project-code").innerText = project.code || "N/A";
    

    // Full Address
    const fullAddress = `${project.address?.addressLine1 || ""}, ${project.address?.addressLine2 || ""}, ${project.address?.city || ""}, ${project.address?.state || ""}, ${project.address?.zip || ""}`
    .replace(/, ,/g, ',')
    .replace(/,+$/, '')
    .trim();

const encodedAddress = encodeURIComponent(fullAddress);

// ✅ Detect iOS for Apple Maps fallback
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const mapLink = isIOS
    ? `http://maps.apple.com/?q=${encodedAddress}`
    : `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;

const addressEl = document.getElementById("project-address");
addressEl.innerText = fullAddress || "N/A";
addressEl.href = mapLink;

}


// ✅ Function to Calculate Grand Total
function calculateTotal(items) {
    let totalAmount = items.reduce((sum, item) => sum + (item.total || 0), 0);
    return totalAmount.toFixed(2);
}


async function toggleItemStatus(vendorId, itemId, currentStatus) {
    try {
        // Determine the next status
        let newStatus;
        let nextLabel;

        if (currentStatus === "new") {
            newStatus = "in-progress";
            nextLabel = "Mark as Completed";
        } else if (currentStatus === "in-progress") {
            // --- ADD: Require at least one after photo to mark as completed ---
            const afterPhotosContainer = document.getElementById(`after-photos-${itemId}`);
            let hasAfterPhoto = false;
            if (afterPhotosContainer) {
                // Try to find at least one <img> inside the after photos container
                hasAfterPhoto = !!afterPhotosContainer.querySelector("img");
            }
            if (!hasAfterPhoto) {
                showToast("You need to upload at least one AFTER photo to mark this item as completed.", "warning");
                return;
            }
            // ---------------------------------------------------------------
            newStatus = "completed";
            nextLabel = "Mark as In Progress";
        } else if (currentStatus === "completed") {
            newStatus = "in-progress";
            nextLabel = "Mark as Completed";
        } else {
            newStatus = "in-progress";
            nextLabel = "Mark as Completed";
        }

        // Get the active estimate ID
        const activeTab = document.querySelector(".estimate-tab.active");
        const estimateId = activeTab ? activeTab.dataset.estimateId : null;

        // Update vendor item status (preserve existing functionality)
        const response = await fetch(`/api/vendors/${vendorId}/update-item-status`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                itemId, 
                status: newStatus,
                estimateId: estimateId // Include estimate ID
            })
        });

        if (!response.ok) {
            const errorMessage = await response.text();
            console.error(`❌ Failed to update item status: ${errorMessage}`);
            return;
        }

        // 🔹 NEW: Sync maintenance request status via PATCH
        // This will update the maintenance request status automatically
        try {
            await fetch(`/api/estimates/line-items/${itemId}/status`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: newStatus })
            });
        } catch (err) {
            console.warn("Maintenance request status sync failed:", err);
        }

        // Wait for a small delay to ensure server processing completes
        await new Promise(resolve => setTimeout(resolve, 500));

        // ✅ Update the status visually
        const statusElement = document.getElementById(`status-${itemId}`);
        const button = document.querySelector(`button[data-item-id="${itemId}"]`);

        if (statusElement) {
            // Update text
            statusElement.innerText = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);

            // Remove all status classes
            statusElement.classList.remove("new", "in-progress", "completed","approved");

            // Add the new class to reflect color
            statusElement.classList.add(newStatus);
        }

        if (button) {
            button.setAttribute("data-current-status", newStatus);
            button.innerText = nextLabel;
        }

        showToast(`✅ Status updated to: ${newStatus}`);
        
        // ✅ Re-fetch and re-render items for the current estimate
        if (activeTab) {
            await handleEstimateSelection(activeTab.dataset.estimateId);
        }
    } catch (error) {
        showToast("❌ Error updating item status");
        console.error("Error:", error);
    }
}




// ✅ Generate Photo Preview (Click to Open Fullscreen)
function generatePhotoPreview(photos, itemId, type) {
    if (!photos || photos.length === 0) {
        return `<p class="placeholder">No photos</p>`;
    }

    const dots = photos.map((_, index) => 
        `<span class="${index === 0 ? 'active' : ''}" data-index="${index}" onclick="jumpToPhoto('${itemId}', '${type}', ${index})"></span>`
    ).join("");

    return `
        <div class="photo-container">
            <div class="photo-wrapper" id="photo-wrapper-${type}-${itemId}" data-index="0" data-photos='${JSON.stringify(photos)}'>
                ${photos.map((photo, index) => `
                    <div class="photo-slide">
                        <img src="${photo}" draggable="false" onclick="openPhotoViewer('${itemId}', '${type}', ${index})">
                        <button class="delete-photo" onclick="deletePhoto('${itemId}', '${photo}', '${type}')">✖</button>
                    </div>
                `).join("")}
            </div>
        </div>
        <div class="photo-dots" id="dots-${type}-${itemId}">${dots}</div>
    `;
}


// ✅ Open Fullscreen Photo Viewer
function openPhotoViewer(itemId, type, index) {
    const wrapper = document.getElementById(`photo-wrapper-${type}-${itemId}`);
    if (!wrapper) return;

    const photos = JSON.parse(wrapper.getAttribute("data-photos"));
    if (!photos || photos.length === 0) return;

    // Set current photo index
    document.getElementById("photo-viewer").setAttribute("data-current-index", index);
    document.getElementById("photo-viewer").setAttribute("data-item-id", itemId);
    document.getElementById("photo-viewer").setAttribute("data-type", type);

    updatePhotoViewer(photos, index);
    document.getElementById("photo-viewer").style.display = "flex";
}

// ✅ Update the Photo Viewer with the Selected Image
function updatePhotoViewer(photos, index) {
    const viewerImage = document.getElementById("viewer-image");
    const prevButton = document.getElementById("prev-photo");
    const nextButton = document.getElementById("next-photo");

    viewerImage.src = photos[index];

    // Show/hide navigation buttons
    prevButton.style.display = index === 0 ? "none" : "block";
    nextButton.style.display = index === photos.length - 1 ? "none" : "block";
}

// ✅ Navigate Photos in Viewer
function changePhotoViewer(step) {
    const viewer = document.getElementById("photo-viewer");
    const itemId = viewer.getAttribute("data-item-id");
    const type = viewer.getAttribute("data-type");
    let currentIndex = parseInt(viewer.getAttribute("data-current-index"), 10);

    const wrapper = document.getElementById(`photo-wrapper-${type}-${itemId}`);
    if (!wrapper) return;

    const photos = JSON.parse(wrapper.getAttribute("data-photos"));
    if (!photos || photos.length === 0) return;

    let newIndex = currentIndex + step;
    if (newIndex < 0 || newIndex >= photos.length) return;

    viewer.setAttribute("data-current-index", newIndex);
    updatePhotoViewer(photos, newIndex);
}

// ✅ Close Photo Viewer
function closePhotoViewer() {
    document.getElementById("photo-viewer").style.display = "none";
}

// ✅ Close Modal on ESC Key
document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closePhotoViewer();
});


// ✅ Enable Swipe Gesture (Fixed)
function enableSwipe(itemId, type) {
    const wrapper = document.getElementById(`photo-wrapper-${type}-${itemId}`);
    if (!wrapper) return;

    let startX = 0;
    let currentIndex = parseInt(wrapper.getAttribute("data-index"), 10) || 0;
    const photos = JSON.parse(wrapper.getAttribute("data-photos"));

    function resetTransform() {
        wrapper.style.transition = "transform 0.4s ease";
        wrapper.style.transform = `translateX(-${currentIndex * 100}%)`;
    }

    
    wrapper.addEventListener("touchstart", (e) => {
        startX = e.touches[0].clientX;
        wrapper.style.transition = "none";
    });

    wrapper.addEventListener("touchmove", (e) => {
        let moveX = e.touches[0].clientX - startX;
        wrapper.style.transform = `translateX(calc(${-currentIndex * 100}% + ${moveX}px))`;
    });

    wrapper.addEventListener("touchend", (e) => {
        let endX = e.changedTouches[0].clientX;
        let distance = startX - endX;

        if (Math.abs(distance) > 50) {
            currentIndex = (distance > 0) 
                ? (currentIndex + 1) % photos.length 
                : (currentIndex - 1 + photos.length) % photos.length;
        }

        resetTransform();
        wrapper.setAttribute("data-index", currentIndex);
        updateDots(itemId, type, currentIndex);
    });

    resetTransform(); // Ensure it resets correctly on page refresh
}


// ✅ FIX: Auto-Slide Photos (Ensures Continuous Slideshow)
function autoSlidePhotos(itemId, type) {
    const wrapper = document.getElementById(`photo-wrapper-${type}-${itemId}`);
    if (!wrapper) return;

    const photos = JSON.parse(wrapper.getAttribute("data-photos"));
    let currentIndex = parseInt(wrapper.getAttribute("data-index"), 10);

    currentIndex = (currentIndex + 1) % photos.length;
    wrapper.style.transition = "transform 0.5s ease";
    wrapper.style.transform = `translateX(-${currentIndex * 100}%)`;
    wrapper.setAttribute("data-index", currentIndex);

    updateDots(wrapper.id, currentIndex);
}



// ✅ FIX: Jump to Specific Photo when Dot is Clicked
function jumpToPhoto(itemId, type, index) {
    const wrapper = document.getElementById(`photo-wrapper-${type}-${itemId}`);
    if (!wrapper) return;

    wrapper.style.transition = "transform 0.5s ease";
    wrapper.style.transform = `translateX(-${index * 100}%)`;
    wrapper.setAttribute("data-index", index);

    updateDots(wrapper.id, index);
}



// ✅ Upload Photos & Ensure Swiping Works
async function uploadPhoto(event, itemId, type) {
  const files = event.target.files;
  if (!files || files.length === 0) return;

  const vendorId = localStorage.getItem("vendorId");
  const projectId = new URLSearchParams(window.location.search).get("projectId");

  if (!vendorId || !projectId) {
    showToast("Missing project or vendor context.");
    return;
  }

  // Determine the selected estimateId
  let estimateId = null;
  const dropdown = document.getElementById("estimate-dropdown");
   const activeTab = document.querySelector(".estimate-tab.active");
    estimateId = activeTab?.dataset.estimateId;
  

  if (!estimateId) {
    showToast("Please select a Work Order before uploading.");
    return;
  }

  const formData = new FormData();
  for (let file of files) {
    formData.append("photos", file);
  }

  formData.append("itemId", itemId);
  formData.append("type", type);
  formData.append("estimateId", estimateId);
  formData.append("vendorId", vendorId);

    // ✅ Show inline loader in the photo section
    const containerId = `${type}-photos-${itemId}`;
    const photoContainer = document.getElementById(containerId);
    if (photoContainer) {
        photoContainer.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; min-height: 100px;">
                <div style="border: 4px solid #f3f3f3; border-top: 4px solid #0ea5e9; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;"></div>
            </div>
        `;
    }

  try {
    const response = await fetch("/api/upload-photos", {
      method: "POST",
      body: formData
    });

    const result = await response.json();
    if (!response.ok) throw new Error(result.message || "Upload failed.");

    showToast(`✅ ${files.length} Photo(s) uploaded successfully!`);
    updatePhotoSection(itemId, type);
  } catch (error) {
    console.error("❌ Photo Upload Error:", error);
    showToast("Failed to upload photos.");
            // Clear loader on error
            if (photoContainer) {
                photoContainer.innerHTML = `<p class="placeholder">Error uploading photos.</p>`;
            }
  }
}

     
// ✅ Delete Photo & Ensure Swiping Remains
async function deletePhoto(itemId, photoUrl, type) {

    
        // ✅ Show inline loader in the photo section
        const containerId = `${type}-photos-${itemId}`;
    const photoContainer = document.getElementById(containerId);
    if (photoContainer) {
        photoContainer.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; min-height: 100px;">
                <div style="border: 4px solid #f3f3f3; border-top: 4px solid #0ea5e9; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;"></div>
            </div>
        `;
    }

    try {
        const response = await fetch(`/api/delete-photo/${localStorage.getItem("vendorId")}/${itemId}/${encodeURIComponent(photoUrl)}`, { method: "DELETE" });

        if (!response.ok) throw new Error("Failed to delete photo.");

        showToast("✅ Photo deleted successfully!");
        updatePhotoSection(itemId, type);
    } catch (error) {
        console.error("❌ Error deleting photo:", error);
        showToast("Failed to delete photo.");
                    // Clear loader on error
                    if (photoContainer) {
                photoContainer.innerHTML = `<p class="placeholder">Error uploading photos.</p>`;
            }
    }
}


function formatDescription(desc) {
  if (!desc) return "N/A";

  const tasks = desc.split(/\s*\d+\.\s*\/\s*/).filter(t => t.trim() !== "");

  return `
    <ul>
      ${tasks.map(task => `<li>${task.trim()}</li>`).join("")}
    </ul>
  `;
}



// ✅ Fetch & Render Assigned Items with Photo Upload & Slideshow
function displayAssignedItems(items) {
    // Check if the container elements exist first
    const container = document.querySelector(".line-items-container");
    
    // Check if container already has elements to avoid duplicates
    let lineItemsList = document.getElementById("line-items-list");
    let totalAmount = document.getElementById("total-amount");
    
    // Only create these elements if they don't exist yet
    if (!lineItemsList || !totalAmount) {
        // Clean existing content to avoid duplicates
        container.innerHTML = `
            <div id="line-items-list"></div>
            <div id="total-amount" class="total-amount-box"></div>
        `;
        
        lineItemsList = document.getElementById("line-items-list");
        totalAmount = document.getElementById("total-amount");
    }
    
    // First check if toggle buttons already exist
    let toggleActiveBtn = document.getElementById("show-active-btn");
    let toggleCompletedBtn = document.getElementById("show-completed-btn");
    
    // Only create toggle buttons if they don't already exist
    if (!toggleActiveBtn || !toggleCompletedBtn) {
        const tabsWrapper = document.createElement("div");
        tabsWrapper.className = "estimate-tabs-wrapper";
        tabsWrapper.innerHTML = `
            <button id="show-active-btn" class="toggle-btn active">Active Items</button>
            <button id="show-completed-btn" class="toggle-btn">Completed Items</button>
        `;
        
        // Insert at the beginning of container
        container.insertBefore(tabsWrapper, container.firstChild);
        
        // Re-assign button references
        toggleActiveBtn = document.getElementById("show-active-btn");
        toggleCompletedBtn = document.getElementById("show-completed-btn");
    }
    
    if (!lineItemsList || !totalAmount) {
        console.error("❌ Error: Elements missing in DOM.");
        return;
    }

    // Split items by status - fixed filter for completed items
    const activeItems = items.filter(item =>
        item.status === "new" ||
        item.status === "in-progress" ||
        item.status === "rework"
    );
    
    const completedItems = items.filter(item =>
        item.status === "completed" || 
        item.status === "approved"
    );
    
    console.log(`Found ${activeItems.length} active items and ${completedItems.length} completed items`);

    // Helper to render a row - kept exactly as original
    function renderRow(item) {
        const currentStatus = item.status || "new";
        let nextLabel = "Mark as In Progress";
        if (currentStatus === "in-progress") nextLabel = "Mark as Completed";
        if (currentStatus === "completed") nextLabel = "Mark as In Progress";

        let statusClass = "new";
        if (currentStatus === "in-progress") statusClass = "in-progress";
        if (currentStatus === "completed") statusClass = "completed";
        if (currentStatus === "approved") statusClass = "approved";

        const reworkNotes = item.qualityControl?.status === "rework"
            ? `<div class="rework-notes">
                   <strong>Rework Notes:</strong> ${item.qualityControl.notes || "No notes provided"}
               </div>`
            : "";

        const row = document.createElement("tr");
        row.innerHTML = `
            <h6>${item.name || "Unnamed Item"}
              <span class="status-label ${statusClass}" id="status-${item.itemId}">
                 ${currentStatus.charAt(0).toUpperCase() + currentStatus.slice(1)}
              </span> 
            </h6>
            <div class="item-description"><h2>Description</h2>${formatDescription(item.description)}</div>
              ${reworkNotes}
            <td style="display:none">Qty: ${item.quantity || "0"} <h4>Unit Price: $${(item.unitPrice || 0).toFixed(2)}</h4></td>
            <td>
                <div class="photo-preview">
                    <div class="photo-section">
                        <h5>Before</h5>
                        <div id="before-photos-${item.itemId}">
                            ${generatePhotoPreview(item.photos.before, item.itemId, "before")}
                        </div>
                        <label class="upload-btn">
                            <input type="file" accept="image/*" multiple onchange="uploadPhoto(event, '${item.itemId}', 'before')">
                            +
                        </label>
                    </div>
                    <div class="photo-section">
                        <h5>After</h5>
                        <div id="after-photos-${item.itemId}">
                            ${generatePhotoPreview(item.photos.after, item.itemId, "after")}
                        </div>
                        <label class="upload-btn">
                            <input type="file" accept="image/*" multiple onchange="uploadPhoto(event, '${item.itemId}', 'after')">
                            +
                        </label>
                    </div>
                </div>
            </td>
            <td>
                <button class="toggle-status-btn" data-item-id="${item.itemId}" data-current-status="${currentStatus}">
                    ${nextLabel}
                </button>
                <h4 style="display:none">Total: $${(item.total || 0).toFixed(2)}</h4>
            </td>
        `;
        return row;
    }

    // --- Render Function for Selected Group ---
    function renderGroup(group, groupName, color) {
        lineItemsList.innerHTML = "";
        if (group.length === 0) {
            lineItemsList.innerHTML = `<tr><td colspan="3" style="text-align:center; color:#888;">No ${groupName.toLowerCase()}.</td></tr>`;
        } else {
            const header = document.createElement("tr");
            header.innerHTML = `<td colspan="3"><h3 style="color:${color};">${groupName}</h3></td>`;
            lineItemsList.appendChild(header);

            group.forEach(item => {
                lineItemsList.appendChild(renderRow(item));
            });
        }
        
        // Update total box for this group only
        totalAmount.innerHTML = `<strong>${groupName} Total:</strong> $${calculateTotal(group)}`;

        // 🔹 Attach toggle-status-btn event listeners for this group
        lineItemsList.querySelectorAll(".toggle-status-btn").forEach(button => {
            button.addEventListener("click", function() {
                const itemId = this.getAttribute("data-item-id");
                const currentStatus = this.getAttribute("data-current-status");
                toggleItemStatus(localStorage.getItem("vendorId"), itemId, currentStatus);
            });
        });
    }

    // --- Toggle Logic ---
    function showActive() {
        toggleActiveBtn.classList.add("active");
        toggleCompletedBtn.classList.remove("active");
        renderGroup(activeItems, "Active Items", "#007BFF");
    }
    
    function showCompleted() {
        toggleActiveBtn.classList.remove("active");
        toggleCompletedBtn.classList.add("active");
        renderGroup(completedItems, "Completed Items", "green");
    }

    // Remove any existing listeners to prevent duplicates
    toggleActiveBtn.removeEventListener("click", showActive);
    toggleCompletedBtn.removeEventListener("click", showCompleted);
    
    // Add fresh event listeners
    toggleActiveBtn.addEventListener("click", showActive);
    toggleCompletedBtn.addEventListener("click", showCompleted);

    // Default: show active items
    showActive();

    // 🔹 Ensure Swipe and Dot Indicators Work Correctly
    enableGlobalSwipeEvents();

    console.log("✅ Items Rendered Successfully!");
}




// ✅ Fix Swiping & Dots After Uploading Photos
async function updatePhotoSection(itemId, type) {
    try {
        const vendorId = localStorage.getItem("vendorId");
        const projectId = new URLSearchParams(window.location.search).get("projectId");
        const activeTab = document.querySelector(".estimate-tab.active");
          const estimateId = activeTab?.dataset.estimateId;
             if (!estimateId) {
            console.warn("No active estimate selected.");
            return;
             }


        const response = await fetch(`/api/vendors/${vendorId}/assigned-items/${projectId}?estimateId=${estimateId}`);
        if (!response.ok) throw new Error("Failed to fetch updated photos.");

        const data = await response.json();
        const item = data.items.find(i => i.itemId?.toString() === itemId.toString());
        if (!item) return;

        document.getElementById(`${type}-photos-${itemId}`).innerHTML = generatePhotoPreview(item.photos[type], itemId, type);

             // ✅ Re-enable swipe and auto slideshow
             enableGlobalSwipeEvents();
        initializeAutoSliding();
    } catch (error) {
        console.error("❌ Error updating photo section:", error);
    }
}


// ✅ FIX: Initialize Auto-Sliding for All Sliders
function initializeAutoSliding() {
    document.querySelectorAll(".photo-wrapper").forEach(wrapper => {
        const itemId = wrapper.id.split("-")[2];
        const type = wrapper.id.split("-")[1];

        if (!wrapper.hasAttribute("data-auto-slide")) {
            wrapper.setAttribute("data-auto-slide", "true");
            setInterval(() => autoSlidePhotos(itemId, type), 4000);
        }
    });
}

// ✅ Ensure Swipe & Auto-Sliding Works After Loading
document.addEventListener("DOMContentLoaded", async () => {
    setTimeout(() => {
        enableGlobalSwipeEvents();
        initializeAutoSliding();
    }, 1500);
});

 </script>
