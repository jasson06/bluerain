<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>All Quotes</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f8fafc;
      padding: 40px;
      margin: 0;
      color: #0f172a;
    }

    h1 {
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 30px;
      color: #0ea5e9;
    }



    .quote-list {
      max-width: 1200px;
      margin: auto;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      overflow: visible; /* ✅ important fix */
      position: relative; /* ensures stacking works */
    }

    .quote-item {
      background: #ffffff;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      cursor: pointer;
      z-index: 1; /* ensures menu appears above it */
    }

    .quote-item:hover {
      transform: scale(1.015);
      box-shadow: 0 0 30px rgba(14, 165, 233, 0.15);
    }

    .quote-meta {
      font-size: 1rem;
      color: #475569;
    }

    .quote-meta strong {
      display: block;
      font-size: 1.2rem;
      color: #0ea5e9;
      margin-bottom: 6px;
    }

 
    .modal {
      display: none;
      position: fixed;
      top: -120px;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 10000;
      padding: 30px;
    }

    .modal-content {
      background: #ffffff;
      color: #0f172a;
      padding: 32px;
      border-radius: 20px;
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 0 40px rgba(0, 0, 0, 0.1);
      position: relative;
      animation: slideUp 0.3s ease-out;
      
    }

    @keyframes slideUp {
      0% {
        opacity: 0;
        transform: translateY(30px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.6rem;
      color: #0f172a;
    }

    .close-modal {
      font-size: 30px;
      cursor: pointer;
      color: #000000;
    }

    .modal-content input,
    .modal-content textarea,
    .modal-content select {
      width: 100%;
      padding: 12px 14px;
      margin-bottom: 14px;
      border: 1px solid #cbd5e1;
      border-radius: 12px;
      background-color: #ffffff;
      color: #0f172a;
      font-size: 1rem;
    }

    .modal-content textarea {
      resize: vertical;
      min-height: 80px;
    }

    .modal-content input:focus,
    .modal-content textarea:focus {
      outline: none;
      border-color: #0ea5e9;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.3);
    }

    .modal-content button {
      background: #10b981;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .modal-content button:hover {
      background: #059669;
    }

    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
      font-size: 0.95rem;
      background-color: #ffffff;
      color: #0f172a;
    }

    th, td {
      padding: 12px;
      border: 1px solid #e2e8f0;
    }

    th {
      background: #f1f5f9;
      color: #0f172a;
      text-align: left;
    }

    @media (max-width: 768px) {
      .filter-bar {
        position: sticky;
        top: 0;
        background: #f8fafc;
        z-index: 999;
        padding: 10px;
      }
    }

    .menu-toggle {
  position: absolute;
  top: 16px;
  right: 16px;
  font-size: 30px;
  background: transparent;
  border: none;
  cursor: pointer;
  color: #0f172a;
  z-index: 20;
}

.quote-menu {
  position: absolute;
  top: 36px;
  right: 16px;
  background: #ffffff;
  border: 1px solid #cbd5e1;
  border-radius: 10px;
  padding: 6px 0;
  display: none;
  flex-direction: column;
  min-width: 160px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  z-index: 9999; /* ← Increased from 99 */
  max-height: 240px;
  overflow-y: auto;
}


.quote-menu button {
  background: transparent;
  border: none;
  color: #0f172a;
  text-align: left;
  padding: 10px 16px;
  font-size: 0.95rem;
  cursor: pointer;
  width: 100%;
  transition: background 0.2s ease-in-out;
}

.quote-menu button:hover {
  background: #f1f5f9;
}

#addQuoteBtn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 48px;
  height: 48px;
  font-size: 45px;
  background: transparent;
  color: #0ea5e9;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  z-index: 10001;
  padding: 0;
  line-height: 1;
  display: flex;
  align-items: center;
  justify-content: center;
}

#addQuoteBtn:hover {
  color: #0284c7;
  background: rgba(14, 165, 233, 0.1);
}




.status-dropdown {
  display: inline-block;
  top: 16px;
  left: 16px;
  font-size: 0.75rem;
  font-weight: 600;
  padding: 4px 12px;
  border: none;
  border-radius: 999px;
  text-transform: uppercase;
  cursor: pointer;
  z-index: 10;
  appearance: none;
  transition: background 0.2s ease;
  color: #fff;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);

}

/* Color variants */
.status-draft {
  background-color: #64748b; /* slate */
}
.status-sent {
  background-color: #f59e0b; /* amber */
}
.status-approved {
  background-color: #10b981; /* green */
}
.status-rejected {
  background-color: #ef4444; /* red */
}

.drag-handle {
  cursor: grab;
  touch-action: none;
  padding: 0 6px;
  font-size: 20px;
  user-select: none;
}
.drag-ghost {
  opacity: 0.4;
  background-color: #f0f0f0;
}


.filter-card {
  background: #ffffff;
  padding: 24px;
  border-radius: 16px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.04);
  margin: 0 auto 30px;
  max-width: 1200px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.filter-group {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  justify-content: center;
}

.input-wrapper {
  position: relative;
  flex: 1 1 100px;
}

.input-wrapper input {
  width: 80%;
  padding: 14px 12px 6px 12px;
  border: 1px solid #cbd5e1;
  border-radius: 12px;
  background: #ffffff;
  font-size: 1rem;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.input-wrapper label {
  position: absolute;
  top: 14px;
  left: 12px;
  color: #64748b;
  background: #ffffff;
  font-size: 14px;
  pointer-events: none;
  transition: all 0.2s ease;
}

.input-wrapper input:focus + label,
.input-wrapper input:not(:placeholder-shown):not(:focus) + label {
  top: -8px;
  left: 10px;
  font-size: 12px;
  color: #0ea5e9;
  padding: 0 4px;
}

.filter-actions {
  display: flex;
  justify-content: center;
  margin-top: 8px;
}

.clear-btn {
  background: #e2e8f0;
  color: #0f172a;
  border: none;
  font-weight: 500;
  padding: 10px 24px;
  font-size: 0.95rem;
  border-radius: 10px;
  cursor: pointer;
  transition: background 0.2s ease;
}

.clear-btn:hover {
  background: #cbd5e1;
}

.active-filters {
  margin-top: 8px;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
}

.active-filters .tag {
  background: #0ea5e9;
  color: white;
  padding: 6px 12px;
  border-radius: 9999px;
  font-size: 0.85rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 6px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.08);
}

.active-filters .tag button {
  background: transparent;
  border: none;
  color: white;
  cursor: pointer;
  font-size: 1rem;
  line-height: 1;
  padding: 0 2px;
}


/* Tooltip for payment status */
.payment-status-tooltip {
  position: relative;
  display: inline-block;
  cursor: pointer;
}

.payment-status-tooltip .tooltip-content {
  visibility: hidden;
  width: max-content;
  max-width: 320px;
  background: #222;
  color: #fff;
  text-align: left;
  border-radius: 6px;
  padding: 8px 12px;
  position: absolute;
  z-index: 100;
  bottom: 125%;
  left: 50%;
  transform: translateX(-50%);
  opacity: 0;
  transition: opacity 0.2s;
  font-size: 0.95em;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.payment-status-tooltip:hover .tooltip-content {
  visibility: visible;
  opacity: 1;
}

/* Modern Payment Modal Styles */
#paymentsModal .modal-content {
  background: #fff;
  border-radius: 18px;
  box-shadow: 0 8px 32px rgba(14, 165, 233, 0.18), 0 1.5px 8px rgba(0,0,0,0.08);
  padding: 32px 28px 24px 28px;
  max-width: 420px;
  width: 100%;
  animation: fadeInScale 0.25s;
  position: relative;
}

#paymentsModal .modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 18px;
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: 10px;
}

#paymentsModal .modal-header h3 {
  font-size: 1.3rem;
  color: #0ea5e9;
  margin: 0;
  font-weight: 700;
  letter-spacing: 0.5px;
}

#paymentsModal .close-modal {
  font-size: 1.8rem;
  color: #64748b;
  cursor: pointer;
  transition: color 0.2s;
}
#paymentsModal .close-modal:hover {
  color: #ef4444;
}

#paymentsModal #paymentSummary {
  background: #f1f5f9;
  border-radius: 10px;
  padding: 14px 18px;
  margin-bottom: 18px;
  font-size: 1.05rem;
  color: #0f172a;
  box-shadow: 0 1px 4px rgba(14,165,233,0.04);
}

#paymentsModal #paymentsForm > div {
  background: #f9fafb;
  border-radius: 8px;
  padding: 10px 12px 8px 12px;
  margin-bottom: 12px;
  box-shadow: 0 1px 3px rgba(14,165,233,0.04);
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
}

#paymentsModal label {
  flex: 1 1 120px;
  font-weight: 600;
  color: #0ea5e9;
  margin-bottom: 0;
}

#paymentsModal input[type="number"] {
  width: 90px;
  border-radius: 7px;
  border: 1px solid #cbd5e1;
  padding: 7px 10px;
  font-size: 1rem;
  background: #fff;
  margin-right: 4px;
  transition: border 0.2s;
}
#paymentsModal input[type="number"]:focus {
  border: 1.5px solid #0ea5e9;
  outline: none;
}

#paymentsModal select {
  border-radius: 7px;
  border: 1px solid #cbd5e1;
  padding: 7px 10px;
  font-size: 1rem;
  background: #fff;
  margin-right: 4px;
  transition: border 0.2s;
}
#paymentsModal select:focus {
  border: 1.5px solid #0ea5e9;
  outline: none;
}

#paymentsModal input[type="date"] {
  border-radius: 7px;
  border: 1px solid #cbd5e1;
  padding: 7px 10px;
  font-size: 1rem;
  background: #fff;
  transition: border 0.2s;
}
#paymentsModal input[type="date"]:focus {
  border: 1.5px solid #0ea5e9;
  outline: none;
}

#paymentsModal #savePaymentsBtn {
  width: 100%;
  margin-top: 18px;
  background: linear-gradient(90deg, #0ea5e9 60%, #10b981 100%);
  color: #fff;
  font-weight: 600;
  font-size: 1.1rem;
  border-radius: 10px;
  padding: 12px 0;
  border: none;
  box-shadow: 0 2px 8px rgba(14,165,233,0.08);
  transition: background 0.2s;
}
#paymentsModal #savePaymentsBtn:hover {
  background: linear-gradient(90deg, #10b981 60%, #0ea5e9 100%);
}

@keyframes fadeInScale {
  0% { opacity: 0; transform: scale(0.97);}
  100% { opacity: 1; transform: scale(1);}
}

/* Modern View Quote Modal Styles */
#quoteModal .modal-content {
  background: #fff;
  border-radius: 22px;
  box-shadow: 0 8px 32px rgba(14, 165, 233, 0.13), 0 1.5px 8px rgba(0,0,0,0.08);
  padding: 38px 32px 28px 32px;
  max-width: 700px;
  width: 100%;
  animation: fadeInScale 0.25s;
  position: relative;
  color: #0f172a;
}

#quoteModal .modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 18px;
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: 10px;
}

#quoteModal .modal-header h3 {
  font-size: 1.5rem;
  color: #0ea5e9;
  margin: 0;
  font-weight: 700;
  letter-spacing: 0.5px;
}

#quoteModal .close-modal {
  font-size: 2rem;
  color: #64748b;
  cursor: pointer;
  transition: color 0.2s;
}
#quoteModal .close-modal:hover {
  color: #ef4444;
}

#quoteModal table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 18px;
  background: #f9fafb;
  border-radius: 10px;
  overflow: hidden;
  font-size: 1rem;
}
#quoteModal th, #quoteModal td {
  padding: 12px 10px;
  border: 1px solid #e2e8f0;
}
#quoteModal th {
  background: #f1f5f9;
  color: #0ea5e9;
  font-weight: 700;
  font-size: 1.05rem;
}
#quoteModal tr:last-child td {
  border-bottom: none;
}

#quoteModal .totals {
  margin-top: 18px;
  text-align: right;
  font-size: 1.08rem;
}
#quoteModal .totals p {
  margin: 4px 0;
}
#quoteModal .totals strong {
  color: #0ea5e9;
  font-size: 1.1rem;
}

#quoteModal .section {
  margin-top: 32px;
}

#quoteModal .section h3, #quoteModal .section h4 {
  color: #0ea5e9;
  margin-bottom: 8px;
}

#quoteModal .payment-schedule-table {
  margin-top: 18px;
  border-radius: 10px;
  overflow: hidden;
  background: #f9fafb;
  box-shadow: 0 1px 4px rgba(14,165,233,0.04);
}

#quoteModal .payment-schedule-table th,
#quoteModal .payment-schedule-table td {
  border: 1px solid #e2e8f0;
  padding: 10px 8px;
  font-size: 1rem;
}
#quoteModal .payment-schedule-table th {
  background: #e0f2fe;
  color: #0ea5e9;
}

#quoteModal .payment-schedule-table td.status-paid {
  color: #10b981;
  font-weight: 600;
}
#quoteModal .payment-schedule-table td.status-overdue {
  color: #ef4444;
  font-weight: 600;
}
#quoteModal .payment-schedule-table td.status-pending {
  color: #64748b;
  font-weight: 600;
}

#quoteModal .summary-row {
  text-align: right;
  font-size: 1.08rem;
  margin-top: 10px;
}

#quoteModal .agreement {
  margin-top: 32px;
  padding-top: 16px;
  border-top: 1px solid #e5e7eb;
}

#quoteModal .signature-line {
  display: flex;
  gap: 50px;
  margin-top: 20px;
}
#quoteModal .signature-line p {
  border-top: 1px solid #333;
  width: 200px;
  text-align: center;
  padding-top: 4px;
  margin: 0;
}

@media (max-width: 700px) {
  #quoteModal .modal-content {
    padding: 18px 6px 18px 6px;
    max-width: 98vw;
  }
}


/* Modern Status Filter Dropdown */
#statusFilter {
  width: 80%;
  padding: 14px 12px 6px 12px;
  border: 1px solid #cbd5e1;
  border-radius: 12px;
  background: #ffffff;
  color: #0f172a;
  font-size: 1rem;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
  appearance: none;
  margin-bottom: 0;
}

#statusFilter:focus {
  outline: none;
  border-color: #0ea5e9;
  box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.18);
}

.input-wrapper label[for="statusFilter"] {
  position: absolute;
  top: 14px;
  left: 12px;
  color: #64748b;
  background: #ffffff;
  font-size: 14px;
  pointer-events: none;
  transition: all 0.2s ease;
}

#statusFilter:focus + label,
#statusFilter:not([value=""]):not(:focus) + label {
  top: -8px;
  left: 10px;
  font-size: 12px;
  color: #0ea5e9;
  padding: 0 4px;
}

/* Responsive Modal Improvements */
@media (max-width: 700px) {
  .modal-content,
  #paymentsModal .modal-content,
  #quoteModal .modal-content {
    max-width: 98vw !important;
    width: 98vw !important;
    min-width: unset !important;
    padding: 12px 4vw 18px 4vw !important;
    border-radius: 14px !important;
    font-size: 1rem !important;
    max-height: 90vh !important;   /* Only restrict more on mobile */
    overflow-y: auto !important;
    box-sizing: border-box;
  }
  #paymentsModal .modal-header,
  #quoteModal .modal-header {
    
    align-items: flex-start;
    gap: 8px;
    padding-bottom: 6px;
  }
  #paymentsModal #paymentsForm > div,
  #quoteModal .payment-schedule-table th,
  #quoteModal .payment-schedule-table td {
    font-size: 0.98rem !important;
    padding: 8px 4px !important;
  }
  #paymentsModal label {
    font-size: 1rem !important;
  }
  #paymentsModal input,
  #paymentsModal select {
    font-size: 1rem !important;
  }
  #paymentsModal #savePaymentsBtn {
    font-size: 1rem !important;
    padding: 10px 0 !important;
  }
  #quoteModal table,
  #quoteModal .payment-schedule-table {
    font-size: 0.98rem !important;
  }
  .modal{
    top: 0;
  }
}

/* Make sure modal backgrounds always cover the screen */
.modal {
  align-items: flex-start;
  justify-content: center;
  padding: 10vw 0 0 0;
  min-height: 100vh;
}

/* Ensure modal content is always scrollable if needed */
.modal-content,
#paymentsModal .modal-content,
#quoteModal .modal-content {
  max-height: 96vh;
  overflow-y: auto;
  box-sizing: border-box;
}
  </style>
</head>
<body>
  
  <h1>📄 All Quotes</h1>

  <div class="filter-card">
    <div class="filter-group">
      <div class="input-wrapper">
        <input type="text" id="searchName" placeholder=" " />
        <label for="searchName">Client Name</label>
      </div>
      <div class="input-wrapper">
        <input type="text" id="searchNumber" placeholder=" " />
        <label for="searchNumber">Quote #</label>
      </div>
      <div class="input-wrapper">
        <input type="date" id="startDate" />
        <label for="startDate">From Date</label>
      </div>
      <div class="input-wrapper">
        <input type="date" id="endDate" />
        <label for="endDate">To Date</label>
      </div>
      
      <div class="input-wrapper">
        <input type="text" id="searchAddress" placeholder=" " />
        <label for="searchAddress">Address</label>
      </div>
    </div>
    <div class="input-wrapper">

  <select id="statusFilter">
    <option value="">All Statuses</option>
    <option value="Draft">Draft</option>
    <option value="Sent">Sent</option>
    <option value="Approved">Approved</option>
    <option value="Rejected">Rejected</option>
  </select>
  <label for="statusFilter">Status</label>
</div>

    <div class="filter-actions">
      <button class="btn clear-btn" onclick="clearFilters()">Clear Filters</button>
    </div>
    <div class="active-filters" id="activeFilters"></div>
  </div>
  
  
  
  <div id="quoteContainer" class="quote-list"></div>

  <div id="quoteModal" class="modal">
    <div class="modal-content">
      <div id="quoteModalContent"></div>
    </div>
  </div>

  <div id="quoteDetailContent" style="display: none;"></div>

  
  <button id="addQuoteBtn" onclick="location.href='/createquote.html'" title="New Quote">
    ＋
  </button>

<div id="paymentsModal" class="modal">
  <div class="modal-content" style="max-width: 700px;">
    <div class="modal-header">
      <h3>Manage Payments</h3>
      <span class="close-modal" onclick="closePaymentsModal()">&times;</span>
    </div>
    <div id="paymentsModalBody"></div>
    <button id="savePaymentsBtn" style="margin-top: 16px; background: #0ea5e9;">Save</button>
  </div>
</div>

<!-- Payment Schedule Selection Modal -->
<div id="scheduleSelectModal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <h3>Select Payment Schedule</h3>
      <span class="close-modal" onclick="closeScheduleSelectModal()">&times;</span>
    </div>
    <div id="scheduleSelectBody"></div>
    <button id="selectScheduleBtn" style="margin-top: 18px; background: #0ea5e9;">Select</button>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" style="
  position: fixed;
  top: 30px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(to right, #0ea5e9, #3b82f6);
  color: white;
  padding: 14px 24px;
  border-radius: 8px;
  display: none;
  z-index: 20000;
  font-weight: 500;
  font-size: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  transition: opacity 0.3s ease, transform 0.3s ease;
  pointer-events: none;
"></div>

<!-- Loader Spinner -->
<div id="loader" style="
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(2px);
  z-index: 9999;
  display: none;
  justify-content: center;
  align-items: center;
">
  <div style="
    border: 5px solid #e5e7eb;
    border-top: 5px solid #3b82f6;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    animation: spin 0.8s linear infinite;
  "></div>
</div>

<!-- Add this to your <style> block or <head> -->
<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Required for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <script>
    function formatDateInput(dateStr) {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  return date.toISOString().split('T')[0];
}

// Global event to close all menus when clicking outside
document.addEventListener('click', (e) => {
  document.querySelectorAll('.quote-menu').forEach(menu => {
    if (!menu.contains(e.target) && !e.target.classList.contains('menu-toggle')) {
      menu.style.display = 'none';
    }
  });
});



function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.style.display = 'block';
  setTimeout(() => { toast.style.display = 'none'; }, 3000);
}

function showLoader() {
  document.getElementById('loader').style.display = 'flex';
}

function hideLoader() {
  document.getElementById('loader').style.display = 'none';
}



    let allQuotes = [];

    async function fetchQuotes() {
      showLoader(); // 👈 START
      try {
        const res = await fetch('/api/quotes');
        allQuotes = await res.json();
        renderQuotes(allQuotes);
      } catch (err) {
        console.error('Error loading quotes:', err);
      } finally {
        hideLoader(); // 👈 END 
      }
    }


    // Add this above renderQuotes()
function getPaymentStatus(payments) {
  if (!payments || payments.length === 0) return "No Schedule";
  const allPaid = payments.every(p => p.status === "Paid");
  const anyOverdue = payments.some(p => p.status === "Overdue");
  const anyPaid = payments.some(p => p.status === "Paid");
  if (allPaid) return "All Paid";
  if (anyOverdue) return "Overdue";
  if (anyPaid) return "Partial";
  return "Pending";
}

function renderQuotes(quotes) {
  const container = document.getElementById('quoteContainer');
  container.innerHTML = quotes.map(q => {
    const statusClass = {
      'Draft': 'status-draft',
      'Sent': 'status-sent',
      'Approved': 'status-approved',
      'Rejected': 'status-rejected'
    }[q.status] || 'status-draft';

    // --- Payment Status ---
    const paymentStatus = getPaymentStatus(q.payments);
    let paymentColor = "#64748b"; // default
    if (paymentStatus === "All Paid") paymentColor = "#10b981";
    else if (paymentStatus === "Overdue") paymentColor = "#ef4444";
    else if (paymentStatus === "Partial") paymentColor = "#f59e0b";
    else if (paymentStatus === "Pending") paymentColor = "#64748b";

    // --- Quote Total ---
    const total = q.totals?.total !== undefined
      ? `$${parseFloat(q.totals.total).toLocaleString(undefined, { minimumFractionDigits: 2 })}`
      : "N/A";

      // ...inside renderQuotes(quotes)...
const totalNum = q.totals?.total ? parseFloat(q.totals.total) : 0;
const paid = (q.payments || []).filter(p => p.status === "Paid")
  .reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
const outstanding = totalNum - paid;

const paidPayments = (q.payments || []).filter(p => p.status === "Paid");
const tooltipContent = paidPayments.length
  ? paidPayments.map(p =>
      `<div>
        <strong>${p.label}:</strong> $${parseFloat(p.amount).toLocaleString(undefined, {minimumFractionDigits:2})}
        ${p.date ? `<span style="color:#a3e635;">(${p.date})</span>` : ""}
      </div>`
    ).join('')
  : "<div>No payments made yet.</div>";

return `
  <div class="quote-item" onclick="viewQuote('${q._id}')">
    <div class="quote-meta">
      <strong>${q.quoteNumber}</strong>
      ${q.to.address || 'No Address Provided'}<br>
      ${q.to?.name || 'Unknown'}<br>
      <small>${new Date(q.date).toLocaleDateString()}</small>
    </div>

    <div style="margin: 10px 0 6px 0;">
      <span style="font-weight:600;">Total:</span>
      <span style="color:#0ea5e9; font-weight:600;">${total}</span>
    </div>

    ${
      q.status === "Approved"
        ? `
          <div style="margin-bottom: 8px;">
            <span
              class="payment-status-tooltip"
              style="
                display:inline-block;
                padding:2px 12px;
                border-radius:999px;
                background:${paymentColor};
                color:#fff;
                font-size:0.85rem;
                font-weight:600;
                letter-spacing:0.5px;
                cursor:pointer;
              "
              onclick="event.stopPropagation(); openPaymentsModal('${q._id}')"
              title="Click to manage payments"
            >
              ${paymentStatus}
              <span class="tooltip-content">
                ${tooltipContent}
              </span>
            </span>
          </div>
          <div style="margin-bottom: 8px;">
            <span style="font-weight:600;">Outstanding:</span>
            <span style="color:${outstanding > 0 ? '#ef4444' : '#10b981'};">
              $${outstanding.toLocaleString(undefined, {minimumFractionDigits:2})}
            </span>
          </div>
        `
        : ""
    }

    <select class="status-dropdown ${statusClass}" onchange="updateQuoteStatus(event, '${q._id}', this.value)" onclick="event.stopPropagation()">
      ${['Draft', 'Sent', 'Approved', 'Rejected'].map(status => `
        <option value="${status}" ${q.status === status ? 'selected' : ''}>${status}</option>
      `).join('')}
    </select>

    <div class="menu-toggle" onclick="toggleMenu(event, '${q._id}')">⋮</div>
    <div class="quote-menu" id="menu-${q._id}">
      <button onclick="event.stopPropagation(); openPaymentsModal('${q._id}')">Manage Payments</button>
          <button onclick="event.stopPropagation(); viewQuote('${q._id}')">View</button>
          <button onclick="event.stopPropagation(); editQuote('${q._id}')">Edit</button>
          <button onclick="event.stopPropagation(); downloadQuoteAsPDF('${q._id}')">Download Quote PDF</button>
          <button onclick="event.stopPropagation(); downloadInvoiceAsPDF('${q._id}')"> Download Invoice PDF</button>
          <button onclick="event.stopPropagation(); downloadReceiptAsPDF('${q._id}')">Download Receipt PDF</button>
          <button onclick="event.stopPropagation(); printQuote('${q._id}')">Print</button>
          <button onclick="event.stopPropagation(); shareQuote('${q._id}')">Share</button>
          <button onclick="event.stopPropagation(); convertToJob('${q._id}')">Convert to Job</button>
          <button onclick="event.stopPropagation(); exportQuoteToExcel('${q._id}')">Export to Excel</button>
          <button onclick="event.stopPropagation(); deleteQuote('${q._id}')">Delete</button>
        </div>
      </div>
    `;
  }).join('');
}


async function updateQuoteStatus(event, id, newStatus) {
  event.stopPropagation(); // Prevent modal opening
  showLoader(); // 👈 START
  try {
    // Fetch the full quote first
    const res = await fetch(`/api/quotes/${id}`);
    const quote = await res.json();

    if (!quote || !quote._id) {
      showToast('Failed to load quote data.');
      return;
    }

    // Update status in quote object
    quote.status = newStatus;

    // Send full PUT update with status
    const updateRes = await fetch(`/api/quotes/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(quote)
    });

    if (updateRes.ok) {
      showToast(`Status updated to "${newStatus}"`);
      fetchQuotes(); // refresh UI
    } else {
      showToast('Failed to update status.');
    }
  } catch (err) {
    console.error('Status update failed:', err);
    showToast('Error updating status.');
  } finally {
    hideLoader(); // 👈 END 
  }
}




function toggleMenu(event, id) {
  event.stopPropagation();

  const menu = document.getElementById(`menu-${id}`);
  const card = menu.closest('.quote-item');

  // Close all menus and reset z-index for all items
  document.querySelectorAll('.quote-menu').forEach(m => m.style.display = 'none');
  document.querySelectorAll('.quote-item').forEach(item => item.style.zIndex = '1');

  // Toggle current menu and raise its quote-item
  const isVisible = menu.style.display === 'flex';
  menu.style.display = isVisible ? 'none' : 'flex';
  card.style.zIndex = isVisible ? '1' : '100'; // lift above others
}





function filterQuotes() {
  const name = document.getElementById('searchName').value.toLowerCase();
  const number = document.getElementById('searchNumber').value.toLowerCase();
  const address = document.getElementById('searchAddress').value.toLowerCase();
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const status = document.getElementById('statusFilter').value;

  const filtered = allQuotes.filter(q => {
    const clientName = q.to?.name?.toLowerCase() || '';
    const quoteNum = q.quoteNumber?.toLowerCase() || '';
    const fullAddress = `${q.to?.address || ''}`.toLowerCase();
    const quoteDate = q.date ? new Date(q.date).toISOString().split('T')[0] : '';
    const isWithinDateRange =
      (!startDate || quoteDate >= startDate) &&
      (!endDate || quoteDate <= endDate);

    // Add status filter here
    const statusMatch = !status || q.status === status;

    return (
      clientName.includes(name) &&
      quoteNum.includes(number) &&
      fullAddress.includes(address) &&
      isWithinDateRange &&
      statusMatch
    );
  });

  renderQuotes(filtered);
  updateActiveFilters();
}



function updateActiveFilters() {
  const filters = [
    { id: 'searchName', label: 'Client' },
    { id: 'searchNumber', label: 'Quote #' },
    { id: 'searchAddress', label: 'Address' },
    { id: 'statusFilter', label: 'Status' } // <-- Add this line
  ];

  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const container = document.getElementById('activeFilters');
  container.innerHTML = '';

  // ✅ Add simple text filters
  filters.forEach(filter => {
    const val = document.getElementById(filter.id).value;
    if (val) {
      const tag = document.createElement('div');
      tag.className = 'tag';
      tag.innerHTML = `${filter.label}: ${val} <button onclick="removeFilter('${filter.id}')">&times;</button>`;
      container.appendChild(tag);
    }
  });

  // ✅ Add date range filter
  if (startDate || endDate) {
    const label = startDate && endDate
      ? `Date: ${startDate} → ${endDate}`
      : startDate
      ? `From: ${startDate}`
      : `Until: ${endDate}`;
    
    const tag = document.createElement('div');
    tag.className = 'tag';
    tag.innerHTML = `${label} <button onclick="removeFilter('startDate'); removeFilter('endDate')">&times;</button>`;
    container.appendChild(tag);
  }
}


function removeFilter(id) {
  document.getElementById(id).value = '';
  filterQuotes();
}

function clearFilters() {
  document.getElementById('searchName').value = '';
  document.getElementById('searchNumber').value = '';
  document.getElementById('searchAddress').value = '';
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  document.getElementById('statusFilter').value = '';
  filterQuotes();
}




    
document.getElementById('searchName').addEventListener('input', filterQuotes);
document.getElementById('searchNumber').addEventListener('input', filterQuotes);
document.getElementById('searchAddress').addEventListener('input', filterQuotes);
document.getElementById('startDate').addEventListener('change', filterQuotes);
document.getElementById('endDate').addEventListener('change', filterQuotes);
document.getElementById('statusFilter').addEventListener('change', filterQuotes);


    function openModal(contentHTML) {
      document.getElementById('quoteModalContent').innerHTML = contentHTML;
      document.getElementById('quoteModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('quoteModal').style.display = 'none';
    }

// ✅ Updated: viewQuote()
async function viewQuote(id) {
  showLoader(); // 👈 START
  try {
    const res = await fetch(`/api/quotes/${id}`);
    const q = await res.json();
    
    let schedule = q.payments || [ ...defaultSchedule ];
    const total30 = (q.totals.total * 0.30).toLocaleString(undefined, { minimumFractionDigits: 2 });
    const total10 = (q.totals.total * 0.10).toLocaleString(undefined, { minimumFractionDigits: 2 });

    const items = q.lineItems.map(item => `
      <tr>
        <td>${item.name}</td>
        <td>${item.description}</td>
        <td>$${item.rate.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
        <td>${item.qty}</td>
        <td>$${(item.rate * item.qty).toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
      </tr>`).join('');

      let payments = (q.payments && q.payments.length > 0)
  ? q.payments
  : [
      { label: "30% at project start", amount: +(q.totals.total * 0.3).toFixed(2), status: "Pending", date: "" },
      { label: "30% at 50% completion", amount: +(q.totals.total * 0.3).toFixed(2), status: "Pending", date: "" },
      { label: "30% at 75% completion", amount: +(q.totals.total * 0.3).toFixed(2), status: "Pending", date: "" },
      { label: "10% at final completion", amount: +(q.totals.total * 0.1).toFixed(2), status: "Pending", date: "" }
    ];

const totalPaid = payments
  .filter(p => p.status === "Paid")
  .reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
const outstanding = q.totals.total - totalPaid;

const paymentsTable = `
  <div style="margin-top:30px;">
    <h3>Payment Schedule</h3>
    <table  style="width:100%; border-collapse:collapse; margin-top:10px;">
      <thead>
        <tr style="background:#f3f4f6;">
          <th style="padding:8px; border:1px solid #ddd;">Stage</th>
          <th style="padding:8px; border:1px solid #ddd;">Amount</th>
          <th style="padding:8px; border:1px solid #ddd;">Status</th>
          <th style="padding:8px; border:1px solid #ddd;">Date Paid</th>
        </tr>
      </thead>
      <tbody>
        ${payments.map(p => `
          <tr>
            <td style="padding:8px; border:1px solid #ddd;">${p.label}</td>
            <td style="padding:8px; border:1px solid #ddd;">$${parseFloat(p.amount).toLocaleString(undefined, {minimumFractionDigits:2})}</td>
            <td style="padding:8px; border:1px solid #ddd; color:${p.status === "Paid" ? "#10b981" : (p.status === "Overdue" ? "#ef4444" : "#64748b")}; font-weight:600;">
              ${p.status}
            </td>
            <td style="padding:8px; border:1px solid #ddd;">${p.status === "Paid" && p.date ? p.date : ""}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    <div style="margin-top:10px; text-align:right;">
      <strong>Total Paid:</strong> $${totalPaid.toLocaleString(undefined, {minimumFractionDigits:2})}<br>
      <strong>Outstanding:</strong> <span style="color:${outstanding > 0 ? '#ef4444' : '#10b981'};">
        $${outstanding.toLocaleString(undefined, {minimumFractionDigits:2})}
      </span>
    </div>
  </div>
`;

    const html = `
      <div class="modal-header">
        <h3>Quote Details</h3>
        <span class="close-modal" onclick="closeModal()">&times;</span>
      </div>
      <p><strong>Quote #:</strong> ${q.quoteNumber}</p>
      <p><strong>Date:</strong> ${new Date(q.date).toLocaleDateString()}</p>
      <p><strong>Valid till:</strong> ${new Date(q.validTill).toLocaleDateString()}</p>
      <hr>
      <h4>Quote From</h4>
      <p>${q.from.name}<br>${q.from.address}<br>${q.from.email}<br>${q.from.phone}<br><strong>License #:</strong> ${q.from.license || 'RBC-2400049'}</p>
      <h4>Quote To</h4>
      <p>${q.to.name}<br>${q.to.address}<br>${q.to.email}<br>${q.to.phone}</p>
      <h4>Line Items</h4>
      <table>
        <thead>
          <tr>
            <th>Item</th><th>Description</th><th>Rate</th><th>Qty</th><th>Total</th>
          </tr>
        </thead>
        <tbody>${items}</tbody>
      </table>
      <div style="text-align: right; margin-top: 10px;">
        <p><strong>Subtotal:</strong> $${q.totals.subtotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
        <p><strong>Discount:</strong> $${q.totals.discount.toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
        <p><strong>Tax:</strong> ${q.totals.tax.toLocaleString(undefined, { minimumFractionDigits: 2 })}%</p>
        <p><strong>Total:</strong> $${q.totals.total.toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
      </div>
 <div style="margin-top: 20px;">
    <strong>Notes:</strong>
    <p>${q.notes || 'None'}</p>
  </div>
  ${paymentsTable}
  <div style="margin-top: 30px;">
    <h3>Agreement</h3>
    <p>If you accept this quote, please sign and return.</p>
    <p><strong>Client Name:</strong> ${q.to.name || "____________________________"}</p>
    <p><strong>Signature:</strong> ____________________________</p>
    <p><strong>Date:</strong> ____________________________</p>
  </div>
`;

    openModal(html);
  } catch (err) {
    console.error('Error fetching quote:', err);
    showToast('Failed to load quote details.');
  } finally {
    hideLoader(); // 👈 END  
  }
}

// Replace the existing editQuote() function
async function editQuote(id) {
  // Instead of opening a modal, redirect to createquote.html with the quote ID
  window.location.href = `/createquote.html?quoteId=${id}`;
}


function enableDragAndDrop() {
  const container = document.getElementById('lineItemsContainer');

  Sortable.create(container, {
    handle: '.drag-handle',
    animation: 150,
    ghostClass: 'drag-ghost',
    onEnd: () => {
      const reorderedItems = [];
      container.querySelectorAll('.line-item').forEach(item => {
        reorderedItems.push({
          name: item.querySelector('.item-name')?.value || '',
          description: item.querySelector('.item-desc')?.value || '',
          rate: parseFloat(item.querySelector('.item-rate')?.value || 0),
          qty: parseFloat(item.querySelector('.item-qty')?.value || 0)
        });
      });
      lineItems = reorderedItems; // update main array if you want to persist order
      setupLiveTotalCalculation(); // recalculate totals after reorder
    }
  });
}


function setupLiveTotalCalculation() {
  const container = document.getElementById('lineItemsContainer');

  const updateTotals = () => {
    let subtotal = 0;
    container.querySelectorAll('.line-item').forEach(item => {
      const rate = parseFloat(item.querySelector('.item-rate')?.value || 0);
      const qty = parseFloat(item.querySelector('.item-qty')?.value || 0);
      subtotal += rate * qty;
    });

    const discount = parseFloat(document.getElementById('editDiscount')?.value || 0);
    const taxRate = parseFloat(document.getElementById('editTax')?.value || 0); // treat as %
    const taxAmount = subtotal * (taxRate / 100);

    const total = subtotal + taxAmount - discount;

    document.getElementById('calcSubtotal').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('calcTotal').textContent = `$${total.toFixed(2)}`;
  };

  container.addEventListener('input', updateTotals);
  document.getElementById('editDiscount').addEventListener('input', updateTotals);
  document.getElementById('editTax').addEventListener('input', updateTotals);

  updateTotals();
}






function addNewLineItem() {
  const container = document.getElementById('lineItemsContainer');
  const row = document.createElement('div');
  row.className = 'line-item';
  row.style.cssText = `
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
    align-items: center;
  `;

  row.innerHTML = `
    <input type="text" class="item-name" placeholder="Item name" style="flex: 1 1 150px; min-width: 100px;" />
    <input type="text" class="item-desc" placeholder="Description" style="flex: 2 1 200px; min-width: 120px;" />
    <input type="number" class="item-rate" placeholder="Rate" style="flex: 1 1 80px; min-width: 60px;" />
    <input type="number" class="item-qty" placeholder="Qty" style="flex: 1 1 60px; min-width: 50px;" />
    <button class="delete-line-btn" style="background: none; border: none; cursor: pointer; color: #e11d48;" title="Delete line item">
      🗑️
    </button>
  `;

  container.appendChild(row);
}


document.addEventListener('click', function (e) {
  if (e.target && e.target.classList.contains('delete-line-btn')) {
    const row = e.target.closest('.line-item');
    if (row) row.remove();
  }
});





async function saveEditedQuote(id) {
  const updatedQuote = {
    quoteNumber: document.getElementById('quoteNumber').value,
    from: {
      name: document.getElementById('fromName').value,
      address: document.getElementById('fromAddress').value,
      email: document.getElementById('fromEmail').value,
      phone: document.getElementById('fromPhone').value,
      license: document.getElementById('fromLicense').value
    },
    to: {
      name: document.getElementById('clientName').value,
      address: document.getElementById('clientAddress').value,
      email: document.getElementById('clientEmail').value,
      phone: document.getElementById('clientPhone').value
    },
    date: document.getElementById('quoteDate').value,
    validTill: document.getElementById('validTill').value,
    notes: document.getElementById('quoteNotes').value,
    lineItems: []
  };

  let subtotal = 0;

  // 🔁 Get all current line items using class selectors
  const names = document.querySelectorAll('.item-name');
  const descs = document.querySelectorAll('.item-desc');
  const rates = document.querySelectorAll('.item-rate');
  const qtys = document.querySelectorAll('.item-qty');
  showLoader(); // 👈 START
  try {
    // ✅ Fetch the existing quote first to retain costCodes
    const existingRes = await fetch(`/api/quotes/${id}`);
    const existingQuote = await existingRes.json();

    for (let i = 0; i < names.length; i++) {
      const name = names[i].value.trim();
      const description = descs[i].value.trim();
      const rate = parseFloat(rates[i].value) || 0;
      const qty = parseFloat(qtys[i].value) || 0;

      // Avoid adding completely blank rows
      if (name || description || rate > 0 || qty > 0) {
        // Try to find matching old item by name
        const existingItem = existingQuote.lineItems.find(item => item.name === name);

        updatedQuote.lineItems.push({
          costCode: existingItem?.costCode || "Uncategorized", // ✅ Retain original costCode
          name,
          description,
          rate,
          qty
        });

        subtotal += rate * qty;
      }
    }

    const discount = parseFloat(document.getElementById('editDiscount')?.value || 0);
    const tax = parseFloat(document.getElementById('editTax')?.value || 0);
    const total = subtotal - discount + tax;

    updatedQuote.totals = { subtotal, discount, tax, total };

    // ✅ Now submit
    const res = await fetch(`/api/quotes/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updatedQuote)
    });

    if (res.ok) {
      showToast('✅ Quote updated successfully.');
      closeModal();
      fetchQuotes();
    } else {
      showToast('❌ Failed to update quote.');
    }
  } catch (err) {
    console.error('Save error:', err);
    showToast('❌ An error occurred while saving.');
  } finally {
    hideLoader(); // 👈 END  
  }
}





// ✅ Updated: downloadQuoteAsPDF()
async function downloadQuoteAsPDF(id) {
  showLoader(); // 👈 START
  try {
    const res = await fetch(`/api/quotes/${id}`);
    const q = await res.json();

    const total30 = (q.totals.total * 0.30).toLocaleString(undefined, { minimumFractionDigits: 2 });
    const total10 = (q.totals.total * 0.10).toLocaleString(undefined, { minimumFractionDigits: 2 });
    const clientNameSafe = q.to.name.replace(/[^a-z0-9]/gi, '_'); // sanitize for safe filename

    // --- Group line items by category ---
    function groupLineItemsByCategory(items) {
      const groups = {};
      items.forEach(item => {
        let category = 'General';
        if (item.name && item.name.includes('-')) {
          category = item.name.split('-').slice(1).join('-').trim();
          if (!category) category = 'General';
        }
        if (!groups[category]) groups[category] = [];
        groups[category].push(item);
      });
      return groups;
    }
    const grouped = groupLineItemsByCategory(q.lineItems);

    function capitalizeCategory(str) {
  if (!str) return '';
  return str.replace(/\b\w/g, c => c.toUpperCase());
}

    // --- Render grouped line items as HTML ---
    let groupedLineItemsHTML = '';
    Object.keys(grouped).forEach(category => {
  groupedLineItemsHTML += `
    <tr>
      <td colspan="5" style="
        background: #f1f5f9;
        font-weight: 500;
        color: #217dbb;
        font-size: 1.06rem;
        letter-spacing: 0.5px;
        padding: 12px 0 12px 16px;
        margin-top: 8px;
        ">
        ${capitalizeCategory(category)}
      </td>
    </tr>
  `;
      grouped[category].forEach(item => {
        groupedLineItemsHTML += `
          <tr>
            <td>${item.name}</td>
            <td>${item.description}</td>
            <td>$${item.rate.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
            <td>${item.qty}</td>
            <td>$${(item.rate * item.qty).toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
          </tr>
        `;
      });
    });

    const styledHTML = `
      <html>
        <head>
          <meta charset="UTF-8">
          <title>Quote PDF</title>
          <style>
            body {
              font-family: 'Segoe UI', sans-serif;
              color: #000;
              font-size: 14px;
              padding: 40px;
              max-width: 800px;
              margin: auto;
              background-color: #ffffff;
            }
            h2 {
              color: #0ea5e9;
            }
            table {
              width: 100%;
              margin-top: 20px;
              border-collapse: collapse;
              font-size: 0.95rem;
              background-color: #ffffff;
              color: #0f172a;
            }
            th, td {
              padding: 12px;
              border: 1px solid #e2e8f0;
            }
            th {
              background: #f1f5f9;
              color: #0f172a;
              text-align: left;
            }
            .totals p {
              margin: 4px 0;
              text-align: right;
            }
            .totals strong {
              color: #0ea5e9;
              font-size: 16px;
            }
            .signature-line {
              display: flex;
              gap: 50px;
              margin-top: 20px;
            }
            .signature-line p {
              border-top: 1px solid #333;
              width: 200px;
              text-align: center;
              padding-top: 4px;
            }
          </style>
        </head>
        <body>
          <div style="font-family: 'Segoe UI', sans-serif; padding: 40px; max-width: 800px; color: #000; font-size: 14px;">
            <h2 style="color:#0ea5e9;">BESF LLC</h2>
            <p><strong>Quote #:</strong> ${q.quoteNumber}</p>
            <p><strong>Date:</strong> ${new Date(q.date).toLocaleDateString()}</p>
            <p><strong>Valid till:</strong> ${new Date(q.validTill).toLocaleDateString()}</p>

            <div style="display: flex; justify-content: space-between;">
              <div style="width:48%">
                <h4>Quote From</h4>
                <p>
                  ${q.from.name}<br>
                  ${q.from.address}<br>
                  ${q.from.email}<br>
                  ${q.from.phone}<br>
                  <strong>License:</strong> ${q.from.license || 'RBC-2400049'}
                </p>
              </div>
              <div style="width:48%">
                <h4>Quote To</h4>
                <p>
                  ${q.to.name}<br>
                  ${q.to.address}<br>
                  ${q.to.email}<br>
                  ${q.to.phone}
                </p>
              </div>
            </div>

            <h3 style="margin-top: 30px;">Line Items</h3>
            <table>
              <thead>
                <tr>
                  <th>Item</th><th>Description</th><th>Rate</th><th>Qty</th><th>Total</th>
                </tr>
              </thead>
              <tbody>
                ${groupedLineItemsHTML}
              </tbody>
            </table>

          <div style="margin-top: 20px; text-align: right;">
           <p><strong>Subtotal:</strong> $${parseFloat(q.totals.subtotal).toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
           <p><strong>Discount:</strong> $${parseFloat(q.totals.discount).toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
            <p><strong>Tax:</strong> $${parseFloat(q.totals.tax).toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
            <p><strong style="font-size: 18px;">Total:</strong> 
            <span style="color: #007bff;">$${parseFloat(q.totals.total).toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>
           </p>

          </div>

            <div class="section" style="margin-top: 20px;">
              <strong>Notes:</strong>
              <p>${q.notes || 'None'}</p>
            </div>

            <h4>Payment Terms</h4>
            <ul>
              <li><strong>30%</strong> at project start: <strong>$${total30}</strong></li>
              <li><strong>30%</strong> at 50% completion: <strong>$${total30}</strong></li>
              <li><strong>30%</strong> at 75% completion: <strong>$${total30}</strong></li>
              <li><strong>10%</strong> at final completion: <strong>$${total10}</strong></li>
            </ul>
            <p>All payments are due within 7 days of invoice unless otherwise agreed in writing. Late payments may be subject to additional fees.</p>

            <div class="section" style="margin-top: 30px;">
              <h4>Agreement</h4>
              <p>If you accept this quote, please sign and return.</p>
              <p><strong>Client Name:</strong> ${q.to.name || 'Client Name'}</p>
              <p><strong>Signature:</strong> ____________________________</p>
              <p><strong>Date:</strong> ____________________________</p>
            </div>
          </div>
        </body>
      </html>
    `;

    const iframe = document.createElement('iframe');
    iframe.style.position = 'fixed';
    iframe.style.left = '-9999px';
    document.body.appendChild(iframe);

    const doc = iframe.contentWindow.document;
    doc.open();
    doc.write(styledHTML);
    doc.close();

    await new Promise(resolve => setTimeout(resolve, 300));

    await html2pdf().set({
      margin: 0,
      filename: `Quote-${q.quoteNumber}-${clientNameSafe}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, scrollY: 0, backgroundColor: '#ffffff' },
      jsPDF: { unit: 'pt', format: 'letter', orientation: 'portrait' },
      pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    }).from(doc.body).save();

    document.body.removeChild(iframe);
  } catch (err) {
    console.error("PDF download error:", err);
    showToast("Failed to generate or download PDF.");
  } finally {
    hideLoader(); // 👈 END  
  }
}

// Helper functions (add once, outside the main functions if not already present)
function groupLineItemsByCategory(items) {
  const groups = {};
  items.forEach(item => {
    let category = 'General';
    if (item.name && item.name.includes('-')) {
      category = item.name.split('-').slice(1).join('-').trim();
      if (!category) category = 'General';
    }
    if (!groups[category]) groups[category] = [];
    groups[category].push(item);
  });
  return groups;
}
function capitalizeCategory(str) {
  if (!str) return '';
  return str.replace(/\b\w/g, c => c.toUpperCase());
}

// ✅ downloadReceiptAsPDF() — same structure as invoice, labeled "Receipt"
async function downloadReceiptAsPDF(id) {
  showLoader(); // 👈 START
  try {
    const res = await fetch(`/api/quotes/${id}`);
    const q = await res.json();

    const total30 = (q.totals.total * 0.30).toLocaleString(undefined, { minimumFractionDigits: 2 });
    const total10 = (q.totals.total * 0.10).toLocaleString(undefined, { minimumFractionDigits: 2 });
    const receiptNumber = `R-${new Date().getTime()}`;
    const clientNameSafe = q.to.name.replace(/[^a-z0-9]/gi, '_'); // sanitize filename

    // --- Group and render line items ---
    const grouped = groupLineItemsByCategory(q.lineItems);
    let groupedLineItemsHTML = '';
    Object.keys(grouped).forEach(category => {
      groupedLineItemsHTML += `
        <tr>
          <td colspan="5" style="
            background: #f1f5f9;
            font-weight: 500;
            color: #217dbb;
            font-size: 1.06rem;
            letter-spacing: 0.5px;
            padding: 12px 0 12px 16px;
            margin-top: 8px;
            ">
            ${capitalizeCategory(category)}
          </td>
        </tr>
      `;
      grouped[category].forEach(item => {
        groupedLineItemsHTML += `
          <tr>
            <td>${item.name}</td>
            <td>${item.description}</td>
            <td>$${item.rate.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
            <td>${item.qty}</td>
            <td>$${(item.rate * item.qty).toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
          </tr>
        `;
      });
    });

    const styledHTML = `
      <html>
        <head>
          <meta charset="UTF-8">
          <title>Receipt PDF</title>
          <style>
            body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0 auto; padding: 40px; color: #000; font-size: 14px; max-width: 800px; }
            h1, h2, h3, h4 { margin: 0; padding: 0; }
            .company { color: #0ea5e9; font-size: 20px; font-weight: bold; margin-bottom: 8px; }
            .info-grid { display: flex; justify-content: space-between; margin: 20px 0; }
            .info-section { width: 48%; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            thead { background: #f3f4f6; }
            th, td { padding: 8px; text-align: left; border: 1px solid #ddd; }
            .totals { margin-top: 20px; text-align: right; }
            .totals p { margin: 4px 0; }
            .totals strong { color: #0ea5e9; }
            .section { margin-top: 40px; }
            .signature-line { display: flex; gap: 50px; margin-top: 20px; }
            .signature-line p { border-top: 1px solid #333; width: 200px; text-align: center; margin-top: 20px; padding-top: 4px; }
            hr { margin: 30px 0; border: none; border-top: 1px solid #ccc; }
          </style>
        </head>
        <body>
          <div style="font-family: 'Segoe UI', sans-serif; padding: 40px; max-width: 800px; color: #000; font-size: 14px;">
            <h2 style="color:#0ea5e9;">BESF LLC</h2>
            <p><strong>Receipt #:</strong> ${receiptNumber}</p>
            <p><strong>Date:</strong> ${new Date(q.date).toLocaleDateString()}</p>
            <p><strong>Due Date:</strong> ${new Date(q.validTill).toLocaleDateString()}</p>
            <div style="display: flex; justify-content: space-between;">
              <div style="width:48%">
                <h4>Receipt From</h4>
                <p>
                  ${q.from.name}<br>
                  ${q.from.address}<br>
                  ${q.from.email}<br>
                  ${q.from.phone}<br>
                  <strong>License:</strong> ${q.from.license || 'RBC-2400049'}
                </p>
              </div>
              <div style="width:48%">
                <h4>Receipt To</h4>
                <p>
                  ${q.to.name}<br>
                  ${q.to.address}<br>
                  ${q.to.email}<br>
                  ${q.to.phone}
                </p>
              </div>
            </div>
            <h3 style="margin-top: 30px;">Line Items</h3>
            <table>
              <thead>
                <tr>
                  <th>Item</th><th>Description</th><th>Rate</th><th>Qty</th><th>Total</th>
                </tr>
              </thead>
              <tbody>
                ${groupedLineItemsHTML}
              </tbody>
            </table>
            <div style="margin-top: 20px; text-align: right;">
              <p><strong>Subtotal:</strong> $${parseFloat(q.totals.subtotal).toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
              <p><strong>Discount:</strong> $${parseFloat(q.totals.discount).toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
              <p><strong>Tax:</strong> $${parseFloat(q.totals.tax).toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
              <p><strong style="font-size: 18px;">Total:</strong> 
                <span style="color: #007bff;">$${parseFloat(q.totals.total).toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>
              </p>
            </div>
        </body>
      </html>
    `;

    const iframe = document.createElement('iframe');
    iframe.style.position = 'fixed';
    iframe.style.left = '-9999px';
    document.body.appendChild(iframe);

    const doc = iframe.contentWindow.document;
    doc.open();
    doc.write(styledHTML);
    doc.close();

    await new Promise(resolve => setTimeout(resolve, 300));

    await html2pdf().set({
      margin: 0,
      filename: `Receipt-${receiptNumber}-${clientNameSafe}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, scrollY: 0, backgroundColor: '#ffffff' },
      jsPDF: { unit: 'pt', format: 'letter', orientation: 'portrait' },
      pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    }).from(doc.body).save();

    document.body.removeChild(iframe);
  } catch (err) {
    console.error("PDF download error:", err);
    showToast("Failed to generate or download PDF.");
  } finally {
    hideLoader(); // 👈 END  
  }
}




async function downloadInvoiceAsPDF(id) {
  showLoader();
  try {
    const res = await fetch(`/api/quotes/${id}`);
    const q = await res.json();

    let schedules = [];
    if (q.paymentSchedules && q.paymentSchedules.length > 0) {
      schedules = q.paymentSchedules;
    } else if (q.payments && q.payments.length > 0) {
      schedules = [{
        name: "Default Schedule",
        description: "Imported from legacy payments",
        payments: q.payments
      }];
    }

    // Show the modal to select (even if only one)
    if (schedules.length > 0) {
      hideLoader();
      openScheduleSelectModal(schedules, function(selectedSchedules) {
        downloadInvoiceWithSchedule(q, selectedSchedules);
      });
      return;
    }

    // If no schedules and no payments, proceed with default
    await downloadInvoiceWithSchedule(q, []);
  } catch (err) {
    console.error("PDF download error:", err);
    showToast("Failed to generate or download PDF.");
    hideLoader();
  }
}

// Helper function to generate the invoice PDF with the selected schedule
async function downloadInvoiceWithSchedule(q, selectedPayments) {
  showLoader();
  try {
    const invoiceNumber = `INV-${new Date().getTime()}`;
    const clientNameSafe = q.to.name.replace(/[^a-z0-9]/gi, '_');

    // --- Group and render line items ---
    const grouped = groupLineItemsByCategory(q.lineItems);
    let groupedLineItemsHTML = '';
    Object.keys(grouped).forEach(category => {
      groupedLineItemsHTML += `
        <tr>
          <td colspan="5" style="
            background: #f1f5f9;
            font-weight: 500;
            color: #217dbb;
            font-size: 1.06rem;
            letter-spacing: 0.5px;
            padding: 12px 0 12px 16px;
            margin-top: 8px;
            ">
            ${capitalizeCategory(category)}
          </td>
        </tr>
      `;
      grouped[category].forEach(item => {
        groupedLineItemsHTML += `
          <tr>
            <td>${item.name}</td>
            <td>${item.description}</td>
            <td>$${item.rate.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
            <td>${item.qty}</td>
            <td>$${(item.rate * item.qty).toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
          </tr>
        `;
      });
    });

    // Gather all payments from all schedules
    let allPayments = [];
    if (q.paymentSchedules && q.paymentSchedules.length > 0) {
      q.paymentSchedules.forEach(sch => {
        if (sch.payments && sch.payments.length > 0) {
          allPayments = allPayments.concat(sch.payments.map(p => ({
            ...p,
            scheduleName: sch.name || ""
          })));
        }
      });
    } else if (q.payments && q.payments.length > 0) {
      allPayments = q.payments;
    } else {
      allPayments = [
        { label: "30% at project start", amount: +(q.totals.total * 0.3).toFixed(2), status: "Pending", date: "" },
        { label: "30% at 50% completion", amount: +(q.totals.total * 0.3).toFixed(2), status: "Pending", date: "" },
        { label: "30% at 75% completion", amount: +(q.totals.total * 0.3).toFixed(2), status: "Pending", date: "" },
        { label: "10% at final completion", amount: +(q.totals.total * 0.1).toFixed(2), status: "Pending", date: "" }
      ];
    }

    // Find which payments are selected (by label+amount+date for uniqueness)
    const selectedKeys = (Array.isArray(selectedPayments) ? selectedPayments : []).map(
      p => `${p.label}|${p.amount}|${p.date || ""}`
    );

    // Calculate totalPaid and outstanding using allPayments
    const totalPaid = allPayments
      .filter(p => p.status === "Paid")
      .reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);

    const outstanding = (q.totals && q.totals.total ? q.totals.total : 0) - totalPaid;

    // Payment table with highlight for selected
    const paymentsTable = `
      <h3 style="margin-top: 30px;">Payment Schedule</h3>
      <table style="margin-top: 32px;
            border-radius: 10px;
            overflow: hidden;
            background: #f9fafb;
            box-shadow: 0 1px 4px rgba(14,165,233,0.04);
            width: 100%;
            border-collapse: collapse;
            font-size: 1rem; ">
        <thead>
          <tr style="background:#f1f5f9;">
            <th style="padding:8px; border:1px solid #ddd;">Stage</th>
            <th style="padding:8px; border:1px solid #ddd;">Amount</th>
            <th style="padding:8px; border:1px solid #ddd;">Status</th>
            <th style="padding:8px; border:1px solid #ddd;">Date Paid</th>
          </tr>
        </thead>
        <tbody>
          ${allPayments.map((p, idx) => {
            const key = `${p.label}|${p.amount}|${p.date || ""}`;
            const isSelected = selectedKeys.includes(key);
            return `
              <tr style="${isSelected ? 'background:#fffbe6; font-weight:bold;' : ''}">
                <td style="padding:8px; border:1px solid #ddd;">
                  ${p.label}
                  
                  ${isSelected ? '<span style="color:#f59e0b; font-weight:600; margin-left:8px;">(Due Now)</span>' : ''}
                </td>
                <td style="padding:8px; border:1px solid #ddd;">$${parseFloat(p.amount).toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                <td style="padding:8px; border:1px solid #ddd; color:${p.status === "Paid" ? "#10b981" : (p.status === "Overdue" ? "#ef4444" : "#64748b")}; font-weight:600;">
                  ${p.status}
                </td>
                <td style="padding:8px; border:1px solid #ddd;">${p.status === "Paid" && p.date ? p.date : ""}</td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
      <div style="margin-top:10px; text-align:right;">
        <strong>Total Paid:</strong> $${totalPaid.toLocaleString(undefined, {minimumFractionDigits:2})}<br>
        <strong>Outstanding:</strong> <span style="color:${outstanding > 0 ? '#ef4444' : '#10b981'};">
          $${outstanding.toLocaleString(undefined, {minimumFractionDigits:2})}
        </span>
      </div>
    `;

    // Section for selected payments total or all paid message
    const selectedTotal = (Array.isArray(selectedPayments) ? selectedPayments : []).reduce(
      (sum, p) => sum + (parseFloat(p.amount) || 0), 0
    );

    const selectedSummary = selectedKeys.length > 0 ? `
      <div style="margin-top:8px; color:#f59e0b; font-weight:600;">
        Please make the following payment${selectedKeys.length > 1 ? 's' : ''} totaling: 
        <u>
          $${selectedTotal.toLocaleString(undefined, {minimumFractionDigits:2})}
        </u>
        <br>
        ${selectedPayments.map(p => `${p.label}: $${parseFloat(p.amount).toLocaleString(undefined, {minimumFractionDigits:2})}`).join('<br>')}
      </div>
    ` : `
      <div style="margin-top:8px; color:#10b981; font-weight:600;">
        All scheduled payments have been made. Thank you!
      </div>
    `;

    const styledHTML = `
      <html>
        <head>
          <meta charset="UTF-8">
          <title>Invoice PDF</title>
          <style>
            body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0 auto; padding: 40px; color: #000; font-size: 14px; max-width: 800px; }
            h1, h2, h3, h4 { margin: 0; padding: 0; }
            .company { color: #0ea5e9; font-size: 20px; font-weight: bold; margin-bottom: 8px; }
            .info-grid { display: flex; justify-content: space-between; margin: 20px 0; }
            .info-section { width: 48%; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            thead { background: #f3f4f6; }
            th, td { padding: 8px; text-align: left; border: 1px solid #ddd; }
            .totals { margin-top: 20px; text-align: right; }
            .totals p { margin: 4px 0; }
            .totals strong { color: #0ea5e9; }
            .section { margin-top: 40px; }
            .signature-line { display: flex; gap: 50px; margin-top: 20px; }
            .signature-line p { border-top: 1px solid #333; width: 200px; text-align: center; margin-top: 20px; padding-top: 4px; }
            hr { margin: 30px 0; border: none; border-top: 1px solid #ccc; }
          </style>
        </head>
        <body>
          <div style="font-family: 'Segoe UI', sans-serif; padding: 40px; max-width: 800px; color: #000; font-size: 14px;">
            <h2 style="color:#0ea5e9;">BESF LLC</h2>
            <p><strong>Invoice #:</strong> ${invoiceNumber}</p>
            <p><strong>Date:</strong> ${new Date(q.date).toLocaleDateString()}</p>
            <p><strong>Due Date:</strong> ${new Date(q.validTill).toLocaleDateString()}</p>
            <div style="display: flex; justify-content: space-between;">
              <div style="width:48%">
                <h4>Invoice From</h4>
                <p>
                  ${q.from.name}<br>
                  ${q.from.address}<br>
                  ${q.from.email}<br>
                  ${q.from.phone}<br>
                  <strong>License:</strong> ${q.from.license || 'RBC-2400049'}
                </p>
              </div>
              <div style="width:48%">
                <h4>Invoice To</h4>
                <p>
                  ${q.to.name}<br>
                  ${q.to.address}<br>
                  ${q.to.email}<br>
                  ${q.to.phone}
                </p>
              </div>
            </div>
            <h3 style="margin-top: 30px;">Line Items</h3>
            <table>
              <thead>
                <tr>
                  <th>Item</th><th>Description</th><th>Rate</th><th>Qty</th><th>Total</th>
                </tr>
              </thead>
              <tbody>
                ${groupedLineItemsHTML}
              </tbody>
            </table>
            <div style="margin-top: 20px; text-align: right;">
              <p><strong>Subtotal:</strong> $${parseFloat(q.totals.subtotal).toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
              <p><strong>Discount:</strong> $${parseFloat(q.totals.discount).toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
              <p><strong>Tax:</strong> $${parseFloat(q.totals.tax).toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
              <p><strong style="font-size: 18px;">Total:</strong> 
                <span style="color: #007bff;">$${parseFloat(q.totals.total).toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>
              </p>
            </div>

            ${paymentsTable}

            ${selectedSummary}
 
          </div>
        </body>
      </html>
    `;

    const iframe = document.createElement('iframe');
    iframe.style.position = 'fixed';
    iframe.style.left = '-9999px';
    document.body.appendChild(iframe);

    const doc = iframe.contentWindow.document;
    doc.open();
    doc.write(styledHTML);
    doc.close();

    await new Promise(resolve => setTimeout(resolve, 300));

    await html2pdf().set({
      margin: 0,
      filename: `Invoice-${invoiceNumber}-${clientNameSafe}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, scrollY: 0, backgroundColor: '#ffffff' },
      jsPDF: { unit: 'pt', format: 'letter', orientation: 'portrait' },
      pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    }).from(doc.body).save();

    document.body.removeChild(iframe);
  } catch (err) {
    console.error("PDF download error:", err);
    showToast("Failed to generate or download PDF.");
  } finally {
    hideLoader();
  }
}


function openScheduleSelectModal(schedules, onSelect) {
  const modal = document.getElementById('scheduleSelectModal');
  const body = document.getElementById('scheduleSelectBody');
  modal.style.display = 'flex';

  // Flatten all payments to check if all are paid
  const allPayments = schedules.flatMap(sch => sch.payments || []);
  const unpaidPayments = allPayments.filter(p => p.status !== "Paid");

  if (unpaidPayments.length === 0) {
    body.innerHTML = `
      <div style="padding:32px 0; text-align:center; color:#10b981; font-size:1.2rem;">
        All scheduled payments have been made. Thank you!
      </div>
    `;
    document.getElementById('selectScheduleBtn').onclick = function() {
      closeScheduleSelectModal();
      if (typeof onSelect === 'function') onSelect([]);
    };
    return;
  }

  // Improved styles for payment selection
  body.innerHTML = schedules.map((sch, sIdx) => `
    <div style="
      margin-bottom:22px;
      border:1.5px solid #bae6fd;
      border-radius:14px;
      background: #f0f9ff;
      box-shadow: 0 2px 8px rgba(14,165,233,0.07);
      padding:0;
      overflow:hidden;
    ">
      <div style="
        background: linear-gradient(90deg, #0ea5e9 60%, #38bdf8 100%);
        color: #fff;
        font-weight:700;
        font-size:1.1rem;
        padding: 12px 18px 8px 18px;
        border-bottom: 1px solid #bae6fd;
      ">
        ${sch.name ? sch.name : 'Payment Schedule'}
        ${sch.description ? `<div style="font-size:0.97em; color:#e0f2fe; font-weight:400; margin-top:2px;">${sch.description}</div>` : ''}
      </div>
      <div style="padding: 14px 18px 10px 18px;">
        ${sch.payments.map((p, pIdx) => `
          <label style="
            display:flex;
            align-items:center;
            gap:10px;
            margin-bottom:8px;
            padding:8px 0;
            border-radius:8px;
            cursor:${p.status === "Paid" ? "not-allowed" : "pointer"};
            opacity:${p.status === "Paid" ? "0.6" : "1"};
            transition: background 0.18s;
          " onmouseover="if(this.querySelector('input').disabled!==true)this.style.background='#e0f2fe'" onmouseout="this.style.background='transparent'">
            <input type="checkbox" name="paymentOption" value="${sIdx}_${pIdx}" style="accent-color:#0ea5e9; width:18px; height:18px;" ${p.status === "Paid" ? "disabled" : ""}>
            <span>
              <span style="font-weight:600;">${p.label}</span>
              <span style="color:#0ea5e9; font-weight:600; margin-left:8px;">$${parseFloat(p.amount).toLocaleString(undefined, {minimumFractionDigits:2})}</span>
              ${p.status === "Paid" ? `<span style="color:#10b981; margin-left:8px;">[Paid]</span>` : ""}
              ${p.status === "Overdue" ? `<span style="color:#ef4444; margin-left:8px;">[Overdue]</span>` : ""}
              ${p.date ? `<span style="color:#64748b; margin-left:8px; font-size:0.96em;">${p.date}</span>` : ""}
            </span>
          </label>
        `).join('')}
      </div>
    </div>
  `).join('');

  // Handle selection
  document.getElementById('selectScheduleBtn').onclick = function() {
    const checked = Array.from(document.querySelectorAll('input[name="paymentOption"]:checked'));
    if (checked.length === 0) {
      showToast("Please select at least one unpaid payment.");
      return;
    }
    // Collect selected payments
    const selectedPayments = checked.map(cb => {
      const [sIdx, pIdx] = cb.value.split('_').map(Number);
      return schedules[sIdx].payments[pIdx];
    });
    closeScheduleSelectModal();
    if (typeof onSelect === 'function') onSelect(selectedPayments);
  };
}

function closeScheduleSelectModal() {
  document.getElementById('scheduleSelectModal').style.display = 'none';
}


// ✅ Updated: printQuote()
async function printQuote(id) {
  showLoader(); // 👈 START
  try {
    const res = await fetch(`/api/quotes/${id}`);
    const q = await res.json();

    const total30 = (q.totals.total * 0.30).toLocaleString(undefined, { minimumFractionDigits: 2 });
    const total10 = (q.totals.total * 0.10).toLocaleString(undefined, { minimumFractionDigits: 2 });

    const items = q.lineItems.map(item => `
      <tr>
        <td>${item.name}</td>
        <td>${item.description}</td>
        <td>$${item.rate.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
        <td>${item.qty}</td>
        <td>$${(item.rate * item.qty).toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
      </tr>
    `).join('');

    const html = `
      <html>
      <head>
        <title>Print Quote</title>
        <style>
          body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            margin: 0 auto;
            padding: 40px;
            color: #000;
            font-size: 14px;
            max-width: 800px;
          }
          h1, h2, h3, h4 {
            margin: 0;
            padding: 0;
          }
          .company {
            color: #0ea5e9;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
          }
          .info-grid {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
          }
          .info-section {
            width: 48%;
          }
          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
          }
          thead {
            background: #f3f4f6;
          }
          th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
          }
          .totals {
            margin-top: 20px;
            text-align: right;
          }
          .totals p {
            margin: 4px 0;
          }
          .totals strong {
            color: #0ea5e9;
          }
          .section {
            margin-top: 40px;
          }
          .signature-line {
            display: flex;
            gap: 50px;
            margin-top: 20px;
          }
          .signature-line p {
            border-top: 1px solid #333;
            width: 200px;
            text-align: center;
            margin-top: 20px;
            padding-top: 4px;
          }
          hr {
            margin: 30px 0;
            border: none;
            border-top: 1px solid #ccc;
          }
        </style>
      </head>
      <body>
        <div class="company">BESF LLC</div>

        <div class="info-grid">
          <div class="info-section">
            <p><strong>Quote #:</strong> ${q.quoteNumber}</p>
            <p><strong>Date:</strong> ${new Date(q.date).toLocaleDateString()}</p>
            <p><strong>Valid till:</strong> ${new Date(q.validTill).toLocaleDateString()}</p>
          </div>
        </div>

        <div class="info-grid">
          <div class="info-section">
            <h4>Quote From</h4>
            <p>${q.from.name}<br>${q.from.address}<br>${q.from.email}<br>${q.from.phone}<br><strong>License:</strong> ${q.from.license || 'RBC-2400049'}</p>
          </div>
          <div class="info-section">
            <h4>Quote To</h4>
            <p>${q.to.name}<br>${q.to.address}<br>${q.to.email}<br>${q.to.phone}</p>
          </div>
        </div>

        <h4>Line Items</h4>
        <table>
          <thead>
            <tr>
              <th>Item</th><th>Description</th><th>Rate</th><th>Qty</th><th>Total</th>
            </tr>
          </thead>
          <tbody>${items}</tbody>
        </table>

        <div class="totals">
          <p>Subtotal: $${q.totals.subtotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
          <p>Discount: $${q.totals.discount.toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
          <p>Tax: $${q.totals.tax.toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
          <p><strong>Total: $${q.totals.total.toLocaleString(undefined, { minimumFractionDigits: 2 })}</strong></p>
        </div>

        <div class="section">
          <h4>Notes</h4>
          <p>${q.notes || 'N/A'}</p>
        </div>

        <div class="section">
          <h3>Payment Terms</h3>
          <ul style="margin-top: 10px; padding-left: 20px;">
            <li><strong>30%</strong> at project start: <strong>$${total30}</strong></li>
            <li><strong>30%</strong> at 50% completion: <strong>$${total30}</strong></li>
            <li><strong>30%</strong> at 75% completion: <strong>$${total30}</strong></li>
            <li><strong>10%</strong> at final completion: <strong>$${total10}</strong></li>
          </ul>
          <p>Each payment is due within 7 days of invoice unless otherwise agreed in writing.</p>
        </div>

        <hr>

        <div class="section">
          <h4>Agreement</h4>
          <p>If you accept this quote, please sign and return.</p>

          <div class="signature-line">
            <p>${q.to.name || 'Client Name'}</p>
            <p>Signature</p>
          </div>
        </div>
      </body>
      </html>
    `;

     // ✅ Use hidden iframe to ensure iOS Safari compatibility
     const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    document.body.appendChild(iframe);

    const doc = iframe.contentWindow.document;
    doc.open();
    doc.write(html);
    doc.close();

    // Wait for iframe content to be ready, then print
    iframe.onload = () => {
      iframe.contentWindow.focus();
      iframe.contentWindow.print();

      // Optional: Remove iframe after printing
      setTimeout(() => document.body.removeChild(iframe), 1000);
    };
  } catch (err) {
    console.error('Print error:', err);
    showToast('Unable to print quote.');
  } finally {
    hideLoader(); // 👈 END  
  }
}







// ✅ Updated: shareQuote()
async function shareQuote(id) {
  showLoader(); // 👈 START
  try {
    const res = await fetch(`/api/quotes/${id}`);
    const q = await res.json();

    const total30 = (q.totals.total * 0.30).toLocaleString(undefined, { minimumFractionDigits: 2 });
    const total10 = (q.totals.total * 0.10).toLocaleString(undefined, { minimumFractionDigits: 2 });

    const items = q.lineItems.map(item => `
      <tr>
        <td>${item.name}</td>
        <td>${item.description}</td>
        <td>$${item.rate.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
        <td>${item.qty}</td>
        <td>$${(item.rate * item.qty).toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
      </tr>
    `).join('');

    const html = `
      <html>
      <head>
        <title>Quote #${q.quoteNumber}</title>
        <style>
          body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            margin: 0 auto;
            padding: 40px;
            max-width: 800px;
            color: #000;
            font-size: 14px;
          }

          h1, h2, h3 {
            margin: 0;
            padding: 0;
          }

          .company {
            color: #0ea5e9;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
          }

          .info-grid {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            margin-bottom: 20px;
          }

          .info-section {
            width: 48%;
          }

          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
          }

          thead {
            background: #f3f4f6;
          }

          th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
          }

          .totals {
            margin-top: 20px;
            text-align: right;
          }

          .totals p {
            margin: 4px 0;
          }

          .totals strong {
            color: #0ea5e9;
          }

          .section {
            margin-top: 40px;
          }

          .signature-line {
            display: flex;
            gap: 50px;
            margin-top: 20px;
          }

          .signature-line p {
            border-top: 1px solid #333;
            width: 200px;
            text-align: center;
            padding-top: 4px;
          }

          hr {
            margin: 30px 0;
            border: none;
            border-top: 1px solid #ccc;
          }
        </style>
      </head>
      <body>
        <div class="company">BESF LLC</div>

        <div class="info-grid">
          <div class="info-section">
            <p><strong>Quote #:</strong> ${q.quoteNumber}</p>
            <p><strong>Date:</strong> ${new Date(q.date).toLocaleDateString()}</p>
            <p><strong>Valid till:</strong> ${new Date(q.validTill).toLocaleDateString()}</p>
          </div>
        </div>

        <div class="info-grid">
          <div class="info-section">
            <h4>Quote From</h4>
            <p>${q.from.name}<br>${q.from.address}<br>${q.from.email}<br>${q.from.phone}<br><strong>License:</strong> ${q.from.license || 'RBC-2400049'}</p>
          </div>
          <div class="info-section">
            <h4>Quote To</h4>
            <p>${q.to.name}<br>${q.to.address}<br>${q.to.email}<br>${q.to.phone}</p>
          </div>
        </div>

        <h4>Line Items</h4>
        <table>
          <thead>
            <tr>
              <th>Item</th><th>Description</th><th>Rate</th><th>Qty</th><th>Total</th>
            </tr>
          </thead>
          <tbody>${items}</tbody>
        </table>

        <div class="totals">
          <p>Subtotal: $${q.totals.subtotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
          <p>Discount: $${q.totals.discount.toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
          <p>Tax: $${q.totals.tax.toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
          <p><strong>Total: $${q.totals.total.toLocaleString(undefined, { minimumFractionDigits: 2 })}</strong></p>
        </div>

        <div class="section">
          <h4>Notes</h4>
          <p>${q.notes || 'N/A'}</p>
        </div>

        <div class="payment-terms">
          <h3>Payment Terms</h3>
          <ul style="margin-top: 10px; padding-left: 20px;">
            <li><strong>30%</strong> at project start: <strong>$${total30}</strong></li>
            <li><strong>30%</strong> at 50% completion: <strong>$${total30}</strong></li>
            <li><strong>30%</strong> at 75% completion: <strong>$${total30}</strong></li>
            <li><strong>10%</strong> at final completion: <strong>$${total10}</strong></li>
          </ul>
          <p style="margin-top: 10px;">Each payment is due within 7 days of invoice unless otherwise agreed in writing. Late payments may be subject to additional fees.</p>
        </div>

        <hr>

        <div class="section">
          <h4>Agreement</h4>
          <p>If you accept this quote, please sign and return.</p>
          <div class="signature-line">
            <p>${q.to.name || 'Client Name'}</p>
            <p>Date</p>
          </div>
        </div>
      </body>
      </html>
    `;

    const blob = new Blob([html], { type: 'text/html' });
    const file = new File([blob], `quote-${q.quoteNumber}.html`, { type: 'text/html' });

    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({
        title: `Quote #${q.quoteNumber}`,
        text: 'Sharing a quote with you.',
        files: [file]
      });
    } else {
      showToast('Sharing is not supported on this device.');
    }
  } catch (err) {
    console.error('Error sharing quote:', err);
    showToast('Failed to share quote.');
  } finally {
    hideLoader(); // 👈 END 
  }
}







    async function deleteQuote(id) {
      if (!confirm('Are you sure you want to delete this quote?')) return;
      showLoader(); // 👈 START
      try {
        const res = await fetch(`/api/quotes/${id}`, { method: 'DELETE' });
        if (res.ok) {
          showToast('Quote deleted successfully.');
          fetchQuotes();
        } else {
          showToast('Failed to delete quote.');
        }
      } catch (err) {
        console.error('Error deleting quote:', err);
      } finally {
        hideLoader(); // 👈 END 
      }
    }

    fetchQuotes();



    async function exportQuoteToExcel(id) {
      showLoader(); // 👈 START   
  try {
    const res = await fetch(`/api/quotes/${id}`);
    const q = await res.json();

    if (!q || !q._id || !q.lineItems || q.lineItems.length === 0) {
      showToast('No line items to export.');
      return;
    }

    // Prepare flattened line items
    const rows = q.lineItems.map(item => ({
      "Category": item.category || "",     // Assumes item.category exists
      "Name": item.name || "",
      "Description": item.description || "",
      "Quantity": item.qty || 0,
      "Unit Price": item.rate || 0
    }));

    // Convert to Excel sheet
    const worksheet = XLSX.utils.json_to_sheet(rows);

    // Create workbook and download
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Line Items");

    const fileName = `Quote-${q.quoteNumber}-LineItems.xlsx`;
    XLSX.writeFile(workbook, fileName);
  } catch (err) {
    console.error("❌ Export failed:", err);
    showToast("Failed to export line items.");
  } finally {
    hideLoader(); // 👈 END  
  }
}



async function convertToJob(quoteId) {
  if (!confirm("Are you sure you want to convert this quote to a job?")) return;
  showLoader(); // 👈 START
  try {
    const res = await fetch(`/api/quotes/${quoteId}/convert-to-job`, {
      method: "POST"
    });
    const result = await res.json();

    if (result.success && result.redirectUrl) {
      // ✅ Automatically redirect to project detail page
      window.location.href = result.redirectUrl;
    } else {
      alert("Conversion failed.");
    }
  } catch (err) {
    console.error('Error:', err);
    alert("An error occurred while converting the quote.");
  } finally {
    hideLoader(); // 👈 END
  }
}


async function openPaymentsModal(quoteId) {
  showLoader();
  try {
    const res = await fetch(`/api/quotes/${quoteId}`);
    const q = await res.json();

    if (q.status !== "Approved") {
      showToast("You can only manage payments for approved quotes.");
      hideLoader();
      return;
    }

    // Default schedule if not present
const total = q.totals && q.totals.total ? q.totals.total : 0;
let schedule = (q.payments && q.payments.length > 0)
  ? q.payments
  : [
      { label: "30% at project start", amount: +(total * 0.3).toFixed(2), status: "Pending", date: "" },
      { label: "30% at 50% completion", amount: +(total * 0.3).toFixed(2), status: "Pending", date: "" },
      { label: "30% at 75% completion", amount: +(total * 0.3).toFixed(2), status: "Pending", date: "" },
      { label: "10% at final completion", amount: +(total * 0.1).toFixed(2), status: "Pending", date: "" }
    ];

const totalPaid = schedule
  .filter(p => p.status === "Paid")
  .reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
const outstanding = total - totalPaid;

    // Render form
document.getElementById('paymentsModalBody').innerHTML = `
  <div id="paymentSummary" style="margin-bottom:16px;">
    <strong>Total:</strong> $${total.toLocaleString(undefined, {minimumFractionDigits:2})}<br>
    <strong>Paid:</strong> $${totalPaid.toLocaleString(undefined, {minimumFractionDigits:2})}<br>
    <strong>Outstanding:</strong> <span style="color:${outstanding > 0 ? '#ef4444' : '#10b981'};">
      $${outstanding.toLocaleString(undefined, {minimumFractionDigits:2})}
    </span>
  </div>
  <form id="paymentsForm">
    ${schedule.map((p, i) => `
      <div style="margin-bottom:12px;">
        <label><strong>${p.label}</strong></label><br>
        <input
          type="number"
          name="amount${i}"
          value="${p.amount}"
          min="0"
          step="0.01"
          style="width:110px; margin-right:8px;"
          placeholder="Amount"
        />
        <select name="status${i}">
          <option value="Pending" ${p.status === "Pending" ? "selected" : ""}>Pending</option>
          <option value="Paid" ${p.status === "Paid" ? "selected" : ""}>Paid</option>
          <option value="Overdue" ${p.status === "Overdue" ? "selected" : ""}>Overdue</option>
        </select>
        <input type="date" name="date${i}" value="${p.date || ""}" style="margin-left:8px;">
      </div>
    `).join('')}
  </form>
`;

const form = document.getElementById('paymentsForm');
form.addEventListener('input', updatePaymentSummary);

function updatePaymentSummary() {
  const form = document.getElementById('paymentsForm');
  let paid = 0;
  schedule.forEach((p, i) => {
    if (form[`status${i}`].value === "Paid") {
      paid += parseFloat(form[`amount${i}`].value) || 0;
    }
  });
  const outstanding = total - paid;
  document.getElementById('paymentSummary').innerHTML = `
    <strong>Total:</strong> $${total.toLocaleString(undefined, {minimumFractionDigits:2})}<br>
    <strong>Paid:</strong> $${paid.toLocaleString(undefined, {minimumFractionDigits:2})}<br>
    <strong>Outstanding:</strong> <span style="color:${outstanding > 0 ? '#ef4444' : '#10b981'};">
      $${outstanding.toLocaleString(undefined, {minimumFractionDigits:2})}
    </span>
  `;
}
    document.getElementById('paymentsModal').style.display = 'flex';

document.getElementById('savePaymentsBtn').onclick = async function() {
  const form = document.getElementById('paymentsForm');
const newSchedule = schedule.map((p, i) => ({
  ...p,
  amount: parseFloat(form[`amount${i}`].value) || 0,
  status: form[`status${i}`].value,
  date: form[`date${i}`].value
}));

  showLoader();
  try {
    const updateRes = await fetch(`/api/quotes/${quoteId}/payments`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ payments: newSchedule })
    });
    if (updateRes.ok) {
      showToast('Payments updated.');
      
      fetchQuotes();
    } else {
      showToast('Failed to update payments.');
    }
  } catch (err) {
    showToast('Error updating payments.');
  } finally {
    hideLoader();
  }
};
  } catch (err) {
     console.error('Failed to load payments:', err);
    showToast('Failed to load payments.');
  } finally {
    hideLoader();
  }
}

function closePaymentsModal() {
  document.getElementById('paymentsModal').style.display = 'none';
}



  </script>
</body>
</html>
