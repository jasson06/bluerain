<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Construction Project Schedule</title>
  <!-- Include Chart.js for Dashboard Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- ✅ Use this for version 0.6.1 (stable) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">
<script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
  
  <style>
    /* Top Bar with Header and Action Buttons */
    .top-bar {
      width: 100%;
      max-width: 1200px;
      background: linear-gradient(90deg, #007bff, #009dff);
      color: #fff;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .top-bar h1 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .top-bar .action-buttons {
      display: flex;
      gap: 10px;
    }
    .top-bar .action-buttons button {
      padding: 8px 15px;
      font-size: 0.9rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: #696a69;
      color: #fff;
      transition: background-color 0.3s ease;
    }
    .top-bar .action-buttons button:hover {
      background-color: #4b4b4d;
    }
    
    /* Global Light Theme with Modern Effects */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #f8f9fa;
      color: #343a40;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    /* Notification Styles */
    #notification {
      padding: 10px 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      display: none;
      width: 90%;
      max-width: 1200px;
      text-align: center;
      font-size: 0.95rem;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    #notification.success {
      background-color: #d4edda;
      color: #155724;
    }
    #notification.error {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    /* Form & Filter Styles */
    .task-form,
    #listViewFilters {
      width: 96%;
      max-width: 1200px;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .task-form input, .task-form select,
    #listViewFilters input, #listViewFilters select {
      margin-right: 10px;
      margin-bottom: 10px;
      padding: 8px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      background: #fff;
      color: #343a40;
      outline: none;
      transition: border-color 0.3s;
    }
    .task-form input:focus, .task-form select:focus,
    #listViewFilters input:focus, #listViewFilters select:focus {
      border-color: #007bff;
    }
    
    /* Modern Date Input Styles */
    input[type="date"] {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 8px;
      font-size: 1rem;
      color: #343a40;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      outline: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    input[type="date"]:focus {
      border-color: #007bff;
      box-shadow: 0 0 5px rgba(0,123,255,0.5);
    }
    
    /* Style for table select elements */
    table select {
      padding: 8px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      background: #fff;
      color: #343a40;
      transition: border-color 0.3s;
      outline: none;
    }
    table select:focus {
      border-color: #007bff;
    }
    
    .task-form button, .view-buttons button, #calendarNav button {
      padding: 10px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: #fff;
      background-color: #007bff;
      transition: background-color 0.3s ease, transform 0.2s;
    }
    .task-form button:hover, .view-buttons button:hover, #calendarNav button:hover {
      background-color: #0056b3;
      transform: translateY(-1px);
    }

    #estimateSelector {
  padding: 8px 12px;
  font-size: 1rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  background-color: #fff;
  color: #333;
  margin-right: 10px;
  margin-bottom: 10px;
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
  appearance: none; /* Optional: removes default browser styles */
}

#estimateSelector:hover {
  border-color: #888;
}

#estimateSelector:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 5px rgba(0, 123, 255, 0.4);
}

    
    /* View Buttons */
    .view-buttons {
      margin-bottom: 20px;
      width: 90%;
      max-width: 1200px;
      text-align: center;
    }
    .view-buttons button {
      margin-right: 10px;
    }
    
    /* Table Styles */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background-color: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 15px;
      text-align: left;
    }
    th {
      background-color: #007bff;
      color: #fff;
      font-weight: 500;
      cursor: pointer;
      position: relative;
    }
    th .sort-indicator {
      margin-left: 5px;
      font-size: 0.8rem;
    }
    td {
      border-bottom: 1px solid #a8b1ce;
    }
    tr:nth-child(even) {
      background-color: #f7f7f7;
    }
    tr:hover {
      background-color: #eeefef !important;
    }
       /* Overdue style: turns red if task is overdue and not completed */
       .overdue {
      background-color: #fbe9e9 !important;
    }
    
    /* Status label classes for grid view */
    .status-label {
      padding: 8px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      background: #fff;
      color: #343a40;
      display: inline-block;
      transition: border-color 0.3s;
    }
    .status-label.in-progress {
      background-color: #cea624;
      color: #fffefd;
    }
    .status-label.completed {
      background-color: #068424;
      color: #ffffff;
    }
    
    /* Grid View Styles */
    .grid-container {
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-start;
  gap: 20px;
  padding: 20px;
}

.grid-item {
  flex: 1 1 calc(33.333% - 40px);
  min-width: 280px;
  max-width: 100%;
  background: linear-gradient(145deg, #ffffff, #f8f8f8);
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  padding: 20px;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  position: relative;
  cursor: pointer;
  border-left: 5px solid transparent;
}

.grid-item:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
}

.grid-item h3 {
  margin-top: 0;
  font-size: 1.2rem;
  color: #333;
}

.grid-item .grid-details {
  margin-top: 10px;
  font-size: 0.95rem;
  color: #555;
}

.status-label {
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 0.85rem;
  display: inline-block;
  background: #ccc;
  color: #fff;
}

/* Dynamic status colors */
.grid-item.in-progress {
  border-left-color: #f0ad4e;
}

.grid-item.completed {
  border-left-color: #5cb85c;
}

.grid-item.overdue {
  border-left-color: #d9534f;
}

.grid-item .status-label.in-progress {
  background: #d8a91a;
}

.grid-item .status-label.completed {
  background: #0b8f2d;
}

.grid-item .status-label.overdue {
  background: #d9534f;
}


    
    /* Calendar View Styles */
    #calendarNav {
      margin-bottom: 10px;
      width: 90%;
      max-width: 1200px;
      text-align: center;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      width: 90%;
      max-width: 1200px;
      margin-bottom: 20px;
    }
    .calendar-date {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .calendar-date:hover {
      background-color: #e6f2ff;
    }
    .calendar-date span.task {
      display: block;
      font-size: 0.75rem;
      margin-top: 5px;
      background: #007bff;
      color: #fff;
      border-radius: 3px;
      padding: 2px 4px;
    }

    
    /* Dashboard Canvas Sizing */
    #statusChart, #timelineChart {
      width: 100% !important;
      height: 300px !important;
    }

    #dashboardView canvas {
  background-color: #fff;
  border-radius: 10px;
  padding: 20px;
}

.completion-banner {
  font-size: 1.1rem;
  text-align: center;
  background: linear-gradient(to right, #007bff, #00c6ff);
  color: white;
  padding: 10px;
  border-radius: 10px;
  margin: 15px auto;
  font-weight: 600;
  max-width: 95%;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

.dashboard-stats {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 15px;
  margin: 20px auto;
  max-width: 95%;
}

.stat-card {
  background: #fff;
  padding: 10px 16px;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  text-align: center;
  flex: 1 1 100px;
  max-width: 150px;
  min-width: 100px;
}

.stat-card strong {
  font-size: 1.3rem;
  display: block;
  margin-bottom: 4px;
}

.stat-card span {
  font-size: 0.85rem;
  color: #555;
}


/* Responsive Chart Containers */
#statusChart,
#timelineChart {
  width: 100% !important;
  height: auto !important;
  max-width: 500px;
  margin: 0 auto 30px;
}

/* Responsive Chart Canvas */
canvas {
  width: 100% !important;
  height: auto !important;
}


    
    /* Modal Styles */
    #modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    #modal .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      position: relative;
      box-shadow: 0 2px 12px rgba(0,0,0,0.2);
      color: #343a40;
    }
    #modal .modal-content input, 
    #modal .modal-content select, 
    #modal .modal-content textarea {
      width: 100%;
      padding: 8px;
      margin: 5px 0 15px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      background: #f8f9fa;
      color: #343a40;
      font-size: 1rem;
    }
    #modal .modal-content button {
      padding: 10px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: #007bff;
      color: #fff;
      transition: background-color 0.3s ease;
    }
    #modal .modal-content button:hover {
      background-color: #0056b3;
    }
    #modal .close {
      position: absolute;
      right: 15px;
      top: 15px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #007bff;
    }
    
    /* Pagination Styles */
    #paginationControls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 15px;
    }
    #paginationControls button {
      background-color: #007bff;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #paginationControls button:hover {
      background-color: #0056b3;
    }
    #paginationControls span {
      font-size: 1rem;
      font-weight: 500;
      color: #343a40;
    }
    
    /* Inline Comment Textarea in Table */
    table textarea {
      resize: vertical;
      padding: 8px;
      font-size: 0.9rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      background: #fff;
      color: #343a40;
      width: 90%;
      transition: border-color 0.3s;
    }
    table textarea:focus {
      border-color: #007bff;
      box-shadow: 0 0 5px rgba(0,123,255,0.5);
    }
    
    /* Responsive Table Card Layout for Mobile */
    @media (max-width: 768px) {
      #scheduleTable thead { display: none; }
      #scheduleTable tr {
        display: block;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      }
      #scheduleTable td {
        display: block;
        text-align: right;
        font-size: 0.9rem;
        border: none;
        position: relative;
        padding-left: 45%;
        margin-bottom: 5px;
      }
      #scheduleTable td::before {
        content: attr(data-label);
        position: absolute;
        left: 15px;
        width: 40%;
        text-align: left;
        font-weight: bold;
        color: #007bff;
      }
    }
    /* Additional Responsive Breakpoints for Grid and Calendar */
    @media (max-width: 768px) {
      .grid-item {
        width: 100%;
        max-width: 600px;
      }
      .calendar {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    @media (max-width: 480px) {
      .calendar {
        grid-template-columns: 1fr;
      }
    }
    
    /* Mobile adjustments for view buttons */
    @media (max-width: 768px) {
      .view-buttons {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
      }
      .view-buttons button {
        flex: 1 1 45%;
        max-width: 45%;
      }
    }
    @media (max-width: 480px) {
      .view-buttons button {
        flex: 1 1 100%;
        max-width: 100%;
      }
    }


/* Wrapper for the entire Gantt view */
#ganttView {
  width: 100%;
  min-height: 600px;
  max-height: 1000px;
  padding: 10px;
  overflow: auto;
  background: #ffffff;
  border-radius: 8px;
  box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
  position: relative;
}

/* The actual Gantt chart container */
#frappeGanttChart {
  overflow-x: auto;
  white-space: nowrap;
}

/* Ensure the SVG inside can scroll horizontally if needed */
.gantt-container,
.gantt-target {
  min-width: 1000px;
}



.gantt .bar[class*="category-"] {
  stroke: #1f2937 !important;
  rx: 4;
  ry: 4;
}

.gantt .bar-wrapper.category-bathroom .bar { fill: #f97316 !important; }
.gantt .bar-wrapper.category-bedroom-1 .bar,
.gantt .bar-wrapper.category-bedroom-2 .bar { fill: #dd6915 !important; }
.gantt .bar-wrapper.category-bedroom-3 .bar { fill: #ac500d !important; }
.gantt .bar-wrapper.category-bedroom-4 .bar { fill: #af4900 !important; }
.gantt .bar-wrapper.category-bathroom-1 .bar { fill: #ef1af3 !important; }
.gantt .bar-wrapper.category-bathroom-2 .bar { fill: #d415d7 !important; }
.gantt .bar-wrapper.category-bathroom-3 .bar { fill: #ef1af3 !important; }
.gantt .bar-wrapper.category-bathroom-4 .bar { fill: #ef1af3 !important; }
.gantt .bar-wrapper.category-main-bathroom .bar { fill: #f90db2 !important; }
.gantt .bar-wrapper.category-closet .bar { fill: #eab308 !important; }
.gantt .bar-wrapper.category-dining-room .bar { fill: #ec4899 !important; }
.gantt .bar-wrapper.category-exterior-overall .bar { fill: #3b82f6 !important; }
.gantt .bar-wrapper.category-roof .bar { fill: #025ff5 !important; }
.gantt .bar-wrapper.category-general .bar { fill: #6b7280 !important; }
.gantt .bar-wrapper.category-interior-overall .bar { fill: #a855f7 !important; }
.gantt .bar-wrapper.category-kitchen .bar { fill: #10b981 !important; }
.gantt .bar-wrapper.category-Dining .bar { fill: #07f9dc !important; }
.gantt .bar-wrapper.category-laundry .bar { fill: #0ea5e9 !important; }
.gantt .bar-wrapper.category-living-room .bar { fill: #facc15 !important; }
gantt .bar-wrapper.category-hallway .bar { fill: #00c7c4 !important; }
.gantt .bar-wrapper.category-default .bar { fill: #9ca3af !important; }


/* --- Labels and progress --- */
.gantt .bar-progress { fill: rgba(2, 2, 2, 0.3) !important; }
.gantt .bar-label { fill: rgb(34, 33, 33) !important; font-weight: bold; font-size: 12px;}



    
  </style>
</head>
<body>
  <!-- Top Bar with Header and Action Buttons -->
  <header class="top-bar">
    <h1>CONSTRUCTION PROJECT SCHEDULE</h1>
    <div class="action-buttons">
      <button id="printBtn">Print</button>
      <button id="exportBtn">Export CSV</button>
    </div>
  </header>
  
  <!-- View Buttons -->
  <div class="view-buttons">
    <button id="dashboardViewBtn">Dashboard</button>
    <button id="listViewBtn">List View</button>
    <button id="gridViewBtn">Grid View</button>
    <button id="calendarViewBtn">Calendar View</button>
    <button id="ganttViewBtn">Gantt Chart View</button>
  </div>
  
  <!-- Dashboard View -->
  <div id="dashboardView" class="view" style="display: none;">
    <!-- Projected Completion Date Display -->
    <div id="projectedCompletionDate" style="text-align:center; font-size:1.2rem; margin-bottom:15px;"></div>
    <div style="width:90%; max-width:1200px; margin-bottom:20px;">
      <canvas id="statusChart"></canvas>
    </div>
    <div style="width:90%; max-width:1200px;">
      <canvas id="timelineChart"></canvas>
    </div>
  </div>
  
  <select id="estimateSelector">
    <option value="">Select Estimate</option>
  </select>
  

  <!-- List View with Filters -->
  <div id="listView" class="view">
    <div id="listViewFilters">
      <input type="text" id="listSearch" placeholder="Search by Task Name" />
      <select id="statusFilter">
        <option value="">All Status</option>
        <option value="in-progress">In Progress</option>
        <option value="completed">Completed</option>
      </select>
      <input type="text" id="categoryFilter" placeholder="Filter by Category" />
      <input type="date" id="startDateFrom" />
      <input type="date" id="startDateTo" />
    </div>
    <div style="overflow-x: auto; width: 100%; max-width: 1200px;">
      <table id="scheduleTable">
        <thead>
          <tr>
            <th data-sort="category">Category<span class="sort-indicator"></span></th>
            <th data-sort="name">Task<span class="sort-indicator"></span></th>
            <th data-sort="startDate">Start Date<span class="sort-indicator"></span></th>
            <th data-sort="endDate">End Date<span class="sort-indicator"></span></th>
            <th data-sort="status">Status<span class="sort-indicator"></span></th>
            <th>Comments</th>
          </tr>
        </thead>
        <tbody>
          <!-- Rows populated by JavaScript -->
        </tbody>
      </table>
      <!-- Pagination Controls -->
      <div id="paginationControls">
        <button id="prevPageBtn">Prev</button>
        <span id="pageIndicator"></span>
        <button id="nextPageBtn">Next</button>
      </div>
    </div>
  </div>
  
  <!-- Grid View -->
  <div id="gridView" class="view" style="display: none;">
    <div class="grid-container">
      <!-- Grid items populated by JavaScript -->
    </div>
  </div>
  
  <!-- Calendar View -->
  <div id="calendarView" class="view" style="display: none;">
    <div id="calendarNav">
      <button id="prevMonthBtn">Prev Month</button>
      <span id="currentMonthYear"></span>
      <button id="nextMonthBtn">Next Month</button>
    </div>
    <div class="calendar">
      <!-- Calendar dates populated by JavaScript -->
    </div>
  </div>
  
  <!-- Gantt Chart View -->
  <div id="ganttView" class="gantt-chart-container">
    <div style="margin-bottom: 10px;">
      <label for="ganttMode"><strong>View Mode:</strong></label>
      <select id="ganttMode">
        <option value="Day">Day</option>
        <option value="Week">Week</option>
        <option value="Month">Month</option>
      </select>
    </div>
    <div id="frappeGanttChart" style="min-height: 600px; background: #fff;"></div>

  </div>
  
  
  <!-- Modal for Editing/View Details -->
  <div id="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="modalBody">
        <!-- Dynamic modal content -->
      </div>
    </div>
  </div>
  
  <!-- Notification Area (ensure it exists) -->
  <div id="notification"></div>
  
   <script>
    let currentView = "listView"; // default view

    // Helper functions for status styling
    function getStatusStyle(status) {
      if (status === "in-progress") {
        return "background-color: #cea624; color: #fff; padding: -1px 5px; border-radius: 4px;";
      } else if (status === "completed") {
        return "background-color:#068424; color: #fff; padding: -1px 5px; border-radius: 4px;";
      }
      return "";
    }
    
    function updateStatusDropdownStyle(selectElement) {
      selectElement.style.cssText = getStatusStyle(selectElement.value);
    }
    
    // Helper for grid view: return CSS class based on status (if needed)
    function getStatusClass(status) {
      if (status === "in-progress") return "in-progress";
      if (status === "completed") return "completed";
      return "";
    }
    
    document.addEventListener("DOMContentLoaded", async function() {
      /* --------------------- Utility Functions --------------------- */
      function showNotification(message, type = "success") {
        const notification = document.getElementById("notification");
        if (!notification) return;
        notification.textContent = message;
        notification.className = type;
        notification.style.display = "block";
        setTimeout(() => {
          notification.style.display = "none";
        }, 3000);
      }
      
      function debounce(func, delay) {
        let timer;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => func.apply(this, args), delay);
        };
      }
      
      /* --------------------- Modal Functions --------------------- */
      const modal = document.getElementById("modal");
      const modalBody = document.getElementById("modalBody");
      const closeModalBtn = modal.querySelector(".close");
      
      function openModal(contentHTML) {
        modalBody.innerHTML = contentHTML;
        modal.style.display = "flex";
        const modalStatusSelect = document.getElementById("editStatus");
        if (modalStatusSelect) {
          updateStatusDropdownStyle(modalStatusSelect);
          modalStatusSelect.addEventListener("change", function() {
            updateStatusDropdownStyle(modalStatusSelect);
          });
        }
      }
      
      function closeModal() {
        modal.style.display = "none";
      }
      
      closeModalBtn.addEventListener("click", closeModal);
      window.addEventListener("click", function(e) {
        if (e.target === modal) closeModal();
      });
      
      /* --------------------- API Functions --------------------- */
      async function getCurrentProjectId() {
        try {
          let projectId = localStorage.getItem("currentProjectId");
          if (!projectId) {
            const response = await fetch('/api/projects/current');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            projectId = data.projectId;
            localStorage.setItem("currentProjectId", projectId);
          }
          return projectId;
        } catch (error) {
          console.error("Error fetching project ID:", error);
          showNotification("Error fetching project ID", "error");
          return null;
        }
      }


      
 async function fetchLineItems(projectId) {
  try {
    const response = await fetch(`/api/estimates/${projectId}/line-items`);
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const estimates = await response.json();
    return Array.isArray(estimates) ? estimates : [];
  } catch (error) {
    console.error("Error fetching estimates:", error);
    showNotification("Error fetching estimates", "error");
    return [];
  }
}

function populateEstimateDropdown(estimates) {
  const estimateSelector = document.getElementById("estimateSelector");
  estimateSelector.innerHTML = `<option value="all">All Estimates</option>`;

  estimates.forEach((estimate, index) => {
    const option = document.createElement("option");
    option.value = index;
    option.textContent = estimate.title || `Estimate ${index + 1}`;
    estimateSelector.appendChild(option);
  });

  estimateSelector.addEventListener("change", () => {
    const selectedValue = estimateSelector.value;

    selectedLineItems =
      selectedValue === "all"
        ? estimates.flatMap(est => est.lineItems || [])
        : (estimates[parseInt(selectedValue)]?.lineItems || []);

    // ✅ Render the appropriate view based on the current view
    if (currentView === "listView") {
      renderTable(selectedLineItems);
    } else if (currentView === "gridView") {
      renderGridView(selectedLineItems);
    } else if (currentView === "calendarView") {
      renderCalendarView(selectedLineItems);
    } else if (currentView === "ganttView") {
      renderGanttChartView(selectedLineItems, ganttViewMode);
    } else if (currentView === "dashboardView") {
      renderDashboardView(selectedLineItems);
    }
  });
}





      
      async function updateLineItem(lineItemId, updates) {
        try {
          const response = await fetch(`/api/estimates/line-items/${lineItemId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updates),
          });
          if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
          showNotification("Task updated successfully");
          return await response.json();
        } catch (error) {
          console.error("Error updating task:", error);
          showNotification("Error updating task", "error");
        }
      }
      
      /* --------------------- Data & State --------------------- */
      let selectedLineItems = [];
      let currentLineItems = [];
      let flatTasks = [];
      let filteredTasks = [];
      let sortField = "name";
      let sortDirection = "asc";
      let currentPage = 1;
      const itemsPerPage = 10;
      
      let currentCalendarDate = new Date();
      let gridTasksOrder = null;
      
      // Attach category to each task.
      function getAllTasks(lineItems) {
        if (lineItems.length && lineItems[0].items) {
          return lineItems.reduce((acc, categoryGroup) => {
            const tasksWithCategory = categoryGroup.items.map(task => ({
              ...task,
              category: categoryGroup.category || "Uncategorized"
            }));
            return acc.concat(tasksWithCategory);
          }, []);
        } else {
          return lineItems.map(task => ({
            ...task,
            category: task.category || "Uncategorized"
          }));
        }
      }
      

      
      /* --------------------- Render Functions --------------------- */
      function renderTable() {
  flatTasks = getAllTasks(selectedLineItems);

  const searchQuery = document.getElementById("listSearch").value.toLowerCase();
  const statusFilter = document.getElementById("statusFilter").value;
  const categoryFilter = document.getElementById("categoryFilter").value.toLowerCase();
  const startDateFrom = document.getElementById("startDateFrom").value;
  const startDateTo = document.getElementById("startDateTo").value;

  filteredTasks = flatTasks.filter(task => {
    if (!task || typeof task.name !== "string") return false; // 🛡️ Safeguard

    const matchesSearch = (task.name || "").toLowerCase().includes(searchQuery);
    const matchesStatus = statusFilter ? (task.status || "") === statusFilter : true;
    const matchesCategory = categoryFilter ? (task.category || "").toLowerCase().includes(categoryFilter) : true;
    
    let matchesStartDate = true;
    if (startDateFrom) {
      matchesStartDate = task.startDate && new Date(task.startDate) >= new Date(startDateFrom);
    }
    if (matchesStartDate && startDateTo) {
      matchesStartDate = task.startDate && new Date(task.startDate) <= new Date(startDateTo);
    }

    return matchesSearch && matchesStatus && matchesCategory && matchesStartDate;
  });

  filteredTasks.sort((a, b) => {
    let valA = a[sortField] || "";
    let valB = b[sortField] || "";
    if (sortField.includes("Date")) {
      valA = new Date(valA);
      valB = new Date(valB);
    }
    if (valA < valB) return sortDirection === "asc" ? -1 : 1;
    if (valA > valB) return sortDirection === "asc" ? 1 : -1;
    return 0;
  });

  const totalPages = Math.ceil(filteredTasks.length / itemsPerPage);
  if (currentPage > totalPages) currentPage = totalPages || 1; // 🛡️ Avoid 0 pages
  const startIdx = (currentPage - 1) * itemsPerPage;
  const paginatedTasks = filteredTasks.slice(startIdx, startIdx + itemsPerPage);

  document.getElementById("pageIndicator").textContent = `Page ${currentPage} of ${totalPages || 1}`;

  const tbody = document.querySelector("#scheduleTable tbody");
  tbody.innerHTML = "";
  paginatedTasks.forEach(task => {
    const row = document.createElement("tr");
    row.className = (task.status || "").toLowerCase().replace(" ", "-");

    if (task.endDate && new Date() > new Date(task.endDate) && task.status !== "completed") {
      row.classList.add("overdue");
    }

    const categoryCell = document.createElement("td");
    categoryCell.textContent = task.category || "Uncategorized";
    categoryCell.setAttribute("data-label", "Category");
    row.appendChild(categoryCell);

    const nameCell = document.createElement("td");
    nameCell.textContent = task.name;
    nameCell.style.cursor = "pointer";
    nameCell.setAttribute("data-label", "Task");
    nameCell.addEventListener("click", () => {
      const modalContent = `
        <h2>Edit Task</h2>
        <label>Task Name: <input type="text" id="editName" value="${task.name}" readonly /></label><br/><br/>
        <label>Start Date: <input type="date" id="editStart" value="${task.startDate ? new Date(task.startDate).toISOString().split("T")[0] : ''}" /></label><br/><br/>
        <label>End Date: <input type="date" id="editEnd" value="${task.endDate ? new Date(task.endDate).toISOString().split("T")[0] : ''}" /></label><br/><br/>
        <label>Status: 
          <select id="editStatus">
            <option value="in-progress" ${task.status==="in-progress"?"selected":""}>In Progress</option>
            <option value="completed" ${task.status==="completed"?"selected":""}>Completed</option>
          </select>
        </label><br/><br/>
        <label>Comments: <textarea id="editComments">${task.description || ''}</textarea></label><br/><br/>
        <button id="saveEditBtn">Save</button>
      `;
      openModal(modalContent);
      document.getElementById("saveEditBtn").addEventListener("click", async function() {
        const updatedTask = {
          name: task.name,
          startDate: document.getElementById("editStart").value,
          endDate: document.getElementById("editEnd").value,
          status: document.getElementById("editStatus").value,
          description: document.getElementById("editComments").value
        };
        await updateLineItem(task._id, updatedTask);
        closeModal();
        loadView("listView");
      });
    });
    row.appendChild(nameCell);

    const startCell = document.createElement("td");
    startCell.setAttribute("data-label", "Start Date");
    const startInput = document.createElement("input");
    startInput.type = "date";
    startInput.value = task.startDate ? new Date(task.startDate).toISOString().split("T")[0] : "";
    startInput.addEventListener("change", debounce(function() {
      updateLineItem(task._id, { startDate: this.value });
    }, 500));
    startCell.appendChild(startInput);
    row.appendChild(startCell);

    const endCell = document.createElement("td");
    endCell.setAttribute("data-label", "End Date");
    const endInput = document.createElement("input");
    endInput.type = "date";
    endInput.value = task.endDate ? new Date(task.endDate).toISOString().split("T")[0] : "";
    endInput.addEventListener("change", debounce(function() {
      updateLineItem(task._id, { endDate: this.value });
    }, 500));
    endCell.appendChild(endInput);
    row.appendChild(endCell);

    const statusCell = document.createElement("td");
    statusCell.setAttribute("data-label", "Status");
    const statusSelect = document.createElement("select");
    statusSelect.innerHTML = `
      <option value="in-progress" ${task.status==="in-progress"?"selected":""}>In Progress</option>
      <option value="completed" ${task.status==="completed"?"selected":""}>Completed</option>
    `;
    updateStatusDropdownStyle(statusSelect);
    statusSelect.addEventListener("change", debounce(function() {
      updateStatusDropdownStyle(statusSelect);
      updateLineItem(task._id, { status: statusSelect.value });
    }, 500));
    statusCell.appendChild(statusSelect);
    row.appendChild(statusCell);

    const commentsCell = document.createElement("td");
    commentsCell.setAttribute("data-label", "Comments");
    const commentsInput = document.createElement("textarea");
    commentsInput.style.resize = "vertical";
    commentsInput.style.width = "90%";
    commentsInput.value = task.description || "";
    commentsInput.addEventListener("input", debounce(function() {
      updateLineItem(task._id, { description: commentsInput.value });
    }, 500));
    commentsCell.appendChild(commentsInput);
    row.appendChild(commentsCell);

    tbody.appendChild(row);
  });
}

      
   function renderGridView(lineItems) {
    gridTasksOrder = getAllTasks(lineItems);
    const gridContainer = document.querySelector("#gridView .grid-container");
    gridContainer.innerHTML = "";

    gridTasksOrder.forEach((task, index) => {
      const gridItem = document.createElement("div");
      gridItem.className = `grid-item ${task.status.toLowerCase().replace(" ", "-")}`;

      if (task.endDate && new Date() > new Date(task.endDate) && task.status !== "completed") {
        gridItem.classList.add("overdue");
      }

      gridItem.setAttribute("draggable", "true");
      gridItem.dataset.index = index;

      gridItem.innerHTML = `
        <h3>${task.name}</h3>
        <div class="grid-details">
          <p><strong>Category:</strong> ${task.category || "Uncategorized"}</p>
          <p><strong>Start:</strong> ${task.startDate ? new Date(task.startDate).toLocaleDateString() : 'N/A'}</p>
          <p><strong>End:</strong> ${task.endDate ? new Date(task.endDate).toLocaleDateString() : 'N/A'}</p>
          <p><strong>Status:</strong> <span class="status-label ${getStatusClass(task.status)}">${task.status}</span></p>
          <p><strong>Comments:</strong> ${task.description ? (task.description.length > 50 ? task.description.substring(0, 50) + "..." : task.description) : 'No comments'}</p>
        </div>
      `;

      gridItem.addEventListener("dragstart", function(e) {
        e.dataTransfer.setData("text/plain", index);
      });

      gridItem.addEventListener("dragover", function(e) {
        e.preventDefault();
      });

      gridItem.addEventListener("drop", function(e) {
        e.preventDefault();
        const sourceIndex = e.dataTransfer.getData("text/plain");
        const targetIndex = index;

        if (sourceIndex !== targetIndex) {
          const temp = gridTasksOrder[sourceIndex];
          gridTasksOrder[sourceIndex] = gridTasksOrder[targetIndex];
          gridTasksOrder[targetIndex] = temp;
          renderGridView(gridTasksOrder);
        }
      });

      gridItem.addEventListener("click", () => {
        const modalContent = `
          <h2>Edit Task</h2>
          <label>Task Name: <input type="text" id="editName" value="${task.name}" readonly /></label><br/><br/>
          <label>Start Date: <input type="date" id="editStart" value="${task.startDate ? new Date(task.startDate).toISOString().split("T")[0] : ''}" /></label><br/><br/>
          <label>End Date: <input type="date" id="editEnd" value="${task.endDate ? new Date(task.endDate).toISOString().split("T")[0] : ''}" /></label><br/><br/>
          <label>Status: 
            <select id="editStatus">
              <option value="in-progress" ${task.status === "in-progress" ? "selected" : ""}>In Progress</option>
              <option value="completed" ${task.status === "completed" ? "selected" : ""}>Completed</option>
            </select>
          </label><br/><br/>
          <label>Comments: <textarea id="editComments">${task.description || ''}</textarea></label><br/><br/>
          <button id="saveEditBtn">Save</button>
        `;
        openModal(modalContent);

        document.getElementById("saveEditBtn").addEventListener("click", async function() {
          const updatedTask = {
            name: task.name,
            startDate: document.getElementById("editStart").value,
            endDate: document.getElementById("editEnd").value,
            status: document.getElementById("editStatus").value,
            description: document.getElementById("editComments").value
          };
          await updateLineItem(task._id, updatedTask);
          closeModal();
          loadView("gridView");
        });
      });

      gridContainer.appendChild(gridItem);
    });
  }
      
      function renderCalendarView(lineItems) {
        const calendarContainer = document.querySelector("#calendarView .calendar");
        calendarContainer.innerHTML = "";
        const currentMonthYear = document.getElementById("currentMonthYear");
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        currentMonthYear.textContent = currentCalendarDate.toLocaleString("default", { month: "long", year: "numeric" });
        const daysOfWeek = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        daysOfWeek.forEach(day => {
          const dayHeader = document.createElement("div");
          dayHeader.className = "calendar-date";
          dayHeader.style.fontWeight = "bold";
          dayHeader.textContent = day;
          calendarContainer.appendChild(dayHeader);
        });
        const firstDayIndex = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 0; i < firstDayIndex; i++) {
          const emptyCell = document.createElement("div");
          calendarContainer.appendChild(emptyCell);
        }
        for (let i = 1; i <= daysInMonth; i++) {
          const dateCell = document.createElement("div");
          dateCell.className = "calendar-date";
          dateCell.textContent = i;
          const cellDateStr = new Date(year, month, i).toISOString().split("T")[0];
          dateCell.dataset.date = cellDateStr;
          const tasksForDay = getAllTasks(lineItems).filter(task => {
            return task.startDate && task.startDate.split("T")[0] === cellDateStr;
          });
          tasksForDay.forEach(task => {
            const taskSpan = document.createElement("span");
            taskSpan.className = "task";
            taskSpan.textContent = `${task.name} (${task.category || "Uncategorized"})`;
            dateCell.appendChild(taskSpan);
          });
          dateCell.addEventListener("click", () => {
            if (tasksForDay.length > 0) {
              let modalHTML = `<h2>Tasks on ${cellDateStr}</h2><ul>`;
              tasksForDay.forEach(task => {
                modalHTML += `<li>${task.name} (${task.category || "Uncategorized"}) - ${task.status}</li>`;
              });
              modalHTML += `</ul>`;
              openModal(modalHTML);
            }
          });
          calendarContainer.appendChild(dateCell);
        }
      }



      

      let ganttInstance = null;
let ganttViewMode = 'Day'; // Default view mode

// ✅ Load Gantt Library
async function loadGanttLibrary() {
  return new Promise((resolve, reject) => {
    if (window.Gantt) return resolve(); // Already loaded
    const script = document.createElement("script");
    script.src = "https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js";
    script.onload = () => resolve();
    script.onerror = () => reject("❌ Failed to load Frappe Gantt.");
    document.head.appendChild(script);
  });
}

// ✅ Call this function after DOM is ready or data is loaded
function renderGanttChartView(lineItems, viewMode = "Day") {
  const containerId = "frappeGanttChart";
  const container = document.getElementById(containerId);

  if (!container) {
    console.error("⚠️ Gantt container not found:", containerId);
    return;
  }

  // Flatten and normalize tasks
  const allItems = lineItems.flatMap(cat =>
    Array.isArray(cat.items)
      ? cat.items.map(item => ({ ...item, category: cat.category }))
      : []
  );

  const tasks = allItems
    .filter(item => item.startDate && item.endDate)
    .map((item, index) => {
      const start = formatDate(item.startDate);
      const end = formatDate(item.endDate);

      if (!start || !end) {
        console.warn("⛔ Skipping item due to invalid dates:", item.name, item.startDate, item.endDate);
        return null;
      }

      const categoryClass = item.category
        ? `category-${item.category.trim().toLowerCase().replace(/\s+/g, "-")}`
        : "category-default";

      return {
        id: item._id || `task-${index + 1}`,
        name: item.name, // Only the task name, not category
        start,
        end,
        progress: item.progress || 0,
        dependencies: item.dependencies || "",
        custom_class: categoryClass,
        category: item.category || "Uncategorized"
      };
    })
    .filter(Boolean);

  if (tasks.length === 0) {
    container.innerHTML = `<p style="padding: 20px;">No tasks available to display</p>`;
    return;
  }

  container.innerHTML = "";

  setTimeout(() => {
    // Remove any previous custom labels
    document.querySelectorAll('.gantt-bar-label-right').forEach(el => el.remove());

    const gantt = new Gantt(`#${containerId}`, tasks, {
      view_mode: viewMode,
      date_format: "YYYY-MM-DD",
      custom_popup_html: task => `
        <div class="gantt-popup">
          <strong>${task.name}</strong><br>
          <span style="color:#007bff;">${task.category || ""}</span><br>
          Start: ${task._start.toDateString()}<br>
          End: ${task._end.toDateString()}<br>
          Progress: ${task.progress}%
        </div>
      `,
      on_date_change: (task, newStart, newEnd) => {
        updateLineItem(task.id, {
          startDate: newStart.toISOString(),
          endDate: newEnd.toISOString()
        });
        showNotification(`📅 "${task.name}" date updated`, "success");
      }
    });

// Add labels to the right of each bar
// Add SVG text labels to the right of each bar
setTimeout(() => {
  // Remove any previous custom SVG labels
  document.querySelectorAll('.gantt-bar-label-right-svg').forEach(el => el.remove());

  // Get the main SVG element
  const svg = document.querySelector('.gantt svg');
  if (!svg) return;

  // Detect vertical offset from main group transform, if any
  let yOffset = 0;
  // Find the first <g> with a transform (usually the main group)
  const mainGroup = Array.from(svg.querySelectorAll('g')).find(g => g.hasAttribute('transform'));
  if (mainGroup) {
    const match = mainGroup.getAttribute('transform').match(/translate\(\s*0\s*,\s*(-?\d+)\s*\)/);
    if (match) yOffset = parseInt(match[1], 10);
  }

  document.querySelectorAll('.gantt .bar-wrapper').forEach(wrapper => {
    const bar = wrapper.querySelector('.bar');
    if (!bar) return;

    // Get the label text from the task name
    const taskId = wrapper.getAttribute('data-id');
    const task = tasks.find(t => t.id == taskId);
    if (!task) return;

    // Get bar's bounding box (relative to SVG)
    const barRect = bar.getBBox();

    // Create SVG text element
    const svgNS = "http://www.w3.org/2000/svg";
    const text = document.createElementNS(svgNS, "text");
    text.setAttribute("class", "gantt-bar-label-right-svg");
    text.setAttribute("x", barRect.x + barRect.width + 18); // 18px to the right of the bar
    text.setAttribute("y", barRect.y + barRect.height / 2 + yOffset);
    text.setAttribute("fill", "#22223b");
    text.setAttribute("font-size", "13");
    text.setAttribute("font-weight", "bold");
    text.setAttribute("dominant-baseline", "middle");
    text.setAttribute("text-anchor", "start");
    text.setAttribute("pointer-events", "none");
    text.textContent = task.name;

    // Append to the main SVG (not to the bar's group)
    svg.appendChild(text);
  });
}, 350);

    enableTouchDragForGantt();
    console.log(`✅ Gantt rendered with ${tasks.length} tasks`);
  }, 20);
}




// ✅ Date formatter
function formatDate(date) {
  const d = new Date(date);
  return isNaN(d) ? "" : d.toISOString().split("T")[0];
}


function enableTouchDragForGantt() {
  const bars = document.querySelectorAll(".gantt .bar-wrapper");

  bars.forEach(bar => {
    let startX = 0;
    let originalLeft = 0;
    let isDragging = false;

    bar.addEventListener("touchstart", e => {
      const touch = e.touches[0];
      startX = touch.clientX;
      originalLeft = bar.getBoundingClientRect().left;
      isDragging = true;
      bar.style.transition = "none";
    });

    bar.addEventListener("touchmove", e => {
      if (!isDragging) return;
      const touch = e.touches[0];
      const dx = touch.clientX - startX;
      bar.style.transform = `translateX(${dx}px)`;
      e.preventDefault();
    });

    bar.addEventListener("touchend", () => {
      if (!isDragging) return;
      bar.style.transition = "transform 0.2s ease-out";
      bar.style.transform = "translateX(0)";
      isDragging = false;

      // Optional: you can trigger a backend update here using the new date
      // Requires calculating the new start/end based on dx
    });
  });
}



// ✅ Date formatter
function formatDate(date) {
  const d = new Date(date);
  return isNaN(d) ? "" : d.toISOString().split("T")[0];
}




      
      /* --------------------- Dashboard Rendering --------------------- */
      function renderDashboardView(lineItems) {
  const tasks = getAllTasks(lineItems);

  // -------------------- Projected Completion Date --------------------
  const endTimes = tasks.filter(t => t.endDate).map(t => new Date(t.endDate).getTime());
  const projectedCompletionDate = endTimes.length ? new Date(Math.max(...endTimes)) : null;

  let completionDiv = document.getElementById("projectedCompletionDate");
  if (!completionDiv) {
    completionDiv = document.createElement("div");
    completionDiv.id = "projectedCompletionDate";
    completionDiv.className = "completion-banner";
    document.getElementById("dashboardView").insertAdjacentElement("afterbegin", completionDiv);
  }

  completionDiv.innerHTML = `
    📅 <strong>Projected Completion:</strong> 
    ${projectedCompletionDate ? projectedCompletionDate.toLocaleDateString() : "N/A"}
  `;

  // -------------------- Extra Stats: % Complete + Overdue --------------------
  const totalTasks = tasks.length;
  const completedTasks = tasks.filter(t => t.status === "completed").length;
  const overdueTasks = tasks.filter(t => t.endDate && new Date(t.endDate) < new Date() && t.status !== "completed").length;
  const percentComplete = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

  let statsDiv = document.getElementById("dashboardStats");
  if (!statsDiv) {
    statsDiv = document.createElement("div");
    statsDiv.id = "dashboardStats";
    statsDiv.className = "dashboard-stats";
    completionDiv.insertAdjacentElement("afterend", statsDiv);
  }

  statsDiv.innerHTML = `
    <div class="stat-card">
      ✅ <strong>${percentComplete}%</strong><br><span>Complete</span>
    </div>
    <div class="stat-card">
      ⏰ <strong>${overdueTasks}</strong><br><span>Overdue Tasks</span>
    </div>
    <div class="stat-card">
      📋 <strong>${totalTasks}</strong><br><span>Total Tasks</span>
    </div>
  `;

  // -------------------- Pie Chart: Task Status --------------------
  const statusCounts = { "in-progress": 0, "completed": 0 };
  tasks.forEach(task => {
    if (statusCounts[task.status] !== undefined) {
      statusCounts[task.status]++;
    }
  });

  const ctxStatus = document.getElementById("statusChart").getContext("2d");
  if (window.statusChartInstance) window.statusChartInstance.destroy();
  window.statusChartInstance = new Chart(ctxStatus, {
    type: "doughnut",
    data: {
      labels: ["In Progress", "Completed"],
      datasets: [{
        data: Object.values(statusCounts),
        backgroundColor: ["#f0ad4e", "#28a745"],
        borderColor: ["#e0a63f", "#218838"],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      animation: {
        animateScale: true,
        animateRotate: true
      },
      plugins: {
        legend: { position: "bottom" },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.label}: ${ctx.parsed}`
          }
        }
      },
      cutout: "65%"
    }
  });

  // -------------------- Bar Chart: Tasks per Month --------------------
  const monthCounts = {};
  tasks.forEach(task => {
    if (task.startDate) {
      const month = new Date(task.startDate).toLocaleString("default", { month: "short", year: "numeric" });
      monthCounts[month] = (monthCounts[month] || 0) + 1;
    }
  });

  const ctxTimeline = document.getElementById("timelineChart").getContext("2d");
  if (window.timelineChartInstance) window.timelineChartInstance.destroy();
  window.timelineChartInstance = new Chart(ctxTimeline, {
    type: "bar",
    data: {
      labels: Object.keys(monthCounts),
      datasets: [{
        label: "Tasks per Month",
        data: Object.values(monthCounts),
        backgroundColor: "#007bff",
        borderColor: "#0056b3",
        borderWidth: 1,
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      animation: {
        duration: 1000,
        easing: "easeOutQuart"
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `Tasks: ${ctx.parsed.y}`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1 }
        }
      }
    }
  });
}


      
      /* --------------------- View Handlers --------------------- */
      async function loadView(view) {
  currentView = view; // track current view

  // Hide all views first
  ["dashboardView", "listView", "gridView", "calendarView", "ganttView"].forEach(v => {
    document.getElementById(v).style.display = "none";
  });

  // Show the selected view
  document.getElementById(view).style.display = "block";

  const projectId = await getCurrentProjectId();
  if (projectId) {
    currentLineItems = await fetchLineItems(projectId);

    const estimateSelector = document.getElementById("estimateSelector");
    const selectedValue = estimateSelector?.value || "all";

    // ✅ Correctly assign selectedLineItems (no const, just assignment)
    selectedLineItems = selectedValue === "all"
      ? currentLineItems.flatMap(est => est.lineItems || [])
      : (currentLineItems[parseInt(selectedValue)]?.lineItems || []);

    // Render the appropriate view
    if (view === "listView") {
      renderTable(selectedLineItems);
    } else if (view === "gridView") {
      gridTasksOrder = getAllTasks(selectedLineItems);
      renderGridView(selectedLineItems);
    } else if (view === "calendarView") {
      renderCalendarView(selectedLineItems);
    } else if (view === "ganttView") {
      renderGanttChartView(selectedLineItems, ganttViewMode);
    } else if (view === "dashboardView") {
      setTimeout(() => {
        renderDashboardView(selectedLineItems);
      }, 500);
    }
  }
}


      
      /* --------------------- Pagination Controls --------------------- */
      document.getElementById("nextPageBtn").addEventListener("click", function() {
  const totalPages = Math.ceil(filteredTasks.length / itemsPerPage) || 1;
  if (currentPage < totalPages) {
    currentPage++;
    renderTable();
  }
});

document.getElementById("prevPageBtn").addEventListener("click", function() {
  if (currentPage > 1) {
    currentPage--;
    renderTable();
  }
});


      document.getElementById("ganttMode").addEventListener("change", function () {
  ganttViewMode = this.value;
  renderGanttChartView(selectedLineItems, ganttViewMode);
});


      
      /* --------------------- Filter Listeners --------------------- */
      document.getElementById("listSearch").addEventListener("input", () => {
        currentPage = 1;
        renderTable(selectedLineItems);
      });
      document.getElementById("statusFilter").addEventListener("change", () => {
        currentPage = 1;
        renderTable(selectedLineItems);
      });
      document.getElementById("categoryFilter").addEventListener("input", () => {
        currentPage = 1;
        renderTable(selectedLineItems);
      });
      document.getElementById("startDateFrom").addEventListener("change", () => {
        currentPage = 1;
        renderTable(selectedLineItems);
      });
      document.getElementById("startDateTo").addEventListener("change", () => {
        currentPage = 1;
        
        renderTable(selectedLineItems);
      });
      
      /* --------------------- Sort Header Listeners --------------------- */
      document.querySelectorAll("#scheduleTable th[data-sort]").forEach(header => {
        header.addEventListener("click", function() {
          const field = this.dataset.sort;
          if (sortField === field) {
            sortDirection = sortDirection === "asc" ? "desc" : "asc";
          } else {
            sortField = field;
            sortDirection = "asc";
          }
          renderTable(selectedLineItems);
        });
      });
      
      /* --------------------- Calendar Navigation --------------------- */
      document.getElementById("prevMonthBtn").addEventListener("click", function() {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
        renderCalendarView(selectedLineItems);
      });
      document.getElementById("nextMonthBtn").addEventListener("click", function() {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
        renderCalendarView(selectedLineItems);
      });
      
      /* --------------------- View Buttons --------------------- */
      document.getElementById("dashboardViewBtn").addEventListener("click", () => loadView("dashboardView"));
      document.getElementById("listViewBtn").addEventListener("click", () => loadView("listView"));
      document.getElementById("gridViewBtn").addEventListener("click", () => loadView("gridView"));
      document.getElementById("calendarViewBtn").addEventListener("click", () => loadView("calendarView"));
      document.getElementById("ganttViewBtn").addEventListener("click", () => loadView("ganttView"));
      
      /* --------------------- Action Buttons --------------------- */
      document.getElementById("printBtn").addEventListener("click", () => window.print());
      document.getElementById("exportBtn").addEventListener("click", exportCSV);
      
      function exportCSV() {
        let csvContent = "data:text/csv;charset=utf-8,Category,Task,Start Date,End Date,Status,Comments\n";
        flatTasks.forEach(task => {
          const row = [
            task.category || "Uncategorized",
            task.name,
            task.startDate ? new Date(task.startDate).toLocaleDateString() : "",
            task.endDate ? new Date(task.endDate).toLocaleDateString() : "",
            task.status,
            task.description ? task.description.replace(/,/g, " ") : ""
          ];
          csvContent += row.join(",") + "\n";
        });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "schedule.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      
      /* --------------------- Initial Load --------------------- */
      const projectId = await getCurrentProjectId();
if (projectId) {
  currentLineItems = await fetchLineItems(projectId); // Fetch all estimates
  populateEstimateDropdown(currentLineItems);         // Set up dropdown

  // Default to All Estimates
  const allItems = currentLineItems.flatMap(est => est.lineItems || []);
  selectedLineItems = allItems;  // ✅ Assign to selectedLineItems
  renderTable();                 // ✅ No arguments
  document.getElementById("estimateSelector").value = "all";
       // Set default view to "listView"
     loadView("listView");
}


    });
  </script>
</body>
</html>
