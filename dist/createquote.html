<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-touch-fullscreen" content="yes" />
  

  <title>Create Quote</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 10px;
      background: #f9f9f9;
      color: #333;
    }

    .container {
      max-width: 1100px;
      margin: auto;
      background: white;
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    h1 {
      color: #007bff;
      margin-bottom: 20px;
    }

    .section {
      margin-bottom: 30px;
    }

    /* Grid layout for Quote From / Quote To / Meta sections */
    .quote-meta-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      align-items: start;
    }
    @media (min-width: 900px) {
      .quote-meta-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
      /* Avoid extra space between cards when in grid */
      .quote-meta-grid .section {
        margin-bottom: 0;
      }
    }
    .quote-meta-grid .section {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 1px 2px rgba(2, 6, 23, 0.04);
    }
    .quote-meta-grid .section h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
      color: #0f172a;
    }

    /* Internal grid for Quote meta fields */
    .section-dates {
      
      grid-template-columns: 1fr;
      gap: 10px 16px;
    }
    .section-dates .field {
      display: flex;
      flex-direction: column;
    }
    .section-dates .field label {
      margin-top: 0; /* override global label top margin inside grouped fields */
      margin-bottom: 6px;
    }
    @media (min-width: 900px) {
      .section-dates {
        grid-template-columns: repeat(3, minmax(0, 1fr));
        align-items: end;
      }
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }

    input, textarea {
  width: 100%;
  font-size: 14px;
  padding: 6px 8px;
  border: 1px solid #ccc;
  border-radius: 5px;
  box-sizing: border-box;
    }

    input:focus,.floating-label-group textarea:focus,
select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 1px rgba(65, 88, 221, 0.705);
  outline: none;
}

    #line-items-cards textarea,
.line-item-row textarea {
  resize: vertical;           /* ✅ Enables manual drag */
  overflow-y: auto;
  min-height: 60px;
  max-height: 300px;          /* Prevent it from taking too much space */
  font-size: 14px;
  padding: 8px 10px;
  border: 1px solid #cccccc;
  border-radius: 5px;
  box-sizing: border-box;
  width: 100%;
}

    
@media (max-width: 600px) {
  .line-item-row textarea,
  .line-item-row input,
  .line-item-row button {
    width: 100%;
  }
}

/* Mobile: make floating-label-group textareas fully responsive */
@media (max-width: 1275px) {
  .floating-label-group {
    min-width: 100%;
    max-width: 100%;
    width: 100%;
  }
  .floating-label-group textarea {
    width: 200% !important; /* override any inline widths (e.g., 260%) */
    box-sizing: border-box;
  }
}

@media (max-width: 1124px) {
  .floating-label-group {
    min-width: 100%;
    max-width: 100%;
    width: 100%;
  }
  .floating-label-group textarea {
    width: 150% !important; /* override any inline widths (e.g., 260%) */
    box-sizing: border-box;
  }
}

@media (max-width: 1024px) {
  .floating-label-group {
    min-width: 100%;
    max-width: 100%;
    width: 100%;
  }
  .floating-label-group textarea {
    width: 100% !important; /* override any inline widths (e.g., 260%) */
    box-sizing: border-box;
  }
}


    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 2px 3px;
      text-align: left;
    }

    th {
      background: #f0f4f8;
    }

    .btn {
      padding: 10px 20px;
      margin-top: 10px;
      margin-right: 10px;
      border: none;
      border-radius: 8px;
      background: #007bff; /* blue-600 */
      color: #ffffff;
      font-weight: 600;
      cursor: pointer;
      transition: background-color .2s ease, box-shadow .2s ease, transform .1s ease;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06), 0 2px 6px rgba(37,99,235,0.15);
    }
    .btn:hover {
      background: #1d4ed8; /* blue-700 */
      box-shadow: 0 1px 3px rgba(0,0,0,0.10), 0 8px 18px rgba(29,78,216,0.20);
      transform: translateY(-1px);
    }
    .btn:active {
      background: #1e40af; /* blue-800 */
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0,0,0,0.08), 0 2px 8px rgba(30,64,175,0.18);
    }
    .btn:focus-visible {
      outline: 2px solid #93c5fd; /* blue-300 */
      outline-offset: 2px;
    }
    .btn:disabled,
    .btn[disabled] {
      background: #9ca3af; /* gray-400 */
      color: #ffffff;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
      opacity: 0.85;
    }

    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      background-color: white;
      min-width: 150px;
      box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.15);
      border-radius: 8px;
      z-index: 10000;
      right: 0;
      top: 100%;
      overflow: hidden;
      font-size: 14px;
    }

    .dropdown-content a {
      display: block;
      padding: 10px 16px;
      color: #333;
      text-decoration: none;
      transition: background 0.2s;
    }

    .dropdown-content a:hover {
      background-color: #f0f0f0;
    }

    .dropdown:hover .dropdown-content,
    .dropdown:focus-within .dropdown-content {
      display: block;
    }

    .dropdown-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #666;
    }

    .summary-box {
      margin-top: 30px;
      padding: 20px;
      background: #f5faff;
      border-radius: 10px;
    }

    .summary-box p {
      margin: 5px 0;
    }

    /* Enhanced totals panel */
    .totals-panel {
      display: grid;
      grid-template-columns: 1fr auto;
      row-gap: 8px;
      column-gap: 16px;
      padding: 14px 16px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(2, 6, 23, 0.04);
    }
    .totals-panel .t-row { display: contents; }
    .totals-panel .label { color: #64748b; font-size: 14px; align-self: center; }
    .totals-panel .value { color: #0f172a; font-weight: 600; font-variant-numeric: tabular-nums; }
    .totals-panel .divider {
      grid-column: 1 / -1;
      height: 1px;
      background: #e5e7eb;
      margin: 4px 0 6px 0;
    }
    .totals-panel .grand .label { font-weight: 700; color: #0f172a; font-size: 15px; }
    .totals-panel .grand .value { font-weight: 800; color: #0ea5e9; font-size: 18px; }

    .modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%; 
  height: 100%;
  background: rgba(0, 0, 0, 0.5); /* Dark overlay for mobile */
  display: none;
  justify-content: center;
  align-items: flex-start;
  z-index: 10000;
  overflow: auto;
  padding: 40px 20px;
  box-sizing: border-box;
}

/* Modal Content */
.modal-content {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
  width: 100%;
  max-width: 800px;
  
  max-height: 94vh;
  overflow-y: auto;
  position: relative;
}


    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
    }

    .close-modal {
      font-size: 24px;
      cursor: pointer;
    }

    .modal-footer {
      margin-top: 20px;
      text-align: right;
    }

    .signature-block {
      margin-top: 40px;
      border-top: 1px solid #ccc;
      padding-top: 20px;
    }

    .signature-block label {
      font-weight: normal;
    }

    .payment-terms {
      margin-top: 30px;
      font-size: 14px;
      color: #555;
      background: #f8f8f8;
      padding: 15px;
      border-radius: 8px;
      border-left: 5px solid #007bff;
    }



.line-item-row {
  position: sticky;
  top: 8px;
  z-index: 1000;
  background: #f7f8fa;
  border: 1px solid #707a86;
  border-radius: 8px;
  padding: 4px 5px;
  margin-bottom: 18px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.03);
}

.line-item-row input {
  
  max-width: 200px;
}


    @media (max-width: 600px) {
  .line-item-row input {
    width: 100%;
  }

  .line-item-row {
    flex-direction: column;
    align-items: stretch;
  }

  .line-item-row input,
  .line-item-row button {
    width: 100%;
    max-width: 100%;
  }

}


    @media (max-width: 480px) {
      .line-item-row,
      .modal-content {
        flex-direction: column;
        padding: 15px;
        position: relative;
      }

      .btn {
        width: 100%;
        margin-top: 10px;
      }

      table, th, td {
        font-size: 0.9rem;
      }

      .container {
        padding: 15px;
      }

      h1 {
        font-size: 1.4rem;
      }
      .floating-label-group textarea  {
        
        width: 112% !important;
      }

      #suggestionBox{
  top: 108px !important;
}
    }

    @media screen and (max-width: 600px) {
      .container {
        padding: 15px;
      }

      h1 {
        font-size: 1.4rem;
      }

      .btn {
        width: 100%;
        margin: 10px 0 0;
      }

      .modal-content {
        padding: 15px;
        max-height: 95vh;
      }

      table, th, td {
        font-size: 0.9rem;
      }


    }

    




    @media (max-width: 600px) {
        .line-item-row {
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }


  .line-item-row input,
  .line-item-row button {
    width: 100%;
    max-width: 100%;
    height: 40px; /* Important fix */
    font-size: 14px;
    padding: 8px 10px;
    box-sizing: border-box;
  }
  
  .line-item-row {
    gap: 8px;
  }

  .btn {
    width: 100%;
    margin-top: 10px;
  }

  table, th, td {
    font-size: 0.9rem;
  }

  .container {
    padding: 15px;
  }

  h1 {
    h1 {
  font-size: clamp(1.4rem, 2vw, 2rem);
}

  }
}

#quoteHistoryList li {
    margin-bottom: 12px;
    padding: 12px 16px;
    background-color: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 8px;
    transition: background-color 0.2s ease, transform 0.1s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  #quoteHistoryList li:hover {
    background-color: #e9f0ff;
    transform: translateY(-2px);
  }

  .quote-link {
    color: #007bff;
    text-decoration: none;
    font-weight: 500;
    font-size: 1rem;
  }

  .quote-meta {
    font-size: 0.85rem;
    color: #666;
    margin-left: 10px;
  }

  .history-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0 20px;
      gap: 10px;
    }

    .history-controls input,
    .history-controls select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .pagination {
      margin-top: 10px;
      text-align: center;
    }

    .pagination button {
      margin: 0 4px;
      padding: 6px 12px;
      background: #eee;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .pagination button.active {
      background: #007bff;
      color: white;
    }

    .sticky-header {
  position: sticky;
  top: 0;
  background-color: #fff;
  z-index: 1000;
  padding: 15px 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-title {
  font-size: 30px;
  font-weight: bold;
  color: #007bff;
}

.dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-btn {
  background: #007bff;
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
}

.dropdown-content {
  display: none;
  position: absolute;
  right: 0;
  background-color: white;
  min-width: 180px;
  box-shadow: 0 8px 16px rgba(0,0,0,0.15);
  border-radius: 8px;
  overflow: hidden;
  z-index: 1001;
}

.dropdown-content a {
  color: #333;
  padding: 12px 16px;
  display: block;
  text-decoration: none;
  font-size: 15px;
}

.dropdown-content a:hover {
  background-color: #f0f0f0;
}

.dropdown:hover .dropdown-content {
  display: block;
}

.dropdown-toggle {
    background: transparent;
    border: none;
    font-size: 20px;
    cursor: pointer;
    margin-left: 10px;
  }
  .dropdown-menu {
    display: none;
    position: absolute;
    right: 0;
    top: 30px;
    background: white;
    border: 1px solid #ccc;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    z-index: 1000;
  }
  .dropdown-menu button {
    display: block;
    padding: 8px 12px;
    width: 100%;
    border: none;
    background: white;
    text-align: left;
    cursor: pointer;
  }
  .dropdown-menu button:hover {
    background-color: #f0f0f0;
  }
  /* Action menu positioned at card's top-right */
  .action-dropdown {
    position: absolute;
    top: 8px;
    right: 8px;
    display: inline-block;
    z-index: 20;
  }
  .action-dropdown .dots {
    background: transparent;
    border: none;
    font-size: 20px;
    cursor: pointer;
  }
  .action-dropdown-content {
    display: none;
    position: absolute;
    top: 28px;
    right: 0;
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    overflow: visible;
    min-width: 120px;
  }
  .action-dropdown-content button {
    width: 100%;
    padding: 8px 12px;
    border: none;
    background: none;
    text-align: left;
    cursor: pointer;
  }
  .action-dropdown-content button:hover {
    background-color: #f0f0f0;
  }

  @keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* By default, show full table on desktop */
.table-responsive-sm {
  overflow: auto;
}

/* On screens smaller than 768px, make it scrollable */
@media screen and (max-width: 768px) {
  .table-responsive-sm {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border-radius: 6px;
    margin-top: 10px;
  }

  .table-responsive-sm table {
    width: 700px; /* triggers scroll */
    min-width: 600px;
    border-collapse: collapse;
  }

  .table-responsive-sm th
   {
    white-space: nowrap;
  }
}


.drag-handle {
  
  cursor: grab;
  font-size: 18px;
  padding: 4px;
  display: inline-block;
}

input, textarea {
  pointer-events: auto !important;
}

  .drag-handle:active {
    cursor: grabbing;
  }


  .summary-box {
  
  bottom: 0;
  background: #f5faff;
  z-index: 999;
  border-top: 2px solid #ddd;
}


#loader {
  transition: opacity 0.3s ease;
}

#loader.hide {
  opacity: 0;
  pointer-events: none;
}


/* 🔵 Default: Mobile & Tablet Portrait (overlay modal) */
.labor-toolbar {
  background: rgba(0, 0, 0, 0.5);
  justify-content: center;
  align-items: flex-start;
  padding-top: 50px;
}

/* 🖥️ Desktop & Tablet Landscape: Sidebar Behavior */
@media (min-width: 768px) {
  /* 🔹 Sidebar modal container */
  #laborCostModal {
    display: none;                 /* Hidden by default */
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: auto;
    width: auto;
    background: transparent !important;
    z-index: 9999;
    justify-content: flex-end;
    align-items: stretch;
    padding: 0;
  }

  /* 🔹 Sidebar modal content */
  #laborCostModal .modal-content,
  .labor-toolbar .modal-content {
    width: 360px;
    max-width: 340px;
    height: 100vh;
    background: #fff;
    border-left: 2px solid #eee;
    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
    overflow-y: auto;
    animation: slideInSidebar 0.3s ease forwards;
    border-radius: 0;
    position: relative;
  }

  /* 🧭 Slide-in animation */
  @keyframes slideInSidebar {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  /* 🔹 Shift main content when sidebar open */
  body.sidebar-open .container {
    margin-right: 370px; /* 360px + 10px gap */
    transition: margin 0.3s ease;
  }


}

/* ✏️ Edit Labor Modal (modal-centered layout) */
#editLaborModal .modal-content {
  max-width: 500px;
  padding: 20px;
}

/* 🔁 Smooth text area height change */
textarea {
  transition: height 0.2s ease;
}

/* Add these styles to your existing CSS */
.package-dropdown {
    position: relative;
    width: 100%;
}

.package-select-btn {
    width: 100%;
    padding: 12px 15px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    cursor: pointer;
    text-align: left;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    color: #333;
    transition: all 0.2s ease;
}

.package-select-btn:hover {
    background: #e9ecef;
    border-color: #adb5bd;
}

.dropdown-arrow {
    font-size: 12px;
    transition: transform 0.2s ease;
}

.package-dropdown-content {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    margin-top: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    z-index: 1000;
}

.package-dropdown-content.show {
    display: block;
}

/* Inline + icon button for showing the new labor form */
  .add-labor-inline-btn {
    display: inline-flex;
    width: 28px;
    height: 28px;
    align-items: center;
    justify-content: center;
    border: none;
    border-radius: 8px;
    background: #007bff; /* Tailwind-esque blue-600 */
    color: #ffffff;
    font-weight: 700;
    font-size: 16px;
    line-height: 1;
    cursor: pointer;
    user-select: none;
    box-shadow: 0 1px 2px rgba(0,0,0,0.08), 0 2px 8px rgba(37,99,235,0.20);
    transition: background-color .2s ease, box-shadow .2s ease, transform .1s ease;
  }
  .add-labor-inline-btn:hover {
    background: #1d4ed8; /* blue-700 */
    box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 6px 16px rgba(29,78,216,0.25);
    transform: translateY(-1px);
  }
  .add-labor-inline-btn:active {
    background: #1e40af; /* blue-800 */
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(0,0,0,0.10), 0 2px 8px rgba(30,64,175,0.20);
  }
  .add-labor-inline-btn:focus-visible {
    outline: 2px solid #93c5fd; /* blue-300 */
    outline-offset: 2px;
  }

/* Row to place button and + icon side by side */
.package-header-row {
  display: flex;
  align-items: center;
  gap: 8px;
}
.package-header-row .package-select-btn {
  flex: 1;
  width: auto;
}

/* Suggestions footer styles */
.totals-footer {
  margin-top: 10px;
  border-top: 1px solid #e5e7eb;
  padding-top: 5px;
}
#laborSuggestionsFooter .t-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 14px;
  padding: 4px 0;
}
#laborSuggestionsFooter .t-row .label { color: #6b7280; }
#laborSuggestionsFooter .t-row .value { font-weight: 600; color: #111827; }
#laborSuggestionsFooter .t-row.grand { border-top: 1px dashed #e5e7eb; margin-top: 4px; padding-top: 8px; }
#laborSuggestionsFooter .t-row.grand .value { font-size: 16px; color: #111827; }

/* Modern total row for labor suggestions */
.suggestion-total-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
  padding: 4px 7px;
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  box-shadow: 0 1px 2px rgba(2, 6, 23, 0.04);
  cursor: pointer;
  transition: background-color .15s ease, box-shadow .15s ease, transform .05s ease;
}
.suggestion-total-row:hover {
  background: #f8fafc;
  box-shadow: 0 2px 6px rgba(2, 6, 23, 0.06);
}
.suggestion-total-row:active {
  transform: translateY(0.5px);
}
.suggestion-total-row .total-amount {
  color: #007bff;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
}
.suggestion-total-row .chevron {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 22px;
  height: 22px;
  border-radius: 9999px;
  background: #f1f5f9;
  color: #475569;
  font-size: 17px;
  line-height: 1;
  transition: transform .15s ease, background-color .15s ease, color .15s ease;
}
.suggestion-total-row.open .chevron {
  transform: rotate(90deg);
  background: #e2e8f0;
  color: #334155;
}

.package-option {
    width: 100%;
    padding: 10px 15px;
    border: none;
    background: none;
    text-align: left;
    cursor: pointer;
    font-size: 14px;
    color: #333;
    transition: background 0.2s ease;
}

.package-option:hover {
    background: #f8f9fa;
}

.package-option:not(:last-child) {
    border-bottom: 1px solid #eee;
}

#suggestionBox{
  width: 400px !important;
}



/* Allow text selection in the line items table */
#lineItemsTableContainer,
#lineItemsTableContainer * {
  user-select: text !important;
}

/* iOS Touch Screen Improvements */
#lineItemsTableContainer {
  -webkit-overflow-scrolling: touch; /* Smooth momentum scrolling on iOS */
  overflow-x: auto;
  overflow-y: visible;
  touch-action: pan-x pan-y; /* Allow scrolling in both directions */
}

#lineItemsTableContainer table {
  touch-action: manipulation; /* Improve tap response */
}

#lineItemsTableContainer input,
#lineItemsTableContainer textarea,
#lineItemsTableContainer button {
  touch-action: manipulation; /* Prevent zoom on double tap */
  -webkit-touch-callout: none; /* Disable callout on long press */
  -webkit-user-select: text; /* Allow text selection */
  user-select: text; /* Standard property for compatibility */
  min-height: 44px; /* iOS recommended minimum touch target */
  font-size: 16px; /* Prevent zoom on focus in iOS Safari */
}

#lineItemsTableContainer .drag-handle,
#lineItemsTableContainer .drag-handle-group {
  touch-action: none; /* Allow drag functionality */
  -webkit-touch-callout: none;
}

/* iOS specific table row touch improvements */
#lineItemsTableContainer tr {
  touch-action: manipulation;
  -webkit-touch-callout: none;
}

#lineItemsTableContainer td {
  touch-action: manipulation;
  -webkit-touch-callout: none;
  -webkit-tap-highlight-color: rgba(0,0,0,0.1);
}

/* Ensure inputs/textareas in table cells work on iOS */
#lineItemsTableContainer td input,
#lineItemsTableContainer td textarea {
  touch-action: manipulation !important;
  -webkit-appearance: none;
  appearance: none;
  border-radius: 4px;
  background-color: #fff;
}

.edit-icon {
  float: right;
  margin-left: 10px;
  cursor: pointer;
  font-size: 16px;
  color: #007bff;
}


/* Only allow drag handle to block touch, not the whole row */
.drag-handle, .drag-handle-group {
  touch-action: none !important;
  -webkit-user-select: none !important;
  user-select: none !important;
}

tbody tr, tbody td {
  touch-action: manipulation !important;
  -webkit-user-select: text !important;
  user-select: text !important;
}

/* Add or update in your <style> */
.drag-handle-group {
  cursor: grab;
  font-size: 19px;
  display: inline-block;
  user-select: none !important;
  -webkit-user-select: none !important;
  touch-action: none !important;
}


.drag-handle {
  cursor: grab;
  display: inline-block;
  user-select: none !important;
  -webkit-user-select: none !important;
  touch-action: none !important;
}

.drag-handle.active-drag-handle {
  background: #dbeafe !important;
  box-shadow: 0 0 0 2px #3b82f6;
}

.drag-handle-group.active-drag-handle {
  background: #dbeafe !important;
  box-shadow: 0 0 0 2px #3b82f6;
}

/* Floating Label Styles */
.floating-label-group {
  position: relative;
  margin-bottom: 8px;
  display: inline-block;
  vertical-align: top;
}
.floating-label-group input,
.floating-label-group textarea {
  width: 100%;
  padding: 7px 2px 6px 2px;
  border: 1px solid #ccc;
  border-radius: 5px;
  background: #ffffff;
  font-size: 0.85rem;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}
.floating-label-group label {
  position: absolute;
  top: -2px;
  left: 12px;
  color: #64748b;
  background: #ffffff;
  font-size: 12px;
  pointer-events: none;
  transition: all 0.2s ease;
}
.floating-label-group input:focus + label,
.floating-label-group input.filled + label,
.floating-label-group textarea:focus + label,
.floating-label-group textarea.filled + label {
  top: -16px;
  left: 6px;
  font-size: 10px;
  color: #2563eb;
  background: #fff;
  padding: 0 4px;
  transition: all 0.25s cubic-bezier(.4,0,.2,1);
  border-radius: 25%;
}
.floating-label-group textarea {
  min-height: 36px;
  resize: vertical;
}
.floating-label-group {
  min-width: 60px;
  max-width: 160px;
}
.floating-label-group:last-child {
  min-width: 180px;
  max-width: 300px;
}


/* Add this CSS near your other table styles */
#lineItemsTableContainer tr:not(.category-group-row):not(.editing-row):hover {
  background: #e0f2fe !important;
  transition: background 0.18s;
  cursor: pointer;
}



  </style>
</head>
<body>
  <div class="container">
    

    <div class="sticky-header">
      <div class="header-title">BESF</div>
      <div class="dropdown">
        <button class="dropdown-btn">⋮ Actions</button>
<div class="dropdown-content">
  <a href="#" onclick="openQuotePreview()">📄 Preview Quote</a>
  <a href="#" onclick="saveQuote()">💾 Save Quote</a>
  <a href="#" onclick="openQuoteHistory()">📜 Quote History</a>
  <a href="#" onclick="openLaborCostModal()">📜 Labor cost list</a>
  <a href="/quotes.html" style="color: #dc3545;">❌ Cancel</a>
</div>
      </div>
    </div>
    
    <div class="quote-meta-grid">
    <div class="section section-from">
      <h3>Quote From</h3>
      <input id="fromName" placeholder="Company Name" />
      <input id="fromAddress" placeholder="Address" />
      <input id="fromEmail" placeholder="Email" />
      <input id="fromPhone" placeholder="Phone Number" />
      <input id="fromLicense" placeholder="License #" />
    </div>
    
    <div class="section section-to">
      <h3>Quote To</h3>
      <input id="toName" placeholder="Customer Name" oninput="showClientSuggestions()" />
<div id="clientSuggestionBox" style="position: absolute; background: white; border: 1px solid #ccc; border-radius: 6px; z-index: 1000; display: none; max-height: 150px; overflow-y: auto;"></div>
<input 
id="toAddress" 
placeholder="Address (0000 Street, City, ST ZIP)" 
onfocus="initAutocomplete()" 
autocomplete="off" 
/>
<span id="addressError" style="color: red; display: none;">Invalid address format. Please use: Street, City, ST ZIP</span>

      <input id="toEmail" placeholder="Email" />
      <input id="toPhone" placeholder="Phone Number" />
    </div>

    <div class="section section-dates">
      <div class="field">
        <label for="quoteNumber">Quote Number:</label>
        <input id="quoteNumber" placeholder="e.g. Q-20250401" readonly />
      </div>

      <div class="field">
        <label for="quoteDate">Date:</label>
        <input type="date" id="quoteDate" />
      </div>

      <div class="field">
        <label for="validTill">Valid Till:</label>
        <input type="date" id="validTill" />
      </div>
    </div>

    </div>

    <div class="section">
      <h3>Line Items</h3>
      <div class="line-item-row">
        <!-- Combined compact section: first row = fields, second row = description + add -->
        <div style="display:flex; gap:0px; width:100%; flex-wrap:wrap; align-items:flex-start;">
          <div style="flex:1 1 680px; display:flex; gap:0px; align-items:center;">
            <div style="display:flex; gap:20px; align-items:center; flex-wrap:wrap;">
              <div class="floating-label-group"><input id="itemCode" style="width:105px" /><label for="itemCode">Cost Code</label></div>
              <div class="floating-label-group" style="min-width:220px; flex:1;"><input id="itemName" /><label for="itemName">Item Name</label></div>
              <div class="floating-label-group"><input id="itemQty" type="number" style="width:60px" /><label for="itemQty">Qty</label></div>
              <div class="floating-label-group"><input id="itemRate" type="number" style="width:70px" /><label for="itemRate">Rate</label></div>
              <div class="floating-label-group" style="display:flex;align-items:center;gap:6px;">
                <div style="position:relative;display:inline-block;">
                  <input id="markup" type="number" step="any" min="0" max="60" style="width:75px" />
                  <label for="markup">Markup</label>
                </div>
                <button type="button" id="markupToggle" onclick="toggleAddMarkupMode()" title="Toggle %/$" style="padding:4px 6px;border:1px solid #cbcdd0;border-radius:6px;background:#fff;cursor:pointer;">%</button>
              </div>
              <div class="floating-label-group"><input id="laborRate" type="number" step="any" style="width:80px" /><label for="laborRate">Labor</label></div>
              <div class="floating-label-group" style="display:none;"><input id="laborHours" type="number" step="any" style="width:90px" value="1" /><label for="laborHours">Labor Qty</label></div>
              <div class="floating-label-group"><input id="materialRate" type="number" step="any" style="width:80px" /><label for="materialRate">Material</label></div>
              <div class="floating-label-group" style="display:none;"><input id="materialQty" type="number" step="any" style="width:110px" value="1" /><label for="materialQty">Material Qty</label></div>
            </div>
          </div>

        <div style="display:flex; gap:0px; width:100%; margin-top:2px; align-items:flex-start;">
          <div style="flex:1;">
            <div class="floating-label-group"><textarea id="itemDesc" style="width:420%; min-height:50px; resize:vertical;" rows="1"></textarea><label for="itemDesc">Description</label></div>
          </div>
          <div style="width:120px; display:flex; align-items:flex-end;">
            <button class="btn" style="width:53%; margin-left: 48px;" onclick="addLineItem()">Add</button>
          </div>
        </div>
        <div id="suggestionBox" style="position: absolute; background: #fff; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 1000; display: none; max-height: 350px; overflow-y: auto;"></div>
      </div>
    </div>

      <div class="table-responsive-sm">
        
        <div id="lineItemsTableContainer"></div>
      </div>
      
      

    <div class="section">
      <label>Notes:</label>
      <textarea id="quoteNotes" rows="4"></textarea>
    </div>

    <div class="section">
      <label>Discount ($):</label>
      <input type="number" id="inputDiscount" value="0" min="0" step="0.01" onchange="renderTable()" />

      <label>Tax Rate (%):</label>
      <input type="number" id="inputTax" value="0" min="0" step="0.01" onchange="renderTable()" />
    </div>

    <div class="summary-box">
      <div id="totalsPanel" class="totals-panel">
        <div class="t-row"><span class="label">Subtotal</span><span class="value">$<span id="subtotal">0.00</span></span></div>
        <div class="t-row"><span class="label">Markup</span><span class="value">$<span id="markupTotal">0.00</span></span></div>
        <div class="t-row"><span class="label">Discount</span><span class="value">$<span id="discount">0.00</span></span></div>
        <div class="t-row"><span class="label">Tax</span><span class="value">$<span id="tax">0.00</span></span></div>
        <div class="divider"></div>
        <div class="t-row grand"><span class="label">Total</span><span class="value">$<span id="grandTotal">0.00</span></span></div>
      </div>
    </div>

    <div class="payment-terms">
      <h3>Payment Terms</h3>
      <p>The total project amount shall be paid in the following phases:</p>
      <ul style="margin-top: 10px; padding-left: 20px;">
        <li><strong>30%</strong> at project start</li>
        <li><strong>30%</strong> at 50% project completion</li>
        <li><strong>30%</strong> at 75% project completion</li>
        <li><strong>10%</strong> at final completion</li>
      </ul>
      <p style="margin-top: 10px;">Each payment is due within 7 days of invoice unless otherwise agreed in writing. Late payments may be subject to additional fees.</p>
    </div>
    

    <div class="signature-block">
      <h3>Agreement</h3>
      <p>If you accept this quote, please sign and return.</p>
      <label>Client Name:</label>
      <input type="text" id="signatureClientName" placeholder="Client Full Name" />
      <label>Signature:</label>
      <input type="text" placeholder="Client Signature" />
      <label>Date:</label>
      <input type="date" />
    </div>
  </div>

  <div id="quoteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Quote Preview</h3>
        <span class="close-modal" onclick="closeQuotePreview()">&times;</span>
      </div>
      <div id="quotePreviewContent"></div>
      <div class="modal-footer">
        <button class="btn no-print" onclick="printQuotePreview()">🖨️ Print</button>
        <button class="btn no-print" onclick="shareQuotePreview()">🔗 Share</button>
      </div>
    </div>
  </div>

<!-- Quote History Modal -->
<div id="quoteHistoryModal" class="modal">
  <div class="modal-content">
    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin: 0; font-size: 1.2rem;">📜 Quote History</h3>
      <span class="close-modal" onclick="closeQuoteHistory()" style="font-size: 24px; cursor: pointer;">&times;</span>
    </div>

    <div class="history-controls" style="margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap;">
      <input type="text" id="searchInput" placeholder="Search by name or number..." oninput="renderQuoteHistory()" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
      <select id="filterSelect" onchange="renderQuoteHistory()" style="padding: 8px; border-radius: 6px; border: 1px solid #ccc;">
        <option value="all">All</option>
        <option value="today">Today</option>
        <option value="week">This Week</option>
        <option value="month">This Month</option>
      </select>
    </div>

    <ul id="quoteHistoryList" style="list-style: none; padding: 0; margin-top: 15px;">
      <!-- Dynamically filled -->
    </ul>

    <div class="pagination" id="paginationControls" style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;"></div>
  </div>
</div>


  <!-- Quote Detail Modal -->
  <div id="quoteDetailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Quote Details</h3>
        <div style="display: flex; gap: 10px; align-items: center;">
          <div class="dropdown">
            <button class="dropdown-btn">⋯</button>
            <div class="dropdown-content">
              <a href="#" onclick="printQuoteDetail()">🖨️ Print</a>
              <a href="#" onclick="shareQuoteDetail()">🔗 Share</a>
              <a href="#" onclick="deleteQuoteDetail()">🗑️ Delete</a>
            </div>
          </div>
          <span class="close-modal" onclick="closeQuoteDetail()">&times;</span>
        </div>
      </div>
      <div id="quoteDetailContent"></div>
    </div>
  </div>

<!-- Suggested Labor Cost List Modal -->
<div id="laborCostModal" class="modal labor-toolbar">

  <div class="modal-content">
    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
      <h3>Labor Cost Suggestions</h3>
      <span class="close-modal" onclick="closeLaborCostModal()" style="font-size: 24px; cursor: pointer;">&times;</span>
    </div>

       <!-- Add Room Packages Section -->
<!-- Replace the existing room-packages-section in the laborCostModal div -->
<div class="room-packages-section">
    <div class="package-dropdown">
        <div class="package-header-row">
          <button class="package-select-btn" onclick="togglePackageDropdown()">
              🏗️ Add Room Package
              <span class="dropdown-arrow">▼</span>
          </button>
          <span class="add-labor-inline-btn" title="Add new labor cost" onclick="toggleNewLaborForm()">＋</span>
        </div>
<div id="packageDropdownContent" class="package-dropdown-content">
       <button onclick="addRoomPackage('exterior')" class="package-option">
        🏡 Exterior Overall Remodel Package
        <span class="edit-icon" onclick="event.stopPropagation(); openEditRoomPackageModal('exterior')">✏️</span>
    </button> 
      <button onclick="addRoomPackage('interior')" class="package-option">
        🏠 Interior Overall Remodel Package
        <span class="edit-icon" onclick="event.stopPropagation(); openEditRoomPackageModal('interior')">✏️</span>
    </button>
    <button onclick="addRoomPackage('kitchen')" class="package-option">
        🏘️ Kitchen Remodel Package
        <span class="edit-icon" onclick="event.stopPropagation(); openEditRoomPackageModal('kitchen')">✏️</span>
    </button>
      <button onclick="addRoomPackage('mainbathroom')" class="package-option">
        🛁 Main Bathroom Remodel Package
        <span class="edit-icon" onclick="event.stopPropagation(); openEditRoomPackageModal('mainbathroom')">✏️</span>
    </button>
    <button onclick="addRoomPackage('bathroom')" class="package-option">
        🚽 Bathroom Remodel Package
        <span class="edit-icon" onclick="event.stopPropagation(); openEditRoomPackageModal('bathroom')">✏️</span>
    </button> 
    <button onclick="addRoomPackage('mainbedroom')" class="package-option">
  🛏️ Main Bedroom Package
  <span class="edit-icon" onclick="event.stopPropagation(); openEditRoomPackageModal('mainbedroom')">✏️</span>
</button>
<button onclick="addRoomPackage('bedroom1')" class="package-option">
  🛏️ Bedroom 1 Package
  <span class="edit-icon" onclick="event.stopPropagation(); openEditRoomPackageModal('bedroom1')">✏️</span>
</button>
<button onclick="addRoomPackage('bedroom2')" class="package-option">
  🛏️ Bedroom 2 Package
  <span class="edit-icon" onclick="event.stopPropagation(); openEditRoomPackageModal('bedroom2')">✏️</span>
</button>
<button onclick="addRoomPackage('bedroom3')" class="package-option">
  🛏️ Bedroom 3 Package
  <span class="edit-icon" onclick="event.stopPropagation(); openEditRoomPackageModal('bedroom3')">✏️</span>
</button>
            <!-- Add more package options here -->
        </div>
    </div>
</div>

    <input type="text" id="laborSearchInput" placeholder="Search labor task..." oninput="renderLaborSuggestions()" style="width: 100%; padding: 8px; margin: 10px 0;">
  <ul id="laborSuggestionList" style="list-style: none; padding: 0; max-height: 420px; overflow-y: auto;"></ul>
  <div id="laborSuggestionsFooter" class="totals-footer">
    <div class="t-row"><span class="label">Markup</span><span class="value">$<span id="suggestionsMarkupTotal">0.00</span></span></div>
    <div class="t-row grand"><span class="label">Total</span><span class="value">$<span id="suggestionsGrandTotal">0.00</span></span></div>
  </div>
  <div id="newLaborFormContainer" style="margin-top: 10px; display: none;">
          <input id="newLaborCode" placeholder="Cost Code" style="width: 100%; padding: 8px; margin-top: 10px;" />
          <input id="newLaborName" placeholder="Task Name" style="width: 100%; padding: 8px; margin-top: 10px;" />
          <input id="newLaborDesc" placeholder="Description" style="width: 100%; padding: 8px; margin-top: 10px;" />
          <input id="newLaborLaborRate" type="number" placeholder="Labor Rate ($/hr or unit)" step="0.01" style="width: 100%; padding: 8px; margin-top: 10px;" />
          <!-- hide new labor qty; default to 1 -->
          <input id="newLaborLaborHours" type="number" placeholder="Labor Hours/Units" step="0.01" value="1" style="width: 100%; padding: 8px; margin-top: 10px; display:none;" />
          <input id="newLaborMaterialRate" type="number" placeholder="Material Rate ($/unit)" step="0.01" style="width: 100%; padding: 8px; margin-top: 10px;" />
          <!-- hide new material qty; default to 1 -->
          <input id="newLaborMaterialQty" type="number" placeholder="Material Qty" step="0.01" value="1" style="width: 100%; padding: 8px; margin-top: 10px; display:none;" />
          <input id="newBaseRate" type="number" placeholder="Base Rate (manual)" step="0.01" style="width: 100%; padding: 8px; margin-top: 10px;" />
          <div style="display:flex; gap:8px; align-items:center; margin-top:10px;">
            <input id="newLaborMarkup" type="number" placeholder="Markup" step="0.01" min="0" style="width: 100%; padding: 8px;" />
            <button id="newMarkupToggle" type="button" title="Toggle %/$" style="padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;background:#fff;cursor:pointer;" data-mode="percent">%</button>
          </div>
          <select id="newLaborCalcMode" style="width: 100%; padding: 8px; margin-top: 10px;">
            <option value="each">Each</option>
            <option value="sqft">SqFt</option>
            <option value="lnft">LnFt</option>
            <option value="hour">Hour</option>
          </select>
          <input id="newLaborUnit" placeholder="Unit (e.g. ft, hr, ea)" style="width: 100%; padding: 8px; margin-top: 10px;" />
          <div style="margin: 10px 0; color: #2563eb;">
            <div>Labor Cost: <span id="newLaborLaborCost">0.00</span></div>
            <div>Material Cost: <span id="newLaborMaterialCost">0.00</span></div>
            <div><b>Total Cost: <span id="newLaborTotalCost">0.00</span></b></div>
          </div>
          <button onclick="addLaborItem()" style="margin-top: 10px;" class="btn">Add Labor Item</button>
  </div>
      </div>
    </div>


<!-- Edit Labor Item Modal -->
 <div id="editLaborModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Edit Labor Item</h3>
          <span class="close-modal" onclick="closeEditLaborModal()" style="font-size: 24px; cursor: pointer;">&times;</span>
        </div>
        <div style="margin-top: 10px;">
          <input id="editLaborCode" placeholder="Cost Code" style="width: 100%; padding: 8px; margin-bottom: 10px;" />
          <input id="editLaborName" placeholder="Task Name" style="width: 100%; padding: 8px; margin-bottom: 10px;" />
          <textarea id="editLaborDesc" placeholder="Description"
            style="width: 100%; padding: 8px; margin-bottom: 10px; resize: vertical; min-height: 80px; overflow-y: hidden;"
            oninput="autoResizeTextarea(this)"></textarea>
          <input id="editLaborLaborRate" type="number" placeholder="Labor Rate ($/hr or unit)" step="0.01" style="width: 100%; padding: 8px; margin-bottom: 10px;" />
          <!-- hide labor hours in modal; default to 1 -->
          <input id="editLaborLaborHours" type="number" placeholder="Labor Hours/Units" step="0.01" value="1" style="width: 100%; padding: 8px; margin-bottom: 10px; display:none;" />
          <input id="editLaborMaterialRate" type="number" placeholder="Material Rate ($/unit)" step="0.01" style="width: 100%; padding: 8px; margin-bottom: 10px;" />
          <!-- hide material qty in modal; default to 1 -->
          <input id="editLaborMaterialQty" type="number" placeholder="Material Qty" step="0.01" value="1" style="width: 100%; padding: 8px; margin-bottom: 10px; display:none;" />
          <input id="editBaseRate" type="number" placeholder="Base Rate (manual)" step="0.01" style="width: 100%; padding: 8px; margin-bottom: 10px;" />
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px;">
            <input id="editLaborMarkup" type="number" placeholder="Markup" step="0.01" min="0" style="width: 100%; padding: 8px;" />
            <button id="editMarkupToggle" type="button" title="Toggle %/$" style="padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;background:#fff;cursor:pointer;" data-mode="percent">%</button>
          </div>
          <select id="editLaborCalcMode" style="width: 100%; padding: 8px; margin-bottom: 10px;">
            <option value="each">Each</option>
            <option value="sqft">SqFt</option>
            <option value="lnft">LnFt</option>
            <option value="hour">Hour</option>
          </select>
          <input id="editLaborUnit" placeholder="Unit (e.g. ft, hr, ea)" style="width: 100%; padding: 8px; margin-bottom: 10px;" />
          <div style="margin: 10px 0; color: #2563eb;">
            <div>Labor Cost: <span id="editLaborLaborCost">0.00</span></div>
            <div>Material Cost: <span id="editLaborMaterialCost">0.00</span></div>
            <div>Markup: <span id="editLaborMarkupDisplay">0.00%</span></div>
            <div><b>Total Cost: <span id="editLaborTotalCost">0.00</span></b></div>
          </div>
          <button onclick="saveEditedLaborItem()" class="btn" style="margin-top: 10px;">Save Changes</button>
        </div>
  </div>
</div>


<div id="editRoomPackageModal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <div class="modal-header">
      <h3>Edit Room Package</h3>
      <span class="close-modal" onclick="closeEditRoomPackageModal()" style="font-size: 24px; cursor: pointer;">&times;</span>
    </div>
    <div id="editRoomPackageContent"></div>
    <div style="margin-top: 20px;">
      <input id="laborSearchForPackage" placeholder="Search labor task..." style="width: 100%; padding: 8px; margin-bottom: 10px;" oninput="renderLaborSuggestionsForPackage()" />
      <ul id="laborSuggestionListForPackage" style="list-style: none; padding: 0; max-height: 200px; overflow-y: auto;"></ul>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="saveRoomPackageEdits()">Save Changes</button>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" style="
  position: fixed;
  top: 30px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(to right, #0ea5e9, #3b82f6);
  color: white;
  padding: 14px 24px;
  border-radius: 8px;
  display: none;
  z-index: 9999;
  font-weight: 500;
  font-size: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  transition: opacity 0.3s ease, transform 0.3s ease;
  pointer-events: none;
"></div>


<!-- Loader Spinner -->
<div id="loader" style="
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(2px);
  z-index: 9999;
  display: none;
  justify-content: center;
  align-items: center;
">
  <div style="
    border: 5px solid #e5e7eb;
    border-top: 5px solid #3b82f6;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    animation: spin 0.8s linear infinite;
  "></div>
</div>


<style>
/* Loader Spinner Animation */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCvzkKpCkAY2PHwU8I8zZiM_FLMzMj1bbg&libraries=places"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>

    window.onload = () => {
      document.getElementById("fromName").value = "BESF LLC";
      document.getElementById("fromAddress").value = "7 CYPRESS POINT CT";
      document.getElementById("fromEmail").value = "besfllc@gmail.com";
      document.getElementById("fromPhone").value = "7252603319";
      document.getElementById("fromLicense").value = "RBC-2400049";


      const today = new Date();
      const yyyyMMdd = today.toISOString().split('T')[0];
      document.getElementById("quoteDate").value = yyyyMMdd;

      const datePart = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
      const randomPart = Math.floor(1000 + Math.random() * 9000);
      const quoteNumber = `Q-${randomPart}-${datePart}`;
      document.getElementById("quoteNumber").value = quoteNumber;

      loadQuoteHistory();
      fetchLaborSuggestions()
      fetchClients();
      loadRoomPackages();





        // Enable suggestions on item name input
  document.getElementById('itemName').addEventListener('input', showLaborSuggestions);

  // --- Recalculate total when labor/material fields or explicit rate change ---
function recalcLineItemTotal() {
  const laborRate = parseFloat(document.getElementById('laborRate').value) || 0;
  let laborHours = parseFloat(document.getElementById('laborHours').value);
  if (!laborHours || isNaN(laborHours)) laborHours = 1;
  const materialRate = parseFloat(document.getElementById('materialRate').value) || 0;
  let materialQty = parseFloat(document.getElementById('materialQty').value);
  if (!materialQty || isNaN(materialQty)) materialQty = 1;
  const markup = parseFloat(document.getElementById('markup').value) || 0;
  const itemRateEl = document.getElementById('itemRate');
  const itemQtyEl = document.getElementById('itemQty');
  const markupToggle = document.getElementById('markupToggle');
  let markupMode = 'percent';
  if (markupToggle && markupToggle.dataset && markupToggle.dataset.mode) {
    markupMode = markupToggle.dataset.mode;
  } else if (markupToggle) {
    markupMode = markupToggle.textContent.trim() === '$' ? 'amount' : 'percent';
    markupToggle.dataset.mode = markupMode;
  }

  // Use breakdown if labor/material present, else manual rate
  const breakdownHasNonZero = (laborRate !== 0 || materialRate !== 0);

  let totalWithMarkup = 0;
  if (breakdownHasNonZero) {
    const baseTotal = (laborRate * laborHours) + (materialRate * materialQty);
    totalWithMarkup = (markupMode === 'amount')
      ? baseTotal + markup
      : baseTotal * (1 + markup / 100);
    // Update itemRate input to show computed price from breakdown and mark it as auto-filled
    if (itemRateEl) {
      itemRateEl.value = baseTotal;
      try { itemRateEl.dataset.autofill = '1'; } catch (_) {}
    }
  } else if (itemRateEl && itemRateEl.value !== '') {
    const base = parseFloat(itemRateEl.value) || 0;
    totalWithMarkup = (markupMode === 'amount')
      ? base + markup
      : base * (1 + markup / 100);
  } else {
    totalWithMarkup = 0;
  }

  // Optionally update the live total preview
  const qty = parseInt(itemQtyEl?.value) || 0;
  let totalPreview = document.getElementById('lineTotalPreview');
  if (!totalPreview) {
    totalPreview = document.createElement('div');
    totalPreview.id = 'lineTotalPreview';
    totalPreview.style.marginTop = '6px';
    totalPreview.style.fontSize = '14px';
    const container = document.querySelector('.line-item-row') || document.body;
    container.appendChild(totalPreview);
  }
  totalPreview.textContent = `Total: $${(totalWithMarkup * qty).toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
}

  // Listen to breakdown inputs + explicit rate and qty so preview updates live
  // Expose the recalc helper to global scope so other handlers (suggestions) can call it
  try { window.recalcLineItemTotal = recalcLineItemTotal; } catch(_) {}
  ['laborRate','laborHours','materialRate','materialQty','markup','itemQty'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('input', recalcLineItemTotal);
  });
  // For itemRate, treat typing as a user action that clears auto-fill marker
  const itemRateEl = document.getElementById('itemRate');
  if (itemRateEl) {
    itemRateEl.addEventListener('input', function onItemRateInput(e) {
      try { delete this.dataset.autofill; } catch (_) { this.removeAttribute && this.removeAttribute('data-autofill'); }
      // then update preview
      try { recalcLineItemTotal(); } catch (_) {}
    });
  }
    };

    document.getElementById('itemName').addEventListener('input', showLaborSuggestions);

  function showLaborSuggestions() {
  const input = document.getElementById('itemName');
  const value = input.value.toLowerCase();
  const box = document.getElementById('suggestionBox');
  box.innerHTML = '';

  if (!value) return (box.style.display = 'none');

  const matches = laborCostList.filter(item =>
    item.name.toLowerCase().includes(value)
  );

  if (matches.length === 0) return (box.style.display = 'none');

  matches.forEach(item => {
    const lr = Number(item.laborRate) || 0;
    const mr = Number(item.materialRate) || 0;
    const lh = lr ? ((Number(item.laborHours) || 1)) : (Number(item.laborHours) || 0);
    const mq = mr ? ((Number(item.materialQty) || 1)) : (Number(item.materialQty) || 0);
    const hasBreakdown = (lr || mr);
    const laborCost = hasBreakdown ? (lr * lh) : (Number(item.baseRate) || 0);
    const materialCost = hasBreakdown ? (mr * mq) : 0;
    const mk = Number(item.markup) || 0;
    const mode = item.markupMode || 'percent';
    const totalCost = item.totalCost ?? (mode === 'amount' ? (laborCost + materialCost + mk) : ((laborCost + materialCost) * (1 + mk / 100)));
    const option = document.createElement('div');
    option.innerHTML = `
      <div style="font-weight:600;">${item.name}</div>
      <div style="font-size: 11px; color: #555; margin-top: 2px;">
        ${item.description || "No description"}
      </div>
      <div style="font-size: 11px; color: #f96302; margin-top: 2px;">
        Labor: $${laborCost.toFixed(2)} ${hasBreakdown ? `(${lr} × ${lh})` : `(manual)`}
      </div>
      <div style="font-size: 11px; color: #16a34a; margin-top: 2px;">
        Material: $${materialCost.toFixed(2)} ${hasBreakdown ? `(${mr} × ${mq})` : `(—)`}
      </div>
      <div style="font-size: 11px; color: #7c3aed; margin-top: 2px;">
        Markup: ${mode === 'amount' ? `$${mk.toFixed(2)}` : `${mk.toFixed(2)}%`}
      </div>
      <div style="font-size: 11px; color: #007bff; margin-top: 2px;">
        <b>Total:</b> $${totalCost.toFixed(2)} <span style="color:#64748b;font-size:11px;">[${item.calcMode || 'each'}${item.unit ? ', ' + item.unit : ''}]</span>
      </div>
    `;
    option.style.padding = '8px';
    option.style.cursor = 'pointer';
    option.style.borderBottom = '1px solid #eee';

    option.onmouseenter = () => (option.style.background = '#f1f5f9');
    option.onmouseleave = () => (option.style.background = '#fff');

    option.onclick = () => {
      document.getElementById('itemName').value = item.name;
      document.getElementById('itemDesc').value = item.description;
      // Apply markup value and mode
      const markupEl = document.getElementById('markup');
      if (markupEl) markupEl.value = (Number(item.markup) || 0);
      const markupToggle = document.getElementById('markupToggle');
      if (markupToggle) {
        const mm = item.markupMode || 'percent';
        markupToggle.dataset.mode = mm;
        markupToggle.textContent = (mm === 'amount') ? '$' : '%';
      }
      if (document.getElementById('itemCode')) {
        document.getElementById('itemCode').value = item.costCode || '';
      }
      // Fill according to breakdown vs manual base
      const rateInput = document.getElementById('itemRate');
      if (lr || mr) {
        // breakdown path - set breakdown fields and show base in rate (autofill)
        document.getElementById('laborRate').value = (item.laborRate ?? '')
        document.getElementById('laborHours').value = (item.laborHours != null && item.laborHours !== 0) ? item.laborHours : '1';
        document.getElementById('materialRate').value = (item.materialRate ?? '')
        document.getElementById('materialQty').value = (item.materialQty != null && item.materialQty !== 0) ? item.materialQty : '1';
        const base = (lr * lh) + (mr * mq);
        if (rateInput) { rateInput.value = base; try { rateInput.dataset.autofill = '1'; } catch(_){} }
      } else {
        // manual path - clear breakdown, set baseRate into rate
        document.getElementById('laborRate').value = '';
        document.getElementById('laborHours').value = '1';
        document.getElementById('materialRate').value = '';
        document.getElementById('materialQty').value = '1';
        if (rateInput) { rateInput.value = (Number(item.baseRate) || 0); try { delete rateInput.dataset.autofill; } catch(_){} }
      }
      // Save suggestion context for addLineItem
      window.lastLaborSuggestion = {
        laborRate: item.laborRate,
        laborHours: item.laborHours,
        materialRate: item.materialRate,
        materialQty: item.materialQty,
        baseRate: Number(item.baseRate) || 0,
        markup: Number(item.markup) || 0,
        markupMode: item.markupMode || 'percent'
      };
      // Update live preview based on current fields (use global export if available)
      try { if (typeof window.recalcLineItemTotal === 'function') window.recalcLineItemTotal(); else if (typeof recalcLineItemTotal === 'function') recalcLineItemTotal(); } catch (_) {}
      // Refresh floating labels after auto-fill
      if (typeof updateFloatingLabels === 'function') updateFloatingLabels();
      box.style.display = 'none';
    };

    box.appendChild(option);
  });

  // Position it below the input
  const rect = input.getBoundingClientRect();
  box.style.top = `${input.offsetTop + input.offsetHeight}px`;
  box.style.left = `${input.offsetLeft}px`;
  box.style.width = `${input.offsetWidth}px`;
  box.style.display = 'block';
}



// Hide box when clicking outside
document.addEventListener('click', e => {
  if (!document.getElementById('suggestionBox').contains(e.target) &&
      e.target !== document.getElementById('itemName')) {
    document.getElementById('suggestionBox').style.display = 'none';
  }
});

function formatCurrency(value) {
  return `$${parseFloat(value).toLocaleString(undefined, {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  })}`;
}


function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.style.display = 'block';
  setTimeout(() => { toast.style.display = 'none'; }, 2500);
}

function showLoader() {
  document.getElementById('loader').style.display = 'flex';
}

function hideLoader() {
  document.getElementById('loader').style.display = 'none';
}

let roomPackages = {};
let editingPackageKey = null;
let editingPackageItems = [];
let clientList = [];


async function loadRoomPackages() {
  try {
    const res = await fetch('/api/room-packages');
    const pkgs = await res.json();
    roomPackages = {};
    pkgs.forEach(pkg => {
      roomPackages[pkg.key] = { name: pkg.name, items: pkg.items };
    });
  } catch (err) {
    showToast('Failed to load room packages');
  }
}

async function fetchClients() {
  showLoader(); // 👈 START
  try {
    const res = await fetch('/api/clients');
    clientList = await res.json();
  } catch (err) {
    console.error('Failed to fetch clients:', err);
  } finally {
    hideLoader(); // 👈 END
  }
}

function showClientSuggestions() {
  const input = document.getElementById('toName');
  const box = document.getElementById('clientSuggestionBox');
  const value = input.value.toLowerCase();
  box.innerHTML = '';

  if (!value) return box.style.display = 'none';

  const matches = clientList.filter(client => client.name.toLowerCase().includes(value));

  if (matches.length === 0) return box.style.display = 'none';

  matches.forEach(client => {
    const option = document.createElement('div');
    option.textContent = client.name;
    option.style.padding = '8px';
    option.style.cursor = 'pointer';
    option.onmouseenter = () => option.style.background = '#f0f0f0';
    option.onmouseleave = () => option.style.background = '#fff';

option.onclick = () => {
  const capitalizedName = capitalizeClientName(client.name);
  document.getElementById('toName').value = capitalizedName;
  document.getElementById('toAddress').value = client.address;
  document.getElementById('toEmail').value = client.email;
  document.getElementById('toPhone').value = client.phone;
  document.getElementById('signatureClientName').value = capitalizedName;
  box.style.display = 'none';
};

    box.appendChild(option);
  });

  const rect = input.getBoundingClientRect();
  box.style.top = `${input.offsetTop + input.offsetHeight}px`;
  box.style.left = `${input.offsetLeft}px`;
  box.style.width = `${input.offsetWidth}px`;
  box.style.display = 'block';
}

document.addEventListener('click', e => {
  if (!document.getElementById('clientSuggestionBox').contains(e.target) &&
      e.target !== document.getElementById('toName')) {
    document.getElementById('clientSuggestionBox').style.display = 'none';
  }
});

function capitalizeClientName(name) {
  return name.replace(/\b\w/g, c => c.toUpperCase());
}


  document.getElementById('toName').addEventListener('input', function(e) {
  const caret = this.selectionStart;
  this.value = capitalizeClientName(this.value);
  this.setSelectionRange(caret, caret); // keep caret position
});


function autoResizeTextarea(textarea) {
  textarea.style.height = 'auto'; // Reset
  textarea.style.height = textarea.scrollHeight + 'px'; // Grow to fit content
}




let autocomplete;

function initAutocomplete() {
  const addressInput = document.getElementById("toAddress");

  autocomplete = new google.maps.places.Autocomplete(addressInput, {
    types: ["address"],
    componentRestrictions: { country: "us" },
    fields: ["address_components", "formatted_address"],
  });

  autocomplete.addListener("place_changed", () => {
    const place = autocomplete.getPlace();
    if (!place.address_components) return;

    const formattedAddress = formatAddressComponents(place.address_components);
    addressInput.value = formattedAddress;

    validateAddress(formattedAddress);
  });
}

function formatAddressComponents(components) {
  let street = "";
  let city = "";
  let state = "";
  let zip = "";

  components.forEach(component => {
    const types = component.types;

    if (types.includes("street_number")) {
      street = component.long_name;
    }
    if (types.includes("route")) {
      street += ` ${component.long_name}`;
    }
    if (types.includes("locality")) {
      city = component.long_name;
    }
    if (types.includes("administrative_area_level_1")) {
      state = component.short_name;
    }
    if (types.includes("postal_code")) {
      zip = component.long_name;
    }
  });

  return `${street}, ${city}, ${state} ${zip}`;
}

function validateAddress(address) {
  const pattern = /^(\d+\s+\w+(?:\s+\w+)*),\s*(\w+(?:\s+\w+)*),\s*([A-Z]{2})\s*(\d{5})$/;
  const errorSpan = document.getElementById('addressError');

  if (pattern.test(address)) {
    errorSpan.style.display = "none";
  } else {
    errorSpan.style.display = "block";
  }
}

function updateFloatingLabels() {
  document.querySelectorAll('.floating-label-group input, .floating-label-group textarea').forEach(function(el) {
    if (el.value) {
      el.classList.add('filled');
    } else {
      el.classList.remove('filled');
    }
  });
}
updateFloatingLabels();
document.querySelectorAll('.floating-label-group input, .floating-label-group textarea').forEach(function(el) {
  el.addEventListener('input', updateFloatingLabels);
  el.addEventListener('focus', updateFloatingLabels);
  el.addEventListener('blur', updateFloatingLabels);
});



let lineItems = [];



function toggleAddMarkupMode() {
  const btn = document.getElementById('markupToggle');
  if (!btn) return;
  // Toggle dataset.mode and button label
  const current = btn.dataset.mode === 'amount' ? 'amount' : 'percent';
  const next = current === 'amount' ? 'percent' : 'amount';
  btn.dataset.mode = next;
  btn.textContent = next === 'amount' ? '$' : '%';

  updateAddLineTotalPreview();
}

function updateAddLineTotalPreview() {
  const markupInput = document.getElementById('markup');
  const markupToggle = document.getElementById('markupToggle');
  let markupMode = 'percent';
  if (markupToggle && markupToggle.dataset && markupToggle.dataset.mode) {
    markupMode = markupToggle.dataset.mode;
  } else if (markupToggle) {
    // fallback: infer from button text
    markupMode = markupToggle.textContent.trim() === '$' ? 'amount' : 'percent';
    markupToggle.dataset.mode = markupMode;
  }

  const qty = parseFloat(document.getElementById('itemQty')?.value) || 1;
  const laborRate = parseFloat(document.getElementById('laborRate')?.value) || 0;
  const laborHours = parseFloat(document.getElementById('laborHours')?.value) || (laborRate ? 1 : 0);
  const materialRate = parseFloat(document.getElementById('materialRate')?.value) || 0;
  const materialQty = parseFloat(document.getElementById('materialQty')?.value) || (materialRate ? 1 : 0);
  const itemRateInput = document.getElementById('itemRate');
  const markup = parseFloat(markupInput?.value) || 0;

  let base = 0;
  // Use breakdown if labor/material present, else manual rate
  if (laborRate || materialRate) {
    base = (laborRate * laborHours) + (materialRate * materialQty);
  } else if (itemRateInput && itemRateInput.value) {
    base = parseFloat(itemRateInput.value) || 0;
  }

  let rate = base;
  if (markupMode === 'percent') {
    rate = base * (1 + markup / 100);
  } else {
    rate = base + markup;
  }

  // Update the preview
  let totalPreview = document.getElementById('lineTotalPreview');
  if (!totalPreview) {
    totalPreview = document.createElement('div');
    totalPreview.id = 'lineTotalPreview';
    totalPreview.style.marginTop = '6px';
    totalPreview.style.fontSize = '14px';
    document.querySelector('.line-item-row').appendChild(totalPreview);
  }
  totalPreview.textContent = `Total: $${(rate * qty).toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
}

function addLineItem() {
  const nameEl = document.getElementById('itemName');
  const descEl = document.getElementById('itemDesc');
  const qtyVal = parseFloat(document.getElementById('itemQty').value);
  const itemRateRaw = document.getElementById('itemRate').value;
  const costCode = document.getElementById('itemCode')?.value || '';
  const markup = parseFloat(document.getElementById('markup').value) || 0;
  const markupToggle = document.getElementById('markupToggle');
  const markupMode = markupToggle?.dataset?.mode || (markupToggle?.textContent.trim() === '$' ? 'amount' : 'percent');

  // Decide if user provided breakdown inputs (labor/material) explicitly.
  const breakdownProvided = (String(document.getElementById('laborRate')?.value || '').trim() !== '') || (String(document.getElementById('materialRate')?.value || '').trim() !== '');

  // If the user provided an explicit rate (and it wasn't auto-filled by recalc), treat it as explicit.
  const itemRateElForAdd = document.getElementById('itemRate');
  const wasAutoFilled = itemRateElForAdd && (itemRateElForAdd.dataset && itemRateElForAdd.dataset.autofill === '1');
  const explicitRateProvided = !wasAutoFilled && (itemRateRaw !== '' && !isNaN(parseFloat(itemRateRaw)));

  let laborRate, laborHours, materialRate, materialQty;
  if (breakdownProvided) {
    laborRate = Number(parseFloat(document.getElementById('laborRate').value) || 0);
    laborHours = Number(parseFloat(document.getElementById('laborHours').value));
    if (!laborHours || isNaN(laborHours)) laborHours = 1;
    materialRate = Number(parseFloat(document.getElementById('materialRate').value) || 0);
    materialQty = Number(parseFloat(document.getElementById('materialQty').value));
    if (!materialQty || isNaN(materialQty)) materialQty = 1;
    try { window.lastLaborSuggestion = null; } catch (_) {}
  } else if (explicitRateProvided) {
    laborRate = undefined;
    laborHours = undefined;
    materialRate = undefined;
    materialQty = undefined;
  } else {
    if (window.lastLaborSuggestion) {
      laborRate = Number(window.lastLaborSuggestion.laborRate) || 0;
      laborHours = Number(window.lastLaborSuggestion.laborHours) || 0;
      materialRate = Number(window.lastLaborSuggestion.materialRate) || 0;
      materialQty = Number(window.lastLaborSuggestion.materialQty) || 0;
      if (!document.getElementById('markup').value && window.lastLaborSuggestion.markup != null) {
        document.getElementById('markup').value = window.lastLaborSuggestion.markup;
      }
      try { window.lastLaborSuggestion = null; } catch (_) {}
    } else {
      laborRate = 0;
      laborHours = 1;
      materialRate = 0;
      materialQty = 1;
    }
  }

  // Validate required fields (name and qty)
  if (!nameEl.value || isNaN(qtyVal) || qtyVal <= 0) {
    [nameEl, document.getElementById('itemQty')].forEach(el => { if (el) el.style.borderColor = !el.value ? 'red' : '#ccc'; });
    showToast('Please enter item name and a valid quantity.');
    return;
  }

  // Determine rate: prefer explicit itemRate input, else compute from breakdown + markup
  let rate = 0;
  if (explicitRateProvided) {
    rate = parseFloat(itemRateRaw);
    if (markup && !isNaN(markup) && Number(markup) !== 0) {
      rate = (markupMode === 'amount') ? (rate + Number(markup)) : (rate * (1 + Number(markup) / 100));
    }
  } else {
    // If no explicit rate and no user-provided breakdown,
    // try to use lastLaborSuggestion's baseRate if present; otherwise compute from suggestion breakdown defaults.
    let base = 0;
    if (typeof laborRate === 'number' && typeof laborHours === 'number' && typeof materialRate === 'number' && typeof materialQty === 'number') {
      base = (Number(laborRate) || 0) * (Number(laborHours) || 0) + (Number(materialRate) || 0) * (Number(materialQty) || 0);
    }
    if (base === 0 && window.lastLaborSuggestion && (Number(window.lastLaborSuggestion.baseRate) || 0)) {
      base = Number(window.lastLaborSuggestion.baseRate) || 0;
    }
    rate = (markupMode === 'amount') ? (base + (Number(markup) || 0)) : (base * (1 + (Number(markup) || 0) / 100));
  }

  lineItems.push({
    costCode,
    name: nameEl.value,
    description: descEl.value || '',
    rate: Number(rate) || 0,
    qty: Number(qtyVal),
    markup: Number(markup) || 0,
  markupMode: markupMode,
  baseRate: (window.lastLaborSuggestion && Number(window.lastLaborSuggestion.baseRate)) || 0,
    laborRate: Number(laborRate) || 0,
    laborHours: Number(laborHours) || 0,
    materialRate: Number(materialRate) || 0,
    materialQty: Number(materialQty) || 0
  });

  renderTable();
  showToast('Line item added');

  // clear inputs
  nameEl.value = '';
  descEl.value = '';
  document.getElementById('itemRate').value = '';
  document.getElementById('markup').value = '';
  document.getElementById('itemQty').value = '';
  if (document.getElementById('itemCode')) document.getElementById('itemCode').value = '';
  document.getElementById('laborRate').value = '';
  document.getElementById('laborHours').value = '1';
  document.getElementById('materialRate').value = '';
  document.getElementById('materialQty').value = '1';

  if (typeof updateFloatingLabels === 'function') updateFloatingLabels();
  updateAddLineTotalPreview();
}

// --- Attach preview update to all relevant inputs and toggle ---
['itemRate', 'itemQty', 'markup', 'laborRate', 'laborHours', 'materialRate', 'materialQty'].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('input', updateAddLineTotalPreview);
});
const markupToggleBtn = document.getElementById('markupToggle');
if (markupToggleBtn) markupToggleBtn.addEventListener('click', updateAddLineTotalPreview);

// Initial preview
updateAddLineTotalPreview();

// 📏 Auto Expand for Description Textarea
const descField = document.getElementById('itemDesc');

descField.addEventListener('input', function () {
  this.style.height = 'auto';
  this.style.height = (this.scrollHeight) + 'px';
});


function groupLineItemsByCategory(items) {
  const groups = {};
  const displayNames = {}; // Map normalized -> display name (first encountered, for pretty display)
  items.forEach(item => {
    let category = 'General';
    if (item.name && item.name.includes('-')) {
      category = item.name.split('-').slice(1).join('-').trim();
      if (!category) category = 'General';
    }
    const normalized = category.toLowerCase().trim();
    if (!groups[normalized]) {
      groups[normalized] = [];
      displayNames[normalized] = category; // Save the first encountered display version
    }
    groups[normalized].push(item);
  });

  // Attach display name for each group
  Object.keys(groups).forEach(norm => {
    groups[norm]._displayName = displayNames[norm];
  });

  return groups;
}


function setupMobileSortableActivation() {
  // Remove any previous listeners to avoid duplicates
  if (window._mobileSortableListeners) {
    window._mobileSortableListeners.forEach(({evt, fn}) => {
      lineItemsTableContainer.removeEventListener(evt, fn);
    });
  }
  window._mobileSortableListeners = [];

  if (!isDesktop()) {
    ['pointerdown', 'touchstart', 'mousedown'].forEach(evtName => {
      const fnGroup = function(e) {
        const handle = e.target.closest('.drag-handle-group');
        if (handle && !sortableEnabled) {
          e.preventDefault();
          window.getSelection()?.removeAllRanges();
          handle.classList.add('active-drag-handle');
          sortableEnabled = true;
          renderTable();
          setTimeout(() => handle.classList.remove('active-drag-handle'), 600);
        }
      };
      lineItemsTableContainer.addEventListener(evtName, fnGroup, { passive: false });
      window._mobileSortableListeners.push({evt: evtName, fn: fnGroup});
    });

    ['pointerdown', 'touchstart', 'mousedown'].forEach(evtName => {
      const fnLine = function(e) {
        const handle = e.target.closest('.drag-handle');
        if (handle && !sortableEnabled && !e.target.closest('.drag-handle-group')) {
          e.preventDefault();
          window.getSelection()?.removeAllRanges();
          handle.classList.add('active-drag-handle');
          sortableEnabled = true;
          renderTable();
          setTimeout(() => handle.classList.remove('active-drag-handle'), 600);
        }
      };
      lineItemsTableContainer.addEventListener(evtName, fnLine, { passive: false });
      window._mobileSortableListeners.push({evt: evtName, fn: fnLine});
    });
  }
}

function isDesktop() {
  return window.innerWidth >= 1535; // You can adjust this breakpoint as needed
}

function updateSortableMode() {
  if (isDesktop()) {
    sortableEnabled = true;
    renderTable();
  } else {
    sortableEnabled = false;
    renderTable();
    setupMobileSortableActivation();
  }
}

// Call on load
window.addEventListener('DOMContentLoaded', updateSortableMode);
// Call on resize
window.addEventListener('resize', () => {
  // Only update if the mode actually changes
  const shouldBeEnabled = isDesktop();
  if (shouldBeEnabled !== sortableEnabled) {
    updateSortableMode();
  }
});

let sortableEnabled = false;
let sortables = []; // Store Sortable instances

function toggleSortable() {
  sortableEnabled = !sortableEnabled;
  document.getElementById('toggleSortableBtn').textContent = sortableEnabled ? 'Disable Drag & Drop' : 'Enable Drag & Drop';
  renderTable();
}

document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('toggleSortableBtn');
  if (btn) btn.onclick = toggleSortable;
});


function renderTable() {
  const container = document.getElementById('lineItemsTableContainer');
  container.innerHTML = '';

  // Destroy previous Sortables
  if (window.sortables && Array.isArray(window.sortables)) {
    window.sortables.forEach(s => s && s.destroy && s.destroy());
  }
  window.sortables = [];

  // Build the table
  const table = document.createElement('table');
  table.className = 'quote-table';
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';

  // Table header
  table.innerHTML = `
    <thead>
      <tr>
        <th></th>
        <th>Cost Code</th>
        <th>Item</th>
        <th style="width: 370px;">Description</th>
        <th >Rate</th>
        <th>Markup</th>
        <th style="width: 50px;">Qty</th>
        <th>Total</th>
        <th>Actions</th>
      </tr>
    </thead>
  `;

  let subtotal = 0;
  const grouped = groupLineItemsByCategory(lineItems);
  const categoryOrder = Object.keys(grouped);

  categoryOrder.forEach((category) => {
    // --- Track category total ---
    let categoryTotal = 0;
    grouped[category].forEach(item => {
      categoryTotal += item.rate * item.qty;
    });

    // --- Category/group header row (draggable) with total ---
    const groupRow = document.createElement('tr');
    groupRow.className = 'category-group-row';
    groupRow.innerHTML = `
      <td style="width:36px;text-align:center;">
        <span class="drag-handle-group" style="cursor:grab;">☰</span>
      </td>
      <td colspan="7" style="
        background: linear-gradient(90deg, #fafdff 80%, #eaf6ff 100%);
        font-weight: 600;
        color: #007bff;
        font-size: 1.08rem;
        font-weight:bold;
        border-left: 6px solid #007bff;
        letter-spacing: 0.5px;
        padding: 12px 0 12px 16px;
        margin-top: 8px;
        user-select: none;
      ">
        ${capitalizeCategory(category)}
      </td>
      <td style="background: #fafdff; font-weight: bold; color: #007bff;">
        ${formatCurrency(categoryTotal)}
      </td>
    `;

    // Create a <tbody> for this category
    const tbody = document.createElement('tbody');
    tbody.setAttribute('data-category', category);
    tbody.appendChild(groupRow);

    grouped[category].forEach((item, index) => {
      const total = item.rate * item.qty;
      subtotal += total;

      const row = document.createElement('tr');
      row.setAttribute('data-flat-index', lineItems.indexOf(item)); // For editing/deleting

      const isEditing = item.isEditing;
      // Determine the display rate for edit mode:
      // - If L/M values exist, always show base (labor+material) without markup
      // - If manual mode, show the manual base (stored or derived)
      const lrDisp = Number(item.laborRate) || 0;
      const lhDisp = (Number(item.laborHours) || 0) || 1; // default 1 for display
      const mrDisp = Number(item.materialRate) || 0;
      const mqDisp = (Number(item.materialQty) || 0) || 1; // default 1 for display
      const hasLMDisp = (lrDisp > 0) || (mrDisp > 0);
      const prevMarkupForDisplay = (typeof item.markup !== 'undefined') ? (Number(item.markup) || 0) : 0;
      const modeDisp = (item.markupMode === 'amount') ? 'amount' : 'percent';
      const manualBase = (typeof item.baseRateManual === 'number')
        ? item.baseRateManual
        : (
            modeDisp === 'percent'
              ? (prevMarkupForDisplay ? ((Number(item.rate) || 0) / (1 + prevMarkupForDisplay / 100)) : (Number(item.rate) || 0))
              : ((Number(item.rate) || 0) - (Number(item.markup) || 0))
          );
      const displayRate = hasLMDisp
        ? (lrDisp * lhDisp + mrDisp * mqDisp)
        : manualBase;

      row.innerHTML = isEditing ? `
  <td style="text-align:center;"><span class="drag-handle" onclick="event.stopPropagation()">☰</span></td>
        <td><input type="text" value="${item.costCode || ''}" id="editCode-${lineItems.indexOf(item)}" readonly style="background: #f1f5f9; cursor: not-allowed;" /></td>
        <td><input type="text" value="${item.name}" id="editName-${lineItems.indexOf(item)}" /></td>
        <td>
        <textarea id="editDesc-${lineItems.indexOf(item)}" oninput="autoResizeTextarea(this)" style="width:100%;">${item.description}</textarea>
        </td>
  <td><input type="number" value="${displayRate}" id="editRate-${lineItems.indexOf(item)}" oninput="recalcEditLineItem(${lineItems.indexOf(item)})" onblur="applyMarkupIfManual(${lineItems.indexOf(item)})" /></td>
  <td>
    <div style="display:flex;align-items:center;gap:6px;">
      <input type="number" value="${item.markup ?? 0}" id="editMarkup-${lineItems.indexOf(item)}" step="any" min="0" style="width:100px" oninput="recalcEditLineItem(${lineItems.indexOf(item)})" />
      <button type="button" id="editMarkupToggle-${lineItems.indexOf(item)}" onclick="toggleMarkupMode(${lineItems.indexOf(item)})" title="Toggle %/$" style="padding:4px 6px;border:1px solid #e5e7eb;border-radius:6px;background:#fff;cursor:pointer;">${item.markupMode === 'amount' ? '$' : '%'}</button>
    </div>
  </td>
  <td><input type="number" value="${item.qty}" id="editQty-${lineItems.indexOf(item)}" oninput="recalcEditLineItem(${lineItems.indexOf(item)})" /></td>
  <td><span id="editTotal-${lineItems.indexOf(item)}">${formatCurrency(item.rate * item.qty)}</span></td>
        <td>
          <div style="display:flex; gap:6px; align-items:center;">
            <!-- Save/Cancel buttons removed: click-away will save -->
            <button title="Advanced" aria-label="Advanced" onclick="toggleAdvancedEdit(${lineItems.indexOf(item)})"
              style="width:28px;height:28px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;border:1px solid #e5e7eb;background:#ffffff;color:#6b7280;margin:0;box-shadow:0 1px 1.5px rgba(0,0,0,0.04);cursor:pointer;">
              ⚙
            </button>
          </div>
        </td>
      ` : `
        <td style="text-align:center;"><span class="drag-handle">☰</span></td>
        <td>${item.costCode || '-'}</td>
        <td>${item.name}</td>
        <td>${item.description}</td>
        <td>${formatCurrency(item.rate)}</td>
  <td>${item.markupMode === 'amount' ? formatCurrency(item.markup || 0) : ((item.markup ?? 0).toFixed(2) + '%')}</td>
        <td>${item.qty}</td>
        <td>${formatCurrency(total)}</td>
        <td>
          <button title="Delete" aria-label="Delete" onclick="event.stopPropagation(); deleteLineItem(${lineItems.indexOf(item)})"
            style="width:28px;height:28px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;border:1px solid #e5e7eb;background:#ffffff;color:#ef4444;margin:0;box-shadow:0 1px 1.5px rgba(0,0,0,0.04);cursor:pointer;">
            🗑️
          </button>
        </td>
      `;

      // Clicking a non-edit row enters edit mode; avoid for drag handle and delete
      if (!isEditing) {
        row.style.cursor = 'pointer';
        row.addEventListener('click', () => editLineItem(lineItems.indexOf(item)));
      }
      tbody.appendChild(row);
      // Wire robust listeners to recalc when editing fields change (in case inline handlers were removed)
      if (isEditing) {
        const idx = lineItems.indexOf(item);
        const ids = [
          `editLaborRate-${idx}`,
          `editLaborHours-${idx}`,
          `editMaterialRate-${idx}`,
          `editMaterialQty-${idx}`,
          `editMarkup-${idx}`,
          `editRate-${idx}`,
          `editQty-${idx}`
        ];
        ids.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.addEventListener('input', () => recalcEditLineItem(idx));
        });
        // Initial sync
        try { recalcEditLineItem(idx); } catch (_) {}
      }
      // Add a full-width advanced edit row below the main edit row
      if (isEditing) {
        const editIdx = lineItems.indexOf(item);
        const advRow = document.createElement('tr');
        advRow.setAttribute('data-adv-for', editIdx);
        advRow.style.display = 'none';
        advRow.id = `advRow-${editIdx}`;
        const advTd = document.createElement('td');
        advTd.colSpan = 9;
        advTd.innerHTML = `
          <div id="advancedEdit-${editIdx}" style="margin-top:-9px;background:#f9fafb;border:1px solid #e5e7eb;padding:10px;border-radius:8px; max-width: 1100px;">
            <div style="border-bottom:1px solid #e5e7eb;margin-bottom:8px;padding-bottom:4px;font-weight:600;color:#334155;font-size:13px;display:flex;align-items:center;justify-content:space-between;">
              <span>Advanced Edit</span>
              <span style=\"font-size:12px;color:#6b7280;\">Adjust labor/material to recalc rate with markup</span>
            </div>
            <div style="margin-bottom:8px;">
             
              <div style="display:flex;flex-direction:row;gap:8px;align-items:flex-start;">
                <div style="display:flex;flex-direction:column;gap:4px;width:100%;max-width:220px;">
                  <label style="font-size:12px;color:#64748b;">Labor Rate</label>
                  <input type="number" id="editLaborRate-${editIdx}" value="${item.laborRate ?? ''}" placeholder="0.00" oninput="recalcEditLineItem(${editIdx})" style="width:100%;padding:6px 8px;border:1px solid #e5e7eb;border-radius:6px;" />
                </div>
                <div style="display:flex;flex-direction:column;gap:4px;width:100%;max-width:220px; display:none;">
                  <label style="font-size:12px;color:#64748b;">Labor Hours</label>
                  <!-- hidden by default; qtys default to 1 -->
                  <input type="number" id="editLaborHours-${editIdx}" value="${(typeof item.laborHours !== 'undefined' && item.laborHours !== null) ? item.laborHours : 1}" placeholder="0" oninput="recalcEditLineItem(${editIdx})" style="width:100%;padding:6px 8px;border:1px solid #e5e7eb;border-radius:6px; display:none;" />
                </div>
                 <div style="display:flex;flex-direction:column;gap:4px;width:100%;max-width:220px;">
                  <label style="font-size:12px;color:#64748b;">Material Rate</label>
                  <input type="number" id="editMaterialRate-${editIdx}" value="${item.materialRate ?? ''}" placeholder="0.00" oninput="recalcEditLineItem(${editIdx})" style="width:100%;padding:6px 8px;border:1px solid #e5e7eb;border-radius:6px;" />
                </div>
                <div style="display:flex;flex-direction:column;gap:4px;width:100%;max-width:220px; display:none;">
                  <label style="font-size:12px;color:#64748b;">Material Qty</label>
                  <!-- hidden by default; qtys default to 1 -->
                  <input type="number" id="editMaterialQty-${editIdx}" value="${(typeof item.materialQty !== 'undefined' && item.materialQty !== null) ? item.materialQty : 1}" placeholder="0" oninput="recalcEditLineItem(${editIdx})" style="width:100%;padding:6px 8px;border:1px solid #e5e7eb;border-radius:6px; display:none;" />
                </div>
              </div>
            </div>
            <div style="margin-top:6px;font-size:12px;color:#64748b;">
              <span id="editBreakdown-${editIdx}"></span>
            </div>
          </div>`;
        advRow.appendChild(advTd);
        tbody.appendChild(advRow);
      }
    });

    table.appendChild(tbody);

    // Enable Sortable for items within this category (tbody) if enabled
    if (sortableEnabled) {
      const s = Sortable.create(tbody, {
        handle: '.drag-handle',
        animation: 150,
        draggable: 'tr:not(.category-group-row)',
        group: { name: 'line-items', put: false },
        filter: 'input, textarea, button, select, .action-dropdown, .action-dropdown *',
        preventOnFilter: false,
        onStart: function () {
          document.body.classList.add('dragging');
        },
        onEnd: function (evt) {
          document.body.classList.remove('dragging');
          // Only reorder if the item was moved within the same category
          if (evt.from === evt.to && evt.oldIndex !== evt.newIndex) {
            // Get all rows (excluding group header) in this tbody
            const rows = Array.from(tbody.querySelectorAll('tr:not(.category-group-row)'));
            const newOrderIndexes = rows.map(row => parseInt(row.getAttribute('data-flat-index')));

            // Find all indexes in lineItems for this category
            const categoryIndexes = lineItems
              .map((item, idx) => {
                let cat = 'General';
                if (item.name && item.name.includes('-')) {
                  cat = item.name.split('-').slice(1).join('-').trim() || 'General';
                }
                return cat.toLowerCase() === category.toLowerCase() ? idx : -1;
              })
              .filter(idx => idx !== -1);

            // Build a new array for this category in the new order
            const reorderedCategoryItems = newOrderIndexes.map(i => lineItems[i]);

            // Replace the items in lineItems at the categoryIndexes with the reordered ones
            categoryIndexes.forEach((lineIdx, i) => {
              lineItems[lineIdx] = reorderedCategoryItems[i];
            });
          }
          if (!isDesktop()) {
            sortableEnabled = false;
            renderTable();
          }
        }
      });
      window.sortables.push(s);
    }
  });

  container.appendChild(table);

  // Enable Sortable for categories (tbodys) if enabled
  if (sortableEnabled) {
    const s = Sortable.create(table, {
      handle: '.drag-handle-group',
      animation: 150,
      draggable: 'tbody',
      filter: 'tr:not(.category-group-row)', // Prevent dragging rows
      preventOnFilter: false,
      onStart: function () {
        document.body.classList.add('dragging');
      },
      onEnd: function (evt) {
        document.body.classList.remove('dragging');
        const tbodys = Array.from(table.querySelectorAll('tbody'));
        let newLineItems = [];
        tbodys.forEach(tbody => {
          const cat = tbody.getAttribute('data-category');
          newLineItems = newLineItems.concat(groupLineItemsByCategory(lineItems)[cat]);
        });
        lineItems = newLineItems;

        if (!isDesktop()) {
          sortableEnabled = false;
          renderTable();
        }
      }
    });
    window.sortables.push(s);
  }

  // Totals
  const discount = parseFloat(document.getElementById('inputDiscount').value || 0);
  const taxRate = parseFloat(document.getElementById('inputTax').value || 0);
  const tax = (subtotal - discount) * (taxRate / 100);
  const total = subtotal - discount + tax;

  // Calculate total markup (sum of all line item markups as applied)
  let totalMarkup = 0;
  lineItems.forEach(item => {
    const qty = Number(item.qty) || 0;
    let base = 0;
    if ((Number(item.laborRate) || 0) > 0 || (Number(item.materialRate) || 0) > 0) {
      // L/M mode
      base = (Number(item.laborRate) || 0) * ((Number(item.laborHours) || 0) || 1) + (Number(item.materialRate) || 0) * ((Number(item.materialQty) || 0) || 1);
    } else {
      // Manual mode
      if (item.markupMode === 'percent') {
        base = (item.markup && item.rate) ? (Number(item.rate) / (1 + Number(item.markup) / 100)) : (Number(item.rate) || 0);
      } else {
        base = (item.markup && item.rate) ? (Number(item.rate) - Number(item.markup)) : (Number(item.rate) || 0);
      }
    }
    let markupAmt = 0;
    if (item.markupMode === 'amount') {
      markupAmt = (Number(item.markup) || 0) * qty;
    } else {
      markupAmt = (base * (Number(item.markup) || 0) / 100) * qty;
    }
    totalMarkup += markupAmt;
  });

  // Update markup total value (formatted without currency sign inside span)
  const markupTotalEl = document.getElementById('markupTotal');
  if (markupTotalEl) {
    markupTotalEl.textContent = totalMarkup.toLocaleString(undefined, { minimumFractionDigits: 2 });
  }

  document.getElementById('subtotal').textContent = formatCurrency(subtotal).replace('$', '');
  document.getElementById('discount').textContent = formatCurrency(discount).replace('$', '');
  document.getElementById('tax').textContent = formatCurrency(tax).replace('$', '');
  document.getElementById('grandTotal').textContent = formatCurrency(total).replace('$', '');
  // Keep suggestions footer in sync with summary-box totals
  try { updateLaborSuggestionsFooter(); } catch (_) {}
}

function capitalizeCategory(category) {
  return category.replace(/\w\S*/g, (txt) =>
    txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
  );
}

  function editLineItem(index) {
    lineItems[index].isEditing = true;
    renderTable();
    // Setup click-away-to-save
    setTimeout(() => {
      const row = document.querySelector(`tr[data-flat-index='${index}']`);
      const advRow = document.getElementById(`advRow-${index}`);
      if (!row) return;
      function handleClickAway(e) {
        // If click is inside the main edit row or the advanced edit row, do not save/close
        if (row.contains(e.target) || (advRow && advRow.contains(e.target))) {
          return;
        }
        saveLineItem(index);
        document.removeEventListener('mousedown', handleClickAway, true);
      }
      document.addEventListener('mousedown', handleClickAway, true);
    }, 0);
  }

function cancelEditLineItem(index) {
  delete lineItems[index].isEditing;
  renderTable();
}

function saveLineItem(index) {
  const name = document.getElementById(`editName-${index}`).value;
  const description = document.getElementById(`editDesc-${index}`).value;
  let rate = parseFloat(document.getElementById(`editRate-${index}`).value);
  const qty = parseInt(document.getElementById(`editQty-${index}`).value);
  const markupInput = document.getElementById(`editMarkup-${index}`);
  const markup = markupInput ? parseFloat(markupInput.value) || 0 : (lineItems[index].markup ?? 0);
  const markupMode = (lineItems[index]?.markupMode === 'amount') ? 'amount' : 'percent';

  if (!name || isNaN(rate) || isNaN(qty)) {
    showToast("Please fill in all fields correctly.");
    return;
  }

  // Preserve costCode
  const costCodeInput = document.getElementById(`editCode-${index}`);
  const costCode = costCodeInput ? costCodeInput.value.trim() : (lineItems[index].costCode || "Uncategorized");

  // Read advanced breakdown inputs if present; else preserve existing
  const lrEl = document.getElementById(`editLaborRate-${index}`);
  const lhEl = document.getElementById(`editLaborHours-${index}`);
  const mrEl = document.getElementById(`editMaterialRate-${index}`);
  const mqEl = document.getElementById(`editMaterialQty-${index}`);
  const laborRate = lrEl ? (parseFloat(lrEl.value) || 0) : (lineItems[index].laborRate ?? undefined);
  const laborHours = lhEl ? (parseFloat(lhEl.value) || 0) : (lineItems[index].laborHours ?? undefined);
  const materialRate = mrEl ? (parseFloat(mrEl.value) || 0) : (lineItems[index].materialRate ?? undefined);
  const materialQty = mqEl ? (parseFloat(mqEl.value) || 0) : (lineItems[index].materialQty ?? undefined);

  // Compute rate based on the active mode
  const hasLM = ((Number(laborRate) || 0) > 0) || ((Number(materialRate) || 0) > 0);
  if (hasLM) {
    // L/M mode: derive base from L/M and apply markup for stored rate
    const lr = Number(laborRate) || 0;
    const lh = (Number(laborHours) || 0) || 1;
    const mr = Number(materialRate) || 0;
    const mq = (Number(materialQty) || 0) || 1;
    const baseLM = lr * lh + mr * mq;
    rate = (markupMode === 'amount') ? (baseLM + (markup || 0)) : (baseLM * (1 + (markup || 0) / 100));
  } else {
    // Manual mode: compute from a stable base
    const existing = lineItems[index] || {};
    const base = (typeof existing.baseRateManual === 'number') ? existing.baseRateManual : rate;
    rate = (markupMode === 'amount') ? (base + (markup || 0)) : (base * (1 + (markup || 0) / 100));
  }
  lineItems[index] = { costCode, name, description, rate, qty, markup, markupMode, laborRate, laborHours, materialRate, materialQty };
  renderTable();
}

function toggleAdvancedEdit(index) {
  // Toggle the below-row advanced edit panel if present; otherwise toggle the in-cell panel
  const advRow = document.getElementById(`advRow-${index}`);
  const attachListeners = () => {
    // Attach input listeners to all advanced edit fields for this index
    [
      `editLaborRate-${index}`,
      `editLaborHours-${index}`,
      `editMaterialRate-${index}`,
      `editMaterialQty-${index}`,
      `editMarkup-${index}`,
      `editRate-${index}`,
      `editQty-${index}`
    ].forEach(id => {
      const el = document.getElementById(id);
      if (el && !el._advListenerAttached) {
        el.addEventListener('input', () => recalcEditLineItem(index));
        el._advListenerAttached = true;
      }
    });
  };
  if (advRow) {
    const opening = advRow.style.display === 'none';
    advRow.style.display = opening ? 'table-row' : 'none';
    if (opening) {
      setTimeout(() => {
        attachListeners();
        try { recalcEditLineItem(index); } catch (_) {}
      }, 0);
    }
    return;
  }
  const advCell = document.getElementById(`advancedEdit-${index}`);
  if (advCell) {
    const opening = advCell.style.display === 'none';
    advCell.style.display = opening ? 'block' : 'none';
    if (opening) {
      setTimeout(() => {
        attachListeners();
        try { recalcEditLineItem(index); } catch (_) {}
      }, 0);
    }
  }
}

function toggleAdvancedGroup(index, section) {
  const body = document.getElementById(`advBody-${section}-${index}`);
  const icon = document.getElementById(`advIcon-${section}-${index}`);
  if (!body || !icon) return;
  const isOpen = body.style.display !== 'none';
  body.style.display = isOpen ? 'none' : 'block';
  icon.textContent = isOpen ? '▸' : '▾';
}

// Toggle markup mode between percent and amount for a specific line item
function toggleMarkupMode(index) {
  if (!lineItems[index]) return;
  const current = (lineItems[index].markupMode === 'amount') ? 'amount' : 'percent';
  const next = current === 'amount' ? 'percent' : 'amount';
  lineItems[index].markupMode = next;
  // Update toggle button label if present
  const btn = document.getElementById(`editMarkupToggle-${index}`);
  if (btn) btn.textContent = next === 'amount' ? '$' : '%';
  // Recalculate with new interpretation
  try { recalcEditLineItem(index); } catch (_) {}
}

// Recalculate the edit row when markup, rate, or qty changes
function recalcEditLineItem(index) {
  const rateEl = document.getElementById(`editRate-${index}`);
  const qtyEl = document.getElementById(`editQty-${index}`);
  const markupEl = document.getElementById(`editMarkup-${index}`);
  if (!rateEl || !qtyEl) return;


  let rate = parseFloat(rateEl.value) || 0;
  const qty = parseInt(qtyEl.value) || 0;
  const markup = markupEl ? (parseFloat(markupEl.value) || 0) : (typeof lineItems[index]?.markup !== 'undefined' ? Number(lineItems[index].markup) || 0 : 0);
  const markupMode = (lineItems[index]?.markupMode === 'amount') ? 'amount' : 'percent';

  const item = lineItems[index];
  const laborRateEl = document.getElementById(`editLaborRate-${index}`);
  const laborHoursEl = document.getElementById(`editLaborHours-${index}`);
  const materialRateEl = document.getElementById(`editMaterialRate-${index}`);
  const materialQtyEl = document.getElementById(`editMaterialQty-${index}`);

  // Get values
  let lr = laborRateEl ? (parseFloat(laborRateEl.value) || 0) : (typeof item?.laborRate !== 'undefined' ? item.laborRate : 0);
  let lh = laborHoursEl ? (parseFloat(laborHoursEl.value) || 0) : (typeof item?.laborHours !== 'undefined' ? item.laborHours : 0);
  let mr = materialRateEl ? (parseFloat(materialRateEl.value) || 0) : (typeof item?.materialRate !== 'undefined' ? item.materialRate : 0);
  let mq = materialQtyEl ? (parseFloat(materialQtyEl.value) || 0) : (typeof item?.materialQty !== 'undefined' ? item.materialQty : 0);


  // Determine if we're in manual mode: no labor/material rates provided
  // Ignore hours/qty defaults (they may be 1 by default but rates define intent)
  const manualMode = ((lr || 0) === 0 && (mr || 0) === 0);

  // We'll track the rate we store for calculations/totals separately from what's shown in the input
  let storedRate = null;

  // If labor/material fields are being edited, recalc from L/M with markup
  if (
    (laborRateEl && document.activeElement === laborRateEl) ||
    (laborHoursEl && document.activeElement === laborHoursEl) ||
    (materialRateEl && document.activeElement === materialRateEl) ||
    (materialQtyEl && document.activeElement === materialQtyEl)
  ) {
    // Ensure sensible defaults when entering L/M fields: set hours/qty to 1 if zero/empty
    if ((laborRateEl && document.activeElement === laborRateEl) || (laborHoursEl && document.activeElement === laborHoursEl)) {
      if (!lh || isNaN(lh)) {
        lh = 1;
        if (laborHoursEl) laborHoursEl.value = '1';
      }
    }
    if ((materialRateEl && document.activeElement === materialRateEl) || (materialQtyEl && document.activeElement === materialQtyEl)) {
      if (!mq || isNaN(mq)) {
        mq = 1;
        if (materialQtyEl) materialQtyEl.value = '1';
      }
    }
    const laborCost = (lr) * (lh);
    const materialCost = (mr) * (mq);
  const baseLM = (laborCost + materialCost);
  const effectiveLM = markupMode === 'amount' ? (baseLM + (markup || 0)) : (baseLM * (1 + (markup || 0) / 100));
    storedRate = effectiveLM;
    // Show base in the input while editing L/M
    rateEl.value = baseLM > 0 ? baseLM.toFixed(2) : '';
    if (lineItems[index]) {
      lineItems[index].rate = effectiveLM;
      delete lineItems[index].baseRateManual; // L/M is the source now
    }
  } else if (markupEl && document.activeElement === markupEl) {
    // Markup changed: apply differently depending on mode
    if (manualMode) {
      // Keep the input as the base rate; only update stored/calculated rate
      const base = (typeof item?.baseRateManual === 'number')
        ? item.baseRateManual
        : (parseFloat(rateEl.value) || 0);
  const finalRate = markupMode === 'amount' ? (base + (markup || 0)) : (base * (1 + (markup || 0) / 100));
      storedRate = finalRate;
      // Do NOT change the input value; it should show base in manual mode
      if (lineItems[index]) {
        lineItems[index].rate = finalRate;
        lineItems[index].markup = markup;
        lineItems[index].baseRateManual = base;
      }
    } else {
      // L/M mode: recompute base+markup; show base, store effective for totals
      const laborCost = (lr) * (lh);
      const materialCost = (mr) * (mq);
  const baseLM = (laborCost + materialCost);
  const effectiveLM = markupMode === 'amount' ? (baseLM + (markup || 0)) : (baseLM * (1 + (markup || 0) / 100));
      storedRate = effectiveLM;
      rateEl.value = baseLM > 0 ? baseLM.toFixed(2) : '';
      if (lineItems[index]) {
        lineItems[index].rate = effectiveLM;
      }
    }
  } else if (document.activeElement === rateEl) {
    // Typing manually in rate: treat as manual mode and do NOT apply markup to the input
    if (lineItems[index]) {
      lineItems[index].baseRateManual = rate;
      // Clear L/M values when switching to manual entry
      if (!manualMode) {
        if (laborRateEl) laborRateEl.value = '';
        if (laborHoursEl) laborHoursEl.value = '';
        if (materialRateEl) materialRateEl.value = '';
        if (materialQtyEl) materialQtyEl.value = '';
        lineItems[index].laborRate = 0;
        lineItems[index].laborHours = 0;
        lineItems[index].materialRate = 0;
        lineItems[index].materialQty = 0;
      }
    }
    // While typing, keep input as base but store effective (base × (1+markup)) so totals stay accurate
  storedRate = markupMode === 'amount' ? (rate + (markup || 0)) : (rate * (1 + (markup || 0) / 100));
  } else if (manualMode) {
    // Not focused on inputs, but in manual mode: ensure stored rate reflects base+markup
    const base = (typeof item?.baseRateManual === 'number') ? item.baseRateManual : (parseFloat(rateEl.value) || 0);
  storedRate = markupMode === 'amount' ? (base + (markup || 0)) : (base * (1 + (markup || 0) / 100));
    if (lineItems[index]) {
      lineItems[index].rate = storedRate;
      lineItems[index].baseRateManual = base;
    }
  }

  // Show breakdown if advanced fields used
  const breakdownEl = document.getElementById(`editBreakdown-${index}`);
  if (breakdownEl) {
    const laborCost = (lr) * (lh);
    const materialCost = (mr) * (mq);
    if (lr || lh || mr || mq) {
      breakdownEl.textContent = `Labor: $${laborCost.toFixed(2)} (${lr} × ${lh}) • Material: $${materialCost.toFixed(2)} (${mr} × ${mq})`;
    } else {
      breakdownEl.textContent = '';
    }
  }

  // Always update backing data (without overwriting storedRate decision)
  if (lineItems[index]) {
    lineItems[index].markup = markup;
    if (storedRate !== null) lineItems[index].rate = storedRate;
    lineItems[index].laborRate = lr;
    lineItems[index].laborHours = lh;
    lineItems[index].materialRate = mr;
    lineItems[index].materialQty = mq;
  }

  const effectiveRate = (storedRate !== null) ? storedRate : rate;
  const total = effectiveRate * qty;
  const totalSpan = document.getElementById(`editTotal-${index}`);
  if (totalSpan) totalSpan.textContent = formatCurrency(total);

  updateTotalsPreviewWithEdit(index);
}

// Apply markup to the manual rate only after user finishes typing (on blur) when no labor/material are provided
function applyMarkupIfManual(index) {
  const rateEl = document.getElementById(`editRate-${index}`);
  const markupEl = document.getElementById(`editMarkup-${index}`);
  if (!rateEl) return;

  const laborRateEl = document.getElementById(`editLaborRate-${index}`);
  const laborHoursEl = document.getElementById(`editLaborHours-${index}`);
  const materialRateEl = document.getElementById(`editMaterialRate-${index}`);
  const materialQtyEl = document.getElementById(`editMaterialQty-${index}`);

  const lr = laborRateEl ? (parseFloat(laborRateEl.value) || 0) : 0;
  const lh = laborHoursEl ? (parseFloat(laborHoursEl.value) || 0) : 0;
  const mr = materialRateEl ? (parseFloat(materialRateEl.value) || 0) : 0;
  const mq = materialQtyEl ? (parseFloat(materialQtyEl.value) || 0) : 0;

  // If using manual rate (no labor/material rates entered)
  if (((lr || 0) === 0 && ((mr || 0) === 0))) {
    const item = lineItems[index] || {};
    const base = (typeof item.baseRateManual === 'number') ? item.baseRateManual : (parseFloat(rateEl.value) || 0);
    const markup = markupEl ? (parseFloat(markupEl.value) || 0) : 0;
    const mode = (item.markupMode === 'amount') ? 'amount' : 'percent';
    const finalRate = mode === 'amount' ? (base + (markup || 0)) : (base * (1 + (markup || 0) / 100));
    // Keep input showing base to avoid compounding perception; only store final
    if (lineItems[index]) {
      lineItems[index].rate = finalRate;
      lineItems[index].markup = markup;
      lineItems[index].baseRateManual = base;
      // Zero out breakdown since manual
      lineItems[index].laborRate = 0;
      lineItems[index].laborHours = 0;
      lineItems[index].materialRate = 0;
      lineItems[index].materialQty = 0;
    }
    // Refresh the row total preview
    updateTotalsPreviewWithEdit(index);
  }
}

// Recompute totals using edited row values if present
function updateTotalsPreviewWithEdit(editIndex) {
  const discount = parseFloat(document.getElementById('inputDiscount')?.value || 0);
  const taxRate = parseFloat(document.getElementById('inputTax')?.value || 0);
  let subtotal = 0;
  for (let i = 0; i < lineItems.length; i++) {
    if (i === editIndex && document.getElementById(`editQty-${i}`)) {
      // Use stored effective rate (includes markup) with live qty input for edited row
      const r = Number(lineItems[i]?.rate) || 0;
      const q = parseInt(document.getElementById(`editQty-${i}`).value) || 0;
      subtotal += r * q;
    } else {
      const it = lineItems[i];
      subtotal += (Number(it.rate) || 0) * (Number(it.qty) || 0);
    }
  }
  const tax = (subtotal - discount) * (taxRate / 100);
  const total = subtotal - discount + tax;
  const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = formatCurrency(val).replace('$',''); };
  setText('subtotal', subtotal);
  setText('discount', discount);
  setText('tax', tax);
  setText('grandTotal', total);

  // Also update each category header total live while editing
  try {
    const tbodys = document.querySelectorAll('tbody[data-category]');
    tbodys.forEach(tbody => {
      const catKey = tbody.getAttribute('data-category'); // normalized category key (lowercase)
      // Recompute total for this category, honoring the current edit row values
      let catTotal = 0;
      for (let i = 0; i < lineItems.length; i++) {
        const item = lineItems[i];
        // Determine normalized category key like groupLineItemsByCategory
        let category = 'General';
        if (item?.name && item.name.includes('-')) {
          const c = item.name.split('-').slice(1).join('-').trim();
          category = c || 'General';
        }
        const norm = String(category).toLowerCase().trim();
        if (norm === catKey) {
          if (i === editIndex && document.getElementById(`editQty-${i}`)) {
            const r = Number(lineItems[i]?.rate) || 0;
            const q = parseInt(document.getElementById(`editQty-${i}`).value) || 0;
            catTotal += r * q;
          } else {
            const r = Number(item?.rate) || 0;
            const q = Number(item?.qty) || 0;
            catTotal += r * q;
          }
        }
      }
      const headerCell = tbody.querySelector('.category-group-row td:last-child');
      if (headerCell) headerCell.textContent = formatCurrency(catTotal);
    });
  } catch (_) {
    // Non-fatal if structure not present
  }
}


    
    function toggleLineItemMenu(event, index) {
  event.stopPropagation();
  const menu = document.getElementById(`lineitem-menu-${index}`);
  menu.style.display = menu.style.display === 'block' ? 'none' : 'block';

  // Close on outside click
  document.addEventListener('click', () => {
    menu.style.display = 'none';
  }, { once: true });
}




    function deleteLineItem(index) {
      lineItems.splice(index, 1);
      renderTable();
    }


    function printQuotePreview() {
      const previewContent = document.getElementById("quotePreviewContent");
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html><head><title>Print Quote</title></head><body>
        ${previewContent.innerHTML}
        </body></html>
      `);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
    }

    async function shareQuotePreview() {
      const previewContent = document.getElementById("quotePreviewContent");
      const blob = new Blob([previewContent.innerHTML], { type: 'text/html' });
      const file = new File([blob], 'quote-preview.html', { type: 'text/html' });
      showLoader(); // 👈 START
      try {
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            title: 'Quote Preview',
            text: 'Here is the quote preview.',
            files: [file]
          });
        } else {
          showToast('Sharing not supported on this device.');
        }
      } catch (err) {
        console.error('Share error:', err);
        showToast('Error sharing quote preview.');
      } finally {
        hideLoader(); // 👈 END
      }
    }

    function openQuotePreview() {
  const fromName = document.getElementById("fromName").value;
  const fromAddress = document.getElementById("fromAddress").value;
  const fromEmail = document.getElementById("fromEmail").value;
  const fromPhone = document.getElementById("fromPhone").value;
  const fromLicense = document.getElementById("fromLicense").value || "RBC-2400049"; //
  const toName = document.getElementById("toName").value;
  const toAddress = document.getElementById("toAddress").value;
  const toEmail = document.getElementById("toEmail").value;
  const toPhone = document.getElementById("toPhone").value;
  const quoteNumber = document.getElementById("quoteNumber").value;
  const quoteDate = document.getElementById("quoteDate").value;
  const expirationDate = document.getElementById("validTill").value;

  const signatureClientInput = document.getElementById("signatureClientName");
  const clientSignatureName = signatureClientInput?.value || toName || "____________________________";

  const lineItemRows = lineItems.map(item => `
  <tr>
    <td>${item.name}</td>
    <td>${item.description}</td>
    <td>$${item.rate.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
    <td>${item.qty.toLocaleString()}</td>
    <td>$${(item.rate * item.qty).toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
  </tr>
`).join("");


  const subtotal = lineItems.reduce((sum, i) => sum + i.rate * i.qty, 0);
  const tax = 0;
  const total = subtotal + tax;

  // ✅ Calculate milestone amounts
const total30 = (total * 0.30).toLocaleString(undefined, { minimumFractionDigits: 2 });
const total10 = (total * 0.10).toLocaleString(undefined, { minimumFractionDigits: 2 });


  document.getElementById("quotePreviewContent").innerHTML = `
    <h2 style="color: #007bff;">BESF LLC</h2>
    <p><strong>Quote #:</strong> ${quoteNumber}</p>
    <p><strong>Date:</strong> ${quoteDate}</p>
    <p><strong>Valid till:</strong> ${expirationDate}</p>
    <hr>

    <div style="display: flex; justify-content: space-between;">
      <div>
        <h4>Quote From</h4>
                <p>
          ${fromName}<br>
          ${fromAddress}<br>
          ${fromEmail}<br>
          ${fromPhone}<br>
          <strong>License:</strong> ${fromLicense} <!-- ✅ Show license here -->
        </p>
      </div>
      <div>
        <h4>Quote To</h4>
        <p>${toName}<br>${toAddress}<br>${toEmail}<br>${toPhone}</p>
      </div>
    </div>

    <h3 style="margin-top: 20px;">Line Items</h3>
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background-color: #f0f0f0;">
          <th>Item</th><th>Description</th><th>Rate</th><th>Qty</th><th>Total</th>
        </tr>
      </thead>
      <tbody>${lineItemRows}</tbody>
    </table>

    <div style="margin-top: 20px; text-align: right;">
     <p><strong>Subtotal:</strong> $${subtotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
    <p><strong>Tax:</strong> $${tax.toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
    <p><strong style="font-size: 18px;">Total:</strong> <span style="color: #007bff;">$${total.toLocaleString(undefined, { minimumFractionDigits: 2 })}</span></p>

    </div>

<div style="margin-top: 30px;">
  <h3>Payment Terms</h3>
  <p>The total project amount shall be paid in the following phases:</p>
  <ul style="margin-top: 10px; padding-left: 20px;">
    <li><strong>30%</strong> at project start: <strong>$${total30}</strong></li>
    <li><strong>30%</strong> at 50% project completion: <strong>$${total30}</strong></li>
    <li><strong>30%</strong> at 75% project completion: <strong>$${total30}</strong></li>
    <li><strong>10%</strong> at final completion: <strong>$${total10}</strong></li>
  </ul>
  <p style="margin-top: 10px;">All payments are due within 7 days of invoice unless otherwise agreed upon in writing. Late payments may be subject to additional fees.</p>
</div>


    <div style="margin-top: 30px; border-top: 1px solid #ccc; padding-top: 20px;">
      <h3>Agreement</h3>
      <p>If you accept this quote, please sign and return.</p>
       <p><strong>Client Name:</strong> ${clientSignatureName}</p>
      <p><strong>Signature:</strong> ____________________________</p>
      <p><strong>Date:</strong> ____________________________</p>
    </div>
  `;

  document.getElementById("quoteModal").style.display = "flex";
}

    function closeQuotePreview() {
      document.getElementById("quoteModal").style.display = "none";
    }

    function generatePDF() {
      html2pdf().from(document.body).save('quote.pdf');
    }

    function shareQuote() {
      alert('Sharing quote (this will work once backend/API is connected).');
    }

// Add this inside your script tag, after window.onload

// Check for quoteId parameter when page loads
document.addEventListener('DOMContentLoaded', async () => {
  const params = new URLSearchParams(window.location.search);
  const quoteId = params.get('quoteId');
  
  // If quoteId exists, load the quote for editing
  if (quoteId) {
    await loadQuoteForEditing(quoteId);
  }
});

// Function to load quote data for editing
async function loadQuoteForEditing(quoteId) {
  showLoader();
  try {
    const response = await fetch(`/api/quotes/${quoteId}`);
    if (!response.ok) throw new Error('Failed to fetch quote');
    
    const quote = await response.json();
    
    // Set the quote ID as a data attribute on the body for later use
    document.body.setAttribute('data-quote-id', quoteId);
    
    // Update page title and header to indicate editing mode
    document.title = `Edit Quote #${quote.quoteNumber}`;
    document.querySelector('.header-title').textContent = 'Edit Quote';
    
    // Fill in "From" information
    document.getElementById('fromName').value = quote.from.name || '';
    document.getElementById('fromAddress').value = quote.from.address || '';
    document.getElementById('fromEmail').value = quote.from.email || '';
    document.getElementById('fromPhone').value = quote.from.phone || '';
    document.getElementById('fromLicense').value = quote.from.license || '';
    
    // Fill in "To" information
    document.getElementById('toName').value = quote.to.name || '';
    document.getElementById('toAddress').value = quote.to.address || '';
    document.getElementById('toEmail').value = quote.to.email || '';
    document.getElementById('toPhone').value = quote.to.phone || '';
    
    // Fill in quote details
    document.getElementById('quoteNumber').value = quote.quoteNumber || '';
    document.getElementById('quoteDate').value = quote.date ? quote.date.split('T')[0] : '';
    document.getElementById('validTill').value = quote.validTill ? quote.validTill.split('T')[0] : '';
    document.getElementById('quoteNotes').value = quote.notes || '';
    
    // Set discount and tax values
    document.getElementById('inputDiscount').value = quote.totals?.discount || 0;
    document.getElementById('inputTax').value = quote.totals?.tax || 0;
    
    // Fill in line items (preserve markup if present)
    lineItems = quote.lineItems.map(item => ({
      costCode: item.costCode || '',
      name: item.name,
      description: item.description || '',
      rate: parseFloat(item.rate) || 0,
      qty: parseInt(item.qty) || 0,
      markup: item.markup != null ? parseFloat(item.markup) : 0,
      markupMode: item.markupMode === 'amount' ? 'amount' : 'percent',
      laborRate: item.laborRate,
      laborHours: item.laborHours,
      materialRate: item.materialRate,
      materialQty: item.materialQty
    }));
    
    // Render the table with the line items
    renderTable();
    
    // If client signature name was stored, restore it
    if (quote.to.name) {
      document.getElementById('signatureClientName').value = quote.to.name;
    }
    
    // Update save button text to indicate update mode
    const saveButtons = document.querySelectorAll('.dropdown-content a[onclick="saveQuote()"]');
    saveButtons.forEach(btn => {
      btn.textContent = '💾 Update Quote';
    });
    
    showToast('Quote loaded for editing');
  } catch (error) {
    console.error('Error loading quote for editing:', error);
    showToast('❌ Failed to load quote for editing');
  } finally {
    hideLoader();
  }
}

// Update the saveQuote function to handle both new quotes and updates
function saveQuote() {
  const quoteId = document.body.getAttribute('data-quote-id');
  const isUpdate = !!quoteId;
  
  const quote = {
    from: {
      name: document.getElementById('fromName').value,
      address: document.getElementById('fromAddress').value,
      email: document.getElementById('fromEmail').value,
      phone: document.getElementById('fromPhone').value,
      license: document.getElementById('fromLicense').value
    },
    to: {
      name: document.getElementById('toName').value,
      address: document.getElementById('toAddress').value,
      email: document.getElementById('toEmail').value,
      phone: document.getElementById('toPhone').value
    },
    quoteNumber: document.getElementById('quoteNumber').value,
    date: document.getElementById('quoteDate').value,
    validTill: document.getElementById('validTill').value,
    notes: document.getElementById('quoteNotes').value,
    // Store laborCost and materialCost if available
    lineItems: lineItems.map(item => {
      let laborCost = null, materialCost = null;
      if (typeof item.laborRate !== 'undefined' && typeof item.laborHours !== 'undefined') {
        laborCost = (item.laborRate || 0) * (item.laborHours || 0);
      }
      if (typeof item.materialRate !== 'undefined' && typeof item.materialQty !== 'undefined') {
        materialCost = (item.materialRate || 0) * (item.materialQty || 0);
      }
      return {
        ...item,
        markup: item.markup != null ? item.markup : 0,
        laborCost,
        materialCost
      };
    }),
    totals: {
      subtotal: parseFloat(document.getElementById('subtotal').textContent.replace(/,/g, '')),
      discount: parseFloat(document.getElementById('discount').textContent.replace(/,/g, '')),
      tax: parseFloat(document.getElementById('tax').textContent.replace(/,/g, '')),
      total: parseFloat(document.getElementById('grandTotal').textContent.replace(/,/g, ''))
    }
  };
  
  showLoader();
  
  // Determine if this is a new quote or an update
  const url = isUpdate ? `/api/quotes/${quoteId}` : '/api/quotes';
  const method = isUpdate ? 'PUT' : 'POST';
  
  fetch(url, {
    method: method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(quote)
  })
    .then(res => res.json())
    .then(data => {
      console.log(`Quote ${isUpdate ? 'updated' : 'saved'}:`, data);
      showToast(`✅ Quote ${isUpdate ? 'updated' : 'saved'}`);
      
      // Redirect back to quotes page after successful save
      setTimeout(() => {
        window.location.href = '/quotes.html';
      }, 1500);
    })
    .catch(err => {
      console.error(`Error ${isUpdate ? 'updating' : 'saving'} quote:`, err);
      showToast(`❌ Failed to ${isUpdate ? 'update' : 'save'} quote`);
    })
    .finally(() => {
      hideLoader();
    });
}


function deleteLineItem(index) {
  lineItems.splice(index, 1);
  renderTable();
}


    function openQuoteHistory() {
      document.getElementById('quoteHistoryModal').style.display = 'flex';
    }

    function closeQuoteHistory() {
      document.getElementById('quoteHistoryModal').style.display = 'none';
    }

    function closeQuoteDetail() {
      document.getElementById('quoteDetailModal').style.display = 'none';
    }


    let allQuotes = [];
let currentPage = 1;
const itemsPerPage = 5;

async function loadQuoteHistory() {
  showLoader(); // 👈 START
  try {
    const res = await fetch('/api/quotes');
    allQuotes = await res.json();
    renderQuoteHistory();
  } catch (err) {
    console.error('Failed to load quote history:', err);
  } finally {
    hideLoader(); // 👈 END
  }
}

function renderQuoteHistory() {
  const list = document.getElementById('quoteHistoryList');
  if (!list) return;
  const search = document.getElementById('searchInput').value.toLowerCase();
  const filter = document.getElementById('filterSelect').value;

  let filtered = allQuotes.filter(q =>
    q.quoteNumber.toLowerCase().includes(search) ||
    (q.to?.name && q.to.name.toLowerCase().includes(search))
  );

  if (filter !== 'all') {
    const now = new Date();
    filtered = filtered.filter(q => {
      const quoteDate = new Date(q.date);
      if (filter === 'today') {
        return quoteDate.toDateString() === now.toDateString();
      } else if (filter === 'week') {
        const weekAgo = new Date();
        weekAgo.setDate(now.getDate() - 7);
        return quoteDate >= weekAgo;
      } else if (filter === 'month') {
        return quoteDate.getMonth() === now.getMonth() && quoteDate.getFullYear() === now.getFullYear();
      }
    });
  }

  const totalPages = Math.ceil(filtered.length / itemsPerPage);
  if (currentPage > totalPages) currentPage = 1;
  const start = (currentPage - 1) * itemsPerPage;
  const paginated = filtered.slice(start, start + itemsPerPage);

  list.innerHTML = paginated.map(q => `
    <li>
      <a href="#" onclick="showQuoteDetail('${q._id}')">${q.quoteNumber}</a> - ${q.to?.name || ''} (${new Date(q.date).toLocaleDateString()})
    </li>
  `).join('');

  const pagination = document.getElementById('paginationControls');
  pagination.innerHTML = '';
  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    if (i === currentPage) btn.classList.add('active');
    btn.onclick = () => {
      currentPage = i;
      renderQuoteHistory();
    };
    pagination.appendChild(btn);
  }
}
async function showQuoteDetail(id) {
  showLoader(); // 👈 START
      try {
        const res = await fetch(`/api/quotes/${id}`);
        const q = await res.json();
        const detail = document.getElementById('quoteDetailContent');
        detail.setAttribute('data-id', q._id);

        // ✅ Add this block to calculate dollar amounts
const total = parseFloat(q.totals.total || 0);
const total30 = (total * 0.30).toLocaleString(undefined, { minimumFractionDigits: 2 });
const total10 = (total * 0.10).toLocaleString(undefined, { minimumFractionDigits: 2 });


const signatureClientInput = document.getElementById("signatureClientName");
const clientSignatureName = signatureClientInput?.value || q.to?.name || "____________________________";


        const lineItems = q.lineItems.map(item => `
          <tr>
            <td>${item.name}</td>
            <td>${item.description}</td>
           <td>$${item.rate.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
           <td>${item.qty.toLocaleString()}</td>
           <td>$${(item.rate * item.qty).toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>

          </tr>`).join('');

        detail.innerHTML = `
          <h2 style="color: #007bff;">BESF LLC</h2>
          <p><strong>Quote #:</strong> ${q.quoteNumber}</p>
          <p><strong>Date:</strong> ${new Date(q.date).toLocaleDateString()}</p>
          <p><strong>Valid till:</strong> ${new Date(q.validTill).toLocaleDateString()}</p>
          <hr>

          <div style="display: flex; justify-content: space-between;">
            <div>
              <h4>Quote From</h4>
              <p>${q.from.name}<br>${q.from.address}<br>${q.from.email}<br>${q.from.phone}</p>
            </div>
            <div>
              <h4>Quote To</h4>
              <p>${q.to.name}<br>${q.to.address}<br>${q.to.email}<br>${q.to.phone}</p>
            </div>
          </div>

          <h3 style="margin-top: 20px;">Line Items</h3>
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background-color: #f0f0f0;">
                <th>Item</th><th>Description</th><th>Rate</th><th>Qty</th><th>Total</th>
              </tr>
            </thead>
            <tbody>${lineItems}</tbody>
          </table>

          <div style="margin-top: 20px; text-align: right;">
           <p><strong>Subtotal:</strong> $${parseFloat(q.totals.subtotal).toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
           <p><strong>Discount:</strong> $${parseFloat(q.totals.discount).toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
            <p><strong>Tax:</strong> $${parseFloat(q.totals.tax).toLocaleString(undefined, { minimumFractionDigits: 2 })}</p>
            <p><strong style="font-size: 18px;">Total:</strong> 
            <span style="color: #007bff;">$${parseFloat(q.totals.total).toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>
           </p>

          </div>

          <div style="margin-top: 30px;">
            <h3>Notes</h3>
            <p>${q.notes || 'N/A'}</p>
          </div>


<div style="margin-top: 30px;">
  <h3>Payment Terms</h3>
  <p>The total project amount shall be paid in the following phases:</p>
  <ul style="margin-top: 10px; padding-left: 20px;">
    <li><strong>30%</strong> at project start: <strong>$${total30}</strong></li>
    <li><strong>30%</strong> at 50% project completion: <strong>$${total30}</strong></li>
    <li><strong>30%</strong> at 75% project completion: <strong>$${total30}</strong></li>
    <li><strong>10%</strong> at final completion: <strong>$${total10}</strong></li>
  </ul>
  <p style="margin-top: 10px;">All payments are due within 7 days of invoice unless otherwise agreed upon in writing. Late payments may be subject to additional fees.</p>
</div>


          <div style="margin-top: 30px; border-top: 1px solid #ccc; padding-top: 20px;">
            <h3>Agreement</h3>
            <p>If you accept this quote, please sign and return.</p>
             <p><strong>Client Name:</strong> ${clientSignatureName}</p>
            <p><strong>Signature:</strong> ____________________________</p>
            <p><strong>Date:</strong> ____________________________</p>
          </div>
        `;

        document.getElementById('quoteDetailModal').style.display = 'flex';
      } catch (err) {
        console.error('Failed to fetch quote details:', err);
      } finally {
        hideLoader(); // 👈 END
      }
    }

    function printQuoteDetail() {
  const detailContent = document.getElementById("quoteDetailContent");
  const printWindow = window.open('', '_blank');

  const styledHTML = `
    <html>
      <head>
        <meta charset="UTF-8">
        <title>Print Quote</title>
         <style>
          body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            margin: 40px;
            color: #000;
            font-size: 14px;
          }

          h1, h2, h3 {
            margin: 0;
            padding: 0;
          }

          .company {
            color: #0ea5e9;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
          }

          .info-grid {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            margin-bottom: 20px;
          }

          .info-section {
            width: 48%;
          }

          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
          }

          thead {
            background: #f3f4f6;
          }

          th, td {
            padding: 8px;
            text-align: left;
          }

          tr:not(:last-child) td {
            border-bottom: 1px solid #ddd;
          }

          .totals {
            margin-top: 20px;
            text-align: right;
          }

          .totals p {
            margin: 4px 0;
          }

          .totals strong {
            color: #0ea5e9;
          }

          .section {
            margin-top: 40px;
          }

          .signature {
            margin-top: 60px;
          }

          .signature-line {
            display: flex;
            gap: 50px;
            margin-top: 20px;
          }

          .signature-line p {
            border-top: 1px solid #333;
            width: 200px;
            text-align: center;
            margin-top: 20px;
            padding-top: 4px;
          }

          hr {
            margin: 30px 0;
            border: none;
            border-top: 1px solid #ccc;
          }
        </style>
      </head>
      <body>
        ${detailContent.innerHTML}
      </body>
    </html>
  `;

  printWindow.document.write(styledHTML);
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
}


    async function shareQuoteDetail() {
  const detail = document.getElementById('quoteDetailContent');
  if (!detail) return alert('No quote loaded.');

  const styledHTML = `
    <html>
      <head>
        <meta charset="UTF-8">
        <title>Quote Details</title>
       <style>
          body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            margin: 40px;
            color: #000;
            font-size: 14px;
          }

          h1, h2, h3 {
            margin: 0;
            padding: 0;
          }

          .company {
            color: #0ea5e9;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
          }

          .info-grid {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            margin-bottom: 20px;
          }

          .info-section {
            width: 48%;
          }

          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
          }

          thead {
            background: #f3f4f6;
          }

          th, td {
            padding: 8px;
            text-align: left;
          }

          tr:not(:last-child) td {
            border-bottom: 1px solid #ddd;
          }

          .totals {
            margin-top: 20px;
            text-align: right;
          }

          .totals p {
            margin: 4px 0;
          }

          .totals strong {
            color: #0ea5e9;
          }

          .section {
            margin-top: 40px;
          }

          .signature {
            margin-top: 60px;
          }

          .signature-line {
            display: flex;
            gap: 50px;
            margin-top: 20px;
          }

          .signature-line p {
            border-top: 1px solid #333;
            width: 200px;
            text-align: center;
            margin-top: 20px;
            padding-top: 4px;
          }

          hr {
            margin: 30px 0;
            border: none;
            border-top: 1px solid #ccc;
          }
        </style>
      </head>
      <body>
        ${detail.innerHTML}
      </body>
    </html>
  `;

  const blob = new Blob([styledHTML], { type: 'text/html' });
  const file = new File([blob], 'quote-details.html', { type: 'text/html' });
  showLoader(); // 👈 START
  try {
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({
        title: 'Quote Details',
        text: 'Here is the quote you requested.',
        files: [file]
      });
    } else {
      showToast('Sharing not supported on this device.');
    }
  } catch (err) {
    console.error('Error sharing quote:', err);
    showToast('Failed to share quote.');
  } finally {
    hideLoader(); // 👈 END
  }
}


    async function deleteQuoteDetail() {
      const detail = document.getElementById('quoteDetailContent');
      const id = detail.getAttribute('data-id');
      if (!id || !confirm('Are you sure you want to delete this quote?')) return;
      showLoader(); // 👈 START
      try {
        const res = await fetch(`/api/quotes/${id}`, { method: 'DELETE' });
        if (res.ok) {
          showToast('Quote deleted.');
          closeQuoteDetail();
          loadQuoteHistory();
        } else {
          showToast('Failed to delete quote.');
        }
      } catch (err) {
        console.error('Delete error:', err);
      } finally {
        hideLoader(); // 👈 END
      }
    }


    let laborCostList = [];

    function openLaborCostModal() {
  document.getElementById('laborCostModal').style.display = 'flex';
  fetchLaborSuggestions();
  if (window.innerWidth >= 768) {
    document.body.classList.add('sidebar-open');
  }
}

function closeLaborCostModal() {
  document.getElementById('laborCostModal').style.display = 'none';
  if (window.innerWidth >= 768) {
    document.body.classList.remove('sidebar-open');
  }
}

  async function fetchLaborSuggestions() {
    showLoader(); // 👈 START
    try {
      const res = await fetch('/api/labor-costs');
      laborCostList = await res.json();
      renderLaborSuggestions();
    } catch (err) {
      console.error('Failed to load labor suggestions:', err);
    } finally {
      hideLoader(); // 👈 END
    }
  }

  // --- RENDER LABOR SUGGESTIONS (NEW SCHEMA) ---
    function renderLaborSuggestions() {
      const query = document.getElementById('laborSearchInput').value.toLowerCase();
      const list = document.getElementById('laborSuggestionList');
      list.innerHTML = '';

      // ...expand/collapse controls (unchanged)...

      const controls = document.createElement('div');
      controls.style.display = 'flex';
      controls.style.justifyContent = 'flex-end';
      controls.style.gap = '10px';
      controls.style.marginBottom = '10px';

      const expandAllBtn = document.createElement('button');
      expandAllBtn.textContent = 'Expand All';
      expandAllBtn.className = 'btn';
      expandAllBtn.style.padding = '6px 12px';
      expandAllBtn.onclick = () => {
        list.querySelectorAll('ul').forEach(ul => ul.style.display = 'block');
        list.querySelectorAll('li > div > span').forEach(span => span.textContent = '➖');
      };

      const collapseAllBtn = document.createElement('button');
      collapseAllBtn.textContent = 'Collapse All';
      collapseAllBtn.className = 'btn';
      collapseAllBtn.style.padding = '6px 12px';
      collapseAllBtn.onclick = () => {
        list.querySelectorAll('ul').forEach(ul => ul.style.display = 'none');
        list.querySelectorAll('li > div > span').forEach(span => span.textContent = '➕');
      };

      controls.appendChild(expandAllBtn);
      controls.appendChild(collapseAllBtn);
      list.appendChild(controls);

      // Group by room
      const groups = {};
      laborCostList.forEach((item, index) => {
        let room = 'General';
        const parts = item.name.split('-');
        if (parts.length > 1) room = parts[1].trim().toLowerCase();
        if (!groups[room]) groups[room] = [];
        groups[room].push({ item, index });
      });

      const sortedRooms = Object.keys(groups).sort((a, b) => a.localeCompare(b));
      for (const roomName of sortedRooms) {
        const groupItems = groups[roomName];
        const filtered = groupItems.filter(({ item }) =>
          item.name.toLowerCase().includes(query) || item.description.toLowerCase().includes(query)
        );
        if (query && filtered.length === 0) continue;
        const groupContainer = document.createElement('li');
        groupContainer.style.marginTop = '15px';
        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.justifyContent = 'space-between';
        header.style.alignItems = 'center';
        header.style.cursor = 'pointer';
        header.style.padding = '8px 12px';
        header.style.background = '#f0f4f8';
        header.style.borderRadius = '8px';
        header.style.fontWeight = 'bold';
        header.style.color = '#007bff';
        header.style.textTransform = 'capitalize';
        header.innerHTML = ` ${roomName} <span style="font-size: 18px;">➕</span>`;
        const itemList = document.createElement('ul');
        itemList.style.listStyle = 'none';
        itemList.style.paddingLeft = '15px';
        itemList.style.display = query ? 'block' : 'none';
        header.onclick = () => {
          if (itemList.style.display === 'none') {
            itemList.style.display = 'block';
            header.querySelector('span').textContent = '➖';
          } else {
            itemList.style.display = 'none';
            header.querySelector('span').textContent = '➕';
          }
        };
        groupContainer.appendChild(header);
        (query ? filtered : groupItems).forEach(({ item, index }) => {
          const li = document.createElement('li');
          li.style.marginTop = '8px';
          li.innerHTML = `
            <div style="border: 1px solid #ccc; padding: 10px; border-radius: 8px; background: #f9f9f9; position: relative;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div onclick="useSuggestedLabor(${index})" style="flex: 1; padding-right: 10px; cursor:pointer;">
                  <small style="color: #64748b;"><strong>cost code:</strong> ${item.costCode || '-'}</small><br>
                  <strong>${item.name}</strong><br>
                  <small>${item.description}</small><br>
                  <div style="margin: 6px 0 2px 0;">
                    ${(() => {
                      const lr = Number(item.laborRate) || 0;
                      const mr = Number(item.materialRate) || 0;
                      const lh = lr ? ((Number(item.laborHours) || 1)) : (Number(item.laborHours) || 0);
                      const mq = mr ? ((Number(item.materialQty) || 1)) : (Number(item.materialQty) || 0);
                      const hasBreakdown = (lr || mr);
                      const laborCost = hasBreakdown ? (lr * lh) : (Number(item.baseRate) || 0);
                      const materialCost = hasBreakdown ? (mr * mq) : 0;
                      const mk = Number(item.markup) || 0;
                      const mm = item.markupMode || 'percent';
                      const total = item.totalCost ?? (mm === 'amount' ? (laborCost + materialCost + mk) : ((laborCost + materialCost) * (1 + mk/100)));
                      const markupText = mm === 'amount' ? `$${mk.toFixed(2)}` : `${mk.toFixed(2)}%`;
                      return `
                        <div class=\"suggestion-total-row\" id=\"total-head-${index}\" onclick=\"toggleSuggestionDetails(event, ${index})\">
                          <span class=\"total-amount\"><b></b> $${total.toFixed(2)}</span>
                          <span id=\"chev-${index}\" class=\"chevron\">▸</span>
                        </div>
                        <div id=\"cost-details-${index}\" style=\"display:none;margin-top:4px;\">
                          <span style=\"color:#7c3aed;\"><b>Labor:</b> $${laborCost.toFixed(2)} ${hasBreakdown ? `(${lr} × ${lh})` : `(manual)`}</span><br>
                          <span style=\"color:#16a34a;\"><b>Material:</b> $${materialCost.toFixed(2)} ${hasBreakdown ? `(${mr} × ${mq})` : `(—)`}</span><br>
                          <span style=\"color:#2563eb;\"><b>Markup:</b> ${markupText}</span><br>
                          <span style=\"color:#64748b;font-size:12px;\"> [${item.calcMode || 'each'}${item.unit ? ', ' + item.unit : ''}]</span>
                        </div>
                      `;
                    })()}
                  </div>
                </div>
                <div class="action-dropdown">
                  <button class="dots" onclick="toggleActionDropdown(event, ${index})">⋮</button>
                  <div class="action-dropdown-content" id="action-menu-${index}">
                    <button onclick="useSuggestedLabor(${index})">Use</button>
                    <button onclick="editLaborItem(${index})">Edit</button>
                    <button onclick="deleteLaborItem(${index})">Delete</button>
                  </div>
                </div>
              </div>
            </div>
          `;
          itemList.appendChild(li);
        });
        groupContainer.appendChild(itemList);
        list.appendChild(groupContainer);
      }
      // Reset footer totals when rendering the list
      if (typeof updateLaborSuggestionsFooter === 'function') updateLaborSuggestionsFooter(null);
    }




  function toggleSuggestionDetails(event, index) {
    if (event && event.stopPropagation) event.stopPropagation();
    const details = document.getElementById(`cost-details-${index}`);
    const chev = document.getElementById(`chev-${index}`);
    const head = document.getElementById(`total-head-${index}`);
    if (!details || !chev) return;
    const open = details.style.display !== 'none';
    details.style.display = open ? 'none' : 'block';
    chev.textContent = open ? '▸' : '▾';
    if (head && head.classList) head.classList.toggle('open', !open);
  }

  function toggleActionDropdown(event, index) {
    event.stopPropagation();
    const menu = document.getElementById(`action-menu-${index}`);
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    document.addEventListener('click', () => (menu.style.display = 'none'), { once: true });
  }

    // --- DYNAMIC CALCULATION FOR ADD LABOR ITEM ---
    function updateNewLaborCostFields() {
  const laborRate = parseFloat(document.getElementById('newLaborLaborRate').value) || 0;
  let laborHours = parseFloat(document.getElementById('newLaborLaborHours').value);
  if (!laborHours || isNaN(laborHours)) laborHours = 1;
  const materialRate = parseFloat(document.getElementById('newLaborMaterialRate').value) || 0;
  let materialQty = parseFloat(document.getElementById('newLaborMaterialQty').value);
  if (!materialQty || isNaN(materialQty)) materialQty = 1;
  const baseRate = parseFloat(document.getElementById('newBaseRate').value) || 0;
  const markup = parseFloat(document.getElementById('newLaborMarkup').value) || 0;
  const mode = document.getElementById('newMarkupToggle')?.dataset?.mode || 'percent';
      const hasBreakdown = (laborRate || materialRate);
      const laborCost = hasBreakdown ? (laborRate * laborHours) : baseRate;
      const materialCost = hasBreakdown ? (materialRate * materialQty) : 0;
      const subtotal = laborCost + materialCost;
      const totalCost = mode === 'amount' ? (subtotal + markup) : (subtotal * (1 + markup / 100));
      document.getElementById('newLaborLaborCost').textContent = laborCost.toFixed(2);
      document.getElementById('newLaborMaterialCost').textContent = materialCost.toFixed(2);
      document.getElementById('newLaborTotalCost').textContent = totalCost.toFixed(2);
    }
    ['newLaborLaborRate','newLaborLaborHours','newLaborMaterialRate','newLaborMaterialQty','newLaborMarkup','newBaseRate'].forEach(id => {
      document.getElementById(id).addEventListener('input', updateNewLaborCostFields);
    });
    // Toggle and mutual exclusivity for New Labor
    document.getElementById('newMarkupToggle')?.addEventListener('click', function(){
      const cur = this.dataset.mode === 'amount' ? 'amount' : 'percent';
      const next = cur === 'amount' ? 'percent' : 'amount';
      this.dataset.mode = next;
      this.textContent = next === 'amount' ? '$' : '%';
      updateNewLaborCostFields();
    });
    document.getElementById('newBaseRate')?.addEventListener('input', function(){
      if (this.value !== '') {
        ['newLaborLaborRate','newLaborLaborHours','newLaborMaterialRate','newLaborMaterialQty'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = '';
        });
      }
      updateNewLaborCostFields();
    });
    ['newLaborLaborRate','newLaborLaborHours','newLaborMaterialRate','newLaborMaterialQty'].forEach(id => {
      document.getElementById(id)?.addEventListener('input', function(){
        if (this.value !== '') {
          const base = document.getElementById('newBaseRate');
          if (base) base.value = '';
        }
      });
    });

    // --- DYNAMIC CALCULATION FOR EDIT LABOR ITEM ---
    function updateEditLaborCostFields() {
  const laborRate = parseFloat(document.getElementById('editLaborLaborRate').value) || 0;
  let laborHours = parseFloat(document.getElementById('editLaborLaborHours').value);
  if (laborRate && (!laborHours || isNaN(laborHours))) laborHours = 1;
  const materialRate = parseFloat(document.getElementById('editLaborMaterialRate').value) || 0;
  let materialQty = parseFloat(document.getElementById('editLaborMaterialQty').value);
  if (materialRate && (!materialQty || isNaN(materialQty))) materialQty = 1;
  const baseRate = parseFloat(document.getElementById('editBaseRate').value) || 0;
  const markup = parseFloat(document.getElementById('editLaborMarkup').value) || 0;
  const mode = document.getElementById('editMarkupToggle')?.dataset?.mode || 'percent';
      const hasBreakdown = (laborRate || materialRate);
      const laborCost = hasBreakdown ? (laborRate * (laborHours || 0)) : baseRate;
      const materialCost = hasBreakdown ? (materialRate * (materialQty || 0)) : 0;
      const subtotal = laborCost + materialCost;
      const totalCost = mode === 'amount' ? (subtotal + markup) : (subtotal * (1 + markup / 100));
      document.getElementById('editLaborLaborCost').textContent = laborCost.toFixed(2);
      document.getElementById('editLaborMaterialCost').textContent = materialCost.toFixed(2);
      const mkSpan = document.getElementById('editLaborMarkupDisplay');
      if (mkSpan) mkSpan.textContent = (mode === 'amount') ? `$${markup.toFixed(2)}` : `${markup.toFixed(2)}%`;
      document.getElementById('editLaborTotalCost').textContent = totalCost.toFixed(2);
    }
    ['editLaborLaborRate','editLaborLaborHours','editLaborMaterialRate','editLaborMaterialQty','editLaborMarkup','editBaseRate'].forEach(id => {
      document.getElementById(id)?.addEventListener('input', updateEditLaborCostFields);
    });
    // Toggle and mutual exclusivity
    document.getElementById('editMarkupToggle')?.addEventListener('click', function(){
      const cur = this.dataset.mode === 'amount' ? 'amount' : 'percent';
      const next = cur === 'amount' ? 'percent' : 'amount';
      this.dataset.mode = next;
      this.textContent = next === 'amount' ? '$' : '%';
      updateEditLaborCostFields();
    });
    document.getElementById('editBaseRate')?.addEventListener('input', function(){
      if (this.value !== '') {
        ['editLaborLaborRate','editLaborLaborHours','editLaborMaterialRate','editLaborMaterialQty'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = '';
        });
      }
      updateEditLaborCostFields();
    });
    ['editLaborLaborRate','editLaborLaborHours','editLaborMaterialRate','editLaborMaterialQty'].forEach(id => {
      document.getElementById(id)?.addEventListener('input', function(){
        if (this.value !== '') {
          const base = document.getElementById('editBaseRate');
          if (base) base.value = '';
        }
      });
    });

    // --- ADD LABOR ITEM (NEW SCHEMA) ---
    async function addLaborItem() {
      const name = document.getElementById('newLaborName').value;
      const description = document.getElementById('newLaborDesc').value;
      const costCode = document.getElementById('newLaborCode').value;
  const laborRate = parseFloat(document.getElementById('newLaborLaborRate').value) || 0;
  let laborHours = parseFloat(document.getElementById('newLaborLaborHours').value);
  if (!laborHours || isNaN(laborHours)) laborHours = 1;
  const materialRate = parseFloat(document.getElementById('newLaborMaterialRate').value) || 0;
  let materialQty = parseFloat(document.getElementById('newLaborMaterialQty').value);
  if (!materialQty || isNaN(materialQty)) materialQty = 1;
  const calcMode = document.getElementById('newLaborCalcMode').value;
  const unit = document.getElementById('newLaborUnit').value;
  const markup = parseFloat(document.getElementById('newLaborMarkup').value) || 0;
  const baseRate = parseFloat(document.getElementById('newBaseRate').value) || 0;
  const markupMode = document.getElementById('newMarkupToggle')?.dataset?.mode || 'percent';

      const hasBreakdown = (laborRate || materialRate);
      if (!name || !description || (!hasBreakdown && !baseRate)) return alert('Please fill all fields correctly (provide base rate or labor/material).');
      showLoader();
      try {
        const res = await fetch('/api/labor-costs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name, description, costCode,
            laborRate, laborHours,
            materialRate, materialQty,
            calcMode, unit,
            markup,
            baseRate, markupMode
          })
        });
        const newItem = await res.json();
        laborCostList.unshift(newItem);
        renderLaborSuggestions();
        // Auto-close the New Labor form on success
        const formEl = document.getElementById('newLaborFormContainer');
        if (formEl) formEl.style.display = 'none';
      } catch (err) {
        console.error('Error adding labor item:', err);
      } finally {
        hideLoader();
        ['newLaborName', 'newLaborDesc', 'newLaborCode', 'newLaborLaborRate', 'newLaborLaborHours', 'newLaborMaterialRate', 'newLaborMaterialQty', 'newLaborUnit','newLaborMarkup','newBaseRate'].forEach(id => {
          // keep hidden qtys set to 1
          if (id === 'newLaborLaborHours' || id === 'newLaborMaterialQty') document.getElementById(id).value = '1';
          else document.getElementById(id).value = '';
        });
        const t = document.getElementById('newMarkupToggle'); if (t) { t.dataset.mode = 'percent'; t.textContent = '%'; }
        updateNewLaborCostFields();
      }
    }


let currentEditingLaborIndex = null; // 🔵 Store which labor item is being edited

    // --- EDIT LABOR ITEM (NEW SCHEMA) ---
    function editLaborItem(index) {
      const item = laborCostList[index];
      currentEditingLaborIndex = index;
      document.getElementById('editLaborCode').value = item.costCode || '';
      document.getElementById('editLaborName').value = item.name;
      document.getElementById('editLaborDesc').value = item.description;
  document.getElementById('editLaborLaborRate').value = item.laborRate || 0;
  // set hidden qtys to stored values or default to 1
  document.getElementById('editLaborLaborHours').value = (item.laborHours != null && item.laborHours !== 0) ? item.laborHours : 1;
  document.getElementById('editLaborMaterialRate').value = item.materialRate || 0;
  document.getElementById('editLaborMaterialQty').value = (item.materialQty != null && item.materialQty !== 0) ? item.materialQty : 1;
    // populate markup input
    document.getElementById('editLaborMarkup').value = item.markup ?? 0;
    const baseInput = document.getElementById('editBaseRate');
    if (baseInput) baseInput.value = item.baseRate || 0;
    const toggle = document.getElementById('editMarkupToggle');
    if (toggle) {
      const mode = item.markupMode || 'percent';
      toggle.dataset.mode = mode;
      toggle.textContent = mode === 'amount' ? '$' : '%';
    }
      document.getElementById('editLaborCalcMode').value = item.calcMode || 'each';
      document.getElementById('editLaborUnit').value = item.unit || '';
      updateEditLaborCostFields();
      document.getElementById('editLaborModal').style.display = 'flex';
    }

function closeEditLaborModal() {
  document.getElementById('editLaborModal').style.display = 'none';
}

  async function saveEditedLaborItem() {
      if (currentEditingLaborIndex === null) return;
      const id = laborCostList[currentEditingLaborIndex]._id;
      const name = document.getElementById('editLaborName').value.trim();
      const description = document.getElementById('editLaborDesc').value.trim();
      const costCode = document.getElementById('editLaborCode').value.trim();
      const laborRate = parseFloat(document.getElementById('editLaborLaborRate').value) || 0;
  let laborHours = parseFloat(document.getElementById('editLaborLaborHours').value);
  if (!laborHours || isNaN(laborHours)) laborHours = 1;
      const materialRate = parseFloat(document.getElementById('editLaborMaterialRate').value) || 0;
  let materialQty = parseFloat(document.getElementById('editLaborMaterialQty').value);
  if (!materialQty || isNaN(materialQty)) materialQty = 1;
  const calcMode = document.getElementById('editLaborCalcMode').value;
  const unit = document.getElementById('editLaborUnit').value;
  const markup = parseFloat(document.getElementById('editLaborMarkup').value) || 0;
  const baseRate = parseFloat(document.getElementById('editBaseRate').value) || 0;
  const markupMode = document.getElementById('editMarkupToggle')?.dataset?.mode || 'percent';

      if (!name || !description || isNaN(laborRate)) {
        alert('Please fill all fields correctly.');
        return;
      }

      showLoader();
      try {
        const res = await fetch(`/api/labor-costs/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name, description, costCode,
            laborRate, laborHours,
            materialRate, materialQty,
            calcMode, unit,
            markup,
            baseRate, markupMode
          })
        });
        const updated = await res.json();
        laborCostList[currentEditingLaborIndex] = updated;
        renderLaborSuggestions();
        showToast('✅ Labor item updated.');
      } catch (err) {
        console.error('Error updating labor item:', err);
        showToast('❌ Failed to update labor item.');
      } finally {
        hideLoader();
        closeEditLaborModal();
        currentEditingLaborIndex = null;
      }
    }



  async function deleteLaborItem(index) {
    const item = laborCostList[index];
    if (!confirm('Are you sure you want to delete this item?')) return;
    showLoader(); // 👈 START
    try {
      await fetch(`/api/labor-costs/${item._id}`, { method: 'DELETE' });
      laborCostList.splice(index, 1);
      renderLaborSuggestions();
    } catch (err) {
      console.error('Error deleting labor item:', err);
    } finally {
      hideLoader(); // 👈 END
    }
  }





    // --- USE SUGGESTED LABOR (NEW SCHEMA) ---
    function useSuggestedLabor(index) {
      const item = laborCostList[index];
      const nameField = document.getElementById('itemName');
      const descField = document.getElementById('itemDesc');
      const rateField = document.getElementById('itemRate');
      const qtyField = document.getElementById('itemQty');
      const costCodeField = document.getElementById('itemCode');
      const laborRateField = document.getElementById('laborRate');
      const laborHoursField = document.getElementById('laborHours');
      const materialRateField = document.getElementById('materialRate');
      const materialQtyField = document.getElementById('materialQty');
      const markupField = document.getElementById('markup');
  // Compute base and total with support for manual base and markup modes
  const lr = Number(item.laborRate) || 0;
  const mr = Number(item.materialRate) || 0;
  const lh = lr ? ((Number(item.laborHours) || 1)) : (Number(item.laborHours) || 0);
  const mq = mr ? ((Number(item.materialQty) || 1)) : (Number(item.materialQty) || 0);
  const hasBreakdown = (lr || mr);
  const laborCost = hasBreakdown ? (lr * lh) : (Number(item.baseRate) || 0);
  const materialCost = hasBreakdown ? (mr * mq) : 0;
  const mk = Number(item.markup) || 0;
  const mm = item.markupMode || 'percent';
  const base = laborCost + materialCost;
  const totalCost = item.totalCost ?? (mm === 'amount' ? (base + mk) : (base * (1 + mk/100)));
      if (nameField) nameField.value = item.name || '';
      if (descField) descField.value = item.description || '';
      if (markupField) markupField.value = mk;
      const markupToggle = document.getElementById('markupToggle');
      if (markupToggle) { markupToggle.dataset.mode = mm; markupToggle.textContent = (mm === 'amount') ? '$' : '%'; }
      if (rateField) {
        if (hasBreakdown) { rateField.value = base; try { rateField.dataset.autofill = '1'; } catch(_){} }
        else { rateField.value = (Number(item.baseRate) || 0); try { delete rateField.dataset.autofill; } catch(_){} }
      }
      if (qtyField) qtyField.value = 1;
      if (costCodeField) costCodeField.value = item.costCode || '';
  if (hasBreakdown) {
    if (laborRateField) laborRateField.value = item.laborRate ?? '';
    if (laborHoursField) laborHoursField.value = (item.laborHours != null && item.laborHours !== 0) ? item.laborHours : '1';
    if (materialRateField) materialRateField.value = item.materialRate ?? '';
    if (materialQtyField) materialQtyField.value = (item.materialQty != null && item.materialQty !== 0) ? item.materialQty : '1';
  } else {
    if (laborRateField) laborRateField.value = '';
    if (laborHoursField) laborHoursField.value = '1';
    if (materialRateField) materialRateField.value = '';
    if (materialQtyField) materialQtyField.value = '1';
  }
      // Store fields for addLineItem, including baseRate and markupMode
      window.lastLaborSuggestion = {
        laborRate: item.laborRate,
        laborHours: item.laborHours,
        materialRate: item.materialRate,
        materialQty: item.materialQty,
        baseRate: Number(item.baseRate) || 0,
        markup: mk,
        markupMode: mm
      };
      // Update the computed total preview (use global export if needed)
      try { if (typeof window.recalcLineItemTotal === 'function') window.recalcLineItemTotal(); else if (typeof recalcLineItemTotal === 'function') recalcLineItemTotal(); } catch (_) {}
      if (typeof updateFloatingLabels === 'function') updateFloatingLabels();
      // Update suggestions footer totals for this item
      try { updateLaborSuggestionsFooter(item); } catch (_) {}
      
    }




function openEditRoomPackageModal(packageKey) {
  // If the package doesn't exist, create a new one with an empty items array
  if (!roomPackages[packageKey]) {
    roomPackages[packageKey] = {
      name: packageKey
        .replace(/([A-Z])/g, ' $1')
        .replace(/^./, str => str.toUpperCase())
        .replace(/\s+/, ' ')
        .trim() + " Package",
      items: []
    };
  }
  editingPackageKey = packageKey;
  editingPackageItems = JSON.parse(JSON.stringify(roomPackages[packageKey].items)); // Deep copy
  renderEditRoomPackageModal();
  document.getElementById('editRoomPackageModal').style.display = 'flex';

    // Auto-resize all textareas after modal is shown
  setTimeout(() => {
    document.querySelectorAll('#editRoomPackageContent textarea').forEach(autoResizeTextarea);
  }, 0);

  // Load labor costs if not already loaded
  if (!laborCostList.length) fetchLaborSuggestions();
  renderLaborSuggestionsForPackage();
}

function closeEditRoomPackageModal() {
  document.getElementById('editRoomPackageModal').style.display = 'none';
  editingPackageKey = null;
  editingPackageItems = [];
}

function autoResizeTextarea(textarea) {
  textarea.style.height = 'auto'; // Reset height
  textarea.style.height = textarea.scrollHeight + 'px'; // Set to scroll height
}

function renderEditRoomPackageModal() {
  const content = document.getElementById('editRoomPackageContent');
  content.innerHTML = `
    <h4>${roomPackages[editingPackageKey].name}</h4>
    <table style="width:100%;margin-bottom:10px;">
      <thead>
        <tr>
          <th>Cost Code</th>
          <th>Item</th>
          <th>Description</th>
          <th>Rate</th>
          <th>Qty</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        ${editingPackageItems.map((item, idx) => `
          <tr>
            <td><input value="${item.costCode || ''}" onchange="updateEditingPackageItem(${idx}, 'costCode', this.value)" style="width:90px;" /></td>
            <td><input value="${item.name}" onchange="updateEditingPackageItem(${idx}, 'name', this.value)" style="width:120px;" /></td>
            <td>
              <textarea
                onchange="updateEditingPackageItem(${idx}, 'description', this.value)"
                oninput="autoResizeTextarea(this)"
                style="min-width:120px; width:280px; overflow:hidden; min-height:30px;"
                rows="1"
              >${item.description || ''}</textarea>
            </td>
            <td><input type="number" value="${item.rate}" onchange="updateEditingPackageItem(${idx}, 'rate', this.value)" style="width:70px;" /></td>
            <td><input type="number" value="${item.qty}" onchange="updateEditingPackageItem(${idx}, 'qty', this.value)" style="width:50px;" /></td>
            <td><button onclick="removeEditingPackageItem(${idx})" style="color:red;">🗑️</button></td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;

  // Auto-resize all textareas after rendering
  content.querySelectorAll('textarea').forEach(textarea => autoResizeTextarea(textarea));
}

function updateEditingPackageItem(idx, field, value) {
  if (field === 'rate' || field === 'qty') value = Number(value);
  editingPackageItems[idx][field] = value;
}

function removeEditingPackageItem(idx) {
  editingPackageItems.splice(idx, 1);
  renderEditRoomPackageModal();
}

async function saveRoomPackageEdits() {
  if (editingPackageKey && roomPackages[editingPackageKey]) {
    // Save to backend
    try {
      showLoader();
      const res = await fetch(`/api/room-packages/${editingPackageKey}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: roomPackages[editingPackageKey].name,
          items: editingPackageItems
        })
      });
      if (!res.ok) throw new Error('Failed to save');
      const updated = await res.json();
      roomPackages[editingPackageKey] = { name: updated.name, items: updated.items };
      showToast('Room package updated!');
      closeEditRoomPackageModal();
    } catch (err) {
      showToast('Failed to save room package');
    } finally {
      hideLoader();
    }
  }
}

// --- Labor cost suggestion for package modal ---
function renderLaborSuggestionsForPackage() {
  const query = document.getElementById('laborSearchForPackage').value.toLowerCase();
  const list = document.getElementById('laborSuggestionListForPackage');
  list.innerHTML = '';
  const matches = laborCostList.filter(item =>
    item.name.toLowerCase().includes(query) ||
    (item.description && item.description.toLowerCase().includes(query))
  );
  matches.forEach(item => {
    const li = document.createElement('li');
    li.style.marginBottom = '6px';
    // compute display rate from breakdown if needed
    const _laborCost = item.laborCost ?? ((item.laborRate || 0) * (item.laborHours || 0));
    const _materialCost = item.materialCost ?? ((item.materialRate || 0) * (item.materialQty || 0));
    const _markupPct = Number(item.markup || 0);
    const _displayRate = item.totalCost ?? ((_laborCost + _materialCost) * (1 + _markupPct / 100));
    li.innerHTML = `
      <div style="border:1px solid #eee; border-radius:6px; padding:6px; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <strong>${item.name}</strong><br>
          <small>${item.description || ''}</small><br>
          <span style="color:#007bff;">$${_displayRate}</span>
        </div>
        <button class="btn" style="padding:4px 10px; font-size:13px;" onclick="addLaborToEditingPackage('${item.costCode || ''}', '${item.name.replace(/'/g,"\\'")}', '${(item.description||'').replace(/'/g,"\\'")}', ${item.laborRate || 0}, ${item.laborHours || 0}, ${item.materialRate || 0}, ${item.materialQty || 0}, ${_markupPct})">Add</button>
      </div>
    `;
    list.appendChild(li);
  });
}

function addLaborToEditingPackage(costCode, name, description, laborRate, laborHours, materialRate, materialQty, markup) {
  // compute total rate from breakdown and markup
  laborRate = Number(laborRate) || 0;
  laborHours = Number(laborHours) || 0;
  materialRate = Number(materialRate) || 0;
  materialQty = Number(materialQty) || 0;
  markup = Number(markup) || 0;
  const laborCost = laborRate * laborHours;
  const materialCost = materialRate * materialQty;
  const totalRate = (laborCost + materialCost) * (1 + markup / 100);

  editingPackageItems.push({
    costCode,
    name,
    description,
    rate: Number(totalRate) || 0,
    qty: 1,
    laborRate,
    laborHours,
    materialRate,
    materialQty,
    markup
  });
  renderEditRoomPackageModal();
}

 
  window.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const modalToOpen = params.get('modal');
    

    if (modalToOpen === 'laborCost' && typeof openLaborCostModal === 'function') {
      openLaborCostModal();
    }
  });

  window.openLaborCostModal = openLaborCostModal;




  // Add this after your existing script tag content

// Define room packages with their line items




// Function to add package items
function addRoomPackage(packageType) {
  const package = roomPackages[packageType];
  if (!package) {
    showToast('Package not found');
    return;
  }

  // Add all items from the package to lineItems array
  package.items.forEach(item => {
    lineItems.push({
      costCode: item.costCode,
      name: item.name,
      description: item.description,
      rate: item.rate,
      qty: item.qty
    });
  });

  // Render the updated table
  renderTable();
  showToast(`✅ Added ${package.name} package`);
}




// Add these functions to your JavaScript
function togglePackageDropdown() {
    const content = document.getElementById('packageDropdownContent');
    const arrow = document.querySelector('.dropdown-arrow');
    content.classList.toggle('show');
    arrow.style.transform = content.classList.contains('show') ? 'rotate(180deg)' : 'rotate(0)';
}

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
    const dropdown = document.querySelector('.package-dropdown');
    const content = document.getElementById('packageDropdownContent');
    
    if (!dropdown?.contains(e.target)) {
        content?.classList.remove('show');
        document.querySelector('.dropdown-arrow').style.transform = 'rotate(0)';
    }
});


// Toggle visibility of the New Labor form below the suggestions list
function toggleNewLaborForm() {
  const el = document.getElementById('newLaborFormContainer');
  if (!el) return;
  const showing = el.style.display !== 'none';
  el.style.display = showing ? 'none' : 'block';
  if (!showing) {
    // Ensure preview is up to date when opening
    try { updateNewLaborCostFields(); } catch (_) {}
    // Optional: scroll into view
    try { el.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch (_) {}
  }
}

// Click-away to close the New Labor form
document.addEventListener('click', (e) => {
  const formEl = document.getElementById('newLaborFormContainer');
  if (!formEl || formEl.style.display === 'none') return;
  const clickInsideForm = formEl.contains(e.target);
  const onPlusIcon = e.target.closest('.add-labor-inline-btn');
  if (!clickInsideForm && !onPlusIcon) {
    formEl.style.display = 'none';
  }
});

// Update the footer totals below the suggestions list
function updateLaborSuggestionsFooter() {
  const mkEl = document.getElementById('suggestionsMarkupTotal');
  const gtEl = document.getElementById('suggestionsGrandTotal');
  if (!mkEl || !gtEl) return;
  // Mirror the main summary-box values
  const mainMk = document.getElementById('markupTotal')?.textContent || '0.00';
  const mainGt = document.getElementById('grandTotal')?.textContent || '0.00';
  mkEl.textContent = mainMk;
  gtEl.textContent = mainGt;
}



  </script>
</body>
</html>
