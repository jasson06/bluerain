<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
   <style>
    /* Base Styles */
:root {
    --primary-color: #2c3e50;
    --secondary-color: #34495e;
    --accent-color: #3498db;
    --background-color: #f5f6fa;
    --text-color: #2c3e50;
    --border-color: #dcdde1;
    --success-color: #27ae60;
    --warning-color: #f1c40f;
    --danger-color: #e74c3c;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--background-color);
    color: var(--text-color);
}

.container {
    display: flex;
    height: 100vh;
    overflow: hidden;
}

/* --- Modern Modal Styles (Apply Globally) --- */
.modal .modal-content {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(44,62,80,0.13);
    padding: 32px 32px 24px 32px;
    max-width: 1100px;
    margin: -10px auto;
    position: relative;
    font-size: 1.05rem;
}

.modal h2 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 24px;
    letter-spacing: 0.5px;
    text-align: center;
}

.modal form .form-row {
    display: flex;
    gap: 18px;
    flex-wrap: wrap;
    margin-bottom: 0;
}

.modal form .form-group {
    flex: 1 1 180px;
    display: flex;
    flex-direction: column;
    margin-bottom: 18px;
}

.modal form .form-group label {
    font-weight: 600;
    margin-bottom: 7px;
    color: var(--primary-color, #2c3e50);
    font-size: 1.01rem;
    letter-spacing: 0.1px;
}

.modal form .form-group input,
.modal form .form-group select,
.modal form .form-group textarea {
    padding: 10px 12px;
    border-radius: 8px;
    border: 1.5px solid #e1e8ed;
    font-size: 1.05rem;
    background: #f9fafb;
    transition: border 0.2s;
    margin-bottom: 2px;
}

.modal form .form-group input:focus,
.modal form .form-group select:focus,
.modal form .form-group textarea:focus {
    border-color: var(--accent-color, #3498db);
    outline: none;
}

.modal form textarea {
    min-height: 38px;
    resize: vertical;
}

.modal form .modal-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 14px;
    margin-top: 24px;
}

.modal form .btn-primary,
.modal form .btn-secondary {
    min-width: 120px;
    font-size: 1.07rem;
    font-weight: 600;
    padding: 11px 22px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: background 0.18s, color 0.18s;
}

.modal form .btn-primary {
    background: linear-gradient(90deg, #3498db 0%, #6dd5fa 100%);
    color: #fff;
}

.modal form .btn-primary:hover {
    background: linear-gradient(90deg, #217dbb 0%, #4fc3f7 100%);
}

.modal form .btn-secondary {
    background: #e1e8ed;
    color: #2980b9;
}

.modal form .btn-secondary:hover {
    background: #d0d7de;
    color: #217dbb;
}

@media (max-width: 900px) {
    .modal .modal-content {
        padding: 12px 4px 10px 4px;
        max-width: 99vw;
    }
    .modal form .form-row {
        flex-direction: column;
        gap: 8px;
    }
    .modal form .form-group {
        min-width: 0;
    }
    .modal form fieldset {
        padding: 10px 6px 6px 6px;
    }
}


/* Modern Property List Styles */
.property-item {
    background: white;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    cursor: pointer;
    border: 2px solid transparent;
}

.property-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    border-color: var(--accent-color);
}

.property-item.active {
    border-color: var(--accent-color);
    background-color: rgba(52, 152, 219, 0.08);
    box-shadow: 0 4px 16px rgba(52, 152, 219, 0.10);
    transition: background 0.2s, box-shadow 0.2s, border-color 0.2s;
}

.property-item.active h3 {
    color: var(--accent-color);
}

.property-item h3 {
    margin: 0 0 8px 0;
    color: var(--primary-color);
    font-size: 1.1rem;
    font-weight: 500;
}

.property-item p {
    margin: 0 0 12px 0;
    color: var(--text-color);
    font-size: 0.9rem;
}

.property-badges {
    display: flex;
    gap: 8px;
    margin-top: 10px;
}

.property-type,
.property-status {
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 500;
}

.property-type {
    background-color: rgba(52, 152, 219, 0.15);
    color: var(--accent-color);
}

.property-status {
    background-color: rgba(46, 204, 113, 0.15);
    color: #27ae60;
}



.property-status {
    background-color: rgba(46, 204, 113, 0.15); /* default green */
    color: #27ae60;
}

.property-status.inactive {
    background-color: rgba(231, 76, 60, 0.15);
    color: #e74c3c;
}

.property-status.completed {
    background-color: rgba(46, 204, 113, 0.15); /* green */
    color: #27ae60;
}

.property-status.in-progress,
.property-status.inprogress,
.property-status.in\ progress {
    background-color: #fff3cd; /* yellow */
    color: #856404;
}


.property-address {
    display: flex;
    align-items: start;
    gap: 8px;
    margin: 8px 0 12px 0;
    color: var(--text-color);
    font-size: 0.9rem;
    line-height: 1.4;
}

.property-address i {
    color: var(--accent-color);
    margin-top: 3px;
}

/* Sidebar Styles */
.sidebar {
    width: 300px;
    background-color: white;
    border-right: 1px solid var(--border-color);
    padding: 20px;
    height: 100vh;
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    overflow-y: auto;
    z-index: 100;
}

.sidebar-header {
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 20px;
}

/* Main Content Styles */
.main-content {
    flex: 1;
    margin-left: 300px;
    padding: 20px;
    height: 100vh;
    overflow-y: auto;
    background: var(--background-color);
}

/* Dashboard Styles */
.dashboard-header {
    margin-bottom: 30px;
}

.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Tabs Styles */
.tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
    position: sticky;
    top: -21px;
    z-index: 10;
    background: var(--background-color);
}

.tab-btn {
    padding: 10px 20px;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 16px;
    color: var(--text-color);
}

.tab-btn.active {
    color: var(--accent-color);
    border-bottom: 2px solid var(--accent-color);
}

.tab-count-badge {
    display: inline-block;
    background: #eaf6ff;
    color: #217dbb;
    font-weight: 600;
    border-radius: 12px;
    padding: 2px 10px;
    font-size: 0.95em;
    margin-left: 7px;
    min-width: 24px;
    text-align: center;
    border: 1.5px solid #b8e0fa;
    vertical-align: middle;
}

/* Units Grid Styles */
.unit-card-modern {
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 2px 8px rgba(44,62,80,0.07);
    margin-bottom: 18px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: box-shadow 0.2s, transform 0.2s;
    border: 1px solid #e1e8ed;
}
.unit-card-modern:hover {
    box-shadow: 0 6px 18px rgba(44,62,80,0.13);
    transform: translateY(-2px) scale(1.01);
}
.unit-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(90deg, #2c3e50 0%, #2c3e50 100%);
    color: #fff;
    padding: 18px 22px;
    border-radius: 14px 14px 0 0;
}
.unit-card-header h3 {
    margin: 0;
    font-size: 1.18rem;
    font-weight: 700;
    letter-spacing: 0.2px;
}
.unit-card-body {
    padding: 18px 22px 10px 22px;
    background: #f8fafd;
}
.unit-info-row {
    display: flex;
    gap: 18px;
    flex-wrap: wrap;
    font-size: 1rem;
    margin-bottom: 10px;
    color: #2c3e50;
}
.unit-info-row span {
    display: flex;
    align-items: center;
    gap: 6px;
}
.unit-utilities-section {
    margin-top: 8px;
}
.unit-utilities-title {
    font-weight: 600;
    color: #2980b9;
    margin-bottom: 6px;
    font-size: 1.01rem;
    display: flex;
    align-items: center;
    gap: 7px;
}
.unit-utility-row {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.97rem;
    margin-bottom: 4px;
    padding-left: 2px;
}
.utility-label {
    min-width: 70px;
    font-weight: 500;
    color: #3498db;
}
.utility-account, .utility-provider, .utility-under {
    color: #555;
    font-size: 0.96em;
}
.badge {
    display: inline-block;
    padding: 3px 12px;
    border-radius: 12px;
    font-size: 0.92rem;
    font-weight: 500;
    margin-left: 6px;
}
.badge-success { background: #e1f7e1; color: #27ae60; }
.badge-warning { background: #fff3cd; color: #856404; }
.badge-danger { background: #ffe1e1; color: #d63031; }
.badge-default { background: #e0e0e0; color: #888; }
.unit-card-actions {
    display: flex;
    gap: 10px;
    padding: 14px 22px 16px 22px;
    background: #f8fafd;
    border-top: 1px solid #e1e8ed;
    border-radius: 0 0 14px 14px;
    justify-content: flex-end;
}
.unit-card-actions .btn-secondary {
    background: #e1e8ed;
    color: #2980b9;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    font-size: 0.97rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s, color 0.15s;
}
.unit-card-actions .btn-secondary:hover {
    background: #3498db;
    color: #fff;
}
.unit-card-actions .btn-icon.delete-btn {
    background: none;
    color: #d63031;
    font-size: 1.1rem;
    border: none;
    padding: 8px;
    border-radius: 50%;
    cursor: pointer;
    transition: background 0.15s;
}
.unit-card-actions .btn-icon.delete-btn:hover {
    background: #ffe1e1;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    z-index: 1000;
    overflow-y: auto; /* Enable scrolling on the modal overlay */
    padding: 20px;
}


.modal-content {
    background: white;
    width: 100%;
    max-width: 750px;
    margin: 20px auto;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    max-height: 98vh;
    overflow-y: auto;
}

.unit-details-modal .modal-body {
    max-height: 60vh;
    overflow-y: auto;
}

/* Add smooth scrolling to the page */
html {
    scroll-behavior: smooth;
}

/* Update detail group styles */
.detail-group {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

/* Form Styles */
.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

.form-group input {
    
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
}

/* Button Styles */
/* Modernized Button Styles - Keep Current Colors */
.btn-primary {
    background: linear-gradient(90deg, var(--accent-color) 0%, #6dd5fa 100%);
    color: #fff;
    border: none;
    padding: 11px 24px;
    border-radius: 8px;
    font-size: 1.07rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(52, 152, 219, 0.08);
    transition: background 0.18s, color 0.18s, box-shadow 0.18s, transform 0.1s;
}
.btn-primary:hover, .btn-primary:focus {
    background: linear-gradient(90deg, #217dbb 0%, #4fc3f7 100%);
    color: #fff;
    box-shadow: 0 4px 16px rgba(52, 152, 219, 0.15);
    transform: translateY(-2px) scale(1.03);
    outline: none;
}

.btn-secondary {
    background: var(--secondary-color);
    color: #fff;
    border: none;
    padding: 11px 24px;
    border-radius: 8px;
    font-size: 1.07rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.18s, color 0.18s, box-shadow 0.18s, transform 0.1s;
}
.btn-secondary:hover, .btn-secondary:focus {
    background: #232e39;
    color: #fff;
    box-shadow: 0 2px 8px rgba(44, 62, 80, 0.10);
    transform: translateY(-1px) scale(1.02);
    outline: none;
}

/* Responsive Design */
@media (max-width: 768px) {
    .container {
        flex-direction: column;
    }

    .sidebar {
        width: 100%;
        height: auto;
    }

    .form-row {
        grid-template-columns: 1fr;
    }
}

.notification {
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 15px 25px;
  border-radius: 4px;
  color: white;
  font-weight: 500;
  transform: translateY(150%);
  transition: transform 0.3s ease;
  z-index: 1000;
}

.notification.show {
  transform: translateY(0);
}

.notification.success {
  background-color: var(--success-color);
}

.notification.error {
  background-color: var(--danger-color);
}

.notification.info {
  background-color: var(--accent-color);
}

/* Tab Pane Styles */
.tab-pane {
    display: none;
    padding: 20px 0;
}

.tab-pane.active {
    display: block;
}

/* Form Textarea */
textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    resize: vertical;
}

/* File Input Styling */
input[type="file"] {
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    width: 100%;
}

/* Select Styling */
select {
    width: 100%;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background-color: white;
}

/* List Styles */
/* Add to your existing styles section */
.maintenance-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding: 10px;
}

.maintenance-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.maintenance-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.maintenance-header {
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
}

.maintenance-header h3 {
    margin: 0;
    color: var(--text-color);
    font-size: 1.1rem;
    font-weight: 500;
}

.priority-badge {
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.priority-badge.urgent {
    background-color: #ffe1e1;
    color: #d63031;
}

.priority-badge.high {
    background-color: #fff3cd;
    color: #856404;
}

.priority-badge.medium {
    background-color: #e1f7e1;
    color: #2ea12e;
}

.priority-badge.low {
    background-color: #e2e8f0;
    color: #64748b;
}

.maintenance-content {
    padding: 15px 20px;
}

.unit-info {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 10px 0;
    font-size: 0.9rem;
    color: var(--text-color);
}

.description {
    margin: 15px 0;
    color: var(--text-color);
    font-size: 0.9rem;
    line-height: 1.5;
}

.maintenance-footer {
    padding: 15px 20px;
    background: #f8f9fa;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.status-badge.pending {
    background-color: #fff3cd;
    color: #856404;
}

.status-badge.in-progress {
    background-color: #cce5ff;
    color: #004085;
}

.status-badge.completed {
    background-color: #e1f7e1;
    color: #2ea12e;
}

.maintenance-actions {
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Document Grid */
.documents-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 24px;
    padding: 20px 0;
}

.document-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(44, 62, 80, 0.07);
    padding: 22px 18px 16px 18px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    transition: box-shadow 0.2s, transform 0.2s;
    position: relative;
}

.document-card:hover {
    box-shadow: 0 6px 18px rgba(44, 62, 80, 0.13);
    transform: translateY(-2px) scale(1.01);
}

.document-icon {
    font-size: 2.5rem;
    color: var(--accent-color);
    margin-bottom: 12px;
    align-self: center;
}

.document-info h3 {
    font-size: 1.08rem;
    margin: 0 0 6px 0;
    color: var(--primary-color);
    font-weight: 600;
    word-break: break-all;
}

.document-info p {
    margin: 0 0 4px 0;
    font-size: 0.93rem;
    color: var(--text-color);
    opacity: 0.85;
}

.document-actions {
    display: flex;
    gap: 10px;
    margin-top: 16px;
    width: 100%;
    justify-content: flex-end;
}

.document-actions button {
    padding: 7px 14px;
    border-radius: 6px;
    font-size: 0.93rem;
    border: none;
    background: var(--background-color);
    color: var(--primary-color);
    cursor: pointer;
    transition: background 0.15s, color 0.15s;
    display: flex;
    align-items: center;
    gap: 6px;
}

.document-actions button:hover {
    background: var(--accent-color);
    color: #fff;
}

.document-actions .delete-btn {
    background: none;
    color: var(--danger-color);
    padding: 7px 10px;
}

.document-actions .delete-btn:hover {
    background: rgba(231, 76, 60, 0.08);
    color: #fff;
}

/* Add to your existing styles */
.unit-card .status {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    margin: 8px 0;
}

.unit-card.vacant .status {
    background-color: var(--warning-color);
    color: white;
}

.unit-card.occupied .status {
    background-color: var(--success-color);
    color: white;
}

.unit-card.maintenance .status {
    background-color: var(--danger-color);
    color: white;
}

.tab-badge {
    display: inline-block;
    background: #fff3cd;
    color: #856404;
    font-weight: bold;
    border-radius: 50%;
    padding: 2px 8px;
    font-size: 0.95em;
    margin-left: 8px;
    border: 1.5px solid #f1c40f;
    box-shadow: 0 0 8px 2px #ffe066;
    vertical-align: middle;
    animation: attentionPulse 1.2s infinite alternate;
}


/* Add these styles */
.unit-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.btn-icon {
    background: none;
    border: none;
    padding: 8px;
    cursor: pointer;
    border-radius: 50%;
    transition: background-color 0.2s;
}

.btn-icon:hover {
    background-color: rgba(0, 0, 0, 0.1);
}

.delete-btn {
    color: var(--danger-color);
}

.delete-btn:hover {
    background-color: rgba(220, 53, 69, 0.1);
}

/* Add to your existing styles */
.form-row input[type="date"] {
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    width: 100%;
}

.detail-group .lease-info {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 10px;
    align-items: center;
}

.lease-dates {
    color: var(--text-color);
    font-size: 0.9em;
}

.lease-status {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    background-color: var(--primary-color);
    color: white;
    display: inline-block;
    margin-left: 8px;
}

/* Lease Information Section Styles */
.form-row {
    display: flex;
    gap: 18px;
    flex-wrap: wrap;
}

.form-group {
    flex: 1 1 180px;
    display: flex;
    flex-direction: column;
    margin-bottom: 16px;
}

.form-group label {
    font-weight: 500;
    margin-bottom: 6px;
    color: var(--primary-color, #2c3e50);
}

.form-group input[type="number"],
.form-group input[type="date"],
.form-group select,
.form-group textarea {
    padding: 7px 10px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    font-size: 1rem;
    margin-bottom: 2px;
    background: #f9fafb;
    transition: border 0.2s;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    border-color: var(--accent-color, #3498db);
    outline: none;
}

#fmrSection,
#section8Section {
    background: #f6fafd;
    border: 1px solid #e1e8ed;
    border-radius: 8px;
    padding: 12px 14px;
    margin-bottom: 14px;
    margin-top: -6px;
}

#fmrSection label,
#section8Section label {
    margin-bottom: 4px;
    color: #2980b9;
    font-size: 0.97rem;
}

#section8Section {
    display: flex;
    gap: 18px;
    flex-wrap: wrap;
}

#section8Section .form-group {
    margin-bottom: 0;
}

.lease-badge {
    display: inline-block;
    padding: 3px 12px;
    border-radius: 12px;
    font-size: 0.92rem;
    font-weight: 500;
    background: #eaf6ff;
    color: #2980b9;
    margin-left: 6px;
}

.lease-badge.renew {
    background: #e1f7e1;
    color: #27ae60;
}

.lease-badge.terminate {
    background: #ffe1e1;
    color: #d63031;
}

/* Add to your existing styles */
.tenants-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    padding: 20px 0;
}

.tenant-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.tenant-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.tenant-card .tenant-header {
    padding: 20px;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    gap: 15px;
}

.tenant-avatar-small {
    width: 40px;
    height: 40px;
    background: var(--accent-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 18px;
    font-weight: 500;
}

.tenant-info {
    padding: 20px;
}

.tenant-info h3 {
    margin: 0;
    color: var(--text-color);
    font-size: 1.2rem;
}

.unit-info {
    margin: 10px 0;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.contact-info {
    margin: 15px 0;
    display: grid;
    gap: 8px;
}

.contact-info p {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-color);
    font-size: 0.9rem;
}

.tenant-status {
    display: inline-flex;
    align-items: center;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
    margin-top: 10px;
}

.tenant-status.active {
    background-color: #e1f7e1;
    color: #2ea12e;
}

.tenant-status.inactive {
    background-color: #ffe1e1;
    color: #d63031;
}

.tenant-actions {
    padding: 15px 20px;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    background: #f8f9fa;
}

.tenant-actions button {
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.9rem;
}

.tenant-lease-info {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid var(--border-color);
    font-size: 0.9rem;
    color: var(--text-color);
}


.tenant-section {
    margin-bottom: 14px;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
}
.tenant-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}
.tenant-section-title {
    font-weight: 600;
    color: var(--accent-color);
    margin-bottom: 6px;
    font-size: 1.02rem;
    display: flex;
    align-items: center;
    gap: 7px;
}
.tenant-detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.97rem;
    margin-bottom: 3px;
    gap: 10px;
}
.tenant-detail-row span {
    display: inline-block;
}
.tenant-detail-value {
    color: #888;
    font-size: 0.97rem;
}
.tenant-list {
    margin: 0 0 0 18px;
    padding: 0;
    font-size: 0.97rem;
}
.tenant-list li {
    margin-bottom: 2px;
}

/* Add these styles to your existing CSS */
.tenant-details-modal {
    
    border-radius: 12px;
    background: white;
    margin: 20px auto;
    
    display: flex;
    flex-direction: column;
    position: relative;
}

.tenant-details-header {
    position: sticky;
    top: 0;
    background: white;
    z-index: 1;
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    border-radius: 12px 12px 0 0;
}

.tenant-details-header h2 {
    margin: 0;
    color: var(--primary-color);
    font-size: 1.8rem;
}

.tenant-avatar {
    width: 60px;
    height: 60px;
    background: var(--accent-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
}

.tenant-details-content {
    padding: 20px;
    overflow-y: auto; /* Enable scrolling for content */
    flex: 1; /* Allow content to take remaining space */
}

.detail-group {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.detail-group label {
    color: var(--primary-color);
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 12px;
    display: block;
}

.detail-group p {
    margin: 8px 0;
    font-size: 1rem;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 8px;
}

.lease-badge {
    display: inline-flex;
    align-items: center;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.lease-badge.active { background: #e1f7e1; color: #27ae60; }
.lease-badge.pending { background: #fff3cd; color: #856404; }
.lease-badge.expired { background: #ffe1e1; color: #d63031; }
.lease-badge.terminated { background: #e0e0e0; color: #888; }

.modal-footer {
    position: sticky;
    bottom: 0;
    background: white;
    padding: 20px;
    border-top: 1px solid var(--border-color);
    border-radius: 0 0 12px 12px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

/* Add styles for better mobile responsiveness */
@media (max-width: 768px) {
    .modal {
        padding: 10px;
    }
    
    .modal-content,
    .tenant-details-modal {
        width: 95%;
        margin: 10px auto;
    }
    
    .tenant-details-content {
        padding: 15px;
    }
}






.delete-btn {
    background: none;
    border: none;
    color: var(--danger-color);
    cursor: pointer;
    padding: 5px;
    transition: transform 0.2s ease;
}

.delete-btn:hover {
    transform: scale(1.1);
}



/* Add to your existing styles section */
.status-dialog .modal-content {
    max-width: 400px;
    padding: 25px;
    border-radius: 12px;
}

.status-dialog h3 {
    color: var(--primary-color);
    margin-bottom: 20px;
    font-size: 1.4rem;
    text-align: center;
}

.status-options {
    display: grid;
    gap: 12px;
    margin-bottom: 20px;
}

.status-option {
    padding: 15px;
    border: 2px solid var(--border-color);
    border-radius: 10px;
    background: white;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.2s ease;
}

.status-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.status-option.active {
    border-color: var(--accent-color);
    background-color: rgba(52, 152, 219, 0.05);
}

.status-option i {
    font-size: 1.2rem;
}

.status-option.pending {
    border-color: #f1c40f;
}

.status-option.in-progress {
    border-color: #3498db;
}

.status-option.completed {
    border-color: #2ecc71;
}

.status-option.pending:hover {
    background-color: rgba(241, 196, 15, 0.1);
}

.status-option.in-progress:hover {
    background-color: rgba(52, 152, 219, 0.1);
}

.status-option.completed:hover {
    background-color: rgba(46, 204, 113, 0.1);
}

.dialog-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

/* Add these styles to your CSS */
.image-viewer .modal-content {
    max-width: 90%;
    max-height: 90vh;
    margin: 20px auto;
    background: white;
    border-radius: 8px;
    overflow: hidden;
}

.image-viewer .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: var(--primary-color);
    color: white;
}

.image-viewer .modal-header h3 {
    margin: 0;
    font-size: 1.2rem;
}

.image-viewer .modal-body {
    padding: 20px;
    overflow: auto;
    text-align: center;
}

.btn-close {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 0 5px;
}

/* Make the pets checkbox and label inline */
.form-group > label > input[type="checkbox"] {
    display: inline-block;
    margin-right: 8px;
    vertical-align: middle;
}

.lease-holder-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
}
.lease-holder-row input {
    flex: 1;
    padding: 7px 10px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    font-size: 1rem;
    background: #f9fafb;
}
.lease-holder-remove {
    background: none;
    border: none;
    color: #d63031;
    font-size: 1.1rem;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 50%;
    transition: background 0.15s;
}
.lease-holder-remove:hover {
    background: #ffe1e1;
}

.btn-add-lease-holder {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(90deg, #3498db 0%, #6dd5fa 100%);
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 9px 20px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(52, 152, 219, 0.08);
    transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
    margin-bottom: 14px;
}
.btn-add-lease-holder i {
    font-size: 1.1em;
}
.btn-add-lease-holder:hover, .btn-add-lease-holder:focus {
    background: linear-gradient(90deg, #217dbb 0%, #4fc3f7 100%);
    box-shadow: 0 4px 16px rgba(52, 152, 219, 0.15);
    transform: translateY(-2px) scale(1.03);
    outline: none;
}


/* Modern Unit Details Modal Styles */
.unit-details-modal {
    max-width: 650px !important;
    border-radius: 14px;
    background: #fff;
    margin: 30px auto;
    box-shadow: 0 8px 32px rgba(44,62,80,0.13);
    overflow: hidden;
    font-size: 1rem;
}

.unit-details-modal .modal-header {
    background: linear-gradient(90deg, #3498db 0%, #6dd5fa 100%);
    color: #fff;
    padding: 24px 28px 18px 28px;
    border-radius: 14px 14px 0 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.unit-details-modal .modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: 0.5px;
}

.unit-details-modal .modal-body {
    padding: 28px 28px 10px 28px;
    background: #f8fafd;
}

.unit-details-modal .unit-section {
    margin-bottom: 22px;
    padding-bottom: 14px;
    border-bottom: 1px solid #e1e8ed;
}

.unit-details-modal .unit-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.unit-details-modal h3 {
    color: #2980b9;
    font-size: 1.13rem;
    margin-bottom: 10px;
    font-weight: 600;
    letter-spacing: 0.2px;
}

.unit-details-modal h4 {
    color: #3498db;
    font-size: 1.01rem;
    margin-bottom: 6px;
    font-weight: 500;
}

.utility-block {
    background: #fff;
    border-radius: 8px;
    padding: 14px 18px;
    margin-bottom: 12px;
    box-shadow: 0 1px 4px rgba(44,62,80,0.05);
    border: 1px solid #e1e8ed;
}

.utility-block div {
    font-size: 0.97rem;
    margin-bottom: 3px;
    color: #2c3e50;
}

.utility-block:last-child {
    margin-bottom: 0;
}



.unit-details-modal .modal-footer {
    background: #f8fafd;
    padding: 18px 28px;
    border-radius: 0 0 14px 14px;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    border-top: 1px solid #e1e8ed;
}

.unit-details-modal .btn-primary,
.unit-details-modal .btn-secondary {
    min-width: 120px;
    font-size: 1rem;
    font-weight: 600;
    padding: 10px 18px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: background 0.18s, color 0.18s;
}

.unit-details-modal .btn-primary {
    background: linear-gradient(90deg, #3498db 0%, #6dd5fa 100%);
    color: #fff;
}

.unit-details-modal .btn-primary:hover {
    background: linear-gradient(90deg, #217dbb 0%, #4fc3f7 100%);
}

.unit-details-modal .btn-secondary {
    background: #e1e8ed;
    color: #2980b9;
}

.unit-details-modal .btn-secondary:hover {
    background: #d0d7de;
    color: #217dbb;
}

.unit-details-modal .btn-close {
    background: none;
    border: none;
    color: #fff;
    font-size: 1.6rem;
    cursor: pointer;
    padding: 0 8px;
    transition: color 0.18s;
}

.unit-details-modal .btn-close:hover {
    color: #ffe1e1;
}

@media (max-width: 700px) {
    .unit-details-modal {
        max-width: 98vw !important;
        padding: 0;
    }
    .unit-details-modal .modal-header,
    .unit-details-modal .modal-body,
    .unit-details-modal .modal-footer {
        padding-left: 10px;
        padding-right: 10px;
    }
}


.unit-details-modal .unit-section {
    margin-bottom: 22px;
    padding-bottom: 12px;
    border-bottom: 1px solid #f0f0f0;
}
.unit-details-modal .unit-section:last-child {
    border-bottom: none;
}

.modal {
    z-index: 5000 !important;
}
.modal-content {
    z-index: 5001 !important;
    position: relative;
}

.payments-table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 4px rgba(44,62,80,0.04);
    margin-top: 18px;
}
.payments-table th, .payments-table td {
    padding: 10px 12px;
    border-bottom: 1px solid #e1e8ed;
    text-align: left;
    font-size: 0.98rem;
}
.payments-table th {
    background: #f6fafd;
    font-weight: 600;
    color: #2980b9;
}
.payments-table tr:last-child td {
    border-bottom: none;
}

.payment-row {
    cursor: pointer;
    transition: background 0.18s, box-shadow 0.18s;
}

.payment-row:hover {
    background: #d6ecfc !important;
    box-shadow: 0 2px 8px rgba(52, 152, 219, 0.10);
}

.download-btn {
    color: #4e4e4e;
    background: none;
    border: none;
    font-size: 1.25rem;
    margin-right: 4px;
    transition: background 0.15s, color 0.15s;
}
.download-btn:hover {
    background: #eaf6ff;
    color: #217dbb;
}

.main-summary-section {
    background: linear-gradient(90deg, #eaf6ff 0%, #f6fafd 100%);
    border-bottom: 2px solid #e1e8ed;
    box-shadow: 0 2px 12px rgba(52,152,219,0.07);
    padding: 0 0 18px 0;
    margin-bottom: 18px;
}

.main-summary-header {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 1.35rem;
    font-weight: 700;
    
    padding: 24px 32px 0 32px;
    letter-spacing: 0.5px;
}

.main-summary-header i {
    font-size: 1.5em;
    color: var(--accent-color);
}

.main-summary-header {
    cursor: pointer;
    user-select: none;
    position: relative;
}

.summary-toggle-icon {
    margin-left: auto;
    font-size: 1.1em;
    transition: transform 0.2s;
}

.main-summary-section.collapsed .main-summary {
    display: none;
}

.main-summary-section.collapsed .summary-toggle-icon {
    transform: rotate(-180deg);
}

/* --- Main Summary List Report Style --- */
.main-summary {
    display: flex;
    gap: 24px;
    padding: 18px 32px 0 32px;
    background: none;
    border: none;
    margin-bottom: 0;
    flex-wrap: wrap;
}

.summary-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(52,152,219,0.09);
    padding: 20px 32px;
    min-width: 220px;
    flex: 1 1 170px;
    text-align: center;
    border: 1.5px solid #e1e8ed;
    transition: box-shadow 0.18s, border 0.18s;
}
.summary-card h4 {
    margin: 0 0 8px 0;
    color: var(--accent-color);
    font-size: 1.08rem;
    font-weight: 600;
    letter-spacing: 0.2px;
}
.summary-card p {
    margin: 0;
    font-size: 1.45rem;
    font-weight: 700;
    color: var(--primary-color);
    letter-spacing: 0.5px;
}
@media (max-width: 900px) {
    .main-summary {
        flex-direction: column;
        gap: 12px;
        padding: 14px 8px 0 8px;
    }
    .main-summary-header {
        padding: 18px 12px 0 12px;
        font-size: 1.1rem;
    }
    .summary-card {
        padding: 14px 12px;
    }
}  

.sidebar .btn-primary {
    margin-left: 60px;
        margin-top: 18px;
    margin-bottom: 10px;
}

/* Modern style for the sidebar Properties heading */
.sidebar-header h2 {
    font-size: 1.45rem;
    font-weight: 800;
    
    letter-spacing: 0.5px;
    margin-bottom: 0px;
    display: flex;
    align-items: center;
    gap: 10px;
    background: linear-gradient(90deg, #eaf6ff 0%, #f6fafd 100%);
    padding: 12px 18px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(52,152,219,0.07);
    margin-left: 15px;
}
   </style>
</head>
<body>



    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>🏢 Properties</h2>
                <button class="btn-primary" onclick="window.location.href='/'">
                <i class="fas fa-home"></i> Home
                </button>
            </div>
            <div class="property-list" id="propertyList">
                <!-- Properties will be listed here -->
            </div>
        </aside>



        
        <!-- Main Content -->
        <main class="main-content">

<section class="main-summary-section collapsed">
    <div class="main-summary-header" id="mainSummaryToggle">
        <i class="fas fa-chart-bar"></i>
        <span>Main Summary</span>
        <i class="fas fa-chevron-up summary-toggle-icon" id="mainSummaryChevron"></i>
    </div>
    <div class="main-summary" id="mainSummary">
            <div class="summary-card">
                <h4>Total Properties</h4>
                <p id="summaryTotalProperties">--</p>
            </div>
            <div class="summary-card">
                <h4>Total Units</h4>
                <p id="summaryTotalUnits">--</p>
            </div>
            <div class="summary-card">
                <h4>Total Tenants</h4>
                <p id="summaryTotalTenants">--</p>
            </div>
            <div class="summary-card">
                <h4>Overall Occupancy</h4>
                <p id="summaryOccupancyRate">--%</p>
            </div>
            <div class="summary-card">
                <h4>Est. Monthly Income</h4>
                <p id="summaryMonthlyIncome">$--</p>
            </div>
        </div>
    </section>


            <!-- Property Dashboard -->
            <div class="dashboard" id="propertyDashboard">
                <div class="dashboard-header">
                    <h1 id="propertyName">Select a Property</h1>
                    <div class="stats-container">
                        <div class="stat-card">
                            <h3>Occupancy Rate</h3>
                            <p id="occupancyRate">--%</p>
                        </div>
                        <div class="stat-card">
                            <h3>Total Units</h3>
                            <p id="totalUnits">--</p>
                        </div>
                        <div class="stat-card">
                            <h3>Vacant Units</h3>
                            <p id="vacantUnits">--</p>
                        </div>
                        <div class="stat-card">
                          <h3>Est. Monthly Income</h3>
                          <p id="propertyMonthlyIncome">$--</p>
                          </div>
                    </div>
                </div>



                
                <!-- Tabs -->
<div class="tabs">
    <button class="tab-btn active" data-tab="units">
        Units <span class="tab-count-badge" id="tabCountUnits"></span>
    </button>
    <button class="tab-btn" data-tab="tenants">
        Tenants <span class="tab-count-badge" id="tabCountTenants"></span>
    </button>
    <button class="tab-btn" data-tab="maintenance">
        Maintenance
        <span id="maintenancePendingBadge" class="tab-badge" style="display:none;">!</span>
    </button>
    <button class="tab-btn" data-tab="documents">
        Documents <span class="tab-count-badge" id="tabCountDocuments"></span>
    </button>
    <button class="tab-btn" data-tab="payments">
        Payments <span class="tab-count-badge" id="tabCountPayments"></span>
    </button>
</div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Units Tab -->
                    <div class="tab-pane active" id="units">
                        <div class="units-header">
                            <h2>Units</h2>
                            <button class="btn-secondary" id="addUnitBtn">+ Add Unit</button>
                        </div>
                        <div class="units-grid" id="unitsGrid"></div>
                    </div>

                    <!-- Tenants Tab -->
                    <div class="tab-pane" id="tenants">
                        <div class="tenants-header">
                            <h2>Tenants</h2>
                            <button class="btn-secondary" id="addTenantBtn">+ Add Tenant</button>
                        </div>
                        <div class="tenants-list" id="tenantsList"></div>
                    </div>

                    <!-- Maintenance Tab -->
                    <div class="tab-pane" id="maintenance">
                        <div class="maintenance-header">
                            <h2>Maintenance Requests</h2>
                            <button class="btn-secondary" id="addMaintenanceBtn">+ New Request</button>
                        </div>
                        <div class="maintenance-list" id="maintenanceList"></div>
                    </div>

                    <!-- Documents Tab -->
                    <div class="tab-pane" id="documents">
                        <div class="documents-header">
                            <h2>Documents</h2>
                            <button class="btn-secondary" id="uploadDocumentBtn">+ Upload Document</button>
                        </div>
                        <div class="documents-grid" id="documentsGrid"></div>
                    </div>

                    <!-- Payments Tab -->
<div class="tab-pane" id="payments">
    <div class="payments-header">
        <h2>Payments</h2>
        <button class="btn-secondary" id="addPaymentBtn">+ Record Payment</button>
    </div>
    <div class="payments-list" id="paymentsList">
        <!-- Payments will be listed here -->
    </div>
</div>
                </div>
            </div>
        </main>
    </div>




 

    <!-- ===================== MODALS (ONE OF EACH, OUTSIDE MAIN CONTENT) ===================== -->



<!-- Add Unit Modal -->
<div class="modal" id="addUnitModal">
    <div class="modal-content">
        <h2>Add/Edit Unit</h2>
        <form id="addUnitForm">
            <div class="form-row">
                <div class="form-group">
                    <label>Unit Number</label>
                    <input type="text" id="unitNumber" required>
                </div>
                <div class="form-group">
                    <label>Floor</label>
                    <input type="number" id="unitFloor" min="1" value="1" required>
                </div>
                <div class="form-group">
                    <label>Square Feet</label>
                    <input type="number" id="unitSqft" min="0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Bedrooms</label>
                    <input type="number" id="unitBedrooms" min="0" required>
                </div>
                <div class="form-group">
                    <label>Bathrooms</label>
                    <input type="number" id="unitBathrooms" min="0" required>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="unitStatus" required>
                        <option value="vacant">Vacant</option>
                        <option value="occupied">Occupied</option>
                        <option value="maintenance">Maintenance</option>
                    </select>
                </div>
            </div>
            <h3>Utility Accounts</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Water Account #</label>
                    <input type="text" id="waterAccountNumber">
                    <label>Provider</label>
                    <input type="text" id="waterProvider">
                    <label>Status</label>
                    <select id="waterStatus">
                        <option value="">Select</option>
                        <option value="active">Active</option>
                        <option value="disconnected">Disconnected</option>
                    </select>
                    <label>Bill Under</label>
                    <select id="waterUnder">
                        <option value="">Select</option>
                        <option value="tenant">Tenant</option>
                        <option value="landlord">Landlord</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Gas Account #</label>
                    <input type="text" id="gasAccountNumber">
                    <label>Provider</label>
                    <input type="text" id="gasProvider">
                    <label>Status</label>
                    <select id="gasStatus">
                        <option value="">Select</option>
                        <option value="active">Active</option>
                        <option value="disconnected">Disconnected</option>
                    </select>
                    <label>Bill Under</label>
                    <select id="gasUnder">
                        <option value="">Select</option>
                        <option value="tenant">Tenant</option>
                        <option value="landlord">Landlord</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Electricity Account #</label>
                    <input type="text" id="electricityAccountNumber">
                    <label>Provider</label>
                    <input type="text" id="electricityProvider">
                    <label>Status</label>
                    <select id="electricityStatus">
                        <option value="">Select</option>
                        <option value="active">Active</option>
                        <option value="disconnected">Disconnected</option>
                    </select>
                    <label>Bill Under</label>
                    <select id="electricityUnder">
                        <option value="">Select</option>
                        <option value="tenant">Tenant</option>
                        <option value="landlord">Landlord</option>
                    </select>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn-secondary" onclick="closeModal('addUnitModal')">Cancel</button>
                <button type="submit" class="btn-primary">Add Unit</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Tenant Modal -->
<div class="modal" id="addTenantModal">
<div class="modal-content">
    <h2>Add/Edit Tenant</h2>
    <form id="addTenantForm">
        <!-- Row 1: Name, Phone, Email -->
        <div class="form-row">
            <div class="form-group">
                <label>Tenant Name</label>
                <input type="text" id="tenantName" required>
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="tenantPhone" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="tenantEmail" required>
            </div>
        </div>
        <!-- Lease Holders -->
        <div class="form-group">
            <label>Lease Holders</label>
            <div id="leaseHoldersList"></div>
            <button type="button" class="btn-add-lease-holder" onclick="addLeaseHolderField()">
                <i class="fas fa-user-plus"></i> Add Lease Holder
            </button>
        </div>
        <!-- Row 2: Lease Dates -->
        <div class="form-row">
            <div class="form-group">
                <label>Lease Start</label>
                <input type="date" id="leaseStart" required>
            </div>
            <div class="form-group">
                <label>Lease End</label>
                <input type="date" id="leaseEnd" required>
            </div>
        </div>
        <!-- Row 3: Rent & Fees -->
        <div class="form-row">
            <div class="form-group">
                <label>Base Rent ($)</label>
                <input type="number" id="baseRent" min="0" required>
            </div>
            <div class="form-group">
                <label>Water Fee ($)</label>
                <input type="number" id="waterFee" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Trash Fee ($)</label>
                <input type="number" id="trashFee" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Admin Fee ($)</label>
                <input type="number" id="adminFee" min="0" step="0.01">
            </div>
        </div>
        <!-- Row 4: Lease Type, Status, Renewal -->
        <div class="form-row">
            <div class="form-group">
                <label>Lease Type</label>
                <select id="leaseType" required>
                    <option value="">Select</option>
                    <option value="fmr">Free Market Rent</option>
                    <option value="section8">Section 8</option>
                </select>
            </div>
            <div class="form-group">
                <label>Lease Status</label>
                <select id="leaseStatus" required>
                    <option value="active">Active</option>
                    <option value="pending">Pending</option>
                    <option value="expired">Expired</option>
                    <option value="terminated">Terminated</option>
                </select>
            </div>
            <div class="form-group">
                <label>Lease Renewal</label>
                <select id="leaseRenewal" required>
                    <option value="renew">Will Renew</option>
                    <option value="terminate">Will Terminate</option>
                </select>
            </div>
        </div>
        <!-- Lease Type Details -->
        <div id="fmrSection" style="display:none;">
            <div class="form-group">
                <label>FMR Notes</label>
                <textarea id="fmrNotes"></textarea>
            </div>
        </div>
        <div id="section8Section" style="display:none;">
            <div class="form-group">
                <label>HUB Contribution ($)</label>
                <input type="number" id="hubContribution" min="0">
            </div>
            <div class="form-group">
                <label>Tenant Contribution ($)</label>
                <input type="number" id="tenantContribution" min="0">
            </div>
        </div>
        <!-- Row 5: Unit, Occupants -->
        <div class="form-row">
            <div class="form-group">
                <label>Unit</label>
                <select id="tenantUnit" required>
                    <option value="">Select a unit</option>
                </select>
            </div>
            <div class="form-group">
                <label>Authorized Occupants (one per line)</label>
                <textarea id="authorizedOccupants"></textarea>
            </div>
        </div>
        <!-- Row 6: Pets & Cars -->
        <div class="form-row">
            <div class="form-group" style="min-width:180px;">
                <label>
                    <input type="checkbox" id="hasPets"> Has Pets
                </label>
                <div id="petDetails" style="display:none;">
                    <label>Number of Pets</label>
                    <input type="number" id="petCount" min="0">
                    <label>Pet Fee ($)</label>
                    <input type="number" id="petFee" min="0">
                </div>
            </div>
            <div class="form-group" style="min-width:180px;">
                <label>
                    <input type="checkbox" id="hasCar"> Has Car(s)
                </label>
                <div id="carDetails" style="display:none;">
                    <label>Number of Cars</label>
                    <input type="number" id="carCount" min="1" value="1">
                    <div id="carFieldsContainer"></div>
                </div>
            </div>
        </div>
        <!-- Emergency Contact Section -->
        <fieldset style="margin-top:18px; border:1px solid #e1e8ed; border-radius:8px; padding:14px 18px;">
            <legend style="font-weight:600; color:#2980b9; font-size:1.01rem;">Emergency Contact</legend>
            <div class="form-row">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="emergencyContactName">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="emergencyContactPhone">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="emergencyContactEmail">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="emergencyContactAddress">
                </div>
                <div class="form-group">
                    <label>Relation</label>
                    <input type="text" id="emergencyContactRelation">
                </div>
            </div>
        </fieldset>
        <!-- Form Buttons -->
        <div class="modal-buttons" style="margin-top:18px;">
            <button type="button" class="btn-secondary" onclick="closeModal('addTenantModal')">Cancel</button>
            <button type="submit" class="btn-primary">Add Tenant</button>
        </div>
    </form>
</div>
</div>
</div>

<!-- Add Maintenance Modal -->
<div class="modal" id="addMaintenanceModal">
    <div class="modal-content">
        <h2>New Maintenance Request</h2>
        <form id="addMaintenanceForm">
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="maintenanceTitle" required>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="maintenanceDescription" required></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Priority</label>
                    <select id="maintenancePriority" required>
                        <option value="urgent">Urgent</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Unit</label>
                    <select id="maintenanceUnit">
                        <option value="">Select a unit</option>
                        <!-- Populated dynamically -->
                    </select>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn-secondary" onclick="closeModal('addMaintenanceModal')">Cancel</button>
                <button type="submit" class="btn-primary">Submit Request</button>
            </div>
        </form>
    </div>
</div>

<!-- Upload Document Modal -->
<div class="modal" id="uploadDocumentModal">
    <div class="modal-content">
        <h2>Upload Document</h2>
        <form id="uploadDocumentForm" enctype="multipart/form-data">
            <div class="form-group">
                <label>Document Name</label>
                <input type="text" id="documentName" required>
            </div>
<div class="form-group">
    <label>Type</label>
    <select id="documentType" required>
        <option value="">Select Type</option>
        <option value="lease">Lease</option>
        <option value="notice">Notice</option>
        <option value="invoice">Invoice</option>
        <option value="other">Other</option>
    </select>
</div>
            <div class="form-group">
                <label>File</label>
                <input type="file" id="documentFile" required>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn-secondary" onclick="closeModal('uploadDocumentModal')">Cancel</button>
                <button type="submit" class="btn-primary">Upload</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" id="addPaymentModal">
    <div class="modal-content">
        <h2>Record Payment</h2>
       <form id="addPaymentForm">
    <div class="form-row">
        <div class="form-group">
            <label>Tenant</label>
            <select id="paymentTenant" required>
                <option value="">Select Tenant</option>
            </select>
        </div>
        <div class="form-group">
            <label>Payment Type</label>
            <select id="paymentType" required>
                <option value="rent">Rent</option>
                <option value="hub">HUB</option>
            </select>
        </div>
        <div class="form-group">
    <label>Late Fee (%)</label>
    <input type="number" id="paymentLateFee" min="0" step="0.01" placeholder="Enter late fee percent">
</div>
        <div class="form-group">
            <label>Amount ($)</label>
            <input type="number" id="paymentAmount" min="0" step="0.01" required>
        </div>
    </div>
    <div class="form-row">
        <div class="form-group">
            <label>Unit #</label>
            <select id="paymentUnit" required>
                <option value="">Select Unit</option>
                <!-- Populated dynamically -->
            </select>
        </div>
        <div class="form-group">
            <label>Payment Method</label>
            <select id="paymentMethod" required>
                <option value="cash">Cash</option>
                <option value="check">Check</option>
                <option value="bank">Bank Transfer</option>
                <option value="online">Online</option>
            </select>
        </div>
        <div class="form-group">
            <label>Date</label>
            <input type="date" id="paymentDate" required>
        </div>
    </div>
    <div class="modal-buttons">
        <button type="button" class="btn-secondary" onclick="closeModal('addPaymentModal')">Cancel</button>
        <button type="submit" class="btn-primary">Save Payment</button>
    </div>
</form>
    </div>
</div>

    <!-- View Unit Modal (example) -->
<div id="viewUnitModal" class="modal">
  <div class="modal-content unit-details-modal">
    <div class="modal-header">
      <h2>Unit Details</h2>
      <button class="btn-close" onclick="closeModal('viewUnitModal')">&times;</button>
    </div>
    <div class="modal-body" id="unitDetailsBody">
      <!-- Content will be injected by JS -->
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="exportUtilityReport()">Export Utility Report</button>
      <button class="btn-primary" onclick="closeModal('viewUnitModal')">Close</button>
    </div>
  </div>
</div>

<!-- Add this just before the closing body tag -->
<div id="notification" class="notification"></div>


<!-- Loader Spinner -->
<div id="loader" style="
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(2px);
  z-index: 9999;
  display: none;
  justify-content: center;
  align-items: center;
">
  <div style="
    border: 5px solid #e5e7eb;
    border-top: 5px solid #3b82f6;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    animation: spin 0.8s linear infinite;
  "></div>
</div>

<!-- Add this to your <style> block or <head> -->
<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

    <script>
       // Global state management
const state = {
    currentProperty: null,
    properties: [],
    units: [],
    tenants: [],
    maintenanceRequests: [],
    documents: [],
    allUnits: [],
allTenants: [],
    payments: []
};

const API_URL = '/api';

// Initialize application
document.addEventListener('DOMContentLoaded', () => {
    initializeEventListeners();
    initializeTabs();
    loadProperties();
});

// Event Listeners Setup
function initializeEventListeners() {
    // Property management
    document.getElementById('addPropertyBtn')?.addEventListener('click', () => openModal('addPropertyModal'));
    document.getElementById('addPropertyForm')?.addEventListener('submit', handleAddProperty);
    
    // Unit management
    document.getElementById('addUnitBtn')?.addEventListener('click', () => openModal('addUnitModal'));
    document.getElementById('addUnitForm')?.addEventListener('submit', handleAddUnit);
    
    // Tenant management
    document.getElementById('addTenantBtn')?.addEventListener('click', () => {
    if (!state.currentProperty) {
        showNotification('Please select a property first', 'error');
        return;
    }
    resetTenantForm(); // <-- Add this line
    populateUnitSelect();
    openModal('addTenantModal');
});
    document.getElementById('addTenantForm')?.addEventListener('submit', handleAddTenant);
    
    // Maintenance management
    document.getElementById('addMaintenanceBtn')?.addEventListener('click', () => {
    if (!state.currentProperty) {
        showNotification('Please select a property first', 'error');
        return;
    }
    populateMaintenanceUnitSelect();
    openModal('addMaintenanceModal');
});
    document.getElementById('addMaintenanceForm')?.addEventListener('submit', handleAddMaintenance);
    
    // Document management
    document.getElementById('uploadDocumentBtn')?.addEventListener('click', () => {
    if (!state.currentProperty) {
        showNotification('Please select a property first', 'error');
        return;
    }
    openModal('uploadDocumentModal');
});
    document.getElementById('uploadDocumentForm')?.addEventListener('submit', handleDocumentUpload);

    // Add event listeners for payments tab and modal
document.getElementById('addPaymentBtn')?.addEventListener('click', () => {
    if (!state.currentProperty) {
        showNotification('Please select a property first', 'error');
        return;
    }
    const form = document.getElementById('addPaymentForm');
    form.reset();
    form.dataset.editMode = 'false';
    form.dataset.paymentId = '';
    form.querySelector('button[type="submit"]').textContent = 'Save Payment';
    populatePaymentTenantSelect();
    populatePaymentUnitSelect();
    openModal('addPaymentModal');
});
document.getElementById('addPaymentForm')?.addEventListener('submit', handleAddPayment);

    // Modal close handlers
    window.onclick = (event) => {
        if (event.target.classList.contains('modal')) {
            closeModal(event.target.id);
        }
    };
}

// Tab Management
function initializeTabs() {
    const tabs = document.querySelectorAll('.tab-btn');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            const tabId = tab.getAttribute('data-tab');
            showTabContent(tabId);
            loadTabContent(tabId);
        });
    });
}

document.getElementById('leaseType').addEventListener('change', function() {
    document.getElementById('fmrSection').style.display = this.value === 'fmr' ? 'block' : 'none';
    document.getElementById('section8Section').style.display = this.value === 'section8' ? 'flex' : 'none';
});

function showTabContent(tabId) {
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    
    const selectedPane = document.getElementById(tabId);
    if (selectedPane) {
        selectedPane.classList.add('active');
    }
}

function updateTabCounts() {
    // Units
    document.getElementById('tabCountUnits').textContent = state.units?.length || 0;
    // Tenants
    document.getElementById('tabCountTenants').textContent = state.tenants?.length || 0;
    // Documents
    document.getElementById('tabCountDocuments').textContent = state.documents?.length || 0;
    // Payments
    document.getElementById('tabCountPayments').textContent = state.payments?.length || 0;
}

async function loadTabContent(tabId) {
    if (!state.currentProperty) return;

    try {
        switch(tabId) {
            case 'units':
                await loadUnits(state.currentProperty._id);
                break;
            case 'tenants':
                await loadTenants(state.currentProperty._id);
                break;
            case 'maintenance':
                await loadMaintenanceRequests(state.currentProperty._id);
                break;
            case 'documents':
                await loadDocuments(state.currentProperty._id);
                break;
                        case 'payments':
                await loadPayments(state.currentProperty._id);
                break;
        }
    } catch (error) {
        console.error(`Error loading ${tabId} content:`, error);
        showNotification(`Error loading ${tabId}`, 'error');
    }
}

// Property Management
async function loadProperties() {
    showLoader();
    try {
        // Fetch active properties
        const response = await fetch('/api/projects');
        if (!response.ok) throw new Error('Failed to fetch projects');
        const data = await response.json();
        // Only multifamily properties
        const activeProperties = data.projects.filter(project =>
            project.type?.toLowerCase() === 'multifamily'
        );

        // Fetch completed properties
        const completedRes = await fetch('/api/completed-projects');
        if (!completedRes.ok) throw new Error('Failed to fetch completed projects');
        const completedData = await completedRes.json();
        const completedProperties = (completedData.projects || []).filter(project =>
            project.type?.toLowerCase() === 'multifamily'
        );

        // Combine both lists
        state.properties = [...activeProperties, ...completedProperties];

        renderPropertyList();

        // Load all units and tenants for summary
        await loadAllUnitsAndTenants();

        // Auto-select the first property if available
        if (state.properties.length > 0) {
            selectProperty(state.properties[0]._id);
        }
    } catch (error) {
        console.error('Error loading properties:', error);
        showNotification('Error loading properties', 'error');
            } finally {
        hideLoader();
    
    }
}
 

// Update the formatAddress function
function formatAddress(address) {
    // Debug log to see the address structure
    console.log('Address object:', address);
    
    // Return early if no address
    if (!address) return 'No address provided';

    // Check if the address is in the expected format
    if (typeof address === 'object') {
        const addressLines = [];

        // Add line1 if exists
        if (address.line1 || address.addressLine1) {
            addressLines.push(address.line1 || address.addressLine1);
        }

        // Add line2 if exists and not empty
        if ((address.line2 || address.addressLine2) && (address.line2?.trim() || address.addressLine2?.trim())) {
            addressLines.push(address.line2 || address.addressLine2);
        }

        // Add city, state, zip
        const cityLine = [
            address.city,
            address.state,
            address.zip
        ].filter(Boolean).join(', ');
        
        if (cityLine) {
            addressLines.push(cityLine);
        }

        // Join with line breaks
        return addressLines.join('<br>');
    }

    // If address is a string, return as is
    if (typeof address === 'string') {
        return address;
    }

    return 'No address provided';
}

// Update renderPropertyList to handle the address properly
function renderPropertyList() {
    const propertyList = document.getElementById('propertyList');
    
    if (!state.properties.length) {
        propertyList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-building"></i>
                <p>No multifamily properties found</p>
            </div>`;
        return;
    }

    propertyList.innerHTML = state.properties.map(property => {
        const isActive = state.currentProperty && state.currentProperty._id === property._id;
        
        return `
            <div class="property-item ${isActive ? 'active' : ''}" 
                 onclick="selectProperty('${property._id}')">
                <h3>${property.name}</h3>
                <div class="property-address">
                    <i class="fas fa-map-marker-alt"></i>
                    <div class="address-text">${formatAddress(property.address)}</div>
                </div>
                <div class="property-badges">
                    <span class="property-type">
                        <i class="fas fa-building"></i> ${property.type || 'Multifamily'}
                    </span>
                  <span class="property-status ${property.status?.toLowerCase().replace(/\s+/g, '-') || ''}">
                 <i class="fas fa-circle"></i> ${property.status || 'Active'}
                 </span>
                </div>
            </div>
        `;
    }).join('');
}

async function selectProperty(propertyId) {
    showLoader();
    try {
        state.currentProperty = state.properties.find(p => p._id === propertyId);
        if (!state.currentProperty) throw new Error('Property not found');

        document.getElementById('propertyName').textContent = state.currentProperty.name;
        
        // Load all property data in parallel
        await Promise.all([
            loadUnits(propertyId),
            loadTenants(propertyId),
            loadMaintenanceRequests(propertyId),
            loadDocuments(propertyId),
            loadPayments(propertyId)
        ]);
        
        updatePropertyStats();
        showNotification('Property loaded successfully', 'success');

            // Re-render the property list to update the active class
        renderPropertyList();

    } catch (error) {
        console.error('Error selecting property:', error);
        showNotification('Error loading property details', 'error');
            } finally {
        hideLoader();
    }
}

// Update the loadUnits function
async function loadUnits(propertyId) {
    
    try {
        const response = await fetch(`${API_URL}/properties/${propertyId}/units`);
        if (!response.ok) throw new Error('Failed to fetch units');
        
        const data = await response.json();
        // Update this line to correctly access units from the response
        state.units = data.property.units || [];
        console.log('Loaded units:', state.units); // Debug log

        renderUnits();
        updatePropertyStats(); // Update stats after loading units
        populateUnitSelect();
         populateMaintenanceUnitSelect();
         updateTabCounts(); 

    } catch (error) {
        console.error('Error loading units:', error);
        showNotification('Error loading units', 'error');

    }
}

// Update the renderUnits function
function renderUnits() {
    const unitsGrid = document.getElementById('unitsGrid');
    if (!state.units || state.units.length === 0) {
        unitsGrid.innerHTML = `
            <div class="empty-state">
                <p>No units found. Add your first unit!</p>
            </div>`;
        return;
    }

    // Utility icons for visual clarity
    const utilityIcons = {
        water: '<i class="fas fa-tint" style="color:#3498db"></i>',
        gas: '<i class="fas fa-fire" style="color:#e67e22"></i>',
        electricity: '<i class="fas fa-bolt" style="color:#f1c40f"></i>'
    };

    unitsGrid.innerHTML = state.units.map(unit => {
        // Utility account info
        const utilities = ['water', 'gas', 'electricity'].map(type => {
            const acc = unit.utilityAccounts?.[type] || {};
            let statusBadge = '';
            if (acc.status === 'active') {
                statusBadge = `<span class="badge badge-success">Active</span>`;
            } else if (acc.status === 'disconnected') {
                statusBadge = `<span class="badge badge-danger">Disconnected</span>`;
            } else {
                statusBadge = `<span class="badge badge-default">N/A</span>`;
            }
            return `
                <div class="unit-utility-row">
                    ${utilityIcons[type]}
                    <span class="utility-label">${type.charAt(0).toUpperCase() + type.slice(1)}</span>
                    <span class="utility-account">Acct: <strong>${acc.accountNumber || 'N/A'}</strong></span>
                    <span class="utility-provider">${acc.provider || 'N/A'}</span>
                    <span class="utility-under">Bill: <strong>${acc.under ? acc.under.charAt(0).toUpperCase() + acc.under.slice(1) : 'N/A'}</strong></span>
                    ${statusBadge}
                </div>
            `;
        }).join('');

        // Status badge
        let statusBadge = '';
        if (unit.status === 'occupied') {
            statusBadge = `<span class="badge badge-success">Occupied</span>`;
        } else if (unit.status === 'vacant') {
            statusBadge = `<span class="badge badge-warning">Vacant</span>`;
        } else if (unit.status === 'maintenance') {
            statusBadge = `<span class="badge badge-danger">Maintenance</span>`;
        } else {
            statusBadge = `<span class="badge badge-default">${unit.status || 'N/A'}</span>`;
        }

        return `
            <div class="unit-card-modern">
                <div class="unit-card-header">
                    <h3>Unit ${unit.number}</h3>
                    ${statusBadge}
                </div>
                <div class="unit-card-body">
                    <div class="unit-info-row">
                        <span><i class="fas fa-layer-group"></i> Floor: <strong>${unit.floor || '1'}</strong></span>
                        <span><i class="fas fa-bed"></i> ${unit.bedrooms} Bed</span>
                        <span><i class="fas fa-bath"></i> ${unit.bathrooms} Bath</span>
                        <span><i class="fas fa-ruler-combined"></i> ${unit.sqft ? `${unit.sqft} sqft` : 'N/A'}</span>
                    </div>
                    <div class="unit-utilities-section">
                        <div class="unit-utilities-title"><i class="fas fa-plug"></i> Utilities</div>
                        ${utilities}
                    </div>
                </div>
                <div class="unit-card-actions">
                    <button onclick="editUnit('${unit._id}')" class="btn-secondary"><i class="fas fa-edit"></i> Edit</button>
                    <button onclick="viewUnitDetails('${unit._id}')" class="btn-secondary"><i class="fas fa-eye"></i> Details</button>
                    <button onclick="deleteUnit('${unit._id}')" class="btn-icon delete-btn" title="Delete Unit"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `;
    }).join('');
}

// Utility Functions
function formatAddress(address) {
    if (!address) return 'No address provided';
    
    const parts = [];
    if (address.line1) parts.push(address.line1);
    if (address.city) parts.push(address.city);
    if (address.state) parts.push(address.state);
    if (address.zip) parts.push(address.zip);
    
    return parts.join(', ') || 'No address provided';
}


// Property Management Handlers
async function handleAddProperty(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const propertyData = {
        name: formData.get('name'),
        type: 'Multifamily',
        address: {
            line1: formData.get('addressLine1'),
            line2: formData.get('addressLine2'),
            city: formData.get('city'),
            state: formData.get('state'),
            zip: formData.get('zip')
        }
    };
showLoader();
    try {
        const response = await fetch(`${API_URL}/projects`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(propertyData)
        });

        if (!response.ok) throw new Error('Failed to add property');
        
        const newProperty = await response.json();
        state.properties.push(newProperty);
        renderPropertyList();
        closeModal('addPropertyModal');
        showNotification('Property added successfully', 'success');
        event.target.reset();
    } catch (error) {
        console.error('Error adding property:', error);
        showNotification('Error adding property', 'error');
            } finally {
        hideLoader();
    }
}

// Unit Management Handlers
async function editUnit(unitId) {
    try {
        const unit = state.units.find(u => u._id === unitId);
        if (!unit) throw new Error('Unit not found');

        // Populate the edit form
        document.getElementById('unitNumber').value = unit.number || '';
        document.getElementById('unitFloor').value = unit.floor || 1;
        document.getElementById('unitBedrooms').value = unit.bedrooms || '';
        document.getElementById('unitBathrooms').value = unit.bathrooms || '';
        document.getElementById('unitSqft').value = unit.sqft || '';
        document.getElementById('unitStatus').value = unit.status || 'vacant';

        // Populate utility account fields
        const acc = unit.utilityAccounts || {};
        const water = acc.water || {};
        const gas = acc.gas || {};
        const electricity = acc.electricity || {};

        document.getElementById('waterAccountNumber').value = water.accountNumber || '';
        document.getElementById('waterProvider').value = water.provider || '';
        document.getElementById('waterStatus').value = water.status || '';
        document.getElementById('waterUnder').value = water.under || '';

        document.getElementById('gasAccountNumber').value = gas.accountNumber || '';
        document.getElementById('gasProvider').value = gas.provider || '';
        document.getElementById('gasStatus').value = gas.status || '';
        document.getElementById('gasUnder').value = gas.under || '';

        document.getElementById('electricityAccountNumber').value = electricity.accountNumber || '';
        document.getElementById('electricityProvider').value = electricity.provider || '';
        document.getElementById('electricityStatus').value = electricity.status || '';
        document.getElementById('electricityUnder').value = electricity.under || '';

        // Open the modal in edit mode
        openModal('addUnitModal');

        // Set form to edit mode and store unitId
        const form = document.getElementById('addUnitForm');
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.textContent = 'Update Unit';
        form.dataset.editMode = 'true';
        form.dataset.unitId = unitId;

        // Remove any previous submit event listeners (if any)
        form.removeEventListener('submit', handleAddUnit);
        // Add a one-time submit handler for update
        form.onsubmit = async function(e) {
            e.preventDefault();
            await handleUpdateUnit(unitId);
        };
    } catch (error) {
        console.error('Error editing unit:', error);
        showNotification('Error editing unit', 'error');
    }
}

async function handleUpdateUnit(unitId) {
    if (!state.currentProperty) {
        showNotification('Please select a property first', 'error');
        return;
    }

    const unitData = {
        number: document.getElementById('unitNumber').value,
        floor: Number(document.getElementById('unitFloor').value),
        sqft: Number(document.getElementById('unitSqft').value),
        bedrooms: Number(document.getElementById('unitBedrooms').value),
        bathrooms: Number(document.getElementById('unitBathrooms').value),
        status: document.getElementById('unitStatus').value,
        utilityAccounts: {
            water: {
                accountNumber: document.getElementById('waterAccountNumber').value,
                provider: document.getElementById('waterProvider').value,
                status: document.getElementById('waterStatus').value,
                under: document.getElementById('waterUnder').value
            },
            gas: {
                accountNumber: document.getElementById('gasAccountNumber').value,
                provider: document.getElementById('gasProvider').value,
                status: document.getElementById('gasStatus').value,
                under: document.getElementById('gasUnder').value
            },
            electricity: {
                accountNumber: document.getElementById('electricityAccountNumber').value,
                provider: document.getElementById('electricityProvider').value,
                status: document.getElementById('electricityStatus').value,
                under: document.getElementById('electricityUnder').value
            }
        }
    };

    // Validate required fields
    if (!unitData.number || !unitData.bedrooms || !unitData.bathrooms) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }

    showLoader();

    try {
        const response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/units/${unitId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(unitData)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to update unit');
        }

        // Reset form and close modal
        const form = document.getElementById('addUnitForm');
        form.reset();
        form.dataset.editMode = 'false';
        form.dataset.unitId = '';
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.textContent = 'Add Unit';

        // Restore the add handler and remove the custom update handler
        form.onsubmit = handleAddUnit;

        await loadUnits(state.currentProperty._id);
        closeModal('addUnitModal');
        showNotification('Unit updated successfully', 'success');
    } catch (error) {
        console.error('Error updating unit:', error);
        showNotification(error.message || 'Error updating unit', 'error');
            } finally {
        hideLoader();
    }
}

function viewUnitDetails(unitId) {
    const unit = state.units.find(u => u._id === unitId);
    if (!unit) {
        showNotification('Unit not found', 'error');
        return;
    }

    // Set the current unit ID for export
    state.currentUnitId = unitId;

    // Utility account info and bills (example structure)
    const utilities = [
        { type: 'Water', key: 'water' },
        { type: 'Gas', key: 'gas' },
        { type: 'Electricity', key: 'electricity' }
    ];

    // Example: unit.utilityAccounts = { water: {...}, gas: {...}, electricity: {...} }
    // Example: unit.utilityBills = [{type: 'water', amount: 50, dueDate: '2025-07-01', paid: true, paidBy: 'tenant'}]

    let html = `
      <div class="unit-section">
        <h3>Unit: ${unit.number || ''}</h3>
        <p><strong>Status:</strong> ${unit.status || 'N/A'}</p>
        <p><strong>Bedrooms:</strong> ${unit.bedrooms || 'N/A'} | <strong>Bathrooms:</strong> ${unit.bathrooms || 'N/A'}</p>
      </div>
      <div class="unit-section">
        <h3>Utilities</h3>
        ${utilities.map(util => {
            const acc = unit.utilityAccounts?.[util.key] || {};
            return `
              <div class="utility-block">
                <h4>${util.type}</h4>
                <div><strong>Account #:</strong> ${acc.accountNumber || 'N/A'}</div>
                <div><strong>Provider:</strong> ${acc.provider || 'N/A'}</div>
                <div><strong>Status:</strong> ${acc.status || 'N/A'}</div>
                <div><strong>Bill Under:</strong> ${acc.under || 'N/A'}</div>
              </div>
            `;
        }).join('')}
      </div>
      
    `;

    document.getElementById('unitDetailsBody').innerHTML = html;
    openModal('viewUnitModal');
}

function exportUtilityReport() {
    const unit = state.units.find(u => u._id === state.currentUnitId);
    if (!unit) {
        showNotification('Unit not found', 'error');
        return;
    }

    // Prepare CSV header
    let csv = 'Utility,Account Number,Provider,Status,Bill Under\n';

    // List of utilities
    const utilities = [
        { type: 'Water', key: 'water' },
        { type: 'Gas', key: 'gas' },
        { type: 'Electricity', key: 'electricity' }
    ];

    // Add each utility's account info
    utilities.forEach(util => {
        const acc = unit.utilityAccounts?.[util.key] || {};
        csv += [
            util.type,
            acc.accountNumber || '',
            acc.provider || '',
            acc.status || '',
            acc.under || ''
        ].join(',') + '\n';
    });

    // Download as CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `utility_accounts_unit_${unit.number || unit._id}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}


// Update the handleAddUnit function
async function handleAddUnit(event) {
    event.preventDefault();

     const form = event.target;
    
    // If in edit mode, don't proceed with add
    if (form.dataset.editMode === 'true') {
        return;
    }
    
    if (!state.currentProperty) {
        showNotification('Please select a property first', 'error');
        return;
    }

    const unitData = {
        number: document.getElementById('unitNumber').value,
        floor: Number(document.getElementById('unitFloor').value),
        sqft: Number(document.getElementById('unitSqft').value),
        bedrooms: Number(document.getElementById('unitBedrooms').value),
        bathrooms: Number(document.getElementById('unitBathrooms').value),
        status: document.getElementById('unitStatus').value,
        utilityAccounts: {
            water: {
                accountNumber: document.getElementById('waterAccountNumber').value,
                provider: document.getElementById('waterProvider').value,
                status: document.getElementById('waterStatus').value,
                under: document.getElementById('waterUnder').value
            },
            gas: {
                accountNumber: document.getElementById('gasAccountNumber').value,
                provider: document.getElementById('gasProvider').value,
                status: document.getElementById('gasStatus').value,
                under: document.getElementById('gasUnder').value
            },
            electricity: {
                accountNumber: document.getElementById('electricityAccountNumber').value,
                provider: document.getElementById('electricityProvider').value,
                status: document.getElementById('electricityStatus').value,
                under: document.getElementById('electricityUnder').value
            }
        }
        // Add other fields as needed
    };

    // Validate required fields
    if (!unitData.number || !unitData.bedrooms || !unitData.bathrooms) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }
showLoader();
    try {
        console.log('Sending unit data:', unitData); // Debug log

        const response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/units`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(unitData)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to add unit');
        }
        
        const result = await response.json();
        console.log('Unit added successfully:', result); // Debug log

        // Reload units to get updated list
        await loadUnits(state.currentProperty._id);
        closeModal('addUnitModal');
        showNotification('Unit added successfully', 'success');
        event.target.reset();
    } catch (error) {
        console.error('Error adding unit:', error);
        showNotification(error.message || 'Error adding unit', 'error');
            } finally {
        hideLoader();
    }
}


async function deleteUnit(unitId) {
    if (!confirm('Are you sure you want to delete this unit?')) {
        return;
    }
    showLoader();
    try {
        const response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/units/${unitId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Failed to delete unit');
        }

        // Remove unit from state and re-render
        state.units = state.units.filter(u => u._id !== unitId);
        renderUnits();
        updatePropertyStats();
        showNotification('Unit deleted successfully', 'success');
    } catch (error) {
        console.error('Error deleting unit:', error);
        showNotification('Error deleting unit', 'error');
            } finally {
        hideLoader();
    }
}

function addLeaseHolderField(holder = {}) {
    const list = document.getElementById('leaseHoldersList');
    const holderDiv = document.createElement('div');
    holderDiv.className = 'lease-holder-row';
    holderDiv.innerHTML = `
        <input type="text" class="lease-holder-name" placeholder="Full Name" value="${holder.name || ''}" required>
        <input type="tel" class="lease-holder-phone" placeholder="Phone" value="${holder.phone || ''}">
        <input type="email" class="lease-holder-email" placeholder="Email" value="${holder.email || ''}">
        <button type="button" class="btn-icon lease-holder-remove" title="Remove" onclick="removeLeaseHolderField(this)">
            <i class="fas fa-times"></i>
        </button>
    `;
    list.appendChild(holderDiv);
}

function removeLeaseHolderField(btn) {
    btn.parentElement.remove();
}

function getLeaseHoldersFromForm() {
    return Array.from(document.querySelectorAll('#leaseHoldersList .lease-holder-row')).map(row => ({
        name: row.querySelector('.lease-holder-name').value.trim(),
        phone: row.querySelector('.lease-holder-phone').value.trim(),
        email: row.querySelector('.lease-holder-email').value.trim()
    })).filter(holder => holder.name); // Only keep if name is filled
}

function populateLeaseHolders(holders = []) {
    const list = document.getElementById('leaseHoldersList');
    list.innerHTML = '';
    holders.forEach(holder => addLeaseHolderField(holder));
}

// Auto-capitalize each word in the tenant name input
document.getElementById('tenantName')?.addEventListener('input', function() {
    this.value = this.value
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
});

// Reset car fields on form reset
function resetTenantForm() {
    document.getElementById('addTenantForm').reset();
    // Clear dynamic lease holders
    populateLeaseHolders([]);
    // Hide pets section
    document.getElementById('petDetails').style.display = 'none';
    // Hide car section
    document.getElementById('carDetails').style.display = 'none';
    document.getElementById('carFieldsContainer').innerHTML = '';
    // Hide lease type sections
    document.getElementById('fmrSection').style.display = 'none';
    document.getElementById('section8Section').style.display = 'none';
    // Reset submit button text
    const submitButton = document.getElementById('addTenantForm').querySelector('button[type="submit"]');
    if (submitButton) submitButton.textContent = 'Add Tenant';
    // Remove edit mode flags
    const form = document.getElementById('addTenantForm');
    form.dataset.editMode = 'false';
    form.dataset.tenantId = '';
}


// Tenant Management
async function handleAddTenant(event) {
    event.preventDefault();
    
    // Check if we're in edit mode - if so, don't proceed
    const form = event.target;
    if (form.dataset.editMode === 'true') {
        return;
    }
    
    if (!state.currentProperty) {
        showNotification('Please select a property first', 'error');
        return;
    }

    // Gather car info if "Has Car(s)" is checked
    let cars = [];
    if (document.getElementById('hasCar').checked) {
        const carCount = parseInt(document.getElementById('carCount').value) || 0;
        for (let i = 0; i < carCount; i++) {
            cars.push({
                make: document.querySelector(`.car-make[data-index="${i}"]`)?.value || '',
                model: document.querySelector(`.car-model[data-index="${i}"]`)?.value || '',
                color: document.querySelector(`.car-color[data-index="${i}"]`)?.value || '',
                licensePlate: document.querySelector(`.car-plate[data-index="${i}"]`)?.value || '',
                year: document.querySelector(`.car-year[data-index="${i}"]`)?.value || ''
            });
        }
    }

    const tenantData = {
        name: document.getElementById('tenantName').value,
        phone: document.getElementById('tenantPhone').value,
        email: document.getElementById('tenantEmail').value,
        leaseHolders: getLeaseHoldersFromForm(),
        emergencyContact: {
            name: document.getElementById('emergencyContactName').value,
            phone: document.getElementById('emergencyContactPhone').value,
            email: document.getElementById('emergencyContactEmail').value,
            address: document.getElementById('emergencyContactAddress').value,
            relation: document.getElementById('emergencyContactRelation').value
        },
        authorizedOccupants: document.getElementById('authorizedOccupants').value
            .split('\n')
            .map(s => s.trim())
            .filter(Boolean),
        pets: {
            hasPets: document.getElementById('hasPets').checked,
            count: document.getElementById('hasPets').checked ? Number(document.getElementById('petCount').value) : 0,
            fee: document.getElementById('hasPets').checked ? Number(document.getElementById('petFee').value) : 0
        },
        cars: {
            hasCar: document.getElementById('hasCar').checked,
            count: document.getElementById('hasCar').checked ? (parseInt(document.getElementById('carCount').value) || 0) : 0,
            details: cars
        },
        leaseRenewal: document.getElementById('leaseRenewal').value,
        unitId: document.getElementById('tenantUnit').value,
        leaseStart: document.getElementById('leaseStart').value,
        leaseEnd: document.getElementById('leaseEnd').value,
        baseRent: Number(document.getElementById('baseRent').value),
        waterFee: Number(document.getElementById('waterFee').value) || 0,
        trashFee: Number(document.getElementById('trashFee').value) || 0,
        adminFee: Number(document.getElementById('adminFee').value) || 0,
        leaseType: document.getElementById('leaseType').value,
        fmrNotes: document.getElementById('leaseType').value === 'fmr' ? document.getElementById('fmrNotes').value : '',
        hubContribution: document.getElementById('leaseType').value === 'section8' ? Number(document.getElementById('hubContribution').value) : 0,
        tenantContribution: document.getElementById('leaseType').value === 'section8' ? Number(document.getElementById('tenantContribution').value) : 0,
        leaseStatus: document.getElementById('leaseStatus').value
    };

    // Validate lease dates
    if (new Date(tenantData.leaseStart) > new Date(tenantData.leaseEnd)) {
        showNotification('Lease end date must be after start date', 'error');
        return;
    }
    showLoader();
    try {
        const response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/tenants`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(tenantData)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to add tenant');
        }

        // Update unit status to occupied if a unit was assigned
        if (tenantData.unitId) {
            await fetch(`${API_URL}/properties/${state.currentProperty._id}/units/${tenantData.unitId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: 'occupied' })
            });
        }

        await Promise.all([
            loadTenants(state.currentProperty._id),
            loadUnits(state.currentProperty._id)
        ]);
        
        closeModal('addTenantModal');
        showNotification('Tenant added successfully', 'success');
        event.target.reset();
        await loadAllUnitsAndTenants();
    } catch (error) {
        console.error('Error adding tenant:', error);
        showNotification(error.message || 'Error adding tenant', 'error');
    } finally {
        hideLoader();
    }
}

// Show/hide pet details
document.getElementById('hasPets').addEventListener('change', function() {
    document.getElementById('petDetails').style.display = this.checked ? 'block' : 'none';
});

// Show/hide car details and dynamic car fields
document.getElementById('hasCar').addEventListener('change', function() {
    const carDetails = document.getElementById('carDetails');
    carDetails.style.display = this.checked ? 'block' : 'none';
    if (this.checked) {
        updateCarFields();
    }
});

// Update car fields when car count changes
document.getElementById('carCount').addEventListener('input', updateCarFields);

function updateCarFields() {
    const count = parseInt(document.getElementById('carCount').value) || 0;
    const container = document.getElementById('carFieldsContainer');
    container.innerHTML = '';
    for (let i = 0; i < count; i++) {
        container.innerHTML += `
            <div class="car-field-group" style="margin-bottom:10px; padding:8px; background:#f8f9fa; border-radius:6px;">
                <label>Car #${i + 1} Make</label>
                <input type="text" class="car-make" data-index="${i}">
                <label>Model</label>
                <input type="text" class="car-model" data-index="${i}">
                <label>Color</label>
                <input type="text" class="car-color" data-index="${i}">
                <label>License Plate</label>
                <input type="text" class="car-plate" data-index="${i}">
                <label>Year</label>
                <input type="number" class="car-year" data-index="${i}" min="1900" max="2100">
            </div>
        `;
    }
}

// Update the loadTenants function
async function loadTenants(propertyId) {
    
    try {
        const response = await fetch(`${API_URL}/properties/${propertyId}/tenants`);
        if (!response.ok) throw new Error('Failed to fetch tenants');
        
        const tenants = await response.json();
        // Update state with tenant data
        state.tenants = tenants;
        console.log('Loaded tenants:', state.tenants); // Debug log
        renderTenants();
        updateTabCounts(); 
    } catch (error) {
        console.error('Error loading tenants:', error);
        showNotification('Error loading tenants', 'error');

    }
}

// Update the renderTenants function
function renderTenants() {
    const tenantsList = document.getElementById('tenantsList');
    
    if (!state.tenants || !state.tenants.length) {
        tenantsList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <p>No tenants found</p>
                <button onclick="openModal('addTenantModal')" class="btn-primary">
                    Add Your First Tenant
                </button>
            </div>`;
        return;
    }

    tenantsList.innerHTML = state.tenants.map(tenant => {
        // Get tenant initials for avatar
        const initials = tenant.name
            .split(' ')
            .map(n => n[0])
            .join('')
            .toUpperCase();

        // Lease holders
        const leaseHolders = (tenant.leaseHolders && tenant.leaseHolders.length)
            ? `<ul class="tenant-list">${tenant.leaseHolders.map(holder => `
                <li>
                    <strong>${holder.name}</strong>
                    ${holder.phone ? ` | <i class="fas fa-phone"></i> ${holder.phone}` : ''}
                    ${holder.email ? ` | <i class="fas fa-envelope"></i> ${holder.email}` : ''}
                </li>
            `).join('')}</ul>`
            : '<span class="tenant-detail-value">None listed</span>';

        // Find the associated unit
        const assignedUnit = typeof tenant.unitId === 'object' ? tenant.unitId : 
            state.units.find(u => u._id === tenant.unitId || u._id?.toString() === tenant.unitId?.toString());

        // Format lease dates
        const leaseStart = tenant.leaseStart ? 
            new Date(tenant.leaseStart).toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            }) : 'Not set';
        
        const leaseEnd = tenant.leaseEnd ? 
            new Date(tenant.leaseEnd).toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            }) : 'Not set';

        // Lease type details
        let leaseTypeDetails = '';
        if (tenant.leaseType === 'fmr') {
            leaseTypeDetails = `<div class="tenant-detail-row"><span>FMR Notes:</span> <span>${tenant.fmrNotes || 'None'}</span></div>`;
        } else if (tenant.leaseType === 'section8') {
            leaseTypeDetails = `
                <div class="tenant-detail-row"><span>HUB:</span> <span>$${tenant.hubContribution?.toFixed(2) || '0.00'}</span></div>
                <div class="tenant-detail-row"><span>Tenant:</span> <span>$${tenant.tenantContribution?.toFixed(2) || '0.00'}</span></div>
            `;
        }

        // Authorized occupants
        const occupants = (tenant.authorizedOccupants || []).length
            ? `<ul class="tenant-list">${tenant.authorizedOccupants.map(o => `<li>${o}</li>`).join('')}</ul>`
            : '<span class="tenant-detail-value">None listed</span>';

        // Pets
        const pets = tenant.pets?.hasPets
            ? `Yes (${tenant.pets.count} pet${tenant.pets.count > 1 ? 's' : ''}), Fee: $${tenant.pets.fee}`
            : 'No';

        // Cars
        let cars = '<span class="tenant-detail-value">No cars listed</span>';
        if (tenant.cars?.hasCar && Array.isArray(tenant.cars.details) && tenant.cars.details.length) {
            cars = `<ul class="tenant-list">${tenant.cars.details.map((car, idx) => `
                <li>
                    <strong>Car #${idx + 1}:</strong>
                    ${car.year || ''} ${car.make || ''} ${car.model || ''} (${car.color || ''}) - Plate: ${car.licensePlate || ''}
                </li>
            `).join('')}</ul>`;
        }

        // Emergency contact (scrollable)
        const emergency = tenant.emergencyContact
            ? `<div class="tenant-detail-row" style="overflow-x:auto; white-space:nowrap; gap:18px;">
                    <span><i class="fas fa-user-shield"></i> ${tenant.emergencyContact.name || 'N/A'}</span>
                    <span><i class="fas fa-phone"></i> ${tenant.emergencyContact.phone || 'N/A'}</span>
                    <span><i class="fas fa-envelope"></i> ${tenant.emergencyContact.email || 'N/A'}</span>
                    <span><i class="fas fa-map-marker-alt"></i> ${tenant.emergencyContact?.address || 'N/A'}</span>
                    <span><i class="fas fa-user-friends"></i> ${tenant.emergencyContact.relation || 'N/A'}</span>
                </div>`
            : '<span class="tenant-detail-value">N/A</span>';

        // Additional fees
        const additionalFees = `
            <div class="tenant-detail-row"><span>Water Fee:</span> <span>$${tenant.waterFee?.toFixed(2) || '0.00'}</span></div>
            <div class="tenant-detail-row"><span>Trash Fee:</span> <span>$${tenant.trashFee?.toFixed(2) || '0.00'}</span></div>
            <div class="tenant-detail-row"><span>Admin Fee:</span> <span>$${tenant.adminFee?.toFixed(2) || '0.00'}</span></div>
        `;

        // Total rent calculation (base rent + additional fees)
const totalRent = 
    (Number(tenant.baseRent) || 0) +
    (Number(tenant.waterFee) || 0) +
    (Number(tenant.trashFee) || 0) +
    (Number(tenant.adminFee) || 0) +
    (tenant.pets?.hasPets ? (Number(tenant.pets.fee) || 0) : 0);

        return `
            <div class="tenant-card">
                <div class="tenant-header">
                    <div class="tenant-avatar-small">${initials}</div>
                    <h3>${tenant.name}</h3>
                </div>
                <div class="tenant-info">
                    <div class="tenant-section">
                        <div class="tenant-section-title"><i class="fas fa-home"></i> Unit</div>
                        <div class="tenant-detail-row">
                            ${assignedUnit ? 
                                `Unit ${assignedUnit.number} (${assignedUnit.bedrooms} bed, ${assignedUnit.bathrooms} bath)` : 
                                'No unit assigned'}
                        </div>
                    </div>
                    <div class="tenant-section">
                        <div class="tenant-section-title"><i class="fas fa-address-book"></i> Contact</div>
                        <div class="tenant-detail-row"><span><i class="fas fa-phone"></i> ${tenant.phone}</span></div>
                        <div class="tenant-detail-row"><span><i class="fas fa-envelope"></i> ${tenant.email}</span></div>
                    </div>
                    <div class="tenant-section">
                        <div class="tenant-section-title"><i class="fas fa-user"></i> Additional Lease Holders</div>
                        ${leaseHolders}
                    </div>
                    <div class="tenant-section">
                        <div class="tenant-section-title"><i class="fas fa-file-contract"></i> Lease</div>
                        <div class="tenant-detail-row"><span>Lease:</span> <span>${leaseStart} - ${leaseEnd}</span></div>
                        <div class="tenant-detail-row"><span>Rent:</span> <span>$${tenant.baseRent?.toFixed(2) || '0.00'}</span></div>
                        ${additionalFees}
                        <div class="tenant-detail-row"><span><strong>Total Rent:</strong></span> <span><strong>$${totalRent.toFixed(2)}</strong></span></div>
                        <div class="tenant-detail-row"><span>Type:</span> <span>${tenant.leaseType === 'fmr' ? 'Free Market Rent' : tenant.leaseType === 'section8' ? 'Section 8' : 'N/A'}</span></div>
                        ${leaseTypeDetails}
                        <div class="tenant-detail-row">
                            <span>Status:</span>
                            <span class="lease-badge ${tenant.leaseStatus || 'active'}">
                                <i class="fas fa-circle"></i>
                                ${(tenant.leaseStatus || 'active').charAt(0).toUpperCase() + (tenant.leaseStatus || 'active').slice(1)}
                            </span>
                        </div>
                        <div class="tenant-detail-row"><span>Renewal:</span> <span>${tenant.leaseRenewal === 'renew' ? 'Will Renew' : 'Will Terminate'}</span></div>
                    </div>
                    <div class="tenant-section">
                        <div class="tenant-section-title"><i class="fas fa-user-shield"></i> Emergency Contact</div>
                        ${emergency}
                    </div>
                    <div class="tenant-section">
                        <div class="tenant-section-title"><i class="fas fa-users"></i> Authorized Occupants</div>
                        ${occupants}
                    </div>
                    <div class="tenant-section">
                        <div class="tenant-section-title"><i class="fas fa-paw"></i> Pets</div>
                        <div class="tenant-detail-row">${pets}</div>
                    </div>
                    <div class="tenant-section">
                        <div class="tenant-section-title"><i class="fas fa-car"></i> Cars</div>
                        ${cars}
                    </div>
                </div>
                <div class="tenant-actions">
                    <button onclick="viewTenantDetails('${tenant._id}')" class="btn-secondary">
                        <i class="fas fa-eye"></i> Details
                    </button>
                    <button onclick="editTenant('${tenant._id}')" class="btn-secondary">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button onclick="deleteTenant('${tenant._id}')" class="btn-icon delete-btn" title="Delete Tenant">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

async function viewTenantDetails(tenantId) {
    try {
        const tenant = state.tenants.find(t => t._id === tenantId);
        if (!tenant) throw new Error('Tenant not found');

        // Get tenant initials for avatar
        const initials = tenant.name
            .split(' ')
            .map(n => n[0])
            .join('')
            .toUpperCase();

        // Lease holders
        const leaseHoldersHtml = (tenant.leaseHolders && tenant.leaseHolders.length)
            ? `<ul>
                ${tenant.leaseHolders.map(holder => `
                    <li>
                        <strong>${holder.name}</strong>
                        ${holder.phone ? ` | <i class="fas fa-phone"></i> ${holder.phone}` : ''}
                        ${holder.email ? ` | <i class="fas fa-envelope"></i> ${holder.email}` : ''}
                    </li>
                `).join('')}
              </ul>`
            : '<span class="tenant-detail-value">None listed</span>';

        // Format dates
        const leaseStart = tenant.leaseStart ?
            new Date(tenant.leaseStart).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) : 'Not set';

        const leaseEnd = tenant.leaseEnd ?
            new Date(tenant.leaseEnd).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) : 'Not set';

        // Unit info
        let unitInfoHtml = '<p>No unit assigned</p>';
        if (tenant.unitId && typeof tenant.unitId === 'object') {
            unitInfoHtml = `
                <p><i class="fas fa-home"></i> Unit ${tenant.unitId.number}</p>
                <p><i class="fas fa-bed"></i> ${tenant.unitId.bedrooms} Bedrooms, ${tenant.unitId.bathrooms} Bathrooms</p>
                <p><i class="fas fa-ruler-combined"></i> ${tenant.unitId.sqft || 'N/A'} sq ft</p>
                <p><i class="fas fa-building"></i> Floor ${tenant.unitId.floor || '1'}</p>
            `;
        }

        // Lease type details
        let leaseTypeDetails = '';
        if (tenant.leaseType === 'fmr') {
            leaseTypeDetails = `<p><i class="fas fa-sticky-note"></i> FMR Notes: ${tenant.fmrNotes || 'None'}</p>`;
        } else if (tenant.leaseType === 'section8') {
            leaseTypeDetails = `
                <p><i class="fas fa-building"></i> HUB Contribution: $${tenant.hubContribution?.toFixed(2) || '0.00'}</p>
                <p><i class="fas fa-user"></i> Tenant Contribution: $${tenant.tenantContribution?.toFixed(2) || '0.00'}</p>
            `;
        }

        // Additional fees
        const additionalFeesHtml = `
            <p><i class="fas fa-tint"></i> Water Fee: $${tenant.waterFee?.toFixed(2) || '0.00'}</p>
            <p><i class="fas fa-trash"></i> Trash Fee: $${tenant.trashFee?.toFixed(2) || '0.00'}</p>
            <p><i class="fas fa-user-cog"></i> Admin Fee: $${tenant.adminFee?.toFixed(2) || '0.00'}</p>
        `;

        // Total rent calculation (base rent + additional fees)
const totalRent = 
    (Number(tenant.baseRent) || 0) +
    (Number(tenant.waterFee) || 0) +
    (Number(tenant.trashFee) || 0) +
    (Number(tenant.adminFee) || 0) +
    (tenant.pets?.hasPets ? (Number(tenant.pets.fee) || 0) : 0);

        // Authorized occupants
        const occupantsHtml = (tenant.authorizedOccupants || []).length
            ? `<ul>${tenant.authorizedOccupants.map(o => `<li>${o}</li>`).join('')}</ul>`
            : '<li>None listed</li>';

        // Pets
        const petsHtml = tenant.pets?.hasPets
            ? `Yes (${tenant.pets.count} pet${tenant.pets.count > 1 ? 's' : ''}), Fee: $${tenant.pets.fee}`
            : 'No';

        // Cars
        let carsHtml = '<span class="tenant-detail-value">No cars listed</span>';
        if (tenant.cars?.hasCar && Array.isArray(tenant.cars.details) && tenant.cars.details.length) {
            carsHtml = `<ul class="tenant-list">${tenant.cars.details.map((car, idx) => `
                <li>
                    <strong>Car #${idx + 1}:</strong>
                    ${car.year || ''} ${car.make || ''} ${car.model || ''} (${car.color || ''}) - Plate: ${car.licensePlate || ''}
                </li>
            `).join('')}</ul>`;
        }

        // Emergency contact
        const emergencyHtml = tenant.emergencyContact
            ? `
                <p><i class="fas fa-user-shield"></i> ${tenant.emergencyContact.name || 'N/A'}</p>
                <p><i class="fas fa-phone"></i> ${tenant.emergencyContact.phone || 'N/A'}</p>
                <p><i class="fas fa-envelope"></i> ${tenant.emergencyContact.email || 'N/A'}</p>
                <p><i class="fas fa-map-marker-alt"></i> ${tenant.emergencyContact.address || 'N/A'}</p>
                <p><i class="fas fa-user-friends"></i> Relation: ${tenant.emergencyContact.relation || 'N/A'}</p>
            `
            : '<span class="tenant-detail-value">N/A</span>';

        // Lease status badge
        const leaseStatus = tenant.leaseStatus || 'active';
        const leaseStatusText = leaseStatus.charAt(0).toUpperCase() + leaseStatus.slice(1);

        // Dates for created/updated
        const createdAt = tenant.createdAt ? new Date(tenant.createdAt).toLocaleDateString('en-US', {
            year: 'numeric', month: 'long', day: 'numeric'
        }) : '';
        const updatedAt = tenant.updatedAt ? new Date(tenant.updatedAt).toLocaleDateString('en-US', {
            year: 'numeric', month: 'long', day: 'numeric'
        }) : '';

        const detailsHtml = `
            <div class="modal-content tenant-details-modal">
                <div class="tenant-details-header">
                    <div class="tenant-avatar">${initials}</div>
                    <h2>${tenant.name}</h2>
                </div>
                <div class="tenant-details-content">
                    <div class="detail-group">
                        <label>Contact Information</label>
                        <p><i class="fas fa-phone"></i> ${tenant.phone}</p>
                        <p><i class="fas fa-envelope"></i> ${tenant.email}</p>
                    </div>
                    <div class="detail-group">
                        <label>Additional Lease Holders</label>
                        ${leaseHoldersHtml}
                    </div>
                    <div class="detail-group">
                        <label>Unit Information</label>
                        ${unitInfoHtml}
                    </div>
                    <div class="detail-group">
                        <label>Lease Information</label>
                        <p><i class="fas fa-calendar-alt"></i> Start Date: ${leaseStart}</p>
                        <p><i class="fas fa-calendar-check"></i> End Date: ${leaseEnd}</p>
                        <p><i class="fas fa-dollar-sign"></i> Base Rent: $${tenant.baseRent?.toFixed(2) || '0.00'}</p>
                        ${additionalFeesHtml}
                        <p><strong><i class="fas fa-calculator"></i> Total Rent:</strong> <strong>$${totalRent.toFixed(2)}</strong></p>
                        <p><i class="fas fa-file-contract"></i> Lease Type: 
                            ${tenant.leaseType === 'fmr' ? 'Free Market Rent' : tenant.leaseType === 'section8' ? 'Section 8' : 'N/A'}
                        </p>
                        ${leaseTypeDetails}
                        <p>
                          <i class="fas fa-info-circle"></i> Lease Status:
                          <span class="lease-badge ${leaseStatus}">
                            ${leaseStatusText}
                          </span>
                        </p>
                        <p><i class="fas fa-redo"></i> Renewal: ${tenant.leaseRenewal === 'renew' ? 'Will Renew' : 'Will Terminate'}</p>
                    </div>
                    <div class="detail-group">
                        <label>Emergency Contact</label>
                        ${emergencyHtml}
                    </div>
                    <div class="detail-group">
                        <label>Authorized Occupants</label>
                        <ul>
                            ${occupantsHtml}
                        </ul>
                    </div>
                    <div class="detail-group">
                        <label>Pets</label>
                        <p>${petsHtml}</p>
                    </div>
                    <div class="detail-group">
                        <label>Cars</label>
                        ${carsHtml}
                    </div>
                    <div class="detail-group">
                        <label>Additional Information</label>
                        <p><i class="fas fa-clock"></i> Added: ${createdAt}</p>
                        <p><i class="fas fa-sync"></i> Last Updated: ${updatedAt}</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button onclick="editTenant('${tenant._id}')" class="btn-primary">
                        <i class="fas fa-edit"></i> Edit Tenant
                    </button>
                    <button onclick="closeModal('tenantDetailsModal')" class="btn-secondary">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        `;

        let modal = document.getElementById('tenantDetailsModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'tenantDetailsModal';
            modal.className = 'modal';
            document.body.appendChild(modal);
        }

        modal.innerHTML = detailsHtml;
        openModal('tenantDetailsModal');

    } catch (error) {
        console.error('Error viewing tenant details:', error);
        showNotification('Error loading tenant details', 'error');
    }
}


async function editTenant(tenantId) {
    try {
        const tenant = state.tenants.find(t => t._id === tenantId);
        if (!tenant) throw new Error('Tenant not found');

        // Populate form fields
        document.getElementById('tenantName').value = tenant.name || '';
        document.getElementById('tenantPhone').value = tenant.phone || '';
        document.getElementById('tenantEmail').value = tenant.email || '';

        populateLeaseHolders(tenant.leaseHolders || []);

        // Lease info fields
        document.getElementById('leaseStart').value = tenant.leaseStart ? new Date(tenant.leaseStart).toISOString().split('T')[0] : '';
        document.getElementById('leaseEnd').value = tenant.leaseEnd ? new Date(tenant.leaseEnd).toISOString().split('T')[0] : '';
        document.getElementById('baseRent').value = tenant.baseRent ?? '';
        document.getElementById('waterFee').value = tenant.waterFee ?? '';
        document.getElementById('trashFee').value = tenant.trashFee ?? '';
        document.getElementById('adminFee').value = tenant.adminFee ?? '';
        document.getElementById('leaseType').value = tenant.leaseType ?? '';
        document.getElementById('leaseStatus').value = tenant.leaseStatus || 'active';

        // Show/hide lease type sections and populate their fields
        if (tenant.leaseType === 'fmr') {
            document.getElementById('fmrSection').style.display = 'block';
            document.getElementById('section8Section').style.display = 'none';
            document.getElementById('fmrNotes').value = tenant.fmrNotes ?? '';
        } else if (tenant.leaseType === 'section8') {
            document.getElementById('fmrSection').style.display = 'none';
            document.getElementById('section8Section').style.display = 'flex';
            document.getElementById('hubContribution').value = tenant.hubContribution ?? '';
            document.getElementById('tenantContribution').value = tenant.tenantContribution ?? '';
        } else {
            document.getElementById('fmrSection').style.display = 'none';
            document.getElementById('section8Section').style.display = 'none';
            document.getElementById('fmrNotes').value = '';
            document.getElementById('hubContribution').value = '';
            document.getElementById('tenantContribution').value = '';
        }

        // Emergency contact
        document.getElementById('emergencyContactName').value = tenant.emergencyContact?.name || '';
        document.getElementById('emergencyContactPhone').value = tenant.emergencyContact?.phone || '';
        document.getElementById('emergencyContactEmail').value = tenant.emergencyContact?.email || '';
        document.getElementById('emergencyContactAddress').value = tenant.emergencyContact?.address || '';
        document.getElementById('emergencyContactRelation').value = tenant.emergencyContact?.relation || '';

        // Authorized occupants
        document.getElementById('authorizedOccupants').value = (tenant.authorizedOccupants || []).join('\n');

        // Pets
        document.getElementById('hasPets').checked = !!(tenant.pets && tenant.pets.hasPets);
        document.getElementById('petDetails').style.display = (tenant.pets && tenant.pets.hasPets) ? 'block' : 'none';
        document.getElementById('petCount').value = tenant.pets?.count || '';
        document.getElementById('petFee').value = tenant.pets?.fee || '';

        // Lease renewal
        document.getElementById('leaseRenewal').value = tenant.leaseRenewal || 'renew';

        // Cars
        document.getElementById('hasCar').checked = !!(tenant.cars && tenant.cars.hasCar);
        document.getElementById('carDetails').style.display = (tenant.cars && tenant.cars.hasCar) ? 'block' : 'none';
        document.getElementById('carCount').value = tenant.cars?.count || 1;
        updateCarFields();
        if (tenant.cars && Array.isArray(tenant.cars.details)) {
            tenant.cars.details.forEach((car, i) => {
                document.querySelector(`.car-make[data-index="${i}"]`).value = car.make || '';
                document.querySelector(`.car-model[data-index="${i}"]`).value = car.model || '';
                document.querySelector(`.car-color[data-index="${i}"]`).value = car.color || '';
                document.querySelector(`.car-plate[data-index="${i}"]`).value = car.licensePlate || '';
                document.querySelector(`.car-year[data-index="${i}"]`).value = car.year || '';
            });
        }

        // Get vacant units plus the tenant's current unit
        const availableUnits = state.units.filter(unit =>
            unit.status === 'vacant' || (tenant.unitId && (unit._id === tenant.unitId._id || unit._id === tenant.unitId))
        );

        // Populate unit select
        const unitSelect = document.getElementById('tenantUnit');
        unitSelect.innerHTML = `
            <option value="">Select a unit</option>
            ${availableUnits.map(unit => `
                <option value="${unit._id}" ${(tenant.unitId && (unit._id === tenant.unitId._id || unit._id === tenant.unitId)) ? 'selected' : ''}>
                    Unit ${unit.number} - ${unit.bedrooms} bed, ${unit.bathrooms} bath
                </option>
            `).join('')}
        `;

        // Open modal in edit mode
        openModal('addTenantModal');

        // Update form handler for edit mode
        const form = document.getElementById('addTenantForm');
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.textContent = 'Update Tenant';

        // Store the tenantId for update and mark as edit mode
        form.dataset.editMode = 'true';
        form.dataset.tenantId = tenantId;

        // Remove the previous event listener and add new one
        form.onsubmit = null;
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            await handleUpdateTenant(tenantId);

            // After update, handle unit status based on leaseStatus
            const leaseStatus = document.getElementById('leaseStatus').value;
            const unitId = document.getElementById('tenantUnit').value;
            if (unitId) {
                if (leaseStatus === 'terminated' || leaseStatus === 'expired') {
                    await fetch(`${API_URL}/properties/${state.currentProperty._id}/units/${unitId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'vacant' })
                    });
                    await loadUnits(state.currentProperty._id);
                } else if (leaseStatus === 'active') {
                    await fetch(`${API_URL}/properties/${state.currentProperty._id}/units/${unitId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'occupied' })
                    });
                    await loadUnits(state.currentProperty._id);
                }
            }
        }, { once: true }); // Use once: true to auto-remove after submission
    } catch (error) {
        console.error('Error editing tenant:', error);
        showNotification('Error editing tenant', 'error');
    }
}

// Update the handleUpdateTenant function to not take event parameter
async function handleUpdateTenant(tenantId) {
    const tenant = state.tenants.find(t => t._id === tenantId);
    if (!tenant) {
        showNotification('Tenant not found', 'error');
        return;
    }

    const newUnitId = document.getElementById('tenantUnit').value;
    const oldUnitId = tenant.unitId?._id || tenant.unitId;

    // Gather car info if "Has Car(s)" is checked
    let cars = [];
    if (document.getElementById('hasCar').checked) {
        const carCount = parseInt(document.getElementById('carCount').value) || 0;
        for (let i = 0; i < carCount; i++) {
            cars.push({
                make: document.querySelector(`.car-make[data-index="${i}"]`)?.value || '',
                model: document.querySelector(`.car-model[data-index="${i}"]`)?.value || '',
                color: document.querySelector(`.car-color[data-index="${i}"]`)?.value || '',
                licensePlate: document.querySelector(`.car-plate[data-index="${i}"]`)?.value || '',
                year: document.querySelector(`.car-year[data-index="${i}"]`)?.value || ''
            });
        }
    }

    const tenantData = {
        name: document.getElementById('tenantName').value,
        phone: document.getElementById('tenantPhone').value,
        email: document.getElementById('tenantEmail').value,
        leaseHolders: getLeaseHoldersFromForm(),
        emergencyContact: {
            name: document.getElementById('emergencyContactName').value,
            phone: document.getElementById('emergencyContactPhone').value,
            email: document.getElementById('emergencyContactEmail').value,
            address: document.getElementById('emergencyContactAddress').value, 
            relation: document.getElementById('emergencyContactRelation').value
        },
        authorizedOccupants: document.getElementById('authorizedOccupants').value
            .split('\n')
            .map(s => s.trim())
            .filter(Boolean),
        pets: {
            hasPets: document.getElementById('hasPets').checked,
            count: document.getElementById('hasPets').checked ? Number(document.getElementById('petCount').value) : 0,
            fee: document.getElementById('hasPets').checked ? Number(document.getElementById('petFee').value) : 0
        },
        cars: {
            hasCar: document.getElementById('hasCar').checked,
            count: document.getElementById('hasCar').checked ? (parseInt(document.getElementById('carCount').value) || 0) : 0,
            details: cars
        },
        leaseRenewal: document.getElementById('leaseRenewal').value,
        unitId: newUnitId,
        leaseStart: document.getElementById('leaseStart').value,
        leaseEnd: document.getElementById('leaseEnd').value,
        baseRent: Number(document.getElementById('baseRent').value),
        waterFee: Number(document.getElementById('waterFee').value) || 0,
        trashFee: Number(document.getElementById('trashFee').value) || 0,
        adminFee: Number(document.getElementById('adminFee').value) || 0,
        leaseType: document.getElementById('leaseType').value,
        fmrNotes: document.getElementById('leaseType').value === 'fmr' ? document.getElementById('fmrNotes').value : '',
        hubContribution: document.getElementById('leaseType').value === 'section8' ? Number(document.getElementById('hubContribution').value) : 0,
        tenantContribution: document.getElementById('leaseType').value === 'section8' ? Number(document.getElementById('tenantContribution').value) : 0,
        leaseStatus: document.getElementById('leaseStatus').value,
        status: tenant.status || 'active'
    };

    // Validate lease dates
    if (new Date(tenantData.leaseStart) > new Date(tenantData.leaseEnd)) {
        showNotification('Lease end date must be after start date', 'error');
        return;
    }
    showLoader();
    try {
        // Update tenant
        const response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/tenants/${tenantId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(tenantData)
        });

        if (!response.ok) throw new Error('Failed to update tenant');

        // Handle unit status changes
        if (oldUnitId !== newUnitId) {
            // Set old unit to vacant if exists
            if (oldUnitId) {
                await fetch(`${API_URL}/properties/${state.currentProperty._id}/units/${oldUnitId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'vacant' })
                });
            }

            // Set new unit to occupied if selected
            if (newUnitId) {
                await fetch(`${API_URL}/properties/${state.currentProperty._id}/units/${newUnitId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'occupied' })
                });
            }
        }

        // If leaseStatus is 'terminated' or 'expired', set the unit to vacant
        if (
            (tenantData.leaseStatus === 'terminated' || tenantData.leaseStatus === 'expired') &&
            newUnitId
        ) {
            await fetch(`${API_URL}/properties/${state.currentProperty._id}/units/${newUnitId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'vacant' })
            });
        }

        // If leaseStatus is 'active', set the unit to occupied
        if (
            tenantData.leaseStatus === 'active' &&
            newUnitId
        ) {
            await fetch(`${API_URL}/properties/${state.currentProperty._id}/units/${newUnitId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'occupied' })
            });
        }

        await Promise.all([
            loadTenants(state.currentProperty._id),
            loadUnits(state.currentProperty._id)
        ]);
        
        // Reset form and close modal
        const form = document.getElementById('addTenantForm');
        form.reset();
        form.dataset.editMode = 'false';
        form.dataset.tenantId = '';
        
        // Reset the submit button text
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.textContent = 'Add Tenant';
        
        // Reset the form handler to add mode
        form.onsubmit = handleAddTenant;
        
        closeModal('addTenantModal');
        showNotification('Tenant updated successfully', 'success');
        await loadAllUnitsAndTenants();
    } catch (error) {
        console.error('Error updating tenant:', error);
        showNotification('Error updating tenant', 'error');
    } finally {
        hideLoader();
    }
}
// Add this function to populate unit select when opening the tenant modal
function populateUnitSelect() {
    const unitSelect = document.getElementById('tenantUnit');
    if (!unitSelect || !state.units) return;
    
    // Get only vacant units
    const vacantUnits = state.units.filter(unit => unit.status === 'vacant');
    
    console.log('Vacant units:', vacantUnits); // Debug log
    
    // Clear existing options and add new ones
    unitSelect.innerHTML = `
        <option value="">Select a unit</option>
        ${vacantUnits.map(unit => `
            <option value="${unit._id}">
                Unit ${unit.number} - ${unit.bedrooms} bed, ${unit.bathrooms} bath
            </option>
        `).join('')}
    `;
}




//  deleteTenant function
async function deleteTenant(tenantId) {
    if (!confirm('Are you sure you want to delete this tenant?')) {
        return;
    }
   showLoader();
    try {
        const tenant = state.tenants.find(t => t._id === tenantId);
        if (!tenant) throw new Error('Tenant not found');

        const response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/tenants/${tenantId}`, {
            method: 'DELETE'
        });

        if (!response.ok) throw new Error('Failed to delete tenant');

        // If tenant was assigned to a unit, update unit status to vacant
        if (tenant.unitId) {
            await fetch(`${API_URL}/properties/${state.currentProperty._id}/units/${tenant.unitId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'vacant' })
            });
        }

        // Reload both tenants and units
        await Promise.all([
            loadTenants(state.currentProperty._id),
            loadUnits(state.currentProperty._id)
        ]);

        showNotification('Tenant deleted successfully', 'success');
    } catch (error) {
        console.error('Error deleting tenant:', error);
        showNotification('Error deleting tenant', 'error');
           } finally {
        hideLoader(); 
    }
}


// Maintenance Request Management
async function handleAddMaintenance(event) {
    event.preventDefault();

    if (!state.currentProperty) {
        showNotification('Please select a property first', 'error');
        return;
    }

    const maintenanceData = {
        title: document.getElementById('maintenanceTitle').value.trim(),
        description: document.getElementById('maintenanceDescription').value.trim(),
        priority: document.getElementById('maintenancePriority').value,
        unitId: document.getElementById('maintenanceUnit').value,
        status: 'pending'
    };
showLoader();
    try {
        const response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/maintenance`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(maintenanceData)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to create maintenance request');
        }

        // Reset form before loading new data
        event.target.reset();
        closeModal('addMaintenanceModal');
        
        await loadMaintenanceRequests(state.currentProperty._id);
        showNotification('Maintenance request created successfully', 'success');
        

    } catch (error) {
        console.error('Error creating maintenance request:', error);
        showNotification(error.message || 'Error creating maintenance request', 'error');
            } finally {
        hideLoader();
    }
}

function updateMaintenanceTabBadge() {
    const badge = document.getElementById('maintenancePendingBadge');
    const pendingCount = state.maintenanceRequests.filter(r => r.status === 'pending').length;
    if (pendingCount > 0) {
        badge.textContent = pendingCount > 9 ? '9+' : pendingCount;
        badge.style.display = '';
    } else {
        badge.style.display = 'none';
    }
}


async function loadMaintenanceRequests(propertyId) {
    
    try {
        const response = await fetch(`${API_URL}/properties/${propertyId}/maintenance`);
        if (!response.ok) throw new Error('Failed to fetch maintenance requests');
        
        const requests = await response.json();
        state.maintenanceRequests = requests;
        console.log('Loaded maintenance requests:', state.maintenanceRequests);
        renderMaintenanceRequests();
        updateMaintenanceTabBadge();
    } catch (error) {
        console.error('Error loading maintenance requests:', error);
        showNotification('Error loading maintenance requests', 'error');

    }
}

// Update the renderMaintenanceRequests function
function renderMaintenanceRequests() {
    const maintenanceList = document.getElementById('maintenanceList');
    if (!state.maintenanceRequests?.length) {
        maintenanceList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-tools"></i>
                <p>No maintenance requests found</p>
                <button onclick="openModal('addMaintenanceModal')" class="btn-primary">
                    Create New Request
                </button>
            </div>`;
        return;
    }

    maintenanceList.innerHTML = state.maintenanceRequests.map(request => {
        // Find the associated unit
        const unit = typeof request.unitId === 'object' ? request.unitId : 
            state.units.find(u => u._id === request.unitId);

        // Format creation date
        const createdDate = new Date(request.createdAt).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        });

        return `
            <div class="maintenance-card">
                <div class="maintenance-header">
                    <div class="header-content">
                        <h3>${request.title}</h3>
                        <span class="priority-badge ${request.priority}">
                            <i class="fas fa-exclamation-circle"></i>
                            ${request.priority.charAt(0).toUpperCase() + request.priority.slice(1)} Priority
                        </span>
                    </div>
                    <div class="maintenance-actions">
                        <button onclick="updateMaintenanceStatus('${request._id}')" class="btn-secondary">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteMaintenance('${request._id}')" class="btn-icon delete-btn" title="Delete Request">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div class="maintenance-content">
                    <div class="unit-info">
                        <i class="fas fa-home"></i>
                        ${unit ? 
                            `Unit ${unit.number} (${unit.bedrooms}bed/${unit.bathrooms}bath)` : 
                            'No unit assigned'}
                    </div>
                    <div class="description">
                        <p>${request.description}</p>
                    </div>
                </div>

                <div class="maintenance-footer">
                    <div class="request-meta">
                        <span class="status-badge ${request.status}">
                            <i class="fas fa-circle"></i>
                            ${request.status.charAt(0).toUpperCase() + request.status.slice(1)}
                        </span>
                        <span class="created-date">
                            <i class="fas fa-calendar-alt"></i>
                            Created: ${createdDate}
                        </span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Add this function to populate maintenance unit select
function populateMaintenanceUnitSelect() {
    const unitSelect = document.getElementById('maintenanceUnit');
    if (!unitSelect || !state.units) return;
    
    // Get all units (we want to allow maintenance requests for any unit)
    console.log('Available units for maintenance:', state.units); // Debug log
    
    // Clear existing options and add new ones
    unitSelect.innerHTML = `
        <option value="">Select a unit</option>
        ${state.units.map(unit => `
            <option value="${unit._id}">
                Unit ${unit.number} - ${unit.status}
                (${unit.bedrooms} bed, ${unit.bathrooms} bath)
            </option>
        `).join('')}
    `;
}


// Add before the window exports

async function deleteMaintenance(requestId) {
    if (!confirm('Are you sure you want to delete this maintenance request?')) {
        return;
    }
     showLoader();
    try {
        const response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/maintenance/${requestId}`, {
            method: 'DELETE'
        });

        if (!response.ok) throw new Error('Failed to delete maintenance request');

        await loadMaintenanceRequests(state.currentProperty._id);
        showNotification('Maintenance request deleted successfully', 'success');
    } catch (error) {
        console.error('Error deleting maintenance request:', error);
        showNotification('Error deleting maintenance request', 'error');
            } finally {
        hideLoader();
    }
}


async function updateMaintenanceStatus(requestId) {
    showLoader();
    try {
        const request = state.maintenanceRequests.find(r => r._id === requestId);
        if (!request) throw new Error('Maintenance request not found');

        // Create status selection dialog
        const newStatus = await showStatusDialog(request.status);
        if (!newStatus) return; // User cancelled

        const response = await fetch(
            `${API_URL}/properties/${state.currentProperty._id}/maintenance/${requestId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            }
        );

        if (!response.ok) throw new Error('Failed to update maintenance status');
        
        await loadMaintenanceRequests(state.currentProperty._id);
        showNotification('Maintenance status updated successfully', 'success');
    } catch (error) {
        console.error('Error updating maintenance status:', error);
        showNotification('Error updating maintenance status', 'error');
            } finally {
        hideLoader();
    }
}

// Update the showStatusDialog function
function showStatusDialog(currentStatus) {
    return new Promise(resolve => {
        const statuses = [
            { value: 'pending', icon: 'clock', label: 'Pending' },
            { value: 'in-progress', icon: 'tools', label: 'In Progress' },
            { value: 'completed', icon: 'check-circle', label: 'Completed' }
        ];

        const dialog = document.createElement('div');
        dialog.className = 'modal status-dialog';
        
        dialog.innerHTML = `
            <div class="modal-content">
                <h3>Update Maintenance Status</h3>
                <div class="status-options">
                    ${statuses.map(status => `
                        <button class="status-option ${status.value} ${status.value === currentStatus ? 'active' : ''}"
                                onclick="updateStatus('${status.value}')">
                            <i class="fas fa-${status.icon}"></i>
                            ${status.label}
                            ${status.value === currentStatus ? 
                                '<i class="fas fa-check" style="margin-left: auto"></i>' : 
                                ''}
                        </button>
                    `).join('')}
                </div>
                <div class="dialog-footer">
                    <button onclick="cancelStatusUpdate()" class="btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(dialog);
        dialog.style.display = 'block';

        // Close dialog if clicking outside
        dialog.addEventListener('click', (e) => {
            if (e.target === dialog) {
                cancelStatusUpdate();
            }
        });

        window.updateStatus = (status) => {
            document.body.removeChild(dialog);
            delete window.updateStatus;
            delete window.cancelStatusUpdate;
            resolve(status);
        };

        window.cancelStatusUpdate = () => {
            document.body.removeChild(dialog);
            delete window.updateStatus;
            delete window.cancelStatusUpdate;
            resolve(null);
        };
    });
}




// Document Management
async function handleDocumentUpload(event) {
    event.preventDefault();
    
    if (!state.currentProperty) {
        showNotification('Please select a property first', 'error');
        return;
    }

    const formData = new FormData();
    const fileInput = document.getElementById('documentFile');
    const nameInput = document.getElementById('documentName');
    const typeInput = document.getElementById('documentType');
    
    if (!fileInput.files[0]) {
        showNotification('Please select a file to upload', 'error');
        return;
    }
    showLoader();
    try {
        // Add file and metadata to FormData
        formData.append('file', fileInput.files[0]);
        formData.append('name', nameInput.value);
        formData.append('type', typeInput.value); // <-- Save the selected document type
        formData.append('propertyId', state.currentProperty._id);

        const response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/documents`, {
            method: 'POST',
            body: formData // Don't set Content-Type header, let browser set it with boundary
        });

        if (!response.ok) throw new Error('Failed to upload document');
        
        await loadDocuments(state.currentProperty._id);
        closeModal('uploadDocumentModal');
        showNotification('Document uploaded successfully', 'success');
        event.target.reset();
    } catch (error) {
        console.error('Error uploading document:', error);
        showNotification('Error uploading document', 'error');
            } finally {
        hideLoader();
    }
}

async function loadDocuments(propertyId) {
    
    try {
        const response = await fetch(`${API_URL}/properties/${propertyId}/documents`);
        if (!response.ok) throw new Error('Failed to fetch documents');
        
        const documents = await response.json();
        state.documents = documents;
        console.log('Loaded documents:', state.documents);
        renderDocuments();
        updateTabCounts(); 
    } catch (error) {
        console.error('Error loading documents:', error);
        showNotification('Error loading documents', 'error');

    }
}

function renderDocuments() {
    const documentsGrid = document.getElementById('documentsGrid');
    
    if (!state.documents?.length) {
        documentsGrid.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-file"></i>
                <p>No documents found</p>
                <button onclick="openModal('uploadDocumentModal')" class="btn-primary">
                    Upload Your First Document
                </button>
            </div>`;
        return;
    }

    documentsGrid.innerHTML = state.documents.map(doc => `
        <div class="document-card">
            <div class="document-icon">
                <i class="fas fa-file-${getFileIcon(doc.name)}"></i>
            </div>
            <div class="document-info">
                <h3>${doc.name}</h3>
                <p>Type: ${doc.type}</p>
                <p>Added: ${new Date(doc.createdAt).toLocaleDateString()}</p>
            </div>
            <div class="document-actions">
                <button onclick="viewDocument('${doc._id}')" title="View">
                    <i class="fas fa-eye"></i> View
                </button>
                <button onclick="downloadDocument('${doc._id}')" title="Download">
                    <i class="fas fa-download"></i> Download
                </button>
                <button onclick="deleteDocument('${doc._id}')" class="delete-btn" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
}

// Helper function to determine file icon
function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    switch (ext) {
        case 'pdf': return 'pdf';
        case 'doc':
        case 'docx': return 'word';
        case 'jpg':
        case 'jpeg':
        case 'png': return 'image';
        default: return 'alt';
    }
}

// Document utility functions
async function viewDocument(documentId) {
    try {
        if (!state.currentProperty) {
            showNotification('Please select a property first', 'error');
            return;
        }

        const docFile = state.documents.find(d => d._id === documentId);
        if (!docFile) {
            throw new Error('Document not found in state');
        }

        // Check file type based on extension
        const fileExtension = docFile.name.split('.').pop().toLowerCase();
        const url = `${API_URL}/properties/${state.currentProperty._id}/documents/${documentId}/view`;

        if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) {
            // Show images in modal
            const modal = document.createElement('div');
            modal.className = 'modal image-viewer';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${docFile.name}</h3>
                        <button onclick="closeImageViewer(this)" class="btn-close">×</button>
                    </div>
                    <div class="modal-body">
                        <img src="${url}" alt="${docFile.name}" style="max-width: 100%; height: auto;">
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
        } else {
            // For PDFs and other docs, open the direct URL in a new tab
            window.open(url, '_blank');
        }
    } catch (error) {
        console.error('Error viewing document:', error);
        showNotification('Error viewing document', 'error');
    }
}




async function downloadDocument(docId) {
    showLoader();
    try {
        const doc = state.documents.find(d => d._id === docId);
        if (!doc) throw new Error('Document not found');

        // Construct the download URL (use the /view endpoint for inline, or create a /download endpoint for attachment)
        const url = `${API_URL}/properties/${state.currentProperty._id}/documents/${docId}/download`;

        // Fetch the file as a blob
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to download document');

        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = doc.name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(downloadUrl);
    } catch (error) {
        console.error('Error downloading document:', error);
        showNotification('Error downloading document', 'error');
           } finally {
        hideLoader(); 
    }
}

async function deleteDocument(docId) {
    if (!confirm('Are you sure you want to delete this document?')) {
        return;
    }
showLoader();
    try {
        const response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/documents/${docId}`, {
            method: 'DELETE'
        });

        if (!response.ok) throw new Error('Failed to delete document');
        
        await loadDocuments(state.currentProperty._id);
        showNotification('Document deleted successfully', 'success');
    } catch (error) {
        console.error('Error deleting document:', error);
        showNotification('Error deleting document', 'error');
            } finally {
        hideLoader();
    }
}


// Load payments when Payments tab is selected
async function loadPayments(propertyId) {

    try {
        const response = await fetch(`${API_URL}/properties/${propertyId}/payments`);
        if (!response.ok) throw new Error('Failed to fetch payments');
        state.payments = await response.json();
        renderPayments();
        updateTabCounts(); 
    } catch (error) {
        console.error('Error loading payments:', error);
        showNotification('Error loading payments', 'error');

    }
}

// Render payments list
function renderPayments() {
    const paymentsList = document.getElementById('paymentsList');
    if (!state.payments.length) {
        paymentsList.innerHTML = `<div class="empty-state"><i class="fas fa-money-check-alt"></i><p>No payments recorded</p></div>`;
        return;
    }
    paymentsList.innerHTML = `
        <table class="payments-table">
            <thead>
                <tr>
                    <th>Tenant</th>
                    <th>Unit #</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Method</th>
                    <th>Date</th>
                    <th>Late Fee</th>
                    <th>Balance</th>
                    <th>Receipt</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody>
                ${state.payments.map(payment => {
                    const tenant = state.tenants.find(t => t._id === payment.tenantId);
                    const unit = state.units.find(u => u._id === payment.unitId);
                    return `
                        <tr class="payment-row" onclick="editPayment('${payment._id}')">
                            <td>${tenant ? tenant.name : 'N/A'}</td>
                            <td>${unit ? unit.number : 'N/A'}</td>
                            <td>${payment.type === 'rent' ? 'Rent' : 'HUB'}</td>
                            <td>$${payment.amount.toFixed(2)}</td>
                            <td>${payment.method.charAt(0).toUpperCase() + payment.method.slice(1)}</td>
                            <td>${new Date(payment.date).toLocaleDateString()}</td>
                            <td>$${payment.lateFee?.toFixed(2) || '0.00'}</td>
                            <td>$${payment.balance?.toFixed(2) || '0.00'}</td>
                            <td>
                               <button class="btn-icon download-btn" title="Download Receipt" onclick="event.stopPropagation();exportReceipt('${payment._id}')">
                               <i class="fas fa-file-arrow-down"></i>
                                  </button>
                            </td>
                            <td>
                                <button class="btn-icon delete-btn" onclick="event.stopPropagation();deletePayment('${payment._id}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;
}

// Populate tenant select in payment modal
function populatePaymentTenantSelect() {
    const select = document.getElementById('paymentTenant');
    if (!select) return;
    select.innerHTML = `<option value="">Select Tenant</option>` +
        state.tenants.map(t => `<option value="${t._id}">${t.name}</option>`).join('');
}

function populatePaymentUnitSelect() {
    const select = document.getElementById('paymentUnit');
    if (!select) return;
    select.innerHTML = `<option value="">Select Unit</option>` +
        state.units.map(u => `<option value="${u._id}">Unit ${u.number}</option>`).join('');
}

// Auto-select assigned unit when tenant is selected in payment form
document.getElementById('paymentTenant')?.addEventListener('change', function() {
    const tenantId = this.value;
    const tenant = state.tenants.find(t => t._id === tenantId);
    if (!tenant) return;
    // Try to get the assigned unitId (could be object or string)
    const unitId = tenant.unitId?._id || tenant.unitId;
    if (unitId) {
        document.getElementById('paymentUnit').value = unitId;
    } else {
        document.getElementById('paymentUnit').value = '';
    }
});

// Auto-select assigned tenant when unit is selected in payment form
document.getElementById('paymentUnit')?.addEventListener('change', function() {
    const unitId = this.value;
    // Find the tenant assigned to this unit
    const tenant = state.tenants.find(t => {
        // t.unitId could be an object or a string
        const tUnitId = t.unitId?._id || t.unitId;
        return tUnitId === unitId;
    });
    if (tenant) {
        document.getElementById('paymentTenant').value = tenant._id;
    }
});



function editPayment(paymentId) {
    const payment = state.payments.find(p => p._id === paymentId);
    if (!payment) return showNotification('Payment not found', 'error');

    // Populate selects before setting values
    populatePaymentTenantSelect();
    populatePaymentUnitSelect();

    // Populate modal fields
    document.getElementById('paymentTenant').value = payment.tenantId;
    document.getElementById('paymentUnit').value = payment.unitId;
    document.getElementById('paymentType').value = payment.type;
    document.getElementById('paymentAmount').value = payment.amount;
    document.getElementById('paymentMethod').value = payment.method;
    document.getElementById('paymentDate').value = payment.date ? new Date(payment.date).toISOString().split('T')[0] : '';
    document.getElementById('paymentLateFee').value = payment.lateFee || 0;

    // Store edit mode and paymentId
    const form = document.getElementById('addPaymentForm');
    form.dataset.editMode = 'true';
    form.dataset.paymentId = paymentId;
    form.querySelector('button[type="submit"]').textContent = 'Update Payment';

    openModal('addPaymentModal');
}

// Handle add payment
async function handleAddPayment(event) {
    event.preventDefault();
    if (!state.currentProperty) {
        showNotification('Please select a property first', 'error');
        return;
    }
    const amount = Number(document.getElementById('paymentAmount').value);
    const lateFeePercent = Number(document.getElementById('paymentLateFee').value) || 0;
    const lateFee = amount * (lateFeePercent / 100);

    const paymentData = {
        tenantId: document.getElementById('paymentTenant').value,
        unitId: document.getElementById('paymentUnit').value,
        type: document.getElementById('paymentType').value,
        amount,
        method: document.getElementById('paymentMethod').value,
        date: document.getElementById('paymentDate').value,
        lateFee
    };

    const form = event.target;
    const isEdit = form.dataset.editMode === 'true';
    const paymentId = form.dataset.paymentId;
    showLoader();
    try {
        let response;
        if (isEdit && paymentId) {
            response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/payments/${paymentId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(paymentData)
            });
        } else {
            response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/payments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(paymentData)
            });
        }
        if (!response.ok) throw new Error('Failed to save payment');
        await loadPayments(state.currentProperty._id);
        closeModal('addPaymentModal');
        showNotification(isEdit ? 'Payment updated successfully' : 'Payment recorded successfully', 'success');
        event.target.reset();
        // Reset form mode
        form.dataset.editMode = 'false';
        form.dataset.paymentId = '';
        form.querySelector('button[type="submit"]').textContent = 'Save Payment';
    } catch (error) {
        console.error('Error saving payment:', error);
        showNotification('Error saving payment', 'error');
            } finally {
        hideLoader();
    }
}

async function deletePayment(paymentId) {
    if (!confirm('Are you sure you want to delete this payment?')) return;
    showLoader();
    try {
        const response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/payments/${paymentId}`, {
            method: 'DELETE'
        });
        if (!response.ok) throw new Error('Failed to delete payment');
        await loadPayments(state.currentProperty._id);
        showNotification('Payment deleted successfully', 'success');
    } catch (error) {
        console.error('Error deleting payment:', error);
        showNotification('Error deleting payment', 'error');
            } finally {
        hideLoader();
    }
}


// Export receipt (simple CSV for now)
function exportReceipt(paymentId) {
    const payment = state.payments.find(p => p._id === paymentId);
    if (!payment) return;
    const tenant = state.tenants.find(t => t._id === payment.tenantId);
    const unit = state.units.find(u => u._id === payment.unitId);

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Header
    doc.setFillColor(52, 152, 219); // #3498db
    doc.rect(0, 0, 210, 30, 'F');
    doc.setFontSize(22);
    doc.setTextColor(255, 255, 255);
    doc.text("Payment Receipt", 105, 18, { align: "center" });

    // Company/Property Info (customize as needed)
    doc.setFontSize(11);
    doc.setTextColor(255, 255, 255);
    doc.text("Property Management System", 105, 26, { align: "center" });

    // Main body
    let y = 40;
    doc.setFontSize(13);
    doc.setTextColor(44, 62, 80); // #2c3e50

    doc.setFont(undefined, 'bold');
    doc.text("Receipt Details", 14, y);
    doc.setFont(undefined, 'normal');
    y += 8;

    // Draw a light line
    doc.setDrawColor(230, 230, 230);
    doc.line(14, y, 196, y);
    y += 6;

    // Info rows
    const infoRows = [
        ["Tenant", tenant ? tenant.name : 'N/A'],
        ["Unit", unit ? unit.number : 'N/A'],
        ["Type", payment.type === 'rent' ? 'Rent' : 'HUB'],
        ["Amount", `$${payment.amount.toFixed(2)}`],
        ["Method", payment.method.charAt(0).toUpperCase() + payment.method.slice(1)],
        ["Date", new Date(payment.date).toLocaleDateString()],
        ["Late Fee", `$${payment.lateFee?.toFixed(2) || '0.00'}`],
        ["Balance", `$${payment.balance?.toFixed(2) || '0.00'}`]
    ];

    infoRows.forEach(([label, value]) => {
        doc.setFont(undefined, 'bold');
        doc.text(`${label}:`, 18, y);
        doc.setFont(undefined, 'normal');
        doc.text(`${value}`, 60, y);
        y += 9;
    });

    // Thank you section
    y += 8;
    doc.setDrawColor(52, 152, 219);
    doc.setLineWidth(0.7);
    doc.line(14, y, 196, y);
    y += 12;
    doc.setFontSize(12);
    doc.setTextColor(52, 152, 219);
    doc.setFont(undefined, 'bold');
    doc.text("Thank you for your payment!", 105, y, { align: "center" });

    // Footer
    y += 14;
    doc.setFontSize(10);
    doc.setTextColor(150, 150, 150);
    doc.setFont(undefined, 'normal');
    doc.text("Generated by Property Management System", 105, y, { align: "center" });

    // Download the PDF
    const filename = `receipt_${tenant ? tenant.name.replace(/\s+/g, '_') : paymentId}.pdf`;
    doc.save(filename);
}

function updatePropertyStats() {
    if (!state.currentProperty) return;

    const stats = {
        totalUnits: state.units.length,
        vacantUnits: state.units.filter(u => u.status === 'vacant').length,
        occupancyRate: calculateOccupancyRate(state.units)
    };

    document.getElementById('totalUnits').textContent = stats.totalUnits;
    document.getElementById('vacantUnits').textContent = stats.vacantUnits;
    document.getElementById('occupancyRate').textContent = stats.occupancyRate;

    // Calculate and display estimated monthly income for this property (including additional fees and pet fee)
    const activeTenants = (state.tenants || []).filter(
        t => t.leaseStatus !== 'terminated' && t.leaseStatus !== 'expired'
    );
    const propertyMonthlyIncome = activeTenants.reduce((sum, t) =>
        sum +
        (Number(t.baseRent) || 0) +
        (Number(t.waterFee) || 0) +
        (Number(t.trashFee) || 0) +
        (Number(t.adminFee) || 0) +
        (t.pets?.hasPets ? (Number(t.pets.fee) || 0) : 0)
    , 0);
    const incomeElem = document.getElementById('propertyMonthlyIncome');
    if (incomeElem) {
        incomeElem.textContent = `$${propertyMonthlyIncome.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    }
}

function calculateOccupancyRate(units) {
    if (!units?.length) return '0%';
    const occupiedUnits = units.filter(u => u.status === 'occupied').length;
    return `${Math.round((occupiedUnits / units.length) * 100)}%`;
}

function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}



function showLoader() {
    const loader = document.getElementById('loader');
    if (loader) loader.style.display = 'flex';
}
function hideLoader() {
    const loader = document.getElementById('loader');
    if (loader) loader.style.display = 'none';
}

// This is a completely rewritten approach to modal handling
function openModal(modalId) {
    // First verify the modal exists
    const modal = document.getElementById(modalId);
    if (!modal) {
        console.error(`Modal with ID "${modalId}" not found`);
        return;
    }
    
    console.log(`Opening modal: ${modalId}`);
    
    // Close all modals first
    document.querySelectorAll('.modal').forEach(m => {
        m.style.display = 'none';
    });
    
    // Make modal visible using basic display property
    modal.style.display = 'block';
    
    // Add event listener for clicks outside the modal content
    modal.onclick = function(event) {
        if (event.target === modal) {
            closeModal(modalId);
        }
    };
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
    }
}


async function loadAllUnitsAndTenants() {
    let allUnits = [];
    let allTenants = [];
    for (const property of state.properties) {
        // Fetch units
        try {
            const unitsRes = await fetch(`${API_URL}/properties/${property._id}/units`);
            if (unitsRes.ok) {
                const unitsData = await unitsRes.json();
                if (unitsData.property && Array.isArray(unitsData.property.units)) {
                    allUnits = allUnits.concat(unitsData.property.units);
                }
            }
        } catch (e) {
            console.error(`Error loading units for property ${property._id}:`, e);
        }
        // Fetch tenants
        try {
            const tenantsRes = await fetch(`${API_URL}/properties/${property._id}/tenants`);
            if (tenantsRes.ok) {
                const tenantsData = await tenantsRes.json();
                if (Array.isArray(tenantsData)) {
                    allTenants = allTenants.concat(tenantsData);
                }
            }
        } catch (e) {
            console.error(`Error loading tenants for property ${property._id}:`, e);
        }
    }
    state.allUnits = allUnits;
    state.allTenants = allTenants;
    renderMainSummary();
}

function renderMainSummary() {
    const totalProperties = state.properties.length;

    // Only count tenants that are not terminated or expired
    const activeTenants = (state.allTenants || []).filter(
        t => t.leaseStatus !== 'terminated' && t.leaseStatus !== 'expired'
    );

    // Only count units as occupied if they are assigned to an active tenant
    const activeTenantUnitIds = new Set(
        activeTenants.map(t => t.unitId?._id || t.unitId).filter(Boolean)
    );

    const totalUnits = state.allUnits ? state.allUnits.length : 0;
    const totalTenants = activeTenants.length;
    const totalOccupiedUnits = state.allUnits
        ? state.allUnits.filter(u => activeTenantUnitIds.has(u._id)).length
        : 0;
    // Calculate total monthly income including additional fees and pet fee
    const totalMonthlyIncome = activeTenants.reduce((sum, t) =>
        sum +
        (Number(t.baseRent) || 0) +
        (Number(t.waterFee) || 0) +
        (Number(t.trashFee) || 0) +
        (Number(t.adminFee) || 0) +
        (t.pets?.hasPets ? (Number(t.pets.fee) || 0) : 0)
    , 0);
    const occupancyRate = totalUnits > 0 ? Math.round((totalOccupiedUnits / totalUnits) * 100) : 0;

    document.getElementById('summaryTotalProperties').textContent = totalProperties;
    document.getElementById('summaryTotalUnits').textContent = totalUnits;
    document.getElementById('summaryTotalTenants').textContent = totalTenants;
    document.getElementById('summaryOccupancyRate').textContent = `${occupancyRate}%`;
    document.getElementById('summaryMonthlyIncome').textContent = `$${totalMonthlyIncome.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

    // Add/update total occupied units in summary if element exists
    let occupiedElem = document.getElementById('summaryTotalOccupiedUnits');
    if (!occupiedElem) {
        // Try to insert after total units card
        const summaryCards = document.querySelectorAll('.main-summary .summary-card');
        if (summaryCards.length >= 2) {
            occupiedElem = document.createElement('div');
            occupiedElem.className = 'summary-card';
            occupiedElem.innerHTML = `
                <h4>Total Units Occupied</h4>
                <p id="summaryTotalOccupiedUnits">${totalOccupiedUnits}</p>
            `;
            summaryCards[1].after(occupiedElem);
        }
    } else {
        occupiedElem.querySelector('p').textContent = totalOccupiedUnits;
    }
}


document.getElementById('mainSummaryToggle').addEventListener('click', function() {
    const section = document.querySelector('.main-summary-section');
    section.classList.toggle('collapsed');
});

// Export functions for global access
window.selectProperty = selectProperty;
window.openModal = openModal;
window.closeModal = closeModal;
window.editUnit = editUnit;
window.viewUnitDetails = viewUnitDetails;
window.editTenant = editTenant;
window.viewTenantDetails = viewTenantDetails;
window.updateMaintenanceStatus = updateMaintenanceStatus;
window.viewDocument = viewDocument;
window.downloadDocument = downloadDocument;
window.deleteDocument = deleteDocument;
window.deleteTenant = deleteTenant;
window.editPayment = editPayment;
window.deletePayment = deletePayment;


    </script>
</body>
</html>
