<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Management</title>
    <link href="https://fonts.googleapis.com/css?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
   <style>
    /* Base Styles */
:root {
    --primary-color: #2c3e50;
    --secondary-color: #34495e;
    --accent-color: #3498db;
    --background-color: #ffffff;
    --text-color: #2c3e50;
    --border-color: #dcdde1;
    --success-color: #27ae60;
    --warning-color: #f1c40f;
    --danger-color: #e74c3c;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* Body and container */
body {
    font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(120deg, #f7f7ff 0%, #e0ecff 100%);
    color: var(--text-color);
    min-height: 100vh;
    letter-spacing: 0.01em;
}

.container {
    background: transparent;
}


/* --- Modern Modal Styles (Apply Globally) --- */
.modal .modal-content {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 8px 32px rgba(44,62,80,0.13);
    padding: 14px 15px 14px 15px;
    max-width: 1100px;
    margin: -10px auto;
    position: relative;
    font-size: 0.85rem;
}

.modal h2 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 24px;
    letter-spacing: 0.5px;
    text-align: center;
}

.modal form .form-row {
    display: flex;
    gap: 18px;
    flex-wrap: wrap;
    margin-bottom: 0;
}

.modal form .form-group {
    flex: 1 1 70px;
    display: flex;
    flex-direction: column;
    margin-bottom: 18px;
}


.modal form .form-group label {
    font-weight: 600;
    margin-bottom: 7px;
    color: var(--primary-color, #2c3e50);
    font-size: 1.01rem;
    letter-spacing: 0.1px;
}

.modal form .form-group input,
.modal form .form-group select,
.modal form .form-group textarea,
.portfolio-maint-status-select {
    padding: 10px 12px;
    border-radius: 8px;
    border: 1.5px solid #e1e8ed;
    font-size: 0.8rem;
    background: #f9fafb;
    transition: border 0.2s;
    margin-bottom: 0px;
}

.modal form .form-group input:focus,
.modal form .form-group select:focus,
.modal form .form-group textarea:focus,
.portfolio-maint-status-select:focus {
    border-color: var(--accent-color, #3498db);
    outline: none;
}

.modal form textarea {
    min-height: 38px;
    resize: vertical;
}

.modal form .modal-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 14px;
    margin-top: 24px;
}

.modal form .btn-primary,
.modal form .btn-secondary {
    min-width: 120px;
    font-size: 1.07rem;
    font-weight: 600;
    padding: 11px 22px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: background 0.18s, color 0.18s;
}

.modal form .btn-primary {
    background: linear-gradient(90deg, #3498db 0%, #6dd5fa 100%);
    color: #fff;
}

.modal form .btn-primary:hover {
    background: linear-gradient(90deg, #217dbb 0%, #4fc3f7 100%);
}

.modal form .btn-secondary {
    background: #e1e8ed;
    color: #2980b9;
}

.modal form .btn-secondary:hover {
    background: #d0d7de;
    color: #217dbb;
}

@media (max-width: 900px) {
    .modal .modal-content {
        padding: 12px 4px 10px 4px;
        max-width: 99vw;
    }
    .modal form .form-row {
        
        gap: 8px;
    }
    .modal form .form-group {
        min-width: 0;
    }
    .modal form fieldset {
        padding: 10px 6px 6px 6px;
    }
}


/* Modern Property List Styles */
.property-item {
    background: white;
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 10px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.308);
    transition: all 0.3s ease;
    cursor: pointer;
    border: 2px solid transparent;
}

.property-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    border-color: var(--accent-color);
}

.property-item.active {
    border-color: var(--accent-color);
    background-color: rgba(52, 152, 219, 0.08);
    box-shadow: 0 4px 16px rgba(52, 152, 219, 0.10);
    transition: background 0.2s, box-shadow 0.2s, border-color 0.2s;
}

.property-item.active h3 {
    color: var(--accent-color);
}

.property-item h3 {
    margin: 0 0 8px 0;
    color: var(--primary-color);
    font-size: 1.1rem;
    font-weight: 500;
}

/* Inline edit styling for Expected rent in portfolio rent details */
.expected-rent-editing {
    background: #f0f7ff !important;
}

.property-item p {
    margin: 0 0 12px 0;
    color: var(--text-color);
    font-size: 0.9rem;
}

.property-badges {
    display: flex;
    gap: 8px;
    margin-top: 10px;
}

.property-type,
.property-status {
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 500;
}

.property-type {
    background-color: rgba(52, 152, 219, 0.15);
    color: var(--accent-color);
}

.property-status {
    background-color: rgba(46, 204, 113, 0.15);
    color: #27ae60;
}



.property-status {
    background-color: rgba(46, 204, 113, 0.15); /* default green */
    color: #27ae60;
}

.property-status.inactive {
    background-color: rgba(231, 76, 60, 0.15);
    color: #e74c3c;
}

.property-status.completed {
    background-color: rgba(46, 204, 113, 0.15); /* green */
    color: #27ae60;
}

.property-status.in-progress,
.property-status.inprogress,
.property-status.in\ progress {
    background-color: #fff3cd; /* yellow */
    color: #856404;
}

/* Slide-in notes drawer for Applications & Invites */
.notes-drawer {
    position: fixed;
    inset: 0;
    z-index: 1300;
    pointer-events: none;
}

.notes-drawer-overlay {
    position: absolute;
    inset: 0;
    background: rgba(15,23,42,0.30);
    opacity: 0;
    transition: opacity 0.2s ease-in-out;
}

.notes-drawer-panel {
    position: absolute;
    top: 0;
    right: 0;
    height: 100%;
    width: min(420px, 100%);
    background: linear-gradient(135deg, rgba(255,255,255,0.96), rgba(248,250,252,0.98));
    box-shadow: -10px 0 35px rgba(15,23,42,0.18);
    border-left: 1px solid rgba(148,163,184,0.35);
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.28s ease-in-out;
    backdrop-filter: blur(18px);
}

.notes-drawer-loader {
    position: absolute;
    inset: 0;
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(2px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 5;
}

.notes-drawer-loader-spinner {
    border: 5px solid #e5e7eb;
    border-top: 5px solid #3b82f6;
    border-radius: 50%;
    width: 34px;
    height: 34px;
    animation: spin 0.8s linear infinite;
}

.notes-drawer.open {
    pointer-events: auto;
}

.notes-drawer.open .notes-drawer-overlay {
    opacity: 1;
}

.notes-drawer.open .notes-drawer-panel {
    transform: translateX(0);
}

.notes-drawer-header {
    padding: 14px 18px 10px 18px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(226,232,240,0.9);
}

.notes-drawer-header h3 {
    margin: 0;
    font-size: 1.05rem;
    font-weight: 700;
    color: #0f172a;
}

.notes-drawer-header small {
    display: block;
    font-size: 0.8rem;
    color: #6b7280;
}

.notes-drawer-close {
    border: none;
    background: transparent;
    font-size: 1.3rem;
    cursor: pointer;
    color: #64748b;
}

.notes-drawer-body {
    flex: 1 1 auto;
    padding: 10px 16px 8px 16px;
    overflow-y: auto;
}

.notes-drawer-empty {
    text-align: center;
    padding: 20px 8px;
    font-size: 0.9rem;
    color: #9ca3af;
}

.notes-drawer-message {
    margin-bottom: 10px;
    display: flex;
}

.notes-drawer-bubble {
    max-width: 100%;
    padding: 8px 20px;
    border-radius: 10px;
    background: rgba(59,130,246,0.08);
    border: 1px solid rgba(147,197,253,0.7);
    color: #0f172a;
    font-size: 0.86rem;
    position: relative;
}

.notes-drawer-timestamp {
    display: block;
    margin-top: 4px;
    font-size: 0.75rem;
    color: #9ca3af;
}

.notes-drawer-delete {
    position: absolute;
    right: 4px;
    top: 33px;
    border: none;
    background: transparent;
    color: #9ca3af;
    cursor: pointer;
    font-size: 0.75rem;
    padding: 0;
}

.notes-drawer-delete:hover {
    color: #ef4444;
}

.notes-drawer-footer {
    padding: 10px 14px 12px 14px;
    border-top: 1px solid rgba(226,232,240,0.9);
    display: flex;
    gap: 8px;
}

.notes-drawer-footer input[type="text"] {
    flex: 1 1 auto;
    border-radius: 999px;
    border: 1px solid #d1d5db;
    padding: 8px 12px;
    font-size: 0.9rem;
}

.notes-drawer-footer button {
    border-radius: 999px;
    border: none;
    padding: 8px 14px;
    background: linear-gradient(90deg,#2563eb,#4f46e5);
    color: #fff;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
}


.property-address {
    display: flex;
    align-items: start;
    gap: 8px;
    margin: 8px 0 12px 0;
    color: var(--text-color);
    font-size: 0.9rem;
    line-height: 1.4;
}

.property-address i {
    color: var(--accent-color);
    margin-top: 3px;
}

/* Compact per-property stats (occupancy, vacancies) */
.property-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
    font-size: 0.78rem;
    color: #6b7280;
}

.property-stat {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 8px;
    border-radius: 999px;
    background: rgba(15, 23, 42, 0.03);
}

.property-stat i {
    color: var(--accent-color);
    font-size: 0.8rem;
}

/* Sidebar Styles */
.sidebar {
    width: 290px;
    background-color: white;
    border-right: 1px solid var(--border-color);
    box-shadow: 2px 0 16px 0 rgba(61,169,252,0.06);
    padding: 20px;
    height: 100vh;
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    overflow-y: auto;
    z-index: 100;
    transition: transform 0.3s cubic-bezier(.4,0,.2,1);
    scrollbar-width: none;
}



@media (max-width: 900px) {
  .sidebar {
    width: 100vw;
    max-width: 100vw;
    left: 0;
    right: 0;
    top: auto;
    bottom: 0;
    height: 50vh;
    max-height: 60vh;
    border-radius: 18px 18px 0 0;
    border-right: none;
    border-top: 2px solid var(--border-color);
    box-shadow: 0 -4px 24px rgba(44,62,80,0.13);
    transform: translateY(100%);
    transition: transform 0.35s cubic-bezier(.4,0,.2,1);
    padding-bottom: 32px;
  }
  .sidebar.visible {
    transform: translateY(0);
  }
}

.sidebar-header {
    position: sticky;
    top: -20px;
    z-index: 10;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 20px;
    background: #ffffff;
}

/* Main Content Styles */
.main-content {
    flex: 1;
    margin-left: 285px;
    padding: 10px;
    height: 100vh;
    overflow-y: auto;
    background: var(--background-color);
}

/* Dashboard Styles */
.dashboard-header {
    margin-bottom: 15px;
}

.stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Tabs Styles */
.tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 5px;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
    position: sticky;
    top: -21px;
    z-index: 10;
    background: var(--background-color);
    overflow: auto;
}

.tab-btn {
    padding: 10px 20px;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 16px;
    color: var(--text-color);
}

.tab-btn.active {
    color: var(--accent-color);
    border-bottom: 2px solid var(--accent-color);
}

.tab-count-badge {
    display: inline-block;
    background: #eaf6ff;
    color: #217dbb;
    font-weight: 600;
    border-radius: 12px;
    padding: 2px 8px;
    font-size: 0.95em;
    margin-left: 7px;
    min-width: 24px;
    text-align: center;
    border: 1.5px solid #2980b9;
    vertical-align: middle;
}

/* Top tools toolbar (maintenance + applications icons) */
.top-tools-bar {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 12px;
    padding: 13px 24px 13px 24px;
    margin: 0;
    border-radius: 18px;
   background: linear-gradient(90deg, #f7fbff 0%, #f7f7ff 100%);
    border-bottom: 2.5px solid var(--accent-color);
    box-shadow: 0 4px 24px rgba(61, 169, 252, 0.10);
    backdrop-filter: blur(10px);
}

.top-tools-item {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    border-radius: 999px;
    background: rgba(255,255,255,0.96);
    border: 1px solid #dbeafe;
    color: #0f172a;
    font-size: 0.9rem;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(15,23,42,0.12);
    transition: background 0.18s, box-shadow 0.18s, transform 0.12s, border-color 0.18s;
}

.top-tools-item i {
    font-size: 1.1rem;
}

.top-tools-item span {
    font-weight: 500;
}

.top-tools-item:hover {
    background: #eaf6ff;
    border-color: #93c5fd;
    box-shadow: 0 4px 14px rgba(59,130,246,0.35);
    transform: translateY(-1px);
}

.top-tools-count {
    min-width: 22px;
    height: 22px;
    border-radius: 999px;
    padding: 0 6px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 700;
    color: #ffffff;
}

.top-tools-count.maintenance {   
    background: #fdf8e9;
    color: #856404;
    font-weight: bold;
    border-radius: 50%;
    font-size: 0.95em;
    border: 1.5px solid #f1c40f;
    box-shadow: 0 0 8px 2px #ffe066;
    vertical-align: middle;
    animation: attentionPulse 1.2s infinite alternate;
}

.top-tools-count.applications {
    background: #e5edfa;
    color: #044785;
    font-weight: bold;
    border-radius: 50%;
    font-size: 0.95em;
    border: 1.5px solid #0f5ef1;
    box-shadow: 0 0 8px 2px #66b3ff;
    vertical-align: middle;
    animation: attentionPulse 1.2s infinite alternate;
}

@media (max-width: 768px) {
    /* On mobile, hide text labels but keep icons and counts visible */
    .top-tools-item span:not(.top-tools-count) {
        display: none;
    }

    .top-tools-bar {
        justify-content: flex-end;
        gap: 8px;
        padding: 6px 12px;
    }

    .top-tools-item {
        padding: 4px 8px;
        gap: 4px;
    }
}

/* Units Grid Styles */
.unit-card-modern {
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 2px 8px rgba(44,62,80,0.07);
    margin-bottom: 18px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    transition: box-shadow 0.2s, transform 0.2s;
    border: 1px solid #e1e8ed;
}
.unit-card-modern:hover {
    box-shadow: 0 6px 18px rgba(44,62,80,0.13);
    transform: translateY(-2px) scale(1.01);
}
.unit-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--primary-color);
    color: #fff;
    padding: 11px 22px;
    border-radius: 14px 14px 0 0;
}
.unit-card-header h3 {
    margin: 0;
    font-size: 1.18rem;
    font-weight: 700;
    letter-spacing: 0.2px;
}
.unit-card-body {
    padding: 18px 22px 10px 22px;
    background: #f8fafd;
}
.unit-info-row {
    display: flex;
    gap: 18px;
    flex-wrap: wrap;
    font-size: 1rem;
    margin-bottom: 10px;
    color: #2c3e50;
}
.unit-info-row span {
    display: flex;
    align-items: center;
    gap: 6px;
}
.unit-utilities-section {
    margin-top: 8px;
}
.unit-utilities-title {
    font-weight: 600;
    color: #2980b9;
    margin-bottom: 6px;
    font-size: 1.01rem;
    display: flex;
    align-items: center;
    gap: 7px;
}
.unit-utility-row {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.85rem;
    margin-bottom: 4px;
    padding-left: 2px;
}
.utility-label {
    min-width: 70px;
    font-weight: 500;
    color: #3498db;
}
.utility-account, .utility-provider, .utility-under {
    color: #555;
    font-size: 0.96em;
}
.badge {
    display: inline-block;
    padding: 3px 12px;
    border-radius: 12px;
    font-size: 0.92rem;
    font-weight: 500;
    margin-left: 6px;
}
.badge-success { background: #e1f7e1; color: #27ae60; }
.badge-warning { background: #fff3cd; color: #856404; }
.badge-danger { background: #ffe1e1; color: #d63031; }
.badge-default { background: #e0e0e0; color: #888; }
.rent-badge { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:12px; font-size:0.72rem; font-weight:600; letter-spacing:.5px; }
.rent-badge.due-soon { background:#fff3cd; color:#856404; }
.rent-badge.overdue { background:#ffe1e1; color:#b91c1c; }
.rent-badge.partial { background:#e0e7ff; color:#1e3a8a; }
.unit-card-actions {
    display: flex;
    gap: 10px;
    padding: 10px 22px 5px 22px;
    background: #f8fafd;
    border-top: 1px solid #e1e8ed;
    border-radius: 0 0 14px 14px;
    justify-content: flex-end;
}
.unit-card-actions .btn-secondary {
    background: #e1e8ed;
    color: #2980b9;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.15s, color 0.15s;
}
.unit-card-actions .btn-secondary:hover {
    background: #3498db;
    color: #fff;
}
.unit-card-actions .btn-icon.delete-btn {
    background: none;
    color: #d63031;
    font-size: 1.1rem;
    border: none;
    padding: 8px;
    border-radius: 50%;
    cursor: pointer;
    transition: background 0.15s;
}
.unit-card-actions .btn-icon.delete-btn:hover {
    background: #ffe1e1;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    z-index: 1000;
    overflow-y: auto; /* Enable scrolling on the modal overlay */
    padding: 20px;
    scrollbar-width: none;
}


.modal-content {
    background: white;
    width: 100%;
    scrollbar-width: none;
    margin: 20px auto;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    max-height: 98vh;
    overflow-y: auto;
}

.unit-details-modal .modal-body {
    max-height: 60vh;
    overflow-y: auto;
}

/* Add smooth scrolling to the page */
html {
    scroll-behavior: smooth;
}

/* Update detail group styles */
.detail-group {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

/* Form Styles */
.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

.form-group input {
    
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
}

/* Button Styles */
/* Modernized Button Styles - Keep Current Colors */
.btn-primary {
    background: linear-gradient(90deg, var(--accent-color) 0%, var(--secondary-color) 100%);
    color: #fff;
    border: none;
    padding: 11px 24px;
    border-radius: 8px;
    font-size: 0.80rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(52, 152, 219, 0.08);
    transition: background 0.18s, color 0.18s, box-shadow 0.18s, transform 0.1s;
}
.btn-primary:hover, .btn-primary:focus {
    background: linear-gradient(90deg, #232946 0%, #3da9fc 100%);
    color: #fff;
    box-shadow: 0 4px 16px rgba(61,169,252,0.15);
    transform: translateY(-2px) scale(1.03);
    outline: none;
}

.btn-secondary {
    background: var(--secondary-color);
    color: #fff;
    border: none;
    padding: 8px 15px;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.18s, color 0.18s, box-shadow 0.18s, transform 0.1s;
    margin-bottom: 10px;
}
.btn-secondary:hover, .btn-secondary:focus {
    background: #232e39;
    color: #fff;
    box-shadow: 0 2px 8px rgba(44, 62, 80, 0.10);
    transform: translateY(-1px) scale(1.02);
    outline: none;
}

/* Compact icon button for copy-link actions */
.icon-copy-btn {
    background: #f9fafb;
    color: #4b5563;
    border: 1px solid #e5e7eb;
    padding: 4px 7px;
    border-radius: 999px;
    font-size: 0.8rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    transition: background 0.18s, color 0.18s, border-color 0.18s, transform 0.1s, box-shadow 0.18s;
}
.icon-copy-btn i {
    font-size: 0.8rem;
}
.icon-copy-btn:hover,
.icon-copy-btn:focus {
    background: #eff6ff;
    color: #1d4ed8;
    border-color: #bfdbfe;
    box-shadow: 0 1px 4px rgba(37, 99, 235, 0.25);
    transform: translateY(-1px);
    outline: none;
}

/* Responsive Design */
@media (max-width: 768px) {
    .container {
        flex-direction: column;
    }

    .sidebar {
        width: 100%;
        height: auto;
    }

    .form-row {
        grid-template-columns: 1fr;
    }
}

.notification {
    position: fixed;
    top: 18px;
    right: 18px;
    max-width: 320px;
    padding: 12px 18px;
    border-radius: 10px;
    color: #f9fafb;
    font-weight: 500;
    font-size: 0.9rem;
    box-shadow: 0 14px 40px rgba(15,23,42,0.35);
    backdrop-filter: blur(10px);
    background: linear-gradient(135deg, rgba(15,23,42,0.92), rgba(30,64,175,0.92));
    display: flex;
    align-items: center;
    gap: 8px;
    transform: translateY(-150%);
    opacity: 0;
    transition: transform 0.28s ease, opacity 0.28s ease;
    z-index: 5002;
}

.notification.show {
    transform: translateY(0);
    opacity: 1;
}

.notification.success {
    background: linear-gradient(135deg, rgba(16,185,129,0.96), rgba(5,150,105,0.96));
}

.notification.error {
    background: linear-gradient(135deg, rgba(220,38,38,0.96), rgba(153,27,27,0.96));
}

.notification.info {
    background: linear-gradient(135deg, rgba(37,99,235,0.96), rgba(30,64,175,0.96));
}

/* Tab Pane Styles */
.tab-pane {
    display: none;
    padding: 5px 0;
}

.tab-pane.active {
    display: block;
}

/* Form Textarea */
textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    resize: vertical;
}

/* File Input Styling */
input[type="file"] {
    font-size: 0.9rem;
}

.maintenance-header, .units-header, .tenants-header, .documents-header, .payments-header {
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-color);
}

.maintenance-header h3 {
    margin: 0;
    color: var(--text-color);
    font-size: 1.1rem;
    font-weight: 500;
}

.priority-badge {
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.priority-badge.urgent {
    background-color: #ffe1e1;
    color: #d63031;
}

.priority-badge.high {
    background-color: #fff3cd;
    color: #856404;
}

.priority-badge.medium {
    background-color: #e1f7e1;
    color: #2ea12e;
}

.priority-badge.low {
    background-color: #e2e8f0;
    color: #64748b;
}

.maintenance-content {
    padding: 15px 20px;
}

.unit-info {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 10px 0;
    font-size: 0.9rem;
    color: var(--text-color);
}

.description {
    margin: 15px 0;
    color: var(--text-color);
    font-size: 0.9rem;
    line-height: 1.5;
}

.maintenance-footer {
    padding: 15px 20px;
    background: #f8f9fa;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.status-badge.pending {
    background-color: #fff3cd;
    color: #856404;
}

.status-badge.in-progress {
    background-color: #cce5ff;
    color: #004085;
}

.status-badge.completed {
    background-color: #e1f7e1;
    color: #2ea12e;
}

.maintenance-actions {
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Document Grid */
.documents-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 24px;
    padding: 20px 0;
}

.document-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(44, 62, 80, 0.07);
    padding: 22px 18px 16px 18px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    transition: box-shadow 0.2s, transform 0.2s;
    position: relative;
}

.document-card:hover {
    box-shadow: 0 6px 18px rgba(44, 62, 80, 0.13);
    transform: translateY(-2px) scale(1.01);
}

.document-icon {
    font-size: 2.5rem;
    color: var(--accent-color);
    margin-bottom: 12px;
    align-self: center;
}

.document-info h3 {
    font-size: 1.08rem;
    margin: 0 0 6px 0;
    color: var(--primary-color);
    font-weight: 600;
    word-break: break-all;
}

.document-info p {
    margin: 0 0 4px 0;
    font-size: 0.93rem;
    color: var(--text-color);
    opacity: 0.85;
}

.document-actions {
    display: flex;
    gap: 10px;
    margin-top: 16px;
    width: 100%;
    justify-content: flex-end;
}

.document-actions button {
    padding: 7px 14px;
    border-radius: 6px;
    font-size: 0.93rem;
    border: none;
    background: var(--background-color);
    color: var(--primary-color);
    cursor: pointer;
    transition: background 0.15s, color 0.15s;
    display: flex;
    align-items: center;
    gap: 6px;
}

.document-actions button:hover {
    background: var(--accent-color);
    color: #fff;
}

.document-actions .delete-btn {
    background: none;
    color: var(--danger-color);
    padding: 7px 10px;
}

.document-actions .delete-btn:hover {
    background: rgba(231, 76, 60, 0.08);
    color: #fff;
}

/* Add to your existing styles */
.unit-card .status {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    margin: 8px 0;
}

.unit-card.vacant .status {
    background-color: var(--warning-color);
    color: white;
}

.unit-card.occupied .status {
    background-color: var(--success-color);
    color: white;
}

.unit-card.maintenance .status {
    background-color: var(--danger-color);
    color: white;
}

.tab-badge {
    display: inline-block;
    background: #fff3cd;
    color: #856404;
    font-weight: bold;
    border-radius: 50%;
    padding: 2px 8px;
    font-size: 0.95em;
    margin-left: 8px;
    border: 1.5px solid #f1c40f;
    box-shadow: 0 0 8px 2px #ffe066;
    vertical-align: middle;
    animation: attentionPulse 1.2s infinite alternate;
}


/* Add these styles */
.unit-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.btn-icon {
    background: none;
    border: none;
    padding: 8px;
    cursor: pointer;
    border-radius: 50%;
    transition: background-color 0.2s;
}

.btn-icon:hover {
    background-color: rgba(0, 0, 0, 0.1);
}

.delete-btn {
    color: var(--danger-color);
}

.delete-btn:hover {
    background-color: rgba(220, 53, 69, 0.1);
}

/* Add to your existing styles */
.form-row input[type="date"] {
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    width: 100%;
}

.detail-group .lease-info {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 10px;
    align-items: center;
}

.lease-dates {
    color: var(--text-color);
    font-size: 0.9em;
}

.lease-status {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    background-color: var(--primary-color);
    color: white;
    display: inline-block;
    margin-left: 8px;
}

/* Lease Information Section Styles */
.form-row {
    display: flex;
    gap: 18px;
    flex-wrap: wrap;
}

.form-group {
    flex: 1 1 180px;
    display: flex;
    flex-direction: column;
    margin-bottom: 16px;
}

.form-group label {
    font-weight: 500;
    margin-bottom: 6px;
    color: var(--primary-color, #2c3e50);
}

.form-group input[type="number"],
.form-group input[type="date"],
.form-group select,
.form-group textarea {
    padding: 7px 10px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    font-size: 1rem;
    margin-bottom: 2px;
    background: #f9fafb;
    transition: border 0.2s;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    border-color: var(--accent-color, #3498db);
    outline: none;
}

#fmrSection,
#section8Section {
    background: #f6fafd;
    border: 1px solid #e1e8ed;
    border-radius: 8px;
    padding: 12px 14px;
    margin-bottom: 14px;
    margin-top: -6px;
}

#fmrSection label,
#section8Section label {
    margin-bottom: 4px;
    color: #2980b9;
    font-size: 0.97rem;
}

#section8Section {
    display: flex;
    gap: 18px;
    flex-wrap: wrap;
}

#section8Section .form-group {
    margin-bottom: 0;
}

.lease-badge {
    display: inline-block;
    padding: 3px 12px;
    border-radius: 12px;
    font-size: 0.92rem;
    font-weight: 500;
    background: #eaf6ff;
    color: #2980b9;
    margin-left: 6px;
}

.lease-badge.renew {
    background: #e1f7e1;
    color: #27ae60;
}

.lease-badge.terminate {
    background: #ffe1e1;
    color: #d63031;
}

/* Add to your existing styles */
.tenants-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    padding: 20px 0;
}

.tenant-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.tenant-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.tenant-card .tenant-header {
    padding: 10px;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    gap: 15px;
}

.tenant-avatar-small {
    width: 40px;
    height: 40px;
    background: var(--accent-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 18px;
    font-weight: 500;
}

.tenant-info {
    padding: 20px;
}

.tenant-info h3 {
    margin: 0;
    color: var(--text-color);
    font-size: 1.2rem;
}

.unit-info {
    margin: 10px 0;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.contact-info {
    margin: 15px 0;
    display: grid;
    gap: 8px;
}

.contact-info p {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-color);
    font-size: 0.9rem;
}

.tenant-status {
    display: inline-flex;
    align-items: center;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
    margin-top: 10px;
}

.tenant-status.active {
    background-color: #e1f7e1;
    color: #2ea12e;
}

.tenant-status.inactive {
    background-color: #ffe1e1;
    color: #d63031;
}

.tenant-actions {
    padding: 15px 20px;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    background: #f8f9fa;
}

.tenant-actions button {
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.9rem;
}

.tenant-lease-info {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid var(--border-color);
    font-size: 0.9rem;
    color: var(--text-color);
}


.tenant-section {
    margin-bottom: 14px;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
}
.tenant-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}
.tenant-section-title {
    font-weight: 600;
    color: var(--accent-color);
    margin-bottom: 6px;
    font-size: 1.02rem;
    display: flex;
    align-items: center;
    gap: 7px;
}
.tenant-detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.97rem;
    margin-bottom: 3px;
    gap: 10px;
}
.tenant-detail-row span {
    display: inline-block;
}
.tenant-detail-value {
    color: #888;
    font-size: 0.97rem;
}
.tenant-list {
    margin: 0 0 0 18px;
    padding: 0;
    font-size: 0.97rem;
}
.tenant-list li {
    margin-bottom: 2px;
}

/* Add these styles to your existing CSS */
.tenant-details-modal {
    
    border-radius: 12px;
    background: white;
    margin: 20px auto;
    
    display: flex;
    flex-direction: column;
    position: relative;
}

.tenant-details-header {
    position: sticky;
    top: 0;
    background: white;
    z-index: 1;
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    border-radius: 12px 12px 0 0;
}

.tenant-details-header h2 {
    margin: 0;
    color: var(--primary-color);
    font-size: 1.8rem;
}

.tenant-avatar {
    width: 60px;
    height: 60px;
    background: var(--accent-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
}

.tenant-details-content {
    padding: 20px;
    overflow-y: auto; /* Enable scrolling for content */
    flex: 1; /* Allow content to take remaining space */
}

.detail-group {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
}

.detail-group label {
    color: var(--primary-color);
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 12px;
    display: block;
}

.detail-group p {
    margin: 8px 0;
    font-size: 1rem;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 8px;
}

.lease-badge {
    display: inline-flex;
    align-items: center;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.lease-badge.active { background: #e1f7e1; color: #27ae60; }
.lease-badge.pending { background: #fff3cd; color: #856404; }
.lease-badge.expired { background: #ffe1e1; color: #d63031; }
.lease-badge.terminated { background: #e0e0e0; color: #888; }

.modal-footer {
    position: sticky;
    bottom: 0;
    background: white;
    padding: 20px;
    border-top: 1px solid var(--border-color);
    border-radius: 0 0 12px 12px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

/* Add styles for better mobile responsiveness */
@media (max-width: 768px) {
    .modal {
        padding: 10px;
    }
    
    .modal-content,
    .tenant-details-modal {
        width: 95%;
        margin: 10px auto;
    }
    
    .tenant-details-content {
        padding: 15px;
    }
}






.delete-btn {
    background: none;
    border: none;
    color: var(--danger-color);
    cursor: pointer;
    padding: 5px;
    transition: transform 0.2s ease;
}

.delete-btn:hover {
    transform: scale(1.1);
}



/* Add to your existing styles section */
.status-dialog .modal-content {
    max-width: 400px;
    padding: 25px;
    border-radius: 12px;
}

.status-dialog h3 {
    color: var(--primary-color);
    margin-bottom: 20px;
    font-size: 1.4rem;
    text-align: center;
}

.status-options {
    display: grid;
    gap: 12px;
    margin-bottom: 20px;
}

.status-option {
    padding: 15px;
    border: 2px solid var(--border-color);
    border-radius: 10px;
    background: white;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.2s ease;
}

.status-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.status-option.active {
    border-color: var(--accent-color);
    background-color: rgba(52, 152, 219, 0.05);
}

.status-option i {
    font-size: 1.2rem;
}

.status-option.pending {
    border-color: #f1c40f;
}

.status-option.in-progress {
    border-color: #3498db;
}

.status-option.completed {
    border-color: #2ecc71;
}

.status-option.pending:hover {
    background-color: rgba(241, 196, 15, 0.1);
}

.status-option.in-progress:hover {
    background-color: rgba(52, 152, 219, 0.1);
}

.status-option.completed:hover {
    background-color: rgba(46, 204, 113, 0.1);
}

.dialog-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

/* Add these styles to your CSS */
.image-viewer .modal-content {
    max-width: 90%;
    max-height: 90vh;
    margin: 20px auto;
    background: white;
    border-radius: 8px;
    overflow: hidden;
}

.image-viewer .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: var(--primary-color);
    color: white;
}

.image-viewer .modal-header h3 {
    margin: 0;
    font-size: 1.2rem;
}

.image-viewer .modal-body {
    padding: 20px;
    overflow: auto;
    text-align: center;
}

.btn-close {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 0 5px;
}

/* Make the pets checkbox and label inline */
.form-group > label > input[type="checkbox"] {
    display: inline-block;
    margin-right: 8px;
    vertical-align: middle;
}

.lease-holder-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
}
.lease-holder-row input {
    flex: 1;
    padding: 7px 10px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    font-size: 1rem;
    background: #f9fafb;
}
.lease-holder-remove {
    background: none;
    border: none;
    color: #d63031;
    font-size: 1.1rem;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 50%;
    transition: background 0.15s;
}
.lease-holder-remove:hover {
    background: #ffe1e1;
}

.btn-add-lease-holder {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(90deg, #3498db 0%, #6dd5fa 100%);
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 9px 20px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(52, 152, 219, 0.08);
    transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
    margin-bottom: 14px;
}
.btn-add-lease-holder i {
    font-size: 1.1em;
}
.btn-add-lease-holder:hover, .btn-add-lease-holder:focus {
    background: linear-gradient(90deg, #217dbb 0%, #4fc3f7 100%);
    box-shadow: 0 4px 16px rgba(52, 152, 219, 0.15);
    transform: translateY(-2px) scale(1.03);
    outline: none;
}


/* Modern Unit Details Modal Styles */
.unit-details-modal {
    
    border-radius: 14px;
    background: #fff;
    margin: 30px auto;
    box-shadow: 0 8px 32px rgba(44,62,80,0.13);
    overflow: hidden;
    font-size: 1rem;
}

.unit-details-modal .modal-header {
    background: linear-gradient(90deg, #edf5fa 0%, #6dd5fa 100%);
    color: #fff;
    padding: 24px 28px 18px 28px;
    border-radius: 14px 14px 0 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.unit-details-modal .modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: 0.5px;
}

.unit-details-modal .modal-body {
    padding: 28px 28px 10px 28px;
    background: #f8fafd;
}

.unit-details-modal .unit-section {
    margin-bottom: 22px;
    padding-bottom: 14px;
    border-bottom: 1px solid #e1e8ed;
}

.unit-details-modal .unit-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.unit-details-modal h3 {
    color: #2980b9;
    font-size: 1.13rem;
    margin-bottom: 10px;
    font-weight: 600;
    letter-spacing: 0.2px;
}

.unit-details-modal h4 {
    color: #3498db;
    font-size: 1.01rem;
    margin-bottom: 6px;
    font-weight: 500;
}

.utility-block {
    background: #fff;
    border-radius: 8px;
    padding: 14px 18px;
    margin-bottom: 12px;
    box-shadow: 0 1px 4px rgba(44,62,80,0.05);
    border: 1px solid #e1e8ed;
}

.utility-block div {
    font-size: 0.97rem;
    margin-bottom: 3px;
    color: #2c3e50;
}

.utility-block:last-child {
    margin-bottom: 0;
}



.unit-details-modal .modal-footer {
    background: #f8fafd;
    padding: 18px 28px;
    border-radius: 0 0 14px 14px;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    border-top: 1px solid #e1e8ed;
}

.unit-details-modal .btn-primary,
.unit-details-modal .btn-secondary {
    min-width: 120px;
    font-size: 1rem;
    font-weight: 600;
    padding: 10px 18px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: background 0.18s, color 0.18s;
}

.unit-details-modal .btn-primary {
    background: linear-gradient(90deg, #3498db 0%, #6dd5fa 100%);
    color: #fff;
}

.unit-details-modal .btn-primary:hover {
    background: linear-gradient(90deg, #217dbb 0%, #4fc3f7 100%);
}

.unit-details-modal .btn-secondary {
    background: #e1e8ed;
    color: #2980b9;
}

.unit-details-modal .btn-secondary:hover {
    background: #d0d7de;
    color: #217dbb;
}

.unit-details-modal .btn-close {
    background: none;
    border: none;
    color: #fff;
    font-size: 1.6rem;
    cursor: pointer;
    padding: 0 8px;
    transition: color 0.18s;
}

.unit-details-modal .btn-close:hover {
    color: #ffe1e1;
}

@media (max-width: 700px) {
    .unit-details-modal {
        max-width: 98vw !important;
        padding: 0;
    }
    .unit-details-modal .modal-header,
    .unit-details-modal .modal-body,
    .unit-details-modal .modal-footer {
        padding-left: 10px;
        padding-right: 10px;
    }
}


.unit-details-modal .unit-section {
    margin-bottom: 22px;
    padding-bottom: 12px;
    border-bottom: 1px solid #f0f0f0;
}
.unit-details-modal .unit-section:last-child {
    border-bottom: none;
}

.modal {
    z-index: 5000 !important;
}
.modal-content {
    z-index: 5001 !important;
    position: relative;
}

/* Compact, mobile-friendly modal layout */
@media (max-width: 700px) {
    .modal .modal-content {
        width: 94%;
        max-width: 94%;
        margin: 40px auto;
        padding: 16px 16px 18px 16px;
        font-size: 0.82rem;
    }
    .modal h2 {
        font-size: 1.4rem;
        margin-bottom: 14px;
    }
    .modal form .form-row {
        
        gap: 10px;
    }
    .modal form .form-group {
        margin-bottom: 10px;
    }
    .modal-content {
        max-height: 80vh;
        overflow-y: auto;
    }
}

.payments-table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 4px rgba(44,62,80,0.04);
    margin-top: 18px;
}
.payments-table th, .payments-table td {
    padding: 10px 12px;
    border-bottom: 1px solid #e1e8ed;
    text-align: left;
    font-size: 0.98rem;
}
.payments-table td.note-cell {
    white-space: normal;
    word-break: auto;
    max-width: 460px;
}
.payments-table th {
    background: #f6fafd;
    font-weight: 600;
    color: #2980b9;
}
.payments-table tr:last-child td {
    border-bottom: none;
}

.payment-row {
/* Link-style button for inline actions */
.link-button {
    background: none;
    border: none;
    padding: 0;
    margin: 0;
    color: #217dbb;
    text-decoration: underline;
    cursor: pointer;
    font: inherit;
}
.link-button:hover {
    color: #0b5cab;
}
    cursor: pointer;
    transition: background 0.18s, box-shadow 0.18s;
}

.payment-row:hover {
    background: #d6ecfc !important;
    box-shadow: 0 2px 8px rgba(52, 152, 219, 0.10);
}

.download-btn {
    color: #4e4e4e;
    background: none;
    border: none;
    font-size: 1.25rem;
    margin-right: 4px;
    transition: background 0.15s, color 0.15s;
}
.download-btn:hover {
    background: #eaf6ff;
    color: #217dbb;
}

/* Portfolio Overview Styles */
.portfolio-overview-section {
    margin-top: 16px;
}

.portfolio-overview-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 24px 12px 24px;
}

.portfolio-overview-header h2 {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--primary-color);
}

.portfolio-overview-layout {
    display: flex;
    align-items: flex-start;
    gap: 0px;
    padding-right: 0px;
}

.portfolio-overview-main {
    flex: 1 1 auto;
    min-width: 0;
}

.portfolio-strip {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    padding: 8px 24px 4px 24px;
    background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,250,252,0.9));
    border-radius: 16px;
    
}

.portfolio-chip {
    position: relative;
    background: linear-gradient(135deg, #ffffff, #f9fafb);
    border-radius: 14px;
    box-shadow: 0 1px 4px rgba(15,23,42,0.06);
    border: 1px solid rgba(226,232,240,0.9);
    padding: 10px 16px;
    min-width: 220px;
    flex: 1 1 100%;
    cursor: pointer;
    overflow: hidden;
    transition: box-shadow 0.18s ease, transform 0.18s ease, border-color 0.18s ease, background 0.18s ease;
}

.portfolio-chip:hover {
    box-shadow: 0 4px 18px rgba(15,23,42,0.16);
    transform: translateY(-1px);
}

.portfolio-chip::before {
    content: '';
    position: absolute;
    inset: 0;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
}

.portfolio-chip:hover::before {
    opacity: 1;
}

.portfolio-chip-label {
    font-size: 0.78rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: #6b7280;
    display: flex;
    align-items: center;
    gap: 6px;
}

.portfolio-chip-label i {
    color: #2563eb;
}

.portfolio-chip-value {
    margin-top: 4px;
    font-size: 1.25rem;
    font-weight: 700;
    color: #111827;
}

.portfolio-chip-sub {
    margin-top: 2px;
    font-size: 0.8rem;
    color: #6b7280;
}

.portfolio-chip.active {
    border-color: rgba(37,99,235,0.75);
    box-shadow: 0 2px 10px rgba(37,99,235,0.25);
    transform: translateY(-2px);
}

.portfolio-chip.active::before {
    opacity: 1;
}

.portfolio-progress {
    margin-top: 6px;
    width: 100%;
    height: 6px;
    border-radius: 999px;
    background: #e5e7eb;
    overflow: hidden;
}

.portfolio-progress-fill {
    height: 100%;
    border-radius: inherit;
    background: linear-gradient(90deg,#22c55e,#16a34a);
    width: 0;
    transition: width 0.25s ease-out;
}

.portfolio-badge-row {
    margin-top: 4px;
    display: flex;
    flex-wrap: wrap;
    gap: 4px 8px;
    font-size: 0.78rem;
}

.portfolio-badge {
    padding: 2px 8px;
    border-radius: 999px;
    background: #eef2ff;
    color: #4f46e5;
}

.portfolio-badge.warn {
    background: #fef3c7;
    color: #92400e;
}

/* Portfolio Applications & Invites type tags */
.portfolio-apps-tag-btn {
    border-radius: 999px;
    padding: 4px 14px;
    font-size: 0.8rem;
    border: 1px solid #d1d5db;
    background: #f3f4f6;
    color: #374151;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 1px 2px rgba(15,23,42,0.04);
    transition: background 0.18s ease, color 0.18s ease, box-shadow 0.18s ease, transform 0.1s ease;
}

.portfolio-apps-tag-btn:hover {
    background: #e5e7eb;
    box-shadow: 0 2px 4px rgba(15,23,42,0.08);
    transform: translateY(-1px);
}

.portfolio-apps-tag-btn.portfolio-apps-tag-active {
    background:  #ffffff;
    color: #3c3c3c;
    border-color: rgba(37,99,235,0.75);
    box-shadow: 0 4px 10px rgba(37,99,235,0.28);
}

.portfolio-badge.danger {
    background: #fee2e2;
    color: #b91c1c;
}

/* Responsive layout for portfolio strip: stack on mobile, 23 per row on tablets, 5 inline on desktop */
@media (min-width: 768px) {
    .portfolio-chip {
        flex: 1 1 calc(50% - 12px);
    }
}

@media (min-width: 1024px) {
    .portfolio-strip {
        justify-content: space-between;
    }
    .portfolio-chip {
        min-width: 0;
        flex: 1 1 calc(10% - 12px);
    }
}

.portfolio-details {
    padding: 0 24px 20px 24px;
    height: 580px;
    display: flex;
    flex-direction: column;
}

.portfolio-details-header {
    margin-bottom: 8px;
}

.portfolio-details-body {
    flex: 1 1 auto;
    min-height: 0;
    overflow-y: auto;
}

.portfolio-details-body table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.86rem;
}

.portfolio-details-body th,
.portfolio-details-body td {
    padding: 6px 8px;
    border-bottom: 1px solid rgba(226,232,240,0.8);
    text-align: left;
}

.portfolio-details-body th {
    font-weight: 600;
    color: #4b5563;
    background: rgba(248,250,252,0.8);
}

.portfolio-details-body tr:nth-child(even) td {
    background: rgba(249,250,251,0.6);
}

/* Ensure hover wins over zebra striping for all rows */
.portfolio-details-body tr:hover td {
    background: #e5f0ff !important;
}

/* Hover state for portfolio overview detail rows */
.portfolio-details-body tr:hover td {
    background: #e5f0ff;
}

.portfolio-tasks-sidebar {
    width: 240px;
    max-width: 300px;
    background: #ffffff;
    border-radius: 14px;
    box-shadow: 0 2px 10px rgba(15,23,42,0.08);
    border: 1px solid rgba(226,232,240,0.9);
    padding: 10px 12px 12px;
    height: 650px;
    display: flex;
    flex-direction: column;
}

/* Stack portfolio overview and tasks panel on small screens */
@media (max-width: 767px) {
    .portfolio-overview-layout {
        flex-direction: column;
        padding-right: 0;
    }
    .portfolio-overview-main,
    .portfolio-tasks-sidebar {
        width: 100%;
        max-width: 100%;
    }
    .portfolio-tasks-sidebar {
        height: auto;
        margin: 8px 16px 0 16px;
    }
    .portfolio-strip {
        padding-left: 16px;
        padding-right: 16px;
    }
}

.portfolio-tasks-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 8px;
}

.portfolio-tasks-header h3 {
    margin: 0;
    font-size: 0.95rem;
    color: #111827;
}

.portfolio-tasks-new {
    display: flex;
    gap: 6px;
    margin-bottom: 8px;
}

.portfolio-tasks-new input[type="text"] {
    flex: 1 1 auto;
    min-width: 0;
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid #d1d5db;
    font-size: 0.82rem;
}

.portfolio-tasks-new button {
    border-radius: 10px;
    border: none;
    padding: 4px 10px;
    font-size: 0.8rem;
    background: var(--secondary-color);
    color: #ffffff;
    cursor: pointer;
}

.portfolio-tasks-list {
    flex: 1 1 auto;
    min-height: 0;
    overflow-y: auto;
}

.portfolio-task-item {
    display: flex;
    align-items: flex-start;
    gap: 6px;
    padding: 4px 2px;
    border-bottom: 1px solid rgba(229,231,235,0.7);
    cursor: pointer;
    border-radius: 6px;
    transition: background-color 0.12s ease;
}

.portfolio-task-item:hover {
    background-color: #e5f0ff;
}

.portfolio-task-main {
    flex: 1 1 auto;
    min-width: 0;
}

.portfolio-task-title {
    font-size: 0.82rem;
    color: #111827;
}

.portfolio-task-meta {
    font-size: 0.7rem;
    color: #6b7280;
}

.portfolio-task-actions {
    display: flex;
    align-items: center;
    gap: 4px;
}

.portfolio-task-delete {
    background: none;
    border: none;
    color: #9ca3af;
    cursor: pointer;
    padding: 0;
}

.portfolio-task-delete:hover {
    color: #ef4444;
}

.portfolio-details {
    padding: 0 24px 20px 24px;
}

.portfolio-details-header {
    margin-bottom: 8px;
}

.portfolio-details-body table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.86rem;
}

.portfolio-details-body th,
.portfolio-details-body td {
    padding: 6px 8px;
    border-bottom: 1px solid rgba(226,232,240,0.8);
    text-align: left;
}

.portfolio-details-body th {
    font-weight: 600;
    color: #4b5563;
    background: rgba(248,250,252,0.8);
}

.portfolio-details-body tr:nth-child(even) td {
    background: rgba(249,250,251,0.6);
}

.summary-card {
    background: linear-gradient(120deg, #fff 70%, #eaf6ff 100%);
    border-radius: 16px;
    box-shadow: 0 2px 12px rgba(61,169,252,0.09);
    padding: 28px 38px;
    min-width: 140px;
    flex: 1 1 180px;
    text-align: center;
    border: 2px solid var(--border-color);
    transition: box-shadow 0.18s, border 0.18s, background 0.18s;
    margin-bottom: 0;
    position: relative;
    z-index: 1;
}

.summary-card h4 {
    margin: 0 0 10px 0;
    color: var(--accent-color);
    font-size: 1.13rem;
    font-weight: 700;
    letter-spacing: 0.2px;
    text-shadow: 0 1px 0 #fff;
}

.summary-card p {
    margin: 0;
    font-size: 1.65rem;
    font-weight: 900;
    color: var(--primary-color);
    letter-spacing: 0.7px;
    text-shadow: 0 1px 0 #fff;
}

.summary-card:hover {
    box-shadow: 0 6px 24px rgba(61,169,252,0.13);
    border-color: var(--accent-color);
    background: linear-gradient(120deg, hsl(200, 100%, 99%) 0%, #eaf6ff 100%);
}

@media (max-width: 900px) {
    .main-summary-header,
    .main-summary {
        padding-left: 10px;
        padding-right: 10px;
    }
    .main-summary {
        
        gap: 14px;
        padding: 14px 8px 0 8px;
    }
}  

.sidebar .btn-primary {
    margin-left: 60px;
        margin-top: 18px;
    margin-bottom: 10px;
}

/* Modern style for the sidebar Properties heading */
.sidebar-header h2 {
    font-size: 1.45rem;
    font-weight: 800;
    
    letter-spacing: 0.5px;
    margin-bottom: 0px;
    display: flex;
    align-items: center;
    gap: 10px;
    background: linear-gradient(90deg, #eaf6ff 0%, #f6fafd 100%);
    padding: 12px 18px;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(52,152,219,0.07);
    margin-left: 30px;
}


/* Responsive adjustments for mobile devices */
@media (max-width: 900px) {
  .container {
    flex-direction: column;
    height: auto;
  }

  .main-content {
    margin-left: 0;
    padding: 25px 4px;
    height: auto;
    min-height: 70vh;
  }
  .main-summary-header,
  .main-summary {
    padding-left: 8px;
    padding-right: 8px;
  }
  .summary-card {
    padding: 12px 8px;
  }
  .units-grid,
  .documents-grid,
  .tenants-list {
    grid-template-columns: 1fr !important;
    gap: 12px !important;
    padding: 0 !important;
  }
  .tab-btn {
    font-size: 15px;
    padding: 8px 8px;
  }
  .tab-count-badge {
    min-width: 18px;
    font-size: 0.9em;
    padding: 2px 6px;
  }
  .modal-content,
  .tenant-details-modal,
  .unit-details-modal {
    width: 98vw !important;
    max-width: 98vw !important;
    margin: 8px auto !important;
    padding: 10px 4px !important;
    border-radius: 10px !important;
  }
  .modal-header,
  .modal-body,
  .modal-footer {
    padding-left: 8px !important;
    padding-right: 8px !important;
  }
  .form-row {
    
    gap: 8px !important;
    display: flex !important;
  }
  .form-group {
    min-width: 0 !important;
    margin-bottom: 12px !important;
  }
  .payments-table th,
  .payments-table td {
    padding: 7px 4px;
    font-size: 0.95rem;
  }
  .payments-table {
    font-size: 0.95rem;
    overflow-x: auto;
    display: block;
  }
  .payments-table thead,
  .payments-table tbody,
  .payments-table tr {
   
    width: 100%;
    table-layout: auto;
  }
  .payments-table {
    width: 100%;
    min-width: 600px;
  }
  .sidebar-header h2 {
    font-size: 1.1rem;
    padding: 8px 10px;
    margin-left: 0;
  }

   .payments-header {
    display: inline !important;
}
}

/* Extra small devices */
@media (max-width: 500px) {
  .sidebar-header h2 {
    font-size: 1rem;
    padding: 6px 6px;
  }
  .btn-primary,
  .btn-secondary {
    font-size: 0.97rem;
    padding: 8px 12px;
    min-width: 90px;
  }
  .modal-content,
  .tenant-details-modal,
  .unit-details-modal {
    padding: 4px 2px !important;
  }
  .main-summary-header,
  .main-summary {
    padding-left: 2px;
    padding-right: 2px;
  }
}


/* Remove old horizontal slide for mobile, now handled above */

/* Overlay for sidebar on mobile */
#sidebarOverlay {
    display: none;
    position: fixed;
    z-index: 99;
    left: 0; top: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.25);
}

/* Show overlay when sidebar is visible */
.sidebar.visible ~ #sidebarOverlay {
    display: block;
}


/* Sidebar toggle tab for mobile (bottom center) */
@media (max-width: 900px) {
  #sidebarToggleBtn {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    top: auto;
    width: 100vw;
    transform: none;
    z-index: 120;
    background: linear-gradient(90deg, #2c3e50 0%, #2c3e50 100%);
    color: #fff;
    border: none;
    border-radius: 18px 18px 0 0;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    box-shadow: 0 2px 8px rgba(44,62,80,0.13);
    cursor: pointer;
    transition: background 0.18s;
    font-weight: 600;
    letter-spacing: 0.5px;
    gap: 12px;
    border-bottom: 2px solid #e0e0e0;
  }
  #sidebarToggleBtn i {
    font-size: 1.3em;
  }
  #sidebarToggleBtn:hover {
    background: #217dbb;
  }
}

/* Hide toggle button on desktop */
@media (min-width: 901px) {
    #sidebarToggleBtn, #sidebarOverlay {
        display: none !important;
    }
    .sidebar {
        transform: none !important;
        position: fixed;
    }
}
/* Always show overlay when sidebar is visible on mobile */
@media (max-width: 900px) {
  #sidebarOverlay {
    display: none;
  }
  .sidebar.visible + #sidebarOverlay {
    display: block;
  }
}



#addUnitModal .form-group label {
    font-weight: 600;
    margin-bottom: 7px;
    color: var(--primary-color, #2c3e50);
    font-size: 1.01rem;
    letter-spacing: 0.1px;
}

#addUnitModal .form-group label > input[type="checkbox"] {
    margin-right: 7px;
    vertical-align: middle;
}

#unitAmenitiesChecklist {
    display: flex;
    flex-wrap: wrap;
    gap: 14px 22px;
    background: #f8fafd;
    border-radius: 8px;
    padding: 12px 10px 6px 10px;
    margin-top: 2px;
    margin-bottom: 2px;
    border: 1px solid #e1e8ed;
    font-size: 0.99em;
}

#unitAmenitiesChecklist label {
    font-weight: 500;
    color: #2980b9;
    margin-bottom: 0;
    cursor: pointer;
    user-select: none;
    transition: color 0.15s;
}

#unitAmenitiesChecklist label:hover {
    color: #217dbb;
}


/* Stat cards */
.stat-card, .summary-card {
    background: linear-gradient(120deg, #fff 70%, #f6fbff 100%);
    border-radius: 16px;
    border: 1.5px solid var(--border-color);
    box-shadow: 0 2px 12px rgba(61,169,252,0.07);
    transition: box-shadow 0.2s, border 0.2s;
}
.stat-card h3, .summary-card h4 {
    color: var(--accent-color);
    font-weight: 700;
    letter-spacing: 0.2px;
}
.stat-card p, .summary-card p {
    color: var(--primary-color);
    font-size: 1.5rem;
    font-weight: 800;
}


/* Avatars */
.tenant-avatar, .tenant-avatar-small {
    background: var(--accent-color);
    color: #fff;
    font-weight: 700;
    border: 2.5px solid #fff;
    box-shadow: 0 2px 8px rgba(61,169,252,0.10);
}




.unit-card-header h3 {
    margin: 0;
    font-size: 1.22rem;
    font-weight: 800;
    letter-spacing: 0.3px;
    color: #fff;
    text-shadow: 0 1px 4px rgba(44,62,80,0.10);
}

.unit-card-header .badge {
    margin-left: 18px;
    font-size: 0.85rem;
    font-weight: 600;
    border-radius: 12px;
    padding: 5px 16px;
    background: rgba(255,255,255,0.13);
    color: #fff;
    border: 1.5px solid #fff;
    box-shadow: 0 1px 4px rgba(61,169,252,0.07);
}

.tenant-tabs {
    display: flex;
    margin-top: 20px;
    gap: 0;
    margin-bottom: 18px;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(44,62,80,0.07);
    background: #f8fafd;
    border: 1.5px solid #e1e8ed;
}




@media (max-width: 600px) {
    .tenant-tabs {
        flex-direction: column;
        box-shadow: none;
        border-radius: 8px;
    }
    .tenant-tab-btn {
        border-right: none;
        border-bottom: 1px solid #e1e8ed;
        padding: 12px 0;
        font-size: 1rem;
    }
    .tenant-tab-btn:last-child {
        border-bottom: none;
    }
}

/* maintenance tabs */
.maintenance-tabs {
    display: flex;
    margin-top: 20px;
    gap: 0;
    margin-bottom: 18px;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(44,62,80,0.07);
    background: #f8fafd;
    border: 1.5px solid #e1e8ed;
}

.maintenance-tab-btn,.tenant-tab-btn {
    flex: 1 1 0;
    padding: 10px 0;
    font-size: 0.90rem;
    font-weight: 600;
    border: none;
    background: none;
    color: #2980b9;
    cursor: pointer;
    transition: background 0.18s, color 0.18s;
    outline: none;
    border-right: 1px solid #e1e8ed;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}
.maintenance-tab-btn:last-child {
    border-right: none;
}
.maintenance-tab-btn.active,.tenant-tab-btn.active {
    background: linear-gradient(90deg, #2c3e50 0%, #2c3e50 100%);
    color: #fff;
    box-shadow: 0 2px 8px rgba(52,152,219,0.10);
    z-index: 1;
}
.maintenance-tab-btn:not(.active):hover,.tenant-tab-btn:not(.active):hover {
    background: #eaf6ff;
    color: #217dbb;
}

@media (max-width: 600px) {
    .maintenance-tabs {
        flex-direction: column;
        box-shadow: none;
        border-radius: 8px;
    }
    .maintenance-tab-btn,.tenant-tab-btn {
        border-right: none;
        border-bottom: 1px solid #e1e8ed;
        padding: 12px 0;
        font-size: 1rem;
    }
    .maintenance-tab-btn:last-child,.tenant-tab-btn:last-child {
        border-bottom: none;
    }
}


/* add dropdown styling */
.new-dropdown .dropdown-menu {
  animation: fadeIn 0.18s;
}

.new-dropdown .dropdown-item {
  transition: background 0.18s, color 0.18s;
}

.new-dropdown .dropdown-item:hover,
.new-dropdown .dropdown-item:focus {
  background: #eaf6ff !important;
  color: #217dbb !important;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-8px);}
  to { opacity: 1; transform: translateY(0);}
}


.maintenance-table tbody tr {
  transition: background 0.18s, box-shadow 0.18s;
  cursor: pointer;
}
.maintenance-table tbody tr:hover {
  background: #eaf6ff;
  box-shadow: 0 2px 8px rgba(52,152,219,0.10);
}

/* Inline edit styles for applications/invites/portfolio tables */
tr[data-app-id][data-editing="true"],
tr[data-invite-id][data-editing="true"],
tr[data-tenant-id][data-editing="true"],
tr[data-maint-id][data-editing="true"] {
    background: #f0f7ff !important;
    box-shadow: 0 0 0 1px rgba(37,99,235,0.25);
}

.app-inline-input {
    width: 100%;
    box-sizing: border-box;
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    font-size: 0.9rem;
    background: #ffffff;
}

.app-inline-input:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 1px rgba(37,99,235,0.25);
}

.app-inline-save,
.app-inline-cancel {
    font-size: 0.85rem;
    padding: 6px 10px;
}

/* Highlighted maintenance row/card when jumping from global list */
.maintenance-highlight {
    animation: maintenanceHighlightPulse 1.4s ease-out 1;
    box-shadow: 0 0 0 2px #2563eb, 0 4px 12px rgba(37,99,235,0.35) !important;
}

@keyframes maintenanceHighlightPulse {
    0% { background-color: #eff6ff; }
    50% { background-color: #dbeafe; }
    100% { background-color: #ffffff; }
}

/* Highlighted application row when jumping from global list */
.application-highlight {
    animation: maintenanceHighlightPulse 1.4s ease-out 1;
    box-shadow: 0 0 0 2px #10b981, 0 4px 12px rgba(16,185,129,0.35) !important;
}



        /* Checklist row hover */
        #moveInChecklistModal ul li {
            padding: 4px 4px;
            border-radius: 6px;
            transition: background-color 0.12s ease;
        }
        #moveInChecklistModal ul li:hover {
            background-color: #eaeef7 !important;
        }

        /* "+ note" chip */
        #moveInChecklistModal .movein-note-toggle {
            opacity: 0;
            border-radius: 999px;
            padding: 2px 8px;
            border: 1px solid #bfdbfe;
            background-color: #eff6ff;
            color: #2563eb !important;
            font-size: 0.78rem;
            font-weight: 500;
            line-height: 1.2;
            transition: opacity 0.15s ease, background-color 0.15s ease, color 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
        }
        #moveInChecklistModal li:hover .movein-note-toggle,
        #moveInChecklistModal .movein-note-toggle:focus-visible {
            opacity: 1;
            background-color: #dbeafe !important;
            border-color: #3b82f6;
            color: #1d4ed8 !important;
            box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.15);
        }

        /* Note input text color */
        #moveInChecklistModal .movein-check-note {
            color: #2563eb;
        }
        #moveInChecklistModal .movein-check-note::placeholder {
            color: #60a5fa;
        }
   </style>
</head>
<body>



<!-- Sidebar toggle tab for mobile (bottom center) -->
<button id="sidebarToggleBtn" aria-label="Open sidebar">
    <i class="fas fa-chevron-up"></i>
    <span style="font-size:1.05em;">Properties</span>
</button>


    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            
            <div class="sidebar-header">
                <h2> Bluerain</h2>
                <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-start;">
                    <button class="btn-primary" onclick="window.location.href='/'">
                        <i class="fas fa-home"></i> Home
                    </button>
                </div>
            </div>
            <div class="property-list" id="propertyList">
                <!-- Properties will be listed here -->
            </div>
        </aside>
               <div id="sidebarOverlay"></div>


        
        <!-- Main Content -->
        <main class="main-content">

            <!-- Global quick tools bar (always visible) -->
            <div class="top-tools-bar">
                    <div class="top-tools-item" id="topToolMaintenance" title="View all maintenance requests">
                        <i class="fas fa-tools"></i>
                        <span>Maintenance</span>
                        <span class="top-tools-count maintenance" id="topMaintenanceCount">0</span>
                    </div>
                    <div class="top-tools-item" id="topToolApplications" title="View rental applications">
                        <i class="fas fa-file-alt"></i>
                        <span>Applications</span>
                        <span class="top-tools-count applications" id="topApplicationsCount">0</span>
                    </div>
                </div>


            <!-- Portfolio Overview main section (hidden by default) -->
            <section id="portfolioOverviewSection" class="portfolio-overview-section" style="display:none;">
                <div class="portfolio-overview-header">
                    <h2><i class="fas fa-chart-pie" style="margin-right:6px;"></i>Portfolio Overview</h2>
                </div>
                <div class="portfolio-overview-layout">
                    <div class="portfolio-overview-main">
                        <div class="portfolio-strip">
                            <div class="portfolio-chip" id="portfolioCardLeases">
                                <div class="portfolio-chip-label"><i class="fas fa-hourglass-half"></i>Leases & Move-ins (60 Days)</div>
                                <div class="portfolio-chip-value" id="portfolioExpiringLeasesCount">--</div>
                                <div class="portfolio-chip-sub" id="portfolioExpiringLeasesBreakdown">Expiring leases & upcoming move-ins</div>
                            </div>
                            <div class="portfolio-chip" id="portfolioCardTenants">
                                <div class="portfolio-chip-label"><i class="fas fa-users"></i>Tenants</div>
                                <div class="portfolio-chip-value" id="portfolioTenantsCount">--</div>
                                <div class="portfolio-chip-sub" id="portfolioTenantsSummary">Portfolio-wide tenants overview</div>
                            </div>
                            <div class="portfolio-chip" id="portfolioCardMaintenance">
                                <div class="portfolio-chip-label"><i class="fas fa-tools"></i>Open Maintenance</div>
                                <div class="portfolio-chip-value" id="portfolioOpenMaintenanceCount">--</div>
                                <div class="portfolio-chip-sub">Pending & in-progress across all properties</div>
                                <div class="portfolio-badge-row" id="portfolioMaintenanceBreakdown"></div>
                            </div>
                            <div class="portfolio-chip" id="portfolioCardApplications">
                                <div class="portfolio-chip-label"><i class="fas fa-file-signature"></i>Applications & Invites</div>
                                <div class="portfolio-chip-value" id="portfolioApplicationsCount">--</div>
                                <div class="portfolio-chip-sub" id="portfolioApplicationsSummary">Pending applications & recent invites</div>
                            </div>
                            <div class="portfolio-chip" id="portfolioCardRent">
                                <div class="portfolio-chip-label" style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                                    <span><i class="fas fa-money-check-alt"></i>Coming Rent</span>
                                </div>
                                <div class="portfolio-chip-value" id="portfolioOpenRentAmount">$--</div>
                                <div class="portfolio-chip-sub" id="portfolioTotalRentSummary">Estimated monthly income: $--</div>
                                <div class="portfolio-chip-sub" id="portfolioOpenRentCount">-- tenants with balance</div>
                                <div class="portfolio-chip-sub" id="portfolioRentCollectedSummary">&nbsp;</div>
                                <div class="portfolio-progress">
                                    <div class="portfolio-progress-fill" id="portfolioRentCollectedBar"></div>
                                </div>
                            </div>
                            <div class="portfolio-chip" id="portfolioCardVacancy">
                                <div class="portfolio-chip-label"><i class="fas fa-door-open"></i>Vacant Units</div>
                                <div class="portfolio-chip-value" id="portfolioVacantUnitsCount">--</div>
                                <div class="portfolio-chip-sub" id="portfolioVacancySummary">Across all properties</div>
                                <div class="portfolio-progress">
                                    <div class="portfolio-progress-fill" id="portfolioOccupancyBar"></div>
                                </div>
                            </div>
                        </div>
                        <div class="portfolio-details" id="portfolioDetails" style="margin-top:16px;">
                            <div class="portfolio-details-header">
                                <h3 id="portfolioDetailsTitle" style="margin:0;font-size:15px;color:#2c3e50;">Details</h3>
                            </div>
                            <div class="portfolio-details-body" id="portfolioDetailsBody"></div>
                        </div>
                    </div>
                    <aside class="portfolio-tasks-sidebar" id="portfolioTasksSidebar">
                        <div class="portfolio-tasks-header">
                            <h3>Tasks</h3>
                        </div>
                        <form class="portfolio-tasks-new" id="portfolioTaskForm">
                            <input type="text" id="portfolioTaskTitleInput" placeholder="Add a task..." autocomplete="off" />
                            <button type="submit">Add</button>
                        </form>
                        <div class="portfolio-tasks-list" id="portfolioTasksList"></div>
                    </aside>
                </div>
            </section>


            <!-- Property Dashboard -->
            <div class="dashboard" id="propertyDashboard">
                <div class="dashboard-header">
                    <h1 id="propertyName">Select a Property</h1>
                    <div class="stats-container">
                        <div class="stat-card">
                            <h3>Occupancy Rate</h3>
                            <p id="occupancyRate">--%</p>
                        </div>
                        <div class="stat-card">
                            <h3>Total Units</h3>
                            <p id="totalUnits">--</p>
                        </div>
                        <div class="stat-card">
                            <h3>Vacant Units</h3>
                            <p id="vacantUnits">--</p>
                        </div>
                        <div class="stat-card">
                          <h3>Est. Monthly Income</h3>
                          <p id="propertyMonthlyIncome">$--</p>
                          </div>
                    </div>
                </div>



                
                <!-- Tabs -->
<div class="tabs">
    <button class="tab-btn active" data-tab="units">
        Units <span class="tab-count-badge" id="tabCountUnits"></span>
    </button>
    <button class="tab-btn" data-tab="tenants">
        Tenants <span class="tab-count-badge" id="tabCountTenants"></span>
    </button>
    <button class="tab-btn" data-tab="maintenance">
        Maintenance
        <span id="maintenancePendingBadge" class="tab-badge" style="display:none;">!</span>
    </button>
    <button class="tab-btn" data-tab="documents">
        Documents <span class="tab-count-badge" id="tabCountDocuments"></span>
    </button>
    <button class="tab-btn" data-tab="payments">
        Payments <span class="tab-count-badge" id="tabCountPayments"></span>
    </button>
    <button class="tab-btn" data-tab="applications">
        Applications <span class="tab-count-badge" id="tabCountApplications"></span>
    </button>
</div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Units Tab -->
                    <div class="tab-pane active" id="units">
                        <div class="units-header">
                            <h2>Units</h2>
                            <button class="btn-secondary" id="addUnitBtn">+ Add Unit</button>
                        </div>
                        <div class="units-grid" id="unitsGrid"></div>
                    </div>

                    <!-- Tenants Tab -->
<div class="tab-pane" id="tenants">
    <div class="tenants-header">
        <h2>Tenants</h2>
        <button class="btn-secondary" id="addTenantBtn">+ Add Tenant</button>
    </div>
<div class="tenant-tabs">
    <button class="tenant-tab-btn active" id="activeTenantsTab">
        <i class="fas fa-user-check"></i> Active Tenants
    </button>
    <button class="tenant-tab-btn" id="inactiveTenantsTab">
        <i class="fas fa-user-slash"></i> Inactive Tenants
    </button>
</div>
    <div class="tenants-list" id="tenantsList"></div>
</div>

                    <!-- Maintenance Tab -->
<div class="tab-pane" id="maintenance">
<div class="maintenance-header">
  <h2>Maintenance</h2>


<div class="dropdown new-dropdown" style="position: relative; display: inline-block;">
  <button class="btn-secondary" id="newMaintenanceDropdownBtn" style="display:flex;align-items:center;gap:8px;">
    <i class="fas fa-plus"></i> New <i class="fas fa-caret-down"></i>
  </button>
  <div id="newMaintenanceDropdownMenu" class="dropdown-menu" style="display:none;position:absolute;top:110%;right:0;min-width:180px;background:#fff;border-radius:10px;box-shadow:0 2px 12px rgba(44,62,80,0.13);border:1.5px solid #e1e8ed;z-index:100;">
    <button class="dropdown-item" id="addScheduleBtn" style="width:100%;padding:12px 18px;border:none;background:none;text-align:left;font-size:1.07rem;color:#2980b9;cursor:pointer;">
      <i class="fas fa-sync-alt"></i> Create Schedule
    </button>
    <button class="dropdown-item" id="addMaintenanceBtn" style="width:100%;padding:12px 18px;border:none;background:none;text-align:left;font-size:1.07rem;color:#2980b9;cursor:pointer;">
      <i class="fas fa-tools"></i> New Request
    </button>
  </div>
</div>
  </div>
<div class="maintenance-tabs">
    <button class="maintenance-tab-btn active" id="maintenanceRequestsTab">
        <i class="fas fa-tools"></i> Maintenance Requests
    </button>
    <button class="maintenance-tab-btn" id="recurringMaintenanceTab">
        <i class="fas fa-sync-alt"></i> Recurring Maintenance
    </button> 
</div>


<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
  <button id="toggleScheduleViewBtn" class="btn-secondary" style="display:flex;align-items:center;gap:8px;size:0.75em;">
    <i id="scheduleViewIcon" class="fas fa-list"></i>
    <span id="scheduleViewLabel">List View</span>
  </button>
  <span id="toggleCalendarIcon"
        title="Show calendar"
        style="display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:50%;background:#eaf6ff;cursor:pointer;font-size:1.25em;transition:background 0.18s;">
    <i class="fas fa-calendar-alt"></i>
  </span>
</div>


  <div id="recurringCalendarContainer" style="margin:24px 0;display:none;">
  <h3 style="margin-bottom:12px;color:#217dbb;"><i class="fas fa-calendar-alt"></i> Recurring Maintenance Calendar</h3>
  <div id="recurringCalendarFull" style="background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(44,62,80,0.07);padding:0;overflow-x:auto;"></div>
</div>
  <div class="maintenance-list" id="scheduleList" style="display:none;"></div>
  <div class="maintenance-list" id="maintenanceList"></div>
</div>



                    <!-- Documents Tab -->
                    <div class="tab-pane" id="documents">
                        <div class="documents-header">
                            <h2>Documents</h2>
                            <button class="btn-secondary" id="uploadDocumentBtn">+ Upload Document</button>
                        </div>
                        <div class="documents-grid" id="documentsGrid"></div>
                    </div>

                    <!-- Applications Tab -->
                    <div class="tab-pane" id="applications">
                        <div class="maintenance-tabs" id="applicationsSubtabs">
                            <button class="maintenance-tab-btn active applications-tab-btn" data-subtab="applications">
                                <i class="fas fa-file-alt"></i> Applications
                            </button>
                            <button class="maintenance-tab-btn applications-tab-btn" data-subtab="invites">
                                <i class="fas fa-paper-plane"></i> Invites
                            </button>
                        </div>

                        <div id="applicationsPane-applications">
                            <div id="applicationsFilterBar" style="margin: 9px 0;border-radius:12px;padding:0px;display:flex;flex-wrap:wrap;gap:0px;align-items:flex-start;position:relative;">
                                <div style="position:relative;flex:1 1 100%;min-width:280px;display:flex;align-items:center;gap:6px;justify-content:flex-start;">
                                    <i class="fas fa-magnifying-glass" style="color:#6b7280;margin-left:6px;"></i>
                                    <input id="applicationsSearchBar" type="text" placeholder="Search applications by" title="Try: name:, email:, phone:, property:, unit:, status:, movein:, submitted:" style="flex:0 1 390px;max-width:300px;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;background:#fff;font-size:0.95rem;" />
                                    <button class="btn-secondary" id="clearApplicationsFiltersBtn" title="Clear search" style="margin-right:6px;padding:6px 10px;font-size:0.9rem;">Clear</button>
                                </div>
                                <div id="applicationsActiveFilterChips" style="display:flex;flex-wrap:wrap;gap:6px;margin:6px 8px 0 36px;flex:1 1 100%;"></div>
                                <div id="applicationsSearchSuggestions" style="position:absolute;top:50px;left:10px;right:auto;min-width:280px;max-width:520px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 12px 32px rgba(0,0,0,0.15);padding:4px 0;display:none;z-index:1000;max-height:300px;overflow:auto;">
                                    <div id="applicationsSuggestHeader" style="padding:8px 12px;font-size:.9em;color:#374151;border-bottom:1px solid #eef2f7;display:flex;justify-content:space-between;align-items:center;">
                                        <span id="applicationsSuggestTitle">Choose a filter</span>
                                        <button id="applicationsSuggestBack" style="display:none;background:transparent;border:none;color:#217dbb;cursor:pointer;font-weight:600;">Back</button>
                                    </div>
                                    <ul id="applicationsSuggestList" style="list-style:none;margin:0;padding:4px 0;"></ul>
                                    <ul id="applicationsSuggestValues" style="list-style:none;margin:0;padding:4px 0;display:none;"></ul>
                                    <div style="border-top:1px solid #eef2f7;margin-top:4px;padding:8px 12px;font-size:.85em;color:#6b7280;"></div>
                                </div>
                            </div>
                            <div class="payments-header">
                                <h2>Applications</h2>
                                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                                    <button class="btn-secondary" id="sendApplicationBtn">Send Application</button>
                                    <button class="btn-secondary" id="refreshApplicationsBtn">Refresh</button>
                                    <div id="applicationsActionsWrapper" style="display:none;position:relative;">
                                        <button class="btn-secondary" id="applicationsActionsBtn">Actions </button>
                                        <div id="applicationsActionsMenu" style="position:absolute;top:110%;right:0;background:#ffffff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 10px 30px rgba(15,23,42,0.18);padding:6px 0;min-width:140px;display:none;z-index:1000;">
                                            <button id="editApplicationBtn" style="display:block;width:100%;padding:6px 14px;text-align:left;background:none;border:none;font-size:0.9rem;color:#111827;cursor:pointer;">
                                                Edit
                                            </button>
                                            <button id="deleteApplicationBtn" style="display:block;width:100%;padding:6px 14px;text-align:left;background:none;border:none;font-size:0.9rem;color:#b91c1c;cursor:pointer;">
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="applicationsList" class="maintenance-list" style="margin-top:10px;"></div>
                        </div>

                        <div id="applicationsPane-invites" style="display:none;">
                            <div id="invitesFilterBar" style="margin: 9px 0;border-radius:12px;padding:0px;display:flex;flex-wrap:wrap;gap:0px;align-items:flex-start;position:relative;">
                                <div style="position:relative;flex:1 1 100%;min-width:280px;display:flex;align-items:center;gap:6px;justify-content:flex-start;">
                                    <i class="fas fa-magnifying-glass" style="color:#6b7280;margin-left:6px;"></i>
                                    <input id="invitesSearchBar" type="text" placeholder="Search invites by" title="Try: name:, email:, property:, unit:, status:, sent:, opened:, openedcount:" style="flex:0 1 390px;max-width:300px;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;background:#fff;font-size:0.95rem;" />
                                    <button class="btn-secondary" id="clearInvitesFiltersBtn" title="Clear search" style="margin-right:6px;padding:6px 10px;font-size:0.9rem;">Clear</button>
                                </div>
                                <div id="invitesActiveFilterChips" style="display:flex;flex-wrap:wrap;gap:6px;margin:6px 8px 0 36px;flex:1 1 100%;"></div>
                                <div id="invitesSearchSuggestions" style="position:absolute;top:50px;left:10px;right:auto;min-width:280px;max-width:520px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 12px 32px rgba(0,0,0,0.15);padding:4px 0;display:none;z-index:1000;max-height:300px;overflow:auto;">
                                    <div id="invitesSuggestHeader" style="padding:8px 12px;font-size:.9em;color:#374151;border-bottom:1px solid #eef2f7;display:flex;justify-content:space-between;align-items:center;">
                                        <span id="invitesSuggestTitle">Choose a filter</span>
                                        <button id="invitesSuggestBack" style="display:none;background:transparent;border:none;color:#217dbb;cursor:pointer;font-weight:600;">Back</button>
                                    </div>
                                    <ul id="invitesSuggestList" style="list-style:none;margin:0;padding:4px 0;"></ul>
                                    <ul id="invitesSuggestValues" style="list-style:none;margin:0;padding:4px 0;display:none;"></ul>
                                    <div style="border-top:1px solid #eef2f7;margin-top:4px;padding:8px 12px;font-size:.85em;color:#6b7280;"></div>
                                </div>
                            </div>
                            <div class="payments-header">
                                <h2>Invites</h2>
                                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                                    <button class="btn-secondary" id="refreshInvitesBtn">Refresh</button>
                                    <div id="invitesActionsWrapper" style="display:none;position:relative;">
                                        <button class="btn-secondary" id="invitesActionsBtn">Actions </button>
                                        <div id="invitesActionsMenu" style="position:absolute;top:110%;right:0;background:#ffffff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 10px 30px rgba(15,23,42,0.18);padding:6px 0;min-width:140px;display:none;z-index:1000;">
                                            <button id="editInviteBtn" style="display:block;width:100%;padding:6px 14px;text-align:left;background:none;border:none;font-size:0.9rem;color:#111827;cursor:pointer;">
                                                Edit
                                            </button>
                                            <button id="deleteInviteBtn" style="display:block;width:100%;padding:6px 14px;text-align:left;background:none;border:none;font-size:0.9rem;color:#b91c1c;cursor:pointer;">
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="invitesList" class="maintenance-list" style="margin-top:10px;"></div>
                        </div>
                    </div>

                    <!-- Payments Tab -->
<div class="tab-pane" id="payments">
    <div class="payments-header">
        <h2>Payments</h2>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <button class="btn-secondary" id="addPaymentBtn">+ Record Payment</button>
            <button class="btn-secondary" id="editMonthChargesBtn" title="Edit expected rent and late fee for a month"> Edit Month Charges</button>
        </div>
    </div>
    <div id="paymentsFilterBar" style="margin-top: 9px;border-radius:12px;padding:0px;display:flex;flex-wrap:wrap;gap:0px;align-items:flex-start;position:relative;">
        <div style="position:relative;flex:1 1 100%;min-width:280px;display:flex;align-items:center;gap:6px;justify-content:flex-start;">
            <i class="fas fa-magnifying-glass" style="color:#6b7280;margin-left:6px;"></i>
            <input id="paymentSearchBar" type="text" placeholder="Search payments by" title="Type to search. Supported tokens: tenant:, unit:, type:, method:, apply:, date:, amount:, note:" style="flex:0 1 390px;max-width:300px;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;background:#fff;font-size:0.95rem;" />
            <button class="btn-secondary" id="clearPaymentFiltersBtn" title="Clear search" style="margin-right:6px;padding:6px 10px;font-size:0.9rem;">Clear</button>
        </div>
        <div id="activeFilterChips" style="display:flex;flex-wrap:wrap;gap:6px;margin:6px 8px 0 36px;flex:1 1 100%;"></div>
        <div id="paymentSearchSuggestions" style="position:absolute;top:50px;left:10px;right:auto;min-width:280px;max-width:520px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 12px 32px rgba(0,0,0,0.15);padding:4px 0;display:none;z-index:1000;max-height:300px;overflow:auto;">
            <div id="paymentSuggestHeader" style="padding:8px 12px;font-size:.9em;color:#374151;border-bottom:1px solid #eef2f7;display:flex;justify-content:space-between;align-items:center;">
                <span id="paymentSuggestTitle">Choose a filter</span>
                <button id="paymentSuggestBack" style="display:none;background:transparent;border:none;color:#217dbb;cursor:pointer;font-weight:600;">Back</button>
            </div>
            <ul id="paymentSuggestList" style="list-style:none;margin:0;padding:4px 0;"></ul>
            <ul id="paymentSuggestValues" style="list-style:none;margin:0;padding:4px 0;display:none;"></ul>
            <div style="border-top:1px solid #eef2f7;margin-top:4px;padding:8px 12px;font-size:.85em;color:#6b7280;"></div>
        </div>
    </div>
    <div class="payments-list" id="paymentsList">
        <!-- Payments will be listed here -->
    </div>
</div>
                </div>
            </div>
        </main>
    </div>




 

    <!-- ===================== MODALS (ONE OF EACH, OUTSIDE MAIN CONTENT) ===================== -->
    
        <!-- Edit Monthly Charges Modal -->
        <div class="modal" id="editMonthChargesModal" style="display:none;">
            <div class="modal-content" style="max-width:560px;">
                <h2>Edit Monthly Charges</h2>
                <form id="editMonthChargesForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editChargesTenant">Tenant</label>
                            <select id="editChargesTenant" required></select>
                        </div>
                        <div class="form-group">
                            <label for="editChargesMonth">Month</label>
                            <input type="month" id="editChargesMonth" required />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editChargesExpected">Expected Rent (override)</label>
                            <input type="number" id="editChargesExpected" step="0.01" min="0" placeholder="Leave blank to use auto" />
                        </div>
                        <div class="form-group">
                            <label for="editChargesLateFee">Late Fee</label>
                            <input type="number" id="editChargesLateFee" step="0.01" min="0" placeholder="Leave blank for none" />
                            <div style="margin-top:6px">
                              <label for="editChargesLateFeeMode" style="font-size:.85em;color:#6b7280">Mode</label>
                              <select id="editChargesLateFeeMode">
                                <option value="amount">Amount ($)</option>
                                <option value="percent">Percent (%)</option>
                              </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="btn-secondary" id="clearMonthChargesBtn">Remove Override</button>
                        <button type="submit" class="btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>



<!-- Add Unit Modal -->
<div class="modal" id="addUnitModal">
    <div class="modal-content">
        <h2>Add/Edit Unit</h2>
        <form id="addUnitForm">
            <div class="form-row">
                <div class="form-group">
                    <label>Unit Number</label>
                    <input type="text" id="unitNumber" required>
                </div>
                <div class="form-group">
                    <label>Floor</label>
                    <input type="number" id="unitFloor" min="1" value="1" required>
                </div>
                <div class="form-group">
                    <label>Square Feet</label>
                    <input type="number" id="unitSqft" min="0">
                </div>
                <div class="form-group">
                    <label>Rent (Monthly)</label>
                    <input type="number" id="unitRent" min="0" step="0.01">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex: 1 1 100%;">
                    <label>Unit Amenities & Features</label>
                    <div id="unitAmenitiesChecklist" style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <label><input type="checkbox" name="amenities" value="washerDryer"> Washer & Dryer</label>
                        <label><input type="checkbox" name="amenities" value="washerDryerHookup"> Washer/Dryer Hookup</label>
                        <label><input type="checkbox" name="amenities" value="centralAC"> Central AC/Heat</label>
                        <label><input type="checkbox" name="amenities" value="miniSplit"> Mini Split AC</label>
                        <label><input type="checkbox" name="amenities" value="windowUnit"> Window AC Unit</label>
                        <label><input type="checkbox" name="amenities" value="dishwasher"> Dishwasher</label>
                        <label><input type="checkbox" name="amenities" value="refrigerator"> Refrigerator</label>
                        <label><input type="checkbox" name="amenities" value="stoveOven"> Stove/Oven</label>
                        <label><input type="checkbox" name="amenities" value="microwave"> Microwave</label>
                        <label><input type="checkbox" name="amenities" value="garbageDisposal"> Garbage Disposal</label>
                        <label><input type="checkbox" name="amenities" value="balcony"> Balcony/Patio</label>
                        <label><input type="checkbox" name="amenities" value="walkInCloset"> Walk-in Closet</label>
                        <label><input type="checkbox" name="amenities" value="ceilingFan"> Ceiling Fan</label>
                        <label><input type="checkbox" name="amenities" value="hardwoodFloor"> Hardwood Floor</label>
                        <label><input type="checkbox" name="amenities" value="tileFloor"> Tile Floor</label>
                        <label><input type="checkbox" name="amenities" value="carpetFloor"> Carpet Floor</label>
                        <label><input type="checkbox" name="amenities" value="fireplace"> Fireplace</label>
                        <label><input type="checkbox" name="amenities" value="privateEntrance"> Private Entrance</label>
                        <label><input type="checkbox" name="amenities" value="storageUnit"> Storage Unit</label>
                        <label><input type="checkbox" name="amenities" value="garage"> Garage</label>
                        <label><input type="checkbox" name="amenities" value="coveredParking"> Covered Parking</label>
                        <label><input type="checkbox" name="amenities" value="securitySystem"> Security System</label>
                        <label><input type="checkbox" name="amenities" value="internetReady"> Internet Ready</label>
                        <label><input type="checkbox" name="amenities" value="cableReady"> Cable Ready</label>
                        <label><input type="checkbox" name="amenities" value="furnished"> Furnished</label>
                        <label><input type="checkbox" name="amenities" value="petFriendly"> Pet Friendly</label>
                        <label><input type="checkbox" name="amenities" value="smokeFree"> Smoke Free</label>
                        <label><input type="checkbox" name="amenities" value="wheelchairAccessible"> Wheelchair Accessible</label>
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Bedrooms</label>
                    <input type="number" id="unitBedrooms" min="0" required>
                </div>
                <div class="form-group">
                    <label>Bathrooms</label>
                    <input type="number" id="unitBathrooms" min="0" required>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="unitStatus" required>
                        <option value="vacant">Vacant</option>
                        <option value="occupied">Occupied</option>
                        <option value="maintenance">Maintenance</option>
                    </select>
                </div>
            </div>
            <h3>Utility Accounts</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Water Account #</label>
                    <input type="text" id="waterAccountNumber">
                    <label>Provider</label>
                    <input type="text" id="waterProvider">
                    <label>Status</label>
                    <select id="waterStatus">
                        <option value="">Select</option>
                        <option value="active">Active</option>
                        <option value="disconnected">Disconnected</option>
                    </select>
                    <label>Bill Under</label>
                    <select id="waterUnder">
                        <option value="">Select</option>
                        <option value="tenant">Tenant</option>
                        <option value="landlord">Landlord</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Gas Account #</label>
                    <input type="text" id="gasAccountNumber">
                    <label>Provider</label>
                    <input type="text" id="gasProvider">
                    <label>Status</label>
                    <select id="gasStatus">
                        <option value="">Select</option>
                        <option value="active">Active</option>
                        <option value="disconnected">Disconnected</option>
                    </select>
                    <label>Bill Under</label>
                    <select id="gasUnder">
                        <option value="">Select</option>
                        <option value="tenant">Tenant</option>
                        <option value="landlord">Landlord</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Electricity Account #</label>
                    <input type="text" id="electricityAccountNumber">
                    <label>Provider</label>
                    <input type="text" id="electricityProvider">
                    <label>Status</label>
                    <select id="electricityStatus">
                        <option value="">Select</option>
                        <option value="active">Active</option>
                        <option value="disconnected">Disconnected</option>
                    </select>
                    <label>Bill Under</label>
                    <select id="electricityUnder">
                        <option value="">Select</option>
                        <option value="tenant">Tenant</option>
                        <option value="landlord">Landlord</option>
                    </select>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn-secondary" onclick="closeModal('addUnitModal')">Cancel</button>
                <button type="submit" class="btn-primary">Add Unit</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Tenant Modal -->
<div class="modal" id="addTenantModal">
<div class="modal-content">
    <h2>Add/Edit Tenant</h2>
    <form id="addTenantForm">
        <!-- Row 1: Name, Phone, Email -->
        <div class="form-row">
            <div class="form-group">
                <label>Tenant Name</label>
                <input type="text" id="tenantName" required>
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="tenantPhone" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="tenantEmail" required>
            </div>
        </div>
        <!-- Lease Holders -->
        <div class="form-group">
            <label>Lease Holders</label>
            <div id="leaseHoldersList"></div>
            <button type="button" class="btn-add-lease-holder" onclick="addLeaseHolderField()">
                <i class="fas fa-user-plus"></i> Add Lease Holder
            </button>
        </div>
        <!-- Row 2: Lease Dates -->
        <div class="form-row">
            <div class="form-group">
                <label>Lease Start</label>
                <input type="date" id="leaseStart" required>
            </div>
            <div class="form-group">
                <label>Lease End</label>
                <input type="date" id="leaseEnd" required>
            </div>
        </div>
        <!-- Row 3: Rent & Fees -->
        <div class="form-row">
                <div class="form-group">
             <label>Deposit ($)</label>
             <input type="number" id="deposit" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Base Rent ($)</label>
                <input type="number" id="baseRent" min="0" required>
            </div>
            <div class="form-group">
                <label>Water Fee ($)</label>
                <input type="number" id="waterFee" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Trash Fee ($)</label>
                <input type="number" id="trashFee" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Admin Fee ($)</label>
                <input type="number" id="adminFee" min="0" step="0.01">
            </div>
            <!-- In the Row 3: Rent & Fees section of your tenant form -->
<div class="form-group">
    <label>Additional Fee Type</label>
    <select id="additionalFeeType">
        <option value="">None</option>
        <option value="parking">Parking</option>
        <option value="storage">Storage</option>
        <option value="other">Other</option>
    </select>
</div>
<div class="form-group" id="additionalFeeLabelGroup" style="display:none;">
    <label>Other Fee Label</label>
    <input type="text" id="additionalFeeLabel" placeholder="Describe fee (e.g. Garage)">
</div>
<div class="form-group" id="additionalFeeAmountGroup" style="display:none;">
    <label>Additional Fee Amount ($)</label>
    <input type="number" id="additionalFeeAmount" min="0" step="0.01">
</div>
        </div>
        <!-- Row 4: Lease Type, Status, Renewal -->
        <div class="form-row">
            <div class="form-group">
                <label>Lease Type</label>
                <select id="leaseType" required>
                    <option value="">Select</option>
                    <option value="fmr">Free Market Rent</option>
                    <option value="section8">Section 8</option>
                </select>
            </div>
            <div class="form-group">
                <label>Lease Status</label>
                <select id="leaseStatus" required>
                    <option value="active">Active</option>
                    <option value="pending">Pending</option>
                    <option value="expired">Expired</option>
                    <option value="terminated">Terminated</option>
                </select>
            </div>
            <div class="form-group">
                <label>Lease Renewal</label>
                <select id="leaseRenewal" required>
                    <option value="renew">Will Renew</option>
                    <option value="terminate">Will Terminate</option>
                </select>
            </div>
        </div>
        <!-- Lease Type Details -->
        <div id="fmrSection" style="display:none;">
            <div class="form-group">
                <label>FMR Notes</label>
                <textarea id="fmrNotes"></textarea>
            </div>
        </div>
        <div id="section8Section" style="display:none;">
            <div class="form-group">
                <label>HUB Contribution ($)</label>
                <input type="number" id="hubContribution" min="0">
            </div>
            <div class="form-group">
                <label>Tenant Contribution ($)</label>
                <input type="number" id="tenantContribution" min="0">
            </div>
        </div>
        <!-- Row 5: Unit, Occupants -->
        <div class="form-row">
            <div class="form-group">
                <label>Unit</label>
                <select id="tenantUnit" required>
                    <option value="">Select a unit</option>
                </select>
            </div>
            <div class="form-group">
                <label>Authorized Occupants (one per line)</label>
                <textarea id="authorizedOccupants"></textarea>
            </div>
        </div>
        <!-- Row 6: Pets & Cars -->
        <div class="form-row">
            <div class="form-group" style="min-width:180px;">
                <label>
                    <input type="checkbox" id="hasPets"> Has Pets
                </label>
                    <div id="petDetails" style="display:none; margin-top:10px;">
                    <label>Number of Pets</label>
                    <input type="number" id="petCount" min="0">
                    <div id="petFieldsContainer"></div>
                    <label>Non-refundable Pet Fee ($)</label>
                    <input type="number" id="petNonRefundableFee" min="0" step="0.01">
                    <label>Monthly Pet Rent ($)</label>
                     <input type="number" id="petMonthlyRent" min="0" step="0.01">
                   <label>Increased Security Deposit ($)</label>
                      <input type="number" id="petDepositIncrease" min="0" step="0.01">
                 </div>
               </div>
            <div class="form-group" style="min-width:180px;">
                <label>
                    <input type="checkbox" id="hasCar"> Has Car(s)
                </label>
                <div id="carDetails" style="display:none;">
                    <label>Number of Cars</label>
                    <input type="number" id="carCount" min="1" value="1">
                    <div id="carFieldsContainer"></div>
                </div>
            </div>
        </div>
        <!-- Emergency Contact Section -->
        <fieldset style="margin-top:18px; border:1px solid #e1e8ed; border-radius:8px; padding:14px 18px;">
            <legend style="font-weight:600; color:#2980b9; font-size:1.01rem;">Emergency Contact</legend>
            <div class="form-row">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="emergencyContactName">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="emergencyContactPhone">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="emergencyContactEmail">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="emergencyContactAddress">
                </div>
                <div class="form-group">
                    <label>Relation</label>
                    <input type="text" id="emergencyContactRelation">
                </div>
            </div>
        </fieldset>
        <!-- Form Buttons -->
        <div class="modal-buttons" style="margin-top:18px;">
            <button type="button" class="btn-secondary" onclick="closeModal('addTenantModal')">Cancel</button>
            <button type="submit" class="btn-primary">Add Tenant</button>
        </div>
    </form>
</div>
</div>
</div>

<!-- Add Maintenance Modal -->
<div class="modal" id="addMaintenanceModal">
    <div class="modal-content">
        <h2>New Maintenance Request</h2>
        <form id="addMaintenanceForm">
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="maintenanceTitle" required>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="maintenanceDescription" required></textarea>
            </div>
            <div class="form-group">
                <label>Property</label>
                <select id="maintenanceProperty">
                    <option value="">Select a property</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Priority</label>
                    <select id="maintenancePriority" required>
                        <option value="urgent">Urgent</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Unit</label>
                    <select id="maintenanceUnit">
                        <option value="">Select a unit</option>
                        <!-- Populated dynamically -->
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Photos</label>
                <input type="file" id="maintenancePhotos" multiple accept="image/*">
                <div id="maintenancePhotosPreview" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;"></div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn-secondary" onclick="closeModal('addMaintenanceModal')">Cancel</button>
                <button type="submit" class="btn-primary">Submit Request</button>
            </div>
        </form>
    </div>
</div>

<!-- Create Maintenance Schedule Modal -->
<div class="modal" id="addScheduleModal">
  <div class="modal-content">
    <h2>Create Maintenance Schedule</h2>
    <form id="addScheduleForm">
      <div class="form-group">
        <label>Title</label>
        <input type="text" id="scheduleTitle" required>
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="scheduleDescription"></textarea>
      </div>
      <div class="form-group">
        <label>Frequency</label>
        <select id="scheduleFrequency" required>
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
          <option value="yearly">Yearly</option>
          <option value="custom">Custom Interval</option>
        </select>
      </div>
      <div class="form-group" id="customIntervalGroup" style="display:none;">
        <label>Custom Interval (days)</label>
        <input type="number" id="scheduleIntervalDays" min="1">
      </div>
      <div class="form-group">
        <label>Start Date</label>
        <input type="date" id="scheduleStartDate" required>
      </div>
      <div class="form-group">
        <label>Assign Vendor (optional)</label>
        <select id="scheduleVendor">
          <option value="">None</option>
          <!-- Populate with vendors -->
        </select>
      </div>
      <!-- NEW FIELDS BELOW -->
      <div class="form-group">
        <label>Unit (optional)</label>
        <select id="scheduleUnit">
          <option value="">None</option>
          <!-- Populate with units -->
        </select>
      </div>
      <div class="form-group">
        <label>Status</label>
        <select id="scheduleStatus">
          <option value="pending">Pending</option>
          <option value="in-progress">In Progress</option>
          <option value="completed">Completed</option>
        </select>
      </div>
      <div class="form-group">
        <label>Cost ($)</label>
        <input type="number" id="scheduleCost" min="0" step="0.01">
      </div>
      <!-- END NEW FIELDS -->
      <div class="modal-buttons">
        <button type="button" class="btn-secondary" onclick="closeModal('addScheduleModal')">Cancel</button>
        <button type="submit" class="btn-primary">Create Schedule</button>
      </div>
    </form>
  </div>
</div>

<!-- Upload Document Modal -->
<div class="modal" id="uploadDocumentModal">
    <div class="modal-content">
        <h2>Upload Document</h2>
        <form id="uploadDocumentForm" enctype="multipart/form-data">
            <div class="form-group">
                <label>Document Name</label>
                <input type="text" id="documentName" required>
            </div>
<div class="form-group">
    <label>Type</label>
    <select id="documentType" required>
        <option value="">Select Type</option>
        <option value="lease">Lease</option>
        <option value="notice">Notice</option>
        <option value="invoice">Invoice</option>
        <option value="other">Other</option>
    </select>
</div>
            <div class="form-group">
                <label>File</label>
                <input type="file" id="documentFile" required>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn-secondary" onclick="closeModal('uploadDocumentModal')">Cancel</button>
                <button type="submit" class="btn-primary">Upload</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" id="addPaymentModal">
    <div class="modal-content">
        <h2>Record Payment</h2>
       <form id="addPaymentForm">
    <div class="form-row">
        <div class="form-group">
            <label>Property</label>
            <select id="paymentProperty" required>
                <option value="">Select Property</option>
            </select>
        </div>
    </div>
    <div class="form-row">
        <div class="form-group">
            <label>Tenant</label>
            <select id="paymentTenant" required>
                <option value="">Select Tenant</option>
            </select>
        </div>
        <div class="form-group">
            <label>Payment Type</label>
            <select id="paymentType" required>
                <option value="rent">Rent</option>
                <option value="hub">HUB (Subsidy)</option>
                <option value="partial">Partial</option>
                <option value="adjustment">Adjustment</option>
                <option value="custom">Custom</option>
            </select>
        </div>
        <div class="form-group" id="customTypeGroup" style="display:none;">
            <label>Custom Type Label</label>
            <input type="text" id="paymentCustomType" maxlength="60" placeholder="Describe custom type">
        </div>
        <div class="form-group">
            <label>Applies To</label>
            <select id="paymentApplyTo">
                <option value="rent">Rent</option>
                <option value="deposit">Deposit</option>
                <option value="fee">Generic Fee</option>
                <option value="late">Late Fee</option>
                <option value="water">Water</option>
                <option value="electric">Electric</option>
                <option value="trash">Trash</option>
                <option value="admin">Admin</option>
                <option value="other">Other</option>
            </select>
        </div>
        <div class="form-group">
    <label>Late Fee (%)</label>
    <input type="number" id="paymentLateFee" min="0" step="0.01" placeholder="Enter late fee percent">
</div>
        <div class="form-group">
            <label>Amount ($)</label>
            <input type="number" id="paymentAmount" step="0.01" required>
            <small style="color:#6b7280">Use negative for credit/refund.</small>
        </div>
    </div>
    <div class="form-row">
        <div class="form-group">
            <label>Unit #</label>
            <select id="paymentUnit" required>
                <option value="">Select Unit</option>
                <!-- Populated dynamically -->
            </select>
        </div>
        <div class="form-group">
            <label>Payment Method</label>
            <select id="paymentMethod" required>
                <option value="cash">Cash</option>
                <option value="check">Check</option>
                <option value="bank">Bank Transfer</option>
                <option value="online">Online</option>
            </select>
        </div>
        <div class="form-group">
            <label>Date</label>
            <input type="date" id="paymentDate" required>
        </div>
    </div>
    <div class="form-row" id="paymentFeeRow" style="display:none;">
        <div class="form-group">
            <label>Fee Type</label>
            <input type="text" id="paymentFeeType" placeholder="e.g., Late, Admin">
        </div>
        <div class="form-group">
            <label>Fee Label</label>
            <input type="text" id="paymentFeeLabel" placeholder="Short description">
        </div>
        <div class="form-group">
            <label>Period (YYYY-MM)</label>
            <input type="month" id="paymentPeriodMonth">
        </div>
    </div>
    <div class="form-row">
        <div class="form-group" style="flex:1 1 100%">
            <label>Note (optional)</label>
            <textarea id="paymentNote" rows="2" placeholder="e.g., Credit for overpayment or memo"></textarea>
        </div>
    </div>
    <div class="form-row" id="carryForwardGroup" style="display:none;">
        <div class="form-group" style="flex:1 1 220px;align-items:center;">
            <label style="font-weight:600">Credit Options</label>
            <div style="display:flex;gap:8px;align-items:center;margin-top:4px;">
                <input type="checkbox" id="paymentCarryForward">
                <label for="paymentCarryForward" style="font-weight:500;">Apply remaining credit to next month rent</label>
            </div>
        </div>
    </div>
    <div class="modal-buttons">
        <button type="button" class="btn-secondary" onclick="closeModal('addPaymentModal')">Cancel</button>
        <button type="submit" class="btn-primary">Save Payment</button>
    </div>
</form>
    </div>
</div>

<!-- Tenant Balance Sheet Modal -->
<div class="modal" id="tenantBalanceModal">
    <div class="modal-content" style="max-width:1000px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h2 style="margin:0;font-size:1.6rem;">Tenant Balance Sheet</h2>
            <div style="display:flex;gap:8px;align-items:center;">
                <button class="btn-secondary" onclick="exportTenantPaymentsReportFromModal()" style="padding:6px 12px;">Export Monthly Report</button>
                <button class="btn-secondary" onclick="closeModal('tenantBalanceModal')" style="padding:6px 12px;">Close</button>
            </div>
        </div>
        <div id="tenantBalanceHeader" style="margin-bottom:18px;font-size:0.95rem;color:#374151"></div>
        <div id="tenantBalanceSummary" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:20px;"></div>
        <div class="table-responsive" style="max-height:380px;overflow:auto;border:1px solid #e1e8ed;border-radius:8px;background:#fff;">
            <table class="payments-table" id="tenantPaymentsTable" style="margin:0;">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Applied To</th>
                        <th>Amount</th>
                        <th>Balance</th>
                        <th>Note</th>
                    </tr>
                </thead>
                <tbody id="tenantPaymentsTbody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Edit Invite Modal -->
<div class="modal" id="editInviteModal">
    <div class="modal-content" style="max-width:520px;">
        <div class="modal-header">
            <h2>Edit Invite</h2>
            <button class="btn-close" onclick="closeModal('editInviteModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="editInviteForm">
                <input type="hidden" id="editInviteId" />
                <div class="form-row">
                    <div class="form-group" style="flex:1 1 60%;">
                        <label for="editInviteName">Name</label>
                        <input type="text" id="editInviteName" required />
                    </div>
                    <div class="form-group" style="flex:1 1 40%;">
                        <label for="editInviteEmail">Email</label>
                        <input type="email" id="editInviteEmail" required />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editInviteProperty">Property</label>
                        <input type="text" id="editInviteProperty" />
                    </div>
                    <div class="form-group" style="max-width:140px;">
                        <label for="editInviteUnit">Unit</label>
                        <input type="text" id="editInviteUnit" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editInviteStatus">Status</label>
                        <select id="editInviteStatus">
                            <option value="sent">Sent</option>
                            <option value="opened">Opened</option>
                            <option value="completed">Completed</option>
                            <option value="expired">Expired</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editInviteUrl">Application Link</label>
                        <input type="url" id="editInviteUrl" />
                    </div>
                </div>
                <div class="modal-buttons" style="margin-top:16px;">
                    <button type="button" class="btn-secondary" onclick="closeModal('editInviteModal')">Cancel</button>
                    <button type="submit" class="btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
</div>

    <!-- View Unit Modal (example) -->
<div id="viewUnitModal" class="modal">
  <div class="modal-content unit-details-modal">
    <div class="modal-header">
      <h2>Unit Details</h2>
      <button class="btn-close" onclick="closeModal('viewUnitModal')">&times;</button>
    </div>
    <div class="modal-body" id="unitDetailsBody">
      <!-- Content will be injected by JS -->
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="exportUtilityReport()">Export Utility Report</button>
      <button class="btn-primary" onclick="closeModal('viewUnitModal')">Close</button>
    </div>
  </div>
</div>

<!-- Slide-in Notes Drawer (shared for Applications & Invites) -->
<div id="notesDrawer" class="notes-drawer">
    <div id="notesDrawerOverlay" class="notes-drawer-overlay"></div>
    <div class="notes-drawer-panel">
        <div id="notesDrawerLoader" class="notes-drawer-loader">
            <div class="notes-drawer-loader-spinner"></div>
        </div>
        <div class="notes-drawer-header">
            <div>
                <h3 id="notesDrawerTitle">Notes</h3>
                <small id="notesDrawerSubtitle"></small>
            </div>
            <button type="button" id="notesDrawerClose" class="notes-drawer-close">&times;</button>
        </div>
        <div id="notesDrawerBody" class="notes-drawer-body">
            <div class="notes-drawer-empty">No notes yet. Start the conversation below.</div>
        </div>
        <form id="notesDrawerForm" class="notes-drawer-footer">
            <input type="text" id="notesDrawerInput" placeholder="Type a note and press Enter" autocomplete="off" />
            <button type="submit">Add</button>
        </form>
    </div>
</div>

<!-- Global Overview Modal (Maintenance / Applications) -->
<div class="modal" id="globalOverviewModal" style="display:none;">
    <div class="modal-content" style="max-width:1000px;">
        <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <h2 id="globalOverviewTitle" style="margin:0;font-size:1.6rem;">Overview</h2>
            <button class="btn-secondary" onclick="closeModal('globalOverviewModal')">Close</button>
        </div>
        <div id="globalOverviewBody" class="modal-body" style="max-height:520px;overflow:auto;scrollbar-width: none;"></div>
    </div>
</div>

<!-- Add this just before the closing body tag -->
<div id="notification" class="notification"></div>


<!-- Loader Spinner -->
<div id="loader" style="
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(2px);
  z-index: 9999;
  display: none;
  justify-content: center;
  align-items: center;
">
  <div style="
    border: 5px solid #e5e7eb;
    border-top: 5px solid #3b82f6;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    animation: spin 0.8s linear infinite;
  "></div>
</div>

<!-- Add this to your <style> block or <head> -->
<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
/* Responsive horizontal scroll for wide tables on small screens */
.table-responsive {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 transparent;
}
.table-responsive::-webkit-scrollbar { height: 8px; }
.table-responsive::-webkit-scrollbar-track { background: transparent; }
.table-responsive::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:4px; }
@media (max-width: 760px) {
    .table-responsive { margin-bottom:12px; border:1px solid #e2e8f0; border-radius:10px; background:#fff; }
    .table-responsive table { min-width:720px; }
    .payments-table th, .payments-table td,
    .maintenance-table th, .maintenance-table td { white-space:nowrap; }
}
</style>

    <script>
       // Global state management
const state = {
    currentProperty: null,
    currentTab: 'units',
    properties: [],
    units: [],
    tenants: [],
    maintenanceRequests: [],
    documents: [],
    allUnits: [],
    allTenants: [],
    portfolioPayments: [],
    portfolioMaintenance: [],
    portfolioTenantsWithBalance: [],
    portfolioExpiringLeases: [],
    portfolioUpcomingMoveIns: [],
    portfolioVacantUnits: [],
    portfolioOccupiedUnits: [],
    portfolioTasks: [],
    payments: [],
    applications: [],
    invites: [],
    highlightMaintenanceId: null,
    highlightApplicationId: null,
    portfolioRentMonth: null,
    keepPortfolioTypeFilterOnNextRender: false
};

const API_URL = '/api';


        // Small utility: schedule non-critical work after first paint/idle
function runWhenIdle(fn) {
    try {
        if (window.requestIdleCallback) {
            window.requestIdleCallback(() => setTimeout(fn, 0), { timeout: 1200 });
        } else {
            setTimeout(fn, 0);
        }
    } catch (_) {
        setTimeout(fn, 0);
    }
}

// Light data cache to avoid re-fetching the same property data repeatedly
state._cache = state._cache || {};
const CACHE_TTL_MS = 60 * 1000; // 60s
function shouldUseCache(key, propertyId) {
    const entry = state._cache[key];
    return entry && entry.propertyId === propertyId && (Date.now() - entry.ts) < CACHE_TTL_MS;
}
function touchCache(key, propertyId) {
    state._cache[key] = { propertyId, ts: Date.now() };
}

// Invalidate one or more cache buckets (used after any create/update/delete)
function invalidateCache(...keys) {
    keys.forEach(k => {
        if (state._cache[k]) {
            delete state._cache[k];
        }
    });
}

// Initialize application
document.addEventListener('DOMContentLoaded', async () => {
    initializeEventListeners();
    initializeTabs();
    initializeApplicationsSubtabs();
    initializeApplicationsSearch();
    initializeInvitesSearch();

    // Ensure properties are loaded before opening the portfolio overview
    try {
        await loadProperties();
    } catch (_) {
        // Errors are already handled inside loadProperties
    }

    // Preload global data so toolbar icons are ready on first click
    runWhenIdle(() => {
        loadApplications().catch(() => {});
        loadInvites().catch(() => {});
        preloadGlobalMaintenanceCount().catch(() => {});
    });

    // Default to portfolio overview on initial load
    runWhenIdle(() => {
        openPortfolioOverview().catch(() => {});
    });
});

async function preloadGlobalMaintenanceCount() {
    try {
        const res = await fetch('/api/properties/maintenance?status=pending,in-progress&_=' + Date.now());
        if (!res.ok) return;
        const items = await res.json();
        const topMaint = document.getElementById('topMaintenanceCount');
        if (topMaint && Array.isArray(items)) {
            const count = items.length || 0;
            topMaint.textContent = count > 99 ? '99+' : count;
        }
    } catch (e) {
        console.error('Error preloading global maintenance count:', e);
    }
}

// Helper: mark active portfolio overview chip
function setActivePortfolioCard(type) {
    const map = {
        rent: 'portfolioCardRent',
        tenants: 'portfolioCardTenants',
        maintenance: 'portfolioCardMaintenance',
        applications: 'portfolioCardApplications',
        leases: 'portfolioCardLeases',
        vacancy: 'portfolioCardVacancy'
    };
    const activeId = map[type];
    if (!activeId) return;
    document.querySelectorAll('.portfolio-chip').forEach(el => el.classList.remove('active'));
    const target = document.getElementById(activeId);
    if (target) target.classList.add('active');
}

// Open the cross-portfolio overview dashboard
async function openPortfolioOverview() {
    const dashboard = document.getElementById('propertyDashboard');
    const section = document.getElementById('portfolioOverviewSection');
    if (!section) return;
    if (dashboard) dashboard.style.display = 'none';
    section.style.display = 'block';
    showLoader();
    try {
        // Prioritize the main portfolio metrics so the overview appears quickly.
        await renderPortfolioOverview();
    } finally {
        hideLoader();
    }

    // Load tasks and default details view without blocking the initial overview paint.
    loadPortfolioTasks(true).catch(() => {});
    try {
        // Default details view when opening overview (Leases & Move-ins)
        renderPortfolioDetails('leases');
        // Mark the default portfolio card as active
        setActivePortfolioCard('leases');
    } catch (e) {
        console.warn('Error rendering initial portfolio details:', e);
    }
}

// Event Listeners Setup
function initializeEventListeners() {
    // Property management
    document.getElementById('addPropertyBtn')?.addEventListener('click', () => openModal('addPropertyModal'));
    document.getElementById('addPropertyForm')?.addEventListener('submit', handleAddProperty);
    
    // Unit management
    document.getElementById('addUnitBtn')?.addEventListener('click', () => {
    resetUnitForm();
    openModal('addUnitModal');
});
    document.getElementById('addUnitForm')?.addEventListener('submit', handleAddUnit);
    
    // Tenant management
    document.getElementById('addTenantBtn')?.addEventListener('click', () => {
    if (!state.currentProperty) {
        showNotification('Please select a property first', 'error');
        return;
    }
    resetTenantForm(); // <-- Add this line
    populateUnitSelect();
    openModal('addTenantModal');
});
    document.getElementById('addTenantForm')?.addEventListener('submit', handleAddTenant);
    
    // Maintenance management
    document.getElementById('addMaintenanceBtn')?.addEventListener('click', () => {
    if (!state.currentProperty) {
        showNotification('Please select a property first', 'error');
        return;
    }
    const form = document.getElementById('addMaintenanceForm');
    if (form) {
        form.dataset.context = 'property';
    }
    populateMaintenancePropertySelect(state.currentProperty && state.currentProperty._id);
    populateMaintenanceUnitSelect();
    openModal('addMaintenanceModal');
});
    document.getElementById('addMaintenanceForm')?.addEventListener('submit', handleAddMaintenance);

    const maintenancePropertySelect = document.getElementById('maintenanceProperty');
    if (maintenancePropertySelect && maintenancePropertySelect.dataset.bound !== 'true') {
        maintenancePropertySelect.addEventListener('change', handleMaintenancePropertyChange);
        maintenancePropertySelect.dataset.bound = 'true';
    }
    
    // Document management
    document.getElementById('uploadDocumentBtn')?.addEventListener('click', () => {
    if (!state.currentProperty) {
        showNotification('Please select a property first', 'error');
        return;
    }
    openModal('uploadDocumentModal');
});
    document.getElementById('uploadDocumentForm')?.addEventListener('submit', handleDocumentUpload);

    // Add event listeners for payments tab and modal
document.getElementById('addPaymentBtn')?.addEventListener('click', () => {
    if (!state.currentProperty) {
        showNotification('Please select a property first', 'error');
        return;
    }
    const propId = state.currentProperty?._id;
    openPaymentModalForTenantAndProperty(null, propId, true);
});
document.getElementById('addPaymentForm')?.addEventListener('submit', handleAddPayment);

    // Portfolio overview toggle
    document.getElementById('portfolioOverviewBtn')?.addEventListener('click', openPortfolioOverview);

    // Portfolio card click handlers for details + active state
    document.getElementById('portfolioCardRent')?.addEventListener('click', () => {
        setActivePortfolioCard('rent');
        renderPortfolioDetails('rent');
    });
    document.getElementById('portfolioCardTenants')?.addEventListener('click', () => {
        setActivePortfolioCard('tenants');
        renderPortfolioDetails('tenants');
    });
    document.getElementById('portfolioCardMaintenance')?.addEventListener('click', () => {
        setActivePortfolioCard('maintenance');
        renderPortfolioDetails('maintenance');
    });
    document.getElementById('portfolioCardApplications')?.addEventListener('click', () => {
        setActivePortfolioCard('applications');
        renderPortfolioDetails('applications');
    });
    document.getElementById('portfolioCardLeases')?.addEventListener('click', () => {
        setActivePortfolioCard('leases');
        renderPortfolioDetails('leases');
    });
    document.getElementById('portfolioCardVacancy')?.addEventListener('click', () => {
        setActivePortfolioCard('vacancy');
        renderPortfolioDetails('vacancy');
    });

    // Portfolio tasks: add / toggle / delete
    const taskForm = document.getElementById('portfolioTaskForm');
    const taskTitleInput = document.getElementById('portfolioTaskTitleInput');
    const tasksListEl = document.getElementById('portfolioTasksList');

    if (taskForm && taskTitleInput) {
        taskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const raw = taskTitleInput.value || '';
            const title = raw.trim();
            if (!title) return;
            try {
                const res = await fetch(`${API_URL}/portfolio-tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title })
                });
                if (res.ok) {
                    const data = await res.json();
                    if (data && data.task) {
                        state.portfolioTasks.unshift(data.task);
                        renderPortfolioTasksList();
                    } else {
                        await loadPortfolioTasks(true);
                    }
                    taskTitleInput.value = '';
                }
            } catch (err) {
                console.error('Error adding portfolio task:', err);
            }
        });
    }

    if (tasksListEl) {
        tasksListEl.addEventListener('click', async (e) => {
            const deleteBtn = e.target.closest('.portfolio-task-delete');
            if (deleteBtn) {
                const item = deleteBtn.closest('.portfolio-task-item');
                const id = item?.dataset.id;
                if (!id) return;
                try {
                    const res = await fetch(`${API_URL}/portfolio-tasks/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        state.portfolioTasks = (state.portfolioTasks || []).filter(t => String(t._id) !== String(id));
                        renderPortfolioTasksList();
                    }
                } catch (err) {
                    console.error('Error deleting portfolio task:', err);
                }
            }
        });

        tasksListEl.addEventListener('change', async (e) => {
            const checkbox = e.target;
            if (!(checkbox instanceof HTMLInputElement) || !checkbox.classList.contains('portfolio-task-toggle')) return;
            const item = checkbox.closest('.portfolio-task-item');
            const id = item?.dataset.id;
            if (!id) return;
            const completed = checkbox.checked;
            try {
                const res = await fetch(`${API_URL}/portfolio-tasks/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed })
                });
                if (res.ok) {
                    const data = await res.json();
                    if (data && data.task) {
                        const idx = (state.portfolioTasks || []).findIndex(t => String(t._id) === String(id));
                        if (idx !== -1) {
                            state.portfolioTasks[idx] = data.task;
                        }
                        renderPortfolioTasksList();
                    } else {
                        await loadPortfolioTasks(true);
                    }
                }
            } catch (err) {
                console.error('Error updating portfolio task:', err);
            }
        });
    }

    // Modal close handlers
    window.onclick = (event) => {
        if (event.target.classList.contains('modal')) {
            closeModal(event.target.id);
        }
    };
}

// Small utility helpers
function debounce(fn, delay) {
    let timerId;
    return function(...args) {
        if (timerId) clearTimeout(timerId);
        timerId = setTimeout(() => fn.apply(this, args), delay);
    };
}

// Applications subtabs toggle (Applications vs Invites)
function initializeApplicationsSubtabs() {
    const buttons = document.querySelectorAll('.applications-tab-btn');
    const paneApps = document.getElementById('applicationsPane-applications');
    const paneInvites = document.getElementById('applicationsPane-invites');
    if (!buttons.length || !paneApps || !paneInvites) return;
    if (paneApps.dataset._subtabsInited === '1') return;
    paneApps.dataset._subtabsInited = '1';
    buttons.forEach(btn => {
        btn.addEventListener('click', () => {
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const sub = btn.getAttribute('data-subtab');
            if (sub === 'invites') {
                paneApps.style.display = 'none';
                paneInvites.style.display = 'block';
            } else {
                paneApps.style.display = 'block';
                paneInvites.style.display = 'none';
            }
        });
    });
}

// ===== Applications Search =====
function initializeApplicationsSearch() {
    const search = document.getElementById('applicationsSearchBar');
    if (!search) return;
    if (search.dataset._inited === '1') return;
    search.dataset._inited = '1';
    const debouncedRender = debounce(renderFilteredApplications, 180);
    search.addEventListener('input', ()=>{ positionApplicationsSearchSuggestions(); autoSuggestApplications(); showApplicationsSearchSuggestions(true); debouncedRender(); });
    search.addEventListener('change', ()=>{ positionApplicationsSearchSuggestions(); debouncedRender(); });
    search.addEventListener('focus', ()=>{ positionApplicationsSearchSuggestions(); showApplicationsSearchSuggestions(true); });
    search.addEventListener('blur', ()=> setTimeout(()=>showApplicationsSearchSuggestions(false), 120));
    const clr = document.getElementById('clearApplicationsFiltersBtn');
    if (clr) clr.onclick = ()=>{ search.value=''; window.__appsAccumulatedQuery=''; renderFilteredApplications(); showApplicationsSearchSuggestions(false); };
    const sug = document.getElementById('applicationsSearchSuggestions');
    if (sug) {
        renderApplicationsSuggestionTokens();
        sug.addEventListener('mousedown', (e)=>{
            const tokenEl = e.target.closest('.suggest-item');
            const valEl = e.target.closest('.suggest-value');
            e.preventDefault();
            if (tokenEl) {
                const token = tokenEl.getAttribute('data-token') || '';
                showApplicationsValueSuggestions(token);
            } else if (valEl) {
                const token = valEl.getAttribute('data-token') || '';
                const value = valEl.getAttribute('data-value') || '';
                const acc = (window.__appsAccumulatedQuery || '').trim();
                const sep = acc ? ' ' : '';
                window.__appsAccumulatedQuery = `${acc}${sep}${token}${value}`;
                const input = document.getElementById('applicationsSearchBar');
                if (input) input.value = '';
                renderFilteredApplications();
                showApplicationsSearchSuggestions(false);
            }
        });
        const backBtn = document.getElementById('applicationsSuggestBack');
        if (backBtn) backBtn.addEventListener('mousedown', (e)=>{ e.preventDefault(); renderApplicationsSuggestionTokens(); });
    }
}

function parseApplicationsSearch(queryStr) {
    const tokens = { nameList:[], emailList:[], phoneList:[], propertyList:[], unitList:[], statusList:[], movein:'', submitted:'', text:'' };
    const parts = (queryStr||'').trim().split(/\s+/).filter(Boolean);
    const rest = [];
    for (const part of parts) {
        const low = part.toLowerCase();
        const take = (pfx)=> part.slice(pfx.length);
        if (low.startsWith('name:')) tokens.nameList.push(...take('name:').split(',').filter(Boolean));
        else if (low.startsWith('email:')) tokens.emailList.push(...take('email:').split(',').filter(Boolean));
        else if (low.startsWith('phone:')) tokens.phoneList.push(...take('phone:').split(',').filter(Boolean));
        else if (low.startsWith('property:')) tokens.propertyList.push(...take('property:').split(',').filter(Boolean));
        else if (low.startsWith('unit:')) tokens.unitList.push(...take('unit:').split(',').filter(Boolean));
        else if (low.startsWith('status:')) tokens.statusList.push(...take('status:').split(',').filter(Boolean));
        else if (low.startsWith('movein:')) tokens.movein = take('movein:');
        else if (low.startsWith('submitted:')) tokens.submitted = take('submitted:');
        else rest.push(part);
    }
    const norm = (arr)=> Array.from(new Set(arr.map(v=>String(v).trim().toLowerCase()).filter(Boolean)));
    tokens.nameList = norm(tokens.nameList);
    tokens.emailList = norm(tokens.emailList);
    tokens.phoneList = norm(tokens.phoneList);
    tokens.propertyList = norm(tokens.propertyList);
    tokens.unitList = norm(tokens.unitList);
    tokens.statusList = norm(tokens.statusList);
    tokens.text = rest.join(' ').toLowerCase();
    return { tokens, text: tokens.text };
}

function getApplicationsSearch() {
    const input = document.getElementById('applicationsSearchBar');
    const current = input ? input.value : '';
    const combined = `${(window.__appsAccumulatedQuery||'').trim()} ${current.trim()}`.trim();
    const query = parseApplicationsSearch(combined);
    renderApplicationsFilterChips(query.tokens);
    return query;
}

function renderApplicationsFilterChips(tokens) {
    const container = document.getElementById('applicationsActiveFilterChips');
    if (!container) return;
    const mkChip = (k,v,disp)=>`<span class="filter-chip" data-key="${k}" data-value="${v}" style="display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#eef2f7;color:#374151;border:1px solid #e5e7eb;font-size:.9em;"><span style="color:#0b5cab;font-weight:600">${k}</span><span>${disp ?? v}</span><button class="chip-remove" style="background:transparent;border:none;color:#6b7280;cursor:pointer;font-weight:700;"></button></span>`;
    const chips = [];
    tokens.nameList.forEach(v=>chips.push(mkChip('name:',v)));
    tokens.emailList.forEach(v=>chips.push(mkChip('email:',v)));
    tokens.phoneList.forEach(v=>chips.push(mkChip('phone:',v)));
    tokens.propertyList.forEach(v=>chips.push(mkChip('property:',v)));
    tokens.unitList.forEach(v=>chips.push(mkChip('unit:',v)));
    tokens.statusList.forEach(v=>chips.push(mkChip('status:',v)));
    if (tokens.movein) chips.push(mkChip('movein:', tokens.movein));
    if (tokens.submitted) chips.push(mkChip('submitted:', tokens.submitted));
    container.innerHTML = chips.join('');
    container.querySelectorAll('.chip-remove').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
            const chip = e.target.closest('.filter-chip');
            removeApplicationsFilterToken(chip.getAttribute('data-key')||'', chip.getAttribute('data-value')||'');
        });
    });
}

function removeApplicationsFilterToken(key, value) {
    const input = document.getElementById('applicationsSearchBar');
    const combined = `${(window.__appsAccumulatedQuery||'').trim()} ${(input?.value||'').trim()}`.trim();
    const { tokens } = parseApplicationsSearch(combined);
    const rem = (arr)=>{ const i = arr.findIndex(v=>v===value.toLowerCase()); if(i>=0) arr.splice(i,1); };
    switch(key){
        case 'name:': rem(tokens.nameList); break;
        case 'email:': rem(tokens.emailList); break;
        case 'phone:': rem(tokens.phoneList); break;
        case 'property:': rem(tokens.propertyList); break;
        case 'unit:': rem(tokens.unitList); break;
        case 'status:': rem(tokens.statusList); break;
        case 'movein:': tokens.movein=''; break;
        case 'submitted:': tokens.submitted=''; break;
    }
    const parts=[];
    if (tokens.nameList.length) parts.push(`name:${tokens.nameList.join(',')}`);
    if (tokens.emailList.length) parts.push(`email:${tokens.emailList.join(',')}`);
    if (tokens.phoneList.length) parts.push(`phone:${tokens.phoneList.join(',')}`);
    if (tokens.propertyList.length) parts.push(`property:${tokens.propertyList.join(',')}`);
    if (tokens.unitList.length) parts.push(`unit:${tokens.unitList.join(',')}`);
    if (tokens.statusList.length) parts.push(`status:${tokens.statusList.join(',')}`);
    if (tokens.movein) parts.push(`movein:${tokens.movein}`);
    if (tokens.submitted) parts.push(`submitted:${tokens.submitted}`);
    window.__appsAccumulatedQuery = parts.join(' ');
    if (input) input.value='';
    renderFilteredApplications();
}

function showApplicationsSearchSuggestions(show){
    const box = document.getElementById('applicationsSearchSuggestions');
    if (!box) return;
    if (show) renderApplicationsSuggestionTokens();
    box.style.display = show ? 'block' : 'none';
}
function positionApplicationsSearchSuggestions(){
    const bar = document.getElementById('applicationsFilterBar');
    const input = document.getElementById('applicationsSearchBar');
    const box = document.getElementById('applicationsSearchSuggestions');
    if (!bar || !input || !box) return;
    const barRect = bar.getBoundingClientRect();
    const inRect = input.getBoundingClientRect();
    box.style.left = `${inRect.left - barRect.left}px`;
    box.style.top = `${inRect.bottom - barRect.top + 6}px`;
    box.style.minWidth = `${Math.max(inRect.width, 320)}px`;
}
function renderApplicationsSuggestionTokens(){
    const list = document.getElementById('applicationsSuggestList');
    const title = document.getElementById('applicationsSuggestTitle');
    const values = document.getElementById('applicationsSuggestValues');
    const backBtn = document.getElementById('applicationsSuggestBack');
    if (!list) return;
    const tokens = ['name:','email:','phone:','property:','unit:','status:','movein:','submitted:'];
    list.innerHTML = tokens.map(k=>`<li class='suggest-item' data-token='${k}' style='padding:8px 12px;cursor:pointer;display:flex;gap:8px;align-items:center;'><span style='font-weight:600;color:#1f2937'>${k}</span><span style='font-size:.85em;color:#6b7280'>Add ${k} filter</span></li>`).join('');
    if (title) title.textContent = 'Choose a filter';
    if (backBtn) backBtn.style.display='none';
    if (values) { values.style.display='none'; values.innerHTML=''; }
    list.style.display='block';
}
function showApplicationsValueSuggestions(token){
    const list = document.getElementById('applicationsSuggestList');
    const values = document.getElementById('applicationsSuggestValues');
    const title = document.getElementById('applicationsSuggestTitle');
    const backBtn = document.getElementById('applicationsSuggestBack');
    if (!list || !values || !title) return;
    let items=[];
    if (token==='property:') {
        // For application property filters, suggest values based on the
        // actual address text shown in the Property column so users can
        // search by what they see, not internal names.
        const rows = Array.from(document.querySelectorAll('#applicationsTable tbody tr'));
        const seen = new Set();
        items = rows.map(r => {
            const label = (r.children[3]?.textContent || '').trim();
            const value = (r.dataset.property || '').toLowerCase();
            return { label, value };
        }).filter(it => {
            if (!it.label || !it.value) return false;
            if (seen.has(it.value)) return false;
            seen.add(it.value);
            return true;
        });
    }
    else if (token==='unit:') items = (state.units||[]).map(u=>({label:`${u.number}`, value:String(u.number).toLowerCase()}));
    else if (token==='status:') items = ['pending','approved','rejected'].map(v=>({label:v,value:v}));
    else if (token==='movein:' || token==='submitted:') {
        const now = new Date();
        items = Array.from({length:6},(_,i)=>{ const d=new Date(now.getFullYear(),now.getMonth()-i,1); const m=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; return {label:m,value:m}; });
    } else if (token==='name:' || token==='email:' || token==='phone:') {
        items = (state.applications||[]).slice(0,10).map(a=>({label: a.name||a.email||a.phone||'', value: (a.name||a.email||a.phone||'').toLowerCase()}));
    }
    title.textContent = `Choose a value for ${token}`;
    if (backBtn) backBtn.style.display='inline';
    list.style.display='none';
    values.innerHTML = items.map(it=>`<li class='suggest-value' data-token='${token}' data-value='${it.value}' style='padding:8px 12px;cursor:pointer;display:flex;gap:8px;align-items:center;'><span style='font-weight:600;color:#1f2937'>${it.label}</span></li>`).join('');
    values.style.display = items.length ? 'block' : 'none';
}
function autoSuggestApplications(){
    const input = document.getElementById('applicationsSearchBar');
    const val = (input?.value||'').trim();
    const m = val.match(/(name:|email:|phone:|property:|unit:|status:|movein:|submitted:)([^\s]*)$/i);
    if (!m) { renderApplicationsSuggestionTokens(); return; }
    const token = m[1].toLowerCase();
    const partial = (m[2]||'').toLowerCase();
    showApplicationsValueSuggestions(token);
    const values = document.getElementById('applicationsSuggestValues');
    if (values && partial) Array.from(values.querySelectorAll('.suggest-value')).forEach(li=>{ const v=(li.getAttribute('data-value')||'').toLowerCase(); li.style.display = v.includes(partial) ? 'flex' : 'none'; });
}
function renderFilteredApplications(){
    const { tokens, text } = getApplicationsSearch();
    const items = (state.applications||[]).filter(a=>{
        const nm = (a.name||'').toLowerCase();
        const em = (a.email||'').toLowerCase();
        const ph = (a.phone||'').toLowerCase();
        let propertyName=''; let unitNumber = a.unit || '';
        if (a.notes) { try { const n=JSON.parse(a.notes); propertyName = (n.propertyAddress||'').toLowerCase(); unitNumber = (n.unitNumber||unitNumber); } catch{} }
        const un = String(unitNumber||'').toLowerCase();
        const st = (a.status||'').toLowerCase();
        const mv = (a.moveIn||'');
        const sb = (a.submitted||'');
        const hitText = !text || nm.includes(text) || em.includes(text) || ph.includes(text) || un.includes(text) || propertyName.includes(text);
        const hitName = !tokens.nameList.length || tokens.nameList.some(v=>nm.includes(v));
        const hitEmail = !tokens.emailList.length || tokens.emailList.some(v=>em.includes(v));
        const hitPhone = !tokens.phoneList.length || tokens.phoneList.some(v=>ph.includes(v));
        const hitProp = !tokens.propertyList.length || tokens.propertyList.some(v=>propertyName.includes(v));
        const hitUnit = !tokens.unitList.length || tokens.unitList.some(v=>un.includes(v));
        const hitStatus = !tokens.statusList.length || tokens.statusList.includes(st);
        const hitMoveIn = !tokens.movein || String(mv).startsWith(tokens.movein);
        const hitSubmitted = !tokens.submitted || String(sb).startsWith(tokens.submitted);
        return hitText && hitName && hitEmail && hitPhone && hitProp && hitUnit && hitStatus && hitMoveIn && hitSubmitted;
    });
    renderApplications(items);
}

// ===== Invites Search =====
function initializeInvitesSearch() {
    const search = document.getElementById('invitesSearchBar');
    if (!search) return;
    if (search.dataset._inited === '1') return;
    search.dataset._inited = '1';
    const debouncedRender = debounce(renderFilteredInvites, 180);
    search.addEventListener('input', ()=>{ positionInvitesSearchSuggestions(); autoSuggestInvites(); showInvitesSearchSuggestions(true); debouncedRender(); });
    search.addEventListener('change', ()=>{ positionInvitesSearchSuggestions(); debouncedRender(); });
    search.addEventListener('focus', ()=>{ positionInvitesSearchSuggestions(); showInvitesSearchSuggestions(true); });
    search.addEventListener('blur', ()=> setTimeout(()=>showInvitesSearchSuggestions(false), 120));
    const clr = document.getElementById('clearInvitesFiltersBtn');
    if (clr) clr.onclick = ()=>{ search.value=''; window.__invAccumulatedQuery=''; renderFilteredInvites(); showInvitesSearchSuggestions(false); };
    const sug = document.getElementById('invitesSearchSuggestions');
    if (sug) {
        renderInvitesSuggestionTokens();
        sug.addEventListener('mousedown', (e)=>{
            const tokenEl = e.target.closest('.suggest-item');
            const valEl = e.target.closest('.suggest-value');
            e.preventDefault();
            if (tokenEl) {
                const token = tokenEl.getAttribute('data-token') || '';
                showInvitesValueSuggestions(token);
            } else if (valEl) {
                const token = valEl.getAttribute('data-token') || '';
                const value = valEl.getAttribute('data-value') || '';
                const acc = (window.__invAccumulatedQuery || '').trim();
                const sep = acc ? ' ' : '';
                window.__invAccumulatedQuery = `${acc}${sep}${token}${value}`;
                const input = document.getElementById('invitesSearchBar');
                if (input) input.value = '';
                renderFilteredInvites();
                showInvitesSearchSuggestions(false);
            }
        });
        const backBtn = document.getElementById('invitesSuggestBack');
        if (backBtn) backBtn.addEventListener('mousedown', (e)=>{ e.preventDefault(); renderInvitesSuggestionTokens(); });
    }
}

function parseInvitesSearch(queryStr) {
    const tokens = { nameList:[], emailList:[], propertyList:[], unitList:[], statusList:[], sent:'', opened:'', openedcount:'', text:'' };
    const parts = (queryStr||'').trim().split(/\s+/).filter(Boolean);
    const rest = [];
    for (const part of parts) {
        const low = part.toLowerCase();
        const take=(p)=>part.slice(p.length);
        if (low.startsWith('name:')) tokens.nameList.push(...take('name:').split(',').filter(Boolean));
        else if (low.startsWith('email:')) tokens.emailList.push(...take('email:').split(',').filter(Boolean));
        else if (low.startsWith('property:')) tokens.propertyList.push(...take('property:').split(',').filter(Boolean));
        else if (low.startsWith('unit:')) tokens.unitList.push(...take('unit:').split(',').filter(Boolean));
        else if (low.startsWith('status:')) tokens.statusList.push(...take('status:').split(',').filter(Boolean));
        else if (low.startsWith('sent:')) tokens.sent = take('sent:');
        else if (low.startsWith('opened:')) tokens.opened = take('opened:');
        else if (low.startsWith('openedcount:')) tokens.openedcount = take('openedcount:');
        else rest.push(part);
    }
    const norm=(arr)=>Array.from(new Set(arr.map(v=>String(v).trim().toLowerCase()).filter(Boolean)));
    tokens.nameList = norm(tokens.nameList);
    tokens.emailList = norm(tokens.emailList);
    tokens.propertyList = norm(tokens.propertyList);
    tokens.unitList = norm(tokens.unitList);
    tokens.statusList = norm(tokens.statusList);
    tokens.text = rest.join(' ').toLowerCase();
    return { tokens, text: tokens.text };
}

function getInvitesSearch(){
    const input = document.getElementById('invitesSearchBar');
    const current = input ? input.value : '';
    const combined = `${(window.__invAccumulatedQuery||'').trim()} ${current.trim()}`.trim();
    const query = parseInvitesSearch(combined);
    renderInvitesFilterChips(query.tokens);
    return query;
}

function renderInvitesFilterChips(tokens){
    const container = document.getElementById('invitesActiveFilterChips');
    if (!container) return;
    const mkChip = (k,v,disp)=>`<span class="filter-chip" data-key="${k}" data-value="${v}" style="display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#eef2f7;color:#374151;border:1px solid #e5e7eb;font-size:.9em;"><span style=\"color:#0b5cab;font-weight:600\">${k}</span><span>${disp ?? v}</span><button class="chip-remove" style="background:transparent;border:none;color:#6b7280;cursor:pointer;font-weight:700;"></button></span>`;
    const chips=[];
    tokens.nameList.forEach(v=>chips.push(mkChip('name:',v)));
    tokens.emailList.forEach(v=>chips.push(mkChip('email:',v)));
    tokens.propertyList.forEach(v=>chips.push(mkChip('property:',v)));
    tokens.unitList.forEach(v=>chips.push(mkChip('unit:',v)));
    tokens.statusList.forEach(v=>chips.push(mkChip('status:',v)));
    if (tokens.sent) chips.push(mkChip('sent:', tokens.sent));
    if (tokens.opened) chips.push(mkChip('opened:', tokens.opened));
    if (tokens.openedcount) chips.push(mkChip('openedcount:', tokens.openedcount));
    container.innerHTML = chips.join('');
    container.querySelectorAll('.chip-remove').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
            const chip = e.target.closest('.filter-chip');
            removeInvitesFilterToken(chip.getAttribute('data-key')||'', chip.getAttribute('data-value')||'');
        });
    });
}

function removeInvitesFilterToken(key, value){
    const input = document.getElementById('invitesSearchBar');
    const combined = `${(window.__invAccumulatedQuery||'').trim()} ${(input?.value||'').trim()}`.trim();
    const { tokens } = parseInvitesSearch(combined);
    const rem=(arr)=>{ const i=arr.findIndex(v=>v===value.toLowerCase()); if(i>=0) arr.splice(i,1); };
    switch(key){
        case 'name:': rem(tokens.nameList); break;
        case 'email:': rem(tokens.emailList); break;
        case 'property:': rem(tokens.propertyList); break;
        case 'unit:': rem(tokens.unitList); break;
        case 'status:': rem(tokens.statusList); break;
        case 'sent:': tokens.sent=''; break;
        case 'opened:': tokens.opened=''; break;
        case 'openedcount:': tokens.openedcount=''; break;
    }
    const parts=[];
    if (tokens.nameList.length) parts.push(`name:${tokens.nameList.join(',')}`);
    if (tokens.emailList.length) parts.push(`email:${tokens.emailList.join(',')}`);
    if (tokens.propertyList.length) parts.push(`property:${tokens.propertyList.join(',')}`);
    if (tokens.unitList.length) parts.push(`unit:${tokens.unitList.join(',')}`);
    if (tokens.statusList.length) parts.push(`status:${tokens.statusList.join(',')}`);
    if (tokens.sent) parts.push(`sent:${tokens.sent}`);
    if (tokens.opened) parts.push(`opened:${tokens.opened}`);
    if (tokens.openedcount) parts.push(`openedcount:${tokens.openedcount}`);
    window.__invAccumulatedQuery = parts.join(' ');
    if (input) input.value='';
    renderFilteredInvites();
}

function showInvitesSearchSuggestions(show){
    const box = document.getElementById('invitesSearchSuggestions');
    if (!box) return;
    if (show) renderInvitesSuggestionTokens();
    box.style.display = show ? 'block' : 'none';
}
function positionInvitesSearchSuggestions(){
    const bar = document.getElementById('invitesFilterBar');
    const input = document.getElementById('invitesSearchBar');
    const box = document.getElementById('invitesSearchSuggestions');
    if (!bar || !input || !box) return;
    const barRect = bar.getBoundingClientRect();
    const inRect = input.getBoundingClientRect();
    box.style.left = `${inRect.left - barRect.left}px`;
    box.style.top = `${inRect.bottom - barRect.top + 6}px`;
    box.style.minWidth = `${Math.max(inRect.width, 320)}px`;
}
function renderInvitesSuggestionTokens(){
    const list = document.getElementById('invitesSuggestList');
    const title = document.getElementById('invitesSuggestTitle');
    const values = document.getElementById('invitesSuggestValues');
    const backBtn = document.getElementById('invitesSuggestBack');
    if (!list) return;
    const tokens = ['name:','email:','property:','unit:','status:','sent:','opened:','openedcount:'];
    list.innerHTML = tokens.map(k=>`<li class='suggest-item' data-token='${k}' style='padding:8px 12px;cursor:pointer;display:flex;gap:8px;align-items:center;'><span style='font-weight:600;color:#1f2937'>${k}</span><span style='font-size:.85em;color:#6b7280'>Add ${k} filter</span></li>`).join('');
    if (title) title.textContent='Choose a filter';
    if (backBtn) backBtn.style.display='none';
    if (values) { values.style.display='none'; values.innerHTML=''; }
    list.style.display='block';
}
function showInvitesValueSuggestions(token){
    const list = document.getElementById('invitesSuggestList');
    const values = document.getElementById('invitesSuggestValues');
    const title = document.getElementById('invitesSuggestTitle');
    const backBtn = document.getElementById('invitesSuggestBack');
    if (!list || !values || !title) return;
    let items=[];
    if (token==='property:') {
        // For invite property filters, base suggestions on the Property
        // column text in the invites table (typically an address) so
        // the search aligns with what users see there.
        const rows = Array.from(document.querySelectorAll('#invitesTable tbody tr'));
        const seen = new Set();
        items = rows.map(r => {
            const label = (r.children[3]?.textContent || '').trim();
            const value = (r.dataset.property || '').toLowerCase();
            return { label, value };
        }).filter(it => {
            if (!it.label || !it.value) return false;
            if (seen.has(it.value)) return false;
            seen.add(it.value);
            return true;
        });
    }
    else if (token==='unit:') items = (state.units||[]).map(u=>({label:`${u.number}`, value:String(u.number).toLowerCase()}));
    else if (token==='status:') items = ['sent','opened','bounced','failed'].map(v=>({label:v,value:v}));
    else if (token==='sent:' || token==='opened:') {
        const now=new Date();
        items = Array.from({length:6},(_,i)=>{ const d=new Date(now.getFullYear(),now.getMonth()-i,1); const m=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; return {label:m,value:m}; });
    } else if (token==='openedcount:') {
        items = ['=0','>0','>=2','>=5'].map(v=>({label:v,value:v}));
    } else if (token==='name:' || token==='email:') {
        items = (state.invites||[]).slice(0,10).map(i=>({label:i.name||i.email||'', value:(i.name||i.email||'').toLowerCase()}));
    }
    title.textContent = `Choose a value for ${token}`;
    if (backBtn) backBtn.style.display='inline';
    list.style.display='none';
    values.innerHTML = items.map(it=>`<li class='suggest-value' data-token='${token}' data-value='${it.value}' style='padding:8px 12px;cursor:pointer;display:flex;gap:8px;align-items:center;'><span style='font-weight:600;color:#1f2937'>${it.label}</span></li>`).join('');
    values.style.display = items.length ? 'block' : 'none';
}
function autoSuggestInvites(){
    const input = document.getElementById('invitesSearchBar');
    const val = (input?.value||'').trim();
    const m = val.match(/(name:|email:|property:|unit:|status:|sent:|opened:|openedcount:)([^\s]*)$/i);
    if (!m) { renderInvitesSuggestionTokens(); return; }
    const token = m[1].toLowerCase();
    const partial = (m[2]||'').toLowerCase();
    showInvitesValueSuggestions(token);
    const values = document.getElementById('invitesSuggestValues');
    if (values && partial) Array.from(values.querySelectorAll('.suggest-value')).forEach(li=>{ const v=(li.getAttribute('data-value')||'').toLowerCase(); li.style.display = v.includes(partial) ? 'flex' : 'none'; });
}
function renderFilteredInvites(){
    const { tokens, text } = getInvitesSearch();
    const items = (state.invites||[]).filter(inv=>{
        const nm = (inv.name||'').toLowerCase();
        const em = (inv.email||'').toLowerCase();
        const prop = (inv.propertyName||'').toLowerCase();
        const un = String(inv.unitNumber||'').toLowerCase();
        const st = (inv.status||'').toLowerCase();
        const sent = String(inv.sentAt||'');
        const opened = String(inv.openedAt||'');
        const oc = Number.isFinite(inv.openCount) ? Number(inv.openCount) : 0;
        const hitText = !text || nm.includes(text) || em.includes(text) || prop.includes(text) || un.includes(text);
        const hitName = !tokens.nameList.length || tokens.nameList.some(v=>nm.includes(v));
        const hitEmail = !tokens.emailList.length || tokens.emailList.some(v=>em.includes(v));
        const hitProp = !tokens.propertyList.length || tokens.propertyList.some(v=>prop.includes(v));
        const hitUnit = !tokens.unitList.length || tokens.unitList.some(v=>un.includes(v));
        const hitStatus = !tokens.statusList.length || tokens.statusList.includes(st);
        const hitSent = !tokens.sent || sent.startsWith(tokens.sent);
        const hitOpened = !tokens.opened || opened.startsWith(tokens.opened);
        let hitOpenCount = true;
        if (tokens.openedcount) {
            const m = tokens.openedcount.match(/^(>=|<=|>|<|=)?\s*(\d+)$/);
            if (m) {
                const op = m[1] || '='; const val = Number(m[2]);
                if (op==='>') hitOpenCount = oc > val; else if (op==='>=') hitOpenCount = oc >= val; else if (op==='<') hitOpenCount = oc < val; else if (op==='<=') hitOpenCount = oc <= val; else hitOpenCount = oc === val;
            }
        }
        return hitText && hitName && hitEmail && hitProp && hitUnit && hitStatus && hitSent && hitOpened && hitOpenCount;
    });
    renderInvites(items);
}

// ===== Portfolio Tenants Search =====
function initializePortfolioTenantsSearch() {
    const search = document.getElementById('portfolioTenantsSearchBar');
    if (!search) return;
    if (search.dataset._inited === '1') return;
    search.dataset._inited = '1';
    const debouncedRender = debounce(renderFilteredPortfolioTenants, 200);
    search.addEventListener('input', () => {
        positionPortfolioTenantsSearchSuggestions();
        autoSuggestPortfolioTenants();
        showPortfolioTenantsSearchSuggestions(true);
        debouncedRender();
    });
    search.addEventListener('change', () => {
        positionPortfolioTenantsSearchSuggestions();
        debouncedRender();
    });
    search.addEventListener('focus', () => {
        positionPortfolioTenantsSearchSuggestions();
        showPortfolioTenantsSearchSuggestions(true);
    });
    search.addEventListener('blur', () => setTimeout(() => showPortfolioTenantsSearchSuggestions(false), 120));

    const clr = document.getElementById('clearPortfolioTenantsFiltersBtn');
    if (clr) clr.onclick = () => {
        search.value = '';
        window.__portfolioTenantsAccumulatedQuery = '';
        renderFilteredPortfolioTenants();
        showPortfolioTenantsSearchSuggestions(false);
    };

    const sug = document.getElementById('portfolioTenantsSearchSuggestions');
    if (sug) {
        renderPortfolioTenantsSuggestionTokens();
        sug.addEventListener('mousedown', (e) => {
            const tokenEl = e.target.closest('.suggest-item');
            const valEl = e.target.closest('.suggest-value');
            e.preventDefault();
            if (tokenEl) {
                const token = tokenEl.getAttribute('data-token') || '';
                showPortfolioTenantsValueSuggestions(token);
            } else if (valEl) {
                const token = valEl.getAttribute('data-token') || '';
                const value = valEl.getAttribute('data-value') || '';
                const acc = (window.__portfolioTenantsAccumulatedQuery || '').trim();
                const sep = acc ? ' ' : '';
                window.__portfolioTenantsAccumulatedQuery = `${acc}${sep}${token}${value}`;
                const input = document.getElementById('portfolioTenantsSearchBar');
                if (input) input.value = '';
                renderFilteredPortfolioTenants();
                showPortfolioTenantsSearchSuggestions(false);
            }
        });
        const backBtn = document.getElementById('portfolioTenantsSuggestBack');
        if (backBtn) backBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            renderPortfolioTenantsSuggestionTokens();
        });
    }
}

function parsePortfolioTenantsSearch(queryStr) {
    const tokens = { nameList: [], emailList: [], phoneList: [], propertyList: [], unitList: [], statusList: [], text: '' };
    const parts = (queryStr || '').trim().split(/\s+/).filter(Boolean);
    const rest = [];
    for (const part of parts) {
        const low = part.toLowerCase();
        const take = (pfx) => part.slice(pfx.length);
        if (low.startsWith('name:')) tokens.nameList.push(...take('name:').split(',').filter(Boolean));
        else if (low.startsWith('email:')) tokens.emailList.push(...take('email:').split(',').filter(Boolean));
        else if (low.startsWith('phone:')) tokens.phoneList.push(...take('phone:').split(',').filter(Boolean));
        else if (low.startsWith('property:')) tokens.propertyList.push(...take('property:').split(',').filter(Boolean));
        else if (low.startsWith('unit:')) tokens.unitList.push(...take('unit:').split(',').filter(Boolean));
        else if (low.startsWith('status:')) tokens.statusList.push(...take('status:').split(',').filter(Boolean));
        else rest.push(part);
    }
    const norm = (arr) => Array.from(new Set(arr.map(v => String(v).trim().toLowerCase()).filter(Boolean)));
    tokens.nameList = norm(tokens.nameList);
    tokens.emailList = norm(tokens.emailList);
    tokens.phoneList = norm(tokens.phoneList);
    tokens.propertyList = norm(tokens.propertyList);
    tokens.unitList = norm(tokens.unitList);
    tokens.statusList = norm(tokens.statusList);
    tokens.text = rest.join(' ').toLowerCase();
    return { tokens, text: tokens.text };
}

function getPortfolioTenantsSearch() {
    const input = document.getElementById('portfolioTenantsSearchBar');
    const current = input ? input.value : '';
    const combined = `${(window.__portfolioTenantsAccumulatedQuery || '').trim()} ${current.trim()}`.trim();
    const query = parsePortfolioTenantsSearch(combined);
    renderPortfolioTenantsFilterChips(query.tokens);
    return query;
}

function renderPortfolioTenantsFilterChips(tokens) {
    const container = document.getElementById('portfolioTenantsActiveFilterChips');
    if (!container) return;
    const mkChip = (k, v, disp) =>
        `<span class="filter-chip" data-key="${k}" data-value="${v}" style="display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#eef2f7;color:#374151;border:1px solid #e5e7eb;font-size:.85em;"><span style="color:#0b5cab;font-weight:600">${k}</span><span>${disp ?? v}</span><button class="chip-remove" style="background:transparent;border:none;color:#6b7280;cursor:pointer;font-weight:700;"></button></span>`;
    const chips = [];
    tokens.nameList.forEach(v => chips.push(mkChip('name:', v)));
    tokens.emailList.forEach(v => chips.push(mkChip('email:', v)));
    tokens.phoneList.forEach(v => chips.push(mkChip('phone:', v)));
    tokens.propertyList.forEach(v => chips.push(mkChip('property:', v)));
    tokens.unitList.forEach(v => chips.push(mkChip('unit:', v)));
    tokens.statusList.forEach(v => chips.push(mkChip('status:', v)));
    container.innerHTML = chips.join('');
    container.querySelectorAll('.chip-remove').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const chip = e.target.closest('.filter-chip');
            removePortfolioTenantsFilterToken(chip.getAttribute('data-key') || '', chip.getAttribute('data-value') || '');
        });
    });
}

function removePortfolioTenantsFilterToken(key, value) {
    const input = document.getElementById('portfolioTenantsSearchBar');
    const combined = `${(window.__portfolioTenantsAccumulatedQuery || '').trim()} ${(input?.value || '').trim()}`.trim();
    const { tokens } = parsePortfolioTenantsSearch(combined);
    const rem = (arr) => {
        const i = arr.findIndex(v => v === value.toLowerCase());
        if (i >= 0) arr.splice(i, 1);
    };
    switch (key) {
        case 'name:': rem(tokens.nameList); break;
        case 'email:': rem(tokens.emailList); break;
        case 'phone:': rem(tokens.phoneList); break;
        case 'property:': rem(tokens.propertyList); break;
        case 'unit:': rem(tokens.unitList); break;
        case 'status:': rem(tokens.statusList); break;
    }
    const parts = [];
    if (tokens.nameList.length) parts.push(`name:${tokens.nameList.join(',')}`);
    if (tokens.emailList.length) parts.push(`email:${tokens.emailList.join(',')}`);
    if (tokens.phoneList.length) parts.push(`phone:${tokens.phoneList.join(',')}`);
    if (tokens.propertyList.length) parts.push(`property:${tokens.propertyList.join(',')}`);
    if (tokens.unitList.length) parts.push(`unit:${tokens.unitList.join(',')}`);
    if (tokens.statusList.length) parts.push(`status:${tokens.statusList.join(',')}`);
    window.__portfolioTenantsAccumulatedQuery = parts.join(' ');
    if (input) input.value = '';
    renderFilteredPortfolioTenants();
}

function showPortfolioTenantsSearchSuggestions(show) {
    const box = document.getElementById('portfolioTenantsSearchSuggestions');
    if (!box) return;
    if (show) renderPortfolioTenantsSuggestionTokens();
    box.style.display = show ? 'block' : 'none';
}

function positionPortfolioTenantsSearchSuggestions() {
    const bar = document.getElementById('portfolioTenantsFilterBar');
    const input = document.getElementById('portfolioTenantsSearchBar');
    const box = document.getElementById('portfolioTenantsSearchSuggestions');
    if (!bar || !input || !box) return;
    const barRect = bar.getBoundingClientRect();
    const inRect = input.getBoundingClientRect();
    box.style.left = `${inRect.left - barRect.left}px`;
    box.style.top = `${inRect.bottom - barRect.top + 6}px`;
    box.style.minWidth = `${Math.max(inRect.width, 260)}px`;
}

function renderPortfolioTenantsSuggestionTokens() {
    const list = document.getElementById('portfolioTenantsSuggestList');
    const title = document.getElementById('portfolioTenantsSuggestTitle');
    const values = document.getElementById('portfolioTenantsSuggestValues');
    const backBtn = document.getElementById('portfolioTenantsSuggestBack');
    if (!list) return;
    const tokens = ['name:', 'email:', 'phone:', 'property:', 'unit:', 'status:'];
    list.innerHTML = tokens.map(k =>
        `<li class='suggest-item' data-token='${k}' style='padding:8px 12px;cursor:pointer;display:flex;gap:8px;align-items:center;'><span style='font-weight:600;color:#1f2937'>${k}</span><span style='font-size:.85em;color:#6b7280'>Add ${k} filter</span></li>`
    ).join('');
    if (title) title.textContent = 'Choose a filter';
    if (backBtn) backBtn.style.display = 'none';
    if (values) {
        values.style.display = 'none';
        values.innerHTML = '';
    }
    list.style.display = 'block';
}

function showPortfolioTenantsValueSuggestions(token) {
    const list = document.getElementById('portfolioTenantsSuggestList');
    const values = document.getElementById('portfolioTenantsSuggestValues');
    const title = document.getElementById('portfolioTenantsSuggestTitle');
    const backBtn = document.getElementById('portfolioTenantsSuggestBack');
    if (!list || !values || !title) return;
    let items = [];
    if (token === 'property:') {
        items = (state.properties || []).map(p => ({ label: p.name, value: (p.name || '').toLowerCase() }));
    } else if (token === 'unit:') {
        items = (state.allUnits || []).map(u => ({ label: `${u.number || u.unitNumber || ''}`, value: String(u.number || u.unitNumber || '').toLowerCase() }));
    } else if (token === 'status:') {
        items = ['active', 'pending', 'expired', 'terminated'].map(v => ({ label: v, value: v }));
    } else if (token === 'name:' || token === 'email:' || token === 'phone:') {
        items = (state.allTenants || []).slice(0, 12).map(t => {
            const base = token === 'name:'
                ? (t.fullName || t.name || `${t.firstName || ''} ${t.lastName || ''}`.trim())
                : token === 'email:'
                    ? (t.email || t.tenantEmail || '')
                    : (t.phone || t.tenantPhone || '');
            return { label: base, value: base.toLowerCase() };
        }).filter(it => it.label);
    }
    title.textContent = `Choose a value for ${token}`;
    if (backBtn) backBtn.style.display = 'inline';
    list.style.display = 'none';
    values.innerHTML = items.map(it =>
        `<li class='suggest-value' data-token='${token}' data-value='${it.value}' style='padding:8px 12px;cursor:pointer;display:flex;gap:8px;align-items:center;'><span style='font-weight:600;color:#1f2937'>${it.label}</span></li>`
    ).join('');
    values.style.display = items.length ? 'block' : 'none';
}

function autoSuggestPortfolioTenants() {
    const input = document.getElementById('portfolioTenantsSearchBar');
    const val = (input?.value || '').trim();
    const m = val.match(/(name:|email:|phone:|property:|unit:|status:)([^\s]*)$/i);
    if (!m) {
        renderPortfolioTenantsSuggestionTokens();
        return;
    }
    const token = m[1].toLowerCase();
    const partial = (m[2] || '').toLowerCase();
    showPortfolioTenantsValueSuggestions(token);
    const values = document.getElementById('portfolioTenantsSuggestValues');
    if (values && partial) {
        Array.from(values.querySelectorAll('.suggest-value')).forEach(li => {
            const v = (li.getAttribute('data-value') || '').toLowerCase();
            li.style.display = v.includes(partial) ? 'flex' : 'none';
        });
    }
}

// Inline edit helper for portfolio tenants table
function enterPortfolioTenantEditMode(row, tenant) {
    if (!row || !tenant) return;
    const tenantIdStr = String(tenant._id || '');
    if (!tenantIdStr) return;
    if (state.currentEditingPortfolioTenantId && state.currentEditingPortfolioTenantId !== tenantIdStr) return;
    if (row.dataset.editing === 'true') return;
    state.currentEditingPortfolioTenantId = tenantIdStr;
    row.dataset.editing = 'true';

    const cells = row.querySelectorAll('td');
    const nameCell = cells[2];
    const phoneCell = cells[3];
    const emailCell = cells[4];
    const datesCell = cells[5];
    const statusCell = cells[6];

    const makeInput = (type, value) => {
        const input = document.createElement('input');
        input.type = type;
        input.className = 'app-inline-input';
        input.value = value || '';
        return input;
    };

    const name = tenant.fullName || tenant.name || `${tenant.firstName || ''} ${tenant.lastName || ''}`.trim();
    const phoneVal = tenant.phone || tenant.tenantPhone || '';
    const emailVal = tenant.email || tenant.tenantEmail || '';
    const statusVal = tenant.leaseStatus || 'active';

    const leaseStartRaw = tenant.leaseStart || '';
    const leaseEndRaw = tenant.leaseEnd || '';
    const toInputDate = (val) => {
        if (!val) return '';
        const s = String(val);
        const m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (m) return `${m[1]}-${m[2]}-${m[3]}`;
        const d = new Date(val);
        if (isNaN(d.getTime())) return '';
        const y = d.getFullYear();
        const mo = String(d.getMonth() + 1).padStart(2, '0');
        const da = String(d.getDate()).padStart(2, '0');
        return `${y}-${mo}-${da}`;
    };

    const nameInput = makeInput('text', name || '');
    const phoneInput = makeInput('text', phoneVal || '');
    const emailInput = makeInput('email', emailVal || '');

    const statusSelect = document.createElement('select');
    statusSelect.className = 'app-inline-input';
    ['active', 'pending', 'expired', 'terminated'].forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val.charAt(0).toUpperCase() + val.slice(1);
        if (String(statusVal || 'active').toLowerCase() === val) opt.selected = true;
        statusSelect.appendChild(opt);
    });

    if (nameCell) { nameCell.innerHTML = ''; nameCell.appendChild(nameInput); }
    if (phoneCell) { phoneCell.innerHTML = ''; phoneCell.appendChild(phoneInput); }
    if (emailCell) { emailCell.innerHTML = ''; emailCell.appendChild(emailInput); }
    if (datesCell) {
        datesCell.innerHTML = '';
        const startInput = makeInput('date', toInputDate(leaseStartRaw));
        const endInput = makeInput('date', toInputDate(leaseEndRaw));
        startInput.style.maxWidth = '140px';
        endInput.style.maxWidth = '140px';
        datesCell.appendChild(startInput);
        const sep = document.createElement('span');
        sep.textContent = '  ';
        sep.style.margin = '0 4px';
        datesCell.appendChild(sep);
        datesCell.appendChild(endInput);
        row.__leaseStartInput = startInput;
        row.__leaseEndInput = endInput;
    }
    if (statusCell) { statusCell.innerHTML = ''; statusCell.appendChild(statusSelect); }

    const saveChanges = async () => {
        const propertyId = tenant.projectId || tenant.propertyId;
        if (!propertyId) {
            state.currentEditingPortfolioTenantId = null;
            showNotification('Cannot update tenant: missing property id', 'error');
            renderPortfolioDetails('tenants');
            return;
        }

        const leaseStartInput = row.__leaseStartInput;
        const leaseEndInput = row.__leaseEndInput;
        const leaseStartVal = leaseStartInput ? leaseStartInput.value : '';
        const leaseEndVal = leaseEndInput ? leaseEndInput.value : '';

        const payload = {
            name: nameInput.value.trim() || name || '',
            phone: phoneInput.value.trim(),
            email: emailInput.value.trim(),
            leaseStatus: statusSelect.value || statusVal || 'active',
            leaseStart: leaseStartVal ? dateInputToISOAtNoon(leaseStartVal) : tenant.leaseStart,
            leaseEnd: leaseEndVal ? dateInputToISOAtNoon(leaseEndVal) : tenant.leaseEnd
        };

        
        try {
            const resp = await fetch(`${API_URL}/properties/${propertyId}/tenants/${tenantIdStr}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!resp.ok) throw new Error('Failed to update tenant');

            const updatedTenant = { ...tenant, ...payload };
            if (Array.isArray(state.tenants)) {
                state.tenants = state.tenants.map(t => String(t._id) === tenantIdStr ? updatedTenant : t);
            }
            if (Array.isArray(state.allTenants)) {
                state.allTenants = state.allTenants.map(t => String(t._id) === tenantIdStr ? updatedTenant : t);
            }
            state.currentEditingPortfolioTenantId = null;
            showNotification('Tenant updated', 'success');
            renderPortfolioDetails('tenants');
        } catch (err) {
            console.error('Inline portfolio tenant update error:', err);
            state.currentEditingPortfolioTenantId = null;
            showNotification('Could not update tenant', 'error');
            renderPortfolioDetails('tenants');
       
        }
    };

    const handleDocClick = (ev) => {
        const target = ev.target;
        if (row.contains(target)) return;
        if (!document.body.contains(row)) {
            document.removeEventListener('click', handleDocClick, true);
            return;
        }
        document.removeEventListener('click', handleDocClick, true);
        saveChanges();
    };

    document.addEventListener('click', handleDocClick, true);
}

// Inline edit helper for portfolio maintenance table
function enterPortfolioMaintenanceEditMode(row, request) {
    if (!row || !request) return;
    const requestIdStr = String(request._id || '');
    if (!requestIdStr) return;
    if (state.currentEditingPortfolioMaintenanceId && state.currentEditingPortfolioMaintenanceId !== requestIdStr) return;
    if (row.dataset.editing === 'true') return;
    state.currentEditingPortfolioMaintenanceId = requestIdStr;
    row.dataset.editing = 'true';

    const cells = row.querySelectorAll('td');
    const summaryCell = cells[3];
    const statusCell = cells[4];

    const summaryInput = document.createElement('textarea');
    summaryInput.className = 'app-inline-input';
    summaryInput.style.resize = 'vertical';
    summaryInput.style.minHeight = '32px';
    summaryInput.style.overflow = 'hidden';
    summaryInput.value = request.summary || request.description || '';

    const autoResize = () => {
        summaryInput.style.height = 'auto';
        summaryInput.style.height = summaryInput.scrollHeight + 'px';
    };

    summaryInput.addEventListener('input', autoResize);

    if (summaryCell) {
        summaryCell.innerHTML = '';
        summaryCell.appendChild(summaryInput);
        autoResize();
        summaryInput.focus();
        summaryInput.select && summaryInput.select();
    }

    const existingStatusSelect = statusCell ? statusCell.querySelector('select.portfolio-maint-status-select') : null;
    if (existingStatusSelect) {
        existingStatusSelect.classList.add('app-inline-input');
    }

    const saveChanges = async () => {
        const requestId = requestIdStr;
        let projectId = row.dataset.projectId;
        if (!projectId) {
            const req = (state.portfolioMaintenance || []).find(r => String(r._id) === String(requestId));
            if (req) {
                projectId = (req.projectId && req.projectId._id) ? req.projectId._id : req.projectId;
            }
        }

        if (!projectId) {
            state.currentEditingPortfolioMaintenanceId = null;
            showNotification('Cannot update maintenance: missing property id', 'error');
            renderPortfolioDetails('maintenance');
            return;
        }

        const newSummary = summaryInput.value.trim();

        try {
            const payload = { summary: newSummary };
            const res = await fetch(`${API_URL}/properties/${projectId}/maintenance/${requestId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('Failed to update maintenance request');

            if (Array.isArray(state.portfolioMaintenance)) {
                state.portfolioMaintenance = state.portfolioMaintenance.map(r =>
                    String(r._id) === String(requestId) ? { ...r, ...payload } : r
                );
            }

            state.currentEditingPortfolioMaintenanceId = null;
            showNotification('Maintenance request updated', 'success');
            renderPortfolioDetails('maintenance');
        } catch (err) {
            console.error('Inline portfolio maintenance update error:', err);
            state.currentEditingPortfolioMaintenanceId = null;
            showNotification('Could not update maintenance request', 'error');
            renderPortfolioDetails('maintenance');
        }
    };

    const handleDocClick = (ev) => {
        const target = ev.target;
        if (row.contains(target)) return;
        if (!document.body.contains(row)) {
            document.removeEventListener('click', handleDocClick, true);
            return;
        }
        document.removeEventListener('click', handleDocClick, true);
        saveChanges();
    };

    document.addEventListener('click', handleDocClick, true);
}

// Inline edit helper for portfolio applications in portfolio overview
function enterPortfolioApplicationEditMode(row, app) {
    if (!row || !app) return;
    const appIdStr = String(app._id || '');
    if (!appIdStr) return;
    if (state.currentEditingPortfolioApplicationId && state.currentEditingPortfolioApplicationId !== appIdStr) return;
    if (row.dataset.editing === 'true') return;
    state.currentEditingPortfolioApplicationId = appIdStr;
    row.dataset.editing = 'true';

    const cells = row.querySelectorAll('td');
    const nameCell = cells[1];
    const emailCell = cells[2];
    const propertyCell = cells[3];
    const unitCell = cells[4];
    const statusCell = cells[5];

    let propertyAddress = '';
    let unitNumber = app.unit || '';
    if (app.notes) {
        try {
            const n = JSON.parse(app.notes);
            propertyAddress = n.propertyAddress || '';
            unitNumber = n.unitNumber || unitNumber;
        } catch {}
    }

    const makeInput = (type, cls, value) => {
        const input = document.createElement('input');
        input.type = type;
        input.className = cls;
        input.value = value || '';
        return input;
    };

    const nameInput = makeInput('text', 'app-inline-input app-inline-name', app.name || '');
    const emailInput = makeInput('email', 'app-inline-input app-inline-email', app.email || '');
    const propertyInput = makeInput('text', 'app-inline-input app-inline-property', propertyAddress || '');
    const unitInput = makeInput('text', 'app-inline-input app-inline-unit', unitNumber || '');

    const statusSelect = document.createElement('select');
    statusSelect.className = 'app-inline-input app-inline-status';
    ['pending','approved','rejected'].forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val.charAt(0).toUpperCase() + val.slice(1);
        if ((app.status || 'pending') === val) opt.selected = true;
        statusSelect.appendChild(opt);
    });

    if (nameCell) { nameCell.innerHTML = ''; nameCell.appendChild(nameInput); }
    if (emailCell) { emailCell.innerHTML = ''; emailCell.appendChild(emailInput); }
    if (propertyCell) { propertyCell.innerHTML = ''; propertyCell.appendChild(propertyInput); }
    if (unitCell) { unitCell.innerHTML = ''; unitCell.appendChild(unitInput); }
    if (statusCell) { statusCell.innerHTML = ''; statusCell.appendChild(statusSelect); }

    const saveChanges = async () => {
        let notesObj = {};
        if (app.notes) {
            try {
                const existing = JSON.parse(app.notes);
                if (existing && typeof existing === 'object') notesObj = existing;
            } catch {}
        }
        notesObj.propertyAddress = propertyInput.value.trim();
        notesObj.unitNumber = unitInput.value.trim();
        const notesString = JSON.stringify(notesObj);

        const payload = {
            name: nameInput.value.trim(),
            email: emailInput.value.trim(),
            phone: app.phone || '',
            unit: unitInput.value.trim(),
            status: statusSelect.value || app.status || 'pending',
            moveIn: app.moveIn || undefined,
            notes: notesString
        };

        try {
            const res = await fetch(`/api/rental-applications/${app._id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('Failed to update application');
            const updated = await res.json();
            const appData = updated.application || updated;
            state.applications = (state.applications || []).map(a => String(a._id) === String(app._id) ? appData : a);
            state.currentEditingPortfolioApplicationId = null;
            showNotification('Application updated', 'success');
            renderPortfolioDetails('applications');
        } catch (err) {
            console.error('Inline portfolio application update error:', err);
            state.currentEditingPortfolioApplicationId = null;
            showNotification('Could not update application', 'error');
            renderPortfolioDetails('applications');
        }
    };

    const handleDocClick = (ev) => {
        const target = ev.target;
        if (row.contains(target)) return;
        if (!document.body.contains(row)) {
            document.removeEventListener('click', handleDocClick, true);
            return;
        }
        document.removeEventListener('click', handleDocClick, true);
        saveChanges();
    };

    document.addEventListener('click', handleDocClick, true);
}

// Inline edit helper for portfolio invites in portfolio overview
function enterPortfolioInviteEditMode(row, invite) {
    if (!row || !invite) return;
    const inviteIdStr = String(invite._id || '');
    if (!inviteIdStr) return;
    if (state.currentEditingPortfolioInviteId && state.currentEditingPortfolioInviteId !== inviteIdStr) return;
    if (row.dataset.editing === 'true') return;
    state.currentEditingPortfolioInviteId = inviteIdStr;
    row.dataset.editing = 'true';

    const cells = row.querySelectorAll('td');
    const nameCell = cells[1];
    const emailCell = cells[2];
    const propertyCell = cells[3];
    const unitCell = cells[4];
    const statusCell = cells[5];

    const makeInput = (type, cls, value) => {
        const input = document.createElement('input');
        input.type = type;
        input.className = cls;
        input.value = value || '';
        return input;
    };

    const nameInput = makeInput('text', 'app-inline-input', invite.name || '');
    const emailInput = makeInput('email', 'app-inline-input', invite.email || '');
    const propertyInput = makeInput('text', 'app-inline-input', invite.propertyName || '');
    const unitInput = makeInput('text', 'app-inline-input', invite.unitNumber || '');

    const statusSelect = document.createElement('select');
    statusSelect.className = 'app-inline-input';
    ['sent', 'opened', 'completed', 'expired'].forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val.charAt(0).toUpperCase() + val.slice(1);
        if ((invite.status || 'sent') === val) opt.selected = true;
        statusSelect.appendChild(opt);
    });

    if (nameCell) { nameCell.innerHTML = ''; nameCell.appendChild(nameInput); }
    if (emailCell) { emailCell.innerHTML = ''; emailCell.appendChild(emailInput); }
    if (propertyCell) { propertyCell.innerHTML = ''; propertyCell.appendChild(propertyInput); }
    if (unitCell) { unitCell.innerHTML = ''; unitCell.appendChild(unitInput); }
    if (statusCell) { statusCell.innerHTML = ''; statusCell.appendChild(statusSelect); }

    const saveInviteChanges = async () => {
        const payload = {
            name: nameInput.value.trim(),
            email: emailInput.value.trim(),
            propertyName: propertyInput.value.trim(),
            unitNumber: unitInput.value.trim(),
            status: statusSelect.value || 'sent',
            applicationUrl: invite.applicationUrl || ''
        };

        try {
            const res = await fetch(`/api/application-invites/${invite._id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('Failed to update invite');
            const updated = await res.json();
            const invData = updated.invite || updated;
            state.invites = (state.invites || []).map(x => String(x._id) === String(invite._id) ? invData : x);
            state.currentEditingPortfolioInviteId = null;
            showNotification('Invite updated', 'success');
            // Preserve current Applications vs Invites filter when re-rendering
            state.keepPortfolioTypeFilterOnNextRender = true;
            renderPortfolioDetails('applications');
        } catch (err) {
            console.error('Inline portfolio invite update error:', err);
            state.currentEditingPortfolioInviteId = null;
            showNotification('Could not update invite', 'error');
            // Also preserve filter on error-triggered re-render
            state.keepPortfolioTypeFilterOnNextRender = true;
            renderPortfolioDetails('applications');
        }
    };

    const handleDocClick = (ev) => {
        const target = ev.target;
        if (row.contains(target)) return;
        if (!document.body.contains(row)) {
            document.removeEventListener('click', handleDocClick, true);
            return;
        }
        document.removeEventListener('click', handleDocClick, true);
        saveInviteChanges();
    };

    document.addEventListener('click', handleDocClick, true);
}

function renderFilteredPortfolioTenants() {
    const tbody = document.getElementById('portfolioTenantsTbody');
    if (!tbody) return;
    const { tokens, text } = getPortfolioTenantsSearch();
    const propsById = (state.properties || []).reduce((map, p) => {
        map[String(p._id)] = p;
        return map;
    }, {});
    const unitsById = (state.allUnits || []).reduce((map, u) => {
        if (u && u._id) map[String(u._id)] = u;
        return map;
    }, {});

    const items = (state.allTenants || []).filter(t => {
        const name = (t.fullName || t.name || `${t.firstName || ''} ${t.lastName || ''}`.trim()).toLowerCase();
        const phone = (t.phone || t.tenantPhone || '').toLowerCase();
        const email = (t.email || t.tenantEmail || '').toLowerCase();
        const unitId = t.unitId?._id || t.unitId;
        let unitLabel = t.unitNumber || t.unit || '';
        if (unitId && unitsById[String(unitId)]) {
            const u = unitsById[String(unitId)];
            unitLabel = (u.number || u.unitNumber || u.name || u.label || '').toString();
        }
        const unit = (unitLabel || '').toLowerCase();
        const pid = t.projectId || t.propertyId;
        const propName = pid && propsById[String(pid)] ? (propsById[String(pid)].name || '') : '';
        const prop = propName.toLowerCase();
        const status = (t.leaseStatus || '').toLowerCase();

        const hitText = !text || name.includes(text) || phone.includes(text) || email.includes(text) || unit.includes(text) || prop.includes(text) || status.includes(text);
        const hitName = !tokens.nameList.length || tokens.nameList.some(v => name.includes(v));
        const hitEmail = !tokens.emailList.length || tokens.emailList.some(v => email.includes(v));
        const hitPhone = !tokens.phoneList.length || tokens.phoneList.some(v => phone.includes(v));
        const hitProp = !tokens.propertyList.length || tokens.propertyList.some(v => prop.includes(v));
        const hitUnit = !tokens.unitList.length || tokens.unitList.some(v => unit.includes(v));
        const hitStatus = !tokens.statusList.length || tokens.statusList.includes(status);
        return hitText && hitName && hitEmail && hitPhone && hitProp && hitUnit && hitStatus;
    });

    const rowsHtml = items.map(t => {
        const name = t.fullName || t.name || `${t.firstName || ''} ${t.lastName || ''}`.trim() || 'Tenant';
        const unitId = t.unitId?._id || t.unitId;
        let unitLabel = '';
        if (unitId && unitsById[String(unitId)]) {
            const u = unitsById[String(unitId)];
            unitLabel = u.number || u.unitNumber || u.name || u.label || '';
        } else {
            unitLabel = t.unitNumber || t.unit || '';
        }
        const pid = t.projectId || t.propertyId;
        const propName = pid && propsById[String(pid)] ? propsById[String(pid)].name : '';
        const phone = t.phone || t.tenantPhone || '';
        const email = t.email || t.tenantEmail || '';
        const leaseStart = t.leaseStart ? new Date(t.leaseStart).toLocaleDateString() : '';
        const leaseEnd = t.leaseEnd ? new Date(t.leaseEnd).toLocaleDateString() : '';
        const status = t.leaseStatus || 'unknown';
        const notesCount = Array.isArray(t.notesHistory) ? t.notesHistory.length : 0;
        const notesBadge = `<button class="portfolio-tenant-notes-link" data-tenant-id="${t._id}" style="background:none;border:none;padding:0;margin:0;font:inherit;cursor:pointer;">
                <span style="display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#4f46e5;font-size:0.8rem;">
                    <i class=\"fas fa-sticky-note\"></i>
                    ${notesCount}
                </span>
            </button>`;
        return `
            <tr data-tenant-id="${t._id}">
                <td>${propName}</td>
                <td>${unitLabel}</td>
                <td>${name}</td>
                <td>${phone}</td>
                <td>${email}</td>
                <td>${leaseStart} - ${leaseEnd}</td>
                <td>${status}</td>
                <td>${notesBadge}</td>
            </tr>`;
    }).join('');

    tbody.innerHTML = rowsHtml || '<tr><td colspan="8" style="font-size:0.86rem;color:#6b7280;">No tenants match your filters.</td></tr>';

    // Wire row click to open inline edit mode for portfolio tenants
    Array.from(tbody.querySelectorAll('tr[data-tenant-id]')).forEach(row => {
        row.addEventListener('click', (e) => {
            const target = e.target;
            if (target.closest('a') || target.closest('.portfolio-tenant-notes-link') || target.closest('input') || target.closest('select')) return;
            if (row.dataset.editing === 'true') return;
            const id = row.getAttribute('data-tenant-id');
            if (!id) return;
            const tenant = (state.allTenants || []).find(t => String(t._id) === String(id));
            if (!tenant) return;
            enterPortfolioTenantEditMode(row, tenant);
        });
    });

    // Wire tenant notes badge clicks to open shared notes drawer (if backend supports tenant notes)
    tbody.querySelectorAll('.portfolio-tenant-notes-link').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const id = btn.getAttribute('data-tenant-id');
            if (!id) return;
            // Reuse application notes drawer context pattern if tenant notes endpoints exist in the API
            if (typeof openNotesDrawerForTenant === 'function') {
                openNotesDrawerForTenant(id);
            } else {
                const tenant = (state.allTenants || []).find(t => String(t._id) === String(id));
                if (!tenant) return;
                const { root, overlay, closeBtn, titleEl, subtitleEl, inputEl } = getNotesDrawerElements();
                if (!root) return;
                state.notesDrawerContext = { type: 'tenant', id };
                if (titleEl) titleEl.textContent = 'Tenant Notes';
                if (subtitleEl) subtitleEl.textContent = `${tenant.fullName || tenant.name || ''}  ${tenant.email || tenant.tenantEmail || ''}`.trim();
                renderNotesDrawerMessages(tenant.notesHistory || []);
                root.classList.add('open');
                if (inputEl) {
                    inputEl.value = '';
                    setTimeout(() => inputEl.focus(), 50);
                }
                if (overlay) overlay.onclick = () => closeNotesDrawer();
                if (closeBtn) closeBtn.onclick = () => closeNotesDrawer();
            }
        });
    });
}

// ===== Shared Portfolio Details Search (rent, maintenance, leases, vacancy) =====
function initializePortfolioDetailsSearch() {
    const search = document.getElementById('portfolioDetailsSearchBar');
    if (!search) return;
    if (search.dataset._inited === '1') return;
    search.dataset._inited = '1';

    const debouncedRender = debounce(renderFilteredPortfolioDetailsRows, 200);

    search.addEventListener('input', () => {
        positionPortfolioDetailsSearchSuggestions();
        autoSuggestPortfolioDetails();
        showPortfolioDetailsSearchSuggestions(true);
        debouncedRender();
    });
    search.addEventListener('change', () => {
        positionPortfolioDetailsSearchSuggestions();
        debouncedRender();
    });
    search.addEventListener('focus', () => {
        positionPortfolioDetailsSearchSuggestions();
        showPortfolioDetailsSearchSuggestions(true);
    });
    search.addEventListener('blur', () => setTimeout(() => showPortfolioDetailsSearchSuggestions(false), 120));

    const clr = document.getElementById('clearPortfolioDetailsFiltersBtn');
    if (clr) clr.onclick = () => {
        search.value = '';
        window.__portfolioDetailsAccumulatedQuery = '';
        renderFilteredPortfolioDetailsRows();
        showPortfolioDetailsSearchSuggestions(false);
    };

    const sug = document.getElementById('portfolioDetailsSearchSuggestions');
    if (sug) {
        renderPortfolioDetailsSuggestionTokens();
        sug.addEventListener('mousedown', (e) => {
            const tokenEl = e.target.closest('.suggest-item');
            const valEl = e.target.closest('.suggest-value');
            e.preventDefault();
            if (tokenEl) {
                const token = tokenEl.getAttribute('data-token') || '';
                showPortfolioDetailsValueSuggestions(token);
            } else if (valEl) {
                const token = valEl.getAttribute('data-token') || '';
                const value = valEl.getAttribute('data-value') || '';
                const acc = (window.__portfolioDetailsAccumulatedQuery || '').trim();
                const sep = acc ? ' ' : '';
                window.__portfolioDetailsAccumulatedQuery = `${acc}${sep}${token}${value}`;
                const input = document.getElementById('portfolioDetailsSearchBar');
                if (input) input.value = '';
                renderFilteredPortfolioDetailsRows();
                showPortfolioDetailsSearchSuggestions(false);
            }
        });
        const backBtn = document.getElementById('portfolioDetailsSuggestBack');
        if (backBtn) backBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            renderPortfolioDetailsSuggestionTokens();
        });
    }
}

function parsePortfolioDetailsSearch(queryStr) {
    const tokens = { nameList: [], propertyList: [], unitList: [], statusList: [], typeList: [], balanceFlags: [], text: '' };
    const parts = (queryStr || '').trim().split(/\s+/).filter(Boolean);
    const rest = [];
    for (const part of parts) {
        const low = part.toLowerCase();
        const take = (pfx) => part.slice(pfx.length);
        if (low.startsWith('name:')) tokens.nameList.push(...take('name:').split(',').filter(Boolean));
        else if (low.startsWith('property:')) tokens.propertyList.push(...take('property:').split(',').filter(Boolean));
        else if (low.startsWith('unit:')) tokens.unitList.push(...take('unit:').split(',').filter(Boolean));
        else if (low.startsWith('status:')) tokens.statusList.push(...take('status:').split(',').filter(Boolean));
        else if (low.startsWith('type:')) tokens.typeList.push(...take('type:').split(',').filter(Boolean));
        else if (low.startsWith('balance:')) tokens.balanceFlags.push(...take('balance:').split(',').filter(Boolean));
        else rest.push(part);
    }
    const norm = (arr) => Array.from(new Set(arr.map(v => String(v).trim().toLowerCase()).filter(Boolean)));
    tokens.nameList = norm(tokens.nameList);
    tokens.propertyList = norm(tokens.propertyList);
    tokens.unitList = norm(tokens.unitList);
    tokens.statusList = norm(tokens.statusList);
    tokens.typeList = norm(tokens.typeList);
    tokens.balanceFlags = norm(tokens.balanceFlags);
    tokens.text = rest.join(' ').toLowerCase();
    return { tokens, text: tokens.text };
}

function getPortfolioDetailsSearch() {
    const input = document.getElementById('portfolioDetailsSearchBar');
    const current = input ? input.value : '';
    const combined = `${(window.__portfolioDetailsAccumulatedQuery || '').trim()} ${current.trim()}`.trim();
    const query = parsePortfolioDetailsSearch(combined);
    renderPortfolioDetailsFilterChips(query.tokens);
    return query;
}

function renderPortfolioDetailsFilterChips(tokens) {
    const container = document.getElementById('portfolioDetailsActiveFilterChips');
    if (!container) return;
    const isRentDetails = state.currentPortfolioDetailsType === 'rent';
    const mkChip = (k, v, disp) =>
        `<span class="filter-chip" data-key="${k}" data-value="${v}" style="display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#eef2f7;color:#374151;border:1px solid #e5e7eb;font-size:.85em;"><span style="color:#0b5cab;font-weight:600">${k}</span><span>${disp ?? v}</span><button class="chip-remove" style="background:transparent;border:none;color:#6b7280;cursor:pointer;font-weight:700;"></button></span>`;
    const chips = [];
    tokens.nameList.forEach(v => chips.push(mkChip('name:', v)));
    tokens.propertyList.forEach(v => chips.push(mkChip('property:', v)));
    tokens.unitList.forEach(v => chips.push(mkChip('unit:', v)));
    tokens.statusList.forEach(v => chips.push(mkChip('status:', v)));
    tokens.typeList.forEach(v => chips.push(mkChip('type:', v)));
    if (isRentDetails) {
        tokens.balanceFlags.forEach(v => {
            const label = v === 'with-balance' ? 'with balance only' : v;
            chips.push(mkChip('balance:', v, label));
        });
    }
    container.innerHTML = chips.join('');
    container.querySelectorAll('.chip-remove').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const chip = e.target.closest('.filter-chip');
            removePortfolioDetailsFilterToken(chip.getAttribute('data-key') || '', chip.getAttribute('data-value') || '');
        });
    });
}

function removePortfolioDetailsFilterToken(key, value) {
    const input = document.getElementById('portfolioDetailsSearchBar');
    const combined = `${(window.__portfolioDetailsAccumulatedQuery || '').trim()} ${(input?.value || '').trim()}`.trim();
    const { tokens } = parsePortfolioDetailsSearch(combined);
    const rem = (arr) => {
        const i = arr.findIndex(v => v === value.toLowerCase());
        if (i >= 0) arr.splice(i, 1);
    };
    switch (key) {
        case 'name:': rem(tokens.nameList); break;
        case 'property:': rem(tokens.propertyList); break;
        case 'unit:': rem(tokens.unitList); break;
        case 'status:': rem(tokens.statusList); break;
        case 'type:': rem(tokens.typeList); break;
        case 'balance:': rem(tokens.balanceFlags); break;
    }
    const parts = [];
    if (tokens.nameList.length) parts.push(`name:${tokens.nameList.join(',')}`);
    if (tokens.propertyList.length) parts.push(`property:${tokens.propertyList.join(',')}`);
    if (tokens.unitList.length) parts.push(`unit:${tokens.unitList.join(',')}`);
    if (tokens.statusList.length) parts.push(`status:${tokens.statusList.join(',')}`);
    if (tokens.typeList.length) parts.push(`type:${tokens.typeList.join(',')}`);
    if (tokens.balanceFlags.length) parts.push(`balance:${tokens.balanceFlags.join(',')}`);
    window.__portfolioDetailsAccumulatedQuery = parts.join(' ');
    if (input) input.value = '';
    renderFilteredPortfolioDetailsRows();
}

function showPortfolioDetailsSearchSuggestions(show) {
    const box = document.getElementById('portfolioDetailsSearchSuggestions');
    if (!box) return;
    if (show) renderPortfolioDetailsSuggestionTokens();
    box.style.display = show ? 'block' : 'none';
}

function positionPortfolioDetailsSearchSuggestions() {
    const bar = document.getElementById('portfolioDetailsFilterBar');
    const input = document.getElementById('portfolioDetailsSearchBar');
    const box = document.getElementById('portfolioDetailsSearchSuggestions');
    if (!bar || !input || !box) return;
    const barRect = bar.getBoundingClientRect();
    const inRect = input.getBoundingClientRect();
    box.style.left = `${inRect.left - barRect.left}px`;
    box.style.top = `${inRect.bottom - barRect.top + 6}px`;
    box.style.minWidth = `${Math.max(inRect.width, 260)}px`;
}

function renderPortfolioDetailsSuggestionTokens() {
    const list = document.getElementById('portfolioDetailsSuggestList');
    const title = document.getElementById('portfolioDetailsSuggestTitle');
    const values = document.getElementById('portfolioDetailsSuggestValues');
    const backBtn = document.getElementById('portfolioDetailsSuggestBack');
    if (!list) return;
    const isRentDetails = state.currentPortfolioDetailsType === 'rent';
    const tokens = isRentDetails
        ? ['name:', 'property:', 'unit:', 'status:', 'type:', 'balance:']
        : ['name:', 'property:', 'unit:', 'status:', 'type:'];
    list.innerHTML = tokens.map(k =>
        `<li class='suggest-item' data-token='${k}' style='padding:8px 12px;cursor:pointer;display:flex;gap:8px;align-items:center;'><span style='font-weight:600;color:#1f2937'>${k}</span><span style='font-size:.85em;color:#6b7280'>Add ${k} filter</span></li>`
    ).join('');
    if (title) title.textContent = 'Choose a filter';
    if (backBtn) backBtn.style.display = 'none';
    if (values) {
        values.style.display = 'none';
        values.innerHTML = '';
    }
    list.style.display = 'block';
}

function showPortfolioDetailsValueSuggestions(token) {
    const list = document.getElementById('portfolioDetailsSuggestList');
    const values = document.getElementById('portfolioDetailsSuggestValues');
    const title = document.getElementById('portfolioDetailsSuggestTitle');
    const backBtn = document.getElementById('portfolioDetailsSuggestBack');
    if (!list || !values || !title) return;
    let items = [];
    if (token === 'property:') {
        // For Applications & Invites (Portfolio), derive property values from the
        // current table rows so filters use the actual address text that is shown
        // in the "Property" column instead of the internal property name.
        if (state.currentPortfolioDetailsType === 'applications') {
            const bodyRows = Array.from(document.querySelectorAll('#portfolioDetailsTbody tr'));
            const seen = new Set();
            items = bodyRows.map(r => {
                const label = (r.children[3]?.textContent || '').trim();
                const value = (r.dataset.property || '').toLowerCase();
                return { label, value };
            }).filter(it => {
                if (!it.label || !it.value) return false;
                if (seen.has(it.value)) return false;
                seen.add(it.value);
                return true;
            });
        } else {
            items = (state.properties || []).map(p => ({ label: p.name, value: (p.name || '').toLowerCase() }));
        }
    } else if (token === 'unit:') {
        items = (state.allUnits || []).map(u => ({ label: `${u.number || u.unitNumber || ''}`, value: String(u.number || u.unitNumber || '').toLowerCase() }));
    } else if (token === 'status:') {
        // Gather statuses from current rows if possible, otherwise fall back to common set
        const bodyRows = Array.from(document.querySelectorAll('#portfolioDetailsTbody tr'));
        const set = new Set();
        bodyRows.forEach(r => { if (r.dataset.status) set.add(r.dataset.status.toLowerCase()); });
        if (!set.size) ['active','pending','expired','terminated','vacant','in-progress','completed'].forEach(v => set.add(v));
        // Ensure lease/move-in specific statuses are always available in the
        // Leases & Upcoming Move-ins (Next 60 Days) portfolio view, even if
        // no current rows happen to have that status.
        if (state.currentPortfolioDetailsType === 'leases') {
            ['lease-expiring','upcoming-movein','past-movein'].forEach(v => set.add(v));
        }
        const mapStatusLabel = (v) => {
            if (v === 'past-movein') return 'Moved-in (already)';
            if (v === 'upcoming-movein') return 'Upcoming move-in';
            if (v === 'lease-expiring') return 'Lease expiring';
            return v;
        };
        items = Array.from(set).map(v => ({ label: mapStatusLabel(v), value: v }));
    } else if (token === 'name:') {
        items = (state.allTenants || []).slice(0, 12).map(t => {
            const base = t.fullName || t.name || `${t.firstName || ''} ${t.lastName || ''}`.trim();
            return { label: base, value: (base || '').toLowerCase() };
        }).filter(it => it.label);
    } else if (token === 'type:') {
        const bodyRows = Array.from(document.querySelectorAll('#portfolioDetailsTbody tr'));
        const set = new Set();
        bodyRows.forEach(r => { if (r.dataset.type) set.add(r.dataset.type.toLowerCase()); });
        if (!set.size) ['rent','maintenance','lease expiring','upcoming move-in','vacancy'].forEach(v => set.add(v));
        items = Array.from(set).map(v => ({ label: v, value: v }));
    } else if (token === 'balance:') {
        // Simple static options for rent view only
        if (state.currentPortfolioDetailsType === 'rent') {
            items = [
                { label: 'With balance only', value: 'with-balance' },
                { label: 'No balance', value: 'no-balance' }
            ];
        } else {
            items = [];
        }
    }
    title.textContent = `Choose a value for ${token}`;
    if (backBtn) backBtn.style.display = 'inline';
    list.style.display = 'none';
    values.innerHTML = items.map(it =>
        `<li class='suggest-value' data-token='${token}' data-value='${it.value}' style='padding:8px 12px;cursor:pointer;display:flex;gap:8px;align-items:center;'><span style='font-weight:600;color:#1f2937'>${it.label}</span></li>`
    ).join('');
    values.style.display = items.length ? 'block' : 'none';
}

function autoSuggestPortfolioDetails() {
    const input = document.getElementById('portfolioDetailsSearchBar');
    const val = (input?.value || '').trim();
    const m = val.match(/(name:|property:|unit:|status:|type:|balance:)([^\s]*)$/i);
    if (!m) {
        renderPortfolioDetailsSuggestionTokens();
        return;
    }
    const token = m[1].toLowerCase();
    const partial = (m[2] || '').toLowerCase();
    showPortfolioDetailsValueSuggestions(token);
    const values = document.getElementById('portfolioDetailsSuggestValues');
    if (values && partial) {
        Array.from(values.querySelectorAll('.suggest-value')).forEach(li => {
            const v = (li.getAttribute('data-value') || '').toLowerCase();
            li.style.display = v.includes(partial) ? 'flex' : 'none';
        });
    }
}

function renderFilteredPortfolioDetailsRows() {
    const tbody = document.getElementById('portfolioDetailsTbody');
    if (!tbody) return;
    const { tokens, text } = getPortfolioDetailsSearch();
    const isRentDetails = state.currentPortfolioDetailsType === 'rent';
    let anyVisible = false;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    Array.from(rows).forEach(row => {
        const prop = (row.dataset.property || '').toLowerCase();
        const unit = (row.dataset.unit || '').toLowerCase();
        const name = (row.dataset.name || '').toLowerCase();
        const status = (row.dataset.status || '').toLowerCase();
        const type = (row.dataset.type || '').toLowerCase();
        const balance = (row.dataset.balance || '').toLowerCase();
        const textContent = (row.textContent || '').toLowerCase();

        const hitText = !text || textContent.includes(text) || prop.includes(text) || unit.includes(text) || name.includes(text) || status.includes(text) || type.includes(text);
        const hitName = !tokens.nameList.length || tokens.nameList.some(v => name.includes(v));
        const hitProp = !tokens.propertyList.length || tokens.propertyList.some(v => prop.includes(v));
        const hitUnit = !tokens.unitList.length || tokens.unitList.some(v => unit.includes(v));
        const hitStatus = !tokens.statusList.length || tokens.statusList.includes(status);
        const hitType = !tokens.typeList.length || tokens.typeList.some(v => type.includes(v));
        // Only apply balance filters on the rent (Tenants with Outstanding Balance) view
        const hitBalance = !isRentDetails || !tokens.balanceFlags.length || tokens.balanceFlags.includes(balance);

        const show = hitText && hitName && hitProp && hitUnit && hitStatus && hitType && hitBalance;
        row.style.display = show ? '' : 'none';
        if (show) anyVisible = true;
    });

    // If this is the vacancy view, update the total rent footer based on visible rows
    const tfoot = document.getElementById('portfolioDetailsTfoot');
    const totalCell = document.getElementById('portfolioVacancyTotalRent');
    if (tfoot && totalCell) {
        let total = 0;
        rows.forEach(row => {
            if (row.style.display === 'none') return;
            const rentCell = row.children[4];
            if (!rentCell) return;
            const text = rentCell.textContent.replace(/[^0-9.\-]/g,'');
            const val = Number(text) || 0;
            total += val;
        });
        totalCell.textContent = `$${total.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0})}`;
    }

    // Optional: could display a "no results" message row if none visible.
}

// Tab Management
function initializeTabs() {
    const tabs = document.querySelectorAll('.tab-btn');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            const tabId = tab.getAttribute('data-tab');
            // Track current active tab
            state.currentTab = tabId;
            showTabContent(tabId);
            loadTabContent(tabId);
        });
    });
    // Initialize currentTab based on any pre-marked active tab button
    const activeBtn = document.querySelector('.tab-btn.active');
    if (activeBtn) {
        state.currentTab = activeBtn.getAttribute('data-tab') || 'units';
    }
}

document.getElementById('leaseType').addEventListener('change', function() {
    document.getElementById('fmrSection').style.display = this.value === 'fmr' ? 'block' : 'none';
    document.getElementById('section8Section').style.display = this.value === 'section8' ? 'flex' : 'none';
});

function showTabContent(tabId) {
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    
    const selectedPane = document.getElementById(tabId);
    if (selectedPane) {
        selectedPane.classList.add('active');
    }
}

function updateTabCounts() {
    // Units
    document.getElementById('tabCountUnits').textContent = state.units?.length || 0;
    // Tenants (only active or pending)
    const activeOrPendingTenants = (state.tenants || []).filter(
        t => t.leaseStatus === 'active' || t.leaseStatus === 'pending'
    );
    document.getElementById('tabCountTenants').textContent = activeOrPendingTenants.length;
    // Documents
    document.getElementById('tabCountDocuments').textContent = state.documents?.length || 0;
    // Payments
    document.getElementById('tabCountPayments').textContent = state.payments?.length || 0;
    // Applications
    const appsBadge = document.getElementById('tabCountApplications');
    const appsAllCount = state.applications?.length || 0;
    if (appsBadge) appsBadge.textContent = appsAllCount;
    // Mirror PENDING applications count into top toolbar icon
    const pendingAppsCount = (state.applications || []).filter(a => (a.status || 'pending') === 'pending').length;
    const topApps = document.getElementById('topApplicationsCount');
    if (topApps) topApps.textContent = pendingAppsCount > 99 ? '99+' : pendingAppsCount;
}

async function loadTabContent(tabId, force = false) {
    if (!state.currentProperty) return;

    try {
        switch(tabId) {
            case 'units':
                await loadUnits(state.currentProperty._id, force);
                break;
            case 'tenants':
                await loadTenants(state.currentProperty._id, force);
                break;
            case 'maintenance':
                await loadMaintenanceRequests(state.currentProperty._id, force);
                await loadMaintenanceSchedules(); 
                break;
            case 'documents':
                await loadDocuments(state.currentProperty._id, force);
                break;
                        case 'payments':
                await loadPayments(state.currentProperty._id, force);
                break;
            case 'applications':
                await loadApplications(force);
                await loadInvites(force);
                break;
        }
    } catch (error) {
        console.error(`Error loading ${tabId} content:`, error);
        showNotification(`Error loading ${tabId}`, 'error');
    }
}

// Universal refresh that bypasses cache for the active or specified tab
async function refreshContent(section) {
    const target = section || state.currentTab || 'units';
    await loadTabContent(target, true);
}

// Property Management
async function loadProperties() {
    showLoader();
    try {
        // Fetch property datasets in parallel
        const [response, completedRes, onMarketRes] = await Promise.all([
            fetch('/api/projects'),
            fetch('/api/completed-projects'),
            fetch('/api/on-market-projects').catch(() => ({ ok: false }))
        ]);

        if (!response.ok) throw new Error('Failed to fetch projects');
        if (!completedRes.ok) throw new Error('Failed to fetch completed projects');

        const [data, completedData] = await Promise.all([
            response.json(),
            completedRes.json()
        ]);

        // Only multifamily properties
        const activeProperties = data.projects.filter(project =>
            project.type?.toLowerCase() === 'multifamily'
        );

        const completedProperties = (completedData.projects || []).filter(project =>
            project.type?.toLowerCase() === 'multifamily'
        );

        // --- Fetch "On Market" properties ---
        if (onMarketRes && onMarketRes.ok) {
            const onMarketData = await onMarketRes.json();
            state.onMarketProperties = (onMarketData.projects || []).filter(project =>
                project.type?.toLowerCase() === 'multifamily'
            );
            console.log('On Market Properties:', state.onMarketProperties);
        } else {
            state.onMarketProperties = [];
        }

        // Combine all lists: active, completed, and on market
        state.properties = [...activeProperties, ...completedProperties, ...state.onMarketProperties];

        renderPropertyList();

        // Defer summary prefetching to avoid blocking first paint
        runWhenIdle(() => {
            loadAllUnitsAndTenants().catch(() => {});
        });

        // Do not auto-select a property; default landing is portfolio overview
    } catch (error) {
        console.error('Error loading properties:', error);
        showNotification('Error loading properties', 'error');
    } finally {
        hideLoader();
    }
}
 

// Update the formatAddress function
function formatAddress(address) {
    // Debug log to see the address structure
    console.log('Address object:', address);
    
    // Return early if no address
    if (!address) return 'No address provided';

    // Check if the address is in the expected format
    if (typeof address === 'object') {
        const addressLines = [];

        // Add line1 if exists
        if (address.line1 || address.addressLine1) {
            addressLines.push(address.line1 || address.addressLine1);
        }

        // Add line2 if exists and not empty
        if ((address.line2 || address.addressLine2) && (address.line2?.trim() || address.addressLine2?.trim())) {
            addressLines.push(address.line2 || address.addressLine2);
        }

        // Add city, state, zip
        const cityLine = [
            address.city,
            address.state,
            address.zip
        ].filter(Boolean).join(', ');
        
        if (cityLine) {
            addressLines.push(cityLine);
        }

        // Join with line breaks
        return addressLines.join('<br>');
    }

    // If address is a string, return as is
    if (typeof address === 'string') {
        return address;
    }

    return 'No address provided';
}

// Update renderPropertyList to handle the address properly
function renderPropertyList() {
    const propertyList = document.getElementById('propertyList');
    const overviewTile = `
        <div class="property-item property-overview-item" onclick="openPortfolioOverview()">
            <h3><i class="fas fa-chart-pie" style="margin-right:6px;"></i> Portfolio Overview</h3>
            <div class="property-address">
                <i class="fas fa-layer-group"></i>
                <div class="address-text">All properties combined</div>
            </div>
        </div>`;

    if (!state.properties.length) {
        propertyList.innerHTML = overviewTile + `
            <div class="empty-state">
                <i class="fas fa-building"></i>
                <p>No multifamily properties found</p>
            </div>`;
        return;
    }

    const propertiesHtml = state.properties.map(property => {
        const isActive = state.currentProperty && state.currentProperty._id === property._id;
        const unitsForProperty = (state.allUnits || []).filter(u => {
            const pid = u.projectId || u.propertyId || u.project; // projectId populated in loadAllUnitsAndTenants
            return pid && String(pid) === String(property._id);
        });
        const totalUnits = unitsForProperty.length;
        const vacantUnits = unitsForProperty.filter(u => u.status === 'vacant').length;
        const occupancyRate = totalUnits ? calculateOccupancyRate(unitsForProperty) : '--';
        const vacantLabel = totalUnits ? `${vacantUnits} vacant` : '--';
        
        return `
            <div class="property-item ${isActive ? 'active' : ''}" 
                 onclick="selectProperty('${property._id}')">
                <h3>${property.name}</h3>
                <div class="property-address">
                    <i class="fas fa-map-marker-alt"></i>
                    <div class="address-text">${formatAddress(property.address)}</div>
                </div>
                <div class="property-badges">
                    <span class="property-type">
                        <i class="fas fa-building"></i> ${property.type || 'Multifamily'}
                    </span>
                  <span class="property-status ${property.status?.toLowerCase().replace(/\s+/g, '-') || ''}">
                 <i class="fas fa-circle"></i> ${property.status || 'Active'}
                 </span>
                </div>
                <div class="property-stats">
                    <span class="property-stat" title="Occupancy rate for this property">
                        <i class="fas fa-user-check" aria-hidden="true"></i>
                        <span>${occupancyRate}</span>
                    </span>
                    <span class="property-stat" title="Number of vacant units for this property">
                        <i class="fas fa-door-open" aria-hidden="true"></i>
                        <span>${vacantLabel}</span>
                    </span>
                </div>
            </div>
        `;
    }).join('');

    propertyList.innerHTML = overviewTile + propertiesHtml;
}

async function selectProperty(propertyId) {
    showLoader();
    try {
        state.currentProperty = state.properties.find(p => p._id === propertyId);
        if (!state.currentProperty) throw new Error('Property not found');

        // Ensure property dashboard is visible when a property is selected
        const dashboard = document.getElementById('propertyDashboard');
        const portfolioSection = document.getElementById('portfolioOverviewSection');
        if (dashboard) dashboard.style.display = '';
        if (portfolioSection) portfolioSection.style.display = 'none';

        document.getElementById('propertyName').textContent = state.currentProperty.name;
        
        // Load critical data first for faster perceived load
        await Promise.all([
            loadUnits(propertyId),
            loadTenants(propertyId)
        ]);

        // Defer non-critical tab data to idle time
        runWhenIdle(() => loadDocuments(propertyId).catch(() => {}));
        runWhenIdle(() => loadPayments(propertyId).catch(() => {}));
        runWhenIdle(() => loadMaintenanceRequests(propertyId).catch(() => {}));
        runWhenIdle(() => loadMaintenanceSchedules(propertyId).catch(() => {}));
        
        updatePropertyStats();
        showNotification('Property loaded successfully', 'success');

            // Re-render the property list to update the active class
        renderPropertyList();

                const sidebar = document.querySelector('.sidebar');
        if (window.innerWidth <= 900 && sidebar.classList.contains('visible')) {
            sidebar.classList.remove('visible');
        }

    } catch (error) {
        console.error('Error selecting property:', error);
        showNotification('Error loading property details', 'error');
            } finally {
        hideLoader();
    }
}

// Update the loadUnits function
async function loadUnits(propertyId, force = false) {
    
    try {
        if (!force && shouldUseCache('units', propertyId)) {
            renderUnits();
            updatePropertyStats();
            populateUnitSelect();
            populateMaintenanceUnitSelect();
            updateTabCounts();
            return;
        }
        const response = await fetch(`${API_URL}/properties/${propertyId}/units`);
        if (!response.ok) throw new Error('Failed to fetch units');
        
        const data = await response.json();
        // Update this line to correctly access units from the response
        state.units = data.property.units || [];
        console.log('Loaded units:', state.units); // Debug log

        renderUnits();
        updatePropertyStats(); // Update stats after loading units
        populateUnitSelect();
         populateMaintenanceUnitSelect();
         updateTabCounts(); 
        touchCache('units', propertyId);

    } catch (error) {
        console.error('Error loading units:', error);
        showNotification('Error loading units', 'error');

    }
}

// Update the renderUnits function
function renderUnits() {
    const unitsGrid = document.getElementById('unitsGrid');
    if (!state.units || state.units.length === 0) {
        unitsGrid.innerHTML = `
            <div class="empty-state">
                <p>No units found. Add your first unit!</p>
            </div>`;
        return;
    }

    // Utility icons for visual clarity
    const utilityIcons = {
        water: '<i class="fas fa-tint" style="color:#3498db"></i>',
        gas: '<i class="fas fa-fire" style="color:#e67e22"></i>',
        electricity: '<i class="fas fa-bolt" style="color:#f1c40f"></i>'
    };

    unitsGrid.innerHTML = state.units.map(unit => {
        // Utility account info
        const utilities = ['water', 'gas', 'electricity'].map(type => {
            const acc = unit.utilityAccounts?.[type] || {};
            let statusBadge = '';
            if (acc.status === 'active') {
                statusBadge = `<span class="badge badge-success">Active</span>`;
            } else if (acc.status === 'disconnected') {
                statusBadge = `<span class="badge badge-danger">Disconnected</span>`;
            } else {
                statusBadge = `<span class="badge badge-default">N/A</span>`;
            }
            return `
                <div class="unit-utility-row">
                    ${utilityIcons[type]}
                    <span class="utility-label">${type.charAt(0).toUpperCase() + type.slice(1)}</span>
                    <span class="utility-account">Acct: <strong>${acc.accountNumber || 'N/A'}</strong></span>
                    <span class="utility-provider">${acc.provider || 'N/A'}</span>
                    <span class="utility-under">Bill: <strong>${acc.under ? acc.under.charAt(0).toUpperCase() + acc.under.slice(1) : 'N/A'}</strong></span>
                    ${statusBadge}
                </div>
            `;
        }).join('');

        // Status badge
        let statusBadge = '';
        if (unit.status === 'occupied') {
            statusBadge = `<span class="badge badge-success">Occupied</span>`;
        } else if (unit.status === 'vacant') {
            statusBadge = `<span class="badge badge-warning">Vacant</span>`;
        } else if (unit.status === 'maintenance') {
            statusBadge = `<span class="badge badge-danger">Maintenance</span>`;
        } else {
            statusBadge = `<span class="badge badge-default">${unit.status || 'N/A'}</span>`;
        }

        return `
            <div class="unit-card-modern">
                <div class="unit-card-header">
                    <h3>Unit ${unit.number}</h3>
                    ${statusBadge}
                </div>
                <div class="unit-card-body">
                    <div class="unit-info-row">
                        <span><i class="fas fa-layer-group"></i> Floor: <strong>${unit.floor || '1'}</strong></span>
                        <span><i class="fas fa-bed"></i> ${unit.bedrooms} Bed</span>
                        <span><i class="fas fa-bath"></i> ${unit.bathrooms} Bath</span>
                        <span><i class="fas fa-ruler-combined"></i> ${unit.sqft ? `${unit.sqft} sqft` : 'N/A'}</span>
                    </div>
                    <div class="unit-utilities-section">
                        <div class="unit-utilities-title"><i class="fas fa-plug"></i> Utilities</div>
                        ${utilities}
                    </div>
                </div>
                <div class="unit-card-actions">
                    <button onclick="editUnit('${unit._id}')" class="btn-secondary"><i class="fas fa-edit"></i> Edit</button>
                    <button onclick="viewUnitDetails('${unit._id}')" class="btn-secondary"><i class="fas fa-eye"></i> Details</button>
                    <button onclick="deleteUnit('${unit._id}')" class="btn-icon delete-btn" title="Delete Unit"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `;
    }).join('');
}

// Utility Functions
function formatAddress(address) {
    if (!address) return 'No address provided';
    
    const parts = [];
    if (address.line1) parts.push(address.line1);
    if (address.city) parts.push(address.city);
    if (address.state) parts.push(address.state);
    if (address.zip) parts.push(address.zip);
    
    return parts.join(', ') || 'No address provided';
}

// --- Date Helpers to avoid off-by-one (timezone) issues ---
// Convert an <input type="date"> value (YYYY-MM-DD) to an ISO string at local noon
function dateInputToISOAtNoon(dateStr) {
    if (!dateStr) return '';
    const parts = dateStr.split('-');
    if (parts.length !== 3) return dateStr;
    const y = Number(parts[0]);
    const m = Number(parts[1]);
    const d = Number(parts[2]);
    const dt = new Date(y, m - 1, d, 12, 0, 0, 0); // local noon avoids day shifting
    return dt.toISOString();
}

// Safer display formatter: prefer YYYY-MM-DD prefix if present; else render in UTC to avoid shift
function formatDateDisplay(value, locale = 'en-US') {
    if (!value) return '';
    const s = String(value);
    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (m) {
        const y = Number(m[1]);
        const mo = Number(m[2]);
        const d = Number(m[3]);
        return new Date(y, mo - 1, d).toLocaleDateString(locale);
    }
    try {
        const d = new Date(value);
        // Render using UTC so midnight UTC doesn't shift date in local TZ
        return d.toLocaleDateString(locale, { timeZone: 'UTC' });
    } catch {
        return s;
    }
}

// --- Rent proration helpers (frontend) ---
// Mirrors server-side behavior: only first month gets prorated, and only base rent is prorated.
// Additionally, no base rent is expected for months that fall completely outside the lease range
// (before leaseStart or after leaseEnd).
function daysInMonth(year, monthIndex) {
    return new Date(year, monthIndex + 1, 0).getDate();
}

// Returns the expected base rent for the given month for a tenant,
// applying proration in the first lease month only. Does NOT include additional monthly fees.
function computeExpectedBaseRentForMonth(tenant, dateLike) {
    const baseRent = Number(tenant?.baseRent) || 0;
    const ref = dateLike ? new Date(dateLike) : new Date();
    const leaseStart = tenant?.leaseStart ? new Date(tenant.leaseStart) : null;
    const leaseEnd = tenant?.leaseEnd ? new Date(tenant.leaseEnd) : null;

    // If we have lease bounds, and this entire month falls outside of them,
    // do not expect any base rent for this month.
    if (leaseStart || leaseEnd) {
        const monthStart = new Date(ref.getFullYear(), ref.getMonth(), 1);
        const monthEnd = new Date(ref.getFullYear(), ref.getMonth() + 1, 0);

        if (leaseStart && monthEnd < leaseStart) {
            return 0;
        }
        if (leaseEnd && monthStart > leaseEnd) {
            return 0;
        }
    }

    // If there's no leaseStart, but we're within (or we don't know) the lease range,
    // use the full base rent for the month (no proration info available).
    if (!leaseStart) return baseRent;

    const sameMonth =
        ref.getFullYear() === leaseStart.getFullYear() &&
        ref.getMonth() === leaseStart.getMonth();

    if (!sameMonth) return baseRent;

    // First lease month: prorate by days remaining in month starting on leaseStart day
    const totalDays = daysInMonth(leaseStart.getFullYear(), leaseStart.getMonth());
    const startDay = leaseStart.getDate();
    // Days remaining including the start day (e.g., start on 15th in 30-day month => 16 days: 15..30)
    const daysRemaining = Math.max(0, totalDays - startDay + 1);
    return +(baseRent * (daysRemaining / totalDays)).toFixed(2);
}


// Property Management Handlers
async function handleAddProperty(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const propertyData = {
        name: formData.get('name'),
        type: 'Multifamily',
        address: {
            line1: formData.get('addressLine1'),
            line2: formData.get('addressLine2'),
            city: formData.get('city'),
            state: formData.get('state'),
            zip: formData.get('zip')
        }
    };
showLoader();
    try {
        const response = await fetch(`${API_URL}/projects`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(propertyData)
        });

        if (!response.ok) throw new Error('Failed to add property');
        
        const newProperty = await response.json();
        state.properties.push(newProperty);
        renderPropertyList();
        closeModal('addPropertyModal');
        showNotification('Property added successfully', 'success');
        event.target.reset();
    } catch (error) {
        console.error('Error adding property:', error);
        showNotification('Error adding property', 'error');
            } finally {
        hideLoader();
    }
}

// Unit Management Handlers
async function editUnit(unitId) {
    try {
        const unit = state.units.find(u => u._id === unitId);
        if (!unit) throw new Error('Unit not found');

        // Populate the edit form
        document.getElementById('unitNumber').value = unit.number || '';
        document.getElementById('unitFloor').value = unit.floor || 1;
        document.getElementById('unitBedrooms').value = unit.bedrooms || '';
        document.getElementById('unitBathrooms').value = unit.bathrooms || '';
        document.getElementById('unitSqft').value = unit.sqft || '';
        const rentInput = document.getElementById('unitRent');
        if (rentInput) rentInput.value = typeof unit.rent === 'number' ? unit.rent : '';
        document.getElementById('unitStatus').value = unit.status || 'vacant';

        // Populate amenities/features checklist
        const amenities = unit.amenities || [];
        document.querySelectorAll('#unitAmenitiesChecklist input[type="checkbox"]').forEach(cb => {
            cb.checked = amenities.includes(cb.value);
        });

        // Populate utility account fields
        const acc = unit.utilityAccounts || {};
        const water = acc.water || {};
        const gas = acc.gas || {};
        const electricity = acc.electricity || {};

        document.getElementById('waterAccountNumber').value = water.accountNumber || '';
        document.getElementById('waterProvider').value = water.provider || '';
        document.getElementById('waterStatus').value = water.status || '';
        document.getElementById('waterUnder').value = water.under || '';

        document.getElementById('gasAccountNumber').value = gas.accountNumber || '';
        document.getElementById('gasProvider').value = gas.provider || '';
        document.getElementById('gasStatus').value = gas.status || '';
        document.getElementById('gasUnder').value = gas.under || '';

        document.getElementById('electricityAccountNumber').value = electricity.accountNumber || '';
        document.getElementById('electricityProvider').value = electricity.provider || '';
        document.getElementById('electricityStatus').value = electricity.status || '';
        document.getElementById('electricityUnder').value = electricity.under || '';

        // Open the modal in edit mode
        openModal('addUnitModal');

        // Set form to edit mode and store unitId
        const form = document.getElementById('addUnitForm');
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.textContent = 'Update Unit';
        form.dataset.editMode = 'true';
        form.dataset.unitId = unitId;

        // Remove any previous submit event listeners (if any)
        form.removeEventListener('submit', handleAddUnit);
        // Add a one-time submit handler for update
        form.onsubmit = async function(e) {
            e.preventDefault();
            await handleUpdateUnit(unitId);
        };
    } catch (error) {
        console.error('Error editing unit:', error);
        showNotification('Error editing unit', 'error');
    }
}

async function handleUpdateUnit(unitId) {
    if (!state.currentProperty) {
        showNotification('Please select a property first', 'error');
        return;
    }

    // Collect amenities/features from checklist
    const amenities = Array.from(document.querySelectorAll('#unitAmenitiesChecklist input[type="checkbox"]:checked'))
        .map(cb => cb.value);

    const unitData = {
        number: document.getElementById('unitNumber').value,
        floor: Number(document.getElementById('unitFloor').value),
        sqft: Number(document.getElementById('unitSqft').value),
        rent: Number(document.getElementById('unitRent')?.value) || 0,
        bedrooms: Number(document.getElementById('unitBedrooms').value),
        bathrooms: Number(document.getElementById('unitBathrooms').value),
        status: document.getElementById('unitStatus').value,
        amenities, // <-- Add amenities array
        utilityAccounts: {
            water: {
                accountNumber: document.getElementById('waterAccountNumber').value,
                provider: document.getElementById('waterProvider').value,
                status: document.getElementById('waterStatus').value,
                under: document.getElementById('waterUnder').value
            },
            gas: {
                accountNumber: document.getElementById('gasAccountNumber').value,
                provider: document.getElementById('gasProvider').value,
                status: document.getElementById('gasStatus').value,
                under: document.getElementById('gasUnder').value
            },
            electricity: {
                accountNumber: document.getElementById('electricityAccountNumber').value,
                provider: document.getElementById('electricityProvider').value,
                status: document.getElementById('electricityStatus').value,
                under: document.getElementById('electricityUnder').value
            }
        }
    };

    // Validate required fields
    if (!unitData.number || !unitData.bedrooms || !unitData.bathrooms) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }

    showLoader();

    try {
        const response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/units/${unitId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(unitData)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to update unit');
        }

        // Reset form and close modal
        const form = document.getElementById('addUnitForm');
        form.reset();
        form.dataset.editMode = 'false';
        form.dataset.unitId = '';
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.textContent = 'Add Unit';

        // Restore the add handler and remove the custom update handler
        form.onsubmit = handleAddUnit;

    invalidateCache('units');
    await refreshContent('units');
        closeModal('addUnitModal');
        showNotification('Unit updated successfully', 'success');
    } catch (error) {
        console.error('Error updating unit:', error);
        showNotification(error.message || 'Error updating unit', 'error');
    } finally {
        hideLoader();
    }
}

function viewUnitDetails(unitId) {
    const unit = state.units.find(u => u._id === unitId);
    if (!unit) {
        showNotification('Unit not found', 'error');
        return;
    }

    // Set the current unit ID for export
    state.currentUnitId = unitId;

    // Utility account info and bills
    const utilities = [
        { type: 'Water', key: 'water' },
        { type: 'Gas', key: 'gas' },
        { type: 'Electricity', key: 'electricity' }
    ];

    // Amenities/features checklist
    const amenitiesList = [
        { key: 'washerDryer', label: 'Washer & Dryer' },
        { key: 'washerDryerHookup', label: 'Washer/Dryer Hookup' },
        { key: 'centralAC', label: 'Central AC/Heat' },
        { key: 'miniSplit', label: 'Mini Split AC' },
        { key: 'windowUnit', label: 'Window AC Unit' },
        { key: 'dishwasher', label: 'Dishwasher' },
        { key: 'refrigerator', label: 'Refrigerator' },
        { key: 'stoveOven', label: 'Stove/Oven' },
        { key: 'microwave', label: 'Microwave' },
        { key: 'garbageDisposal', label: 'Garbage Disposal' },
        { key: 'balcony', label: 'Balcony/Patio' },
        { key: 'walkInCloset', label: 'Walk-in Closet' },
        { key: 'ceilingFan', label: 'Ceiling Fan' },
        { key: 'hardwoodFloor', label: 'Hardwood Floor' },
        { key: 'tileFloor', label: 'Tile Floor' },
        { key: 'carpetFloor', label: 'Carpet Floor' },
        { key: 'fireplace', label: 'Fireplace' },
        { key: 'privateEntrance', label: 'Private Entrance' },
        { key: 'storageUnit', label: 'Storage Unit' },
        { key: 'garage', label: 'Garage' },
        { key: 'coveredParking', label: 'Covered Parking' },
        { key: 'securitySystem', label: 'Security System' },
        { key: 'internetReady', label: 'Internet Ready' },
        { key: 'cableReady', label: 'Cable Ready' },
        { key: 'furnished', label: 'Furnished' },
        { key: 'petFriendly', label: 'Pet Friendly' },
        { key: 'smokeFree', label: 'Smoke Free' },
        { key: 'wheelchairAccessible', label: 'Wheelchair Accessible' }
    ];

    // Amenities HTML
    const amenitiesHtml = unit.amenities && unit.amenities.length
        ? `<ul style="margin:0 0 0 18px; padding:0;">
            ${amenitiesList.filter(a => unit.amenities.includes(a.key)).map(a => `<li>${a.label}</li>`).join('')}
           </ul>`
        : '<span class="tenant-detail-value">No amenities listed</span>';

    // Utility accounts HTML
    const utilitiesHtml = utilities.map(util => {
        const acc = unit.utilityAccounts?.[util.key] || {};
        return `
            <div class="utility-block">
                <h4>${util.type}</h4>
                <div><strong>Account #:</strong> ${acc.accountNumber || 'N/A'}</div>
                <div><strong>Provider:</strong> ${acc.provider || 'N/A'}</div>
                <div><strong>Status:</strong> ${acc.status || 'N/A'}</div>
                <div><strong>Bill Under:</strong> ${acc.under || 'N/A'}</div>
            </div>
        `;
    }).join('');

    // Main HTML
    let html = `
      <div class="unit-section">
        <h3>Unit: ${unit.number || ''}</h3>
        <p><strong>Status:</strong> ${unit.status || 'N/A'}</p>
        <p><strong>Bedrooms:</strong> ${unit.bedrooms || 'N/A'} | <strong>Bathrooms:</strong> ${unit.bathrooms || 'N/A'}</p>
        <p><strong>Floor:</strong> ${unit.floor || 'N/A'} | <strong>Square Feet:</strong> ${unit.sqft || 'N/A'}</p>
      </div>
      <div class="unit-section">
        <h3>Amenities & Features</h3>
        ${amenitiesHtml}
      </div>
      <div class="unit-section">
        <h3>Utilities</h3>
        ${utilitiesHtml}
      </div>
    `;

    document.getElementById('unitDetailsBody').innerHTML = html;
    openModal('viewUnitModal');
}

function exportUtilityReport() {
    const unit = state.units.find(u => u._id === state.currentUnitId);
    if (!unit) {
        showNotification('Unit not found', 'error');
        return;
    }

    // Prepare CSV header
    let csv = 'Utility,Account Number,Provider,Status,Bill Under\n';

    // List of utilities
    const utilities = [
        { type: 'Water', key: 'water' },
        { type: 'Gas', key: 'gas' },
        { type: 'Electricity', key: 'electricity' }
    ];

    // Add each utility's account info
    utilities.forEach(util => {
        const acc = unit.utilityAccounts?.[util.key] || {};
        csv += [
            util.type,
            acc.accountNumber || '',
            acc.provider || '',
            acc.status || '',
            acc.under || ''
        ].join(',') + '\n';
    });

    // Download as CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `utility_accounts_unit_${unit.number || unit._id}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}


// Update the handleAddUnit function
async function handleAddUnit(event) {
    event.preventDefault();

    const form = event.target;

    // If in edit mode, don't proceed with add
    if (form.dataset.editMode === 'true') {
        return;
    }

    if (!state.currentProperty) {
        showNotification('Please select a property first', 'error');
        return;
    }

    // Collect amenities/features from checklist
    const amenities = Array.from(document.querySelectorAll('#unitAmenitiesChecklist input[type="checkbox"]:checked'))
        .map(cb => cb.value);

    const unitData = {
        number: document.getElementById('unitNumber').value,
        floor: Number(document.getElementById('unitFloor').value),
        sqft: Number(document.getElementById('unitSqft').value),
        rent: Number(document.getElementById('unitRent')?.value) || 0,
        bedrooms: Number(document.getElementById('unitBedrooms').value),
        bathrooms: Number(document.getElementById('unitBathrooms').value),
        status: document.getElementById('unitStatus').value,
        amenities, // <-- Add amenities array
        utilityAccounts: {
            water: {
                accountNumber: document.getElementById('waterAccountNumber').value,
                provider: document.getElementById('waterProvider').value,
                status: document.getElementById('waterStatus').value,
                under: document.getElementById('waterUnder').value
            },
            gas: {
                accountNumber: document.getElementById('gasAccountNumber').value,
                provider: document.getElementById('gasProvider').value,
                status: document.getElementById('gasStatus').value,
                under: document.getElementById('gasUnder').value
            },
            electricity: {
                accountNumber: document.getElementById('electricityAccountNumber').value,
                provider: document.getElementById('electricityProvider').value,
                status: document.getElementById('electricityStatus').value,
                under: document.getElementById('electricityUnder').value
            }
        }
    };

    // Validate required fields
    if (!unitData.number || !unitData.bedrooms || !unitData.bathrooms) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }
    showLoader();
    try {
        const response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/units`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(unitData)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to add unit');
        }

        await loadUnits(state.currentProperty._id);
        closeModal('addUnitModal');
        showNotification('Unit added successfully', 'success');
        event.target.reset();
    } catch (error) {
        console.error('Error adding unit:', error);
        showNotification(error.message || 'Error adding unit', 'error');
    } finally {
        hideLoader();
    }
}

function resetUnitForm() {
    const form = document.getElementById('addUnitForm');
    if (form) {
        form.reset();
        // Uncheck all amenities checkboxes
        document.querySelectorAll('#unitAmenitiesChecklist input[type="checkbox"]').forEach(cb => cb.checked = false);
        // Clear rent explicitly
        const rentInput = document.getElementById('unitRent');
        if (rentInput) rentInput.value = '';
        // Reset submit button text
        const submitButton = form.querySelector('button[type="submit"]');
        if (submitButton) submitButton.textContent = 'Add Unit';
        // Remove edit mode flags
        form.dataset.editMode = 'false';
        form.dataset.unitId = '';
    }
}


async function deleteUnit(unitId) {
    if (!confirm('Are you sure you want to delete this unit?')) {
        return;
    }
    showLoader();
    try {
        const response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/units/${unitId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Failed to delete unit');
        }

    invalidateCache('units');
    await refreshContent('units');
        showNotification('Unit deleted successfully', 'success');
    } catch (error) {
        console.error('Error deleting unit:', error);
        showNotification('Error deleting unit', 'error');
            } finally {
        hideLoader();
    }
}

function addLeaseHolderField(holder = {}) {
    const list = document.getElementById('leaseHoldersList');
    const holderDiv = document.createElement('div');
    holderDiv.className = 'lease-holder-row';
    holderDiv.innerHTML = `
        <input type="text" class="lease-holder-name" placeholder="Full Name" value="${holder.name || ''}" required>
        <input type="tel" class="lease-holder-phone" placeholder="Phone" value="${holder.phone || ''}">
        <input type="email" class="lease-holder-email" placeholder="Email" value="${holder.email || ''}">
        <button type="button" class="btn-icon lease-holder-remove" title="Remove" onclick="removeLeaseHolderField(this)">
            <i class="fas fa-times"></i>
        </button>
    `;
    list.appendChild(holderDiv);
}

function removeLeaseHolderField(btn) {
    btn.parentElement.remove();
}

function getLeaseHoldersFromForm() {
    return Array.from(document.querySelectorAll('#leaseHoldersList .lease-holder-row')).map(row => ({
        name: row.querySelector('.lease-holder-name').value.trim(),
        phone: row.querySelector('.lease-holder-phone').value.trim(),
        email: row.querySelector('.lease-holder-email').value.trim()
    })).filter(holder => holder.name); // Only keep if name is filled
}

function populateLeaseHolders(holders = []) {
    const list = document.getElementById('leaseHoldersList');
    list.innerHTML = '';
    holders.forEach(holder => addLeaseHolderField(holder));
}

// Auto-capitalize each word in the tenant name input
document.getElementById('tenantName')?.addEventListener('input', function() {
    this.value = this.value
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
});

// Reset car fields on form reset
function resetTenantForm() {
    document.getElementById('addTenantForm').reset();
    // Clear dynamic lease holders
    populateLeaseHolders([]);
    // Hide pets section
    document.getElementById('petDetails').style.display = 'none';
    // Hide car section
    document.getElementById('carDetails').style.display = 'none';
    document.getElementById('carFieldsContainer').innerHTML = '';
    // Hide lease type sections
    document.getElementById('fmrSection').style.display = 'none';
    document.getElementById('section8Section').style.display = 'none';
    // Reset submit button text
    const submitButton = document.getElementById('addTenantForm').querySelector('button[type="submit"]');
    if (submitButton) submitButton.textContent = 'Add Tenant';
    // Remove edit mode flags
    const form = document.getElementById('addTenantForm');
    form.dataset.editMode = 'false';
    form.dataset.tenantId = '';
}


// Tenant Management
async function handleAddTenant(event) {
    event.preventDefault();

    // Check if we're in edit mode - if so, don't proceed
    const form = event.target;
    if (form.dataset.editMode === 'true') {
        return;
    }

    if (!state.currentProperty) {
        showNotification('Please select a property first', 'error');
        return;
    }

    // Gather car info if "Has Car(s)" is checked
    let cars = [];
    if (document.getElementById('hasCar').checked) {
        const carCount = parseInt(document.getElementById('carCount').value) || 0;
        for (let i = 0; i < carCount; i++) {
            cars.push({
                make: document.querySelector(`.car-make[data-index="${i}"]`)?.value || '',
                model: document.querySelector(`.car-model[data-index="${i}"]`)?.value || '',
                color: document.querySelector(`.car-color[data-index="${i}"]`)?.value || '',
                licensePlate: document.querySelector(`.car-plate[data-index="${i}"]`)?.value || '',
                year: document.querySelector(`.car-year[data-index="${i}"]`).value || ''
            });
        }
    }

    // Gather pet info if "Has Pets" is checked
    let pets = {
        hasPets: document.getElementById('hasPets').checked,
        count: document.getElementById('hasPets').checked ? Number(document.getElementById('petCount').value) : 0,
        fee: document.getElementById('hasPets').checked ? Number(document.getElementById('petFee')?.value) || 0 : 0,
        nonRefundableFee: document.getElementById('hasPets').checked ? Number(document.getElementById('petNonRefundableFee')?.value) || 0 : 0,
        monthlyRent: document.getElementById('hasPets').checked ? Number(document.getElementById('petMonthlyRent')?.value) || 0 : 0,
        depositIncrease: document.getElementById('hasPets').checked ? Number(document.getElementById('petDepositIncrease')?.value) || 0 : 0,
        details: []
    };
    if (pets.hasPets) {
        pets.details = Array.from(document.querySelectorAll('.pet-field-group')).map((group, i) => ({
            type: group.querySelector('.pet-type')?.value || '',
            name: group.querySelector('.pet-name')?.value || '',
            breed: group.querySelector('.pet-breed')?.value || '',
            weight: group.querySelector('.pet-weight')?.value || '',
            age: group.querySelector('.pet-age')?.value || '',
            gender: group.querySelector('.pet-gender')?.value || '',
            vaccination: group.querySelector('.pet-vaccination')?.value || ''
        }));
    }

    const tenantData = {
        name: document.getElementById('tenantName').value,
        phone: document.getElementById('tenantPhone').value,
        email: document.getElementById('tenantEmail').value,
        leaseHolders: getLeaseHoldersFromForm(),
        emergencyContact: {
            name: document.getElementById('emergencyContactName').value,
            phone: document.getElementById('emergencyContactPhone').value,
            email: document.getElementById('emergencyContactEmail').value,
            address: document.getElementById('emergencyContactAddress').value,
            relation: document.getElementById('emergencyContactRelation').value
        },
        authorizedOccupants: document.getElementById('authorizedOccupants').value
            .split('\n')
            .map(s => s.trim())
            .filter(Boolean),
        pets,
        cars: {
            hasCar: document.getElementById('hasCar').checked,
            count: document.getElementById('hasCar').checked ? (parseInt(document.getElementById('carCount').value) || 0) : 0,
            details: cars
        },
        additionalFee: {
            type: document.getElementById('additionalFeeType').value,
            label: document.getElementById('additionalFeeLabel').value,
            amount: Number(document.getElementById('additionalFeeAmount').value) || 0
        },
        leaseRenewal: document.getElementById('leaseRenewal').value,
        unitId: document.getElementById('tenantUnit').value,
    // Send ISO at local noon to avoid timezone shifting
    leaseStart: dateInputToISOAtNoon(document.getElementById('leaseStart').value),
    leaseEnd: dateInputToISOAtNoon(document.getElementById('leaseEnd').value),
        baseRent: Number(document.getElementById('baseRent').value),
        deposit: Number(document.getElementById('deposit').value) || 0,
        waterFee: Number(document.getElementById('waterFee').value) || 0,
        trashFee: Number(document.getElementById('trashFee').value) || 0,
        adminFee: Number(document.getElementById('adminFee').value) || 0,
        leaseType: document.getElementById('leaseType').value,
        fmrNotes: document.getElementById('leaseType').value === 'fmr' ? document.getElementById('fmrNotes').value : '',
        hubContribution: document.getElementById('leaseType').value === 'section8' ? Number(document.getElementById('hubContribution').value) : 0,
        tenantContribution: document.getElementById('leaseType').value === 'section8' ? Number(document.getElementById('tenantContribution').value) : 0,
        leaseStatus: document.getElementById('leaseStatus').value
    };

    // Validate lease dates
    if (new Date(tenantData.leaseStart) > new Date(tenantData.leaseEnd)) {
        showNotification('Lease end date must be after start date', 'error');
        return;
    }
    showLoader();
    try {
        const response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/tenants`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(tenantData)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to add tenant');
        }

        // Update unit status to occupied if a unit was assigned
        if (tenantData.unitId) {
            await fetch(`${API_URL}/properties/${state.currentProperty._id}/units/${tenantData.unitId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: 'occupied' })
            });
        }

        // Bust caches and refresh tenants and units to reflect changes instantly
        invalidateCache('tenants', 'units');
        await Promise.all([
            refreshContent('tenants'),
            refreshContent('units')
        ]);
        
        closeModal('addTenantModal');
        showNotification('Tenant added successfully', 'success');
        event.target.reset();
    // Optional: refresh global summary lazily
    runWhenIdle(() => loadAllUnitsAndTenants());
    } catch (error) {
        console.error('Error adding tenant:', error);
        showNotification(error.message || 'Error adding tenant', 'error');
    } finally {
        hideLoader();
    }
}




// Show/hide car details and dynamic car fields
document.getElementById('hasCar').addEventListener('change', function() {
    const carDetails = document.getElementById('carDetails');
    carDetails.style.display = this.checked ? 'block' : 'none';
    if (this.checked) {
        updateCarFields();
    }
});

// Update car fields when car count changes
document.getElementById('carCount').addEventListener('input', updateCarFields);

function updateCarFields() {
    const count = parseInt(document.getElementById('carCount').value) || 0;
    const container = document.getElementById('carFieldsContainer');
    container.innerHTML = '';
    for (let i = 0; i < count; i++) {
        container.innerHTML += `
            <div class="car-field-group" style="margin-bottom:10px; padding:8px; background:#f8f9fa; border-radius:6px;">
                <label>Car #${i + 1} Make</label>
                <input type="text" class="car-make" data-index="${i}">
                <label>Model</label>
                        <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Photos</th>
                <input type="text" class="car-model" data-index="${i}">
                <label>Color</label>
                <input type="text" class="car-color" data-index="${i}">
                <label>License Plate</label>
                <input type="text" class="car-plate" data-index="${i}">
                <label>Year</label>
                <input type="number" class="car-year" data-index="${i}" min="1900" max="2100">
            </div>
        `;
    }
}

function updatePetFields() {
    const count = parseInt(document.getElementById('petCount').value) || 0;
    const container = document.getElementById('petFieldsContainer');
    container.innerHTML = '';
    for (let i = 0; i < count; i++) {
        container.innerHTML += `
            <div class="pet-field-group" style="margin-bottom:10px; padding:8px; background:#f8f9fa; border-radius:6px;">
                <label>Pet #${i + 1} Type</label>
                <input type="text" class="pet-type" data-index="${i}" placeholder="e.g. Dog, Cat">
                <label>Name</label>
                <input type="text" class="pet-name" data-index="${i}">
                <label>Breed</label>
                <input type="text" class="pet-breed" data-index="${i}">
                <label>Weight/Size</label>
                <input type="text" class="pet-weight" data-index="${i}" placeholder="e.g. 25 lbs, Medium">
                <label>Age</label>
                <input type="text" class="pet-age" data-index="${i}">
                <label>Gender</label>
                <select class="pet-gender" data-index="${i}">
                    <option value="">Select</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
                <label>Vaccination/Licensing #</label>
                <input type="text" class="pet-vaccination" data-index="${i}">
            </div>
        `;
    }
}

// Update event listeners for pets
document.getElementById('hasPets').addEventListener('change', function() {
    document.getElementById('petDetails').style.display = this.checked ? 'block' : 'none';
    if (this.checked) updatePetFields();
});
document.getElementById('petCount').addEventListener('input', updatePetFields);



// Update the loadTenants function
async function loadTenants(propertyId, force = false) {
    
    try {
        if (!force && shouldUseCache('tenants', propertyId)) {
            renderTenants();
            updateTabCounts();
            return;
        }
        const response = await fetch(`${API_URL}/properties/${propertyId}/tenants`);
        if (!response.ok) throw new Error('Failed to fetch tenants');
        
        const tenants = await response.json();
        // Update state with tenant data
        state.tenants = tenants;
        console.log('Loaded tenants:', state.tenants); // Debug log
        renderTenants();
        updateTabCounts(); 
        touchCache('tenants', propertyId);
    } catch (error) {
        console.error('Error loading tenants:', error);
        showNotification('Error loading tenants', 'error');

    }
}

// Add tenant tab switching logic
let currentTenantTab = 'active';

document.getElementById('activeTenantsTab').addEventListener('click', function() {
    currentTenantTab = 'active';
    renderTenants();
    this.classList.add('active');
    document.getElementById('inactiveTenantsTab').classList.remove('active');
});
document.getElementById('inactiveTenantsTab').addEventListener('click', function() {
    currentTenantTab = 'inactive';
    renderTenants();
    this.classList.add('active');
    document.getElementById('activeTenantsTab').classList.remove('active');
});

// Update the renderTenants function
function renderTenants() {
    const tenantsList = document.getElementById('tenantsList');
    let tenantsToShow = [];
    if (currentTenantTab === 'active') {
        tenantsToShow = (state.tenants || []).filter(t => t.leaseStatus !== 'terminated' && t.leaseStatus !== 'expired');
    } else {
        tenantsToShow = (state.tenants || []).filter(t => t.leaseStatus === 'terminated' || t.leaseStatus === 'expired');
    }
    if (!tenantsToShow.length) {
        tenantsList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <p>No ${currentTenantTab === 'active' ? 'active' : 'inactive'} tenants found</p>
                ${currentTenantTab === 'active' ? `<button onclick="openModal('addTenantModal')" class="btn-primary">Add Your First Tenant</button>` : ''}
            </div>`;
        return;
    }

    tenantsList.innerHTML = tenantsToShow.map(tenant => {
        // Get tenant initials for avatar
        const initials = tenant.name
            .split(' ')
            .map(n => n[0])
            .join('')
            .toUpperCase();

        // Find the associated unit
        const assignedUnit = typeof tenant.unitId === 'object' ? tenant.unitId : 
            state.units.find(u => u._id === tenant.unitId || u._id?.toString() === tenant.unitId?.toString());

        // Format lease dates
        const leaseStart = tenant.leaseStart ? formatDateDisplay(tenant.leaseStart, 'en-US') : 'Not set';
        const leaseEnd = tenant.leaseEnd ? formatDateDisplay(tenant.leaseEnd, 'en-US') : 'Not set';

        // Only sum monthly pet rent for totals
        const petFees = (tenant.pets?.hasPets ? (Number(tenant.pets.monthlyRent) || 0) : 0);

        // Calculate additional fees (including custom "Other" fee)
        const additionalFees = 
            (Number(tenant.waterFee) || 0) +
            (Number(tenant.trashFee) || 0) +
            (Number(tenant.adminFee) || 0) +
            (tenant.additionalFee?.amount || 0) +
            petFees;

        // Total rent calculation (base rent + additional fees)
        const totalRent = (Number(tenant.baseRent) || 0) + additionalFees;

        // --- Rent payment status for current month ---
        const now = new Date();
        const periodMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        // Collect this month's rent payments (applyTo rent) for the tenant
        const monthPayments = (state.payments || []).filter(p => p.tenantId === tenant._id && p.applyTo === 'rent' && p.date && new Date(p.date).getMonth() === now.getMonth() && new Date(p.date).getFullYear() === now.getFullYear());
        // Only count positive amounts toward payment; credits (negative) should not increase paid
        const totalPaidThisMonth = monthPayments.reduce((sum,p)=>{
            const amt = Number(p.amount) || 0;
            const appliedCred = Number(p.appliedCredit) || 0;
            return sum + (amt > 0 ? amt : 0);
        },0);
    // Expected rent using same logic as server, but respect monthly overrides immediately
    // First check for override on this month:
    const overrideMap = tenant?.monthlyOverrides || null;
    const monthOverride = overrideMap
        ? (typeof overrideMap.get === 'function' ? overrideMap.get(periodMonth) : overrideMap[periodMonth])
        : null;
    // Apply first-month proration to BASE RENT only; add recurring monthly fees un-prorated
    const expectedBase = computeExpectedBaseRentForMonth(tenant, now);
    let expectedMonthly = expectedBase + additionalFees;
    if (monthOverride) {
        const ovExpected = Number(monthOverride.expectedRent);
        const ovLate = Number(monthOverride.lateFee);
        const ovMode = (monthOverride.lateFeeMode === 'percent') ? 'percent' : 'amount';
        // Determine base amount before late fee
        const baseBeforeLate = Number.isFinite(ovExpected) ? ovExpected : (expectedBase + additionalFees);
        if (ovMode === 'percent' && Number.isFinite(ovLate)) {
            expectedMonthly = baseBeforeLate + (baseBeforeLate * (ovLate / 100));
        } else {
            expectedMonthly = baseBeforeLate + (Number.isFinite(ovLate) ? ovLate : 0);
        }
    }
        const remainingRent = Math.max(0, expectedMonthly - totalPaidThisMonth);
        // Assume due date = 1st of month (can be extended later with tenant.rentDueDay)
        const dueDate = new Date(now.getFullYear(), now.getMonth(), 1);
        const daysUntilDue = Math.floor((dueDate - now) / (1000*60*60*24));
        let rentStatusBadge = '';
        if (remainingRent > 0) {
            if (daysUntilDue < 0) {
                rentStatusBadge = `<span class="rent-badge overdue" title="Rent overdue${monthOverride && monthOverride.expectedRent!=null ? '  override active' : ''}"><i class="fas fa-exclamation-circle"></i> OVERDUE  $${remainingRent.toFixed(2)}</span>`;
            } else if (daysUntilDue <= 3) {
                rentStatusBadge = `<span class="rent-badge due-soon" title="Rent due soon${monthOverride && monthOverride.expectedRent!=null ? '  override active' : ''}"><i class="fas fa-clock"></i> DUE IN ${daysUntilDue}d  $${remainingRent.toFixed(2)}</span>`;
            } else if (totalPaidThisMonth > 0 && remainingRent > 0) {
                rentStatusBadge = `<span class="rent-badge partial" title="Partial rent paid${monthOverride && monthOverride.expectedRent!=null ? '  override active' : ''}"><i class="fas fa-adjust"></i> PARTIAL  ${((totalPaidThisMonth/expectedMonthly)*100).toFixed(0)}%</span>`;
            }
        }
        // If fully paid (or credit making it negative), optional badge skipped for cleanliness

        // Emergency contact (just name and phone)
        const emergency = tenant.emergencyContact
            ? `<div class="tenant-detail-row" style="overflow-x:auto; white-space:nowrap; gap:18px;">
                    <span><i class="fas fa-user-shield"></i> ${tenant.emergencyContact.name || 'N/A'}</span>
                    <span><i class="fas fa-phone"></i> ${tenant.emergencyContact.phone || 'N/A'}</span>
                </div>`
            : '<span class="tenant-detail-value">N/A</span>';

    // Lease countdown logic
    let leaseCountdownHtml = '';
    if (tenant.leaseEnd) {
        const today = new Date();
        const leaseEndDate = new Date(tenant.leaseEnd);
        const diffMs = leaseEndDate - today;
        const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
        if (diffDays <= 60 && diffDays > 0 && (tenant.leaseStatus === 'active' || tenant.leaseStatus === 'pending')) {
            leaseCountdownHtml = `
                <div class="tenant-detail-row" style="margin-top:8px;">
                    <span style="color:#f39c12; font-weight:600;">
                        <i class="fas fa-hourglass-half"></i>
                        Lease expires in <span style="font-size:1.08em; color:#d35400;">${diffDays} day${diffDays !== 1 ? 's' : ''}</span>
                    </span>
                </div>
            `;
        }
    }

    return `
        <div class="tenant-card">
            <div class="tenant-header">
                <div class="tenant-avatar-small">${initials}</div>
                <h3>${tenant.name}</h3>
            </div>
            <div class="tenant-info">
                <div class="tenant-section">
                    <div class="tenant-section-title"><i class="fas fa-home"></i> Unit</div>
                    <div class="tenant-detail-row">
                        ${assignedUnit ? 
                            `Unit ${assignedUnit.number} (${assignedUnit.bedrooms} bed, ${assignedUnit.bathrooms} bath)` : 
                            'No unit assigned'}
                    </div>
                </div>
                <div class="tenant-section">
                    <div class="tenant-section-title"><i class="fas fa-calendar-alt"></i> Lease</div>
                    <div class="tenant-detail-row"><span>Lease:</span> <span>${leaseStart} - ${leaseEnd}</span></div>
                    ${leaseCountdownHtml}
                    ${rentStatusBadge ? `<div class="tenant-detail-row">${rentStatusBadge}</div>` : ''}
                    <div class="tenant-detail-row"><span>Deposit:</span> <span>$${(tenant.deposit ?? 0).toFixed(2)}</span></div>
                    <div class="tenant-detail-row"><span>Base Rent:</span> <span>$${(Number(tenant.baseRent) || 0).toFixed(2)}</span></div>
                    <div class="tenant-detail-row"><span>Total Fees:</span> <span style="font-weight:600; color:#2980b9;">$${additionalFees.toFixed(2)}</span></div>
                    <div class="tenant-detail-row">
                        <span>Total Rent:</span>
                        <span style="font-weight:700; color:#217dbb; font-size:1.08em; letter-spacing:0.5px; background:#eaf6ff; padding:3px 12px; border-radius:12px;">
                            $${totalRent.toFixed(2)}
                        </span>
                    </div>
                    <div class="tenant-detail-row">
                        <span>Status:</span>
                        <span class="lease-badge ${tenant.leaseStatus || 'active'}">
                            <i class="fas fa-circle"></i>
                            ${(tenant.leaseStatus || 'active').charAt(0).toUpperCase() + (tenant.leaseStatus || 'active').slice(1)}
                        </span>
                    </div>
                </div>
                <div class="tenant-section">
                    <div class="tenant-section-title"><i class="fas fa-user-shield"></i> Emergency</div>
                    ${emergency}
                </div>
            </div>
            <div class="tenant-actions">
                <button onclick="viewTenantDetails('${tenant._id}')" class="btn-secondary">
                    <i class="fas fa-eye"></i> Details
                </button>
                <button onclick="editTenant('${tenant._id}')" class="btn-secondary">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button onclick="deleteTenant('${tenant._id}')" class="btn-icon delete-btn" title="Delete Tenant">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
}).join('');
}


async function viewTenantDetails(tenantId) {
    try {
        const tenant = state.tenants.find(t => t._id === tenantId);
        if (!tenant) throw new Error('Tenant not found');

        // Get tenant initials for avatar
        const initials = tenant.name
            .split(' ')
            .map(n => n[0])
            .join('')
            .toUpperCase();

        // Lease holders
        const leaseHoldersHtml = (tenant.leaseHolders && tenant.leaseHolders.length)
            ? `<ul>
                ${tenant.leaseHolders.map(holder => `
                    <li>
                        <strong>${holder.name}</strong>
                        ${holder.phone ? ` | <i class="fas fa-phone"></i> ${holder.phone}` : ''}
                        ${holder.email ? ` | <i class="fas fa-envelope"></i> ${holder.email}` : ''}
                    </li>
                `).join('')}
              </ul>`
            : '<span class="tenant-detail-value">None listed</span>';

        // Format dates
        const leaseStart = tenant.leaseStart ? formatDateDisplay(tenant.leaseStart, 'en-US') : 'Not set';
        const leaseEnd = tenant.leaseEnd ? formatDateDisplay(tenant.leaseEnd, 'en-US') : 'Not set';

        // Unit info
        let unitInfoHtml = '<p>No unit assigned</p>';
        if (tenant.unitId && typeof tenant.unitId === 'object') {
            unitInfoHtml = `
                <p><i class="fas fa-home"></i> Unit ${tenant.unitId.number}</p>
                <p><i class="fas fa-bed"></i> ${tenant.unitId.bedrooms} Bedrooms, ${tenant.unitId.bathrooms} Bathrooms</p>
                <p><i class="fas fa-ruler-combined"></i> ${tenant.unitId.sqft || 'N/A'} sq ft</p>
                <p><i class="fas fa-building"></i> Floor ${tenant.unitId.floor || '1'}</p>
            `;
        }

        // Lease type details
        let leaseTypeDetails = '';
        if (tenant.leaseType === 'fmr') {
            leaseTypeDetails = `<p><i class="fas fa-sticky-note"></i> FMR Notes: ${tenant.fmrNotes || 'None'}</p>`;
        } else if (tenant.leaseType === 'section8') {
            leaseTypeDetails = `
                <p><i class="fas fa-building"></i> HUB Contribution: $${tenant.hubContribution?.toFixed(2) || '0.00'}</p>
                <p><i class="fas fa-user"></i> Tenant Contribution: $${tenant.tenantContribution?.toFixed(2) || '0.00'}</p>
            `;
        }

        // Only sum monthly pet rent for totals
        const petFees = (tenant.pets?.hasPets ? (Number(tenant.pets.monthlyRent) || 0) : 0);

        // Calculate additional fees (including custom "Other" fee)
        const additionalFees = 
            (Number(tenant.waterFee) || 0) +
            (Number(tenant.trashFee) || 0) +
            (Number(tenant.adminFee) || 0) +
            (tenant.additionalFee?.amount || 0) +
            petFees;

        // Additional fees HTML
        const additionalFeesHtml = `
            <p><i class="fas fa-tint"></i> Water Fee: $${tenant.waterFee?.toFixed(2) || '0.00'}</p>
            <p><i class="fas fa-trash"></i> Trash Fee: $${tenant.trashFee?.toFixed(2) || '0.00'}</p>
            <p><i class="fas fa-user-cog"></i> Admin Fee: $${tenant.adminFee?.toFixed(2) || '0.00'}</p>
            ${
                tenant.additionalFee?.amount
                    ? `<p><i class="fas fa-coins"></i> ${
                        tenant.additionalFee.type === 'other' && tenant.additionalFee.label
                            ? tenant.additionalFee.label
                            : tenant.additionalFee.type === 'parking'
                                ? 'Parking Fee'
                                : tenant.additionalFee.type === 'storage'
                                    ? 'Storage Fee'
                                    : (tenant.additionalFee.label || 'Other Fee')
                    }: $${Number(tenant.additionalFee.amount).toFixed(2)}</p>`
                    : ''
            }
            ${tenant.pets?.hasPets && tenant.pets.monthlyRent ? `<p><i class="fas fa-dog"></i> Monthly Pet Rent: $${(Number(tenant.pets.monthlyRent) || 0).toFixed(2)}</p>` : ''}
            <p style="margin-top:8px; font-weight:600; color:#2980b9;">
              <i class="fas fa-plus-circle"></i> Total Fees: $${additionalFees.toFixed(2)}
            </p>
        `;

        // Total rent calculation (base rent + all additional fees)
        const totalRent =
            (Number(tenant.baseRent) || 0) +
            additionalFees;

        // Authorized occupants
        const occupantsHtml = (tenant.authorizedOccupants || []).length
            ? `<ul>${tenant.authorizedOccupants.map(o => `<li>${o}</li>`).join('')}</ul>`
            : '<li>None listed</li>';

        // Pets
        let petsHtml = 'No';
        if (tenant.pets?.hasPets) {
            petsHtml = `<div>
                Yes (${tenant.pets.count} pet${tenant.pets.count > 1 ? 's' : ''})
                ${tenant.pets.fee ? `, Fee: $${tenant.pets.fee}` : ''}
                ${tenant.pets.nonRefundableFee ? `<br>Non-refundable Fee: $${tenant.pets.nonRefundableFee}` : ''}
                ${tenant.pets.monthlyRent ? `<br>Monthly Pet Rent: $${tenant.pets.monthlyRent}` : ''}
                ${tenant.pets.depositIncrease ? `<br>Deposit Increase: $${tenant.pets.depositIncrease}` : ''}
                ${Array.isArray(tenant.pets.details) && tenant.pets.details.length ? `
                    <ul>
                        ${tenant.pets.details.map((pet, idx) => `
                            <li>
                                <strong>Pet #${idx + 1}:</strong>
                                ${pet.type ? `Type: ${pet.type}, ` : ''}
                                ${pet.name ? `Name: ${pet.name}, ` : ''}
                                ${pet.breed ? `Breed: ${pet.breed}, ` : ''}
                                ${pet.weight ? `Weight/Size: ${pet.weight}, ` : ''}
                                ${pet.age ? `Age: ${pet.age}, ` : ''}
                                ${pet.gender ? `Gender: ${pet.gender}, ` : ''}
                                ${pet.vaccination ? `Vaccination/Licensing #: ${pet.vaccination}` : ''}
                            </li>
                        `).join('')}
                    </ul>
                ` : ''}
            </div>`;
        }

        // Cars
        let carsHtml = '<span class="tenant-detail-value">No cars listed</span>';
        if (tenant.cars?.hasCar && Array.isArray(tenant.cars.details) && tenant.cars.details.length) {
            carsHtml = `<ul class="tenant-list">${tenant.cars.details.map((car, idx) => `
                <li>
                    <strong>Car #${idx + 1}:</strong>
                    ${car.year || ''} ${car.make || ''} ${car.model || ''} (${car.color || ''}) - Plate: ${car.licensePlate || ''}
                </li>
            `).join('')}</ul>`;
        }

        // Emergency contact
        const emergencyHtml = tenant.emergencyContact
            ? `
                <p><i class="fas fa-user-shield"></i> ${tenant.emergencyContact.name || 'N/A'}</p>
                <p><i class="fas fa-phone"></i> ${tenant.emergencyContact.phone || 'N/A'}</p>
                <p><i class="fas fa-envelope"></i> ${tenant.emergencyContact.email || 'N/A'}</p>
                <p><i class="fas fa-map-marker-alt"></i> ${tenant.emergencyContact.address || 'N/A'}</p>
                <p><i class="fas fa-user-friends"></i> Relation: ${tenant.emergencyContact.relation || 'N/A'}</p>
            `
            : '<span class="tenant-detail-value">N/A</span>';

        // Lease status badge
        const leaseStatus = tenant.leaseStatus || 'active';
        const leaseStatusText = leaseStatus.charAt(0).toUpperCase() + leaseStatus.slice(1);

        // Dates for created/updated
        const createdAt = tenant.createdAt ? new Date(tenant.createdAt).toLocaleDateString('en-US', {
            year: 'numeric', month: 'long', day: 'numeric'
        }) : '';
        const updatedAt = tenant.updatedAt ? new Date(tenant.updatedAt).toLocaleDateString('en-US', {
            year: 'numeric', month: 'long', day: 'numeric'
        }) : '';

        const detailsHtml = `
            <div class="modal-content tenant-details-modal">
                <div class="tenant-details-header">
                    <div class="tenant-avatar">${initials}</div>
                    <h2>${tenant.name}</h2>
                </div>
                <div class="tenant-details-content">
                    <div class="detail-group">
                        <label>Contact Information</label>
                        <p><i class="fas fa-phone"></i> ${tenant.phone}</p>
                        <p><i class="fas fa-envelope"></i> ${tenant.email}</p>
                    </div>
                    <div class="detail-group">
                        <label>Additional Lease Holders</label>
                        ${leaseHoldersHtml}
                    </div>
                    <div class="detail-group">
                        <label>Unit Information</label>
                        ${unitInfoHtml}
                    </div>
                    <div class="detail-group">
                        <label>Lease Information</label>
                        <p><i class="fas fa-calendar-alt"></i> Start Date: ${leaseStart}</p>
                        <p><i class="fas fa-calendar-check"></i> End Date: ${leaseEnd}</p>
                        <p><i class="fas fa-dollar-sign"></i> Deposit: $${tenant.deposit?.toFixed(2) || '0.00'}</p>
                        <p><i class="fas fa-dollar-sign"></i> Base Rent: $${tenant.baseRent?.toFixed(2) || '0.00'}</p>
                        ${additionalFeesHtml}
                        <p style="margin-top:10px;">
                          <strong><i class="fas fa-calculator"></i> Total Rent:</strong>
                          <span style="font-weight:700; color:#217dbb; font-size:1.08em; letter-spacing:0.5px; background:#eaf6ff; padding:3px 12px; border-radius:12px;">
                            $${totalRent.toFixed(2)}
                          </span>
                        </p>
                        <p><i class="fas fa-file-contract"></i> Lease Type: 
                            ${tenant.leaseType === 'fmr' ? 'Free Market Rent' : tenant.leaseType === 'section8' ? 'Section 8' : 'N/A'}
                        </p>
                        ${leaseTypeDetails}
                        <p>
                          <i class="fas fa-info-circle"></i> Lease Status:
                          <span class="lease-badge ${leaseStatus}">
                            ${leaseStatusText}
                          </span>
                        </p>
                        <p><i class="fas fa-redo"></i> Renewal: ${tenant.leaseRenewal === 'renew' ? 'Will Renew' : 'Will Terminate'}</p>
                    </div>
                    <div class="detail-group">
                        <label>Emergency Contact</label>
                        ${emergencyHtml}
                    </div>
                    <div class="detail-group">
                        <label>Authorized Occupants</label>
                        <ul>
                            ${occupantsHtml}
                        </ul>
                    </div>
                    <div class="detail-group">
                        <label>Pets</label>
                        <p>${petsHtml}</p>
                    </div>
                    <div class="detail-group">
                        <label>Cars</label>
                        ${carsHtml}
                    </div>
                    <div class="detail-group">
                        <label>Additional Information</label>
                        <p><i class="fas fa-clock"></i> Added: ${createdAt}</p>
                        <p><i class="fas fa-sync"></i> Last Updated: ${updatedAt}</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button onclick="editTenant('${tenant._id}')" class="btn-primary">
                        <i class="fas fa-edit"></i> Edit Tenant
                    </button>
                    <button onclick="closeModal('tenantDetailsModal')" class="btn-secondary">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        `;

        let modal = document.getElementById('tenantDetailsModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'tenantDetailsModal';
            modal.className = 'modal';
            document.body.appendChild(modal);
        }

        modal.innerHTML = detailsHtml;
        openModal('tenantDetailsModal');

    } catch (error) {
        console.error('Error viewing tenant details:', error);
        showNotification('Error loading tenant details', 'error');
    }
}

async function editTenant(tenantId) {
    try {
        const tenant = state.tenants.find(t => t._id === tenantId);
        if (!tenant) throw new Error('Tenant not found');

        // Populate form fields (defensive: check if element exists before setting value)
        const setVal = (id, val) => {
            const el = document.getElementById(id);
            if (el) el.value = val ?? '';
        };

        setVal('tenantName', tenant.name);
        setVal('tenantPhone', tenant.phone);
        setVal('tenantEmail', tenant.email);

        populateLeaseHolders(tenant.leaseHolders || []);

        setVal('leaseStart', tenant.leaseStart ? new Date(tenant.leaseStart).toISOString().split('T')[0] : '');
        setVal('leaseEnd', tenant.leaseEnd ? new Date(tenant.leaseEnd).toISOString().split('T')[0] : '');
        setVal('baseRent', tenant.baseRent);
        setVal('deposit', tenant.deposit);
        setVal('waterFee', tenant.waterFee);
        setVal('trashFee', tenant.trashFee);
        setVal('adminFee', tenant.adminFee);
        setVal('leaseType', tenant.leaseType);
        setVal('leaseStatus', tenant.leaseStatus || 'active');

        // Additional Fee fields
        setVal('additionalFeeType', tenant.additionalFee?.type || '');
        setVal('additionalFeeLabel', tenant.additionalFee?.label || '');
        setVal('additionalFeeAmount', tenant.additionalFee?.amount || '');
        document.getElementById('additionalFeeType')?.dispatchEvent(new Event('change'));

        // Lease type sections
        if (tenant.leaseType === 'fmr') {
            document.getElementById('fmrSection').style.display = 'block';
            document.getElementById('section8Section').style.display = 'none';
            setVal('fmrNotes', tenant.fmrNotes);
        } else if (tenant.leaseType === 'section8') {
            document.getElementById('fmrSection').style.display = 'none';
            document.getElementById('section8Section').style.display = 'flex';
            setVal('hubContribution', tenant.hubContribution);
            setVal('tenantContribution', tenant.tenantContribution);
        } else {
            document.getElementById('fmrSection').style.display = 'none';
            document.getElementById('section8Section').style.display = 'none';
            setVal('fmrNotes', '');
            setVal('hubContribution', '');
            setVal('tenantContribution', '');
        }

        // Emergency contact
        setVal('emergencyContactName', tenant.emergencyContact?.name || '');
        setVal('emergencyContactPhone', tenant.emergencyContact?.phone || '');
        setVal('emergencyContactEmail', tenant.emergencyContact?.email || '');
        setVal('emergencyContactAddress', tenant.emergencyContact?.address || '');
        setVal('emergencyContactRelation', tenant.emergencyContact?.relation || '');

        // Authorized occupants
        setVal('authorizedOccupants', (tenant.authorizedOccupants || []).join('\n'));

        // Pets
        const hasPets = !!(tenant.pets && tenant.pets.hasPets);
        const petsCheckbox = document.getElementById('hasPets');
        if (petsCheckbox) petsCheckbox.checked = hasPets;
        const petDetailsDiv = document.getElementById('petDetails');
        if (petDetailsDiv) petDetailsDiv.style.display = hasPets ? 'block' : 'none';
        setVal('petCount', tenant.pets?.count || '');
        setVal('petFee', tenant.pets?.fee || '');
        setVal('petNonRefundableFee', tenant.pets?.nonRefundableFee || '');
        setVal('petMonthlyRent', tenant.pets?.monthlyRent || '');
        setVal('petDepositIncrease', tenant.pets?.depositIncrease || '');
        updatePetFields();
        if (tenant.pets && Array.isArray(tenant.pets.details)) {
            tenant.pets.details.forEach((pet, i) => {
                const setPetVal = (cls, val) => {
                    const el = document.querySelector(`.${cls}[data-index="${i}"]`);
                    if (el) el.value = val ?? '';
                };
                setPetVal('pet-type', pet.type);
                setPetVal('pet-name', pet.name);
                setPetVal('pet-breed', pet.breed);
                setPetVal('pet-weight', pet.weight);
                setPetVal('pet-age', pet.age);
                setPetVal('pet-gender', pet.gender);
                setPetVal('pet-vaccination', pet.vaccination);
            });
        }

        // Lease renewal
        setVal('leaseRenewal', tenant.leaseRenewal || 'renew');

        // Cars
        const hasCar = !!(tenant.cars && tenant.cars.hasCar);
        const hasCarCheckbox = document.getElementById('hasCar');
        if (hasCarCheckbox) hasCarCheckbox.checked = hasCar;
        const carDetailsDiv = document.getElementById('carDetails');
        if (carDetailsDiv) carDetailsDiv.style.display = hasCar ? 'block' : 'none';
        setVal('carCount', tenant.cars?.count || 1);
        updateCarFields();
        if (tenant.cars && Array.isArray(tenant.cars.details)) {
            tenant.cars.details.forEach((car, i) => {
                const setCarVal = (cls, val) => {
                    const el = document.querySelector(`.${cls}[data-index="${i}"]`);
                    if (el) el.value = val ?? '';
                };
                setCarVal('car-make', car.make);
                setCarVal('car-model', car.model);
                setCarVal('car-color', car.color);
                setCarVal('car-plate', car.licensePlate);
                setCarVal('car-year', car.year);
            });
        }

        // Get vacant units plus the tenant's current unit
        const availableUnits = state.units.filter(unit =>
            unit.status === 'vacant' || (tenant.unitId && (unit._id === tenant.unitId._id || unit._id === tenant.unitId))
        );
        const unitSelect = document.getElementById('tenantUnit');
        if (unitSelect) {
            unitSelect.innerHTML = `
                <option value="">Select a unit</option>
                ${availableUnits.map(unit => `
                    <option value="${unit._id}" ${(tenant.unitId && (unit._id === tenant.unitId._id || unit._id === tenant.unitId)) ? 'selected' : ''}>
                        Unit ${unit.number} - ${unit.bedrooms} bed, ${unit.bathrooms} bath
                    </option>
                `).join('')}
            `;
        }

        // Open modal in edit mode
        openModal('addTenantModal');

        // Update form handler for edit mode
        const form = document.getElementById('addTenantForm');
        const submitButton = form.querySelector('button[type="submit"]');
        if (submitButton) submitButton.textContent = 'Update Tenant';

        // Store the tenantId for update and mark as edit mode
        form.dataset.editMode = 'true';
        form.dataset.tenantId = tenantId;

        // Remove the previous event listener and add new one
        form.onsubmit = null;
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            await handleUpdateTenant(tenantId);

            // After update, handle unit status based on leaseStatus
            const leaseStatus = document.getElementById('leaseStatus').value;
            const unitId = document.getElementById('tenantUnit').value;
            if (unitId) {
                if (leaseStatus === 'terminated' || leaseStatus === 'expired') {
                    await fetch(`${API_URL}/properties/${state.currentProperty._id}/units/${unitId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'vacant' })
                    });
                    await loadUnits(state.currentProperty._id);
                } else if (leaseStatus === 'active') {
                    await fetch(`${API_URL}/properties/${state.currentProperty._id}/units/${unitId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'occupied' })
                    });
                    await loadUnits(state.currentProperty._id);
                }
            }
        }, { once: true }); // Use once: true to auto-remove after submission
    } catch (error) {
        console.error('Error editing tenant:', error);
        showNotification('Error editing tenant', 'error');
    }
}


async function handleUpdateTenant(tenantId) {
    const tenant = state.tenants.find(t => t._id === tenantId);
    if (!tenant) {
        showNotification('Tenant not found', 'error');
        return;
    }

    const newUnitId = document.getElementById('tenantUnit').value;
    const oldUnitId = tenant.unitId?._id || tenant.unitId;

    // Gather car info if "Has Car(s)" is checked
    let cars = [];
    if (document.getElementById('hasCar').checked) {
        const carCount = parseInt(document.getElementById('carCount').value) || 0;
        for (let i = 0; i < carCount; i++) {
            cars.push({
                make: document.querySelector(`.car-make[data-index="${i}"]`)?.value || '',
                model: document.querySelector(`.car-model[data-index="${i}"]`)?.value || '',
                color: document.querySelector(`.car-color[data-index="${i}"]`)?.value || '',
                licensePlate: document.querySelector(`.car-plate[data-index="${i}"]`)?.value || '',
                year: document.querySelector(`.car-year[data-index="${i}"]`).value || ''
            });
        }
    }

    // Gather pet info if "Has Pets" is checked
    let pets = {
        hasPets: document.getElementById('hasPets').checked,
        count: document.getElementById('hasPets').checked ? Number(document.getElementById('petCount').value) : 0,
        fee: document.getElementById('hasPets').checked ? Number(document.getElementById('petFee')?.value) || 0 : 0,
        nonRefundableFee: document.getElementById('hasPets').checked ? Number(document.getElementById('petNonRefundableFee')?.value) || 0 : 0,
        monthlyRent: document.getElementById('hasPets').checked ? Number(document.getElementById('petMonthlyRent')?.value) || 0 : 0,
        depositIncrease: document.getElementById('hasPets').checked ? Number(document.getElementById('petDepositIncrease')?.value) || 0 : 0,
        details: []
    };
    if (pets.hasPets) {
        pets.details = Array.from(document.querySelectorAll('.pet-field-group')).map((group, i) => ({
            type: group.querySelector('.pet-type')?.value || '',
            name: group.querySelector('.pet-name')?.value || '',
            breed: group.querySelector('.pet-breed')?.value || '',
            weight: group.querySelector('.pet-weight')?.value || '',
            age: group.querySelector('.pet-age')?.value || '',
            gender: group.querySelector('.pet-gender')?.value || '',
            vaccination: group.querySelector('.pet-vaccination')?.value || ''
        }));
    }

    const tenantData = {
        name: document.getElementById('tenantName').value,
        phone: document.getElementById('tenantPhone').value,
        email: document.getElementById('tenantEmail').value,
        leaseHolders: getLeaseHoldersFromForm(),
        emergencyContact: {
            name: document.getElementById('emergencyContactName').value,
            phone: document.getElementById('emergencyContactPhone').value,
            email: document.getElementById('emergencyContactEmail').value,
            address: document.getElementById('emergencyContactAddress').value, 
            relation: document.getElementById('emergencyContactRelation').value
        },
        authorizedOccupants: document.getElementById('authorizedOccupants').value
            .split('\n')
            .map(s => s.trim())
            .filter(Boolean),
        pets,
        cars: {
            hasCar: document.getElementById('hasCar').checked,
            count: document.getElementById('hasCar').checked ? (parseInt(document.getElementById('carCount').value) || 0) : 0,
            details: cars
        },
        additionalFee: {
            type: document.getElementById('additionalFeeType').value,
            label: document.getElementById('additionalFeeLabel').value,
            amount: Number(document.getElementById('additionalFeeAmount').value) || 0
        },
        leaseRenewal: document.getElementById('leaseRenewal').value,
        unitId: newUnitId,
    leaseStart: dateInputToISOAtNoon(document.getElementById('leaseStart').value),
    leaseEnd: dateInputToISOAtNoon(document.getElementById('leaseEnd').value),
        baseRent: Number(document.getElementById('baseRent').value),
        deposit: Number(document.getElementById('deposit').value) || 0,
        waterFee: Number(document.getElementById('waterFee').value) || 0,
        trashFee: Number(document.getElementById('trashFee').value) || 0,
        adminFee: Number(document.getElementById('adminFee').value) || 0,
        leaseType: document.getElementById('leaseType').value,
        fmrNotes: document.getElementById('leaseType').value === 'fmr' ? document.getElementById('fmrNotes').value : '',
        hubContribution: document.getElementById('leaseType').value === 'section8' ? Number(document.getElementById('hubContribution').value) : 0,
        tenantContribution: document.getElementById('leaseType').value === 'section8' ? Number(document.getElementById('tenantContribution').value) : 0,
        leaseStatus: document.getElementById('leaseStatus').value,
        status: tenant.status || 'active'
    };

    // Validate lease dates
    if (new Date(tenantData.leaseStart) > new Date(tenantData.leaseEnd)) {
        showNotification('Lease end date must be after start date', 'error');
        return;
    }
    showLoader();
    try {
        // Update tenant
        const response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/tenants/${tenantId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(tenantData)
        });

        if (!response.ok) throw new Error('Failed to update tenant');

        // Handle unit status changes
        if (oldUnitId !== newUnitId) {
            // Set old unit to vacant if exists
            if (oldUnitId) {
                await fetch(`${API_URL}/properties/${state.currentProperty._id}/units/${oldUnitId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'vacant' })
                });
            }

            // Set new unit to occupied if selected
            if (newUnitId) {
                await fetch(`${API_URL}/properties/${state.currentProperty._id}/units/${newUnitId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'occupied' })
                });
            }
        }

        // If leaseStatus is 'terminated' or 'expired', set the unit to vacant
        if (
            (tenantData.leaseStatus === 'terminated' || tenantData.leaseStatus === 'expired') &&
            newUnitId
        ) {
            await fetch(`${API_URL}/properties/${state.currentProperty._id}/units/${newUnitId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'vacant' })
            });
        }

        // If leaseStatus is 'active', set the unit to occupied
        if (
            tenantData.leaseStatus === 'active' &&
            newUnitId
        ) {
            await fetch(`${API_URL}/properties/${state.currentProperty._id}/units/${newUnitId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'occupied' })
            });
        }

        invalidateCache('tenants','units');
        await Promise.all([
            refreshContent('tenants'),
            refreshContent('units')
        ]);
        
        // Reset form and close modal
        const form = document.getElementById('addTenantForm');
        form.reset();
        form.dataset.editMode = 'false';
        form.dataset.tenantId = '';
        
        // Reset the submit button text
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.textContent = 'Add Tenant';
        
    // The original global addEventListener('submit', handleAddTenant) remains.
    // Avoid assigning form.onsubmit here to prevent duplicate submission handlers
    // which caused double tenant creation.
        
        closeModal('addTenantModal');
        showNotification('Tenant updated successfully', 'success');
    runWhenIdle(() => loadAllUnitsAndTenants());
    } catch (error) {
        console.error('Error updating tenant:', error);
        showNotification('Error updating tenant', 'error');
    } finally {
        hideLoader();
    }
}


// Add this function to populate unit select when opening the tenant modal
function populateUnitSelect() {
    const unitSelect = document.getElementById('tenantUnit');
    if (!unitSelect || !state.units) return;
    
    // Get only vacant units
    const vacantUnits = state.units.filter(unit => unit.status === 'vacant');
    
    console.log('Vacant units:', vacantUnits); // Debug log
    
    // Clear existing options and add new ones
    unitSelect.innerHTML = `
        <option value="">Select a unit</option>
        ${vacantUnits.map(unit => `
            <option value="${unit._id}">
                Unit ${unit.number} - ${unit.bedrooms} bed, ${unit.bathrooms} bath
            </option>
        `).join('')}
    `;
}




//  deleteTenant function
async function deleteTenant(tenantId) {
    if (!confirm('Are you sure you want to delete this tenant?')) {
        return;
    }
   showLoader();
    try {
        const tenant = state.tenants.find(t => t._id === tenantId);
        if (!tenant) throw new Error('Tenant not found');

        const response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/tenants/${tenantId}`, {
            method: 'DELETE'
        });

        if (!response.ok) throw new Error('Failed to delete tenant');

        // If tenant was assigned to a unit, update unit status to vacant
        if (tenant.unitId) {
            await fetch(`${API_URL}/properties/${state.currentProperty._id}/units/${tenant.unitId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'vacant' })
            });
        }

        // Reload both tenants and units using universal refresh
        invalidateCache('tenants', 'units');
        await Promise.all([
            refreshContent('tenants'),
            refreshContent('units')
        ]);

        showNotification('Tenant deleted successfully', 'success');
    } catch (error) {
        console.error('Error deleting tenant:', error);
        showNotification('Error deleting tenant', 'error');
           } finally {
        hideLoader(); 
    }
}


let scheduleListView = false;

// Maintenance Request Management
async function handleAddMaintenance(event) {
    event.preventDefault();

    const formEl = event.target;
    const propertySelect = document.getElementById('maintenanceProperty');
    let projectId = '';
    if (propertySelect && propertySelect.value) {
        projectId = propertySelect.value;
    } else if (state.currentProperty && state.currentProperty._id) {
        projectId = state.currentProperty._id;
    }

    if (!projectId) {
        showNotification('Please select a property first', 'error');
        return;
    }

    const photosInput = document.getElementById('maintenancePhotos');
    const preview = document.getElementById('maintenancePhotosPreview');
    const hasPhotos = photosInput && photosInput.files && photosInput.files.length;
    // If photos were uploaded earlier as temp, they are stored in form dataset
    const tempPhotosPaths = (event.target.dataset.tempPhotosPaths ? JSON.parse(event.target.dataset.tempPhotosPaths) : []);
    let response;
    showLoader();
    try {
        if (tempPhotosPaths.length) {
            const formData = new FormData();
            formData.append('title', document.getElementById('maintenanceTitle').value.trim());
            formData.append('description', document.getElementById('maintenanceDescription').value.trim());
            formData.append('priority', document.getElementById('maintenancePriority').value);
            formData.append('unitId', document.getElementById('maintenanceUnit').value);
            formData.append('status', 'pending');
            formData.append('tempPhotosPaths', JSON.stringify(tempPhotosPaths));
            response = await fetch(`${API_URL}/properties/${projectId}/maintenance`, {
                method: 'POST',
                body: formData
            });
        } else {
            const maintenanceData = {
                title: document.getElementById('maintenanceTitle').value.trim(),
                description: document.getElementById('maintenanceDescription').value.trim(),
                priority: document.getElementById('maintenancePriority').value,
                unitId: document.getElementById('maintenanceUnit').value,
                status: 'pending'
            };
            response = await fetch(`${API_URL}/properties/${projectId}/maintenance`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(maintenanceData)
            });
        }

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to create maintenance request');
        }

        // Reset form before loading new data
        event.target.reset();
        event.target.dataset.tempPhotosPaths = JSON.stringify([]);
        if (preview) preview.innerHTML = '';
        closeModal('addMaintenanceModal');
        
        const ctx = formEl && formEl.dataset ? formEl.dataset.context || '' : '';
        if (ctx === 'portfolio') {
            try {
                await renderPortfolioOverview();
                renderPortfolioDetails('maintenance');
            } catch (e) {
                console.warn('Error refreshing portfolio maintenance after new request:', e);
            }
        } else {
            invalidateCache('maintenance');
            await refreshContent('maintenance');
        }
        showNotification('Maintenance request created successfully', 'success');
        

    } catch (error) {
        console.error('Error creating maintenance request:', error);
        showNotification(error.message || 'Error creating maintenance request', 'error');
            } finally {
        hideLoader();
    }
}

// Immediate temp upload on file selection with deletion confirmation
document.getElementById('maintenancePhotos')?.addEventListener('change', async function() {
    const input = this;
    const preview = document.getElementById('maintenancePhotosPreview');
    const form = document.getElementById('addMaintenanceForm');
    if (!input.files || !input.files.length || !form) return;
    try {
        const propertySelect = document.getElementById('maintenanceProperty');
        let projectId = '';
        if (propertySelect && propertySelect.value) {
            projectId = propertySelect.value;
        } else if (state.currentProperty && state.currentProperty._id) {
            projectId = state.currentProperty._id;
        }
        if (!projectId) {
            showNotification('Please select a property before uploading photos', 'error');
            return;
        }
        const fd = new FormData();
        Array.from(input.files).forEach(f => fd.append('photos', f));
        const resp = await fetch(`${API_URL}/properties/${projectId}/maintenance/temp-photos`, { method: 'POST', body: fd });
        if (!resp.ok) throw new Error('Failed to upload photos');
        const data = await resp.json();
        const current = form.dataset.tempPhotosPaths ? JSON.parse(form.dataset.tempPhotosPaths) : [];
        const all = Array.from(new Set(current.concat(data.photos || [])));
        form.dataset.tempPhotosPaths = JSON.stringify(all);
        // Render previews with removable X
        preview.innerHTML = all.map(url => {
            return `<div class="maint-thumb" data-url="${url}" style="position:relative;width:72px;height:72px;border-radius:6px;overflow:hidden;box-shadow:0 0 4px rgba(0,0,0,0.15);">
                <img src="${url}" style="width:100%;height:100%;object-fit:cover;">
                <button type="button" class="thumb-remove" title="Remove" style="position:absolute;top:4px;right:4px;width:18px;height:18px;border:none;border-radius:50%;background:rgba(0,0,0,0.65);color:#fff;font-size:12px;line-height:18px;text-align:center;cursor:pointer;"></button>
            </div>`;
        }).join('');
        preview.querySelectorAll('.thumb-remove').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const wrap = e.currentTarget.closest('.maint-thumb');
                const url = wrap?.getAttribute('data-url');
                if (!url) return;
                // Confirm deletion
                if (!confirm('Remove this photo from the request?')) return;
                // Remove from dataset and UI; also delete temp file on server (optional)
                const list = JSON.parse(form.dataset.tempPhotosPaths || '[]').filter(p => p !== url);
                form.dataset.tempPhotosPaths = JSON.stringify(list);
                wrap.remove();
                // Attempt to delete temp file
                try {
                    // No dedicated temp delete API; rely on server cleanup or ignore
                } catch {}
            });
        });
        // Clear input so same files can be re-selected again
        input.value = '';
    } catch (err) {
        console.error('Temp upload error:', err);
        showNotification(err.message || 'Error uploading photos', 'error');
    }
});

function updateMaintenanceTabBadge() {
    const badge = document.getElementById('maintenancePendingBadge');
    const pendingCount = state.maintenanceRequests.filter(r =>
        r.status === 'pending' || r.status === 'in-progress'
    ).length;
    if (pendingCount > 0) {
        badge.textContent = pendingCount > 9 ? '9+' : pendingCount;
        badge.style.display = '';
    } else {
        badge.style.display = 'none';
    }
}


async function loadMaintenanceRequests(propertyId, force = false) {
    try {
        const response = await fetch(`${API_URL}/properties/${propertyId}/maintenance${force ? `?_=${Date.now()}` : ''}`);
        if (!response.ok) throw new Error('Failed to fetch maintenance requests');

        const requests = await response.json();
        state.maintenanceRequests = requests;
        console.log('Loaded maintenance requests:', state.maintenanceRequests);
        renderMaintenanceRequests();
        updateMaintenanceTabBadge();
    } catch (error) {
        console.error('Error loading maintenance requests:', error);
        showNotification('Error loading maintenance requests', 'error');
    }
}

function renderMaintenanceRequestsList(requests) {
  const maintenanceList = document.getElementById('maintenanceList');
  if (!maintenanceList) return;

  if (!requests.length) {
    maintenanceList.innerHTML = `
      <div class="empty-state" style="text-align:center;padding:32px;">
        <i class="fas fa-tools" style="font-size:2.2em;color:#3498db;margin-bottom:12px;"></i>
        <p style="font-size:1.1em;color:#888;">No maintenance requests found.</p>
      </div>
    `;
    return;
  }

  maintenanceList.innerHTML = `
    <div style="overflow-x:auto;">
      <table class="maintenance-table" style="width:100%;border-collapse:collapse;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(44,62,80,0.07);margin-bottom:18px;">
        <thead>
          <tr style="background:#f6fafd;">
            <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Title</th>
            <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Description</th>
            <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Priority</th>
            <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Unit</th>
            <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Status</th>
            <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Created</th>
            <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Actions</th>
          </tr>
        </thead>
        <tbody>
          ${requests.map(request => {
            const unit = typeof request.unitId === 'object' ? request.unitId : state.units.find(u => u._id === request.unitId);
            const createdDate = new Date(request.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const priorityBadge = `<span class="priority-badge ${request.priority}">${request.priority.charAt(0).toUpperCase() + request.priority.slice(1)}</span>`;
            const statusBadge = `<span class="status-badge ${request.status}">${request.status.charAt(0).toUpperCase() + request.status.slice(1)}</span>`;
                        return `
                            <tr style="border-bottom:1px solid #e1e8ed;" data-maint-id="${request._id}">
                <td style="padding:10px 8px;font-weight:600;color:#2c3e50;">${request.title}</td>
                <td style="padding:10px 8px;color:#555;">${request.description || ''}</td>
                <td style="padding:10px 8px;">${priorityBadge}</td>
                <td style="padding:10px 8px;">${unit ? `Unit ${unit.number}` : 'N/A'}</td>
                <td style="padding:10px 8px;">${statusBadge}</td>
                <td style="padding:10px 8px;">${createdDate}</td>
                <td style="padding:10px 8px;">
                  <button onclick="editMaintenance('${request._id}')" class="btn-secondary" title="Edit" style="margin-right:6px;">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="deleteMaintenance('${request._id}')" class="btn-icon delete-btn" title="Delete" style="margin-left:2px;">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;

    // If we navigated here from the global overview, focus the selected request
    focusMaintenanceRequest();
}

// Update the renderMaintenanceRequests function
function renderMaintenanceRequests() {
  const maintenanceList = document.getElementById('maintenanceList');
  if (!state.maintenanceRequests?.length) {
    maintenanceList.innerHTML = `
      <div class="empty-state" style="text-align:center;padding:32px;">
        <i class="fas fa-tools" style="font-size:2.2em;color:#3498db;margin-bottom:12px;"></i>
        <p style="font-size:1em;color:#888;">No maintenance requests found.</p>
      </div>
    `;
    return;
  }

  maintenanceList.innerHTML = state.maintenanceRequests.map(request => {
    // Find the associated unit
    const unit = typeof request.unitId === 'object' ? request.unitId : 
      state.units.find(u => u._id === request.unitId);

    // Format creation date
    const createdDate = new Date(request.createdAt).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    });

    // Priority badge
    const priorityBadge = `<span class="badge badge-info" style="background:#fff3cd;color:#856404;padding:2px 10px;border-radius:10px;font-size:0.92em;">
      <i class="fas fa-exclamation-circle"></i> ${request.priority.charAt(0).toUpperCase() + request.priority.slice(1)} Priority
    </span>`;

    // Status badge with icon
    let statusIcon = '<i class="fas fa-clock"></i>';
    if (request.status === 'completed') statusIcon = '<i class="fas fa-check-circle"></i>';
    else if (request.status === 'in-progress') statusIcon = '<i class="fas fa-spinner"></i>';
    const statusBadge = `<span class="status-badge ${request.status}" style="padding:4px 12px;border-radius:15px;font-size:0.82em;font-weight:600;">
      ${statusIcon} ${request.status.charAt(0).toUpperCase() + request.status.slice(1)}
    </span>`;

    // --- Make description stand out ---
    const descriptionHtml = `
      <div style="
        margin-bottom:12px;
        background: linear-gradient(90deg, #eaf6ff 0%, #f7f7ff 100%);
        border-left: 4px solid #3498db;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.97em;
        color: #217dbb;
        font-weight: 500;
        box-shadow: 0 1px 4px rgba(44,62,80,0.05);
      ">
        <i class="fas fa-align-left" style="margin-right:7px;color:#217dbb;"></i>
        ${request.description || '<span style="color:#888;">No description provided.</span>'}
      </div>
    `;

        return `
            <div class="maintenance-card" data-maint-id="${request._id}" style="border:1.5px solid #e1e8ed;box-shadow:0 2px 8px rgba(44,62,80,0.07);margin-bottom:18px;font-size:0.97em;">
        <div class="maintenance-header" style="background:#f6fafd;padding:12px 18px;border-bottom:1px solid #e1e8ed;display:flex;justify-content:space-between;align-items:center;">
          <div>
            <strong style="font-size:1.08em;color:#2c3e50;"><i class="fas fa-tools" style="color:#217dbb;margin-right:8px;"></i>${request.title}</strong>
            <span style="margin-left:12px;">${priorityBadge}</span>
          </div>
          <div class="maintenance-actions">
            <button onclick="editMaintenance('${request._id}')" class="btn-secondary" style="margin-right:6px;font-size:0.97em;">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button onclick="deleteMaintenance('${request._id}')" class="btn-icon delete-btn" title="Delete Request" style="font-size:0.97em;">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        <div class="maintenance-content" style="padding:14px 18px;">
                    <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
            <div>
              ${descriptionHtml}
              <div style="margin-bottom:8px;"><strong><i class="fas fa-calendar-alt"></i> Created:</strong> <span style="color:#217dbb;">${createdDate}</span></div>
              <div style="margin-bottom:8px;"><strong><i class="fas fa-info-circle"></i> Status:</strong> ${statusBadge}</div>
            </div>
                        <div>
                            <div style="margin-bottom:8px;"> ${unit ? `<i class="fas fa-door-open"></i> Unit ${unit.number}` : '<span style="color:#888;font-size:0.97em;"><i class="fas fa-door-closed"></i> None</span>'}</div>
                            ${Array.isArray(request.photos) && request.photos.length ? `
                                <div class="maintenance-photos" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;">
                                    ${request.photos.map((src, idx) => `
                                        <div class="photo-thumb" style="width:74px;height:74px;border-radius:6px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,0.12);cursor:pointer;">
                                            <img src="${src}" alt="Photo ${idx+1}" style="width:100%;height:100%;object-fit:cover;" onclick="openMaintenancePhotoViewer('${request._id}', ${idx})">
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
          </div>
        </div>
      </div>
    `;
  }).join('');

    // If we navigated here from the global overview, focus the selected request
    focusMaintenanceRequest();
}

function focusMaintenanceRequest() {
    try {
        const targetId = state.highlightMaintenanceId;
        if (!targetId) return;
        const el = document.querySelector(`[data-maint-id="${targetId}"]`);
        if (!el) {
            state.highlightMaintenanceId = null;
            return;
        }
        el.classList.add('maintenance-highlight');
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => {
            el.classList.remove('maintenance-highlight');
        }, 2200);
        state.highlightMaintenanceId = null;
    } catch (_) {
        state.highlightMaintenanceId = null;
    }
}


// Add before the window exports

async function deleteMaintenance(requestId) {
    if (!confirm('Are you sure you want to delete this maintenance request?')) {
        return;
    }
     showLoader();
    try {
        const response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/maintenance/${requestId}`, {
            method: 'DELETE'
        });

        if (!response.ok) throw new Error('Failed to delete maintenance request');

    invalidateCache('maintenance');
    await refreshContent('maintenance');
        showNotification('Maintenance request deleted successfully', 'success');
    } catch (error) {
        console.error('Error deleting maintenance request:', error);
        showNotification('Error deleting maintenance request', 'error');
            } finally {
        hideLoader();
    }
}

// Photo viewer modal (full-screen, next/prev)
(function setupMaintenancePhotoViewer(){
    if (!document.getElementById('maintenancePhotoViewer')) {
        const viewerHtml = `
            <div id="maintenancePhotoViewer" class="modal" style="display:none;background:rgba(0,0,0,0.8);">
                <div class="modal-content" style="max-width:900px;background:#000;color:#fff;">
                    <div id="mpvBody" style="position:relative;display:flex;align-items:center;justify-content:center;min-height:480px;">
                        <button id="mpvPrev" class="btn-secondary" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);opacity:0.9;"></button>
                        <img id="mpvImage" src="" alt="Photo" style="max-width:100%;max-height:80vh;object-fit:contain;border-radius:6px;">
                        <button id="mpvNext" class="btn-secondary" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);opacity:0.9;"></button>
                        <button id="mpvClose" class="btn-secondary" style="position:absolute;right:10px;top:10px;"></button>
                    </div>
                    <div id="mpvCaption" style="padding:8px 12px;color:#ddd;font-size:0.9em;"></div>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', viewerHtml);
    }
    const viewer = document.getElementById('maintenancePhotoViewer');
    const img = document.getElementById('mpvImage');
    const caption = document.getElementById('mpvCaption');
    const btnPrev = document.getElementById('mpvPrev');
    const btnNext = document.getElementById('mpvNext');
    const btnClose = document.getElementById('mpvClose');
    let currentList = [];
    let currentIndex = 0;

    function render() {
        if (!currentList.length) return;
        img.src = currentList[currentIndex];
        caption.textContent = `Photo ${currentIndex+1} of ${currentList.length}`;
        btnPrev.disabled = currentIndex === 0;
        btnNext.disabled = currentIndex === currentList.length - 1;
    }

    window.openMaintenancePhotoViewer = (requestId, startIdx = 0) => {
        const req = (state.maintenanceRequests || []).find(r => r._id === requestId);
        const photos = Array.isArray(req?.photos) ? req.photos : [];
        if (!photos.length) return;
        currentList = photos;
        currentIndex = Math.max(0, Math.min(startIdx, photos.length-1));
        render();
        openModal('maintenancePhotoViewer');
    };

    btnPrev.addEventListener('click', () => { if (currentIndex > 0) { currentIndex--; render(); } });
    btnNext.addEventListener('click', () => { if (currentIndex < currentList.length - 1) { currentIndex++; render(); } });
    btnClose.addEventListener('click', () => closeModal('maintenancePhotoViewer'));
})();


async function updateMaintenanceStatus(requestId) {
    try {
        const request = state.maintenanceRequests.find(r => r._id === requestId);
        if (!request) throw new Error('Maintenance request not found');

        // Wait for user to select a status (no loader here)
        const newStatus = await showStatusDialog(request.status);
        if (!newStatus) return; // User cancelled

        showLoader(); // Only show loader for the network request
        const response = await fetch(
            `${API_URL}/properties/${state.currentProperty._id}/maintenance/${requestId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            }
        );

        if (!response.ok) throw new Error('Failed to update maintenance status');
        
    invalidateCache('maintenance');
    await refreshContent('maintenance');
        showNotification('Maintenance status updated successfully', 'success');
    } catch (error) {
        console.error('Error updating maintenance status:', error);
        showNotification('Error updating maintenance status', 'error');
    } finally {
        hideLoader();
    }
}

// Full edit (all fields + photos append)
async function editMaintenance(requestId) {
        try {
                const request = state.maintenanceRequests.find(r => r._id === requestId);
                if (!request) throw new Error('Maintenance request not found');

                let modal = document.getElementById('editMaintenanceModal');
                if (!modal) {
                        const html = `
                        <div class="modal" id="editMaintenanceModal" style="display:none;">
                            <div class="modal-content">
                                <h2>Edit Maintenance Request</h2>
                                <form id="editMaintenanceForm">
                                    <div class="form-group">
                                        <label>Title</label>
                                        <input type="text" id="editMaintenanceTitle" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Description</label>
                                        <textarea id="editMaintenanceDescription" required style="min-height:110px;"></textarea>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Priority</label>
                                            <select id="editMaintenancePriority" required>
                                                <option value="urgent">Urgent</option>
                                                <option value="high">High</option>
                                                <option value="medium">Medium</option>
                                                <option value="low">Low</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Status</label>
                                            <select id="editMaintenanceStatus" required>
                                                <option value="pending">Pending</option>
                                                <option value="in-progress">In-Progress</option>
                                                <option value="completed">Completed</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Unit</label>
                                            <select id="editMaintenanceUnit"><option value="">None</option></select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Photos (add more)</label>
                                        <input type="file" id="editMaintenancePhotos" multiple accept="image/*">
                                    </div>
                                    <div id="existingMaintenancePhotos" style="display:flex;flex-wrap:wrap;gap:6px;margin:10px 0;"></div>
                                    <div class="modal-buttons">
                                        <button type="button" id="cancelEditMaintenanceBtn" class="btn-secondary">Cancel</button>
                                        <button type="submit" class="btn-primary">Save Changes</button>
                                    </div>
                                </form>
                            </div>
                        </div>`;
                        document.body.insertAdjacentHTML('beforeend', html);
                        modal = document.getElementById('editMaintenanceModal');
                }

                // Populate fields
                document.getElementById('editMaintenanceTitle').value = request.title || '';
                document.getElementById('editMaintenanceDescription').value = request.description || '';
                document.getElementById('editMaintenancePriority').value = request.priority || 'medium';
                document.getElementById('editMaintenanceStatus').value = request.status || 'pending';

                // Units
                const unitSelect = document.getElementById('editMaintenanceUnit');
                if (unitSelect) {
                        const currentId = request.unitId && (request.unitId._id || request.unitId);
                        unitSelect.innerHTML = `<option value="">None</option>` + (state.units || [])
                            .map(u => `<option value="${u._id}" ${currentId === u._id ? 'selected' : ''}>Unit ${u.number}</option>`)
                            .join('');
                }

                                // Existing photos preview with remove controls
                                const existing = document.getElementById('existingMaintenancePhotos');
                                const photos = request.photos || [];
                                const thumbStyle = 'position:relative;display:inline-block;width:72px;height:72px;border-radius:6px;overflow:hidden;box-shadow:0 0 4px rgba(0,0,0,0.15);';
                                const closeStyle = 'position:absolute;top:4px;right:4px;width:18px;height:18px;border:none;border-radius:50%;background:rgba(0,0,0,0.65);color:#fff;font-size:12px;line-height:18px;text-align:center;cursor:pointer;';
                                existing.innerHTML = photos.length ? photos.map(p => `
                                    <div class="maint-thumb" data-url="${p}" style="${thumbStyle}">
                                        <img src="${p}" style="width:100%;height:100%;object-fit:cover;">
                                        <button type="button" class="thumb-remove" title="Remove" style="${closeStyle}"></button>
                                    </div>
                                `).join('') : '<em style="color:#888;">No photos yet.</em>';
                                existing.querySelectorAll('.thumb-remove').forEach(btn => {
                                    btn.addEventListener('click', (e) => {
                                        const wrap = e.currentTarget.closest('.maint-thumb');
                                        const url = wrap?.getAttribute('data-url');
                                        if (!url) return;
                                        if (!confirm('Delete this photo permanently?')) return;
                                        (async () => {
                                            try {
                                                showLoader();
                                                const resp = await fetch(`${API_URL}/properties/${state.currentProperty._id}/maintenance/${requestId}/photos`, {
                                                    method: 'DELETE',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify({ url })
                                                });
                                                if (!resp.ok) throw new Error('Failed to delete photo');
                                                wrap.remove();
                                                const idx = (request.photos || []).indexOf(url);
                                                if (idx >= 0) request.photos.splice(idx, 1);
                                                showNotification('Photo deleted', 'success');
                                                // Refresh global list so cards reflect changes immediately
                                                try {
                                                    invalidateCache('maintenance');
                                                    await refreshContent('maintenance');
                                                } catch {}
                                            } catch (err) {
                                                console.error('Photo delete error:', err);
                                                showNotification(err.message || 'Error deleting photo', 'error');
                                            } finally {
                                                hideLoader();
                                            }
                                        })();
                                    });
                                });

                // Show modal
                modal.style.display = 'block';
                openModal('editMaintenanceModal');

                document.getElementById('cancelEditMaintenanceBtn').onclick = () => {
                        closeModal('editMaintenanceModal');
                };

                const form = document.getElementById('editMaintenanceForm');
                form.onsubmit = async (e) => {
                        e.preventDefault();
                        showLoader();
                        try {
                                const fd = new FormData();
                                fd.append('title', document.getElementById('editMaintenanceTitle').value.trim());
                                fd.append('description', document.getElementById('editMaintenanceDescription').value.trim());
                                fd.append('priority', document.getElementById('editMaintenancePriority').value);
                                fd.append('status', document.getElementById('editMaintenanceStatus').value);
                                fd.append('unitId', document.getElementById('editMaintenanceUnit').value);
                                const photoInput = document.getElementById('editMaintenancePhotos');
                                if (photoInput && photoInput.files.length) {
                                        Array.from(photoInput.files).forEach(f => fd.append('photos', f));
                                }
                        // Include any temp-uploaded new photos collected before save
                        const tempNew = form.dataset.tempPhotosPaths ? JSON.parse(form.dataset.tempPhotosPaths) : [];
                        if (tempNew.length) {
                            fd.append('tempPhotosPaths', JSON.stringify(tempNew));
                        }
                                const resp = await fetch(`${API_URL}/properties/${state.currentProperty._id}/maintenance/${requestId}`, {
                                        method: 'PUT',
                                        body: fd
                                });
                                if (!resp.ok) throw new Error('Failed to update maintenance request');
                                closeModal('editMaintenanceModal');
                                invalidateCache('maintenance');
                                await refreshContent('maintenance');
                                showNotification('Maintenance request updated', 'success');
                        } catch (err) {
                                console.error('Error updating maintenance request:', err);
                                showNotification(err.message || 'Error updating maintenance', 'error');
                        } finally {
                                hideLoader();
                        }
                };
                // Instant temp upload on new photo selection in edit modal
                const editInput = document.getElementById('editMaintenancePhotos');
                // Avoid attaching duplicate listeners if modal reopened
                if (!modal.dataset.photosListenerAttached && editInput) {
                modal.dataset.photosListenerAttached = 'true';
                editInput.addEventListener('change', async function() {
                    if (!this.files || !this.files.length) return;
                    try {
                        const fd = new FormData();
                        Array.from(this.files).forEach(f => fd.append('photos', f));
                        const resp = await fetch(`${API_URL}/properties/${state.currentProperty._id}/maintenance/temp-photos`, { method: 'POST', body: fd });
                        if (!resp.ok) throw new Error('Failed to upload photos');
                        const data = await resp.json();
                        const current = form.dataset.tempPhotosPaths ? JSON.parse(form.dataset.tempPhotosPaths) : [];
                        const all = Array.from(new Set(current.concat(data.photos || [])));
                        form.dataset.tempPhotosPaths = JSON.stringify(all);
                        // Render appended previews right in the existing section
                        const existing = document.getElementById('existingMaintenancePhotos');
                        const thumbStyle = 'position:relative;display:inline-block;width:72px;height:72px;border-radius:6px;overflow:hidden;box-shadow:0 0 4px rgba(0,0,0,0.15);';
                        const closeStyle = 'position:absolute;top:4px;right:4px;width:18px;height:18px;border:none;border-radius:50%;background:rgba(0,0,0,0.65);color:#fff;font-size:12px;line-height:18px;text-align:center;cursor:pointer;';
                        (data.photos || []).forEach(url => {
                            // If placeholder text is present, clear it before adding real thumbnails
                            if (existing && existing.textContent && existing.textContent.includes('No photos yet')) {
                                existing.innerHTML = '';
                            }
                            const wrap = document.createElement('div');
                            wrap.className = 'maint-thumb';
                            wrap.setAttribute('data-url', url);
                            wrap.style = thumbStyle;
                            wrap.innerHTML = `<img src="${url}" style="width:100%;height:100%;object-fit:cover;"><button type="button" class="thumb-remove" title="Remove" style="${closeStyle}"></button>`;
                            existing.appendChild(wrap);
                            wrap.querySelector('.thumb-remove')?.addEventListener('click', (e) => {
                                if (!confirm('Remove this photo from the update?')) return;
                                const list = JSON.parse(form.dataset.tempPhotosPaths || '[]').filter(p => p !== url);
                                form.dataset.tempPhotosPaths = JSON.stringify(list);
                                wrap.remove();
                                // No server delete required; these are temp files not yet committed if removed
                            });
                        });
                        this.value = '';
                    } catch (err) {
                        console.error('Temp upload error:', err);
                        showNotification(err.message || 'Error uploading photos', 'error');
                    }
                });
                }
        } catch (error) {
                console.error('Error preparing maintenance edit:', error);
                showNotification('Error loading maintenance request for edit', 'error');
        }
}


// Update the showStatusDialog function
function showStatusDialog(currentStatus) {
    return new Promise(resolve => {
        const statuses = [
            { value: 'pending', icon: 'clock', label: 'Pending' },
            { value: 'in-progress', icon: 'tools', label: 'In Progress' },
            { value: 'completed', icon: 'check-circle', label: 'Completed' }
        ];

        const dialog = document.createElement('div');
        dialog.className = 'modal status-dialog';
        
        dialog.innerHTML = `
            <div class="modal-content">
                <h3>Update Maintenance Status</h3>
                <div class="status-options">
                    ${statuses.map(status => `
                        <button class="status-option ${status.value} ${status.value === currentStatus ? 'active' : ''}"
                                onclick="updateStatus('${status.value}')">
                            <i class="fas fa-${status.icon}"></i>
                            ${status.label}
                            ${status.value === currentStatus ? 
                                '<i class="fas fa-check" style="margin-left: auto"></i>' : 
                                ''}
                        </button>
                    `).join('')}
                </div>
                <div class="dialog-footer">
                    <button onclick="cancelStatusUpdate()" class="btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(dialog);
        dialog.style.display = 'block';

        // Close dialog if clicking outside
        dialog.addEventListener('click', (e) => {
            if (e.target === dialog) {
                cancelStatusUpdate();
            }
        });

        window.updateStatus = (status) => {
            document.body.removeChild(dialog);
            delete window.updateStatus;
            delete window.cancelStatusUpdate;
            resolve(status);
        };

        window.cancelStatusUpdate = () => {
            document.body.removeChild(dialog);
            delete window.updateStatus;
            delete window.cancelStatusUpdate;
            resolve(null);
        };
    });
}



// Maintenance Schedules
async function loadMaintenanceSchedules() {
  if (!state.currentProperty) return;
  showLoader();
  try {
    const res = await fetch(`/api/properties/${state.currentProperty._id}/maintenance-schedules`);
    if (!res.ok) throw new Error('Failed to fetch maintenance schedules');
    const schedules = await res.json();
    if (scheduleListView) {
      renderMaintenanceSchedulesList(schedules);
    } else {
      renderMaintenanceSchedules(schedules);
    }
  } catch (err) {
    console.error('Error loading maintenance schedules:', err);
    showNotification('Error loading maintenance schedules', 'error');
  } finally {
    hideLoader();
  }
}

function focusApplication() {
    try {
        const targetId = state.highlightApplicationId;
        if (!targetId) return;
        const row = document.querySelector(`[data-app-id="${targetId}"]`);
        if (!row) {
            state.highlightApplicationId = null;
            return;
        }
        row.classList.add('application-highlight');
        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => {
            row.classList.remove('application-highlight');
        }, 2200);
        state.highlightApplicationId = null;
    } catch (_) {
        state.highlightApplicationId = null;
    }
}

// Add this event listener after DOMContentLoaded
document.getElementById('toggleScheduleViewBtn').addEventListener('click', () => {
  scheduleListView = !scheduleListView;
  document.getElementById('scheduleViewIcon').className = scheduleListView ? 'fas fa-list' : 'fas fa-th-large';
  document.getElementById('scheduleViewLabel').textContent = scheduleListView ? 'List View' : 'Card View';
  if (currentMaintenanceTab === 'schedules') {
    loadMaintenanceSchedules();
  } else {
    if (scheduleListView) {
      renderMaintenanceRequestsList(state.maintenanceRequests);
    } else {
      renderMaintenanceRequests();
    }
  }
});

const completeModalHtml = `
  <div class="modal" id="completeScheduleModal" style="display:none;">
    <div class="modal-content" style="max-width:400px;">
      <h2 style="font-size:1.3em;margin-bottom:18px;">Mark Schedule as Completed</h2>
      <form id="completeScheduleForm">
        <div class="form-group">
          <label for="completedByInput">Completed By</label>
          <input type="text" id="completedByInput" required>
        </div>
        <div class="form-group">
          <label for="completedNotesInput">Notes (optional)</label>
          <textarea id="completedNotesInput" rows="2"></textarea>
        </div>
        <div class="modal-buttons" style="margin-top:18px;">
          <button type="button" class="btn-secondary" id="cancelCompleteScheduleBtn">Cancel</button>
          <button type="submit" class="btn-primary">Mark as Completed</button>
        </div>
      </form>
    </div>
  </div>
`;
if (!document.getElementById('completeScheduleModal')) {
  document.body.insertAdjacentHTML('beforeend', completeModalHtml);
}

// Move-in Readiness Checklist Modal (static markup injected once)
const moveInChecklistHtml = `
   
    <div class="modal" id="moveInChecklistModal" style="display:none;">
        <div class="modal-content" style="max-width:720px;">
            <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <h2 style="margin:0;font-size:1.6rem;">Move-in Readiness Checklist</h2>
                <button type="button" class="btn-secondary" onclick="closeModal('moveInChecklistModal')">Close</button>
            </div>
            <div class="modal-body" style="max-height:540px;overflow:auto;font-size:0.9rem;">
                <p id="moveInChecklistContext" style="margin-bottom:12px;color:#4b5563;"></p>

                <h3 style="margin-top:16px;font-size:1rem;color:#111827;">Leasing &amp; Admin</h3>
                <ul style="list-style:none;padding-left:0;margin-top:8px;margin-bottom:12px;">
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="leasing_lease_signed"> Lease fully signed by all parties</label>
                            <button type="button" class="movein-note-toggle" data-item-id="leasing_lease_signed" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="leasing_lease_signed" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="leasing_funds_received"> Move-in funds received and cleared</label>
                            <button type="button" class="movein-note-toggle" data-item-id="leasing_funds_received" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="leasing_funds_received" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="leasing_deposit_received"> Deposit received</label>
                            <button type="button" class="movein-note-toggle" data-item-id="leasing_deposit_received" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="leasing_deposit_received" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="leasing_tenant_entered"> Tenant info entered into system</label>
                            <button type="button" class="movein-note-toggle" data-item-id="leasing_tenant_entered" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="leasing_tenant_entered" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="leasing_emergency_contacts"> Emergency contacts collected</label>
                            <button type="button" class="movein-note-toggle" data-item-id="leasing_emergency_contacts" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="leasing_emergency_contacts" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="leasing_renters_insurance"> Renter's insurance verified (if required)</label>
                            <button type="button" class="movein-note-toggle" data-item-id="leasing_renters_insurance" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="leasing_renters_insurance" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                </ul>

                <h3 style="margin-top:16px;font-size:1rem;color:#111827;">Utilities &amp; Services</h3>
                <ul style="list-style:none;padding-left:0;margin-top:8px;margin-bottom:12px;">
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="utilities_electricity"> Electricity on and Transferred to tenant</label>
                            <button type="button" class="movein-note-toggle" data-item-id="utilities_electricity" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="utilities_electricity" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="utilities_water"> Water on and Transferred to tenant</label>
                            <button type="button" class="movein-note-toggle" data-item-id="utilities_water" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="utilities_water" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="utilities_gas"> Gas on and Transferred to tenant (if applicable)</label>
                            <button type="button" class="movein-note-toggle" data-item-id="utilities_gas" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="utilities_gas" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                </ul>

                <h3 style="margin-top:16px;font-size:1rem;color:#111827;">Maintenance &amp; Safety</h3>
                <ul style="list-style:none;padding-left:0;margin-top:8px;margin-bottom:12px;">
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="safety_lights"> All lights working (fixtures + bulbs)</label>
                            <button type="button" class="movein-note-toggle" data-item-id="safety_lights" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="safety_lights" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="safety_outlets"> Outlets and switches tested</label>
                            <button type="button" class="movein-note-toggle" data-item-id="safety_outlets" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="safety_outlets" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="safety_gfci"> GFCI outlets reset and working</label>
                            <button type="button" class="movein-note-toggle" data-item-id="safety_gfci" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="safety_gfci" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="safety_smoke_detectors"> Smoke detectors tested</label>
                            <button type="button" class="movein-note-toggle" data-item-id="safety_smoke_detectors" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="safety_smoke_detectors" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="safety_co_detectors"> CO detectors tested (if applicable)</label>
                            <button type="button" class="movein-note-toggle" data-item-id="safety_co_detectors" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="safety_co_detectors" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="safety_locks"> Door and window locks working</label>
                            <button type="button" class="movein-note-toggle" data-item-id="safety_locks" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="safety_locks" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="safety_deadbolts"> Deadbolts installed and re-keyed</label>
                            <button type="button" class="movein-note-toggle" data-item-id="safety_deadbolts" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="safety_deadbolts" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="safety_screens"> Screens installed (if provided)</label>
                            <button type="button" class="movein-note-toggle" data-item-id="safety_screens" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="safety_screens" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="safety_leaks"> No active leaks (sinks, toilets, water heater)</label>
                            <button type="button" class="movein-note-toggle" data-item-id="safety_leaks" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="safety_leaks" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="safety_toilet"> Toilet secure and flushing properly</label>
                            <button type="button" class="movein-note-toggle" data-item-id="safety_toilet" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="safety_toilet" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="safety_hot_water"> Hot water working</label>
                            <button type="button" class="movein-note-toggle" data-item-id="safety_hot_water" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="safety_hot_water" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="safety_hvac"> HVAC working (cool + heat tested)</label>
                            <button type="button" class="movein-note-toggle" data-item-id="safety_hvac" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="safety_hvac" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="safety_filters"> Filters replaced</label>
                            <button type="button" class="movein-note-toggle" data-item-id="safety_filters" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="safety_filters" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                </ul>

                <h3 style="margin-top:16px;font-size:1rem;color:#111827;">Cleaning &amp; Turnover</h3>
                <ul style="list-style:none;padding-left:0;margin-top:8px;margin-bottom:12px;">
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="clean_deep_clean"> Full unit deep clean complete</label>
                            <button type="button" class="movein-note-toggle" data-item-id="clean_deep_clean" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="clean_deep_clean" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="clean_floors"> Floors cleaned (vacuum + mop)</label>
                            <button type="button" class="movein-note-toggle" data-item-id="clean_floors" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="clean_floors" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="clean_baseboards"> Baseboards wiped</label>
                            <button type="button" class="movein-note-toggle" data-item-id="clean_baseboards" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="clean_baseboards" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="clean_windows"> Windows cleaned (inside)</label>
                            <button type="button" class="movein-note-toggle" data-item-id="clean_windows" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="clean_windows" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="clean_blinds"> Blinds cleaned or replaced</label>
                            <button type="button" class="movein-note-toggle" data-item-id="clean_blinds" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="clean_blinds" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="clean_trash"> Trash removed from unit &amp; exterior</label>
                            <button type="button" class="movein-note-toggle" data-item-id="clean_trash" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="clean_trash" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                    <li>
                        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                            <label style="flex:1 1 auto;"><input type="checkbox" class="movein-check-item" data-item-id="clean_odor"> Odor check (no smoke, pets, or mildew)</label>
                            <button type="button" class="movein-note-toggle" data-item-id="clean_odor" title="Add note" style="cursor:pointer;">+ note</button>
                        </div>
                        <input type="text" class="movein-check-note" data-item-id="clean_odor" placeholder="Add note (optional)" style="display:none;margin-top:4px;width:100%;font-size:0.8rem;padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;" />
                    </li>
                </ul>
            </div>
        </div>
    </div>
`;
if (!document.getElementById('moveInChecklistModal')) {
    document.body.insertAdjacentHTML('beforeend', moveInChecklistHtml);
}

// Persist move-in checklist changes
const moveInChecklistModalEl = document.getElementById('moveInChecklistModal');
if (moveInChecklistModalEl) {
    // Toggle note field visibility when clicking the note icon
    moveInChecklistModalEl.addEventListener('click', (e) => {
        const btn = e.target.closest('.movein-note-toggle');
        if (!btn) return;
        const itemId = btn.getAttribute('data-item-id');
        if (!itemId) return;
        const input = moveInChecklistModalEl.querySelector(`.movein-check-note[data-item-id="${itemId}"]`);
        if (!input) return;
        const currentlyHidden = !input.style.display || input.style.display === 'none';
        input.style.display = currentlyHidden ? 'block' : 'none';
        if (!currentlyHidden) return;
        try {
            input.focus();
        } catch (_) {}
    });

    moveInChecklistModalEl.addEventListener('change', async (e) => {
        const target = e.target;
        if (!(target instanceof HTMLInputElement) || !moveInChecklistModalEl.dataset.appId) return;

        const appId = moveInChecklistModalEl.dataset.appId;

        // Recompute completed ids and notes from current UI state
        const completedIds = Array.from(moveInChecklistModalEl.querySelectorAll('.movein-check-item'))
            .filter(cb => cb.checked && cb.getAttribute('data-item-id'))
            .map(cb => cb.getAttribute('data-item-id'));

        const notes = {};
        Array.from(moveInChecklistModalEl.querySelectorAll('.movein-check-note')).forEach(input => {
            const key = input.getAttribute('data-item-id');
            const val = input.value.trim();
            if (key && val) {
                notes[key] = val;
            }
        });

        try {
            const res = await fetch(`${API_URL}/rental-applications/${appId}/move-in-checklist`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ completedIds, notes })
            });
            if (!res.ok) throw new Error('Failed to save checklist');
            const data = await res.json();
            const list = Array.isArray(data.completedIds) ? data.completedIds : completedIds;
            const returnedNotes = data.notes && typeof data.notes === 'object' ? data.notes : notes;
            // Update local applications state
            if (Array.isArray(state.applications)) {
                const idx = state.applications.findIndex(a => String(a._id) === String(appId));
                if (idx !== -1) {
                    state.applications[idx].moveInChecklistCompleted = list;
                    state.applications[idx].moveInChecklistNotes = returnedNotes;
                }
            }
        } catch (err) {
            console.error('Error saving move-in checklist:', err);
            showNotification('Error saving move-in checklist', 'error');
        }
    });
}

// 1. Mark as Completed Handler
async function markScheduleCompleted(scheduleId) {
  // Find the schedule to get vendor info
  const schedules = window.lastLoadedSchedules || [];
  const schedule = schedules.find(s => s._id === scheduleId);
  let vendorName = '';
  if (schedule && schedule.assignedVendor) {
    vendorName = schedule.assignedVendor.name || schedule.assignedVendor.email || '';
  }

  // Show modal
  const modal = document.getElementById('completeScheduleModal');
  const form = document.getElementById('completeScheduleForm');
  const completedByInput = document.getElementById('completedByInput');
  const notesInput = document.getElementById('completedNotesInput');
  completedByInput.value = vendorName || '';
  notesInput.value = '';
  modal.style.display = 'block';

  // Cancel handler
  document.getElementById('cancelCompleteScheduleBtn').onclick = () => {
    modal.style.display = 'none';
  };

  // Submit handler
  form.onsubmit = async function(e) {
    e.preventDefault();
    showLoader();
    try {
      const completedBy = completedByInput.value.trim() || 'System';
      const notes = notesInput.value.trim();
      const res = await fetch(`/api/properties/${state.currentProperty._id}/maintenance-schedules/${scheduleId}/complete`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ completedBy, notes })
      });
      if (!res.ok) throw new Error('Failed to complete schedule');
      showNotification('Schedule marked as completed and reset!', 'success');
      modal.style.display = 'none';
    // Force-refresh maintenance tab to reflect changes
    await refreshContent('maintenance');
    } catch (err) {
      showNotification('Error completing schedule', 'error');
    } finally {
      hideLoader();
    }
  };
}

// Make globally accessible
window.markScheduleCompleted = markScheduleCompleted;

// 2. Render History Helper
function renderScheduleHistory(history) {
  if (!history || !history.length) return '<div style="color:#888;font-size:0.96em;">No completion history yet.</div>';
  return `
    <div style="margin-top:8px;">
      <strong style="color:#217dbb;">Completion History:</strong>
      <ul style="margin:6px 0 0 0;padding-left:18px;">
        ${history.slice().reverse().map(h => `
          <li style="margin-bottom:4px;">
            <span style="color:#27ae60;"><i class="fas fa-check-circle"></i> ${new Date(h.completedAt).toLocaleDateString()}</span>
            ${h.completedBy ? ` by <strong>${h.completedBy}</strong>` : ''}
            ${h.notes ? `<br><span style="color:#888;">Notes: ${h.notes}</span>` : ''}
          </li>
        `).join('')}
      </ul>
    </div>
  `;
}

// CARD VIEW
function renderMaintenanceSchedules(schedules) {
  const scheduleList = document.getElementById('scheduleList');
  if (!scheduleList) return;

  if (!schedules.length) {
    scheduleList.innerHTML = `
      <div class="empty-state" style="text-align:center;padding:32px;">
        <i class="fas fa-calendar-alt" style="font-size:2.2em;color:#3498db;margin-bottom:12px;"></i>
        <p style="font-size:1em;color:#888;">No routine maintenance schedules found.</p>
      </div>
    `;
    return;
  }

  scheduleList.innerHTML = schedules.map(schedule => {
    const nextDate = schedule.nextScheduledDate
    ? formatDateDisplay(schedule.nextScheduledDate, 'en-US')
      : 'N/A';

    const startDateLabel = schedule.startDate
    ? formatDateDisplay(schedule.startDate, 'en-US')
      : 'N/A';

    let freqLabel = schedule.frequency.charAt(0).toUpperCase() + schedule.frequency.slice(1);
    if (schedule.frequency === 'custom' && schedule.intervalDays) {
      freqLabel = `<span class="badge badge-info" style="background:#eaf6ff;color:#217dbb;padding:2px 10px;border-radius:10px;font-size:0.92em;"><i class="fas fa-sync-alt"></i> Every ${schedule.intervalDays} days</span>`;
    } else {
      freqLabel = `<span class="badge badge-default" style="background:#f6fafd;color:#217dbb;padding:2px 10px;border-radius:10px;font-size:0.92em;"><i class="fas fa-clock"></i> ${freqLabel}</span>`;
    }

    const vendorName = schedule.assignedVendor?.name
      ? `<span style="color:#217dbb;font-weight:600;font-size:0.97em;"><i class="fas fa-user-tie"></i> ${schedule.assignedVendor.name}</span>`
      : '<span style="color:#888;font-size:0.97em;"><i class="fas fa-user-slash"></i> None</span>';

    let unitLabel = '<span style="color:#888;font-size:0.97em;"><i class="fas fa-door-closed"></i> No unit assigned</span>';
    if (schedule.unitId) {
      if (typeof schedule.unitId === 'object' && schedule.unitId.number) {
        unitLabel = `<i class="fas fa-door-open"></i> Unit ${schedule.unitId.number}`;
      } else if (typeof schedule.unitId === 'string') {
        const unitObj = state.units?.find(u => u._id === schedule.unitId);
        if (unitObj && unitObj.number) {
          unitLabel = `<i class="fas fa-door-open"></i> Unit ${unitObj.number}`;
        } else {
          unitLabel = `<i class="fas fa-door-open"></i> ${schedule.unitId}`;
        }
      }
    }

    const statusIcon = schedule.status === 'completed'
      ? '<i class="fas fa-check-circle"></i>'
      : schedule.status === 'in-progress'
        ? '<i class="fas fa-spinner"></i>'
        : '<i class="fas fa-clock"></i>';
    const statusLabel = schedule.status
      ? `<span class="status-badge ${schedule.status}" style="padding:4px 12px;border-radius:15px;font-size:0.82em;font-weight:600;">${statusIcon} ${schedule.status.charAt(0).toUpperCase() + schedule.status.slice(1)}</span>`
      : '<span class="status-badge pending" style="padding:4px 12px;border-radius:15px;font-size:0.82em;font-weight:600;"><i class="fas fa-clock"></i> Pending</span>';
    const costLabel = typeof schedule.cost === 'number'
      ? `<span style="color:#217dbb;font-weight:600;font-size:0.97em;"><i class="fas fa-dollar-sign"></i> $${schedule.cost.toFixed(2)}</span>`
      : '<span style="color:#888;font-size:0.97em;"><i class="fas fa-dollar-sign"></i> $0.00</span>';

    const canComplete = schedule.status !== 'pending';
    const completeBtn = canComplete
      ? `<button onclick="markScheduleCompleted('${schedule._id}')" class="btn-primary" style="margin-top:8px;"><i class="fas fa-check"></i> Mark as Completed</button>`
      : '';

    const historyHtml = renderScheduleHistory(schedule.history);

    const descriptionHtml = `
      <div style="
        margin-bottom:12px;
        background: linear-gradient(90deg, #eaf6ff 0%, #f7f7ff 100%);
        border-left: 4px solid #3498db;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.97em;
        color: #217dbb;
        font-weight: 500;
        box-shadow: 0 1px 4px rgba(44,62,80,0.05);
      ">
        <i class="fas fa-align-left" style="margin-right:7px;color:#217dbb;"></i>
        ${schedule.description || '<span style="color:#888;">No description provided.</span>'}
      </div>
    `;

    return `
      <div class="maintenance-card" style="border:1.5px solid #e1e8ed;box-shadow:0 2px 8px rgba(44,62,80,0.07);margin-bottom:18px;font-size:0.97em;">
        <div class="maintenance-header" style="background:#f6fafd;padding:12px 18px;border-bottom:1px solid #e1e8ed;display:flex;justify-content:space-between;align-items:center;">
          <div>
            <strong style="font-size:1.08em;color:#2c3e50;"><i class="fas fa-sync-alt" style="color:#217dbb;margin-right:8px;"></i>${schedule.title}</strong>
            <span style="margin-left:12px;">${freqLabel}</span>
          </div>
          <div class="maintenance-actions">
            <button onclick="editMaintenanceSchedule('${schedule._id}')" class="btn-secondary" style="margin-right:6px;font-size:0.97em;">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button onclick="deleteMaintenanceSchedule('${schedule._id}')" class="btn-icon delete-btn" title="Delete" style="font-size:0.97em;">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        <div class="maintenance-content" style="padding:14px 18px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
              ${descriptionHtml}
              <div style="margin-bottom:8px;"><strong><i class="fas fa-calendar-day"></i> Start Date:</strong> <span style="color:#217dbb;">${startDateLabel}</span></div>
              <div style="margin-bottom:8px;"><strong><i class="fas fa-calendar-alt"></i> Next Date:</strong> <span style="color:#217dbb;">${nextDate}</span></div>
              <div style="margin-bottom:8px;"><strong><i class="fas fa-info-circle"></i> Status:</strong> ${statusLabel}</div>
              ${completeBtn}
            </div>
            <div>
              <div style="margin-bottom:8px;"><strong><i class="fas fa-user-tie"></i> Vendor:</strong> ${vendorName}</div>
              <div style="margin-bottom:8px;"> ${unitLabel}</div>
              <div><strong><i class="fas fa-dollar-sign"></i> Cost:</strong> ${costLabel}</div>
            </div>
          </div>
          <div style="margin-top:10px;">
            <button class="btn-secondary" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'block' ? 'none' : 'block';this.textContent = this.textContent.includes('Show') ? 'Hide History' : 'Show History';">
              <i class="fas fa-history"></i> Show History
            </button>
            <div style="display:none;">${historyHtml}</div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// LIST VIEW
function renderMaintenanceSchedulesList(schedules) {
  const scheduleList = document.getElementById('scheduleList');
  if (!scheduleList) return;

  if (!schedules.length) {
    scheduleList.innerHTML = `
      <div class="empty-state" style="text-align:center;padding:32px;">
        <i class="fas fa-calendar-alt" style="font-size:2.2em;color:#3498db;margin-bottom:12px;"></i>
        <p style="font-size:1.1em;color:#888;">No routine maintenance schedules found.</p>
      </div>
    `;
    return;
  }

  scheduleList.innerHTML = `
    <div style="overflow-x:auto;">
      <table class="maintenance-table" style="width:100%;border-collapse:collapse;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(44,62,80,0.07);margin-bottom:18px;">
        <thead>
          <tr style="background:#f6fafd;">
            <th>Title</th>
            <th>Description</th>
            <th>Frequency</th>
            <th>Start Date</th>
            <th>Next Scheduled</th>
            <th>Vendor</th>
            <th>Unit</th>
            <th>Status</th>
            <th>Cost</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${schedules.map((schedule, idx) => {
            const nextDate = schedule.nextScheduledDate
              ? formatDateDisplay(schedule.nextScheduledDate, 'en-US')
              : 'N/A';
            let freqLabel = schedule.frequency.charAt(0).toUpperCase() + schedule.frequency.slice(1);
            if (schedule.frequency === 'custom' && schedule.intervalDays) {
              freqLabel = `<span style="background:#eaf6ff;color:#217dbb;padding:2px 10px;border-radius:10px;">Every ${schedule.intervalDays} days</span>`;
            }
            const vendorName = schedule.assignedVendor?.name
              ? `<span style="color:#217dbb;font-weight:600;">${schedule.assignedVendor.name}</span>`
              : '<span style="color:#888;">None</span>';
            let unitLabel = '<span style="color:#888;">None</span>';
            if (schedule.unitId) {
              if (typeof schedule.unitId === 'object' && schedule.unitId.number) {
                unitLabel = `Unit ${schedule.unitId.number}`;
              } else if (typeof schedule.unitId === 'string') {
                const unitObj = state.units?.find(u => u._id === schedule.unitId);
                if (unitObj && unitObj.number) {
                  unitLabel = `Unit ${unitObj.number}`;
                } else {
                  unitLabel = schedule.unitId;
                }
              }
            }
            const statusLabel = schedule.status
              ? `<span class="status-badge ${schedule.status}">${schedule.status.charAt(0).toUpperCase() + schedule.status.slice(1)}</span>`
              : '<span class="status-badge pending">Pending</span>';
            const costLabel = typeof schedule.cost === 'number'
              ? `$${schedule.cost.toFixed(2)}`
              : '$0.00';

            const canComplete = schedule.status !== 'pending';
            const completeBtn = canComplete
              ? `<button onclick="markScheduleCompleted('${schedule._id}')" class="btn-primary" style="margin-bottom:4px;"><i class="fas fa-check"></i></button>`
              : '';

            // Each row gets a unique id for toggling
            const rowId = `schedule-row-${idx}`;
            const historyRowId = `schedule-history-row-${idx}`;
            const historyHtml = renderScheduleHistory(schedule.history);

            return `
              <tr id="${rowId}" class="schedule-row" style="border-bottom:1px solid #e1e8ed;cursor:pointer;">
                <td style="padding:10px 8px;font-weight:600;color:#2c3e50;">${schedule.title}</td>
                <td style="padding:10px 8px;color:#555;">${schedule.description || ''}</td>
                <td style="padding:10px 8px;">${freqLabel}</td>
                <td style="padding:10px 8px;">${formatDateDisplay(schedule.startDate, 'en-US')}</td>
                <td style="padding:10px 8px;color:#217dbb;font-weight:600;">${nextDate}</td>
                <td style="padding:10px 8px;">${vendorName}</td>
                <td style="padding:10px 8px;">${unitLabel}</td>
                <td style="padding:10px 8px;">${statusLabel}</td>
                <td style="padding:10px 8px;">${costLabel}</td>
                <td style="padding:10px 8px;">
                  <button onclick="event.stopPropagation();editMaintenanceSchedule('${schedule._id}')" class="btn-secondary" title="Edit" style="margin-right:6px;">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="event.stopPropagation();deleteMaintenanceSchedule('${schedule._id}')" class="btn-icon delete-btn" title="Delete" style="margin-left:2px;">
                    <i class="fas fa-trash"></i>
                  </button>
                  ${completeBtn}
                </td>
              </tr>
              <tr id="${historyRowId}" class="schedule-history-row" style="display:none;background:#f8fafd;">
                <td colspan="10" style="padding:12px 24px 12px 32px;border-bottom:1px solid #e1e8ed;">
                  ${historyHtml}
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;

  // Attach event listeners after rendering
  setTimeout(() => {
    document.querySelectorAll('.schedule-row').forEach((row, idx) => {
      row.addEventListener('click', function () {
        const historyRow = document.getElementById('schedule-history-row-' + idx);
        if (historyRow.style.display === 'none' || !historyRow.style.display) {
          historyRow.style.display = 'table-row';
        } else {
          historyRow.style.display = 'none';
        }
      });
    });
  }, 0);
}




document.getElementById('addScheduleBtn').addEventListener('click', async () => {
  const form = document.getElementById('addScheduleForm');
  form.reset();
  form.dataset.editMode = 'false';
  form.dataset.scheduleId = '';
  form.querySelector('button[type="submit"]').textContent = 'Create Schedule';
  document.getElementById('customIntervalGroup').style.display = 'none';
  await populateScheduleVendorSelect();
  await populateScheduleUnitSelect(); // <-- Add this line
  openModal('addScheduleModal');
});

document.getElementById('scheduleFrequency').addEventListener('change', function() {
  document.getElementById('customIntervalGroup').style.display = this.value === 'custom' ? 'block' : 'none';
});



document.getElementById('addScheduleBtn').addEventListener('click', async () => {
  const form = document.getElementById('addScheduleForm');
  form.reset();
  form.dataset.editMode = 'false';
  form.dataset.scheduleId = '';
  form.querySelector('button[type="submit"]').textContent = 'Create Schedule';
  document.getElementById('customIntervalGroup').style.display = 'none';
  await populateScheduleVendorSelect();
  await populateScheduleUnitSelect();

  // Reset form submit handler to default create logic
  form.onsubmit = async function(e) {
    e.preventDefault();
    const title = document.getElementById('scheduleTitle').value;
    const description = document.getElementById('scheduleDescription').value;
    const frequency = document.getElementById('scheduleFrequency').value;
    const intervalDays = frequency === 'custom' ? Number(document.getElementById('scheduleIntervalDays').value) : null;
    const startDateRaw = document.getElementById('scheduleStartDate').value;
    const startDate = dateInputToISOAtNoon(startDateRaw);
    const assignedVendor = document.getElementById('scheduleVendor').value;
    const unitId = document.getElementById('scheduleUnit').value || null;
    const status = document.getElementById('scheduleStatus').value;
    const cost = Number(document.getElementById('scheduleCost').value) || 0;
    const vendorValue = assignedVendor && assignedVendor !== "" ? assignedVendor : null;

    showLoader();
    try {
    const payload = { title, description, frequency, intervalDays, startDate, assignedVendor: vendorValue, unitId, status, cost };
      const res = await fetch(`/api/properties/${state.currentProperty._id}/maintenance-schedules`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('Failed to create schedule');
      closeModal('addScheduleModal');
      showNotification('Schedule created!', 'success');
      await loadMaintenanceSchedules();
      form.dataset.editMode = 'false';
      form.dataset.scheduleId = '';
      form.querySelector('button[type="submit"]').textContent = 'Create Schedule';
      form.reset();
      document.getElementById('customIntervalGroup').style.display = 'none';
    } catch (err) {
      showNotification('Error creating schedule', 'error');
    } finally {
      hideLoader();
    }
  };

  openModal('addScheduleModal');
});

// Populate units in the schedule modal
async function populateScheduleUnitSelect() {
  const select = document.getElementById('scheduleUnit');
  if (!select || !state.units) return;
  select.innerHTML = `<option value="">None</option>` +
    state.units.map(unit => `<option value="${unit._id}">Unit ${unit.number}</option>`).join('');
}


async function populateScheduleVendorSelect() {
  const select = document.getElementById('scheduleVendor');
  if (!select) return;
  select.innerHTML = `<option value="">None</option>`;
  try {
    const res = await fetch('/api/vendors');
    if (!res.ok) throw new Error('Failed to fetch vendors');
    const vendors = await res.json();
    vendors.forEach(vendor => {
      select.innerHTML += `<option value="${vendor._id}">${vendor.name || vendor.email}</option>`;
    });
  } catch (err) {
    select.innerHTML = `<option value="">None</option>`;
  }
}


                function populateMaintenanceUnitSelect() {
    const select = document.getElementById('maintenanceUnit');
    if (!select || !state.units) return;
    select.innerHTML = `<option value="">Select a unit</option>` +
        state.units.map(unit => `<option value="${unit._id}">Unit ${unit.number}</option>`).join('');
}

                function populateMaintenancePropertySelect(selectedId) {
    const select = document.getElementById('maintenanceProperty');
    if (!select) return;
    const properties = state.properties || [];
    if (!properties.length) {
        select.innerHTML = '<option value="">No properties available</option>';
        return;
    }
    const preferredId = selectedId || (state.currentProperty && state.currentProperty._id);
    let options = '<option value="">Select a property</option>';
    properties.forEach(p => {
        if (!p || !p._id) return;
        const pid = p._id;
        const name = p.name || p.projectName || p.address || 'Property';
        const selectedAttr = preferredId && String(preferredId) === String(pid) ? ' selected' : '';
        options += `<option value="${pid}"${selectedAttr}>${name}</option>`;
    });
    select.innerHTML = options;
}

                async function handleMaintenancePropertyChange() {
    const select = document.getElementById('maintenanceProperty');
    if (!select) return;
    const propertyId = select.value;
    const unitSelect = document.getElementById('maintenanceUnit');
    if (!unitSelect) return;
    if (!propertyId) {
        unitSelect.innerHTML = '<option value="">Select a unit</option>';
        return;
    }
    try {
        showLoader();
        await loadUnits(propertyId, true);
        populateMaintenanceUnitSelect();
    } catch (err) {
        console.error('Error loading units for maintenance property:', err);
        showNotification('Error loading units for selected property', 'error');
    } finally {
        hideLoader();
    }
}



// Edit Maintenance Schedule
async function editMaintenanceSchedule(scheduleId) {
  try {
    // Fetch schedule details
    const res = await fetch(`/api/properties/${state.currentProperty._id}/maintenance-schedules`);
    const schedules = await res.json();
    const schedule = schedules.find(s => s._id === scheduleId);
    if (!schedule) {
      showNotification('Schedule not found', 'error');
      return;
    }

    await populateScheduleVendorSelect();
    await populateScheduleUnitSelect();

    // Populate modal fields
    document.getElementById('scheduleTitle').value = schedule.title || '';
    document.getElementById('scheduleDescription').value = schedule.description || '';
    document.getElementById('scheduleFrequency').value = schedule.frequency || 'monthly';
    document.getElementById('customIntervalGroup').style.display = schedule.frequency === 'custom' ? 'block' : 'none';
    document.getElementById('scheduleIntervalDays').value = schedule.intervalDays || '';
    document.getElementById('scheduleStartDate').value = schedule.startDate ? (String(schedule.startDate).substring(0,10)) : '';
    document.getElementById('scheduleVendor').value = schedule.assignedVendor?._id || '';
    document.getElementById('scheduleUnit').value = schedule.unitId?._id || schedule.unitId || '';
    document.getElementById('scheduleStatus').value = schedule.status || 'pending';
    document.getElementById('scheduleCost').value = typeof schedule.cost === 'number' ? schedule.cost : '';

    // Set edit mode
    const form = document.getElementById('addScheduleForm');
    form.dataset.editMode = 'true';
    form.dataset.scheduleId = scheduleId;
    form.querySelector('button[type="submit"]').textContent = 'Update Schedule';

    openModal('addScheduleModal');

    // Remove previous submit handler and add new one for update
    form.onsubmit = async function(e) {
      e.preventDefault();
      await handleUpdateMaintenanceSchedule(scheduleId);
    };
  } catch (err) {
    showNotification('Error loading schedule for edit', 'error');
  }
}

// Handle Update Maintenance Schedule (send all fields)
async function handleUpdateMaintenanceSchedule(scheduleId) {
  const title = document.getElementById('scheduleTitle').value;
  const description = document.getElementById('scheduleDescription').value;
  const frequency = document.getElementById('scheduleFrequency').value;
    const intervalDays = frequency === 'custom' ? Number(document.getElementById('scheduleIntervalDays').value) : null;
    const startDateRaw = document.getElementById('scheduleStartDate').value;
    const startDate = dateInputToISOAtNoon(startDateRaw);
  const assignedVendor = document.getElementById('scheduleVendor').value || null;
  const unitId = document.getElementById('scheduleUnit').value || null;
  const status = document.getElementById('scheduleStatus').value;
  const cost = Number(document.getElementById('scheduleCost').value) || 0;

  showLoader();
  try {
    const res = await fetch(`/api/properties/${state.currentProperty._id}/maintenance-schedules/${scheduleId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        title,
        description,
        frequency,
        intervalDays,
    startDate,
        assignedVendor,
        unitId,
        status,
        cost
      })
    });
    if (!res.ok) throw new Error('Failed to update schedule');
    closeModal('addScheduleModal');
    showNotification('Schedule updated!', 'success');
    await refreshContent('maintenance');
  } catch (err) {
    showNotification('Error updating schedule', 'error');
  } finally {
    hideLoader();
  }
}


// Delete Maintenance Schedule
async function deleteMaintenanceSchedule(scheduleId) {
  if (!confirm('Are you sure you want to delete this schedule?')) return;
  showLoader();
  try {
    const res = await fetch(`/api/properties/${state.currentProperty._id}/maintenance-schedules/${scheduleId}`, {
      method: 'DELETE'
    });
    if (!res.ok) throw new Error('Failed to delete schedule');
    showNotification('Schedule deleted!', 'success');
    await refreshContent('maintenance');
  } catch (err) {
    showNotification('Error deleting schedule', 'error');
  } finally {
    hideLoader();
  }
}



// --- Export functions for global access ---
window.editMaintenanceSchedule = editMaintenanceSchedule;
window.deleteMaintenanceSchedule = deleteMaintenanceSchedule;


// Tab switching logic for maintenance section
let currentMaintenanceTab = 'requests';

document.getElementById('recurringMaintenanceTab').addEventListener('click', function() {
  currentMaintenanceTab = 'schedules';
  this.classList.add('active');
  document.getElementById('maintenanceRequestsTab').classList.remove('active');
  document.getElementById('maintenanceList').style.display = 'none';
  document.getElementById('scheduleList').style.display = '';
  document.getElementById('recurringCalendarContainer').style.display = 'none'; // <-- Always hide calendar on tab switch
});

document.getElementById('maintenanceRequestsTab').addEventListener('click', function() {
  currentMaintenanceTab = 'requests';
  this.classList.add('active');
  document.getElementById('recurringMaintenanceTab').classList.remove('active');
  document.getElementById('maintenanceList').style.display = '';
  document.getElementById('scheduleList').style.display = 'none';
  document.getElementById('recurringCalendarContainer').style.display = 'none'; // Only hide when switching to requests
});

// Optionally, show requests tab by default on load
document.getElementById('maintenanceRequestsTab').click();





// New Maintenance Dropdown Menu

const newDropdownBtn = document.getElementById('newMaintenanceDropdownBtn');
const newDropdownMenu = document.getElementById('newMaintenanceDropdownMenu');

newDropdownBtn.addEventListener('click', function(e) {
  e.stopPropagation();
  newDropdownMenu.style.display = newDropdownMenu.style.display === 'block' ? 'none' : 'block';
});

// Hide dropdown when clicking outside
document.addEventListener('click', function(e) {
  if (!newDropdownBtn.contains(e.target)) {
    newDropdownMenu.style.display = 'none';
  }
});

// Document Management
async function handleDocumentUpload(event) {
    event.preventDefault();
    
    if (!state.currentProperty) {
        showNotification('Please select a property first', 'error');
        return;
    }

    const formData = new FormData();
    const fileInput = document.getElementById('documentFile');
    const nameInput = document.getElementById('documentName');
    const typeInput = document.getElementById('documentType');
    
    if (!fileInput.files[0]) {
        showNotification('Please select a file to upload', 'error');
        return;
    }
    showLoader();
    try {
        // Add file and metadata to FormData
        formData.append('file', fileInput.files[0]);
        formData.append('name', nameInput.value);
        formData.append('type', typeInput.value); // <-- Save the selected document type
        formData.append('propertyId', state.currentProperty._id);

        const response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/documents`, {
            method: 'POST',
            body: formData // Don't set Content-Type header, let browser set it with boundary
        });

    if (!response.ok) throw new Error('Failed to upload document');
        
    invalidateCache('documents');
    await refreshContent('documents');
        closeModal('uploadDocumentModal');
        showNotification('Document uploaded successfully', 'success');
        event.target.reset();
    } catch (error) {
        console.error('Error uploading document:', error);
        showNotification('Error uploading document', 'error');
            } finally {
        hideLoader();
    }
}



function showRecurringDetailsModal(selectedDate, schedules) {
  // selectedDate is a JS Date object
  const events = schedules.filter(sch => {
    if (!sch.nextScheduledDate) return false;
    const schDate = new Date(sch.nextScheduledDate);
    // Compare year, month, day in local time
    return (
      schDate.getFullYear() === selectedDate.getFullYear() &&
      schDate.getMonth() === selectedDate.getMonth() &&
      schDate.getDate() === selectedDate.getDate()
    );
  });

  // Build modal HTML with all schedule fields
  let html = `
    <div class="modal-content" style="max-width:600px;">
      <h2>Recurring Maintenance for ${selectedDate.toLocaleDateString()}</h2>
      ${events.length === 0 ? '<p>No recurring maintenance scheduled for this date.</p>' : ''}
      <ul style="padding-left:0;">
        ${events.map(sch => `
          <li style="margin-bottom:18px;list-style:none;">
            <strong>${sch.title}</strong><br>
            <span style="color:#888;">${sch.description || ''}</span><br>
            <span>Frequency: ${sch.frequency}${sch.frequency === 'custom' && sch.intervalDays ? `, every ${sch.intervalDays} days` : ''}</span><br>
            <span>Vendor: ${sch.assignedVendor?.name || 'None'}</span><br>
            <span>Unit: ${sch.unitId?.number ? `Unit ${sch.unitId.number}` : (sch.unitId ? sch.unitId : 'None')}</span><br>
            <span>Status: <span class="status-badge ${sch.status}">${sch.status ? sch.status.charAt(0).toUpperCase() + sch.status.slice(1) : 'Pending'}</span></span><br>
            <span>Cost: ${typeof sch.cost === 'number' ? `$${sch.cost.toFixed(2)}` : '$0.00'}</span><br>
            ${sch.completedAt ? `<span style="color:#27ae60;">Completed: ${new Date(sch.completedAt).toLocaleDateString()}</span><br>` : ''}
            <div style="margin-top:8px;">
              <button onclick="editMaintenanceSchedule('${sch._id}')" class="btn-secondary" style="margin-right:6px;">
                <i class="fas fa-edit"></i> Edit
              </button>
              <button onclick="deleteMaintenanceSchedule('${sch._id}')" class="btn-icon delete-btn" style="margin-left:2px;">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          </li>
        `).join('')}
      </ul>
      <div style="text-align:right;margin-top:18px;">
        <button class="btn-secondary" onclick="closeModal('recurringDetailsModal')">Close</button>
      </div>
    </div>
  `;

  let modal = document.getElementById('recurringDetailsModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'recurringDetailsModal';
    modal.className = 'modal';
    document.body.appendChild(modal);
  }
  modal.innerHTML = html;
  openModal('recurringDetailsModal');
}

// Update your calendar rendering function:
function renderRecurringMaintenanceFullCalendar(schedules) {
  const calendarEl = document.getElementById('recurringCalendarFull');
  if (!calendarEl) return;

  if (calendarEl._fullCalendar) {
    calendarEl._fullCalendar.destroy();
    calendarEl.innerHTML = '';
  }

  const events = schedules.map(sch => ({
    title: sch.title + (sch.assignedVendor?.name ? ` (${sch.assignedVendor.name})` : ''),
    start: sch.nextScheduledDate ? new Date(sch.nextScheduledDate) : null,
    allDay: true,
    extendedProps: {
      description: sch.description,
      frequency: sch.frequency,
      vendor: sch.assignedVendor?.name || '',
      scheduleId: sch._id
    }
  })).filter(e => e.start);

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    height: 500,
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: ''
    },
    events,
    eventDidMount: function(info) {
      info.el.title = `${info.event.title}\n${info.event.extendedProps.description || ''}\nFrequency: ${info.event.extendedProps.frequency}`;
    },
    dateClick: function(info) {
      // Use info.date (JS Date object) and pass to modal
      showRecurringDetailsModal(info.date, schedules);
    }
  });
  calendar.render();
  calendarEl._fullCalendar = calendar;
}

async function loadMaintenanceSchedules() {
  if (!state.currentProperty) return;
  showLoader();
  try {
    const res = await fetch(`/api/properties/${state.currentProperty._id}/maintenance-schedules`);
    if (!res.ok) throw new Error('Failed to fetch maintenance schedules');
    const schedules = await res.json();
    window.lastLoadedSchedules = schedules; // Save for calendar
    if (scheduleListView) {
      renderMaintenanceSchedulesList(schedules);
    } else {
      renderMaintenanceSchedules(schedules);
    }
    // If recurring tab is active, render calendar
window.lastLoadedSchedules = schedules; // Save for calendar
if (currentMaintenanceTab === 'schedules') {
  renderRecurringMaintenanceFullCalendar(schedules);
}
  } catch (err) {
    console.error('Error loading maintenance schedules:', err);
    showNotification('Error loading maintenance schedules', 'error');
  } finally {
    hideLoader();
  }
}





// Ensure the calendar is hidden by default on page load
document.addEventListener('DOMContentLoaded', () => {
  const calContainer = document.getElementById('recurringCalendarContainer');
  if (calContainer) calContainer.style.display = 'none';
});

// Toggle calendar icon logic
document.getElementById('toggleCalendarIcon').addEventListener('click', () => {
  const calContainer = document.getElementById('recurringCalendarContainer');
  if (calContainer.style.display === 'none' || calContainer.style.display === '') {
    calContainer.style.display = 'block';
    // Render calendar if not already rendered
    const schedules = window.lastLoadedSchedules || [];
    renderRecurringMaintenanceFullCalendar(schedules);
  } else {
    calContainer.style.display = 'none';
  }
});



async function loadDocuments(propertyId, force = false) {
    
    try {
        if (!force && shouldUseCache('documents', propertyId)) {
            renderDocuments();
            updateTabCounts();
            return;
        }
        const response = await fetch(`${API_URL}/properties/${propertyId}/documents`);
        if (!response.ok) throw new Error('Failed to fetch documents');
        
        const documents = await response.json();
        state.documents = documents;
        console.log('Loaded documents:', state.documents);
        renderDocuments();
        updateTabCounts(); 
        touchCache('documents', propertyId);
    } catch (error) {
        console.error('Error loading documents:', error);
        showNotification('Error loading documents', 'error');

    }
}

function renderDocuments() {
    const documentsGrid = document.getElementById('documentsGrid');
    
    if (!state.documents?.length) {
        documentsGrid.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-file"></i>
                <p>No documents found</p>
                <button onclick="openModal('uploadDocumentModal')" class="btn-primary">
                    Upload Your First Document
                </button>
            </div>`;
        return;
    }

    documentsGrid.innerHTML = state.documents.map(doc => `
        <div class="document-card">
            <div class="document-icon">
                <i class="fas fa-file-${getFileIcon(doc.name)}"></i>
            </div>
            <div class="document-info">
                <h3>${doc.name}</h3>
                <p>Type: ${doc.type}</p>
                <p>Added: ${new Date(doc.createdAt).toLocaleDateString()}</p>
            </div>
            <div class="document-actions">
                <button onclick="viewDocument('${doc._id}')" title="View">
                    <i class="fas fa-eye"></i> View
                </button>
                <button onclick="downloadDocument('${doc._id}')" title="Download">
                    <i class="fas fa-download"></i> Download
                </button>
                <button onclick="deleteDocument('${doc._id}')" class="delete-btn" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
}

// Applications: fetch and render
async function loadApplications(force = false) {
    try {
        if (!force && Array.isArray(state.applications) && state.applications.length) {
            renderApplications();
            updateTabCounts();
            return;
        }
        const res = await fetch('/api/rental-applications?limit=200');
        if (!res.ok) throw new Error('Failed to fetch applications');
        const all = await res.json();
        // Keep all applications (Pending, Approved, Rejected) in state for the Applications tab
        state.applications = Array.isArray(all) ? all : [];
        renderApplications();
        updateTabCounts();
    } catch (err) {
        console.error('Error loading applications:', err);
        showNotification('Error loading applications', 'error');
    }
}

// Invites: fetch and render
async function loadInvites(force = false) {
    try {
        if (!force && Array.isArray(state.invites) && state.invites.length) {
            renderInvites();
            return;
        }
        const res = await fetch('/api/application-invites?limit=200');
        if (!res.ok) throw new Error('Failed to fetch invites');
        state.invites = await res.json();
        renderInvites();
    } catch (err) {
        console.error('Error loading invites:', err);
        showNotification('Error loading invites', 'error');
    }
}

function renderInvites(items) {
    const list = document.getElementById('invitesList');
    if (!list) return;
    const invites = items || state.invites || [];
    if (!invites.length) {
        list.innerHTML = `
            <div class="empty-state" style="text-align:center;padding:24px;">
                <i class="fas fa-paper-plane" style="font-size:2em;color:#3498db;margin-bottom:8px;"></i>
                <p>No invites sent</p>
            </div>`;
        return;
    }
    const currentSelectedInviteId = state.selectedInviteId || null;
    const rows = invites.map(inv => {
        const sentAt = inv.sentAt ? new Date(inv.sentAt).toLocaleString('en-US') : '';
        const openedAt = inv.openedAt ? new Date(inv.openedAt).toLocaleString('en-US') : '';
        const status = inv.status || 'sent';
        const statusBadge = `<span class="status-badge ${status}" style="padding:4px 10px;border-radius:12px;font-size:.85em;">${status.charAt(0).toUpperCase() + status.slice(1)}</span>`;
        const link = inv.applicationUrl || '';
        const safeLink = link.replace(/"/g, '&quot;');
        const notesCount = Array.isArray(inv.notesHistory) ? inv.notesHistory.length : 0;
        const isSelected = currentSelectedInviteId && String(currentSelectedInviteId) === String(inv._id);
        return `
            <tr style="border-bottom:1px solid #e1e8ed;" data-invite-id="${inv._id}">
                <td style="padding:10px 8px;width:36px;text-align:center;">
                    <input type="radio" name="selectedInvite" class="invite-select" value="${inv._id}" ${isSelected ? 'checked' : ''} style="cursor:pointer;" />
                </td>
                <td style="padding:10px 8px;font-weight:600;color:#2c3e50;">
                    <button class="invite-notes-link" data-invite-id="${inv._id}" style="background:none;border:none;padding:0;margin:0;font:inherit;color:#2563eb;cursor:pointer;">
                        ${inv.name || ''}
                    </button>
                </td>
                <td style="padding:10px 8px;">${inv.email || ''}</td>
                <td style="padding:10px 8px;">${inv.propertyName || ''}</td>
                <td style="padding:10px 8px;">${inv.unitNumber || ''}</td>
                <td style="padding:10px 8px;">${sentAt || ''}</td>
                <td style="padding:10px 8px;">${openedAt || ''}</td>
                <td style="padding:10px 8px;">${typeof inv.openCount === 'number' ? inv.openCount : 0}</td>
                <td style="padding:10px 8px;">
                    <button class="invite-notes-link" data-invite-id="${inv._id}" style="background:none;border:none;padding:0;margin:0;font:inherit;cursor:pointer;">
                        <span style="display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#4f46e5;font-size:0.8rem;">
                            <i class="fas fa-sticky-note"></i>
                            ${notesCount}
                        </span>
                    </button>
                </td>
                <td style="padding:10px 8px;">${statusBadge}</td>
                <td style="padding:10px 8px;">${link ? `
                    <div style="display:flex;gap:6px;align-items:center;">
                        <a href="${safeLink}" target="_blank" rel="noopener" class="icon-copy-btn" title="Open invite link" style="text-decoration:none;">
                            <i class="fas fa-up-right-from-square"></i>
                        </a>
                        <button type="button" class="icon-copy-btn invite-copy-link" data-link="${safeLink}" title="Copy invite URL">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                ` : ''}</td>
            </tr>`;
    }).join('');
    list.innerHTML = `
      <div style="overflow-x:auto;">
        <table class="maintenance-table" style="width:100%;border-collapse:collapse;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(44,62,80,0.07);">
          <thead>
            <tr style="background:#f6fafd;">
                            <th style="padding:12px 8px;font-weight:600;color:#2980b9;width:36px;"></th>
              <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Name</th>
              <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Email</th>
              <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Property</th>
              <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Unit</th>
              <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Sent</th>
              <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Opened</th>
              <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Open Count</th>
              <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Notes</th>
              <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Status</th>
              <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      </div>
    `;

    // Wire invite selection to Actions dropdown
    const invitesWrapper = document.getElementById('invitesActionsWrapper');
    const invitesMenu = document.getElementById('invitesActionsMenu');
    const invitesBtn = document.getElementById('invitesActionsBtn');
    const editInviteBtn = document.getElementById('editInviteBtn');
    const deleteInviteBtn = document.getElementById('deleteInviteBtn');

    // Helper to enter inline edit mode for invites
    function enterInviteEditMode(row, invite) {
        if (!row || !invite) return;
        const inviteIdStr = String(invite._id || '');
        if (!inviteIdStr) return;
        if (state.currentEditingInviteId && state.currentEditingInviteId !== inviteIdStr) return;
        if (row.dataset.editing === 'true') return;
        state.currentEditingInviteId = inviteIdStr;
        row.dataset.editing = 'true';

        const cells = row.querySelectorAll('td');
        const nameCell = cells[1];
        const emailCell = cells[2];
        const propertyCell = cells[3];
        const unitCell = cells[4];
        const statusCell = cells[9];
        const actionsCell = cells[10];

        function makeInput(type, className, value) {
            const input = document.createElement('input');
            input.type = type;
            input.className = className;
            input.value = value || '';
            return input;
        }

        const nameInput = makeInput('text', 'app-inline-input', invite.name || '');
        const emailInput = makeInput('email', 'app-inline-input', invite.email || '');
        const propertyInput = makeInput('text', 'app-inline-input', invite.propertyName || '');
        const unitInput = makeInput('text', 'app-inline-input', invite.unitNumber || '');

        const statusSelect = document.createElement('select');
        statusSelect.className = 'app-inline-input';
        ['sent', 'opened', 'completed', 'expired'].forEach(val => {
            const opt = document.createElement('option');
            opt.value = val;
            opt.textContent = val.charAt(0).toUpperCase() + val.slice(1);
            if ((invite.status || 'sent') === val) opt.selected = true;
            statusSelect.appendChild(opt);
        });

        const urlInput = makeInput('url', 'app-inline-input', invite.applicationUrl || '');

        if (nameCell) { nameCell.innerHTML = ''; nameCell.appendChild(nameInput); }
        if (emailCell) { emailCell.innerHTML = ''; emailCell.appendChild(emailInput); }
        if (propertyCell) { propertyCell.innerHTML = ''; propertyCell.appendChild(propertyInput); }
        if (unitCell) { unitCell.innerHTML = ''; unitCell.appendChild(unitInput); }
        if (statusCell) { statusCell.innerHTML = ''; statusCell.appendChild(statusSelect); }
        if (actionsCell) { actionsCell.innerHTML = ''; actionsCell.appendChild(urlInput); }

        const saveInviteChanges = async () => {
            const payload = {
                name: nameInput.value.trim(),
                email: emailInput.value.trim(),
                propertyName: propertyInput.value.trim(),
                unitNumber: unitInput.value.trim(),
                status: statusSelect.value || 'sent',
                applicationUrl: urlInput.value.trim() || ''
            };

            try {
                const res = await fetch(`/api/application-invites/${invite._id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error('Failed to update invite');
                const updated = await res.json();
                const invData = updated.invite || updated;
                state.invites = (state.invites || []).map(x => String(x._id) === String(invite._id) ? invData : x);
                state.currentEditingInviteId = null;
                renderInvites();
                showNotification('Invite updated', 'success');
            } catch (err) {
                console.error('Inline invite update error:', err);
                state.currentEditingInviteId = null;
                showNotification('Could not update invite', 'error');
                renderInvites();
            }
        };

        const handleDocClick = (ev) => {
            const target = ev.target;
            if (row.contains(target)) return;
            if (!document.body.contains(row)) {
                document.removeEventListener('click', handleDocClick, true);
                return;
            }
            document.removeEventListener('click', handleDocClick, true);
            saveInviteChanges();
        };

        document.addEventListener('click', handleDocClick, true);
    }

    if (invitesWrapper) {
        invitesWrapper.style.display = state.selectedInviteId ? 'flex' : 'none';
    }

    document.querySelectorAll('.invite-select').forEach(input => {
        input.addEventListener('click', (e) => {
            const val = e.target.value || null;
            if (state.selectedInviteId && String(state.selectedInviteId) === String(val)) {
                // Toggle off when clicking the already selected invite
                e.target.checked = false;
                state.selectedInviteId = null;
                if (invitesWrapper) invitesWrapper.style.display = 'none';
                if (invitesMenu) invitesMenu.style.display = 'none';
            } else {
                state.selectedInviteId = val;
                if (invitesWrapper) invitesWrapper.style.display = val ? 'flex' : 'none';
                if (invitesMenu) invitesMenu.style.display = 'none';
            }
        });
    });

    if (invitesBtn && invitesMenu) {
        invitesBtn.onclick = (e) => {
            e.stopPropagation();
            if (!state.selectedInviteId) return;
            invitesMenu.style.display = invitesMenu.style.display === 'block' ? 'none' : 'block';
        };
    }

    // Simple outside-click handler to close the menu
    document.addEventListener('click', (e) => {
        if (invitesMenu && invitesMenu.style.display === 'block' && !invitesMenu.contains(e.target) && e.target !== invitesBtn) {
            invitesMenu.style.display = 'none';
        }
    });

    if (editInviteBtn) {
        editInviteBtn.onclick = () => {
            const id = state.selectedInviteId;
            if (!id) return;
            const invite = (state.invites || []).find(x => String(x._id) === String(id));
            if (!invite) return;
            const row = list.querySelector(`tr[data-invite-id="${id}"]`);
            enterInviteEditMode(row, invite);
            if (invitesMenu) invitesMenu.style.display = 'none';
        };
    }

    if (deleteInviteBtn) {
        deleteInviteBtn.onclick = async () => {
            const id = state.selectedInviteId;
            if (!id) return;
            if (!confirm('Delete this invite? This cannot be undone.')) return;
            try {
                showLoader();
                const res = await fetch(`/api/application-invites/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Failed to delete invite');
                state.invites = (state.invites || []).filter(x => String(x._id) !== String(id));
                state.selectedInviteId = null;
                renderInvites();
                showNotification('Invite deleted', 'success');
            } catch (err) {
                console.error('Delete invite error:', err);
                showNotification('Could not delete invite', 'error');
            } finally {
                hideLoader();
            }
        };
    }

    // Wire invite name/notes click to open notes drawer
    list.querySelectorAll('.invite-notes-link').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const id = btn.getAttribute('data-invite-id');
            if (!id) return;
            openNotesDrawerForInvite(id);
        });
    });

    // Wire copy invite URL buttons
    list.querySelectorAll('.invite-copy-link').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            const url = btn.getAttribute('data-link');
            if (!url) return;
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(url);
                } else {
                    const tempInput = document.createElement('input');
                    tempInput.value = url;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                }
                if (typeof showNotification === 'function') {
                    showNotification('Invite link copied', 'success');
                }
            } catch (err) {
                console.error('Copy invite link failed', err);
                if (typeof showNotification === 'function') {
                    showNotification('Could not copy link', 'error');
                }
            }
        });
    });

    // Wire row click (excluding controls) to open inline edit mode for invites
    list.querySelectorAll('tr[data-invite-id]').forEach(row => {
        row.addEventListener('click', (e) => {
            const target = e.target;
            if (target.closest('input[type="radio"]') ||
                target.closest('.invite-notes-link') ||
                target.closest('a')) {
                return;
            }
            if (row.dataset.editing === 'true') return;
            const inviteId = row.getAttribute('data-invite-id');
            if (!inviteId) return;
            const invite = (state.invites || []).find(x => String(x._id) === String(inviteId));
            if (!invite) return;
            enterInviteEditMode(row, invite);
        });
    });
}

// Hook up invites refresh button
document.getElementById('refreshInvitesBtn')?.addEventListener('click', async () => {
    showLoader();
    try {
        state.invites = [];
        await loadInvites(true);
        showNotification('Invites refreshed', 'success');
    } catch {} finally {
        hideLoader();
    }
});

function renderApplications(items) {
    const list = document.getElementById('applicationsList');
    if (!list) return;
    const apps = items || state.applications || [];
    if (!apps.length) {
        list.innerHTML = `
            <div class="empty-state" style="text-align:center;padding:24px;">
                <i class="fas fa-file-alt" style="font-size:2em;color:#3498db;margin-bottom:8px;"></i>
                <p>No rental applications found</p>
            </div>`;
        return;
    }

    const currentSelectedAppId = state.selectedApplicationId || null;
    const rows = apps.map(a => {
        // Safely parse notes for propertyAddress and unitNumber
        let propertyAddress = '';
        let unitNumber = a.unit || '';
        if (a.notes) {
            try {
                const n = JSON.parse(a.notes);
                propertyAddress = n.propertyAddress || '';
                unitNumber = n.unitNumber || unitNumber;
            } catch {}
        }
        let moveIn = '';
        if (a.moveIn) {
            try {
                const d = new Date(a.moveIn);
                if (!isNaN(d.getTime())) {
                    const y = d.getUTCFullYear();
                    const m = String(d.getUTCMonth() + 1).padStart(2, '0');
                    const day = String(d.getUTCDate()).padStart(2, '0');
                    moveIn = `${m}/${day}/${y}`;
                }
            } catch {}
        }
        const submitted = a.submitted ? new Date(a.submitted).toLocaleString('en-US') : '';
        const status = (a.status || 'pending');
        let notesJson = '';
        if (a.notes) {
            try { notesJson = encodeURIComponent(a.notes); } catch {}
        }
        const notesCount = Array.isArray(a.notesHistory) ? a.notesHistory.length : 0;
                const statusSelect = `
                    <select class="app-status-select"
                                    data-app-id="${a._id}"
                                    data-name="${(a.name||'').replace(/\"/g,'&quot;')}"
                                    data-email="${(a.email||'').replace(/\"/g,'&quot;')}"
                                    data-phone="${(a.phone||'').replace(/\"/g,'&quot;')}"
                                    data-unit="${(unitNumber||'').toString().replace(/\"/g,'&quot;')}"
                                    data-movein="${a.moveIn ? new Date(a.moveIn).toISOString() : ''}"
                                    data-notes="${notesJson}"
                                    style="padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;background:#fff;">
                        <option value="pending" ${status==='pending'?'selected':''}>Pending</option>
                        <option value="approved" ${status==='approved'?'selected':''}>Approved</option>
                        <option value="rejected" ${status==='rejected'?'selected':''}>Rejected</option>
                    </select>`;
        const viewLink = `/applications/review/${a._id}`;
        const isSelected = currentSelectedAppId && String(currentSelectedAppId) === String(a._id);
        return `
            <tr style="border-bottom:1px solid #e1e8ed;" data-app-id="${a._id}">
                <td style="padding:10px 8px;width:36px;text-align:center;">
                    <input type="radio" name="selectedApplication" class="application-select" value="${a._id}" ${isSelected ? 'checked' : ''} style="cursor:pointer;" />
                </td>
                <td style="padding:10px 8px;font-weight:600;color:#2563eb;">
                    <button class="application-jump-link" data-app-id="${a._id}" style="background:none;border:none;color:#2563eb;padding:0;margin:0;font:inherit;text-align:left;cursor:pointer;">
                        ${a.name || ''}
                    </button>
                </td>
                <td style="padding:10px 8px;">${a.email || ''}</td>
                <td style="padding:10px 8px;">${a.phone || ''}</td>
                <td style="padding:10px 8px;">${propertyAddress || ''}</td>
                <td style="padding:10px 8px;">${unitNumber || ''}</td>
                <td style="padding:10px 8px;">${moveIn || ''}</td>
                <td style="padding:10px 8px;">${submitted || ''}</td>
                <td style="padding:10px 8px;">
                    <button class="application-jump-link" data-app-id="${a._id}" style="background:none;border:none;color:inherit;padding:0;margin:0;font:inherit;text-align:left;cursor:pointer;">
                        <span style="display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#4f46e5;font-size:0.8rem;">
                            <i class="fas fa-sticky-note"></i>
                            ${notesCount}
                        </span>
                    </button>
                </td>
                <td style="padding:10px 8px;">${statusSelect}</td>
                <td style="padding:10px 8px;">
                    <a class="btn-secondary" href="${viewLink}" target="_blank" rel="noopener" style="text-decoration:none;padding:6px 10px;border-radius:8px;display:inline-block;">
                         View
                    </a>
                </td>
            </tr>`;
    }).join('');

    list.innerHTML = `
      <div style="overflow-x:auto;">
        <table class="maintenance-table" style="width:100%;border-collapse:collapse;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(44,62,80,0.07);">
          <thead>
            <tr style="background:#f6fafd;">
                            <th style="padding:12px 8px;font-weight:600;color:#2980b9;width:36px;"></th>
              <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Applicant</th>
              <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Email</th>
              <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Phone</th>
              <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Property Address</th>
              <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Unit</th>
              <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Move-In</th>
              <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Submitted</th>
              <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Notes</th>
              <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Status</th>
              <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      </div>
    `;

        focusApplication();

    // Attach change handlers for status dropdowns
    document.querySelectorAll('.app-status-select').forEach(sel => {
        sel.addEventListener('change', async (e) => {
            const el = e.currentTarget;
            const appId = el.dataset.appId;
            const newStatus = el.value;
            try {
                showLoader();
                const res = await fetch(`/api/rental-applications/${appId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                if (!res.ok) throw new Error('Failed to update application status');
                // Update local state
                const idx = (state.applications||[]).findIndex(a => a._id === appId);
                if (idx >= 0) state.applications[idx].status = newStatus;
                showNotification('Application status updated', 'success');

                if (newStatus === 'approved') {
                    const appData = {
                        name: el.dataset.name || '',
                        phone: el.dataset.phone || '',
                        email: el.dataset.email || '',
                        unit: el.dataset.unit || '',
                        moveIn: el.dataset.movein || ''
                    };
                    prefillTenantFromApplication(appData);
                    openModal('addTenantModal');
                }
            } catch (err) {
                console.error('Update status error:', err);
                showNotification('Could not update status', 'error');
                renderApplications();
            } finally {
                hideLoader();
            }
        });
    });

    // Wire application selection to Actions dropdown
    const appsWrapper = document.getElementById('applicationsActionsWrapper');
    const appsMenu = document.getElementById('applicationsActionsMenu');
    const appsBtn = document.getElementById('applicationsActionsBtn');
    const editAppBtn = document.getElementById('editApplicationBtn');
    const deleteAppBtn = document.getElementById('deleteApplicationBtn');

    // Helper to enter inline edit mode for a given row/application
    function enterApplicationEditMode(row, app) {
        if (!row || !app) return;
        const appIdStr = String(app._id || '');
        if (!appIdStr) return;
        // Prevent multiple rows from being edited at once
        if (state.currentEditingApplicationId && state.currentEditingApplicationId !== appIdStr) return;
        if (row.dataset.editing === 'true') return;
        state.currentEditingApplicationId = appIdStr;
        row.dataset.editing = 'true';

        const cells = row.querySelectorAll('td');
        const nameCell = cells[1];
        const emailCell = cells[2];
        const phoneCell = cells[3];
        const propertyCell = cells[4];
        const unitCell = cells[5];
        const moveInCell = cells[6];

        // Derive property address and unit number from notes JSON when available
        let propertyAddress = '';
        let unitNumber = app.unit || '';
        if (app.notes) {
            try {
                const n = JSON.parse(app.notes);
                propertyAddress = n.propertyAddress || '';
                unitNumber = n.unitNumber || unitNumber;
            } catch {}
        }

        function makeInput(type, className, value) {
            const input = document.createElement('input');
            input.type = type;
            input.className = className;
            input.value = value || '';
            return input;
        }

        const nameInput = makeInput('text', 'app-inline-input app-inline-name', app.name || '');
        const emailInput = makeInput('email', 'app-inline-input app-inline-email', app.email || '');
        const phoneInput = makeInput('text', 'app-inline-input app-inline-phone', app.phone || '');
        const propertyInput = makeInput('text', 'app-inline-input app-inline-property', propertyAddress || '');
        const unitInput = makeInput('text', 'app-inline-input app-inline-unit', unitNumber || '');

        const moveInInput = makeInput('date', 'app-inline-input app-inline-movein', '');
        if (app.moveIn) {
            try {
                const d = new Date(app.moveIn);
                if (!isNaN(d.getTime())) {
                    moveInInput.value = d.toISOString().slice(0, 10);
                }
            } catch {}
        }

        if (nameCell) {
            nameCell.innerHTML = '';
            nameCell.appendChild(nameInput);
        }
        if (emailCell) {
            emailCell.innerHTML = '';
            emailCell.appendChild(emailInput);
        }
        if (phoneCell) {
            phoneCell.innerHTML = '';
            phoneCell.appendChild(phoneInput);
        }
        if (propertyCell) {
            propertyCell.innerHTML = '';
            propertyCell.appendChild(propertyInput);
        }
        if (unitCell) {
            unitCell.innerHTML = '';
            unitCell.appendChild(unitInput);
        }
        if (moveInCell) {
            moveInCell.innerHTML = '';
            moveInCell.appendChild(moveInInput);
        }

        // Auto-save when clicking away from the row
        const saveChanges = async () => {
            const statusSelect = row.querySelector('.app-status-select');
            const newStatus = statusSelect ? statusSelect.value : (app.status || 'pending');

            // Build notes JSON with updated property address and unit number, preserving other keys
            let notesObj = {};
            if (app.notes) {
                try {
                    const existing = JSON.parse(app.notes);
                    if (existing && typeof existing === 'object') notesObj = existing;
                } catch {}
            }
            notesObj.propertyAddress = propertyInput.value.trim();
            notesObj.unitNumber = unitInput.value.trim();
            const notesString = JSON.stringify(notesObj);

            const payload = {
                name: nameInput.value.trim(),
                email: emailInput.value.trim(),
                phone: phoneInput.value.trim(),
                unit: unitInput.value.trim(),
                status: newStatus,
                moveIn: moveInInput.value || undefined,
                notes: notesString
            };

            try {
                
                const res = await fetch(`/api/rental-applications/${app._id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error('Failed to update application');
                const updated = await res.json();
                const appData = updated.application || updated;
                state.applications = (state.applications || []).map(a => String(a._id) === String(app._id) ? appData : a);
                state.currentEditingApplicationId = null;
                renderApplications();
                showNotification('Application updated', 'success');
            } catch (err) {
                console.error('Inline application update error:', err);
                showNotification('Could not update application', 'error');
                state.currentEditingApplicationId = null;
                renderApplications();

            }
        };

        const handleDocClick = (ev) => {
            const target = ev.target;
            if (row.contains(target)) return;
            if (!document.body.contains(row)) {
                document.removeEventListener('click', handleDocClick, true);
                return;
            }
            document.removeEventListener('click', handleDocClick, true);
            saveChanges();
        };

        document.addEventListener('click', handleDocClick, true);
    }

    if (appsWrapper) {
        appsWrapper.style.display = state.selectedApplicationId ? 'flex' : 'none';
    }

    document.querySelectorAll('.application-select').forEach(input => {
        input.addEventListener('click', (e) => {
            const val = e.target.value || null;
            if (state.selectedApplicationId && String(state.selectedApplicationId) === String(val)) {
                // Toggle off when clicking the already selected application
                e.target.checked = false;
                state.selectedApplicationId = null;
                if (appsWrapper) appsWrapper.style.display = 'none';
                if (appsMenu) appsMenu.style.display = 'none';
            } else {
                state.selectedApplicationId = val;
                if (appsWrapper) appsWrapper.style.display = val ? 'flex' : 'none';
                if (appsMenu) appsMenu.style.display = 'none';
            }
        });
    });

    if (appsBtn && appsMenu) {
        appsBtn.onclick = (e) => {
            e.stopPropagation();
            if (!state.selectedApplicationId) return;
            appsMenu.style.display = appsMenu.style.display === 'block' ? 'none' : 'block';
        };
    }

    document.addEventListener('click', (e) => {
        if (appsMenu && appsMenu.style.display === 'block' && !appsMenu.contains(e.target) && e.target !== appsBtn) {
            appsMenu.style.display = 'none';
        }
    });

    if (editAppBtn) {
        editAppBtn.onclick = () => {
            const id = state.selectedApplicationId;
            if (!id) return;
            const apps = state.applications || [];
            const app = apps.find(a => String(a._id) === String(id));
            if (!app) return;
            const row = list.querySelector(`tr[data-app-id="${id}"]`);
            enterApplicationEditMode(row, app);
        };
    }

    if (deleteAppBtn) {
        deleteAppBtn.onclick = async () => {
            const id = state.selectedApplicationId;
            if (!id) return;
            if (!confirm('Delete this application? This cannot be undone.')) return;
            try {
                showLoader();
                const res = await fetch(`/api/rental-applications/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Failed to delete application');
                state.applications = (state.applications || []).filter(a => String(a._id) !== String(id));
                state.selectedApplicationId = null;
                renderApplications();
                updateTabCounts();
                showNotification('Application deleted', 'success');
            } catch (err) {
                console.error('Delete application error:', err);
                showNotification('Could not delete application', 'error');
            } finally {
                hideLoader();
            }
        };
    }

    // Wire application name and notes click to open notes drawer
    list.querySelectorAll('.application-jump-link').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            const id = btn.getAttribute('data-app-id');
            if (!id) return;
            openNotesDrawerForApplication(id);
        });
    });

    // Wire row click (excluding controls) to open inline edit mode
    list.querySelectorAll('tr[data-app-id]').forEach(row => {
        row.addEventListener('click', (e) => {
            const target = e.target;
            // Ignore clicks on controls: radio, status select, links, notes/name buttons
            if (target.closest('input[type="radio"]') ||
                target.closest('.app-status-select') ||
                target.closest('a') ||
                target.closest('.application-jump-link')) {
                return;
            }
            if (row.dataset.editing === 'true') return;
            const appId = row.getAttribute('data-app-id');
            if (!appId) return;
            const apps = state.applications || [];
            const app = apps.find(a => String(a._id) === String(appId));
            if (!app) return;
            enterApplicationEditMode(row, app);
        });
    });
}

// Hook up refresh button
document.getElementById('refreshApplicationsBtn')?.addEventListener('click', async () => {
    showLoader();
    try {
        state.applications = [];
        await loadApplications(true);
        showNotification('Applications refreshed', 'success');
    } catch {} finally {
        hideLoader();
    }
});

// Helper to render the global maintenance overview table into the modal body
async function renderGlobalMaintenanceOverview() {
    // Load all maintenance across properties (pending + in-progress only) directly into the overview modal
    const res = await fetch('/api/properties/maintenance?status=pending,in-progress&_=' + Date.now());
    if (!res.ok) throw new Error('Failed to fetch maintenance requests');
    const items = await res.json();

    const body = document.getElementById('globalOverviewBody');
    const title = document.getElementById('globalOverviewTitle');
    if (body && title) {
        title.textContent = 'Maintenance Requests';
        if (!items.length) {
            body.innerHTML = '<div class="empty-state" style="text-align:center;padding:24px;"><i class="fas fa-tools" style="font-size:2em;color:#3498db;margin-bottom:8px;"></i><p>No maintenance requests found.</p></div>';
        } else {
            body.innerHTML = `
                                    <div style="overflow-x:auto;">
                                        <table class="maintenance-table" style="width:100%;border-collapse:collapse;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(44,62,80,0.07);">
                                            <thead>
                                                <tr style="background:#f6fafd;">
                                                    <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Title</th>
                                                    <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Property Address</th>
                                                    <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Unit</th>
                                                    <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Priority</th>
                                                    <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Status</th>
                                                    <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Created</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${items.map(r => {
                                                        const created = r.createdAt ? new Date(r.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';
                                                        const unitLabel = r.unitId ? `Unit ${r.unitId.number || ''}` : '';
                                                        const priority = (r.priority || '').charAt(0).toUpperCase() + (r.priority || '').slice(1);
                                                        const rawStatus = (r.status || 'pending');
                                                        const status = rawStatus.charAt(0).toUpperCase() + rawStatus.slice(1);
                                                        const projectName = r.projectName || (r.projectId && r.projectId.name) || '';

                                                        // Build a best-effort property address string
                                                        let propertyAddress = r.propertyAddress || '';

                                                        // If embedded project has address fields, derive from those
                                                        if (!propertyAddress && r.projectId) {
                                                            const a = (r.projectId.address) || {};
                                                            const line1 = a.line1 || a.addressLine1 || a.street || r.projectId.line1 || '';
                                                            const line2 = a.line2 || a.addressLine2 || a.suite || r.projectId.line2 || '';
                                                            const city = a.city || r.projectId.city || '';
                                                            const state = a.state || r.projectId.state || '';
                                                            const zip = a.zip || a.postalCode || r.projectId.zip || '';
                                                            const parts = [];
                                                            if (line1) parts.push(line1);
                                                            if (line2) parts.push(line2);
                                                            let last = '';
                                                            if (city) last += city;
                                                            if (state) last += (last ? ', ' : '') + state;
                                                            if (zip) last += (last ? ' ' : '') + zip;
                                                            if (last) parts.push(last);
                                                            if (parts.length) propertyAddress = parts.join(', ');
                                                        }

                                                        // As a fallback, try propertyAddress stored in notes JSON (if present)
                                                        if (!propertyAddress && r.notes) {
                                                            try {
                                                                const n = JSON.parse(r.notes);
                                                                propertyAddress = n.propertyAddress || '';
                                                            } catch {}
                                                        }

                                                        return `
                                                            <tr style="border-bottom:1px solid #e1e8ed;">
                                                                <td style="padding:10px 8px;font-weight:600;color:#2563eb;">
                                                                    <button class="maintenance-jump-link" data-project-id="${(r.projectId && r.projectId._id) || r.projectId || ''}" data-request-id="${r._id || ''}" style="background:none;border:none;color:#2563eb;padding:0;margin:0;font:inherit;text-align:left;cursor:pointer;">
                                                                        ${r.title || ''}
                                                                    </button>
                                                                </td>
                                                                <td style="padding:10px 8px;">${propertyAddress || projectName || ''}</td>
                                                                <td style="padding:10px 8px;">${unitLabel}</td>
                                                                <td style="padding:10px 8px;">${priority || ''}</td>
                                                                <td style="padding:10px 8px;">
                                                                    <select class="maintenance-status-select" data-project-id="${(r.projectId && r.projectId._id) || r.projectId || ''}" data-request-id="${r._id || ''}" style="padding:6px 8px;border-radius:8px;border:1px solid #d1d5db;background:#fff;">
                                                                        <option value="pending" ${rawStatus==='pending' ? 'selected' : ''}>Pending</option>
                                                                        <option value="in-progress" ${rawStatus==='in-progress' ? 'selected' : ''}>In-Progress</option>
                                                                        <option value="completed" ${rawStatus==='completed' ? 'selected' : ''}>Completed</option>
                                                                    </select>
                                                                </td>
                                                                <td style="padding:10px 8px;">${created || ''}</td>
                                                            </tr>`;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>`;
        }
    }
}

// Top toolbar icon clicks: jump to respective tabs
document.getElementById('topToolMaintenance')?.addEventListener('click', async () => {
    try {
        await renderGlobalMaintenanceOverview();
                openModal('globalOverviewModal');
    } catch (e) {
        console.error('Error opening maintenance overview modal:', e);
        showNotification('Could not open maintenance overview', 'error');
    }
});

document.getElementById('topToolApplications')?.addEventListener('click', async () => {
    try {
        if (!state.applications || !state.applications.length) {
            await loadApplications(true);
        }
        const body = document.getElementById('globalOverviewBody');
        const title = document.getElementById('globalOverviewTitle');
        if (body && title) {
            // Show only pending applications in the global overview
            const pendingApps = (state.applications || []).filter(a => (a.status || 'pending') === 'pending');
            title.textContent = 'Pending Applications';

            if (!pendingApps.length) {
                body.innerHTML = `
                    <div class="empty-state" style="text-align:center;padding:24px;">
                        <i class="fas fa-file-alt" style="font-size:2em;color:#3498db;margin-bottom:8px;"></i>
                        <p>No pending applications found.</p>
                    </div>`;
            } else {
                const rows = pendingApps.map(a => {
                    let propertyAddress = '';
                    let unitNumber = a.unit || '';
                    if (a.notes) {
                        try {
                            const n = JSON.parse(a.notes);
                            propertyAddress = n.propertyAddress || '';
                            unitNumber = n.unitNumber || unitNumber;
                        } catch {}
                    }
                    let moveIn = '';
                    if (a.moveIn) {
                        try {
                            const d = new Date(a.moveIn);
                            if (!isNaN(d.getTime())) {
                                const y = d.getUTCFullYear();
                                const m = String(d.getUTCMonth() + 1).padStart(2, '0');
                                const day = String(d.getUTCDate()).padStart(2, '0');
                                moveIn = `${m}/${day}/${y}`;
                            }
                        } catch {}
                    }
                    const submitted = a.submitted ? new Date(a.submitted).toLocaleString('en-US') : '';
                    const status = (a.status || 'pending');
                    const statusLabel = status.charAt(0).toUpperCase() + status.slice(1);
                    const viewLink = `/applications/review/${a._id}`;
                    return `
                        <tr style="border-bottom:1px solid #e1e8ed;" data-app-id="${a._id}">
                            <td style="padding:10px 8px;font-weight:600;color:#2563eb;">
                                <button class="application-jump-link" data-app-id="${a._id}" style="background:none;border:none;color:#2563eb;padding:0;margin:0;font:inherit;text-align:left;cursor:pointer;">
                                    ${a.name || ''}
                                </button>
                            </td>
                            <td style="padding:10px 8px;">${a.email || ''}</td>
                            <td style="padding:10px 8px;">${a.phone || ''}</td>
                            <td style="padding:10px 8px;">${propertyAddress || ''}</td>
                            <td style="padding:10px 8px;">${unitNumber || ''}</td>
                            <td style="padding:10px 8px;">${moveIn || ''}</td>
                            <td style="padding:10px 8px;">${submitted || ''}</td>
                            <td style="padding:10px 8px;">${statusLabel}</td>
                            <td style="padding:10px 8px;">
                                <a class="btn-secondary" href="${viewLink}" target="_blank" rel="noopener" style="text-decoration:none;padding:6px 10px;border-radius:8px;display:inline-block;">
                                     View
                                </a>
                            </td>
                        </tr>`;
                }).join('');

                body.innerHTML = `
                  <div style="overflow-x:auto;">
                    <table class="maintenance-table" style="width:100%;border-collapse:collapse;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(44,62,80,0.07);">
                      <thead>
                        <tr style="background:#f6fafd;">
                          <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Applicant</th>
                          <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Email</th>
                          <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Phone</th>
                          <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Property Address</th>
                          <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Unit</th>
                          <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Move-In</th>
                          <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Submitted</th>
                          <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Status</th>
                          <th style="padding:12px 8px;font-weight:600;color:#2980b9;">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${rows}
                      </tbody>
                    </table>
                  </div>
                `;
            }
        }
        openModal('globalOverviewModal');
    } catch (e) {
        console.error('Error opening applications overview modal:', e);
        showNotification('Could not open applications overview', 'error');
    }
});

// When clicking a maintenance item in the global overview, jump to that property's Maintenance tab
document.getElementById('globalOverviewBody')?.addEventListener('click', async (e) => {
    const maintBtn = e.target.closest('.maintenance-jump-link');
    if (maintBtn) {
        const projectId = maintBtn.getAttribute('data-project-id');
        const requestId = maintBtn.getAttribute('data-request-id');
        if (!projectId) return;
        if (requestId) {
            state.highlightMaintenanceId = requestId;
        }
        try {
            showLoader();
            await selectProperty(projectId);
            const maintenanceTabBtn = document.querySelector('.tab-btn[data-tab="maintenance"]');
            maintenanceTabBtn?.click();
            closeModal('globalOverviewModal');
        } catch (err) {
            console.error('Error navigating to property maintenance from global overview:', err);
            showNotification('Could not open property maintenance view', 'error');
        } finally {
            hideLoader();
        }
        return;
    }

    const appBtn = e.target.closest('.application-jump-link');
    if (appBtn) {
        const appId = appBtn.getAttribute('data-app-id');
        if (!appId) return;
        state.highlightApplicationId = appId;
        try {
            const applicationsTabBtn = document.querySelector('.tab-btn[data-tab="applications"]');
            applicationsTabBtn?.click();
            closeModal('globalOverviewModal');
        } catch (err) {
            console.error('Error navigating to applications tab from global overview:', err);
            showNotification('Could not open applications view', 'error');
        }
    }
});

// Handle inline status changes for maintenance rows in the Global Overview modal
document.getElementById('globalOverviewBody')?.addEventListener('change', async (e) => {
    const select = e.target.closest('.maintenance-status-select');
    if (!select) return;

    const newStatus = select.value;
    const projectId = select.getAttribute('data-project-id');
    const requestId = select.getAttribute('data-request-id');
    if (!projectId || !requestId) return;

    try {
        showLoader();
        const res = await fetch(`${API_URL}/properties/${projectId}/maintenance/${requestId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
        });
        if (!res.ok) throw new Error('Failed to update maintenance status');
        await renderGlobalMaintenanceOverview();
        // Also refresh the top maintenance icon count so it reflects the new status distribution
        if (typeof preloadGlobalMaintenanceCount === 'function') {
            try { await preloadGlobalMaintenanceCount(); } catch {}
        }
        showNotification('Maintenance status updated', 'success');
    } catch (err) {
        console.error('Error updating maintenance status from overview:', err);
        showNotification('Could not update maintenance status', 'error');
    } finally {
        hideLoader();
    }
});

// Helper function to determine file icon
function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    switch (ext) {
        case 'pdf': return 'pdf';
        case 'doc':
        case 'docx': return 'word';
        case 'jpg':
        case 'jpeg':
        case 'png': return 'image';
        default: return 'alt';
    }
}

// Prefill tenant modal fields based on an approved application
function prefillTenantFromApplication(app) {
    try {
        resetTenantForm();
        populateUnitSelect();

        const nameEl = document.getElementById('tenantName');
        const phoneEl = document.getElementById('tenantPhone');
        const emailEl = document.getElementById('tenantEmail');
        const unitEl = document.getElementById('tenantUnit');
        const leaseStartEl = document.getElementById('leaseStart');

        if (nameEl) nameEl.value = app.name || '';
        if (phoneEl) phoneEl.value = app.phone || '';
        if (emailEl) emailEl.value = app.email || '';

        if (leaseStartEl && app.moveIn) {
            const d = new Date(app.moveIn);
            if (!isNaN(d.getTime())) {
                leaseStartEl.value = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
            }
        }

        if (unitEl && app.unit && Array.isArray(state.units)) {
            const match = state.units.find(u => String(u.number) === String(app.unit) && u.status === 'vacant');
            if (match) unitEl.value = match._id;
        }

        // Decode notes JSON (if provided) and prefill extended fields: pets, cars, emergency contact, lease holders, occupants
        if (app.notes) {
            try {
                const raw = decodeURIComponent(app.notes);
                const n = JSON.parse(raw) || {};

                // Normalize application JSON (flat keys) into tenant schema shape
                const norm = {
                    emergencyContact: n.emergencyContact || {
                        name: n.emName || '',
                        phone: n.emPhone || '',
                        email: n.emEmail || '',
                        address: n.emAddress || '',
                        relation: n.emRel || ''
                    },
                    leaseHolders: Array.isArray(n.leaseHolders) ? n.leaseHolders : (()=>{
                        const full = [n.caFirst, n.caMiddle, n.caLast].filter(Boolean).join(' ').trim();
                        const email = n.caEmail || '';
                        const phone = n.caPhone || '';
                        return full || email || phone ? [{ name: full, email, phone }] : [];
                    })(),
                    authorizedOccupants: (()=>{
                        const names = [];
                        for (let i=1;i<=5;i++){
                            const nm = n[`occ${i}Name`];
                            if (nm && String(nm).trim()) names.push(String(nm).trim());
                        }
                        return names;
                    })(),
                    pets: (()=>{
                        const details = [];
                        for (let i=1;i<=3;i++){
                            const type = n[`pet${i}Type`];
                            const weight = n[`pet${i}Weight`];
                            const age = n[`pet${i}Age`];
                            const vaccinated = n[`pet${i}Vaccinated`];
                            if ((type && String(type).trim()) || (weight && String(weight).trim()) || (age && String(age).trim()) || (vaccinated && String(vaccinated).trim())){
                                details.push({
                                    type: type || '',
                                    name: '',
                                    breed: '',
                                    weight: weight || '',
                                    age: age || '',
                                    gender: '',
                                    vaccination: vaccinated || ''
                                });
                            }
                        }
                        return {
                            hasPets: details.length > 0,
                            count: details.length,
                            fee: 0,
                            nonRefundableFee: 0,
                            monthlyRent: 0,
                            depositIncrease: 0,
                            details
                        };
                    })(),
                    cars: (()=>{
                        const details = [];
                        const addCar = (mm, year, plate) => {
                            if (!mm && !year && !plate) return;
                            details.push({
                                make: mm || '',
                                model: '',
                                color: '',
                                licensePlate: plate || '',
                                year: year || ''
                            });
                        };
                        addCar(n.veh1MakeModel, n.veh1Year, n.veh1Plate);
                        addCar(n.veh2MakeModel, n.veh2Year, n.veh2Plate);
                        let count = parseInt(n.vehCount, 10);
                        if (!Number.isFinite(count) || count <= 0) count = details.length;
                        return {
                            hasCar: details.length > 0,
                            count,
                            details
                        };
                    })()
                };

                // Emergency Contact
                const ecName = document.getElementById('emergencyContactName');
            const ecPhone = document.getElementById('emergencyContactPhone');
            const ecEmail = document.getElementById('emergencyContactEmail');
            const ecAddress = document.getElementById('emergencyContactAddress');
            const ecRelation = document.getElementById('emergencyContactRelation');
                if (ecName) ecName.value = norm.emergencyContact.name || '';
                if (ecPhone) ecPhone.value = norm.emergencyContact.phone || '';
                if (ecEmail) ecEmail.value = norm.emergencyContact.email || '';
                if (ecAddress) ecAddress.value = norm.emergencyContact.address || '';
                if (ecRelation) ecRelation.value = norm.emergencyContact.relation || '';

                // Lease Holders (co-applicants)
                if (Array.isArray(norm.leaseHolders) && norm.leaseHolders.length) {
                    populateLeaseHolders(norm.leaseHolders);
                }

                // Authorized Occupants
                const occ = Array.isArray(norm.authorizedOccupants) ? norm.authorizedOccupants : [];
                if (occ.length) {
                    const ta = document.getElementById('authorizedOccupants');
                    if (ta) ta.value = occ.join('\n');
                }

                // Pets
                if (norm.pets && (norm.pets.hasPets || (Array.isArray(norm.pets.details) && norm.pets.details.length > 0))) {
                    const hasPetsEl = document.getElementById('hasPets');
                    if (hasPetsEl) {
                        hasPetsEl.checked = !!norm.pets.hasPets || (Array.isArray(norm.pets.details) && norm.pets.details.length > 0);
                        document.getElementById('petDetails').style.display = hasPetsEl.checked ? 'block' : 'none';
                    }
                    if (typeof norm.pets.count === 'number') {
                        const petCountEl = document.getElementById('petCount');
                        if (petCountEl) petCountEl.value = String(norm.pets.count);
                        updatePetFields();
                    } else {
                        updatePetFields();
                    }
                    // Fees
                    const petNRF = document.getElementById('petNonRefundableFee');
                    const petMR = document.getElementById('petMonthlyRent');
                    const petDI = document.getElementById('petDepositIncrease');
                    if (petNRF && typeof norm.pets.nonRefundableFee === 'number') petNRF.value = String(norm.pets.nonRefundableFee);
                    if (petMR && typeof norm.pets.monthlyRent === 'number') petMR.value = String(norm.pets.monthlyRent);
                    if (petDI && typeof norm.pets.depositIncrease === 'number') petDI.value = String(norm.pets.depositIncrease);
                    // Details per pet
                    if (Array.isArray(norm.pets.details)) {
                        // Ensure petCount matches
                        const countEl = document.getElementById('petCount');
                        if (countEl) {
                            countEl.value = String(norm.pets.details.length);
                            updatePetFields();
                        }
                        norm.pets.details.forEach((pd, i) => {
                            const pt = document.querySelector(`.pet-type[data-index="${i}"]`);
                            const pn = document.querySelector(`.pet-name[data-index="${i}"]`);
                            const pb = document.querySelector(`.pet-breed[data-index="${i}"]`);
                            const pw = document.querySelector(`.pet-weight[data-index="${i}"]`);
                            const pa = document.querySelector(`.pet-age[data-index="${i}"]`);
                            const gSel = document.querySelector(`.pet-gender[data-index="${i}"]`);
                            const pv = document.querySelector(`.pet-vaccination[data-index="${i}"]`);
                            if (pt) pt.value = pd.type || '';
                            if (pn) pn.value = pd.name || '';
                            if (pb) pb.value = pd.breed || '';
                            if (pw) pw.value = pd.weight || '';
                            if (pa) pa.value = pd.age || '';
                            if (gSel && pd.gender) gSel.value = pd.gender;
                            if (pv) pv.value = pd.vaccination || '';
                        });
                    }
                }

                // Vehicles
                if (norm.cars && (norm.cars.hasCar || (Array.isArray(norm.cars.details) && norm.cars.details.length > 0))) {
                    const hasCarEl = document.getElementById('hasCar');
                    if (hasCarEl) {
                        hasCarEl.checked = !!norm.cars.hasCar || (Array.isArray(norm.cars.details) && norm.cars.details.length > 0);
                        document.getElementById('carDetails').style.display = hasCarEl.checked ? 'block' : 'none';
                    }
                    const carCountEl = document.getElementById('carCount');
                    if (Array.isArray(norm.cars.details)) {
                        if (carCountEl) {
                            carCountEl.value = String(norm.cars.details.length);
                            updateCarFields();
                        }
                        norm.cars.details.forEach((cd, i) => {
                            const cm = document.querySelector(`.car-make[data-index="${i}"]`);
                            const cmo = document.querySelector(`.car-model[data-index="${i}"]`);
                            const cc = document.querySelector(`.car-color[data-index="${i}"]`);
                            const cp = document.querySelector(`.car-plate[data-index="${i}"]`);
                            const cy = document.querySelector(`.car-year[data-index="${i}"]`);
                            if (cm) cm.value = cd.make || '';
                            if (cmo) cmo.value = cd.model || '';
                            if (cc) cc.value = cd.color || '';
                            if (cp) cp.value = cd.licensePlate || '';
                            if (cy) cy.value = cd.year || '';
                        });
                    }
                }
            } catch (e) {
                console.warn('Unable to parse application notes for prefill:', e?.message || e);
            }
        }

        // Focus for quick confirmation/edit
        nameEl?.focus();
    } catch (e) {
        console.warn('Unable to prefill tenant from application:', e?.message || e);
    }
}

// Document utility functions
async function viewDocument(documentId) {
    try {
        if (!state.currentProperty) {
            showNotification('Please select a property first', 'error');
            return;
        }

        const docFile = state.documents.find(d => d._id === documentId);
        if (!docFile) {
            throw new Error('Document not found in state');
        }

        // Check file type based on extension
        const fileExtension = docFile.name.split('.').pop().toLowerCase();
        const url = `${API_URL}/properties/${state.currentProperty._id}/documents/${documentId}/view`;

        if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) {
            // Show images in modal
            const modal = document.createElement('div');
            modal.className = 'modal image-viewer';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${docFile.name}</h3>
                        <button onclick="closeImageViewer(this)" class="btn-close"></button>
                    </div>
                    <div class="modal-body">
                        <img src="${url}" alt="${docFile.name}" style="max-width: 100%; height: auto;">
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'block';
        } else {
            // For PDFs and other docs, open the direct URL in a new tab
            window.open(url, '_blank');
        }
    } catch (error) {
        console.error('Error viewing document:', error);
        showNotification('Error viewing document', 'error');
    }
}




async function downloadDocument(docId) {
    showLoader();
    try {
        const doc = state.documents.find(d => d._id === docId);
        if (!doc) throw new Error('Document not found');

        // Construct the download URL (use the /view endpoint for inline, or create a /download endpoint for attachment)
        const url = `${API_URL}/properties/${state.currentProperty._id}/documents/${docId}/download`;

        // Fetch the file as a blob
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to download document');

        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = doc.name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(downloadUrl);
    } catch (error) {
        console.error('Error downloading document:', error);
        showNotification('Error downloading document', 'error');
           } finally {
        hideLoader(); 
    }
}

// ===== Notes Drawer Logic (Applications & Invites) =====

function getNotesDrawerElements() {
    return {
        root: document.getElementById('notesDrawer'),
        overlay: document.getElementById('notesDrawerOverlay'),
        loaderEl: document.getElementById('notesDrawerLoader'),
        closeBtn: document.getElementById('notesDrawerClose'),
        titleEl: document.getElementById('notesDrawerTitle'),
        subtitleEl: document.getElementById('notesDrawerSubtitle'),
        bodyEl: document.getElementById('notesDrawerBody'),
        formEl: document.getElementById('notesDrawerForm'),
        inputEl: document.getElementById('notesDrawerInput')
    };
}

function setNotesDrawerLoading(isLoading) {
    const { loaderEl } = getNotesDrawerElements();
    if (!loaderEl) return;
    loaderEl.style.display = isLoading ? 'flex' : 'none';
}

function renderNotesDrawerMessages(notes) {
    const { bodyEl } = getNotesDrawerElements();
    if (!bodyEl) return;
    const items = Array.isArray(notes) ? notes : [];
    if (!items.length) {
        bodyEl.innerHTML = '<div class="notes-drawer-empty">No notes yet. Start the conversation below.</div>';
        return;
    }
    const rows = items
        .slice()
        .sort((a, b) => new Date(a.createdAt || 0) - new Date(b.createdAt || 0))
        .map(n => {
            const ts = n.createdAt ? new Date(n.createdAt).toLocaleString('en-US') : '';
            const safeText = (n.text || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            const noteId = n._id || '';
            return `
                <div class="notes-drawer-message" data-note-id="${noteId}">
                    <div class="notes-drawer-bubble">
                        <button type="button" class="notes-drawer-delete" data-note-id="${noteId}" title="Delete note">
                            <i class="fas fa-trash"></i>
                        </button>
                        <div>${safeText}</div>
                        <span class="notes-drawer-timestamp">${ts}</span>
                    </div>
                </div>`;
        }).join('');
    bodyEl.innerHTML = rows;

    // Attach delete handlers for each note trash icon
    bodyEl.querySelectorAll('.notes-drawer-delete').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const noteId = btn.getAttribute('data-note-id');
            if (!noteId) return;
            deleteNoteFromDrawer(noteId);
        });
    });

    bodyEl.scrollTop = bodyEl.scrollHeight;
}

function openNotesDrawerForApplication(appId) {
    const { root, overlay, closeBtn, titleEl, subtitleEl, inputEl } = getNotesDrawerElements();
    if (!root) return;
    const app = (state.applications || []).find(a => String(a._id) === String(appId));
    if (!app) return;

    state.notesDrawerContext = {
        type: 'application',
        id: appId
    };

    if (titleEl) titleEl.textContent = 'Application Notes';
    if (subtitleEl) subtitleEl.textContent = `${app.name || ''}  ${app.email || ''}`.trim();

    renderNotesDrawerMessages(app.notesHistory || []);

    root.classList.add('open');
    if (inputEl) {
        inputEl.value = '';
        setTimeout(() => inputEl.focus(), 50);
    }

    if (overlay) {
        overlay.onclick = () => closeNotesDrawer();
    }
    if (closeBtn) {
        closeBtn.onclick = () => closeNotesDrawer();
    }
}

function openNotesDrawerForInvite(inviteId) {
    const { root, overlay, closeBtn, titleEl, subtitleEl, inputEl } = getNotesDrawerElements();
    if (!root) return;
    const invite = (state.invites || []).find(x => String(x._id) === String(inviteId));
    if (!invite) return;

    state.notesDrawerContext = {
        type: 'invite',
        id: inviteId
    };

    if (titleEl) titleEl.textContent = 'Invite Notes';
    if (subtitleEl) subtitleEl.textContent = `${invite.name || ''}  ${invite.email || ''}`.trim();

    renderNotesDrawerMessages(invite.notesHistory || []);

    root.classList.add('open');
    if (inputEl) {
        inputEl.value = '';
        setTimeout(() => inputEl.focus(), 50);
    }

    if (overlay) {
        overlay.onclick = () => closeNotesDrawer();
    }
    if (closeBtn) {
        closeBtn.onclick = () => closeNotesDrawer();
    }
}

function closeNotesDrawer() {
    const { root } = getNotesDrawerElements();
    if (!root) return;
    root.classList.remove('open');
    state.notesDrawerContext = null;
}

async function deleteNoteFromDrawer(noteId) {
    const ctx = state.notesDrawerContext;
    if (!ctx || !noteId) return;

    if (!confirm('Delete this note? This cannot be undone.')) return;

    let url = '';
    if (ctx.type === 'application') {
        url = `/api/rental-applications/${ctx.id}/notes/${noteId}`;
    } else if (ctx.type === 'invite') {
        url = `/api/application-invites/${ctx.id}/notes/${noteId}`;
    } else if (ctx.type === 'tenant') {
        url = `/api/tenants/${ctx.id}/notes/${noteId}`;
    } else {
        return;
    }

    try {
        setNotesDrawerLoading(true);
        const res = await fetch(url, { method: 'DELETE' });
        if (!res.ok) throw new Error('Failed to delete note');
        const data = await res.json();
        const notes = data.notes || [];

        if (ctx.type === 'application') {
            state.applications = (state.applications || []).map(a =>
                String(a._id) === String(ctx.id) ? { ...a, notesHistory: notes } : a
            );
        } else if (ctx.type === 'invite') {
            state.invites = (state.invites || []).map(x =>
                String(x._id) === String(ctx.id) ? { ...x, notesHistory: notes } : x
            );
        } else if (ctx.type === 'tenant') {
            state.allTenants = (state.allTenants || []).map(t =>
                String(t._id) === String(ctx.id) ? { ...t, notesHistory: notes } : t
            );
        }

        renderNotesDrawerMessages(notes);
    } catch (err) {
        console.error('Delete note error:', err);
        showNotification('Could not delete note', 'error');
    } finally {
        setNotesDrawerLoading(false);
    }
}

document.getElementById('notesDrawerForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const ctx = state.notesDrawerContext;
    const { inputEl } = getNotesDrawerElements();
    if (!ctx || !inputEl) return;
    const text = (inputEl.value || '').trim();
    if (!text) return;

    let url = '';
    if (ctx.type === 'application') {
        url = `/api/rental-applications/${ctx.id}/notes`;
    } else if (ctx.type === 'invite') {
        url = `/api/application-invites/${ctx.id}/notes`;
    } else if (ctx.type === 'tenant') {
        url = `/api/tenants/${ctx.id}/notes`;
    } else {
        return;
    }

    try {
        setNotesDrawerLoading(true);
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text })
        });
        if (!res.ok) throw new Error('Failed to add note');
        const data = await res.json();
        const notes = data.notes || [];

        if (ctx.type === 'application') {
            state.applications = (state.applications || []).map(a =>
                String(a._id) === String(ctx.id) ? { ...a, notesHistory: notes } : a
            );
        } else if (ctx.type === 'invite') {
            state.invites = (state.invites || []).map(x =>
                String(x._id) === String(ctx.id) ? { ...x, notesHistory: notes } : x
            );
        } else if (ctx.type === 'tenant') {
            state.allTenants = (state.allTenants || []).map(t =>
                String(t._id) === String(ctx.id) ? { ...t, notesHistory: notes } : t
            );
        }

        inputEl.value = '';
        renderNotesDrawerMessages(notes);
    } catch (err) {
        console.error('Add note error:', err);
        showNotification('Could not add note', 'error');
    } finally {
        setNotesDrawerLoading(false);
    }
});
// Handle Edit Invite modal submit
document.getElementById('editInviteForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const idEl = document.getElementById('editInviteId');
    const nameEl = document.getElementById('editInviteName');
    const emailEl = document.getElementById('editInviteEmail');
    const propEl = document.getElementById('editInviteProperty');
    const unitEl = document.getElementById('editInviteUnit');
    const statusEl = document.getElementById('editInviteStatus');
    const urlEl = document.getElementById('editInviteUrl');

    const id = idEl?.value;
    if (!id) return;

    const payload = {
        name: nameEl?.value?.trim() || '',
        email: emailEl?.value?.trim() || '',
        propertyName: propEl?.value?.trim() || '',
        unitNumber: unitEl?.value?.trim() || '',
        status: statusEl?.value || 'sent',
        applicationUrl: urlEl?.value?.trim() || ''
    };

    try {
        showLoader();
        const res = await fetch(`/api/application-invites/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('Failed to update invite');
        const updated = await res.json();
        const invData = updated.invite || updated;
        state.invites = (state.invites || []).map(x => String(x._id) === String(id) ? invData : x);
        closeModal('editInviteModal');
        renderInvites();
        showNotification('Invite updated', 'success');
    } catch (err) {
        console.error('Edit invite submit error:', err);
        showNotification('Could not update invite', 'error');
    } finally {
        hideLoader();
    }
});

async function deleteDocument(docId) {
    if (!confirm('Are you sure you want to delete this document?')) {
        return;
    }
showLoader();
    try {
        const response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/documents/${docId}`, {
            method: 'DELETE'
        });

        if (!response.ok) throw new Error('Failed to delete document');
        
    invalidateCache('documents');
    await refreshContent('documents');
        showNotification('Document deleted successfully', 'success');
    } catch (error) {
        console.error('Error deleting document:', error);
        showNotification('Error deleting document', 'error');
            } finally {
        hideLoader();
    }
}


// Load payments when Payments tab is selected
async function loadPayments(propertyId, force = false) {

    try {
        if (!force && shouldUseCache('payments', propertyId)) {
            renderPayments();
            // Ensure tenant rent badges reflect cached payments for this property
            renderTenants();
            updateTabCounts();
            return;
        }
        const response = await fetch(`${API_URL}/properties/${propertyId}/payments`);
        if (!response.ok) throw new Error('Failed to fetch payments');
        state.payments = await response.json();
        renderPayments();
        // After loading fresh payments for the selected property, recompute tenant rent status badges
        renderTenants();
        updateTabCounts(); 
        touchCache('payments', propertyId);
    } catch (error) {
        console.error('Error loading payments:', error);
        showNotification('Error loading payments', 'error');
    const monthPayments = (state.payments || []).filter(p => p.tenantId === tenant._id && p.applyTo === 'rent' && p.date && new Date(p.date).getMonth() === now.getMonth() && new Date(p.date).getFullYear() === now.getFullYear() && (!p.projectId || p.projectId === tenant.propertyId));

    }
}

// Render payments list
function renderPayments() {
    const paymentsList = document.getElementById('paymentsList');
    if (!state.payments.length) {
        paymentsList.innerHTML = `<div class="empty-state"><i class="fas fa-money-check-alt"></i><p>No payments recorded</p></div>`;
        return;
    }
    // Ensure search/sort are initialized once
    if (!window.__paymentsFiltersInitialized) {
        initializeSimplePaymentSearchAndSort();
        window.__paymentsFiltersInitialized = true;
    }
    const { query, sort } = getPaymentSearchAndSort();
    // Helper to derive YYYY-MM from a date-like
    const toYYYYMM = (d) => {
        if (!d) return '';
        const dt = new Date(d);
        if (isNaN(dt)) return '';
        return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
    };
    // Apply token-based search filters
    const filtered = (state.payments || []).filter(p => {
        const tenant = state.tenants.find(t => t._id === p.tenantId);
        const unit = state.units.find(u => u._id === p.unitId);
        const tokens = query.tokens;
        // generalized text search across tenant name, unit number, note, type, method, appliedTo
        const haystack = [
            (tenant?.name || ''),
            (unit?.number != null ? String(unit.number) : ''),
            (p.note || ''),
            (p.type || ''),
            (p.method || ''),
            (p.applyTo || '')
        ].join(' ').toLowerCase();
        if (query.text && !haystack.includes(query.text)) return false;
        // token checks with multi-value support (comma-separated)
        const tname = (tenant?.name || '').toLowerCase();
        const uname = (String(unit?.number || '')).toLowerCase();
        // Prefer exact tenantId filtering when provided
        if (tokens.tenantIdList.length) {
            if (!tokens.tenantIdList.includes(String(p.tenantId))) return false;
        } else if (tokens.tenantList.length) {
            const nameParts = tname.split(/\s+/).filter(Boolean);
            const matchesTenant = tokens.tenantList.some(raw => {
                const x = String(raw || '').toLowerCase().trim();
                if (!x) return false;
                // Space in value: allow substring match on full name
                if (x.includes(' ')) return tname.includes(x);
                // Single token: match includes, any part equals, or any part startsWith
                if (tname.includes(x)) return true;
                if (nameParts.some(p => p === x)) return true;
                if (nameParts.some(p => p.startsWith(x))) return true;
                return false;
            });
            if (!matchesTenant) return false;
        }
        if (tokens.unitList.length && !tokens.unitList.some(x=>uname.includes(x))) return false;
        const ptype = (p.type || '').toLowerCase();
        if (tokens.typeList.length && !tokens.typeList.includes(ptype)) return false;
        const pmeth = (p.method || '').toLowerCase();
        if (tokens.methodList.length && !tokens.methodList.includes(pmeth)) return false;
        const pappl = (p.applyTo || '').toLowerCase();
        if (tokens.applyList.length && !tokens.applyList.includes(pappl)) return false;
        if (tokens.date) {
            const pd = new Date(p.date);
            const [y,m,d] = tokens.date.split('-').map(Number);
            if (isNaN(pd)) return false;
            if (y && pd.getFullYear() !== y) return false;
            if (m && (pd.getMonth()+1) !== m) return false;
            if (d && pd.getDate() !== d) return false;
        }
        if (tokens.amountOp) {
            const amt = Number(p.amount) || 0;
            const val = Number(tokens.amountVal) || 0;
            if (tokens.amountOp === '>' && !(amt > val)) return false;
            if (tokens.amountOp === '<' && !(amt < val)) return false;
            if (tokens.amountOp === '>=' && !(amt >= val)) return false;
            if (tokens.amountOp === '<=' && !(amt <= val)) return false;
            if (tokens.amountOp === '=' && !(amt === val)) return false;
        }
        const pnote = (p.note||'').toLowerCase();
        if (tokens.noteList.length && !tokens.noteList.some(x=>pnote.includes(x))) return false;
        return true;
    });
    // Apply sorting
    const sortCmp = (a,b) => {
        const getTenant = p => state.tenants.find(t=>t._id===p.tenantId)?.name || '';
        const getApplied = p => (p.applyTo || 'rent');
        const getMethod = p => (p.method || '');
        const getAmount = p => Number(p.amount)||0;
        const getDate = p => new Date(p.date);
        const dir = (sort.dir === 'desc') ? -1 : 1;
        let va,vb;
        switch(sort.key){
            case 'tenant': va=getTenant(a).toLowerCase(); vb=getTenant(b).toLowerCase(); return va>vb?dir:(va<vb?-dir:0);
            case 'applied': va=getApplied(a).toLowerCase(); vb=getApplied(b).toLowerCase(); return va>vb?dir:(va<vb?-dir:0);
            case 'method': va=getMethod(a).toLowerCase(); vb=getMethod(b).toLowerCase(); return va>vb?dir:(va<vb?-dir:0);
            case 'amount': va=getAmount(a); vb=getAmount(b); return (va-vb)*dir;
            case 'date': va=getDate(a).getTime(); vb=getDate(b).getTime(); return (va-vb)*dir;
            default: return 0;
        }
    };
    if (sort.key) filtered.sort(sortCmp);
    paymentsList.innerHTML = `
    <div class="table-responsive">
    <table class="payments-table">
            <thead>
                <tr>
                    <th class="sortable" data-sort-key="tenant">Tenant <span class="sort-arrow" id="arrow-tenant"></span></th>
                    <th>Unit #</th>
                    <th>Type</th>
                    <th class="sortable" data-sort-key="applied">Applied To <span class="sort-arrow" id="arrow-applied"></span></th>
                    <th class="sortable" data-sort-key="amount">Amount <span class="sort-arrow" id="arrow-amount"></span></th>
                    <th class="sortable" data-sort-key="method">Method <span class="sort-arrow" id="arrow-method"></span></th>
                    <th class="sortable" data-sort-key="date">Date <span class="sort-arrow" id="arrow-date"></span></th>
                    <th>Late Fee</th>
                    <th>Balance</th>
                    <th>Note</th>
                    <th>Receipt</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody>
                ${filtered.map(payment => {
                    const tenant = state.tenants.find(t => t._id === payment.tenantId);
                    const unit = state.units.find(u => u._id === payment.unitId);
                    // Compute display balance with monthly override awareness (client-side immediate view)
                    let displayBalance = payment.balance;
                    let overrideActive = false;
                    let lateFeeDisplay = Number(payment.lateFee || 0);
                    if (tenant && (payment.applyTo === 'rent' || !payment.applyTo)) {
                        const period = payment.periodMonth || toYYYYMM(payment.date);
                        if (period) {
                            let overrideMap = tenant.monthlyOverrides || null;
                            if (overrideMap && typeof overrideMap.get === 'function') {
                                // Convert Map to plain object for access
                                const obj = {}; overrideMap.forEach((v,k)=>obj[k]=v); overrideMap = obj;
                            }
                            const ov = overrideMap ? overrideMap[period] : null;
                            // Determine expected for this period: use override expected if present; otherwise compute proration+fees
                            if (ov && (ov.expectedRent != null || ov.lateFee != null || ov.lateFeeMode != null)) {
                                const [y, m] = period.split('-').map(Number);
                                const periodDate = (y && m) ? new Date(y, m-1, 1) : new Date(payment.date);
                                // Base expected rent for that period (prorated if first month)
                                let expectedForPeriod;
                                if (Number.isFinite(Number(ov.expectedRent))) {
                                    expectedForPeriod = Number(ov.expectedRent);
                                } else {
                                    // Fallback to calculated expected = base (prorated) + recurring fees
                                    const base = computeExpectedBaseRentForMonth(tenant, periodDate);
                                    const petFees = (tenant.pets?.hasPets ? (Number(tenant.pets.monthlyRent) || 0) : 0);
                                    const additionalFees = (Number(tenant.waterFee) || 0) + (Number(tenant.trashFee) || 0) + (Number(tenant.adminFee) || 0) + (tenant.additionalFee?.amount || 0) + petFees;
                                    expectedForPeriod = base + additionalFees;
                                }
                                // Add late fee override as amount or percent
                                const ovLate = Number(ov.lateFee);
                                const ovMode = (ov.lateFeeMode === 'percent') ? 'percent' : 'amount';
                                if (Number.isFinite(ovLate)) {
                                    const addedLate = (ovMode === 'percent') ? (expectedForPeriod * (ovLate/100)) : ovLate;
                                    lateFeeDisplay = addedLate;
                                    expectedForPeriod += addedLate;
                                } else {
                                    lateFeeDisplay = 0;
                                }

                                const totalPaidForPeriod = (state.payments || []).filter(p =>
                                    p.tenantId === payment.tenantId && (p.applyTo === 'rent' || !p.applyTo) &&
                                    ( (p.periodMonth && p.periodMonth === period) || (!p.periodMonth && toYYYYMM(p.date) === period) )
                                ).reduce((sum, p) => sum + Number(p.amount || 0), 0);
                                displayBalance = expectedForPeriod - totalPaidForPeriod;
                                overrideActive = true;
                            }
                        }
                    }
                    return `
                        <tr class="payment-row" onclick="editPayment('${payment._id}')">
                            <td>${tenant ? `<button class=\"link-button\" title=\"View balance sheet\" onclick=\"event.stopPropagation();openTenantBalanceModal('${tenant._id}')\">${tenant.name}</button>` : 'N/A'}</td>
                            <td>${unit ? unit.number : 'N/A'}</td>
                            <td>${(payment.type || '').charAt(0).toUpperCase() + (payment.type || '').slice(1)}</td>
                            <td>${payment.applyTo ? payment.applyTo.charAt(0).toUpperCase() + payment.applyTo.slice(1) : 'Rent'}</td>
                            <td>${(
                                (Number(payment.amount) === 0 && Number(payment.appliedCredit) > 0)
                                    ? `<span style="color:#065f46;font-weight:600" title="Applied credit">Applied credit $${Number(payment.appliedCredit).toFixed(2)}</span>`
                                    : (payment.amount < 0
                                        ? '<span style="color:#dc2626" title="Credit">-$' + Math.abs(payment.amount).toFixed(2) + '</span>'
                                        : '$' + Number(payment.amount).toFixed(2))
                              )}</td>
                            <td>${payment.method.charAt(0).toUpperCase() + payment.method.slice(1)}</td>
                            <td>${formatDateDisplay(payment.date)}</td>
                            <td>$${Number(lateFeeDisplay).toFixed(2)}</td>
                                                        <td>
                                                            ${displayBalance < 0 || payment.amount < 0
                                                                ? `<button class="link-button" title="Apply credit${overrideActive ? '  override active' : ''}" onclick="event.stopPropagation();openCreditMenu(event, '${payment.tenantId}', '${payment._id}')">` +
                                                                     (displayBalance < 0 ? `<span style='color:#16a34a'>-$${Math.abs(displayBalance).toFixed(2)}</span>` : `$${(Number(displayBalance).toFixed(2))}`) +
                                                                     `</button>`
                                                                : (displayBalance !== undefined && displayBalance !== null ? `$${(Number(displayBalance).toFixed(2))}` : '')}
                                                        </td>
                                                        <td class="note-cell">${payment.note ? payment.note.replace(/</g,'&lt;') : ''}</td>
                                                        <td>
                                                             <button class="btn-icon download-btn" title="Download Receipt" onclick="event.stopPropagation();exportReceipt('${payment._id}')">
                                                                 <i class="fas fa-file-arrow-down"></i>
                                                             </button>
                                                             <button class="btn-icon email-btn" title="Email Receipt" onclick="event.stopPropagation();emailReceipt('${payment._id}')">
                                                                 <i class="fas fa-paper-plane"></i>
                                                             </button>
                                                        </td>
                            <td>
                                <button class="btn-icon delete-btn" onclick="event.stopPropagation();deletePayment('${payment._id}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
    </table>
    </div>
    `;
    // Wire clickable header sort and update arrows
    wireClickableHeaderSort();
    updateSortArrows();
}

// Initialize single search bar and header sort controls
function initializeSimplePaymentSearchAndSort() {
    const search = document.getElementById('paymentSearchBar');
    if (search) {
        if (search.dataset._inited === '1') return;
        search.dataset._inited = '1';
        const debouncedRender = debounce(renderPayments, 200);
        search.addEventListener('input', ()=> { positionSearchSuggestions(); autoSuggestBasedOnInput(); showSearchSuggestions(true); debouncedRender(); });
        search.addEventListener('change', ()=> { positionSearchSuggestions(); debouncedRender(); });
        search.addEventListener('focus', ()=> { positionSearchSuggestions(); showSearchSuggestions(true); });
        search.addEventListener('blur', ()=> setTimeout(()=>showSearchSuggestions(false), 120));
        // basic keyboard navigation for the dropdown
        search.addEventListener('keydown', (e)=>{
            const list = document.getElementById('paymentSuggestList');
            const box = document.getElementById('paymentSearchSuggestions');
            if (!list || box.style.display === 'none') return;
            const items = Array.from(list.querySelectorAll('.suggest-item'));
            if (!items.length) return;
            window.__suggestIndex = (typeof window.__suggestIndex === 'number') ? window.__suggestIndex : -1;
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                window.__suggestIndex = Math.min(items.length-1, window.__suggestIndex + 1);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                window.__suggestIndex = Math.max(0, window.__suggestIndex - 1);
            } else if (e.key === 'Enter') {
                if (window.__suggestIndex >= 0) {
                    e.preventDefault();
                    const item = items[window.__suggestIndex];
                    const token = item.getAttribute('data-token') || '';
                    const acc = (window.__accumulatedQuery || '').trim();
                    const sep = acc ? ' ' : '';
                    window.__accumulatedQuery = `${acc}${sep}${token}`;
                    search.value = '';
                    renderPayments();
                    showSearchSuggestions(false);
                    window.__suggestIndex = -1;
                    // Defocus so the field is ready for the next filter (user clicks to reopen)
                    search.blur();
                }
            }
            // update highlight
            items.forEach((li, idx) => li.style.background = idx === window.__suggestIndex ? '#f1f5f9' : 'transparent');
        });
    }
    const clr = document.getElementById('clearPaymentFiltersBtn');
    if (clr) clr.onclick = ()=>{ if (search) search.value=''; window.__accumulatedQuery=''; renderPayments(); showSearchSuggestions(false); };

    const sug = document.getElementById('paymentSearchSuggestions');
    if (sug) {
        renderSuggestionTokens();
        sug.addEventListener('mousedown', (e)=>{
            const item = e.target.closest('.suggest-item');
            const valItem = e.target.closest('.suggest-value');
            e.preventDefault();
            if (item) {
                // Choose token -> show values for that token
                const token = item.getAttribute('data-token') || '';
                showValueSuggestions(token);
            } else if (valItem) {
                const token = valItem.getAttribute('data-token') || '';
                const value = valItem.getAttribute('data-value') || '';
                if (search) {
                    const acc = (window.__accumulatedQuery || '').trim();
                    const sep = acc ? ' ' : '';
                    window.__accumulatedQuery = `${acc}${sep}${token}${value}`;
                    search.value = '';
                    renderPayments();
                    showSearchSuggestions(false);
                    // Defocus to keep box closed until user clicks again
                    search.blur();
                }
            }
        });
        // Back button returns to token list
        const backBtn = document.getElementById('paymentSuggestBack');
        if (backBtn) backBtn.addEventListener('mousedown', (e)=>{ e.preventDefault(); renderSuggestionTokens(); });
        // hover highlight
        sug.addEventListener('mousemove', (e)=>{
            const item = e.target.closest('.suggest-item');
            const valItem = e.target.closest('.suggest-value');
            document.querySelectorAll('#paymentSuggestList .suggest-item').forEach(li => {
                li.style.background = li === item ? '#f8fafc' : 'transparent';
            });
            document.querySelectorAll('#paymentSuggestValues .suggest-value').forEach(li => {
                li.style.background = li === valItem ? '#f8fafc' : 'transparent';
            });
        });
    }
}

function parsePaymentSearch(queryStr) {
    const tokens = { tenant:'', unit:'', type:'', method:'', apply:'', date:'', amountOp:'', amountVal:'', note:'', text:'',
                     tenantList:[], tenantIdList:[], unitList:[], typeList:[], methodList:[], applyList:[], noteList:[] };
    const q = (queryStr || '').trim();
    if (!q) return { tokens, text:'' };
    const parts = q.split(/\s+/);
    const rest = [];
    for (const part of parts) {
        const low = part.toLowerCase();
        const takeVal = (pfx) => part.slice(pfx.length);
        if (low.startsWith('tenant:')) { const v = takeVal('tenant:').toLowerCase(); tokens.tenantList.push(...v.split(',').filter(Boolean)); }
        else if (low.startsWith('tenantid:')) { const v = takeVal('tenantid:'); tokens.tenantIdList.push(...v.split(',').filter(Boolean)); }
        else if (low.startsWith('unit:')) { const v = takeVal('unit:').toLowerCase(); tokens.unitList.push(...v.split(',').filter(Boolean)); }
        else if (low.startsWith('type:')) { const v = takeVal('type:').toLowerCase(); tokens.typeList.push(...v.split(',').filter(Boolean)); }
        else if (low.startsWith('method:')) { const v = takeVal('method:').toLowerCase(); tokens.methodList.push(...v.split(',').filter(Boolean)); }
        else if (low.startsWith('apply:')) { const v = takeVal('apply:').toLowerCase(); tokens.applyList.push(...v.split(',').filter(Boolean)); }
        else if (low.startsWith('date:')) tokens.date = takeVal('date:');
        else if (low.startsWith('amount:')) {
            const val = takeVal('amount:');
            const m = val.match(/^(>=|<=|>|<|=)?\s*(\-?\d+(?:\.\d+)?)$/);
            if (m) { tokens.amountOp = m[1] || '='; tokens.amountVal = m[2]; }
        }
        else if (low.startsWith('note:')) { const v = takeVal('note:').toLowerCase(); tokens.noteList.push(...v.split(',').filter(Boolean)); }
        else rest.push(part);
    }
    // Normalize: trim, dedupe, and set scalar mirrors for chips display
    const dedupe = (arr)=>Array.from(new Set(arr.map(v=>String(v).trim()).filter(Boolean)));
    tokens.tenantList = dedupe(tokens.tenantList);
    tokens.tenantIdList = dedupe(tokens.tenantIdList);
    tokens.unitList = dedupe(tokens.unitList);
    tokens.typeList = dedupe(tokens.typeList);
    tokens.methodList = dedupe(tokens.methodList);
    tokens.applyList = dedupe(tokens.applyList);
    tokens.noteList = dedupe(tokens.noteList);
    tokens.tenant = tokens.tenantList.join(',');
    tokens.unit = tokens.unitList.join(',');
    tokens.type = tokens.typeList.join(',');
    tokens.method = tokens.methodList.join(',');
    tokens.apply = tokens.applyList.join(',');
    tokens.note = tokens.noteList.join(',');
    tokens.text = rest.join(' ').toLowerCase();
    return { tokens, text: tokens.text };
}

function getPaymentSearchAndSort() {
    const currentInput = document.getElementById('paymentSearchBar')?.value || '';
    const combined = `${(window.__accumulatedQuery || '').trim()} ${currentInput.trim()}`.trim();
    const query = parsePaymentSearch(combined);
    const sort = window.__paymentSortState || { key:'', dir:'asc' };
    renderActiveFilterChips(query.tokens);
    return { query, sort };
}

function renderActiveFilterChips(tokens) {
    const container = document.getElementById('activeFilterChips');
    if (!container) return;
    const chipHtml = [];
    const pushChip = (key, value, displayLabel) => {
        chipHtml.push(`
        <span class="filter-chip" data-key="${key}" data-value="${value}" style="display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#eef2f7;color:#374151;border:1px solid #e5e7eb;font-size:.9em;">
            <span style="color:#0b5cab;font-weight:600">${key === 'tenantid:' ? 'tenant:' : key}</span>
            <span>${displayLabel ?? value}</span>
            <button class="chip-remove" title="Remove" style="background:transparent;border:none;color:#6b7280;cursor:pointer;font-weight:700;"></button>
        </span>`);
    };
    // Split multi-value lists into individual chips for fine-grained removal
    // Prefer ID-based chips with display names
    if (tokens.tenantIdList && tokens.tenantIdList.length) {
        tokens.tenantIdList.forEach(id => {
            const t = (state.tenants || []).find(tt => String(tt._id) === String(id));
            const label = t?.name || String(id);
            pushChip('tenantid:', String(id), label);
        });
    } else {
        (tokens.tenantList || []).forEach(v => pushChip('tenant:', v));
    }
    (tokens.unitList || []).forEach(v => pushChip('unit:', v));
    (tokens.typeList || []).forEach(v => pushChip('type:', v));
    (tokens.methodList || []).forEach(v => pushChip('method:', v));
    (tokens.applyList || []).forEach(v => pushChip('apply:', v));
    if (tokens.date) pushChip('date:', tokens.date);
    if (tokens.amountOp) pushChip('amount:', `${tokens.amountOp}${tokens.amountVal}`);
    (tokens.noteList || []).forEach(v => pushChip('note:', v));
    container.innerHTML = chipHtml.join('');
    container.querySelectorAll('.chip-remove').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
            const chip = e.target.closest('.filter-chip');
            if (!chip) return;
            const key = chip.getAttribute('data-key') || '';
            const value = chip.getAttribute('data-value') || '';
            removeFilterTokenFromSearch(key, value);
        });
    });
}

function removeFilterTokenFromSearch(key, value) {
    // Robust approach: parse current tokens, remove the specific value, then rebuild the query
    const currentInput = document.getElementById('paymentSearchBar')?.value || '';
    const combined = `${(window.__accumulatedQuery || '').trim()} ${currentInput.trim()}`.trim();
    const { tokens } = parsePaymentSearch(combined);
    const normVal = (value || '').toLowerCase();
    const removeFrom = (list) => {
        const idx = list.findIndex(v => v.toLowerCase() === normVal);
        if (idx >= 0) list.splice(idx, 1);
    };
    switch (key) {
        case 'tenant:': removeFrom(tokens.tenantList); break;
        case 'tenantid:': removeFrom(tokens.tenantIdList); break;
        case 'unit:': removeFrom(tokens.unitList); break;
        case 'type:': removeFrom(tokens.typeList); break;
        case 'method:': removeFrom(tokens.methodList); break;
        case 'apply:': removeFrom(tokens.applyList); break;
        case 'note:': removeFrom(tokens.noteList); break;
        case 'date:': tokens.date = ''; break;
        case 'amount:': tokens.amountOp = ''; tokens.amountVal = ''; break;
        default: break;
    }
    // Rebuild accumulated query string from remaining tokens (exclude free text input)
    const parts = [];
    if (tokens.tenantIdList.length) parts.push(`tenantid:${tokens.tenantIdList.join(',')}`);
    else if (tokens.tenantList.length) parts.push(`tenant:${tokens.tenantList.join(',')}`);
    if (tokens.unitList.length) parts.push(`unit:${tokens.unitList.join(',')}`);
    if (tokens.typeList.length) parts.push(`type:${tokens.typeList.join(',')}`);
    if (tokens.methodList.length) parts.push(`method:${tokens.methodList.join(',')}`);
    if (tokens.applyList.length) parts.push(`apply:${tokens.applyList.join(',')}`);
    if (tokens.date) parts.push(`date:${tokens.date}`);
    if (tokens.amountOp) parts.push(`amount:${tokens.amountOp}${tokens.amountVal}`);
    if (tokens.noteList.length) parts.push(`note:${tokens.noteList.join(',')}`);
    window.__accumulatedQuery = parts.join(' ').trim();
    // Clear input to avoid reintroducing removed values; re-render
    const search = document.getElementById('paymentSearchBar');
    if (search) search.value = '';
    renderPayments();
}

function showSearchSuggestions(show) {
    const box = document.getElementById('paymentSearchSuggestions');
    if (!box) return;
    if (show) renderSuggestionTokens();
    box.style.display = show ? 'block' : 'none';
}

function positionSearchSuggestions() {
    const bar = document.getElementById('paymentsFilterBar');
    const input = document.getElementById('paymentSearchBar');
    const box = document.getElementById('paymentSearchSuggestions');
    if (!bar || !input || !box) return;
    const barRect = bar.getBoundingClientRect();
    const inRect = input.getBoundingClientRect();
    const left = inRect.left - barRect.left;
    const top = inRect.bottom - barRect.top + 6;
    box.style.left = `${left}px`;
    box.style.top = `${top}px`;
    box.style.minWidth = `${Math.max(inRect.width, 320)}px`;
}

function renderSuggestionTokens() {
    const list = document.getElementById('paymentSuggestList');
    const header = document.getElementById('paymentSuggestHeader');
    const title = document.getElementById('paymentSuggestTitle');
    const values = document.getElementById('paymentSuggestValues');
    if (!list) return;
    const tokens = ['tenant:','unit:','type:','method:','apply:','date:','amount:','note:'];
    list.innerHTML = tokens.map(k => `
        <li class='suggest-item' data-token='${k}' style='padding:8px 12px;cursor:pointer;display:flex;gap:8px;align-items:center;'>
            <span style='font-weight:600;color:#1f2937'>${k}</span>
            <span style='font-size:.85em;color:#6b7280'>Add ${k} filter</span>
        </li>
    `).join('');
    if (title) title.textContent = 'Choose a filter';
    const backBtn = document.getElementById('paymentSuggestBack');
    if (backBtn) backBtn.style.display = 'none';
    if (values) { values.style.display = 'none'; values.innerHTML = ''; }
    // Ensure token list is visible when resetting
    list.style.display = 'block';
}

function showValueSuggestions(token) {
    const list = document.getElementById('paymentSuggestList');
    const values = document.getElementById('paymentSuggestValues');
    const title = document.getElementById('paymentSuggestTitle');
    const backBtn = document.getElementById('paymentSuggestBack');
    if (!list || !values || !title) return;
    // Build values by token
    let items = [];
    if (token === 'tenant:' || token === 'tenantid:') {
        items = (state.tenants || []).map(t=>({label: t?.name || 'Unknown', value: t?._id || ''}));
        token = 'tenantid:'; // force ID-based token for reliability
    } else if (token === 'unit:') {
        items = (state.units || []).map(u=>({label: String(u?.number ?? ''), value: String(u?.number ?? '').toLowerCase()}));
    } else if (token === 'type:') {
        items = ['rent','deposit','fee','credit'].map(v=>({label:v, value:v}));
    } else if (token === 'method:') {
        items = ['cash','check','card','bank','online'].map(v=>({label:v, value:v}));
    } else if (token === 'apply:') {
        items = ['rent','deposit','late','water','electric','trash','admin','other'].map(v=>({label:v, value:v}));
    } else if (token === 'date:') {
        // Suggest recent months
        const now = new Date();
        items = Array.from({length:6}, (_,i)=>{
            const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
            const label = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            return {label, value:label};
        });
    } else if (token === 'amount:') {
        items = ['>100','>500','>1000','<100','<500','=0'].map(v=>({label:v, value:v}));
    } else if (token === 'note:') {
        items = ['late','credit','deposit','partial'].map(v=>({label:v, value:v}));
    }
    if (title) title.textContent = `Choose a value for ${token}`;
    if (backBtn) backBtn.style.display = 'inline';
    // Hide token list when showing values
    list.style.display = 'none';
    values.innerHTML = items.map(it=>`<li class='suggest-value' data-token='${token}' data-value='${it.value}' style='padding:8px 12px;cursor:pointer;display:flex;gap:8px;align-items:center;'>
        <span style='font-weight:600;color:#1f2937'>${it.label}</span>
    </li>`).join('');
    values.style.display = items.length ? 'block' : 'none';
}

// Auto switch to value suggestions based on text after a token prefix
function autoSuggestBasedOnInput() {
    const inp = document.getElementById('paymentSearchBar');
    const val = (inp?.value || '').trim();
    const match = val.match(/(tenant:|unit:|type:|method:|apply:|date:|amount:|note:)([^\s]*)$/i);
    if (match) {
        const token = match[1].toLowerCase();
        const partial = match[2].toLowerCase();
        // Show values filtered by partial
        showValueSuggestions(token);
        // Filter list by partial if available
        const values = document.getElementById('paymentSuggestValues');
        if (values && partial) {
            Array.from(values.querySelectorAll('.suggest-value')).forEach(li => {
                const v = (li.getAttribute('data-value') || '').toLowerCase();
                li.style.display = v.includes(partial) ? 'flex' : 'none';
            });
        }
    } else {
        renderSuggestionTokens();
    }
}

function wireClickableHeaderSort() {
    const headers = document.querySelectorAll('.payments-table thead .sortable');
    headers.forEach(h => {
        h.style.cursor = 'pointer';
        h.addEventListener('click', () => {
            const key = h.getAttribute('data-sort-key');
            const cur = window.__paymentSortState || { key:'', dir:'asc' };
            let dir = 'asc';
            if (cur.key === key) dir = cur.dir === 'asc' ? 'desc' : 'asc';
            window.__paymentSortState = { key, dir };
            renderPayments();
        });
    });
}

function updateSortArrows() {
    const cur = window.__paymentSortState || { key:'', dir:'asc' };
    const keys = ['tenant','applied','amount','method','date'];
    keys.forEach(k => {
        const el = document.getElementById(`arrow-${k}`);
        if (!el) return;
        if (cur.key === k) {
            el.textContent = cur.dir === 'asc' ? '' : '';
            el.style.color = '#217dbb';
            el.style.fontSize = '0.85em';
            el.style.marginLeft = '4px';
        } else {
            el.textContent = '';
        }
    });
}

// Floating credit apply menu
let creditMenuEl;
function ensureCreditMenu() {
    if (creditMenuEl) return creditMenuEl;
    creditMenuEl = document.createElement('div');
    creditMenuEl.id = 'creditApplyMenu';
        creditMenuEl.style.position = 'fixed';
        creditMenuEl.style.background = '#fff';
        creditMenuEl.style.border = '1px solid #e5e7eb';
        creditMenuEl.style.borderRadius = '12px';
        creditMenuEl.style.boxShadow = '0 12px 32px rgba(0,0,0,0.16)';
        creditMenuEl.style.padding = '0';
        creditMenuEl.style.zIndex = 6000;
        creditMenuEl.style.display = 'none';
        creditMenuEl.style.minWidth = '260px';
        creditMenuEl.style.overflow = 'hidden';
        creditMenuEl.style.transform = 'translateY(-6px)';
        creditMenuEl.style.opacity = '0';
        creditMenuEl.style.transition = 'opacity .12s ease, transform .12s ease';

        creditMenuEl.innerHTML = `
            <div style="display:flex;flex-direction:column;min-width:260px;">
                <div id="creditMenuHeader" style="padding:10px 12px;background:#f8fafc;border-bottom:1px solid #eef2f7;display:flex;align-items:center;gap:8px;">
                    <div style="width:28px;height:28px;border-radius:8px;background:#e8f3ff;display:flex;align-items:center;justify-content:center;color:#217dbb;font-weight:700;">$</div>
                    <div>
                        <div style="font-size:.82rem;color:#6b7280;">Available Credit</div>
                        <div id="creditMenuRemaining" style="font-weight:700;color:#065f46;">$0.00</div>
                    </div>
                </div>
                <div style="padding:6px;">
                    <button class="menu-item" data-target="rent"><i class="fas fa-home"></i><span>Apply to Rent</span></button>
                    <button class="menu-item" data-target="deposit"><i class="fas fa-piggy-bank"></i><span>Apply to Deposit</span></button>
                    <div class="menu-divider"></div>
                    <div class="menu-label">Apply to Fee</div>
                    <div class="fee-grid">
                        ${['late','water','electric','trash','admin','other'].map(k=>`<button class='menu-chip' data-target='${k}'>${k.charAt(0).toUpperCase()+k.slice(1)}</button>`).join('')}
                    </div>
                </div>
            </div>`;

        // Scoped styles for menu items
        const style = document.createElement('style');
        style.textContent = `
            #creditApplyMenu .menu-item { display:flex; align-items:center; gap:8px; width:100%; padding:10px 10px; border-radius:10px; border:none; background:transparent; cursor:pointer; color:#1f2937; }
            #creditApplyMenu .menu-item i { color:#217dbb; width:18px; text-align:center; }
            #creditApplyMenu .menu-item:hover { background:#f1f5f9; }
            #creditApplyMenu .menu-divider { height:1px; background:#eef2f7; margin:6px 2px; }
            #creditApplyMenu .menu-label { color:#6b7280; font-size:.82rem; padding:4px 6px 6px; }
            #creditApplyMenu .fee-grid { display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:6px; padding:0 4px 6px; }
            #creditApplyMenu .menu-chip { padding:8px 10px; background:#f8fafc; border:1px solid #e5e7eb; border-radius:999px; cursor:pointer; color:#374151; }
            #creditApplyMenu .menu-chip:hover { background:#eaf6ff; border-color:#cfe8ff; color:#0b5cab; }
        `;
        document.head.appendChild(style);
    document.body.appendChild(creditMenuEl);
    // Delegate clicks
    creditMenuEl.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-target]');
        if (!btn) return;
        const target = btn.getAttribute('data-target');
        const creditPaymentId = creditMenuEl.getAttribute('data-credit-payment-id');
        const tenantId = creditMenuEl.getAttribute('data-tenant-id');
        closeCreditMenu();
        promptAndApplyCredit(tenantId, creditPaymentId, target);
    });
    // Close when clicking outside
    document.addEventListener('click', (e) => {
        if (!creditMenuEl || creditMenuEl.style.display === 'none') return;
        if (!creditMenuEl.contains(e.target)) closeCreditMenu();
    });
    return creditMenuEl;
}

function openCreditMenu(event, tenantId, creditPaymentId) {
    const menu = ensureCreditMenu();
    // If this row isn't the credit payment, try to find a credit with remaining for this tenant
    let sourceId = creditPaymentId;
    const payments = (state.payments || []).filter(p => p.tenantId === tenantId);
    const findRemaining = (p) => {
        const amt = Number(p.amount) || 0;
        const bal = Number(p.balance);
        const base = amt < 0 ? Math.abs(amt) : (isNaN(bal) ? 0 : (bal < 0 ? Math.abs(bal) : 0));
        return Math.max(0, base - Math.abs(Number(p.appliedCredit)||0));
    };
    let remaining = 0;
    if (!payments.find(p => p._id === sourceId && (remaining = findRemaining(p)) > 0)) {
        const candidate = payments.find(p => (Number(p.amount)||0) < 0 && findRemaining(p) > 0);
        if (candidate) { sourceId = candidate._id; remaining = findRemaining(candidate); }
    }
    if (!sourceId || remaining <= 0) {
        showNotification('No available credit to apply', 'info');
        return;
    }
        menu.setAttribute('data-credit-payment-id', sourceId);
    menu.setAttribute('data-tenant-id', tenantId);
    menu.style.left = `${event.clientX + 6}px`;
    menu.style.top = `${event.clientY + 6}px`;
    const remainingEl = document.getElementById('creditMenuRemaining');
    if (remainingEl) remainingEl.textContent = `$${remaining.toFixed(2)}`;
        menu.style.display = 'block';
        requestAnimationFrame(()=>{
            menu.style.opacity = '1';
            menu.style.transform = 'translateY(0)';
        });
}

function closeCreditMenu() {
        if (creditMenuEl) {
            creditMenuEl.style.opacity = '0';
            creditMenuEl.style.transform = 'translateY(-6px)';
            setTimeout(()=>{ if (creditMenuEl) creditMenuEl.style.display = 'none'; }, 120);
        }
}

async function promptAndApplyCredit(tenantId, creditPaymentId, target) {
    try {
        // Compute remaining
        const credit = (state.payments || []).find(p => p._id === creditPaymentId);
        let remaining = 0;
        if (credit) {
            const amt = Number(credit.amount) || 0;
            const bal = Number(credit.balance);
            const base = amt < 0 ? Math.abs(amt) : (isNaN(bal) ? 0 : (bal < 0 ? Math.abs(bal) : 0));
            remaining = Math.max(0, base - Math.abs(Number(credit.appliedCredit)||0));
        }
        let amtStr = prompt(`Enter amount to apply (available $${remaining.toFixed(2)}):`, remaining.toFixed(2));
        if (amtStr === null) return; // cancelled
        const amount = Math.max(0, Number(amtStr) || 0);
        if (amount <= 0) { showNotification('Amount must be greater than 0', 'error'); return; }
        let feeType = '', feeLabel = '', periodMonth = '';
        // Resolve unitId for posting (prefer source payment unitId, else tenant assigned)
        let resolvedUnitId = credit?.unitId || (state.tenants.find(t => t._id === tenantId)?.unitId?._id || state.tenants.find(t => t._id === tenantId)?.unitId || undefined);
        if (target === 'fee' || ['late','water','electric','trash','admin','other'].includes(target)) {
            if (target === 'fee' || target === 'other') {
                feeType = prompt('Enter fee type (e.g., other):', target === 'other' ? 'other' : '') || '';
                feeLabel = prompt('Enter fee label (optional):', '') || '';
            } else {
                feeType = target;
            }
        }
        if (target === 'rent') {
            periodMonth = prompt('Apply to which period (YYYY-MM)? Leave blank for current month:', '') || '';
        }
        showLoader();
        const resp = await fetch(`${API_URL}/properties/${state.currentProperty._id}/payments/${creditPaymentId}/apply-credit`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tenantId, unitId: resolvedUnitId, amount, targetApplyTo: target === 'fee' ? 'fee' : target, feeType, feeLabel, periodMonth })
        });
        if (!resp.ok) throw new Error('Failed to apply credit');
        // Refresh both payments and tenants so deposit paid/summary updates
        invalidateCache('payments','tenants');
        await Promise.all([
            refreshContent('payments'),
            refreshContent('tenants')
        ]);
        showNotification('Credit applied successfully', 'success');
    } catch (e) {
        console.error('Error applying credit:', e);
        showNotification('Error applying credit', 'error');
    } finally {
        hideLoader();
    }
}

// Populate tenant select in payment modal
function populatePaymentTenantSelect() {
    const select = document.getElementById('paymentTenant');
    if (!select) return;
    const isActive = (t) => !['terminated','expired','inactive'].includes(String(t.leaseStatus||'').toLowerCase());
    const allTenants = (state.allTenants && state.allTenants.length ? state.allTenants : (state.tenants || []));
    const propertySelect = document.getElementById('paymentProperty');
    const selectedPropertyId = propertySelect?.value || state.currentProperty?._id || '';
    let tenants = allTenants.filter(isActive);
    if (selectedPropertyId) {
        tenants = tenants.filter(t => {
            const pid = t.projectId || t.propertyId;
            return pid && String(pid) === String(selectedPropertyId);
        });
    }
    select.innerHTML = `<option value="">Select Tenant</option>` +
        tenants.map(t => `<option value="${t._id}">${t.name}</option>`).join('');
}

// --- Monthly Charges (Overrides) UI Logic ---
function populateEditChargesTenantSelect() {
    const sel = document.getElementById('editChargesTenant');
    if (!sel) return;
    const isActive = (t) => !['terminated','expired','inactive'].includes(String(t.leaseStatus||'').toLowerCase());
    const activeTenants = (state.tenants || []).filter(isActive);
    sel.innerHTML = `<option value="">Select Tenant</option>` +
        activeTenants.map(t => `<option value="${t._id}">${t.name}</option>`).join('');
}

function getMonthInputValueYYYYMM(inputId) {
    const v = document.getElementById(inputId)?.value || '';
    // input type=month returns YYYY-MM
    if (/^\d{4}-\d{2}$/.test(v)) return v;
    return '';
}

async function fetchMonthOverride(tenantId, period) {
    const resp = await fetch(`${API_URL}/tenants/${tenantId}/monthly-overrides/${period}`);
    if (!resp.ok) return null;
    const data = await resp.json();
    return data?.override || null;
}

// Keep UI snappy: update local state immediately so badges reflect changes without waiting for network refresh
function upsertLocalTenantMonthlyOverride(tenantId, period, overrideObjOrNull) {
    if (!state.tenants) return;
    const t = state.tenants.find(tt => tt._id === tenantId);
    if (!t) return;
    // Normalize monthlyOverrides to a plain object for easy access
    if (!t.monthlyOverrides) {
        t.monthlyOverrides = {};
    } else if (typeof t.monthlyOverrides.get === 'function') {
        const obj = {};
        t.monthlyOverrides.forEach((v, k) => { obj[k] = v; });
        t.monthlyOverrides = obj;
    }
    if (overrideObjOrNull) {
        t.monthlyOverrides[period] = { ...t.monthlyOverrides[period], ...overrideObjOrNull };
    } else {
        delete t.monthlyOverrides[period];
    }
}

// Mirror override changes into the cross-portfolio tenant list as well
function upsertLocalAllTenantMonthlyOverride(tenantId, period, overrideObjOrNull) {
    if (!Array.isArray(state.allTenants)) return;
    const t = state.allTenants.find(tt => String(tt._id) === String(tenantId));
    if (!t) return;
    if (!t.monthlyOverrides) {
        t.monthlyOverrides = {};
    } else if (typeof t.monthlyOverrides.get === 'function') {
        const obj = {};
        t.monthlyOverrides.forEach((v, k) => { obj[k] = v; });
        t.monthlyOverrides = obj;
    }
    if (overrideObjOrNull) {
        t.monthlyOverrides[period] = { ...t.monthlyOverrides[period], ...overrideObjOrNull };
    } else {
        delete t.monthlyOverrides[period];
    }
}

async function openEditMonthChargesModal() {
    const modal = document.getElementById('editMonthChargesModal');
    if (!modal) return;
    populateEditChargesTenantSelect();
    // default month to current
    const now = new Date();
    const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    const monthInput = document.getElementById('editChargesMonth');
    if (monthInput) monthInput.value = ym;
    // Prefill tenant if only one
    const sel = document.getElementById('editChargesTenant');
    if (sel && sel.options.length === 2) sel.selectedIndex = 1;
    // Clear fields
    document.getElementById('editChargesExpected').value = '';
    document.getElementById('editChargesLateFee').value = '';
    const modeSel = document.getElementById('editChargesLateFeeMode');
    if (modeSel) modeSel.value = 'amount';
    // Try load if both available
    const tenantId = sel?.value;
    if (tenantId) {
        const ov = await fetchMonthOverride(tenantId, ym);
        if (ov) {
            document.getElementById('editChargesExpected').value = ov.expectedRent ?? '';
            document.getElementById('editChargesLateFee').value = ov.lateFee ?? '';
            if (modeSel) modeSel.value = (ov.lateFeeMode === 'percent') ? 'percent' : 'amount';
        }
    }
    modal.style.display = 'block';
}

document.getElementById('editMonthChargesBtn')?.addEventListener('click', (e) => {
    e.preventDefault();
    openEditMonthChargesModal();
});

document.getElementById('editChargesTenant')?.addEventListener('change', async () => {
    const tenantId = document.getElementById('editChargesTenant').value;
    const period = getMonthInputValueYYYYMM('editChargesMonth');
    if (!tenantId || !period) return;
    const ov = await fetchMonthOverride(tenantId, period);
    document.getElementById('editChargesExpected').value = ov?.expectedRent ?? '';
    document.getElementById('editChargesLateFee').value = ov?.lateFee ?? '';
    const modeSel = document.getElementById('editChargesLateFeeMode');
    if (modeSel) modeSel.value = (ov?.lateFeeMode === 'percent') ? 'percent' : 'amount';
});

document.getElementById('editChargesMonth')?.addEventListener('change', async () => {
    const tenantId = document.getElementById('editChargesTenant').value;
    const period = getMonthInputValueYYYYMM('editChargesMonth');
    if (!tenantId || !period) return;
    const ov = await fetchMonthOverride(tenantId, period);
    document.getElementById('editChargesExpected').value = ov?.expectedRent ?? '';
    document.getElementById('editChargesLateFee').value = ov?.lateFee ?? '';
    const modeSel = document.getElementById('editChargesLateFeeMode');
    if (modeSel) modeSel.value = (ov?.lateFeeMode === 'percent') ? 'percent' : 'amount';
});

document.getElementById('editMonthChargesForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const tenantId = document.getElementById('editChargesTenant').value;
    const period = getMonthInputValueYYYYMM('editChargesMonth');
    if (!tenantId || !period) { showNotification('Select tenant and month', 'error'); return; }
    const expectedRentRaw = document.getElementById('editChargesExpected').value;
    const lateFeeRaw = document.getElementById('editChargesLateFee').value;
    const payload = {
        expectedRent: expectedRentRaw === '' ? null : Number(expectedRentRaw),
        lateFee: lateFeeRaw === '' ? null : Number(lateFeeRaw),
        lateFeeMode: document.getElementById('editChargesLateFeeMode')?.value || 'amount'
    };
    showLoader();
    try {
        const resp = await fetch(`${API_URL}/tenants/${tenantId}/monthly-overrides/${period}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!resp.ok) throw new Error('Failed to save override');
        showNotification('Monthly charges saved', 'success');
        // Instant UI reflection: update local state and re-render tenants now
        upsertLocalTenantMonthlyOverride(tenantId, period, payload);
        renderTenants();
    renderPayments();
        // Refresh payments to reflect
        invalidateCache('payments');
        await refreshContent('payments');
        document.getElementById('editMonthChargesModal').style.display = 'none';
    } catch (err) {
        console.error(err);
        showNotification('Error saving monthly charges', 'error');
    } finally {
        hideLoader();
    }
});

document.getElementById('clearMonthChargesBtn')?.addEventListener('click', async () => {
    const tenantId = document.getElementById('editChargesTenant').value;
    const period = getMonthInputValueYYYYMM('editChargesMonth');
    if (!tenantId || !period) { showNotification('Select tenant and month', 'error'); return; }
    showLoader();
    try {
        const resp = await fetch(`${API_URL}/tenants/${tenantId}/monthly-overrides/${period}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ expectedRent: null, lateFee: null })
        });
        if (!resp.ok) throw new Error('Failed to remove override');
    document.getElementById('editChargesExpected').value = '';
    document.getElementById('editChargesLateFee').value = '';
    const modeSel2 = document.getElementById('editChargesLateFeeMode');
    if (modeSel2) modeSel2.value = 'amount';
        showNotification('Override removed', 'success');
        // Instant UI reflection: remove locally and re-render
        upsertLocalTenantMonthlyOverride(tenantId, period, null);
        renderTenants();
    renderPayments();
        invalidateCache('payments');
        await refreshContent('payments');
    } catch (err) {
        console.error(err);
        showNotification('Error removing override', 'error');
    } finally {
        hideLoader();
    }
});

function populatePaymentUnitSelect() {
    const select = document.getElementById('paymentUnit');
    if (!select) return;
    const allUnits = (state.allUnits && state.allUnits.length ? state.allUnits : (state.units || []));
    const propertySelect = document.getElementById('paymentProperty');
    const selectedPropertyId = propertySelect?.value || state.currentProperty?._id || '';
    let units = allUnits;
    if (selectedPropertyId) {
        units = units.filter(u => {
            const pid = u.projectId || u.propertyId || u.project;
            return pid && String(pid) === String(selectedPropertyId);
        });
    }
    select.innerHTML = `<option value="">Select Unit</option>` +
        units.map(u => `<option value="${u._id}">Unit ${u.number}</option>`).join('');
}

// Auto-select assigned unit when tenant is selected in payment form
document.getElementById('paymentTenant')?.addEventListener('change', function() {
    const tenantId = this.value;
    const tenantsSource = (state.allTenants && state.allTenants.length ? state.allTenants : (state.tenants || []));
    const tenant = tenantsSource.find(t => String(t._id) === String(tenantId));
    if (!tenant) return;
    // Try to get the assigned unitId (could be object or string)
    const unitId = tenant.unitId?._id || tenant.unitId;
    if (unitId) {
        document.getElementById('paymentUnit').value = unitId;
    } else {
        document.getElementById('paymentUnit').value = '';
    }
});

// Auto-select assigned tenant when unit is selected in payment form
document.getElementById('paymentUnit')?.addEventListener('change', function() {
    const unitId = this.value;
    // Find the ACTIVE tenant assigned to this unit (skip terminated/expired/inactive)
    const isActive = (t) => !['terminated','expired','inactive'].includes(String(t.leaseStatus||'').toLowerCase());
    const tenantsSource = (state.allTenants && state.allTenants.length ? state.allTenants : (state.tenants || []));
    const tenant = tenantsSource.find(t => {
        const tUnitId = t.unitId?._id || t.unitId;
        return isActive(t) && String(tUnitId) === String(unitId);
    });
    const tenantSelect = document.getElementById('paymentTenant');
    if (tenant && tenantSelect) {
        tenantSelect.value = tenant._id;
    } else if (tenantSelect) {
        // Clear selection if previously set to an inactive tenant
        if (tenantSelect.value && !isActive(state.tenants.find(tt => tt._id === tenantSelect.value))) {
            tenantSelect.value = '';
        }
    }
});

function populatePaymentPropertySelect(selectedPropertyId, lockSelection) {
    const sel = document.getElementById('paymentProperty');
    if (!sel) return;
    const props = state.properties || [];
    sel.innerHTML = '<option value="">Select Property</option>' +
        props.map(p => `<option value="${p._id}">${p.name}</option>`).join('');
    if (selectedPropertyId) {
        sel.value = selectedPropertyId;
    } else if (state.currentProperty?._id) {
        sel.value = state.currentProperty._id;
    }
    sel.disabled = !!lockSelection;
}

function openPaymentModalForTenantAndProperty(tenantId, propertyId, lockProperty) {
    const form = document.getElementById('addPaymentForm');
    if (!form) return;
    form.reset();
    form.dataset.editMode = 'false';
    form.dataset.paymentId = '';
    form.querySelector('button[type="submit"]').textContent = 'Save Payment';

    const effectivePropertyId = propertyId || state.currentProperty?._id || '';
    populatePaymentPropertySelect(effectivePropertyId, !!lockProperty);
    populatePaymentTenantSelect();
    populatePaymentUnitSelect();

    // Default payment date to today (YYYY-MM-DD)
    const dateInput = document.getElementById('paymentDate');
    if (dateInput && !dateInput.value) {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        dateInput.value = `${y}-${m}-${d}`;
    }

    if (tenantId) {
        const tenantSel = document.getElementById('paymentTenant');
        if (tenantSel) {
            tenantSel.value = tenantId;
            tenantSel.dispatchEvent(new Event('change'));
        }
    }

    document.getElementById('paymentApplyTo')?.dispatchEvent(new Event('change'));
    document.getElementById('paymentType')?.dispatchEvent(new Event('change'));
    updateCarryForwardVisibility();
    openModal('addPaymentModal');
}

document.getElementById('paymentProperty')?.addEventListener('change', function() {
    populatePaymentTenantSelect();
    populatePaymentUnitSelect();
    const tenantSel = document.getElementById('paymentTenant');
    const unitSel = document.getElementById('paymentUnit');
    if (tenantSel) tenantSel.value = '';
    if (unitSel) unitSel.value = '';
});

// Normalize and validate payment type against server enum
function normalizePaymentType(raw) {
    if (!raw) return null;
    const t = String(raw).trim().toLowerCase();
    if (t === 'rent') return 'rent';
    // Map common synonyms to HUB if user types them
    if (t === 'hub' || t === 'section8' || t === 'voucher' || t === 'subsidy') return 'hub';
    return null; // not acceptable by server enum
}

function editPayment(paymentId) {
    const payment = state.payments.find(p => p._id === paymentId);
    if (!payment) return showNotification('Payment not found', 'error');

    // Populate selects before setting values
    const propertyId = payment.projectId || payment.propertyId || state.currentProperty?._id || '';
    populatePaymentPropertySelect(propertyId, true);
    populatePaymentTenantSelect();
    populatePaymentUnitSelect();

    // Populate modal fields
    document.getElementById('paymentTenant').value = payment.tenantId;
    document.getElementById('paymentUnit').value = payment.unitId;
    document.getElementById('paymentType').value = payment.type;
    document.getElementById('paymentCustomType').value = payment.customType || '';
    document.getElementById('paymentAmount').value = payment.amount;
    document.getElementById('paymentMethod').value = payment.method;
    document.getElementById('paymentDate').value = payment.date ? new Date(payment.date).toISOString().split('T')[0] : '';
    document.getElementById('paymentLateFee').value = payment.lateFee || 0;
    document.getElementById('paymentApplyTo').value = payment.applyTo || 'rent';
    document.getElementById('paymentFeeType').value = payment.feeType || '';
    document.getElementById('paymentFeeLabel').value = payment.feeLabel || '';
    if (payment.periodMonth) {
        // assume stored as YYYY-MM or full date
        const pm = payment.periodMonth;
        document.getElementById('paymentPeriodMonth').value = pm;
    } else {
        document.getElementById('paymentPeriodMonth').value = '';
    }
    document.getElementById('paymentNote').value = payment.note || '';
    document.getElementById('paymentCarryForward').checked = Boolean(payment.carryForward);
    // Show carry forward group only if this payment is a credit (negative amount)
    const carryGroup = document.getElementById('carryForwardGroup');
    if (carryGroup) carryGroup.style.display = (payment.amount < 0) ? 'flex' : 'none';

    // Store edit mode and paymentId
    const form = document.getElementById('addPaymentForm');
    form.dataset.editMode = 'true';
    form.dataset.paymentId = paymentId;
    form.querySelector('button[type="submit"]').textContent = 'Update Payment';

    // Sync visibility toggles
    document.getElementById('paymentApplyTo')?.dispatchEvent(new Event('change'));
    document.getElementById('paymentType')?.dispatchEvent(new Event('change'));
    updateCarryForwardVisibility();
    openModal('addPaymentModal');
}

// Toggle fee fields when 'Applies To' changes
document.getElementById('paymentApplyTo')?.addEventListener('change', function() {
    const val = this.value;
    const feeRow = document.getElementById('paymentFeeRow');
    const amountInput = document.getElementById('paymentAmount');
    if (val === 'fee') {
        if (feeRow) feeRow.style.display = 'flex';
        if (amountInput) amountInput.placeholder = 'Enter fee amount';
    } else {
        if (feeRow) feeRow.style.display = 'none';
        if (val === 'deposit') {
            if (amountInput) amountInput.placeholder = 'Leave blank to auto-calc remaining deposit';
        } else {
            if (amountInput) amountInput.placeholder = '';
        }
    }
});

// Toggle custom type input when payment type is 'custom'
document.getElementById('paymentType')?.addEventListener('change', function() {
    const isCustom = this.value === 'custom';
    const grp = document.getElementById('customTypeGroup');
    if (grp) grp.style.display = isCustom ? 'block' : 'none';
});

// Carry-forward checkbox deprecated in favor of clickable balance apply-credit menu
function updateCarryForwardVisibility() {
    const group = document.getElementById('carryForwardGroup');
    if (group) group.style.display = 'none';
}

document.getElementById('paymentAmount')?.addEventListener('input', updateCarryForwardVisibility);

// Handle add payment
async function handleAddPayment(event) {
    event.preventDefault();
    const propertySelect = document.getElementById('paymentProperty');
    const selectedPropertyId = propertySelect?.value || state.currentProperty?._id || '';
    if (!selectedPropertyId) {
        showNotification('Please select a property first', 'error');
        return;
    }
    const amount = Number(document.getElementById('paymentAmount').value);
    const lateFeePercent = Number(document.getElementById('paymentLateFee').value) || 0;
    const lateFee = amount * (lateFeePercent / 100);

        // Validate/normalize type for server enum
    const normalizedType = document.getElementById('paymentType').value; // already enum

    const paymentData = {
        tenantId: document.getElementById('paymentTenant').value,
        unitId: document.getElementById('paymentUnit').value,
        type: normalizedType,
        amount: (amount || amount === 0) ? amount : undefined, // allow blank for deposit auto-calc, permit negatives
        method: document.getElementById('paymentMethod').value,
    // Normalize date to ISO at local noon to avoid off-by-one when stored/parsed as UTC
    date: dateInputToISOAtNoon(document.getElementById('paymentDate').value),
        lateFee,
        applyTo: document.getElementById('paymentApplyTo').value,
        feeType: document.getElementById('paymentFeeType').value.trim() || undefined,
        feeLabel: document.getElementById('paymentFeeLabel').value.trim() || undefined,
        periodMonth: document.getElementById('paymentPeriodMonth').value || undefined,
        // Preserve empty string explicitly so clearing a note removes it server-side
        note: (() => { const v = document.getElementById('paymentNote').value; return v === '' ? '' : v.trim(); })(),
        customType: document.getElementById('paymentCustomType').value.trim() || undefined,
        carryForward: document.getElementById('paymentCarryForward').checked || undefined
    };

    const form = event.target;
    const isEdit = form.dataset.editMode === 'true';
    const paymentId = form.dataset.paymentId;
    showLoader();
    try {
        let response;
        if (isEdit && paymentId) {
            response = await fetch(`${API_URL}/properties/${selectedPropertyId}/payments/${paymentId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(paymentData)
            });
        } else {
            response = await fetch(`${API_URL}/properties/${selectedPropertyId}/payments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(paymentData)
            });
        }
        if (!response.ok) throw new Error('Failed to save payment');
    invalidateCache('payments');
    // Only refresh the payments tab list if we're currently on Payments
    if (state.currentTab === 'payments') {
        await refreshContent('payments');
    }
    // Also refresh portfolio rent metrics/table if portfolio is in use
    try {
        if (typeof renderPortfolioOverview === 'function') {
            // Invalidate cached portfolio-wide payments so fresh data is used
            if (Array.isArray(state.portfolioPayments)) {
                state.portfolioPayments = [];
            }
            await renderPortfolioOverview();
            if (state.currentPortfolioDetailsType === 'rent') {
                renderPortfolioDetails('rent');
            }
        }
    } catch (e) {
        console.warn('Error refreshing portfolio after payment:', e);
    }
        closeModal('addPaymentModal');
        showNotification(isEdit ? 'Payment updated successfully' : 'Payment recorded successfully', 'success');
        event.target.reset();
        // Reset form mode
        form.dataset.editMode = 'false';
        form.dataset.paymentId = '';
        form.querySelector('button[type="submit"]').textContent = 'Save Payment';
    } catch (error) {
        console.error('Error saving payment:', error);
        showNotification('Error saving payment', 'error');
            } finally {
        hideLoader();
    }
}

// --- Prorated First-Month Rent Utilities ---
function getTenantStartDateObj(tenant) {
    const raw = tenant?.leaseStart || tenant?.startDate || tenant?.moveInDate;
    if (!raw) return null;
    try { const d = new Date(raw); return isNaN(d.getTime()) ? null : d; } catch { return null; }
}

function daysInMonth(year, monthIndex) { // monthIndex 0-11
    return new Date(year, monthIndex + 1, 0).getDate();
}

function computeProratedRent(tenant, targetDateStr) {
    const startDate = getTenantStartDateObj(tenant);
    if (!startDate) return null; // no start date => cannot prorate automatically
    const targetDate = targetDateStr ? new Date(targetDateStr) : new Date();
    if (isNaN(targetDate.getTime())) return null;
    // Only prorate if the target month is the SAME as the lease start month & year
    if (startDate.getFullYear() !== targetDate.getFullYear() || startDate.getMonth() !== targetDate.getMonth()) {
        return null; // not first month
    }
    // Use base rent from tenant schema (exclude add-ons like pet rent for first-month proration)
    const monthlyTotal = Number(tenant?.baseRent) || Number(tenant?.rent) || Number(tenant?.monthlyRent) || 0;
    if (monthlyTotal <= 0) return null;
    const totalDays = daysInMonth(targetDate.getFullYear(), targetDate.getMonth());
    const startDay = startDate.getDate();
    // Occupied days = totalDays - (startDay - 1)
    const occupiedDays = Math.max(1, totalDays - (startDay - 1));
    const dailyRate = monthlyTotal / totalDays;
    const prorated = occupiedDays * dailyRate;
    return { amount: Number(prorated.toFixed(2)), occupiedDays, totalDays, startDate, monthlyTotal };
}

// Helper: format YYYY-MM from a date string or Date instance
function getPeriodYYYYMM(dateLike) {
    try {
        const d = (typeof dateLike === 'string') ? new Date(dateLike) : (dateLike instanceof Date ? dateLike : null);
        if (!d || isNaN(d.getTime())) return '';
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        return `${y}-${m}`;
    } catch { return ''; }
}

function ensureProrateButton() {
    const modal = document.getElementById('addPaymentModal');
    if (!modal) return;
    const applyToSelect = document.getElementById('paymentApplyTo');
    const amountInput = document.getElementById('paymentAmount');
    if (!applyToSelect || !amountInput) return;
    // Place button next to amount input's parent container
    const container = amountInput.parentElement;
    if (!container) return;
    if (container.querySelector('#prorateRentBtn')) return; // already added
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.id = 'prorateRentBtn';
    btn.style.marginLeft = '8px';
    btn.style.padding = '6px 10px';
    btn.style.fontSize = '0.7rem';
    btn.style.borderRadius = '6px';
    btn.style.border = '1px solid #d1d5db';
    btn.style.background = '#ffffff';
    btn.style.cursor = 'pointer';
    btn.innerHTML = '<i class="fas fa-calculator" style="margin-right:4px;"></i>Prorate First Month';
    container.appendChild(btn);
    btn.addEventListener('click', () => {
        // Only active when Applies To is rent
        if ((applyToSelect.value || 'rent') !== 'rent') {
            showNotification('Proration only applies to rent payments', 'info');
            return;
        }
        const tenantId = document.getElementById('paymentTenant')?.value;
        if (!tenantId) { showNotification('Select a tenant first', 'error'); return; }
        const tenant = state.tenants.find(t => t._id === tenantId);
        if (!tenant) { showNotification('Tenant not found', 'error'); return; }
        const paymentDateStr = document.getElementById('paymentDate')?.value;
        // If no payment date chosen yet, prompt for month (default today) fallback
        let effectiveDateStr = paymentDateStr;
        if (!effectiveDateStr) {
            effectiveDateStr = new Date().toISOString().split('T')[0];
        }
        let result = computeProratedRent(tenant, effectiveDateStr);
        if (!result) {
            // Show inline proration panel within the modal instead of prompts
            ensureProrationInlinePanel(tenant, effectiveDateStr);
            return;
        }
        // Automatic proration path
        amountInput.value = result.amount;
        // Auto-set the period month to the payment date (or lease start month if no date)
        const pmInput = document.getElementById('paymentPeriodMonth');
        if (pmInput) {
            const pm = getPeriodYYYYMM(effectiveDateStr || result.startDate);
            if (pm) pmInput.value = pm;
        }
        const noteEl = document.getElementById('paymentNote');
        if (noteEl) {
            noteEl.value = `Prorated first-month rent (${result.occupiedDays}/${result.totalDays} days) from ${result.startDate.toLocaleDateString()} (@ ${ (result.monthlyTotal / daysInMonth(result.startDate.getFullYear(), result.startDate.getMonth())).toFixed(2) }/day)`;
        }
        showNotification('Prorated rent calculated', 'success');
    });
}

// Create an inline panel for manual proration inputs and calculation
function ensureProrationInlinePanel(tenant, effectiveDateStr) {
    const amountInput = document.getElementById('paymentAmount');
    const container = amountInput?.parentElement;
    if (!container) return;
    let panel = document.getElementById('prorationInlinePanel');
    if (!panel) {
        panel = document.createElement('div');
        panel.id = 'prorationInlinePanel';
        panel.style.marginTop = '8px';
        panel.style.padding = '10px';
        panel.style.background = '#f8fafc';
        panel.style.border = '1px solid #e5e7eb';
        panel.style.borderRadius = '8px';
        panel.innerHTML = `
            <div style="display:flex; align-items:flex-end; gap:10px; flex-wrap:wrap;">
                <div style="display:flex; flex-direction:column;">
                    <label style="font-size:0.8rem; color:#374151; margin-bottom:4px;">Lease Start (First Month)</label>
                    <input id="prorationStartDate" type="date" style="padding:6px 8px; border:1px solid #d1d5db; border-radius:6px;" />
                </div>
                <div style="display:flex; flex-direction:column;">
                    <label style="font-size:0.8rem; color:#374151; margin-bottom:4px;">Full Monthly Rent</label>
                    <input id="prorationMonthlyRent" type="number" step="0.01" min="0" placeholder="0.00" style="padding:6px 8px; border:1px solid #d1d5db; border-radius:6px; width:140px;" />
                </div>
                <div style="display:flex; gap:8px;">
                    <button type="button" id="prorationComputeBtn" style="padding:6px 10px; border:1px solid #d1d5db; background:#fff; border-radius:6px; cursor:pointer; font-size:0.8rem;">
                        <i class="fas fa-equals" style="margin-right:4px;"></i>Compute
                    </button>
                    <button type="button" id="prorationHideBtn" style="padding:6px 10px; border:1px solid #e5e7eb; background:#f3f4f6; border-radius:6px; cursor:pointer; font-size:0.8rem;">
                        Hide
                    </button>
                </div>
            </div>
            <div id="prorationHint" style="margin-top:6px; font-size:0.78rem; color:#6b7280;"></div>
        `;
        container.appendChild(panel);

        // Wire buttons
        panel.querySelector('#prorationHideBtn').onclick = () => { panel.remove(); };
        panel.querySelector('#prorationComputeBtn').onclick = () => {
            const startStr = document.getElementById('prorationStartDate').value;
            const rentVal = Number(document.getElementById('prorationMonthlyRent').value);
            const hint = document.getElementById('prorationHint');
            if (!startStr) { showNotification('Enter a lease start date', 'error'); return; }
            if (!rentVal || rentVal <= 0) { showNotification('Enter a valid monthly rent', 'error'); return; }
            const sd = new Date(startStr);
            const pd = new Date(effectiveDateStr);
            if (isNaN(sd.getTime()) || isNaN(pd.getTime())) { showNotification('Invalid dates', 'error'); return; }
            if (sd.getMonth() !== pd.getMonth() || sd.getFullYear() !== pd.getFullYear()) {
                showNotification('Start date must be within the payment month', 'error');
                return;
            }
            const totalDays = daysInMonth(pd.getFullYear(), pd.getMonth());
            const occupiedDays = Math.max(1, totalDays - (sd.getDate() - 1));
            const dailyRate = rentVal / totalDays;
            const prorated = Number((occupiedDays * dailyRate).toFixed(2));
            amountInput.value = prorated;
            // Ensure Applies To is rent
            const applyToSelect = document.getElementById('paymentApplyTo');
            if (applyToSelect && applyToSelect.value !== 'rent') {
                applyToSelect.value = 'rent';
                applyToSelect.dispatchEvent(new Event('change'));
            }
            // Auto-set the period month to the payment month
            const pmInput = document.getElementById('paymentPeriodMonth');
            if (pmInput) {
                const pm = getPeriodYYYYMM(pd);
                if (pm) pmInput.value = pm;
            }
            const noteEl = document.getElementById('paymentNote');
            if (noteEl) noteEl.value = `Prorated rent (${occupiedDays}/${totalDays} days) from ${sd.toLocaleDateString()} @ ${dailyRate.toFixed(2)}/day`;
            hint.textContent = `Calculated: $${prorated.toFixed(2)} (${occupiedDays}/${totalDays} days; $${dailyRate.toFixed(2)}/day)`;
            showNotification('Prorated rent calculated', 'success');
        };
    }

    // Prefill values if available
    const startInput = panel.querySelector('#prorationStartDate');
    const rentInput = panel.querySelector('#prorationMonthlyRent');
    const startObj = getTenantStartDateObj(tenant);
    if (startObj) startInput.value = startObj.toISOString().split('T')[0];
    const monthlyTotal = Number(tenant?.baseRent) || Number(tenant?.rent) || Number(tenant?.monthlyRent) || 0;
    if (monthlyTotal > 0) rentInput.value = monthlyTotal.toFixed(2);
}

// Hook into modal opening to inject button
const originalOpenModalRef = openModal;
openModal = function(modalId) {
    originalOpenModalRef(modalId);
    if (modalId === 'addPaymentModal') {
        // Defer to ensure elements exist
        setTimeout(ensureProrateButton, 50);
    }
};

async function deletePayment(paymentId) {
    if (!confirm('Are you sure you want to delete this payment?')) return;
    showLoader();
    try {
        const response = await fetch(`${API_URL}/properties/${state.currentProperty._id}/payments/${paymentId}`, {
            method: 'DELETE'
        });
        if (!response.ok) throw new Error('Failed to delete payment');
    invalidateCache('payments');
    await refreshContent('payments');
        showNotification('Payment deleted successfully', 'success');
    } catch (error) {
        console.error('Error deleting payment:', error);
        showNotification('Error deleting payment', 'error');
            } finally {
        hideLoader();
    }
}


// Export receipt as a PDF file
async function exportReceipt(paymentId) {
    const payment = state.payments.find(p => p._id === paymentId);
    if (!payment) {
        showNotification('Payment not found', 'error');
        return;
    }

    const tenant = state.tenants.find(t => t._id === payment.tenantId);
    const unit = state.units.find(u => u._id === payment.unitId);
    // Prefer the property linked to the payment; fallback to currentProperty
    const property = (state.properties || []).find(p => p._id === payment.projectId) || state.currentProperty;

    const formatCurrency = (n) => `$${(Number(n) || 0).toFixed(2)}`; // keep simple for PDF rows, detailed formatter below
    const toTitle = (s) => (s ? s.charAt(0).toUpperCase() + s.slice(1) : '');
    const formatAddressLines = (prop) => {
        if (!prop) return ['Address: N/A'];
        const a = prop.address || {};
        // Support both Property schema (line1/line2) and Project schema (addressLine1/addressLine2)
        const line1 = a.line1 || a.addressLine1 || a.street || prop.line1 || '';
        const line2 = a.line2 || a.addressLine2 || a.suite || prop.line2 || '';
        const city = a.city || prop.city || '';
        const state = a.state || prop.state || '';
        const zip = a.zip || a.postalCode || prop.zip || '';
        const lines = [];
        if (line1) lines.push(line1);
        if (line2) lines.push(line2);
        let last = '';
        if (city) last += city;
        if (state) last += (last ? ', ' : '') + state;
        if (zip) last += (last ? ' ' : '') + zip;
        if (last) lines.push(last);
        if (!lines.length) return ['Address: N/A'];
        return lines;
    };

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Helper: fetch an image URL and convert to Data URL
    const fetchAsDataURL = async (url) => {
        try {
            const res = await fetch(url, { cache: 'no-store' });
            if (!res.ok) return null;
            const blob = await res.blob();
            return await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        } catch (e) {
            return null;
        }
    };

    // Try common logo locations
    let logoDataUrl = null;
    const logoCandidates = [
        '/images/logo.png',
        '/images/logo.jpg',
        '/public/images/logo.png',
        '/public/logo.png',
        '/logo.png'
    ];
    for (const path of logoCandidates) {
        logoDataUrl = await fetchAsDataURL(path);
        if (logoDataUrl) break;
    }

    // Theme colors
    // Adjusted brand palette
    const brand = { r: 31, g: 78, b: 121 }; // #1F4E79
    const success = { r: 39, g: 174, b: 96 };
    const warning = { r: 243, g: 156, b: 18 };
    const textDark = { r: 38, g: 50, b: 56 };   // slightly darker
    const textMuted = { r: 100, g: 116, b: 128 }; // cool gray
    const border = { r: 225, g: 232, b: 237 };

    // Small utility to lighten a color toward white
    const lighten = (c, amt = 0.2) => ({
        r: Math.min(255, Math.round(c.r + (255 - c.r) * amt)),
        g: Math.min(255, Math.round(c.g + (255 - c.g) * amt)),
        b: Math.min(255, Math.round(c.b + (255 - c.b) * amt))
    });

    // Header band with angled accent
    const headerH = 42; // taller for a modern, breathable header
    const headerW = 210; // A4 width in mm for jsPDF default
    const brandLight = lighten(brand, 0.22);
    doc.setFillColor(brand.r, brand.g, brand.b);
    doc.rect(0, 0, headerW, headerH, 'F');
    // Angled overlay on the right to add depth
    doc.setFillColor(brandLight.r, brandLight.g, brandLight.b);
    // Draw a triangle from mid-top to right-top to right-bottom
    doc.triangle(130, 0, headerW, 0, headerW, headerH, 'F');
    // Slim accent line below header
    doc.setFillColor(brandLight.r, brandLight.g, brandLight.b);
    doc.rect(0, headerH, headerW, 1.2, 'F');

    // Header content positions
    let headerTitleX = 14;
    const headerTitleY = 20;
    const headerSubY = 28;

    // Insert logo if available
    if (logoDataUrl) {
        try {
            const logoW = 18; // mm
            const logoH = 18; // mm
            const logoX = 14;
            const logoY = 6;
            doc.addImage(logoDataUrl, 'PNG', logoX, logoY, logoW, logoH);
            headerTitleX = logoX + logoW + 6; // shift title to the right of logo
        } catch (e) {
            // If addImage fails, continue without logo
        }
    }

    doc.setFont('helvetica', 'bold');
    doc.setFontSize(20);
    doc.setTextColor(255, 255, 255);
    doc.text('Payment Receipt', headerTitleX, headerTitleY);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    doc.text('Blue Rain MF LLC', headerTitleX, headerSubY);

    // Payment status badge in header (always show PAID)
    const badgeX = 160, badgeY = 12, badgeW = 38, badgeH = 12;
    doc.setFillColor(success.r, success.g, success.b);
    doc.roundedRect(badgeX, badgeY, badgeW, badgeH, 3, 3, 'F');
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.setTextColor(255, 255, 255);
    doc.text('PAID', badgeX + badgeW / 2, badgeY + 8, { align: 'center' });

    // Subtle watermark behind content
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(60);
    const wmColor = lighten({ r: 230, g: 236, b: 240 }, 0.15); // very light
    doc.setTextColor(wmColor.r, wmColor.g, wmColor.b);
    doc.text('BR', 170, 150, { align: 'center' });

    // Meta box on right  floating card overlapping header
    const metaX = 120;
    const boxTop = headerH - 8;
    const boxW = 76;
    const boxH = 34;
    // Faux shadow
    doc.setFillColor(235, 241, 246);
    doc.roundedRect(metaX + 1.2, boxTop + 1.2, boxW, boxH, 3, 3, 'F');
    // Card
    doc.setFillColor(255, 255, 255);
    doc.setDrawColor(220, 230, 240);
    doc.setLineWidth(0.4);
    doc.roundedRect(metaX, boxTop, boxW, boxH, 3, 3, 'FD');
    const receiptNo = (payment._id || '').slice(-8).toUpperCase();
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(11);
    doc.setTextColor(textDark.r, textDark.g, textDark.b);
    doc.text('Receipt Details', metaX + 4, boxTop + 8);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    doc.setTextColor(textMuted.r, textMuted.g, textMuted.b);
    doc.text(`Receipt # : ${receiptNo}`, metaX + 4, boxTop + 15);
    doc.text(`Date      : ${formatDateDisplay(payment.date)}`, metaX + 4, boxTop + 21);
    doc.text(`Payment ID: ${(payment._id || '').substring(0, 12)}...`, metaX + 4, boxTop + 27);

    // Property address (actual address, not project name)
    doc.setTextColor(textDark.r, textDark.g, textDark.b);
    let y = headerH + 18;
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text('Property Address', 14, y);
    y += 6;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    const addrLines = formatAddressLines(property);
    doc.text(addrLines, 14, y);
    y += (addrLines.length * 6) + 6;

    // Separator
    doc.setDrawColor(230, 230, 230);
    doc.line(14, y, 196, y);
    y += 10;

    // Payer and Payment details columns
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text('Payor', 14, y);
    doc.text('Payment', 110, y);
    y += 7;

    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    const leftCol = [
        `Tenant: ${tenant ? tenant.name : 'N/A'}`,
        `Unit: ${unit ? unit.number : 'N/A'}`,
        tenant?.email ? `Email: ${tenant.email}` : null,
        tenant?.phone ? `Phone: ${tenant.phone}` : null
    ].filter(Boolean);
    leftCol.forEach((line, idx) => doc.text(line, 14, y + (idx * 6)));

    const rightY = y;
    const displayType = payment.type === 'custom' ? (payment.customType || 'Custom') : toTitle(payment.type || '');
    const rightCol = [
        `Type: ${displayType}`,
        `Method: ${toTitle(payment.method)}`,
        `Applied To: ${toTitle(payment.applyTo || 'rent')}`,
        (payment.applyTo && ['water','electric','trash','admin','late','other'].includes(payment.applyTo)) ? `Category: ${toTitle(payment.applyTo)}` : null,
        payment.applyTo === 'fee' && payment.feeType ? `Fee Type: ${toTitle(payment.feeType)}` : null,
        payment.applyTo === 'fee' && payment.feeLabel ? `Fee Label: ${payment.feeLabel}` : null,
        payment.periodMonth ? `Period: ${payment.periodMonth}` : null,
        `Reference: ${receiptNo}`
    ].filter(Boolean);
    rightCol.forEach((line, idx) => doc.text(line, 110, rightY + (idx * 6)));
    const blockHeight = Math.max(leftCol.length, rightCol.length) * 6;
    y = y + blockHeight + 12;

    // Wrapped Note section (full width) if a note exists
    if (payment.note) {
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(11);
        doc.setTextColor(textDark.r, textDark.g, textDark.b);
        doc.text('Note', 14, y);
        y += 6;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(10);
        doc.setTextColor(textMuted.r, textMuted.g, textMuted.b);
        const wrappedNote = doc.splitTextToSize(payment.note, 182); // span near full printable width
        doc.text(wrappedNote, 14, y);
        y += wrappedNote.length * 5 + 8; // advance Y based on line count
        // Separator under note
        doc.setDrawColor(230, 230, 230);
        doc.line(14, y, 196, y);
        y += 10;
    }

    // Totals card
    const cardX = 14;
    const cardW = 182;
    const rowH = 8;
    const cardPadding = 5;
    const amount = Number(payment.amount) || 0;
    const late = Number(payment.lateFee) || 0;
    const totalPaid = amount + late;
    const balance = Number(payment.balance) || 0;

    // Compute compact card height for a single-row summary (includes title gap)
    const rowsCount = 1;
    const titleGap = 10;
    const cardH = cardPadding * 2 + titleGap + (rowH * rowsCount);
    // Card background
    doc.setFillColor(234, 246, 255);
    doc.roundedRect(cardX, y, cardW, cardH, 3, 3, 'F');
    // Card border
    doc.setDrawColor(border.r, border.g, border.b);
    doc.roundedRect(cardX, y, cardW, cardH, 3, 3);

    // Card title
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.setTextColor(textDark.r, textDark.g, textDark.b);
    doc.text('Payment Summary', cardX + cardPadding, y + cardPadding + 2);

    // Rows
    const startY = y + cardPadding + titleGap;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    const drawRow = (label, value, rowIndex, isEmphasis = false) => {
        const yy = startY + rowIndex * rowH;
        doc.setTextColor(textMuted.r, textMuted.g, textMuted.b);
        doc.text(label, cardX + cardPadding, yy);
        doc.setFont('helvetica', isEmphasis ? 'bold' : 'normal');
        doc.setTextColor(textDark.r, textDark.g, textDark.b);
        doc.text(value, cardX + cardW - cardPadding, yy, { align: 'right' });
        doc.setFont('helvetica', 'normal');
    };
    const totalPaidLabel = totalPaid < 0 ? 'Credit Applied' : 'Total Paid';
    drawRow(totalPaidLabel, formatCurrency(totalPaid), 0, true);
    

    y = y + cardH + 10;

    // Acknowledgement and footer
    doc.setDrawColor(230, 230, 230);
    doc.line(14, y, 196, y);
    y += 10;
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(brand.r, brand.g, brand.b);
    doc.setFontSize(12);
    doc.text('Thank you for your payment!', 105, y, { align: 'center' });
    y += 10;
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(150, 150, 150);
    doc.setFontSize(9.5);
    doc.text('Generated by Bluerain MF LLC   (210) 981-9251', 105, y, { align: 'center' });

    // Filename uses tenant name if available
    const filename = `receipt_${tenant ? tenant.name.replace(/\s+/g, '_') : paymentId}.pdf`;
    doc.save(filename);
}

// Email receipt to the tenant using backend mailer (server builds the email content)
async function emailReceipt(paymentId) {
    try {
        const payment = (state.payments || []).find(p => p._id === paymentId);
        if (!payment) {
            showNotification('Payment not found', 'error');
            return;
        }

        const tenant = (state.tenants || []).find(t => t._id === payment.tenantId);
        if (!tenant || !tenant.email) {
            showNotification('Tenant email not available for this payment', 'error');
            return;
        }

        const property = (state.properties || []).find(p => p._id === payment.projectId) || state.currentProperty;
        if (!property || !property._id) {
            showNotification('Property context missing for this payment', 'error');
            return;
        }

        showLoader();

        // Call backend endpoint; server composes and sends the receipt email
        const res = await fetch(`/api/properties/${property._id}/payments/${paymentId}/send-receipt`, {
            method: 'POST'
        });

        if (!res.ok) {
            let msg = 'Error sending receipt email';
            try {
                const data = await res.json();
                if (data && data.message) msg = data.message;
            } catch (_) {}
            showNotification(msg, 'error');
            return;
        }

        showNotification(`Receipt emailed to ${tenant.email}`, 'success');
    } catch (err) {
        console.error('Error emailing receipt:', err);
        showNotification('Error sending receipt email', 'error');
    } finally {
        try { hideLoader(); } catch (_) {}
    }
}

// -------- Tenant Balance Sheet Helpers & Modal --------
// Currency formatter with sign handling used in balance sheet cards
function tenantCurrency(value) {
    const v = Number(value) || 0;
    const sign = v < 0 ? '-' : '';
    return `${sign}$${Math.abs(v).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;
}

function computeTenantRentBalance(tenantId) {
    const relevant = (state.payments || []).filter(p => p.tenantId === tenantId && (p.applyTo === 'rent' || p.applyTo === undefined));
    if (!relevant.length) return 0;
    // Use last recorded balance if available
    const last = relevant.slice().sort((a,b) => new Date(a.date) - new Date(b.date))[relevant.length - 1];
    if (typeof last.balance === 'number') return last.balance;
    const totalPaid = relevant.reduce((sum, p) => sum + Math.abs(Number(p.amount) || 0), 0);
    const expected = relevant.reduce((sum, p) => sum + (Number(p.expectedAmount) || 0), 0);
    return (expected || 0) - totalPaid;
}

function computeTenantDepositStatus(tenantId) {
    const tenant = state.tenants.find(t => t._id === tenantId);
    // Required deposit: base tenant.deposit plus any pet deposit increase (if present)
    const baseRequired = Number(tenant?.deposit) || 0;
    const petIncrease = Number(tenant?.pets?.depositIncrease) || Number(tenant?.depositIncrease) || 0;
    const required = baseRequired + petIncrease;
    // Paid: prefer server-maintained depositPaid if present, else sum deposit payments
    let paid = Number(tenant?.depositPaid);
    if (!Number.isFinite(paid)) {
        const deposits = (state.payments || []).filter(p => p.tenantId === tenantId && p.applyTo === 'deposit');
        paid = deposits.reduce((s,p) => s + (Number(p.amount) || 0), 0);
    }
    const remaining = Math.max(0, required - paid);
    return { required, paid, remaining };
}

function computeTenantCreditRemaining(tenantId) {
    const list = (state.payments || []).filter(p => p.tenantId === tenantId);
    let credits = 0, applied = 0;
    for (const p of list) {
        const amt = Number(p.amount) || 0;
        if (amt < 0) credits += Math.abs(amt);
        applied += Math.abs(Number(p.appliedCredit) || 0);
    }
    return Math.max(0, credits - applied);
}

function openTenantBalanceModal(tenantId) {
    try {
        const tenant = state.tenants.find(t => t._id === tenantId);
        if (!tenant) return;
        const modal = document.getElementById('tenantBalanceModal');
        if (!modal) return;
        // Store tenantId on modal for export usage
        modal.dataset.tenantId = tenantId;
        const headerEl = document.getElementById('tenantBalanceHeader');
        // Show unit number instead of property address next to tenant name
        const unit = state.units.find(u => (u._id === (tenant.unitId?._id || tenant.unitId))) || tenant.unitId || null;
        const unitLabel = unit ? `Unit ${unit.number}` : '';
        headerEl.innerHTML = `<strong>${tenant.name || tenant.tenantName || 'Tenant'}</strong>${unitLabel ? `  <span style="color:#6b7280">${unitLabel}</span>` : ''}`;

        const rentBal = computeTenantRentBalance(tenantId);
        const dep = computeTenantDepositStatus(tenantId);
        const creditRemaining = computeTenantCreditRemaining(tenantId);
        const summary = document.getElementById('tenantBalanceSummary');
        summary.innerHTML = '';
        const cards = [
            { key:'rent', label: 'Rent Balance', value: tenantCurrency(rentBal), accent: rentBal > 0 ? '#991b1b' : (rentBal < 0 ? '#065f46' : '#1f2937') },
            { key:'depositPaid', label: 'Deposit Paid', value: `${tenantCurrency(dep.paid)} / ${tenantCurrency(dep.required)}`, accent: '#1f2937' },
            { key:'depositRemaining', label: 'Deposit Remaining', value: tenantCurrency(dep.remaining), accent: dep.remaining > 0 ? '#92400e' : '#065f46' },
            { key:'creditRemaining', label: 'Credit Remaining', value: tenantCurrency(-creditRemaining), accent: creditRemaining > 0 ? '#065f46' : '#1f2937' }
        ];
        for (const c of cards) {
            const div = document.createElement('div');
            div.className = 'balance-card';
            div.style.border = '1px solid #e5e7eb';
            div.style.borderRadius = '8px';
            div.style.padding = '12px';
            div.style.background = '#f9fafb';
            if (c.key === 'depositPaid') {
                div.id = 'depositPaidCard';
                const paidNum = Number(dep.paid) || 0;
                const reqNum = Number(dep.required) || 0;
                div.innerHTML = `
                    <div style="font-size:0.75rem;color:#6b7280;text-transform:uppercase;letter-spacing:.5px;display:flex;align-items:center;gap:6px;">
                        ${c.label}
                        <button title="Edit deposit paid" aria-label="Edit deposit paid" style="margin-left:6px;width:26px;height:26px;border-radius:6px;border:1px solid #d1d5db;background:#ffffff;color:#374151;display:inline-flex;align-items:center;justify-content:center;" onclick="event.stopPropagation();enterDepositPaidEdit('${tenantId}')"><i class="fas fa-pen"></i></button>
                    </div>
                    <div id="depositPaidDisplay" style="font-weight:600;color:${c.accent};font-size:1.05rem;margin-top:4px;">${tenantCurrency(paidNum)} / ${tenantCurrency(reqNum)}</div>
                    <div id="depositPaidEditor" style="display:none;margin-top:6px;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <input id="depositPaidInput" type="number" step="0.01" min="0" value="${paidNum.toFixed(2)}" style="padding:6px 8px;border:1px solid #d1d5db;border-radius:6px;width:90px;" />
                            <span style="color:#6b7280; font-size:0.75rem;">/ ${tenantCurrency(reqNum)}</span>
                        </div>
                        <div style="margin-top:6px;display:flex;gap:6px;">
                            <button title="Save" aria-label="Save" style="width:28px;height:28px;border-radius:6px;border:1px solid #16a34a;background:#16a34a;color:#ffffff;display:inline-flex;align-items:center;justify-content:center;" onclick="saveDepositPaid('${tenantId}')"><i class="fas fa-check"></i></button>
                            <button title="Cancel" aria-label="Cancel" style="width:28px;height:28px;border-radius:6px;border:1px solid #d1d5db;background:#ffffff;color:#374151;display:inline-flex;align-items:center;justify-content:center;" onclick="cancelDepositPaidEdit('${tenantId}')"><i class="fas fa-times"></i></button>
                        </div>
                    </div>`;
            } else {
                div.innerHTML = `<div style="font-size:0.75rem;color:#6b7280;text-transform:uppercase;letter-spacing:.5px;">${c.label}</div><div style="font-weight:600;color:${c.accent};font-size:1.05rem;margin-top:4px;">${c.value}</div>`;
            }
            summary.appendChild(div);
        }

        const tbody = document.getElementById('tenantPaymentsTbody');
        tbody.innerHTML = '';
        const allTenantPayments = (state.payments || []).filter(p => p.tenantId === tenantId).sort((a,b) => new Date(b.date) - new Date(a.date));

        // Helper: compute monthly override late fee for a period (YYYY-MM)
        function computeMonthlyOverrideLateFee(tenantObj, periodKey) {
            if (!tenantObj) return 0;
            let overrideMap = tenantObj.monthlyOverrides || null;
            if (overrideMap && typeof overrideMap.get === 'function') {
                const obj = {}; overrideMap.forEach((v,k)=>obj[k]=v); overrideMap = obj;
            }
            const ov = overrideMap ? overrideMap[periodKey] : null;
            if (!ov || (ov.lateFee == null && ov.lateFeeMode == null)) return 0;
            // Determine base-before-late: override expectedRent if present; else base proration + recurring fees for that month
            const [yy, mm] = (periodKey || '').split('-').map(Number);
            const periodDate = (yy && mm) ? new Date(yy, mm-1, 1) : new Date();
            const base = computeExpectedBaseRentForMonth(tenantObj, periodDate) || 0;
            const petFees = (tenantObj.pets?.hasPets ? (Number(tenantObj.pets.monthlyRent) || 0) : 0);
            const addl = (Number(tenantObj.waterFee) || 0) + (Number(tenantObj.trashFee) || 0) + (Number(tenantObj.adminFee) || 0) + (tenantObj.additionalFee?.amount || 0) + petFees;
            const beforeLate = Number.isFinite(Number(ov?.expectedRent)) ? Number(ov.expectedRent) : (base + addl);
            const lfVal = Number(ov.lateFee);
            const mode = (ov.lateFeeMode === 'percent') ? 'percent' : 'amount';
            if (!Number.isFinite(lfVal)) return 0;
            const applied = mode === 'percent' ? (beforeLate * (lfVal/100)) : lfVal;
            return Number(applied) || 0;
        }

        // Helper: compute monthly expected rent (including override late fee if any)
        function computeMonthlyExpectedTotal(tenantObj, periodKey) {
            const [yy, mm] = (periodKey || '').split('-').map(Number);
            const periodDate = (yy && mm) ? new Date(yy, mm-1, 1) : new Date();
            const base = computeExpectedBaseRentForMonth(tenantObj, periodDate) || 0;
            const petFees = (tenantObj.pets?.hasPets ? (Number(tenantObj.pets.monthlyRent) || 0) : 0);
            const addl = (Number(tenantObj.waterFee) || 0) + (Number(tenantObj.trashFee) || 0) + (Number(tenantObj.adminFee) || 0) + (tenantObj.additionalFee?.amount || 0) + petFees;
            // Prefer override expectedRent if present
            let beforeLate = base + addl;
            let overrideMap = tenantObj.monthlyOverrides || null;
            if (overrideMap && typeof overrideMap.get === 'function') {
                const obj = {}; overrideMap.forEach((v,k)=>obj[k]=v); overrideMap = obj;
            }
            const ov = overrideMap ? overrideMap[periodKey] : null;
            if (ov && Number.isFinite(Number(ov.expectedRent))) beforeLate = Number(ov.expectedRent);
            const late = computeMonthlyOverrideLateFee(tenantObj, periodKey);
            return beforeLate + late;
        }

    // Build monthly aggregation map:
    // { YYYY-MM: { rentBase, rentCollected, depositCash, depositCredit, feesCash, feesCredit, otherCash, otherCredit, rentCredit, credits, late, expected } }
    const monthlyMap = {};
        for (const p of allTenantPayments) {
            if (!p.date) continue;
            const d = new Date(p.date);
            const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            if (!monthlyMap[key]) monthlyMap[key] = { rentBase:0, rentCollected:0, depositCash:0, depositCredit:0, feesCash:0, feesCredit:0, otherCash:0, otherCredit:0, rentCredit:0, credits:0, late:0 };
            const amt = Number(p.amount) || 0;
            const apply = p.applyTo || 'rent';
            const appliedCred = Number(p.appliedCredit) || 0;
            // Negative payments are issued credits
            if (amt < 0) {
                monthlyMap[key].credits += Math.abs(amt);
                continue;
            }
            // Pure credit allocation entries (amount === 0, appliedCredit > 0)
            if (amt === 0 && appliedCred > 0) {
                if (apply === 'rent') monthlyMap[key].rentCredit += appliedCred;
                else if (apply === 'deposit') monthlyMap[key].depositCredit += appliedCred;
                else if (apply === 'fee' || ['water','electric','trash','admin','late','other'].includes(apply)) monthlyMap[key].feesCredit += appliedCred;
                else monthlyMap[key].otherCredit += appliedCred;
                continue;
            }
            // Cash portion always counts toward collected totals
            if (apply === 'rent') monthlyMap[key].rentCollected += amt;
            else if (apply === 'deposit') monthlyMap[key].depositCash += amt;
            else if (apply === 'fee' || ['water','electric','trash','admin','late','other'].includes(apply)) monthlyMap[key].feesCash += amt;
            else monthlyMap[key].otherCash += amt;
            // If part of the payment consumed credit (appliedCredit > 0) track that separately too
            if (appliedCred > 0) {
                if (apply === 'rent') monthlyMap[key].rentCredit += appliedCred;
                else if (apply === 'deposit') monthlyMap[key].depositCredit += appliedCred;
                else if (apply === 'fee' || ['water','electric','trash','admin','late','other'].includes(apply)) monthlyMap[key].feesCredit += appliedCred;
                else monthlyMap[key].otherCredit += appliedCred;
            }
        }

        // Inject computed monthly override late fee values, expected totals, and base rent
        Object.keys(monthlyMap).forEach(k => {
            monthlyMap[k].late = computeMonthlyOverrideLateFee(tenant, k);
            monthlyMap[k].expected = computeMonthlyExpectedTotal(tenant, k);
            // Base rent (prorated when first month), excluding add-on fees and late
            const [yy, mm] = k.split('-').map(Number);
            const periodDate = (yy && mm) ? new Date(yy, mm-1, 1) : new Date();
            monthlyMap[k].rentBase = Number(computeExpectedBaseRentForMonth(tenant, periodDate)) || 0;
        });

    // Insert / update monthly summary section with toggle (Rent Due vs Paid removed per request)
        let monthlyContainer = document.getElementById('tenantMonthlyBreakdown');
        if (!monthlyContainer) {
            monthlyContainer = document.createElement('div');
            monthlyContainer.id = 'tenantMonthlyBreakdown';
            monthlyContainer.style.margin = '14px 0 10px';
            monthlyContainer.style.padding = '10px 12px';
            monthlyContainer.style.background = '#f1f5f9';
            monthlyContainer.style.border = '1px solid #e2e8f0';
            monthlyContainer.style.borderRadius = '8px';
            const summaryParent = document.getElementById('tenantBalanceSummary');
            summaryParent.parentNode.insertBefore(monthlyContainer, summaryParent.nextSibling);
        }
    // Removed expectedMonthlyRent / variance calculations
        const monthKeys = Object.keys(monthlyMap).sort().reverse();
        if (!monthKeys.length) {
            monthlyContainer.innerHTML = '<div style="color:#6b7280;font-size:0.9rem;">No payments recorded yet.</div>';
        } else {
            // Header with inline toggle button
            const bodyId = 'monthlyBreakdownBody';
            const collapsedAttr = monthlyContainer.getAttribute('data-collapsed') === 'true';
            const toggleIcon = collapsedAttr ? 'fa-chevron-down' : 'fa-chevron-up';
            const bodyDisplay = collapsedAttr ? 'none' : 'block';
            let html = `<div style="font-weight:600;margin-bottom:6px;color:#1f2937;display:flex;align-items:center;justify-content:space-between;gap:8px;">
                <span style="display:flex;align-items:center;gap:8px;"><i class=\"fas fa-calendar\"></i> Monthly Payment Breakdown</span>
                <button id="monthlyToggleBtn" style="background:#ffffff;border:1px solid #d1d5db;color:#374151;padding:4px 8px;font-size:0.7rem;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:4px;">
                    <i class="fas ${toggleIcon}"></i> ${collapsedAttr ? 'Show' : 'Hide'}
                </button>
            </div>`;
            html += `<div id="${bodyId}" style="display:${bodyDisplay};">`;
        html += monthKeys.map(mKey => {
        const m = monthlyMap[mKey];
        const depositDisplay = m.depositCash + m.depositCredit;
        const feesDisplay = m.feesCash + m.feesCredit;
        const otherDisplay = m.otherCash + m.otherCredit;
        const totalCollected = m.rentCollected + m.depositCash + m.feesCash + m.otherCash; // exclude applied credits
                const lateDisp = m.late && m.late > 0 ? `$${m.late.toFixed(2)}` : '$0.00';
                const expectedDisp = `$${(Number(m.expected)||0).toFixed(2)}`;
                // Variance removed per request; only display Collected amount
                return `<div style="display:grid;grid-template-columns:90px repeat(7,1fr);gap:4px;font-size:0.75rem;align-items:center;padding:6px 8px;border-radius:6px;background:#fff;margin-bottom:4px;border:1px solid #e5e7eb;">
                        <div style="font-weight:600;color:#374151;">${mKey}</div>
                        <div><span style="color:#6b7280;">Expected:</span> ${expectedDisp}</div>
                        <div><span style="color:#6b7280;">Rent:</span> $${m.rentBase.toFixed(2)}</div>
            <div><span style="color:#6b7280;">Deposit:</span> $${depositDisplay.toFixed(2)}${m.depositCredit>0?` <span style='color:#065f46'>(incl credit $${m.depositCredit.toFixed(2)})</span>`:''}</div>
            <div><span style="color:#6b7280;">Fees:</span> $${feesDisplay.toFixed(2)}${m.feesCredit>0?` <span style='color:#065f46'>(incl credit $${m.feesCredit.toFixed(2)})</span>`:''}</div>
            <div><span style="color:#6b7280;">Other:</span> $${otherDisplay.toFixed(2)}${m.otherCredit>0?` <span style='color:#065f46'>(incl credit $${m.otherCredit.toFixed(2)})</span>`:''}</div>
                        <div><span style="color:#6b7280;">Late Fee:</span> ${lateDisp}</div>
                        <div><span style="color:#065f46;">Credits:</span> $${m.credits.toFixed(2)}</div>
                <div style="grid-column:1 / -1; font-size:0.65rem; color:#475569; display:flex; justify-content:space-between; gap:10px;">
               <span>${m.late > 0 ? 'Override late fee applied this month' : ''}</span>
                                    <span>Collected: $${totalCollected.toFixed(2)}</span>
                        </div>
                    </div>`;
            }).join('');
            html += '</div>'; // close body
            monthlyContainer.innerHTML = html;
            // Attach toggle handler (re-attach safely each open)
            const toggleBtn = document.getElementById('monthlyToggleBtn');
            if (toggleBtn) {
                toggleBtn.onclick = () => {
                    const body = document.getElementById(bodyId);
                    if (!body) return;
                    const isHidden = body.style.display === 'none';
                    body.style.display = isHidden ? 'block' : 'none';
                    monthlyContainer.setAttribute('data-collapsed', isHidden ? 'false' : 'true');
                    toggleBtn.innerHTML = `<i class=\"fas ${isHidden ? 'fa-chevron-up' : 'fa-chevron-down'}\"></i> ${isHidden ? 'Hide' : 'Show'}`;
                };
            }
        }

        // Populate detailed payment rows grouped by month (descending)
        let lastMonthKey = null;
        // Determine column count once (fallback 7)
        const paymentsTable = document.getElementById('tenantPaymentsTable');
        let colCount = 7;
        if (paymentsTable) {
            const headerRow = paymentsTable.querySelector('thead tr');
            if (headerRow) colCount = headerRow.children.length || colCount;
        }
        for (const p of allTenantPayments) {
            const monthKey = p.date ? (()=>{ const base = String(p.date).substring(0,10); const parts = base.split('-'); if(parts.length===3){return `${parts[0]}-${parts[1]}`;} const d=new Date(p.date); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; })() : 'Unknown';
            if (monthKey !== lastMonthKey) {
                const groupTr = document.createElement('tr');
                groupTr.className = 'month-group-row';
                const lateHere = monthlyMap[monthKey]?.late || 0;
                const lateBadge = lateHere > 0 ? `<span style="margin-left:10px;color:#9a3412;background:#fffbeb;border:1px solid #fde68a;border-radius:999px;padding:2px 8px;font-size:0.7rem;">Late Fee: $${lateHere.toFixed(2)}</span>` : '';
                groupTr.innerHTML = `<td colspan="${colCount}" style="background:#f1f5f9;color:#374151;font-weight:600;padding:6px 10px;border-top:1px solid #e2e8f0;">${monthKey}${lateBadge}</td>`;
                tbody.appendChild(groupTr);
                lastMonthKey = monthKey;
            }
            const tr = document.createElement('tr');
                        const typeLabel = p.type === 'custom' && p.customType ? p.customType : (p.type || '');
                        const amount = Number(p.amount) || 0;
                        const appliedCred = Number(p.appliedCredit) || 0;
            const bal = typeof p.balance === 'number' ? Number(p.balance) : undefined;
            const note = (p.note || '').toString().replace(/</g,'&lt;').replace(/>/g,'&gt;');
                        tr.innerHTML = `
              <td>${p.date ? formatDateDisplay(p.date) : ''}</td>
              <td>${typeLabel}</td>
              <td>${p.applyTo || ''}${p.feeType ? `  ${p.feeType}` : ''}${p.feeLabel ? ` (${p.feeLabel})` : ''}</td>
                                                        <td style="${(amount < 0 || (amount === 0 && appliedCred > 0)) ? 'color:#065f46;font-weight:600;' : ''} max-width:160px; white-space:normal; word-break:break-word;">`
                            + `${(amount === 0 && appliedCred > 0)
                                        ? 'Applied credit ' + tenantCurrency(appliedCred)
                                        : ((amount < 0 ? '-' : '') + tenantCurrency(Math.abs(amount)))}`
                            + `</td>
              <td>${bal === undefined ? '' : (bal < 0 ? '-' : '') + tenantCurrency(Math.abs(bal))}${bal < 0 ? ' CR' : ''}</td>
              <td style="max-width:240px;white-space:normal;">${note}</td>`;
            tbody.appendChild(tr);
        }
        openModal('tenantBalanceModal');
    } catch (e) {
        console.error('Failed to open tenant balance modal', e);
    }
}

// Inline edit controls for Deposit Paid on Tenant Balance Sheet
function enterDepositPaidEdit(tenantId) {
    const card = document.getElementById('depositPaidCard');
    if (!card) return;
    const disp = card.querySelector('#depositPaidDisplay');
    const editor = card.querySelector('#depositPaidEditor');
    const input = card.querySelector('#depositPaidInput');
    if (disp && editor) {
        disp.style.display = 'none';
        editor.style.display = 'block';
        if (input) {
            input.focus();
            input.select();
            const keyHandler = (e) => {
                if (e.key === 'Enter') { saveDepositPaid(tenantId); }
                else if (e.key === 'Escape') { cancelDepositPaidEdit(tenantId); }
            };
            input.addEventListener('keydown', keyHandler, { once: true });
        }
    }
}

async function saveDepositPaid(tenantId) {
    try {
        const card = document.getElementById('depositPaidCard');
        if (!card) return;
        const input = card.querySelector('#depositPaidInput');
        const val = Number(input?.value);
        if (!Number.isFinite(val) || val < 0) { showNotification('Please enter a non-negative number', 'error'); return; }
        showLoader();
        const resp = await fetch(`${API_URL}/properties/${state.currentProperty._id}/tenants/${tenantId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ depositPaid: val })
        });
        if (!resp.ok) throw new Error('Failed to update deposit paid');
        invalidateCache('tenants');
        await refreshContent('tenants');
        showNotification('Deposit paid updated', 'success');
        openTenantBalanceModal(tenantId);
    } catch (e) {
        console.error('Error updating deposit paid:', e);
        showNotification('Error updating deposit paid', 'error');
    } finally {
        hideLoader();
    }
}

function cancelDepositPaidEdit(tenantId) {
    openTenantBalanceModal(tenantId);
}

// Export per-month detailed report for the tenant in the balance modal
function exportTenantPaymentsReportFromModal() {
    const modal = document.getElementById('tenantBalanceModal');
    if (!modal) return;
    const tenantId = modal.dataset.tenantId;
    if (!tenantId) { showNotification('No tenant loaded for report.', 'error'); return; }
    exportTenantPaymentsReport(tenantId);
}

// Generate a PDF summarizing all payments grouped by month with subtotals
function exportTenantPaymentsReport(tenantId) {
    const tenant = state.tenants.find(t => t._id === tenantId);
    if (!tenant) { showNotification('Tenant not found', 'error'); return; }
    const payments = (state.payments || []).filter(p => p.tenantId === tenantId).sort((a,b)=> new Date(a.date) - new Date(b.date));
    if (!payments.length) { showNotification('No payments to export.', 'info'); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p','mm','a4');
    const pageW = 210;
    let y = 16;
    // Header
    doc.setFont('helvetica','bold');
    doc.setFontSize(16);
    doc.text(`Payment History Report`, 14, y);
    y += 6;
    doc.setFontSize(11);
    doc.setFont('helvetica','normal');
    doc.text(`Tenant: ${tenant.name}    Generated: ${new Date().toLocaleDateString()}`, 14, y);
    y += 8;
    doc.setDrawColor(200,200,200);
    doc.line(14,y,pageW-14,y); y += 6;

    // Group payments by month
    const groups = {};
    for (const p of payments) {
        if (!p.date) continue;
        const d = new Date(p.date);
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        if (!groups[key]) groups[key] = [];
        groups[key].push(p);
    }
    const monthKeys = Object.keys(groups).sort();

    const colDefs = [
        { h:'Date', w:26 },
        { h:'Type', w:22 },
        { h:'Applied', w:30 },
        { h:'Amount', w:22 },
        { h:'Balance', w:24 },
        { h:'Note', w:70 }
    ];
    const lineHeight = 5;

    function addPageIfNeeded(extra=0) {
        if (y + extra > 280) { doc.addPage(); y = 16; }
    }
    function drawHeaderRow(bg=true) {
        addPageIfNeeded(10);
        if (bg) { doc.setFillColor(240,244,248); doc.rect(14,y,pageW-28, lineHeight+2,'F'); }
        doc.setFont('helvetica','bold'); doc.setFontSize(9);
        let x = 16; const baseY = y+lineHeight; 
        for (const c of colDefs) { doc.text(c.h, x, baseY); x += c.w; }
        y += lineHeight + 3;
    }

    // Helper to compute monthly override late fee for a given month key
    function computeMonthlyOverrideLateFeeForReport(tenantObj, periodKey) {
        if (!tenantObj || !periodKey) return 0;
        let overrideMap = tenantObj.monthlyOverrides || null;
        if (overrideMap && typeof overrideMap.get === 'function') {
            const obj = {}; overrideMap.forEach((v,k)=>obj[k]=v); overrideMap = obj;
        }
        const ov = overrideMap ? overrideMap[periodKey] : null;
        if (!ov || (ov.lateFee == null && ov.lateFeeMode == null)) return 0;
        const [yy, mm] = periodKey.split('-').map(Number);
        const periodDate = (yy && mm) ? new Date(yy, mm-1, 1) : new Date();
        const base = computeExpectedBaseRentForMonth(tenantObj, periodDate) || 0;
        const petFees = (tenantObj.pets?.hasPets ? (Number(tenantObj.pets.monthlyRent) || 0) : 0);
        const addl = (Number(tenantObj.waterFee) || 0) + (Number(tenantObj.trashFee) || 0) + (Number(tenantObj.adminFee) || 0) + (tenantObj.additionalFee?.amount || 0) + petFees;
        const beforeLate = Number.isFinite(Number(ov?.expectedRent)) ? Number(ov.expectedRent) : (base + addl);
        const lfVal = Number(ov.lateFee);
        const mode = (ov.lateFeeMode === 'percent') ? 'percent' : 'amount';
        if (!Number.isFinite(lfVal)) return 0;
        const applied = mode === 'percent' ? (beforeLate * (lfVal/100)) : lfVal;
        return Number(applied) || 0;
    }

    // Compute monthly expected helper for report
    function computeMonthlyExpectedForReport(tenantObj, periodKey) {
        if (!tenantObj || !periodKey) return 0;
        let overrideMap = tenantObj.monthlyOverrides || null;
        if (overrideMap && typeof overrideMap.get === 'function') {
            const obj = {}; overrideMap.forEach((v,k)=>obj[k]=v); overrideMap = obj;
        }
        const [yy, mm] = periodKey.split('-').map(Number);
        const periodDate = (yy && mm) ? new Date(yy, mm-1, 1) : new Date();
        const base = computeExpectedBaseRentForMonth(tenantObj, periodDate) || 0;
        const petFees = (tenantObj.pets?.hasPets ? (Number(tenantObj.pets.monthlyRent) || 0) : 0);
        const addl = (Number(tenantObj.waterFee) || 0) + (Number(tenantObj.trashFee) || 0) + (Number(tenantObj.adminFee) || 0) + (tenantObj.additionalFee?.amount || 0) + petFees;
        const ov = overrideMap ? overrideMap[periodKey] : null;
        let beforeLate = Number.isFinite(Number(ov?.expectedRent)) ? Number(ov.expectedRent) : (base + addl);
        // Late fee override
        const lfVal = Number(ov?.lateFee);
        const mode = (ov?.lateFeeMode === 'percent') ? 'percent' : 'amount';
        if (Number.isFinite(lfVal)) beforeLate += (mode === 'percent') ? (beforeLate * (lfVal/100)) : lfVal;
        return beforeLate;
    }

    for (const mKey of monthKeys) {
        addPageIfNeeded(12);
        doc.setFont('helvetica','bold'); doc.setFontSize(11);
        doc.text(mKey, 14, y);
        y += 6;
        drawHeaderRow();
        let monthTotals = { rent:0, deposit:0, fees:0, other:0, credits:0, late:0 };
        for (const p of groups[mKey]) {
            const amt = Number(p.amount) || 0;
            const late = Number(p.lateFee) || 0; // will be overridden by monthly override if present
            const apply = p.applyTo || 'rent';
            const appliedCred = Number(p.appliedCredit) || 0; // ensure defined for PDF row rendering
            if (amt < 0) monthTotals.credits += Math.abs(amt); else if (apply === 'rent') monthTotals.rent += amt; else if (apply==='deposit') monthTotals.deposit += amt; else if (apply==='fee' || ['water','electric','trash','admin','late','other'].includes(apply)) monthTotals.fees += amt; else monthTotals.other += amt;
            const dateStr = p.date ? new Date(p.date).toLocaleDateString() : '';
            const typeLabel = p.type === 'custom' && p.customType ? p.customType : (p.type || '');
            const appliedLabel = apply + (p.feeType ? `/${p.feeType}` : '') + (p.feeLabel ? `(${p.feeLabel})` : '');
            const bal = typeof p.balance === 'number' ? p.balance : null;
            // Wrap note
            const noteRaw = (p.note || '').replace(/\r\n|\r|\n/g,' ');
            const noteLines = doc.splitTextToSize(noteRaw, colDefs[5].w - 2);
            // Amount text and wrapping for narrow column
            const amountText = (amt === 0 && appliedCred > 0)
                ? `Applied credit $${appliedCred.toFixed(2)}`
                : (amt<0?'-':'') + `$${Math.abs(amt).toFixed(2)}`;
            const amountLines = doc.splitTextToSize(amountText, colDefs[3].w - 2);
            const amountHeight = amountLines.length * 4;
            const rowHeight = Math.max(lineHeight, noteLines.length * 4, amountHeight);
            addPageIfNeeded(rowHeight + 2);
            doc.setFont('helvetica','normal'); doc.setFontSize(8);
            let x = 16; const textY = y + lineHeight; // base text line
            doc.text(dateStr, x, textY); x += colDefs[0].w;
            doc.text(typeLabel, x, textY); x += colDefs[1].w;
            doc.text(appliedLabel, x, textY); x += colDefs[2].w;
            // Amount (wrapped)
            if (amountLines.length > 0) {
                doc.text(amountLines[0], x, textY);
                for (let i = 1; i < amountLines.length; i++) {
                    // Place subsequent lines below the base line to avoid overlap
                    doc.text(amountLines[i], x, textY + (i * 4));
                }
            } else {
                doc.text('', x, textY);
            }
            x += colDefs[3].w;
            // Late column removed from PDF row output
            doc.text(bal===null?'':(bal<0?'-':'') + `$${Math.abs(bal).toFixed(2)}` + (bal<0?' CR':''), x, textY); x += colDefs[4].w;
            // Multi-line note
            for (let i=0;i<noteLines.length;i++) {
                doc.text(noteLines[i], x, y + 4 + (i*4));
            }
            y += rowHeight + 2;
        }
        // Replace per-payment late total with monthly override late when present
        const overrideLate = computeMonthlyOverrideLateFeeForReport(tenant, mKey);
        if (overrideLate > 0) monthTotals.late = overrideLate;
        // Month subtotal block (Variance removed to match modal)
        addPageIfNeeded(20);
        doc.setFont('helvetica','bold'); doc.setFontSize(9);
        const expectedThisMonth = computeMonthlyExpectedForReport(tenant, mKey);
        const subtotalLines = [
            `Expected: $${expectedThisMonth.toFixed(2)}`,
            `Rent (base): $${(function(){
                // Base/prorated rent for this month, excluding add-ons and late
                const [yy, mm] = mKey.split('-').map(Number);
                const periodDate = (yy && mm) ? new Date(yy, mm-1, 1) : new Date();
                const baseOnly = Number(computeExpectedBaseRentForMonth(tenant, periodDate)) || 0;
                return baseOnly.toFixed(2);
            })()}`,
            `Deposit: $${monthTotals.deposit.toFixed(2)}`,
            `Fees: $${monthTotals.fees.toFixed(2)}`,
            `Other: $${monthTotals.other.toFixed(2)}`,
            `Credits: $${monthTotals.credits.toFixed(2)}`,
            `Late Fees: $${monthTotals.late.toFixed(2)}`,
            // Collected = sum of positive payment amounts (cash) excluding credits and credit applications
            `Collected: $${(monthTotals.rent+monthTotals.deposit+monthTotals.fees+monthTotals.other).toFixed(2)}`
        ];
        if (overrideLate > 0) subtotalLines.push('Note: Monthly override late fee applied this month');
        const boxH = subtotalLines.length * 5 + 6;
        doc.setDrawColor(220,230,236); doc.setFillColor(245,249,252);
        doc.rect(14,y,pageW-28,boxH,'FD');
        let lineY = y + 6;
        subtotalLines.forEach(l=>{
            doc.text(l, 18, lineY);
            lineY += 5;
        });
        y += boxH + 8;
    }

    // Save file
    const filename = `tenant_payments_report_${tenant.name.replace(/\s+/g,'_')}.pdf`;
    doc.save(filename);
    showNotification('Monthly report exported', 'success');
}




function calculateOccupancyRate(units) {
    if (!units?.length) return '0%';
    const occupiedUnits = units.filter(u => u.status === 'occupied').length;
    return `${Math.round((occupiedUnits / units.length) * 100)}%`;
}

function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}



function showLoader() {
    const loader = document.getElementById('loader');
    if (loader) loader.style.display = 'flex';
}
function hideLoader() {
    const loader = document.getElementById('loader');
    if (loader) loader.style.display = 'none';
}

// This is a completely rewritten approach to modal handling
function openModal(modalId) {
    // First verify the modal exists
    const modal = document.getElementById(modalId);
    if (!modal) {
        console.error(`Modal with ID "${modalId}" not found`);
        return;
    }
    
    console.log(`Opening modal: ${modalId}`);
    
    // Close all modals first
    document.querySelectorAll('.modal').forEach(m => {
        m.style.display = 'none';
    });
    
    // Make modal visible using basic display property
    modal.style.display = 'block';
    
    // Add event listener for clicks outside the modal content
    modal.onclick = function(event) {
        if (event.target === modal) {
            closeModal(modalId);
        }
    };
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
    }
}


async function loadAllUnitsAndTenants() {
    if (!Array.isArray(state.properties) || !state.properties.length) {
        state.allUnits = [];
        state.allTenants = [];
        renderPropertyList();
        return;
    }

    const results = await Promise.all(
        state.properties.map(async (property) => {
            let units = [];
            let tenants = [];

            // Fetch units and tenants for this property in parallel
            const unitsPromise = (async () => {
                try {
                    const unitsRes = await fetch(`${API_URL}/properties/${property._id}/units`);
                    if (unitsRes.ok) {
                        const unitsData = await unitsRes.json();
                        if (unitsData.property && Array.isArray(unitsData.property.units)) {
                            units = unitsData.property.units.map(u => {
                                u.projectId = property._id;
                                return u;
                            });
                        }
                    }
                } catch (e) {
                    console.error(`Error loading units for property ${property._id}:`, e);
                }
            })();

            const tenantsPromise = (async () => {
                try {
                    const tenantsRes = await fetch(`${API_URL}/properties/${property._id}/tenants`);
                    if (tenantsRes.ok) {
                        const tenantsData = await tenantsRes.json();
                        if (Array.isArray(tenantsData)) {
                            tenants = tenantsData;
                        }
                    }
                } catch (e) {
                    console.error(`Error loading tenants for property ${property._id}:`, e);
                }
            })();

            await Promise.all([unitsPromise, tenantsPromise]);
            return { units, tenants };
        })
    );

    const allUnits = [];
    const allTenants = [];
    results.forEach(r => {
        if (r.units && r.units.length) allUnits.push(...r.units);
        if (r.tenants && r.tenants.length) allTenants.push(...r.tenants);
    });

    state.allUnits = allUnits;
    state.allTenants = allTenants;
    // Refresh property list so per-property stats (occupancy, vacancies) are shown once data is loaded
    renderPropertyList();
}

// Load all payments across all properties for portfolio-wide rent metrics
async function loadPortfolioPayments(force = false) {
    if (!force && Array.isArray(state.portfolioPayments) && state.portfolioPayments.length) {
        return state.portfolioPayments;
    }
    if (!Array.isArray(state.properties) || !state.properties.length) {
        state.portfolioPayments = [];
        return [];
    }

    const perPropertyArrays = await Promise.all(
        state.properties.map(async (property) => {
            try {
                const res = await fetch(`${API_URL}/properties/${property._id}/payments`);
                if (!res.ok) return [];
                const data = await res.json();
                return Array.isArray(data) ? data : [];
            } catch (e) {
                console.error(`Error loading payments for property ${property._id}:`, e);
                return [];
            }
        })
    );

    const all = perPropertyArrays.flat();
    state.portfolioPayments = all;
    return all;
}



function updatePropertyStats() {
    if (!state.currentProperty) return;

    // Only count tenants that are not terminated or expired
    const activeTenants = (state.tenants || []).filter(
        t => t.leaseStatus !== 'terminated' && t.leaseStatus !== 'expired'
    );

    const stats = {
        totalUnits: state.units.length,
        vacantUnits: state.units.filter(u => u.status === 'vacant').length,
        occupancyRate: calculateOccupancyRate(state.units)
    };

    document.getElementById('totalUnits').textContent = stats.totalUnits;
    document.getElementById('vacantUnits').textContent = stats.vacantUnits;
    document.getElementById('occupancyRate').textContent = stats.occupancyRate;

    // Estimated monthly income for this property (active tenants only)
    const propertyMonthlyIncome = activeTenants.reduce((sum, t) =>
        sum +
        (Number(t.baseRent) || 0) +
        (Number(t.waterFee) || 0) +
        (Number(t.trashFee) || 0) +
        (Number(t.adminFee) || 0) +
        (t.additionalFee?.amount || 0) +
        (t.pets?.hasPets ? (Number(t.pets.monthlyRent) || 0) : 0)
    , 0);
    const incomeElem = document.getElementById('propertyMonthlyIncome');
    if (incomeElem) {
        incomeElem.textContent = `$${propertyMonthlyIncome.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    }
}

// Compute and render portfolio-wide metrics into the overview strip
async function renderPortfolioOverview() {
    try {
        const section = document.getElementById('portfolioOverviewSection');
        if (!section) return;

        const elOpenRentAmount = document.getElementById('portfolioOpenRentAmount');
        const elOpenRentCount = document.getElementById('portfolioOpenRentCount');
        const elRentSummary = document.getElementById('portfolioRentCollectedSummary');
        const elRentBar = document.getElementById('portfolioRentCollectedBar');
        const elTotalRentSummary = document.getElementById('portfolioTotalRentSummary');
        const elTenantsCount = document.getElementById('portfolioTenantsCount');
        const elTenantsSummary = document.getElementById('portfolioTenantsSummary');
        const elOpenMaint = document.getElementById('portfolioOpenMaintenanceCount');
        const elMaintBreakdown = document.getElementById('portfolioMaintenanceBreakdown');
        const elApplicationsCount = document.getElementById('portfolioApplicationsCount');
        const elApplicationsSummary = document.getElementById('portfolioApplicationsSummary');
        const elExpiringLeases = document.getElementById('portfolioExpiringLeasesCount');
        const elExpiringLeasesBreakdown = document.getElementById('portfolioExpiringLeasesBreakdown');
        const elVacantUnits = document.getElementById('portfolioVacantUnitsCount');
        const elVacancySummary = document.getElementById('portfolioVacancySummary');
        const elOccupancyBar = document.getElementById('portfolioOccupancyBar');
        if (!elOpenRentAmount || !elOpenRentCount || !elOpenMaint || !elExpiringLeases || !elVacantUnits) return;

        // Start loading portfolio-wide payments and maintenance in parallel with any
        // remaining unit/tenant loading work to reduce time-to-first overview paint.
        const paymentsPromise = loadPortfolioPayments().catch((e) => {
            console.error('Error loading portfolio payments:', e);
            return [];
        });

        const maintenancePromise = (async () => {
            let openMaintCount = 0;
            let maintPending = 0;
            let maintInProgress = 0;
            try {
                // Include completed requests in the portfolio maintenance dataset so
                // the status filter can show and switch to them, but only count
                // pending + in-progress toward the "Open Maintenance" chip.
                const res = await fetch('/api/properties/maintenance?status=pending,in-progress,completed&_=' + Date.now());
                if (res.ok) {
                    const items = await res.json();
                    if (Array.isArray(items)) {
                        state.portfolioMaintenance = items;
                        items.forEach(m => {
                            if (m.status === 'pending') {
                                maintPending++;
                                openMaintCount++;
                            } else if (m.status === 'in-progress') {
                                maintInProgress++;
                                openMaintCount++;
                            }
                        });
                    }
                }
            } catch (e) {
                console.error('Error loading portfolio maintenance overview:', e);
            }
            return { openMaintCount, maintPending, maintInProgress };
        })();

        // Ensure portfolio units/tenants are loaded
        if (!Array.isArray(state.allUnits) || !state.allUnits.length || !Array.isArray(state.allTenants) || !state.allTenants.length) {
            try {
                await loadAllUnitsAndTenants();
            } catch (e) {
                console.warn('Error loading units/tenants for portfolio overview:', e);
            }
        }

        const allUnits = state.allUnits || [];
        const allTenants = state.allTenants || [];
        const allApplications = state.applications || [];
        const allInvites = state.invites || [];
        state.portfolioTenantsWithBalance = [];
        state.portfolioExpiringLeases = [];
        state.portfolioUpcomingMoveIns = [];
        state.portfolioVacantUnits = [];
        state.portfolioOccupiedUnits = [];
        const activeTenants = allTenants.filter(t => t.leaseStatus !== 'terminated' && t.leaseStatus !== 'expired');

        const pendingApplications = allApplications.filter(a => (a.status || 'pending') === 'pending');
        const recentInvites = allInvites.slice(0, 50);

        const now = new Date();
        // Determine which month to use for rent metrics (default = current month)
        let periodYear = now.getFullYear();
        let periodMonthIndex = now.getMonth(); // 0-based
        if (state.portfolioRentMonth) {
            const parts = String(state.portfolioRentMonth).split('-');
            if (parts.length === 2) {
                const py = Number(parts[0]);
                const pm = Number(parts[1]);
                if (!isNaN(py) && !isNaN(pm) && pm >= 1 && pm <= 12) {
                    periodYear = py;
                    periodMonthIndex = pm - 1;
                }
            }
        }
        const periodMonth = `${periodYear}-${String(periodMonthIndex + 1).padStart(2, '0')}`;
        const periodDate = new Date(periodYear, periodMonthIndex, 15);

        // Update Applications & Invites chip if present
        if (elApplicationsCount && elApplicationsSummary) {
            const appsCount = pendingApplications.length;
            const invitesCount = recentInvites.length;
            elApplicationsCount.textContent = String(appsCount);
            const parts = [];
            parts.push(`${appsCount} pending application${appsCount === 1 ? '' : 's'}`);
            if (invitesCount) {
                parts.push(`${invitesCount} invite${invitesCount === 1 ? '' : 's'}`);
            }
            elApplicationsSummary.textContent = parts.join('  ') || 'Applications & invites overview';
        }

        // Load portfolio-wide payments for current month rent comparisons
        const allPayments = await paymentsPromise;

        let totalUnpaidRent = 0;
        let totalExpectedRent = 0;
        let portfolioMonthlyIncome = 0; // contract monthly income (base rent + recurring fees, no proration)
        let totalPaidThisMonthAll = 0;
        let tenantsWithBalance = 0;
        let expiringLeasesCount = 0;
        let expiringWithin30 = 0;
        let upcomingMoveInsCount = 0;
        let upcomingMoveInsWithin30 = 0;

        activeTenants.forEach(tenant => {
            // Lease expiry within 60 days (always relative to "now", not the selected rent month)
            if (tenant.leaseEnd) {
                const leaseEndDate = new Date(tenant.leaseEnd);
                const diffMs = leaseEndDate - now;
                const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                if (diffDays <= 60 && diffDays > 0 && (tenant.leaseStatus === 'active' || tenant.leaseStatus === 'pending')) {
                    expiringLeasesCount++;
                    if (diffDays <= 30) {
                        expiringWithin30++;
                    }
                    state.portfolioExpiringLeases.push({ tenant, daysUntilEnd: diffDays });
                }
            }

            // Expected rent vs payments for the selected month
            const petFees = (tenant.pets?.hasPets ? (Number(tenant.pets.monthlyRent) || 0) : 0);
            const additionalFees =
                (Number(tenant.waterFee) || 0) +
                (Number(tenant.trashFee) || 0) +
                (Number(tenant.adminFee) || 0) +
                (tenant.additionalFee?.amount || 0) +
                petFees;

            // Determine if the selected month falls completely outside this tenant's lease range
            const leaseStart = tenant.leaseStart ? new Date(tenant.leaseStart) : null;
            const leaseEnd = tenant.leaseEnd ? new Date(tenant.leaseEnd) : null;
            let outOfLeaseMonth = false;
            if (leaseStart || leaseEnd) {
                const monthStart = new Date(periodYear, periodMonthIndex, 1);
                const monthEnd = new Date(periodYear, periodMonthIndex + 1, 0);
                if (leaseStart && monthEnd < leaseStart) {
                    outOfLeaseMonth = true;
                }
                if (leaseEnd && monthStart > leaseEnd) {
                    outOfLeaseMonth = true;
                }
            }

            // For "Estimated monthly income", only count tenants whose lease covers the selected month
            // (no proration/overrides applied in this high-level metric)
            const contractualMonthly = (Number(tenant.baseRent) || 0) + additionalFees;
            if (!outOfLeaseMonth) {
                portfolioMonthlyIncome += contractualMonthly;
            }

            let expectedMonthly = 0;
            let monthOverride = null;
            if (!outOfLeaseMonth) {
                // For in-range months, still respect proration and overrides
                const expectedBase = computeExpectedBaseRentForMonth(tenant, periodDate);
                const overrideMap = tenant?.monthlyOverrides || null;
                monthOverride = overrideMap
                    ? (typeof overrideMap.get === 'function' ? overrideMap.get(periodMonth) : overrideMap[periodMonth])
                    : null;

                expectedMonthly = expectedBase + additionalFees;
                if (monthOverride) {
                    const ovExpected = Number(monthOverride.expectedRent);
                    const ovLate = Number(monthOverride.lateFee);
                    const ovMode = (monthOverride.lateFeeMode === 'percent') ? 'percent' : 'amount';
                    const baseBeforeLate = Number.isFinite(ovExpected) ? ovExpected : (expectedBase + additionalFees);
                    if (ovMode === 'percent' && Number.isFinite(ovLate)) {
                        expectedMonthly = baseBeforeLate + (baseBeforeLate * (ovLate / 100));
                    } else {
                        expectedMonthly = baseBeforeLate + (Number.isFinite(ovLate) ? ovLate : 0);
                    }
                }
            }

            const monthPayments = allPayments.filter(p => {
                if (!p.date || p.applyTo !== 'rent') return false;
                if (String(p.tenantId) !== String(tenant._id)) return false;
                const d = new Date(p.date);
                return d.getMonth() === periodMonthIndex && d.getFullYear() === periodYear;
            });

            const totalPaidThisMonth = monthPayments.reduce((sum, p) => {
                const amt = Number(p.amount) || 0;
                return sum + (amt > 0 ? amt : 0);
            }, 0);

            const remainingRent = Math.max(0, expectedMonthly - totalPaidThisMonth);
            totalExpectedRent += expectedMonthly;
            totalPaidThisMonthAll += totalPaidThisMonth;
            // Always store a row so the rent details view can show all tenants
            state.portfolioTenantsWithBalance.push({ tenant, remainingRent, expectedMonthly, paidThisMonth: totalPaidThisMonth, outOfLease: outOfLeaseMonth });
            // But only count those with a positive remaining balance toward the "open rent" chip
            if (!outOfLeaseMonth && remainingRent > 0.01) {
                tenantsWithBalance++;
                totalUnpaidRent += remainingRent;
            }
        });

        // Upcoming / recent move-ins based on actual tenant lease start dates
        // (rather than applications). Track move-ins up to 60 days out and
        // up to 60 days after the lease start date.
        const msPerDay = 1000 * 60 * 60 * 24;
        activeTenants.forEach(tenant => {
            if (!tenant.leaseStart) return;
            const moveInDate = new Date(tenant.leaseStart);
            if (isNaN(moveInDate.getTime())) return;
            const diffMs = moveInDate - now;
            const diffDays = Math.ceil(diffMs / msPerDay);
            // Include move-ins up to 60 days out, plus the move-in day (0)
            // and up to 60 days after move-in (negative diffDays).
            if (diffDays <= 60 && diffDays >= -60) {
                upcomingMoveInsCount++;
                if (diffDays <= 30) {
                    upcomingMoveInsWithin30++;
                }
                const displayDays = diffDays < 0 ? 0 : diffDays;
                state.portfolioUpcomingMoveIns.push({
                    tenant,
                    daysUntilMoveIn: displayDays,
                    rawDaysUntilMoveIn: diffDays
                });
            }
        });

        const vacantUnitsList = allUnits.filter(u => u.status === 'vacant');
        const occupiedUnitsList = allUnits.filter(u => u.status === 'occupied' || u.status === 'leased' || u.status === 'rented');
        const vacantUnits = vacantUnitsList.length;
        const totalUnits = allUnits.length || 0;
        state.portfolioVacantUnits = vacantUnitsList;
        state.portfolioOccupiedUnits = occupiedUnitsList;

        const { openMaintCount, maintPending, maintInProgress } = await maintenancePromise;

        const rentText = `$${totalUnpaidRent.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        const rentSub = tenantsWithBalance ? `${tenantsWithBalance} tenant${tenantsWithBalance !== 1 ? 's' : ''} with balance` : 'All current month rent paid';

        elOpenRentAmount.textContent = rentText;
        elOpenRentCount.textContent = rentSub;
        if (elTotalRentSummary) {
            const totalExpectedText = `$${portfolioMonthlyIncome.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            elTotalRentSummary.textContent = `Estimated monthly income: ${totalExpectedText}`;
        }

        // Tenants chip: show active vs total tenants across the portfolio
        if (elTenantsCount && elTenantsSummary) {
            const totalTenantsCount = allTenants.length;
            const activeTenantsCount = activeTenants.length;
            const inactiveTenantsCount = Math.max(0, totalTenantsCount - activeTenantsCount);
            elTenantsCount.textContent = activeTenantsCount;
            if (!totalTenantsCount) {
                elTenantsSummary.textContent = 'No tenants yet across the portfolio';
            } else {
                elTenantsSummary.textContent = `${activeTenantsCount} active  ${inactiveTenantsCount} inactive (of ${totalTenantsCount} total)`;
            }
        }
        elOpenMaint.textContent = openMaintCount;
        const totalLeaseAndMoveEvents = expiringLeasesCount + upcomingMoveInsCount;
        elExpiringLeases.textContent = totalLeaseAndMoveEvents;
        elVacantUnits.textContent = vacantUnits;

        // Rent collection progress
        if (elRentSummary && elRentBar) {
            const collectedPercent = totalExpectedRent > 0
                ? Math.max(0, Math.min(100, Math.round((totalPaidThisMonthAll / totalExpectedRent) * 100)))
                : 100;
            elRentSummary.textContent = `Collected ${collectedPercent}% of expected rent`;
            elRentBar.style.width = collectedPercent + '%';
        }

        // Maintenance breakdown badges
        if (elMaintBreakdown) {
            elMaintBreakdown.innerHTML = '';
            if (openMaintCount === 0) {
                const badge = document.createElement('span');
                badge.className = 'portfolio-badge';
                badge.textContent = 'No open requests';
                elMaintBreakdown.appendChild(badge);
            } else {
                if (maintPending > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'portfolio-badge warn';
                    badge.textContent = `${maintPending} pending`;
                    elMaintBreakdown.appendChild(badge);
                }
                if (maintInProgress > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'portfolio-badge';
                    badge.textContent = `${maintInProgress} in-progress`;
                    elMaintBreakdown.appendChild(badge);
                }
            }
        }

        // Lease expiry breakdown
        if (elExpiringLeasesBreakdown) {
            if (totalLeaseAndMoveEvents === 0) {
                elExpiringLeasesBreakdown.textContent = 'No expiring leases or upcoming move-ins in the next 60 days';
            } else {
                const within30Total = expiringWithin30 + upcomingMoveInsWithin30;
                const in31To60Total = (expiringLeasesCount - expiringWithin30) + (upcomingMoveInsCount - upcomingMoveInsWithin30);
                elExpiringLeasesBreakdown.textContent = `${within30Total} within 30 days, ${in31To60Total} in 31-60 days`;
            }
        }

        // Occupancy progress
        if (elVacancySummary && elOccupancyBar) {
            if (totalUnits === 0) {
                elVacancySummary.textContent = 'No units configured yet';
                elOccupancyBar.style.width = '0%';
            } else {
                const occupiedUnits = Math.max(0, totalUnits - vacantUnits);
                const occupancyPercent = Math.round((occupiedUnits / totalUnits) * 100);
                elVacancySummary.textContent = `${occupancyPercent}% occupied, ${vacantUnits} vacant of ${totalUnits} units`;
                elOccupancyBar.style.width = occupancyPercent + '%';
            }
        }
    } catch (e) {
        console.warn('Error rendering portfolio overview:', e);
    }
}

async function loadPortfolioTasks(force = false) {
    if (!force && Array.isArray(state.portfolioTasks) && state.portfolioTasks.length) {
        return state.portfolioTasks;
    }
    try {
        const res = await fetch(`${API_URL}/portfolio-tasks`);
        if (!res.ok) throw new Error('Failed to load portfolio tasks');
        const data = await res.json();
        state.portfolioTasks = Array.isArray(data.tasks) ? data.tasks : [];
    } catch (e) {
        console.error('Error loading portfolio tasks:', e);
        state.portfolioTasks = [];
    }
    renderPortfolioTasksList();
    return state.portfolioTasks;
}

function renderPortfolioTasksList() {
    const listEl = document.getElementById('portfolioTasksList');
    if (!listEl) return;
    const tasks = state.portfolioTasks || [];
    if (!tasks.length) {
        listEl.innerHTML = '<p style="font-size:0.8rem;color:#9ca3af;margin:4px 2px;">No tasks yet. Add one above.</p>';
        return;
    }
    listEl.innerHTML = tasks.map(t => {
        const completed = t.status === 'completed';
        const due = t.dueDate ? new Date(t.dueDate).toLocaleDateString() : '';
        const statusLabel = t.status ? t.status.replace(/-/g,' ') : '';
        return `
            <div class="portfolio-task-item" data-id="${t._id}">
                <div class="portfolio-task-actions">
                    <input type="checkbox" class="portfolio-task-toggle" ${completed ? 'checked' : ''} />
                </div>
                <div class="portfolio-task-main">
                    <div class="portfolio-task-title" style="${completed ? 'text-decoration:line-through;color:#9ca3af;' : ''}">${(t.title || '').replace(/</g,'&lt;')}</div>
                    <div class="portfolio-task-meta">
                        ${due ? `<span><i class="far fa-calendar-alt"></i> ${due}</span>` : ''}
                        ${statusLabel && !completed ? `<span style="margin-left:4px;"> ${statusLabel}</span>` : ''}
                    </div>
                </div>
                <div class="portfolio-task-actions">
                    <button type="button" class="portfolio-task-delete" title="Delete task">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>`;
    }).join('');
}
document.addEventListener('DOMContentLoaded', () => {
    const sidebar = document.querySelector('.sidebar');
    const toggleBtn = document.getElementById('sidebarToggleBtn');
    const overlay = document.getElementById('sidebarOverlay');

    // Hide sidebar by default on mobile
    function setSidebarInitial() {
        if (window.innerWidth <= 900) {
            sidebar.classList.remove('visible');
        } else {
            sidebar.classList.add('visible');
        }
    }
    setSidebarInitial();

    toggleBtn.addEventListener('click', () => {
        // Toggle sidebar open/close for mobile
        if (window.innerWidth <= 900) {
            sidebar.classList.toggle('visible');
        } else {
            sidebar.classList.add('visible');
        }
    });

    overlay.addEventListener('click', () => {
        sidebar.classList.remove('visible');
    });

        // Touch support for maintenance-card hover effect on iOS/mobile
    document.querySelectorAll('.maintenance-card').forEach(card => {
        card.addEventListener('touchstart', function() {
            this.classList.add('active');
        });
        card.addEventListener('touchend', function() {
            this.classList.remove('active');
        });
        card.addEventListener('touchcancel', function() {
            this.classList.remove('active');
        });
    });


    // Hide sidebar on resize if needed
    window.addEventListener('resize', () => {
        setSidebarInitial();
    });
});

function renderPortfolioDetails(type) {
    const body = document.getElementById('portfolioDetailsBody');
    const titleEl = document.getElementById('portfolioDetailsTitle');
    if (!body || !titleEl) return;

    // Track which portfolio details view is currently active so month changes can refresh it
    state.currentPortfolioDetailsType = type;

    const propsById = (state.properties || []).reduce((map, p) => {
        map[String(p._id)] = p;
        return map;
    }, {});

    const unitsById = (state.allUnits || []).reduce((map, u) => {
        if (u && u._id) {
            map[String(u._id)] = u;
        }
        return map;
    }, {});

    if (type === 'applications') {
        titleEl.textContent = 'Applications & Invites (Portfolio)';
        const allApps = state.applications || [];
        const allInvites = state.invites || [];
        if (!allApps.length && !allInvites.length) {
            body.innerHTML = '<p style="font-size:0.86rem;color:#6b7280;">No applications or invites found.</p>';
            return;
        }

        const combined = [];
        allApps.forEach(a => {
            // Try to derive property/unit from notes JSON when available
            let propertyAddress = '';
            let unitNumber = a.unit || '';
            if (a.notes) {
                try {
                    const n = JSON.parse(a.notes);
                    propertyAddress = n.propertyAddress || propertyAddress;
                    unitNumber = n.unitNumber || unitNumber;
                } catch {}
            }
            const notesCount = Array.isArray(a.notesHistory) ? a.notesHistory.length : 0;
            combined.push({
                kind: 'Application',
                source: 'application',
                id: a._id,
                name: a.name || '',
                email: a.email || '',
                property: propertyAddress,
                unit: unitNumber,
                status: a.status || 'pending',
                date: a.submitted ? new Date(a.submitted) : null,
                notesCount
            });
        });
        allInvites.forEach(inv => {
            const notesCount = Array.isArray(inv.notesHistory) ? inv.notesHistory.length : 0;
            const openCount = typeof inv.openCount === 'number' ? inv.openCount : 0;
            const lastOpened = inv.openedAt ? new Date(inv.openedAt) : null;
            combined.push({
                kind: 'Invite',
                source: 'invite',
                id: inv._id,
                name: inv.name || '',
                email: inv.email || '',
                property: inv.propertyName || '',
                unit: inv.unitNumber || '',
                status: inv.status || 'sent',
                date: inv.sentAt ? new Date(inv.sentAt) : null,
                notesCount,
                openCount,
                lastOpened,
                applicationUrl: inv.applicationUrl || ''
            });
        });

        combined.sort((a, b) => {
            const da = a.date ? a.date.getTime() : 0;
            const db = b.date ? b.date.getTime() : 0;
            return db - da;
        });

        const rowsHtml = combined.map(item => {
            const dateStr = item.date ? item.date.toLocaleString('en-US') : '';
            const lastOpenedStr = item.lastOpened ? item.lastOpened.toLocaleString('en-US') : '';
            const dataName = (item.name || '').toLowerCase().replace(/"/g,'&quot;');
            const dataEmail = (item.email || '').toLowerCase().replace(/"/g,'&quot;');
            const dataProp = (item.property || '').toLowerCase().replace(/"/g,'&quot;');
            const dataUnit = String(item.unit || '').toLowerCase().replace(/"/g,'&quot;');
            const dataStatus = (item.status || '').toLowerCase().replace(/"/g,'&quot;');
            const dataType = item.kind.toLowerCase();
            const notesBadge = `<button class="portfolio-notes-link" data-notes-source="${item.source}" data-notes-id="${item.id || ''}" style="background:none;border:none;padding:0;margin:0;font:inherit;cursor:pointer;">
                    <span style="display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#4f46e5;font-size:0.8rem;">
                        <i class="fas fa-sticky-note"></i>
                        ${item.notesCount || 0}
                    </span>
                </button>`;
            const typeCell = item.source === 'application'
                ? `<a href="/applications/review/${item.id}" target="_blank" rel="noopener" style="color:#2563eb;text-decoration:underline;cursor:pointer;">${item.kind}</a>`
                : item.kind;
            const safeLink = (item.applicationUrl || '').replace(/"/g,'&quot;');
            const copyBtn = (item.source === 'invite' && safeLink)
                ? `<button type="button" class="icon-copy-btn portfolio-invite-copy-link" data-link="${safeLink}" title="Copy invite URL"><i class="fas fa-copy"></i></button>`
                : '';
            const dateCell = item.source === 'invite'
                ? `<div style="display:flex;flex-wrap:wrap;align-items:center;gap:4px;"><span>${dateStr}</span>${lastOpenedStr ? `<span style="display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;background:#ecfdf3;color:#16a34a;font-size:0.75rem;">Opens: ${typeof item.openCount === 'number' ? item.openCount : 0}  Last opened: ${lastOpenedStr}</span>` : `<span style="display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;background:#ecfdf3;color:#16a34a;font-size:0.75rem;">Opens: ${typeof item.openCount === 'number' ? item.openCount : 0}</span>`}${copyBtn}</div>`
                : dateStr;
            return `
                <tr data-name="${dataName}" data-email="${dataEmail}" data-property="${dataProp}" data-unit="${dataUnit}" data-status="${dataStatus}" data-type="${dataType}" ${item.source === 'application' ? `data-app-id="${item.id || ''}"` : ''}${item.source === 'invite' ? ` data-invite-id="${item.id || ''}"` : ''}>
                    <td>${typeCell}</td>
                    <td>${item.name || ''}</td>
                    <td>${item.email || ''}</td>
                    <td>${item.property || ''}</td>
                    <td>${item.unit || ''}</td>
                    <td>${item.status}</td>
                    <td>${dateCell}</td>
                    <td>${notesBadge}</td>
                </tr>`;
        }).join('');

        body.innerHTML = `
            <div id="portfolioDetailsFilterBar" style="margin-bottom:8px;border-radius:12px;padding:0;display:flex;flex-wrap:wrap;gap:0;align-items:flex-start;position:relative;">
                <div style="position:relative;flex:1 1 100%;min-width:240px;display:flex;align-items:center;gap:6px;justify-content:flex-start;">
                    <i class="fas fa-magnifying-glass" style="color:#6b7280;margin-left:4px;"></i>
                    <input id="portfolioDetailsSearchBar" type="text" placeholder="Search list by" title="Try: name:, email:, property:, unit:, status:, type:" style="flex:0 1 320px;max-width:280px;border:1px solid #e5e7eb;border-radius:10px;padding:6px 9px;background:#fff;font-size:0.9rem;" />
                    <button class="btn-secondary" id="clearPortfolioDetailsFiltersBtn" title="Clear search" style="margin-right:4px;padding:5px 9px;font-size:0.85rem;">Clear</button>
                </div>
                <div id="portfolioDetailsActiveFilterChips" style="display:flex;flex-wrap:wrap;gap:6px;margin:6px 8px 0 26px;flex:1 1 100%;"></div>
                <div id="portfolioDetailsSearchSuggestions" style="position:absolute;top:40px;left:6px;right:auto;min-width:240px;max-width:520px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 12px 32px rgba(0,0,0,0.15);padding:4px 0;display:none;z-index:1000;max-height:260px;overflow:auto;">
                    <div id="portfolioDetailsSuggestHeader" style="padding:8px 12px;font-size:.85em;color:#374151;border-bottom:1px solid #eef2f7;display:flex;justify-content:space-between;align-items:center;">
                        <span id="portfolioDetailsSuggestTitle">Choose a filter</span>
                        <button id="portfolioDetailsSuggestBack" style="display:none;background:transparent;border:none;color:#217dbb;cursor:pointer;font-weight:600;">Back</button>
                    </div>
                    <ul id="portfolioDetailsSuggestList" style="list-style:none;margin:0;padding:4px 0;"></ul>
                    <ul id="portfolioDetailsSuggestValues" style="list-style:none;margin:0;padding:4px 0;display:none;"></ul>
                    <div style="border-top:1px solid #eef2f7;margin-top:4px;padding:6px 10px;font-size:.8em;color:#6b7280;">Use tokens like <strong>name:</strong> or <strong>status:</strong> for precise filters.</div>
                </div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;gap:8px;flex-wrap:wrap;">
                <div style="font-size:0.9rem;color:#6b7280;">Applications & invites across all properties.</div>
                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                    <div id="portfolioAppsTypeTags" style="display:inline-flex;gap:6px;flex-wrap:wrap;">
                        <button type="button" class="portfolio-apps-tag-btn" data-type="application">Applications</button>
                        <button type="button" class="portfolio-apps-tag-btn" data-type="invite">Invites</button>
                    </div>
                    <button class="btn-secondary" id="portfolioSendApplicationBtn" type="button">Send Application</button>
                </div>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Property</th>
                            <th>Unit</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="portfolioDetailsTbody">
                        ${rowsHtml}
                    </tbody>
                </table>
            </div>`;

        // By default, start this view filtered to Applications.
        // When an inline portfolio invite edit sets
        // state.keepPortfolioTypeFilterOnNextRender, preserve whatever
        // type filter (Applications or Invites) was active.
        if (!state.keepPortfolioTypeFilterOnNextRender) {
            window.__portfolioDetailsAccumulatedQuery = 'type:application';
        } else {
            state.keepPortfolioTypeFilterOnNextRender = false;
        }
        initializePortfolioDetailsSearch();
        renderFilteredPortfolioDetailsRows();

        // Wire Applications/Invites type tags inside the portfolio view
        (function setupPortfolioAppsTypeTags() {
            const container = document.getElementById('portfolioAppsTypeTags');
            if (!container) return;
            const buttons = Array.from(container.querySelectorAll('.portfolio-apps-tag-btn'));
            if (!buttons.length) return;
            const getCurrentTypeFromQuery = () => {
                const combined = `${(window.__portfolioDetailsAccumulatedQuery || '').trim()}`.trim();
                if (!combined) return 'application';
                const { tokens } = parsePortfolioDetailsSearch(combined);
                if (tokens.typeList && tokens.typeList.length) {
                    return tokens.typeList[0];
                }
                return 'application';
            };
            const syncActiveFromFilter = () => {
                const currentType = getCurrentTypeFromQuery();
                buttons.forEach(b => {
                    const t = b.getAttribute('data-type') || '';
                    b.classList.toggle('portfolio-apps-tag-active', t === currentType);
                });
            };
            const applyTypeFilter = (selectedType) => {
                const input = document.getElementById('portfolioDetailsSearchBar');
                const combined = `${(window.__portfolioDetailsAccumulatedQuery || '').trim()} ${(input?.value || '').trim()}`.trim();
                const { tokens } = parsePortfolioDetailsSearch(combined);
                // Replace type filter with the selected one
                tokens.typeList = selectedType ? [selectedType] : [];
                const parts = [];
                if (tokens.nameList.length) parts.push(`name:${tokens.nameList.join(',')}`);
                if (tokens.propertyList.length) parts.push(`property:${tokens.propertyList.join(',')}`);
                if (tokens.unitList.length) parts.push(`unit:${tokens.unitList.join(',')}`);
                if (tokens.statusList.length) parts.push(`status:${tokens.statusList.join(',')}`);
                if (tokens.typeList.length) parts.push(`type:${tokens.typeList.join(',')}`);
                if (tokens.balanceFlags && tokens.balanceFlags.length) parts.push(`balance:${tokens.balanceFlags.join(',')}`);
                window.__portfolioDetailsAccumulatedQuery = parts.join(' ');
                if (input) input.value = '';
                renderFilteredPortfolioDetailsRows();
            };
            // Set initial active tag based on current type filter
            syncActiveFromFilter();
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const selected = btn.getAttribute('data-type') || '';
                    buttons.forEach(b => {
                        const isActive = b === btn;
                        b.classList.toggle('portfolio-apps-tag-active', isActive);
                    });
                    applyTypeFilter(selected);
                });
            });
        })();

        // Wire notes badge clicks and inline edit for applications in portfolio view
        const detailsTbody = document.getElementById('portfolioDetailsTbody');
        if (detailsTbody) {
            detailsTbody.querySelectorAll('.portfolio-notes-link').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const src = btn.getAttribute('data-notes-source');
                    const id = btn.getAttribute('data-notes-id');
                    if (!id || !src) return;
                    if (src === 'application') {
                        openNotesDrawerForApplication(id);
                    } else if (src === 'invite') {
                        openNotesDrawerForInvite(id);
                    }
                });
            });

            detailsTbody.querySelectorAll('tr[data-app-id]').forEach(row => {
                row.addEventListener('click', (e) => {
                    const target = e.target;
                    if (target.closest('.portfolio-notes-link') || target.closest('button') || target.closest('input') || target.closest('select') || target.closest('a')) {
                        return;
                    }
                    if (row.dataset.editing === 'true') return;
                    const id = row.getAttribute('data-app-id');
                    if (!id) return;
                    const app = (state.applications || []).find(a => String(a._id) === String(id));
                    if (!app) return;
                    enterPortfolioApplicationEditMode(row, app);
                });
            });

            detailsTbody.querySelectorAll('tr[data-invite-id]').forEach(row => {
                row.addEventListener('click', (e) => {
                    const target = e.target;
                    if (target.closest('.portfolio-notes-link') || target.closest('button') || target.closest('input') || target.closest('select') || target.closest('a')) {
                        return;
                    }
                    if (row.dataset.editing === 'true') return;
                    const id = row.getAttribute('data-invite-id');
                    if (!id) return;
                    const invite = (state.invites || []).find(x => String(x._id) === String(id));
                    if (!invite) return;
                    enterPortfolioInviteEditMode(row, invite);
                });
            });

            // Wire copy buttons for invite rows in Applications & Invites (Portfolio)
            detailsTbody.querySelectorAll('.portfolio-invite-copy-link').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const url = btn.getAttribute('data-link');
                    if (!url) return;
                    try {
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            await navigator.clipboard.writeText(url);
                        } else {
                            const tempInput = document.createElement('input');
                            tempInput.value = url;
                            document.body.appendChild(tempInput);
                            tempInput.select();
                            document.execCommand('copy');
                            document.body.removeChild(tempInput);
                        }
                        if (typeof showNotification === 'function') {
                            showNotification('Invite link copied', 'success');
                        }
                    } catch (err) {
                        console.error('Copy portfolio invite link failed', err);
                        if (typeof showNotification === 'function') {
                            showNotification('Could not copy link', 'error');
                        }
                    }
                });
            });
        }

        // Reuse the existing "Send Application" modal/flow from the main Applications tab
        const portfolioSendBtn = document.getElementById('portfolioSendApplicationBtn');
        const mainSendBtn = document.getElementById('sendApplicationBtn');
        if (portfolioSendBtn && mainSendBtn) {
            portfolioSendBtn.addEventListener('click', (e) => {
                e.preventDefault();
                mainSendBtn.click();
            });
        }
        return;
    }

    if (type === 'tenants') {
        titleEl.textContent = 'All Tenants (Portfolio)';
        const tenants = state.allTenants || [];
        if (!tenants.length) {
            body.innerHTML = '<p style="font-size:0.86rem;color:#6b7280;">No tenants found across the portfolio.</p>';
            return;
        }

        const rowsHtml = tenants.map(t => {
            const name = t.fullName || t.name || `${t.firstName || ''} ${t.lastName || ''}`.trim() || 'Tenant';
            const unitId = t.unitId?._id || t.unitId;
            let unitLabel = '';
            if (unitId && unitsById[String(unitId)]) {
                const u = unitsById[String(unitId)];
                unitLabel = u.number || u.unitNumber || u.name || u.label || '';
            } else {
                unitLabel = t.unitNumber || t.unit || '';
            }
            const pid = t.projectId || t.propertyId;
            const propName = pid && propsById[String(pid)] ? propsById[String(pid)].name : '';
            const phone = t.phone || t.tenantPhone || '';
            const email = t.email || t.tenantEmail || '';
            const leaseStart = t.leaseStart ? new Date(t.leaseStart).toLocaleDateString() : '';
            const leaseEnd = t.leaseEnd ? new Date(t.leaseEnd).toLocaleDateString() : '';
            const status = t.leaseStatus || 'unknown';
            const notesCount = Array.isArray(t.notesHistory) ? t.notesHistory.length : 0;
            return `
                <tr>
                    <td>${propName}</td>
                    <td>${unitLabel}</td>
                    <td>${name}</td>
                    <td>${phone}</td>
                    <td>${email}</td>
                    <td>${leaseStart} - ${leaseEnd}</td>
                    <td>${status}</td>
                </tr>`;
        }).join('');

        body.innerHTML = `
            <div id="portfolioTenantsFilterBar" style="margin-bottom:8px;border-radius:12px;padding:0;display:flex;flex-wrap:wrap;gap:0;align-items:flex-start;position:relative;">
                <div style="position:relative;flex:1 1 100%;min-width:240px;display:flex;align-items:center;gap:6px;justify-content:flex-start;">
                    <i class="fas fa-magnifying-glass" style="color:#6b7280;margin-left:4px;"></i>
                    <input id="portfolioTenantsSearchBar" type="text" placeholder="Search tenants by" title="Try: name:, email:, phone:, property:, unit:, status:" style="flex:0 1 320px;max-width:280px;border:1px solid #e5e7eb;border-radius:10px;padding:6px 9px;background:#fff;font-size:0.9rem;" />
                    <button class="btn-secondary" id="clearPortfolioTenantsFiltersBtn" title="Clear search" style="margin-right:4px;padding:5px 9px;font-size:0.85rem;">Clear</button>
                </div>
                <div id="portfolioTenantsActiveFilterChips" style="display:flex;flex-wrap:wrap;gap:6px;margin:6px 8px 0 26px;flex:1 1 100%;"></div>
                <div id="portfolioTenantsSearchSuggestions" style="position:absolute;top:40px;left:6px;right:auto;min-width:240px;max-width:520px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 12px 32px rgba(0,0,0,0.15);padding:4px 0;display:none;z-index:1000;max-height:260px;overflow:auto;">
                    <div id="portfolioTenantsSuggestHeader" style="padding:8px 12px;font-size:.85em;color:#374151;border-bottom:1px solid #eef2f7;display:flex;justify-content:space-between;align-items:center;">
                        <span id="portfolioTenantsSuggestTitle">Choose a filter</span>
                        <button id="portfolioTenantsSuggestBack" style="display:none;background:transparent;border:none;color:#217dbb;cursor:pointer;font-weight:600;">Back</button>
                    </div>
                    <ul id="portfolioTenantsSuggestList" style="list-style:none;margin:0;padding:4px 0;"></ul>
                    <ul id="portfolioTenantsSuggestValues" style="list-style:none;margin:0;padding:4px 0;display:none;"></ul>
                    <div style="border-top:1px solid #eef2f7;margin-top:4px;padding:6px 10px;font-size:.8em;color:#6b7280;">Use tokens like <strong>name:</strong> or <strong>status:</strong> for precise filters.</div>
                </div>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Property</th>
                            <th>Unit</th>
                            <th>Tenant</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Lease Dates</th>
                            <th>Status</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="portfolioTenantsTbody">
                        ${rowsHtml}
                    </tbody>
                </table>
            </div>`;

        // Initialize smart search for portfolio tenants with default status:active filter
        initializePortfolioTenantsSearch();
        window.__portfolioTenantsAccumulatedQuery = 'status:active';
        renderFilteredPortfolioTenants();
        return;
    }

    if (type === 'rent') {
        titleEl.textContent = 'Tenants with Outstanding Balance';
        const rows = state.portfolioTenantsWithBalance || [];
        if (!rows.length) {
            body.innerHTML = '<p style="font-size:0.86rem;color:#6b7280;">No tenants with outstanding balance for this month.</p>';
            return;
        }
        const htmlRows = rows.map(({ tenant, remainingRent, expectedMonthly, paidThisMonth, outOfLease }) => {
            const name = tenant.fullName || tenant.name || `${tenant.firstName || ''} ${tenant.lastName || ''}`.trim() || 'Tenant';
            const unitId = tenant.unitId?._id || tenant.unitId;
            let unitLabel = '';
            if (unitId && unitsById[String(unitId)]) {
                const u = unitsById[String(unitId)];
                unitLabel = u.number || u.unitNumber || u.name || u.label || '';
            } else {
                unitLabel = tenant.unitNumber || tenant.unit || '';
            }
            const pid = tenant.projectId || tenant.propertyId;
            const propName = pid && propsById[String(pid)] ? propsById[String(pid)].name : '';
            const dataProp = (propName || '').toLowerCase().replace(/"/g,'&quot;');
            const dataUnit = String(unitLabel || '').toLowerCase().replace(/"/g,'&quot;');
            const dataName = (name || '').toLowerCase().replace(/"/g,'&quot;');
            const dataStatus = (tenant.leaseStatus || '').toLowerCase().replace(/"/g,'&quot;');
            const isOutOfLease = !!outOfLease;
            const numericRemaining = Number(remainingRent) || 0;
            const dataBalance = numericRemaining > 0.01 ? 'with-balance' : 'no-balance';

            const expectedCellHtml = isOutOfLease
                ? '<span style="color:#9ca3af;">N/A</span>'
                : `$${(expectedMonthly || 0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`;

            const balanceDisplay = `$${numericRemaining.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`;
            let balanceCellHtml;
            if (isOutOfLease) {
                balanceCellHtml = '<span style="color:#9ca3af;">N/A</span>';
            } else if (Math.abs(numericRemaining) <= 0.01) {
                balanceCellHtml = `<span style="color:#16a34a;font-weight:600;" title="Paid in full"><i class="fas fa-circle-check" aria-hidden="true" style="margin-right:4px;"></i>${balanceDisplay}</span>`;
            } else {
                balanceCellHtml = balanceDisplay;
            }
            return `
                <tr data-property="${dataProp}" data-unit="${dataUnit}" data-name="${dataName}" data-status="${dataStatus}" data-balance="${dataBalance}" data-tenant-id="${tenant._id}" data-property-id="${pid || ''}">
                    <td>${propName}</td>
                    <td>${unitLabel}</td>
                    <td>${name}</td>
                    <td>${expectedCellHtml}</td>
                    <td>$${(paidThisMonth || 0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
                    <td>${balanceCellHtml}</td>
                    <td class="portfolio-rent-actions-cell"><button type="button" class="btn-secondary portfolio-record-payment-btn" style="padding:4px 8px;font-size:0.8rem;display:none;">+Payment</button></td>
                </tr>`;
        }).join('');
        body.innerHTML = `
            <div id="portfolioDetailsFilterBar" style="margin-bottom:8px;border-radius:12px;padding:0;display:flex;flex-wrap:wrap;gap:0;align-items:flex-start;position:relative;">
                <div style="position:relative;flex:1 1 100%;min-width:240px;display:flex;align-items:center;gap:6px;justify-content:flex-start;flex-wrap:wrap;">
                    <i class="fas fa-magnifying-glass" style="color:#6b7280;margin-left:4px;"></i>
                    <input id="portfolioDetailsSearchBar" type="text" placeholder="Search list by" title="Try: name:, property:, unit:, status:, type:" style="flex:0 1 260px;max-width:260px;border:1px solid #e5e7eb;border-radius:10px;padding:6px 9px;background:#fff;font-size:0.9rem;" />
                    <input type="month" id="portfolioRentMonthPicker" style="font-size:0.8rem;border:1px solid #e5e7eb;border-radius:8px;padding:4px 8px;margin-left:4px;" title="Select month for rent metrics" />
                    <button class="btn-secondary" id="clearPortfolioDetailsFiltersBtn" title="Clear search" style="margin-right:4px;padding:5px 9px;font-size:0.85rem;">Clear</button>
                </div>
                <div id="portfolioDetailsActiveFilterChips" style="display:flex;flex-wrap:wrap;gap:6px;margin:6px 8px 0 26px;flex:1 1 100%;"></div>
                <div id="portfolioDetailsSearchSuggestions" style="position:absolute;top:40px;left:6px;right:auto;min-width:240px;max-width:520px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 12px 32px rgba(0,0,0,0.15);padding:4px 0;display:none;z-index:1000;max-height:260px;overflow:auto;">
                    <div id="portfolioDetailsSuggestHeader" style="padding:8px 12px;font-size:.85em;color:#374151;border-bottom:1px solid #eef2f7;display:flex;justify-content:space-between;align-items:center;">
                        <span id="portfolioDetailsSuggestTitle">Choose a filter</span>
                        <button id="portfolioDetailsSuggestBack" style="display:none;background:transparent;border:none;color:#217dbb;cursor:pointer;font-weight:600;">Back</button>
                    </div>
                    <ul id="portfolioDetailsSuggestList" style="list-style:none;margin:0;padding:4px 0;"></ul>
                    <ul id="portfolioDetailsSuggestValues" style="list-style:none;margin:0;padding:4px 0;display:none;"></ul>
                    <div style="border-top:1px solid #eef2f7;margin-top:4px;padding:6px 10px;font-size:.8em;color:#6b7280;">Use tokens like <strong>name:</strong> or <strong>status:</strong> for precise filters.</div>
                </div>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Property</th>
                            <th>Unit</th>
                            <th>Tenant</th>
                            <th>Expected</th>
                            <th>Paid</th>
                            <th>Balance</th>
                            <th style="width:1%;"></th>
                        </tr>
                    </thead>
                    <tbody id="portfolioDetailsTbody">
                        ${htmlRows}
                    </tbody>
                </table>
            </div>`;
        // Default rent details view (no preset filters)
        window.__portfolioDetailsAccumulatedQuery = '';
        initializePortfolioDetailsSearch();
        renderFilteredPortfolioDetailsRows();

        // Initialize and wire the portfolio rent month picker beside the search bar
        (function setupPortfolioRentMonthPicker() {
            const monthInput = document.getElementById('portfolioRentMonthPicker');
            if (!monthInput) return;
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const currentVal = `${y}-${m}`;
            if (!state.portfolioRentMonth) state.portfolioRentMonth = currentVal;
            monthInput.value = state.portfolioRentMonth;
            if (monthInput.dataset.bound === 'true') return;
            monthInput.addEventListener('change', async () => {
                const v = monthInput.value;
                state.portfolioRentMonth = v || currentVal;
                try {
                    showLoader();
                    await renderPortfolioOverview();
                    // Refresh current details tab (rent or others) based on new month
                    if (state.currentPortfolioDetailsType) {
                        renderPortfolioDetails(state.currentPortfolioDetailsType);
                    }
                } finally {
                    hideLoader();
                }
            });
            monthInput.dataset.bound = 'true';
        })();

        // Inline edit for Expected rent: click the Expected column cell to edit, save on blur
        (function setupInlineExpectedRentEditing() {
            const tbody = body.querySelector('#portfolioDetailsTbody');
            if (!tbody) return;
            tbody.addEventListener('click', async (evt) => {
            const cell = evt.target.closest('td');
            if (!cell) return;
            const row = cell.closest('tr');
                if (!row) return;
            const cellIndex = Array.prototype.indexOf.call(row.children, cell);
            // Only activate edit mode when clicking the Expected column (4th column, index 3)
            if (cellIndex !== 3) return;
                const tenantId = row.getAttribute('data-tenant-id');
                if (!tenantId) return;
            const expectedCell = cell;
                if (!expectedCell || expectedCell.querySelector('input')) return;

                const currentText = (expectedCell.textContent || '').trim();
                const numericMatch = currentText.replace(/[^0-9.\-]/g, '');
                const originalValue = numericMatch || '';

                const input = document.createElement('input');
                input.type = 'number';
                input.step = '0.01';
                input.min = '0';
                input.value = originalValue;
                input.className = 'app-inline-input';

                expectedCell.textContent = '';
                expectedCell.classList.add('expected-rent-editing');
                row.dataset.editing = 'true';
                expectedCell.appendChild(input);
                input.focus();
                input.select();

                const period = (state.portfolioRentMonth && /^\d{4}-\d{2}$/.test(state.portfolioRentMonth))
                    ? state.portfolioRentMonth
                    : (() => {
                        const now = new Date();
                        return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                    })();

                const restoreCell = (valueStr) => {
                    const num = Number(valueStr) || 0;
                    expectedCell.textContent = `$${num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    expectedCell.classList.remove('expected-rent-editing');
                    delete row.dataset.editing;
                };

                const handleBlur = async () => {
                    input.removeEventListener('blur', handleBlur);
                    input.removeEventListener('keydown', handleKey);
                    const newRaw = input.value.trim();
                    if (newRaw === originalValue) {
                        restoreCell(originalValue);
                        return;
                    }
                    const expectedRent = newRaw === '' ? null : Number(newRaw);
                    if (expectedRent !== null && !Number.isFinite(expectedRent)) {
                        restoreCell(originalValue);
                        showNotification('Invalid expected rent amount', 'error');
                        return;
                    }

                    showLoader();
                    try {
                        // Preserve any existing late fee override while updating expected rent
                        const existingOv = await fetchMonthOverride(tenantId, period);
                        const payload = {
                            expectedRent,
                            lateFee: existingOv?.lateFee ?? null,
                            lateFeeMode: existingOv?.lateFeeMode === 'percent' ? 'percent' : 'amount'
                        };
                        const resp = await fetch(`${API_URL}/tenants/${tenantId}/monthly-overrides/${period}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!resp.ok) throw new Error('Failed to save expected rent override');

                        upsertLocalTenantMonthlyOverride(tenantId, period, payload);
                        upsertLocalAllTenantMonthlyOverride(tenantId, period, payload);

                        showNotification('Expected rent updated', 'success');
                        await renderPortfolioOverview();
                        renderPortfolioDetails('rent');
                    } catch (err) {
                        console.error(err);
                        restoreCell(originalValue);
                        showNotification('Error saving expected rent', 'error');
                    } finally {
                        hideLoader();
                    }
                };

                const handleKey = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        input.blur();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        input.value = originalValue;
                        input.blur();
                    }
                };

                input.addEventListener('blur', handleBlur);
                input.addEventListener('keydown', handleKey);
            });
        })();

        // Show Record Payment button only on row hover
        (function setupPortfolioRentActionHover() {
            const tbody = body.querySelector('#portfolioDetailsTbody');
            if (!tbody) return;
            tbody.addEventListener('mouseover', (evt) => {
                const row = evt.target.closest('tr');
                if (!row) return;
                const btn = row.querySelector('.portfolio-record-payment-btn');
                if (btn) btn.style.display = 'inline-flex';
            });
            tbody.addEventListener('mouseout', (evt) => {
                const row = evt.target.closest('tr');
                if (!row) return;
                const btn = row.querySelector('.portfolio-record-payment-btn');
                if (btn) btn.style.display = 'none';
            });
            // Mobile/touch fallback: tap row to reveal/hide button on small screens
            tbody.addEventListener('click', (evt) => {
                const isNarrow = window.innerWidth <= 768;
                if (!isNarrow) return;
                // If the actual button was clicked, let the other handler process it
                if (evt.target.closest('.portfolio-record-payment-btn')) return;
                const row = evt.target.closest('tr');
                if (!row) return;
                const btn = row.querySelector('.portfolio-record-payment-btn');
                if (!btn) return;
                const current = (btn.style.display || '').toLowerCase();
                btn.style.display = (current === 'inline-flex') ? 'none' : 'inline-flex';
            });
        })();

        // Per-row Record Payment button for tenants with outstanding balance
        (function setupPortfolioRentRecordPayment() {
            const tbody = body.querySelector('#portfolioDetailsTbody');
            if (!tbody) return;
            tbody.addEventListener('click', (evt) => {
                const btn = evt.target.closest('.portfolio-record-payment-btn');
                if (!btn) return;
                const row = btn.closest('tr');
                if (!row) return;
                const tenantId = row.getAttribute('data-tenant-id');
                const propertyId = row.getAttribute('data-property-id') || '';
                if (!tenantId) {
                    showNotification('Unable to determine tenant for payment', 'error');
                    return;
                }
                openPaymentModalForTenantAndProperty(tenantId, propertyId || undefined, false);
            });
        })();
        return;
    }

    if (type === 'maintenance') {
        titleEl.textContent = 'Open Maintenance Requests';
        const items = state.portfolioMaintenance || [];
        if (!items.length) {
            body.innerHTML = '<p style="font-size:0.86rem;color:#6b7280;">No open maintenance requests.</p>';
            return;
        }
        const htmlRows = items.map(m => {
            const projectId = (m.projectId && m.projectId._id) ? m.projectId._id : (m.projectId || m.propertyId || m.property);
            let propName = '';
            if (projectId && propsById[String(projectId)]) {
                propName = propsById[String(projectId)].name;
            } else if (m.projectId && m.projectId.name) {
                // Fallback when projectId is a populated object not present in propsById map
                propName = m.projectId.name;
            }
            const unitId = m.unitId?._id || m.unitId;
            let unitLabel = '';
            if (unitId && unitsById[String(unitId)]) {
                const u = unitsById[String(unitId)];
                unitLabel = u.number || u.unitNumber || u.name || u.label || '';
            } else {
                unitLabel = m.unitLabel || m.unitNumber || m.unit || '';
            }
            const statusRaw = m.status || '';
            const statusLabel = statusRaw.replace(/_/g,' ');
            const dataProp = (propName || '').toLowerCase().replace(/"/g,'&quot;');
            const dataUnit = String(unitLabel || '').toLowerCase().replace(/"/g,'&quot;');
            const dataType = (m.category || 'Request').toLowerCase().replace(/"/g,'&quot;');
            const dataStatus = statusRaw.toLowerCase().replace(/"/g,'&quot;');
            return `
                <tr data-maint-id="${m._id}" data-project-id="${projectId || ''}" data-property="${dataProp}" data-unit="${dataUnit}" data-type="${dataType}" data-status="${dataStatus}">
                    <td>${propName}</td>
                    <td>${unitLabel}</td>
                    <td>${m.category || 'Request'}</td>
                    <td>${m.summary || m.description || ''}</td>
                    <td>
                        <select class="portfolio-maint-status-select">
                            <option value="pending" ${statusRaw==='pending' ? 'selected' : ''}>Pending</option>
                            <option value="in-progress" ${statusRaw==='in-progress' ? 'selected' : ''}>In Progress</option>
                            <option value="completed" ${statusRaw==='completed' ? 'selected' : ''}>Completed</option>
                        </select>
                    </td>
                </tr>`;
        }).join('');
        body.innerHTML = `
            <div id="portfolioDetailsFilterBar" style="margin-bottom:8px;border-radius:12px;padding:0;display:flex;flex-wrap:wrap;gap:0;align-items:flex-start;position:relative;">
                <div style="position:relative;flex:1 1 100%;min-width:240px;display:flex;align-items:center;gap:6px;justify-content:flex-start;">
                    <i class="fas fa-magnifying-glass" style="color:#6b7280;margin-left:4px;"></i>
                    <input id="portfolioDetailsSearchBar" type="text" placeholder="Search list by" title="Try: type:, property:, unit:, status:" style="flex:0 1 320px;max-width:280px;border:1px solid #e5e7eb;border-radius:10px;padding:6px 9px;background:#fff;font-size:0.9rem;" />
                    <button class="btn-secondary" id="clearPortfolioDetailsFiltersBtn" title="Clear search" style="margin-right:4px;padding:5px 9px;font-size:0.85rem;">Clear</button>
                </div>
                <div id="portfolioDetailsActiveFilterChips" style="display:flex;flex-wrap:wrap;gap:6px;margin:6px 8px 0 26px;flex:1 1 100%;"></div>
                <div id="portfolioDetailsSearchSuggestions" style="position:absolute;top:40px;left:6px;right:auto;min-width:240px;max-width:520px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 12px 32px rgba(0,0,0,0.15);padding:4px 0;display:none;z-index:1000;max-height:260px;overflow:auto;">
                    <div id="portfolioDetailsSuggestHeader" style="padding:8px 12px;font-size:.85em;color:#374151;border-bottom:1px solid #eef2f7;display:flex;justify-content:space-between;align-items:center;">
                        <span id="portfolioDetailsSuggestTitle">Choose a filter</span>
                        <button id="portfolioDetailsSuggestBack" style="display:none;background:transparent;border:none;color:#217dbb;cursor:pointer;font-weight:600;">Back</button>
                    </div>
                    <ul id="portfolioDetailsSuggestList" style="list-style:none;margin:0;padding:4px 0;"></ul>
                    <ul id="portfolioDetailsSuggestValues" style="list-style:none;margin:0;padding:4px 0;display:none;"></ul>
                    <div style="border-top:1px solid #eef2f7;margin-top:4px;padding:6px 10px;font-size:.8em;color:#6b7280;">Use tokens like <strong>type:</strong> or <strong>status:</strong> for precise filters.</div>
                </div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;gap:8px;flex-wrap:wrap;">
                <div style="font-size:0.9rem;color:#6b7280;">Open maintenance requests across all properties.</div>
                <div>
                    <button class="btn-secondary" id="portfolioNewMaintenanceBtn" type="button">New Request</button>
                </div>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Property</th>
                            <th>Unit</th>
                            <th>Type</th>
                            <th>Summary</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="portfolioDetailsTbody">
                        ${htmlRows}
                    </tbody>
                </table>
            </div>`;

        // Open Maintenance view defaults to showing only open items
        // (pending + in-progress) while still allowing filters for
        // completed via the status: token.
        window.__portfolioDetailsAccumulatedQuery = 'status:pending,in-progress';
        initializePortfolioDetailsSearch();
        renderFilteredPortfolioDetailsRows();

        const portfolioNewMaintBtn = document.getElementById('portfolioNewMaintenanceBtn');
        if (portfolioNewMaintBtn) {
            portfolioNewMaintBtn.addEventListener('click', () => {
                const form = document.getElementById('addMaintenanceForm');
                if (!form) return;
                form.dataset.context = 'portfolio';
                populateMaintenancePropertySelect();
                const unitSelect = document.getElementById('maintenanceUnit');
                if (unitSelect) {
                    unitSelect.innerHTML = '<option value="">Select a unit</option>';
                }
                openModal('addMaintenanceModal');
            });
        }

        // Wire row click to open inline edit mode for portfolio maintenance
        const maintTbody = document.getElementById('portfolioDetailsTbody');
        if (maintTbody) {
            Array.from(maintTbody.querySelectorAll('tr[data-maint-id]')).forEach(row => {
                row.addEventListener('click', (e) => {
                    const target = e.target;
                    if (target.closest('a') || target.closest('button') || target.closest('input') || target.closest('select')) return;
                    if (row.dataset.editing === 'true') return;
                    const id = row.getAttribute('data-maint-id');
                    if (!id) return;
                    const req = (state.portfolioMaintenance || []).find(r => String(r._id) === String(id));
                    if (!req) return;
                    enterPortfolioMaintenanceEditMode(row, req);
                });
            });
        }

        // Wire change handlers for inline status dropdowns
        const table = body.querySelector('table');
        if (table) {
            table.addEventListener('change', async (e) => {
                const select = e.target;
                if (!(select instanceof HTMLSelectElement) || !select.classList.contains('portfolio-maint-status-select')) return;
                const row = select.closest('tr');
                const requestId = row?.dataset.maintId;
                let projectId = row?.dataset.projectId;
                if (!requestId) return;
                // Fallback to request.projectId if dataset missing
                if (!projectId) {
                    const req = (state.portfolioMaintenance || []).find(r => String(r._id) === String(requestId));
                    if (req) {
                        projectId = (req.projectId && req.projectId._id) ? req.projectId._id : req.projectId;
                    }
                }
                const newStatus = select.value;
                if (!projectId || !newStatus) return;
                try {
                    const res = await fetch(`${API_URL}/properties/${projectId}/maintenance/${requestId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });
                    if (!res.ok) throw new Error('Failed to update maintenance status');
                    // Refresh portfolio overview metrics and maintenance list
                    try {
                        await renderPortfolioOverview();
                        renderPortfolioDetails('maintenance');
                    } catch (refreshErr) {
                        console.warn('Error refreshing portfolio overview after maintenance update:', refreshErr);
                    }
                    // Update local portfolio list
                    const idx = (state.portfolioMaintenance || []).findIndex(r => String(r._id) === String(requestId));
                    if (idx !== -1) {
                        state.portfolioMaintenance[idx].status = newStatus;
                    }
                    showNotification('Maintenance status updated', 'success');
                } catch (err) {
                    console.error('Error updating portfolio maintenance status:', err);
                    showNotification('Error updating maintenance status', 'error');
                }
            });
        }
        return;
    }

    if (type === 'leases') {
        titleEl.textContent = 'Leases & Upcoming Move-ins (Next 60 Days)';
        const leaseItems = state.portfolioExpiringLeases || [];
        const moveInItems = state.portfolioUpcomingMoveIns || [];

        const rows = [
            // Expiring leases based on tenant lease end dates
            ...leaseItems.map(({ tenant, daysUntilEnd }) => {
                let leaseEndDate = '';
                if (tenant.leaseEnd) {
                    try {
                        const d = new Date(tenant.leaseEnd);
                        if (!isNaN(d.getTime())) {
                            const y = d.getUTCFullYear();
                            const m = String(d.getUTCMonth() + 1).padStart(2, '0');
                            const day = String(d.getUTCDate()).padStart(2, '0');
                            leaseEndDate = `${m}/${day}/${y}`;
                        }
                    } catch {}
                }
                return {
                    type: 'Lease Expiring',
                    daysUntil: daysUntilEnd,
                    statusKey: 'lease-expiring',
                    name: tenant.fullName || tenant.name || `${tenant.firstName || ''} ${tenant.lastName || ''}`.trim() || 'Tenant',
                    unitId: tenant.unitId?._id || tenant.unitId,
                    unitFallback: tenant.unitNumber || tenant.unit || '',
                    propertyId: tenant.projectId || tenant.propertyId,
                    date: leaseEndDate
                };
            }),
            // Upcoming / recent move-ins based on tenant lease start dates
            ...moveInItems.map(item => {
                const tenant = item.tenant || null;
                const application = item.application || null; // backwards compatibility, if any
                const daysUntilMoveIn = item.daysUntilMoveIn;
                const rawDaysUntilMoveIn = item.rawDaysUntilMoveIn;

                let moveInDate = '';
                let name = 'Tenant';
                let unitId = null;
                let unitFallback = '';
                let propertyId = null;
                let propertyNameOverride = '';
                let source = '';
                let sourceId = '';

                if (tenant) {
                    name = tenant.fullName || tenant.name || `${tenant.firstName || ''} ${tenant.lastName || ''}`.trim() || 'Tenant';
                    unitId = tenant.unitId?._id || tenant.unitId || null;
                    unitFallback = tenant.unitNumber || tenant.unit || '';
                    propertyId = tenant.projectId || tenant.propertyId || null;
                    if (tenant.leaseStart) {
                        try {
                            const d = new Date(tenant.leaseStart);
                            if (!isNaN(d.getTime())) {
                                const y = d.getUTCFullYear();
                                const m = String(d.getUTCMonth() + 1).padStart(2, '0');
                                const day = String(d.getUTCDate()).padStart(2, '0');
                                moveInDate = `${m}/${day}/${y}`;
                            }
                        } catch {}
                    }
                    source = 'tenant';
                    sourceId = tenant._id || '';
                } else if (application) {
                    // Fallback path if any legacy application-based move-ins remain
                    let propertyAddress = '';
                    let unitNumber = application.unit || '';
                    if (application.notes) {
                        try {
                            const n = JSON.parse(application.notes);
                            propertyAddress = n.propertyAddress || propertyAddress;
                            unitNumber = n.unitNumber || unitNumber;
                        } catch {}
                    }
                    if (application.moveIn) {
                        try {
                            const d = new Date(application.moveIn);
                            if (!isNaN(d.getTime())) {
                                const y = d.getUTCFullYear();
                                const m = String(d.getUTCMonth() + 1).padStart(2, '0');
                                const day = String(d.getUTCDate()).padStart(2, '0');
                                moveInDate = `${m}/${day}/${y}`;
                            }
                        } catch {}
                    }
                    name = application.name || 'Applicant';
                    unitId = null;
                    unitFallback = unitNumber || '';
                    propertyId = null;
                    propertyNameOverride = propertyAddress || '';
                    source = 'application';
                    sourceId = application._id || '';
                }

                const rawDays = typeof rawDaysUntilMoveIn === 'number' ? rawDaysUntilMoveIn : daysUntilMoveIn;
                const statusKey = rawDays < 0 ? 'past-movein' : 'upcoming-movein';
                return {
                    type: 'Upcoming Move-in',
                    daysUntil: daysUntilMoveIn,
                    statusKey,
                    name,
                    unitId,
                    unitFallback,
                    propertyId,
                    propertyNameOverride,
                    date: moveInDate,
                    source,
                    sourceId
                };
            })
        ];

        if (!rows.length) {
            body.innerHTML = '<p style="font-size:0.86rem;color:#6b7280;">No expiring leases or upcoming move-ins in the next 60 days.</p>';
            return;
        }

        const htmlRows = rows
            .slice()
            .sort((a,b) => a.daysUntil - b.daysUntil)
            .map(row => {
                const unitId = row.unitId;
                let unitLabel = '';
                if (unitId && unitsById[String(unitId)]) {
                    const u = unitsById[String(unitId)];
                    unitLabel = u.number || u.unitNumber || u.name || u.label || '';
                } else {
                    unitLabel = row.unitFallback || '';
                }
                let propName = row.propertyNameOverride || '';
                if (!row.propertyNameOverride && row.propertyId && propsById[String(row.propertyId)]) {
                    propName = propsById[String(row.propertyId)].name;
                }
                const rowStatus = (row.statusKey || '').toLowerCase();
                const dataType = (row.type || '').toLowerCase().replace(/"/g,'&quot;');
                const dataProp = (propName || '').toLowerCase().replace(/"/g,'&quot;');
                const dataUnit = String(unitLabel || '').toLowerCase().replace(/"/g,'&quot;');
                const dataName = (row.name || '').toLowerCase().replace(/"/g,'&quot;');
                return `
                    <tr data-type="${dataType}" data-property="${dataProp}" data-unit="${dataUnit}" data-name="${dataName}" data-status="${rowStatus}">
                        <td>${row.type}</td>
                        <td>${propName}</td>
                        <td>${unitLabel}</td>
                        <td>${row.name}</td>
                        <td>${row.date}</td>
                        <td>${row.daysUntil} days</td>
                        <td>${row.type === 'Upcoming Move-in' ? `<button type="button" class="btn-secondary movein-checklist-btn" data-source="${row.source || ''}" data-source-id="${row.sourceId || ''}" data-name="${(row.name || '').replace(/"/g,'&quot;')}" data-property="${(propName || '').replace(/"/g,'&quot;')}" data-unit="${(unitLabel || '').toString().replace(/"/g,'&quot;')}" data-date="${(row.date || '').replace(/"/g,'&quot;')}">Checklist</button>` : ''}</td>
                    </tr>`;
            }).join('');

        body.innerHTML = `
            <div id="portfolioDetailsFilterBar" style="margin-bottom:8px;border-radius:12px;padding:0;display:flex;flex-wrap:wrap;gap:0;align-items:flex-start;position:relative;">
                <div style="position:relative;flex:1 1 100%;min-width:240px;display:flex;align-items:center;gap:6px;justify-content:flex-start;">
                    <i class="fas fa-magnifying-glass" style="color:#6b7280;margin-left:4px;"></i>
                    <input id="portfolioDetailsSearchBar" type="text" placeholder="Search list by" title="Try: name:, type:, property:, unit:, status:" style="flex:0 1 320px;max-width:280px;border:1px solid #e5e7eb;border-radius:10px;padding:6px 9px;background:#fff;font-size:0.9rem;" />
                    <button class="btn-secondary" id="clearPortfolioDetailsFiltersBtn" title="Clear search" style="margin-right:4px;padding:5px 9px;font-size:0.85rem;">Clear</button>
                </div>
                <div id="portfolioDetailsActiveFilterChips" style="display:flex;flex-wrap:wrap;gap:6px;margin:6px 8px 0 26px;flex:1 1 100%;"></div>
                <div id="portfolioDetailsSearchSuggestions" style="position:absolute;top:40px;left:6px;right:auto;min-width:240px;max-width:520px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 12px 32px rgba(0,0,0,0.15);padding:4px 0;display:none;z-index:1000;max-height:260px;overflow:auto;">
                    <div id="portfolioDetailsSuggestHeader" style="padding:8px 12px;font-size:.85em;color:#374151;border-bottom:1px solid #eef2f7;display:flex;justify-content:space-between;align-items:center;">
                        <span id="portfolioDetailsSuggestTitle">Choose a filter</span>
                        <button id="portfolioDetailsSuggestBack" style="display:none;background:transparent;border:none;color:#217dbb;cursor:pointer;font-weight:600;">Back</button>
                    </div>
                    <ul id="portfolioDetailsSuggestList" style="list-style:none;margin:0;padding:4px 0;"></ul>
                    <ul id="portfolioDetailsSuggestValues" style="list-style:none;margin:0;padding:4px 0;display:none;"></ul>
                    <div style="border-top:1px solid #eef2f7;margin-top:4px;padding:6px 10px;font-size:.8em;color:#6b7280;">Use tokens like <strong>name:</strong> or <strong>type:</strong> for precise filters.</div>
                </div>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Property</th>
                            <th>Unit</th>
                            <th>Name</th>
                            <th>Date</th>
                            <th>Days Left</th>
                            <th>Checklist</th>
                        </tr>
                    </thead>
                    <tbody id="portfolioDetailsTbody">
                        ${htmlRows}
                    </tbody>
                </table>
            </div>`;

        // Default Leases view to show upcoming move-ins while still
        // allowing users to switch to other statuses (e.g. moved-in).
        window.__portfolioDetailsAccumulatedQuery = 'status:upcoming-movein,lease-expiring';
        initializePortfolioDetailsSearch();
        renderFilteredPortfolioDetailsRows();

        // Wire checklist button clicks for upcoming move-ins
        const table = body.querySelector('table');
        if (table) {
            table.addEventListener('click', (e) => {
                const btn = e.target.closest('.movein-checklist-btn');
                if (!btn) return;
                const name = btn.getAttribute('data-name') || '';
                const property = btn.getAttribute('data-property') || '';
                const unit = btn.getAttribute('data-unit') || '';
                const date = btn.getAttribute('data-date') || '';
                const appId = btn.getAttribute('data-source-id') || '';
                const parts = [
                    `Move-in for ${name || 'applicant'}`,
                    property ? `Property: ${property}` : '',
                    unit ? `Unit: ${unit}` : '',
                    date ? `Move-in date: ${date}` : ''
                ].filter(Boolean);
                const ctxText = parts.join('  ');
                const modal = document.getElementById('moveInChecklistModal');
                const ctx = document.getElementById('moveInChecklistContext');
                if (ctx) ctx.textContent = ctxText;
                if (modal) {
                    // store application id on modal for later saves
                    modal.dataset.appId = appId;
                    const app = (state.applications || []).find(a => String(a._id) === String(appId));
                    const completed = Array.isArray(app && app.moveInChecklistCompleted)
                        ? app.moveInChecklistCompleted
                        : [];
                    const notesMap = app && app.moveInChecklistNotes ? app.moveInChecklistNotes : {};
                    // set checkboxes and notes according to saved state
                    modal.querySelectorAll('.movein-check-item').forEach(cb => {
                        const key = cb.getAttribute('data-item-id');
                        cb.checked = !!(key && completed.includes(key));
                    });
                    modal.querySelectorAll('.movein-check-note').forEach(input => {
                        const key = input.getAttribute('data-item-id');
                        const val = (key && notesMap && typeof notesMap[key] === 'string') ? notesMap[key] : '';
                        input.value = val || '';
                        // Auto-show note fields that already have saved text, hide empty ones
                        input.style.display = val ? 'block' : 'none';
                    });
                    modal.style.display = 'block';
                }
            });
        }
        return;
    }

    if (type === 'vacancy') {
        titleEl.textContent = 'Vacancy & Occupancy';
        const vacantUnits = state.portfolioVacantUnits || [];
        const occupiedUnits = state.portfolioOccupiedUnits || [];
        const allUnitsForView = [...vacantUnits.map(u => ({ ...u, __status: 'vacant' })), ...occupiedUnits.map(u => ({ ...u, __status: 'occupied' }))];
        if (!allUnitsForView.length) {
            body.innerHTML = '<p style="font-size:0.86rem;color:#6b7280;">No units found across the portfolio.</p>';
            return;
        }
        // Map active/pending tenants by unitId so we can show the actual rent
        const tenantsByUnitId = (state.allTenants || []).reduce((map, t) => {
            const unitId = t.unitId?._id || t.unitId;
            if (!unitId) return map;
            const status = (t.leaseStatus || '').toLowerCase();
            if (status === 'active' || status === 'pending') {
                map[String(unitId)] = t;
            }
            return map;
        }, {});
        const htmlRows = allUnitsForView.map(u => {
            const pid = u.projectId || u.propertyId || u.project;
            const propName = pid && propsById[String(pid)] ? propsById[String(pid)].name : '';
            const unitLabel = u.number || u.unitNumber || u.name || u.label || '';
            const beds = u.bedrooms != null ? u.bedrooms : (u.beds != null ? u.beds : '');
            const baths = u.bathrooms != null ? u.bathrooms : (u.baths != null ? u.baths : '');
            let rent = 0;
            if (u.__status === 'occupied' && u._id && tenantsByUnitId[String(u._id)]) {
                const tenant = tenantsByUnitId[String(u._id)];
                const petFees = (tenant.pets?.hasPets ? (Number(tenant.pets.monthlyRent) || 0) : 0);
                const additionalFees =
                    (Number(tenant.waterFee) || 0) +
                    (Number(tenant.trashFee) || 0) +
                    (Number(tenant.adminFee) || 0) +
                    (tenant.additionalFee?.amount || 0) +
                    petFees;
                rent = (Number(tenant.baseRent) || 0) + additionalFees;
            } else if (u.__status === 'vacant') {
                // For vacant units, show the market/unit rent value
                rent = Number(u.rent) || 0;
            }
            const statusLabel = u.__status === 'occupied' ? 'Occupied' : 'Vacant';
            const dataProp = (propName || '').toLowerCase().replace(/"/g,'&quot;');
            const dataUnit = String(unitLabel || '').toLowerCase().replace(/"/g,'&quot;');
            const dataStatus = u.__status;
            const dataType = 'vacancy';
            return `
                <tr data-property="${dataProp}" data-unit="${dataUnit}" data-status="${dataStatus}" data-type="${dataType}">
                    <td>${propName}</td>
                    <td>${unitLabel}</td>
                    <td>${beds}</td>
                    <td>${baths}</td>
                    <td>$${rent.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0})}</td>
                    <td>${statusLabel}</td>
                </tr>`;
        }).join('');
        body.innerHTML = `
            <div id="portfolioDetailsFilterBar" style="margin-bottom:8px;border-radius:12px;padding:0;display:flex;flex-wrap:wrap;gap:0;align-items:flex-start;position:relative;">
                <div style="position:relative;flex:1 1 100%;min-width:240px;display:flex;align-items:center;gap:6px;justify-content:flex-start;">
                    <i class="fas fa-magnifying-glass" style="color:#6b7280;margin-left:4px;"></i>
                    <input id="portfolioDetailsSearchBar" type="text" placeholder="Search list by" title="Try: property:, unit:, status:, type:" style="flex:0 1 320px;max-width:280px;border:1px solid #e5e7eb;border-radius:10px;padding:6px 9px;background:#fff;font-size:0.9rem;" />
                    <button class="btn-secondary" id="clearPortfolioDetailsFiltersBtn" title="Clear search" style="margin-right:4px;padding:5px 9px;font-size:0.85rem;">Clear</button>
                </div>
                <div id="portfolioDetailsActiveFilterChips" style="display:flex;flex-wrap:wrap;gap:6px;margin:6px 8px 0 26px;flex:1 1 100%;"></div>
                <div id="portfolioDetailsSearchSuggestions" style="position:absolute;top:40px;left:6px;right:auto;min-width:240px;max-width:520px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 12px 32px rgba(0,0,0,0.15);padding:4px 0;display:none;z-index:1000;max-height:260px;overflow:auto;">
                    <div id="portfolioDetailsSuggestHeader" style="padding:8px 12px;font-size:.85em;color:#374151;border-bottom:1px solid #eef2f7;display:flex;justify-content:space-between;align-items:center;">
                        <span id="portfolioDetailsSuggestTitle">Choose a filter</span>
                        <button id="portfolioDetailsSuggestBack" style="display:none;background:transparent;border:none;color:#217dbb;cursor:pointer;font-weight:600;">Back</button>
                    </div>
                    <ul id="portfolioDetailsSuggestList" style="list-style:none;margin:0;padding:4px 0;"></ul>
                    <ul id="portfolioDetailsSuggestValues" style="list-style:none;margin:0;padding:4px 0;display:none;"></ul>
                    <div style="border-top:1px solid #eef2f7;margin-top:4px;padding:6px 10px;font-size:.8em;color:#6b7280;">Use tokens like <strong>property:</strong> or <strong>status:</strong> for precise filters.</div>
                </div>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Property</th>
                            <th>Unit</th>
                            <th>Beds</th>
                            <th>Baths</th>
                            <th>Rent</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="portfolioDetailsTbody">
                        ${htmlRows}
                    </tbody>
                    <tfoot id="portfolioDetailsTfoot" style="position:sticky;bottom:0;background:#f9fafb;font-weight:600;">
                        <tr>
                            <td colspan="4" style="text-align:right;">Total:</td>
                            <td id="portfolioVacancyTotalRent">$0</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>`;

        // Default vacancy view to status:vacant while still allowing status:occupied filter
        window.__portfolioDetailsAccumulatedQuery = 'status:vacant';
        initializePortfolioDetailsSearch();
        renderFilteredPortfolioDetailsRows();
        return;
    }
}

// Show/hide additional fee fields based on selection
document.getElementById('additionalFeeType').addEventListener('change', function() {
    const type = this.value;
    document.getElementById('additionalFeeLabelGroup').style.display = type === 'other' ? 'block' : 'none';
    document.getElementById('additionalFeeAmountGroup').style.display = type ? 'block' : 'none';
    if (type !== 'other') {
        document.getElementById('additionalFeeLabel').value = '';
    }
});

// Export functions for global access
window.selectProperty = selectProperty;
window.openPortfolioOverview = openPortfolioOverview;
window.openModal = openModal;
window.closeModal = closeModal;
window.editUnit = editUnit;
window.viewUnitDetails = viewUnitDetails;
window.editTenant = editTenant;
window.viewTenantDetails = viewTenantDetails;
window.updateMaintenanceStatus = updateMaintenanceStatus;
window.viewDocument = viewDocument;
window.downloadDocument = downloadDocument;
window.deleteDocument = deleteDocument;
window.deleteTenant = deleteTenant;
window.editPayment = editPayment;
window.deletePayment = deletePayment;
// Expose tenant balance modal function after definition (added later in script)
window.openTenantBalanceModal = openTenantBalanceModal;
// Export functions for reports
window.exportTenantPaymentsReportFromModal = exportTenantPaymentsReportFromModal;


// Setup Send Application modal and actions
document.addEventListener('DOMContentLoaded', () => {
    // Create modal if missing
    if (!document.getElementById('sendApplicationModal')) {
        const modal = document.createElement('div');
        modal.id = 'sendApplicationModal';
        modal.className = 'modal';
        modal.style.display = 'none';
        modal.innerHTML = `
            <div class="modal-content" style="max-width:480px;">
                <h2>Send Rental Application</h2>
                <form id="sendApplicationForm">
                    <div class="form-group">
                        <label>Property (optional)</label>
                        <select id="sendAppProperty">
                            <option value="">Select a property</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Unit (optional)</label>
                        <select id="sendAppUnit" disabled>
                            <option value="">Select a unit</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Full Name (optional)</label>
                        <input type="text" id="sendAppName" placeholder="e.g., John Doe" />
                    </div>
                    <div class="form-group">
                        <label>Email (required)</label>
                        <input type="email" id="sendAppEmail" placeholder="applicant@example.com" required />
                        <div id="sendAppError" style="display:none; color:#b91c1c; font-size:12px; margin-top:8px;">Please enter a valid email.</div>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="btn-secondary" id="cancelSendAppBtn">Cancel</button>
                        <button type="submit" class="btn-primary" id="confirmSendAppBtn">Send Link</button>
                    </div>
                </form>
            </div>`;
        document.body.appendChild(modal);
    }

    const sendBtn = document.getElementById('sendApplicationBtn');
    const cancelBtn = document.getElementById('cancelSendAppBtn');
    const formEl = document.getElementById('sendApplicationForm');
    const errorEl = document.getElementById('sendAppError');
    const emailInput = document.getElementById('sendAppEmail');
    const nameInput = document.getElementById('sendAppName');
    const propertySelect = document.getElementById('sendAppProperty');
    const unitSelect = document.getElementById('sendAppUnit');
    let modalUnits = [];

    function isValidEmail(email) { return /[^\s@]+@[^\s@]+\.[^\s@]+/.test(email); }

    async function populateUnitsForProperty(propertyId) {
        modalUnits = [];
        unitSelect.innerHTML = '<option value="">Select a unit</option>';
        unitSelect.disabled = true;
        if (!propertyId) return;
        try {
            const res = await fetch(`${API_URL}/properties/${propertyId}/units`);
            if (!res.ok) throw new Error('Failed to load units');
            const data = await res.json();
            modalUnits = data.property?.units || [];
            if (modalUnits.length) {
                unitSelect.disabled = false;
                unitSelect.innerHTML = ['<option value="">Select a unit</option>',
                    ...modalUnits.map(u => `<option value="${u._id}">Unit ${u.number}</option>`)
                ].join('');
            }
        } catch (e) {
            console.error('Error loading units for property:', e);
        }
    }

    function openSendAppModal() {
        errorEl.style.display = 'none';
        nameInput.value = '';
        emailInput.value = '';
        // Populate properties list (default to current property if available)
        if (propertySelect) {
            propertySelect.innerHTML = '<option value="">Select a property</option>' +
                (state.properties || []).map(p => `<option value="${p._id}">${p.name}</option>`).join('');
            if (state.currentProperty?._id) {
                propertySelect.value = state.currentProperty._id;
            }
            // Populate units for the selected property
            populateUnitsForProperty(propertySelect.value);
        }
        openModal('sendApplicationModal');
    }
    function closeSendAppModal() { closeModal('sendApplicationModal'); }

    sendBtn?.addEventListener('click', openSendAppModal);
    cancelBtn?.addEventListener('click', closeSendAppModal);
    propertySelect?.addEventListener('change', (e) => {
        const propId = e.target.value || '';
        populateUnitsForProperty(propId);
    });
    formEl?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = emailInput.value.trim();
        const name = nameInput.value.trim();
        const selectedPropertyId = propertySelect?.value || '';
        const selectedProperty = (state.properties || []).find(p => p._id === selectedPropertyId);
        const selectedUnitId = unitSelect?.value || '';
        const selectedUnit = (modalUnits || []).find(u => u._id === selectedUnitId);
        if (!isValidEmail(email)) { errorEl.style.display = 'block'; return; }
        try {
            showLoader();
            const res = await fetch('/api/rental-applications/send-link', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email,
                    name,
                    propertyId: selectedProperty?._id || state.currentProperty?._id || undefined,
                    propertyName: selectedProperty?.name || state.currentProperty?.name || undefined,
                    unitId: selectedUnit?._id || undefined,
                    unitNumber: selectedUnit?.number || undefined
                })
            });
            hideLoader();
            if (!res.ok) throw new Error('Failed to send link');
            closeSendAppModal();
            showNotification('Application link sent successfully', 'success');
            // Refresh invites list to show the new record
            runWhenIdle(() => loadInvites(true));
        } catch (err) {
            console.error('Send application error:', err);
            errorEl.textContent = 'Failed to send link. Please try again.';
            errorEl.style.display = 'block';
        }
    });
});

    </script>
</body>
</html>
