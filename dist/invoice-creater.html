<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create Invoice</title>
  <style>
:root {
  --primary: #007bff;
  --secondary: #6b7280;
  --bg: #f9fafb;
  --white: #ffffff;
  --text: #1f2937;
  --border: #e5e7eb;
  --radius: 12px;
  --shadow: 0 4px 14px rgba(0, 0, 0, 0.08);
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: var(--bg);
  margin: 0;
  padding: 20px;
  color: var(--text);
}

.container {
  max-width: 1000px;
  margin: auto;
  background: var(--white);
  padding: 24px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  transition: box-shadow 0.3s ease;
}

input,
select,
button {
  font-family: inherit;
  font-size: 16px;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background-color: #fff;
  color: var(--text);
  transition: border-color 0.3s ease, box-shadow 0.2s ease;
  box-sizing: border-box;
}

h2, h3 {
  color: var(--primary);
  margin-bottom: 10px;
}

label {
  font-weight: bold;
  display: block;
  margin: 15px 0 5px;
}

input[type="text"],
input[type="email"],
input[type="number"],
input[type="date"],
select {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background-color: #fefefe;
  transition: border 0.3s ease;
}

input:focus,
select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(96, 37, 235, 0.21);
  outline: none;
}

.line-item-row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
}

.line-item-row input {
  flex: 1 1 10%;
  min-width: 150px;
}

/* üëá Invoice table fix */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  table-layout: fixed;
}

th, td {
  padding: 12px;
  border: 1px solid var(--border);
  text-align: left;
  vertical-align: top;
  word-wrap: break-word;
  white-space: normal;
}

th[data-sort] {
  cursor: pointer;
}

th:nth-child(3),
td:nth-child(3) {
  width: 40%;
}

.sort-indicator {
  margin-left: 5px;
  color: var(--primary);
}

.btn {
  background: var(--primary);
  color: var(--white);
  padding: 10px 20px;
  border: none;
  border-radius: var(--radius);
  cursor: pointer;
  margin: 10px 5px 0 0;
  transition: background 0.3s ease;
}

.btn:hover {
  background: #0056b3;
}

.secondary-btn {
  background: var(--secondary);
}

.secondary-btn:hover {
  background: #5a6268;
}

.history {
  margin-top: 40px;
}



/* üîß Modal wrapper */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.4);
  display: none;
  justify-content: center;
  align-items: flex-start;
  z-index: 10000;
  padding: 40px 20px;
  overflow-y: auto;
}

.modal-content {
  background: #fff;
  width: 100%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
}

.table-container {
  overflow-x: auto;
}

/* Modal header */
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.close-modal {
  font-size: 28px;
  cursor: pointer;
  color: var(--secondary);
}

/* Dropdown */
.dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-btn {
  background: transparent;
  border: none;
  font-size: 25px;
  cursor: pointer;
  padding: 6px;
  border-radius: 6px;
  transition: background 0.2s ease;
  color: #555; /* Softer dark */
}

.dropdown-content {
  display: none;
  position: absolute;
  right: 0;
  top: 100%;
  background: white;
  border: 1px solid #ddd;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  margin-top: 6px;
  min-width: 160px;
  z-index: 1000;
}

.dropdown-content a {
  padding: 10px 16px;
  display: block;
  text-decoration: none;
  color: #333;
  font-size: 14px;
  cursor: pointer;
}

.dropdown-content a:hover {
  background-color: #f1f5f9;
}



.dropdown-content {
  display: none;
}
.dropdown.open .dropdown-content {
  display: block;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .invoice-info {
    flex-direction: column;
  }

  .line-item-row input {
    flex: 1 1 100%;
  }

  .modal-content {
    padding: 20px;
  }
}

/* Mobile responsiveness for #invoiceModal */
#invoiceModal .modal-content {
  background: #fff;
  max-width: 800px;
  width: 90%;
  margin-left: -47px;
  margin-top: -41px;
  border-radius: 12px;
  padding: 30px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

@media (max-width: 768px) {
  #invoiceModal .modal-content {
    padding: 20px;
  }

  #invoiceModal .modal-content h2,
  #invoiceModal .modal-content h3 {
    font-size: 20px;
  }

  #invoiceModal table th,
  #invoiceModal table td {
    font-size: 14px;
    padding: 8px;
  }

  #invoiceModal .modal-content p {
    font-size: 14px;
  }
}

@media (max-width: 480px) {
  #invoiceModal .modal-content {
    padding: 15px;
  }

  #invoiceModal .modal-content h2,
  #invoiceModal .modal-content h3 {
    font-size: 18px;
  }

  #invoiceModal table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
  }

  #invoiceModal table th,
  #invoiceModal table td {
    font-size: 13px;
  }
}

#invoiceModal {
  scroll-behavior: smooth;
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes dropdownFade {
  from { opacity: 0; transform: translateY(-4px); }
  to { opacity: 1; transform: translateY(0); }
}

.responsive-table-wrapper {
    overflow-x: auto;
    width: 100%;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 700px; /* Force scroll for narrow screens */
  }

  th, td {
    padding: 10px;
    border: 1px solid #ccc;
    text-align: left;
    font-size: 14px;
    
  }

  th {
    background-color: #f0f4f8;
    font-weight: 600;
  }

  @media (max-width: 768px) {
    th, td {
      font-size: 13px;
    }

    .responsive-table-wrapper {
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
  }


  .responsive-table-wrapper {
    overflow-x: auto;
    width: 100%;
  }

  .responsive-table-wrapper table {
    min-width: 600px; /* Forces scroll on smaller devices */
    width: 100%;
    border-collapse: collapse;
  }

  table th, table td {
    padding: 10px;
    border: 1px solid #ccc;
    text-align: left;
    
    font-size: 14px;
  }

  table th {
    background-color: #f0f4f8;
    font-weight: 600;
  }

  @media (max-width: 768px) {
    table th, table td {
      font-size: 13px;
    }
  }

  #loader {
  transition: opacity 0.3s ease;
}

#loader.hide {
  opacity: 0;
  pointer-events: none;
}

.toast-warning {
  background: linear-gradient(to right, #f59e42, #fbbf24); /* orange/yellow */
  color: #fff;
  border: 1px solid #f59e42;
}
.toast-info {
  background: linear-gradient(to right, #0ea5e9, #3b82f6);
  color: white;
  border: 1px solid #0ea5e9;
}
.toast-success {
  background: linear-gradient(to right, #22c55e, #16a34a);
  color: white;
  border: 1px solid #16a34a;
}
.toast-error {
  background: linear-gradient(to right, #ef4444, #b91c1c);
  color: white;
  border: 1px solid #b91c1c;
}

#help-fab:hover {
  background: #0056b3;
}
  </style>
</head>
<body>

  <header style="display: flex; justify-content: space-between; align-items: center; padding: 20px; background-color: #007bff; color: white; border-radius: 6px; margin-bottom: 20px;">
    <h2 style="margin: 0; color: white;">üßæ Create Invoice</h2>
    <button onclick="window.location.href = '/Subcontractor Page.html';"
      style="background: white; color: #007bff; border: none; padding: 8px 16px; border-radius: 4px; font-weight: bold; cursor: pointer; transition: background 0.3s;">
      ‚¨ÖÔ∏è Back to Dashboard
    </button>
  </header>
  
<!-- FROM Section -->
<label style="font-weight: bold; margin-top: 20px; display: block;">FROM</label>

<h2><input type="text" id="companyName" placeholder="Company Name" /></h2>
<input type="text" id="companyAddress" placeholder="Street Address" />
<input type="text" id="companyCityZip" placeholder="City, ST ZIP Code" />
<input type="text" id="companyPhoneFax" placeholder="Phone: (xxx) xxx-xxxx | Fax: (xxx) xxx-xxxx" />


<!-- TO Section -->
<label style="font-weight: bold; margin-top: 20px; display: block;">TO</label>
<input type="text" id="recipientCompany" placeholder="Company Name" />




<!-- Invoice Meta -->
<label for="invoiceDate"><strong>Invoice Date:</strong></label>
<input type="date" id="invoiceDate" />




<div class="container">
  <h2>Create Invoice</h2>

  <!-- Step 1: Project Selection -->
  <label for="projectSelect"><strong>Select Project:</strong></label>
  <select id="projectSelect" style="width: 100%; padding: 10px; margin-bottom: 15px;">
    <option value="">-- Loading Projects --</option>
  </select>

  <!-- Step 2: Estimate Selection (populated based on selected project) -->
  <label for="estimateSelect"><strong>Select Estimate:</strong></label>
  <select id="estimateSelect" style="width: 100%; padding: 10px; margin-bottom: 15px;">
    <option value="">-- Select Estimate --</option>
  </select>

  <!-- Step 3: Line Items -->
<label><strong>Import Line Items:</strong></label>
<div id="lineItemCheckboxList" style="max-height: 220px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px; margin-bottom: 15px;"></div>
<button onclick="importLineItems()" class="btn">Import Selected Items</button>
</div>


<h3>Manual Line Item Entry</h3>
<div class="line-item-row" style="display: flex; flex-wrap: wrap; gap: 10px; position: relative; margin-bottom: 20px;">
  <input type="text" id="itemCostCode" placeholder="Cost Code" style="flex: 0 0 100px; min-width: 80px;">
  <input type="text" id="itemName" placeholder="Item Name" style="flex: 1 1 160px; min-width: 140px;">
  <input type="text" id="itemDesc" placeholder="Description" style="flex: 2 1 400px; min-width: 200px;"> <!-- üî• Wider and grows nicely -->
  <input type="number" id="itemQty" placeholder="Quantity" style="flex: 0 0 80px; min-width: 60px;">
  <input type="number" id="itemPrice" placeholder="Unit Price" style="flex: 0 0 100px; min-width: 80px;">
  <button class="btn" onclick="addManualItem()" style="flex: 0 0 70px;">Add</button>
</div>




<h3>Line Items</h3>
<div class="responsive-table-wrapper">
  <table>
    <thead>
      <tr>
        <th>Cost Code</th>
        <th>Name</th>
        <th>Description</th>
        <th>Qty</th>
        
        <th>Total</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="lineItemsTable"></tbody>
  </table>
</div>


<!-- Hidden Email Field -->
<input type="email" id="invoiceEmail" value="jleonel3915@gmail.com" style="display: none;" />


    <button class="btn" onclick="openInvoicePreview()">Preview Invoice</button>
    <button class="btn" onclick="submitInvoice()">Submit Invoice</button>

    <div class="history">
      <h3>Invoice History</h3>
      <div class="responsive-table-wrapper">
        <table>
          <thead>
            <tr>
              <th data-sort="invoiceNumber">Invoice # <span class="sort-indicator"></span></th>
              <th data-sort="project">Project <span class="sort-indicator"></span></th>
              <th data-sort="date">Date <span class="sort-indicator"></span></th>
              <th data-sort="total">Total <span class="sort-indicator"></span></th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="invoiceHistoryTable"></tbody>
        </table>
      </div>
    </div>
    

  

  <!-- Modal Structure -->
<div id="invoiceModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Invoice Preview</h3>
      <span class="close-modal" onclick="closeInvoicePreview()">&times;</span>
    </div>
    <div id="invoicePreviewContent"></div>
    <button onclick="printInvoice()" id="printBtn">Print</button>
  </div>
</div>


<!-- Floating Help Icon -->
<div id="help-fab" style="
  position: fixed;
  bottom: 32px;
  right: 32px;
  z-index: 99999;
  background: #007bff;
  color: #fff;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  box-shadow: 0 4px 16px rgba(0,0,0,0.18);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  cursor: pointer;
  transition: background 0.2s;
">
  ?
</div>

<!-- Help Modal -->
<div id="helpModal" style="
  display: none;
  position: fixed;
  top: 0; left: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.35);
  z-index: 100000;
  align-items: center;
  justify-content: center;
">
  <div id="helpModalContent" style="
    background: #fff;
    border-radius: 12px;
    max-width: 420px;
    width: 90%;
    margin: auto;
    padding: 32px 24px 24px 24px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.18);
    position: relative;
    text-align: center;
  ">
    <button onclick="closeHelpModal()" style="
      position: absolute; top: 12px; right: 16px; background: none; border: none; font-size: 22px; color: #888; cursor: pointer;">&times;</button>
    <h3 style="margin-top:0;">How can we help?</h3>
    <div id="helpOptions">
      <button class="btn" style="width:100%;margin-bottom:12px;" onclick="showHelpVideo('import')">How to import a line item</button>
      <button class="btn" style="width:100%;" onclick="showHelpVideo('submit')">How to submit an invoice</button>
    </div>
    <div id="helpVideoContainer" style="display:none;">
      <video id="helpVideo" width="100%" controls style="border-radius:8px; margin-top:10px;">
        <source id="helpVideoSource" src="" type="video/mp4">
        Your browser does not support the video tag.
      </video>
      <button class="btn" style="margin-top:16px;" onclick="closeHelpVideo()">Back to Help Options</button>
    </div>
  </div>
</div>


<!-- Toast Notification -->
<div id="toast" style="
  position: fixed;
  top: 30px;
  left: 50%;
  transform: translateX(-50%);
  padding: 14px 24px;
  border-radius: 8px;
  display: none;
  z-index: 9999;
  font-weight: 500;
  font-size: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  transition: opacity 0.3s ease, transform 0.3s ease;
  pointer-events: none;
"></div>

<!-- Loader Spinner -->
<div id="loader" style="
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(2px);
  z-index: 9999;
  display: none;
  justify-content: center;
  align-items: center;
">
  <div style="
    border: 5px solid #e5e7eb;
    border-top: 5px solid #3b82f6;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    animation: spin 0.8s linear infinite;
  "></div>
</div>

<!-- Add this to your <style> block or <head> -->
<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>




<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>

window.onload = async () => {
  const vendorId = localStorage.getItem("vendorId");

  if (!vendorId) {
    showToast("Missing vendor ID");
    return;
  }

  document.getElementById('recipientCompany').value = 'BESF LLC'; // ‚úÖ Default value

  // Load vendor-specific data
  await fetchVendorName();
  await fetchAssignedProjects(vendorId);
  await fetchInvoiceHistory(vendorId);
  await fetchVendorNameAndAutofill();
  await fetchLaborSuggestions();
};


    
    let lineItems = [];



    async function fetchProjectDetails(projectId) {
      showLoader(); // üëà START
  try {
    const res = await fetch(`/api/details/projects/${projectId}`);
    const { project } = await res.json();
    console.log("Project Details:", project);
    // You can do something with it here...
  } catch (err) {
    console.error("Error loading project details:", err);
  } finally {
    hideLoader(); // üëà END  
  }
}

function showToast(message, type = "info") {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.style.display = 'block';

  // Remove any previous type classes
  toast.classList.remove('toast-success', 'toast-error', 'toast-warning', 'toast-info');

  // Add class based on type
  toast.classList.add(`toast-${type}`);

  setTimeout(() => { toast.style.display = 'none'; }, 3000);
}

function showLoader() {
  document.getElementById('loader').style.display = 'flex';
}

function hideLoader() {
  document.getElementById('loader').style.display = 'none';
}






let laborCostList = []; // <-- ADD THIS at top

async function fetchLaborSuggestions() {
  try {
    const res = await fetch('/api/labor-costs');
    laborCostList = await res.json();
    console.log('‚úÖ Labor cost list loaded:', laborCostList.length, 'items');
  } catch (err) {
    console.error('‚ùå Failed to load labor suggestions:', err);
  }
}



async function fetchAssignedProjects(vendorId) {
  try {
    const res = await fetch(`/api/vendors/${vendorId}/assigned-projects?t=${Date.now()}`);
    if (!res.ok) throw new Error("Failed to fetch assigned projects.");

    const data = await res.json();
    console.log("üì¶ Assigned Projects Response:", data);

    // ‚úÖ Combine all job types into one array
    const projects = [
      ...(data.newJobs || []),
      ...(data.inProgress || []),
      ...(data.completed || [])
    ];

    const projectSelect = document.getElementById('projectSelect');
    projectSelect.innerHTML = `<option value="">-- Select Project --</option>`;

    projects.forEach(p => {
      const project = p.projectId || p; // in case structure is { projectId: {...} }
      if (project?._id && project?.name) {
        const option = document.createElement("option");
        option.value = project._id;
        option.textContent = project.name;
         // ‚úÖ Add full address as data-address
    option.dataset.address = `${project.address?.addressLine1 || ''}, ${project.address?.city || ''}, ${project.address?.state || ''}, ${project.address?.zip || ''}`.replace(/, ,/g, ',').trim();
        projectSelect.appendChild(option);
      }
    });

    // üìå Hook up estimate selection after selecting a project
    projectSelect.addEventListener("change", function () {
      const projectId = this.value;
      if (projectId) fetchEstimatesForProject(vendorId, projectId);
    });

  } catch (err) {
    console.error("‚ùå Error loading assigned projects:", err);
    showToast("‚ùå Failed to load assigned projects.");
  }
}



async function fetchEstimatesForProject(vendorId, projectId) {
  try {
    const estimateSelect = document.getElementById('estimateSelect');
    const lineItemCheckboxList = document.getElementById('lineItemCheckboxList');
    estimateSelect.innerHTML = `<option value="">-- Select Estimate --</option>`;
    if (lineItemCheckboxList) lineItemCheckboxList.innerHTML = '';

    // 1. Fetch assigned items
    const itemsRes = await fetch(`/api/vendors/${vendorId}/assigned-items/${projectId}`);
    let items = [];

    if (itemsRes.status === 404) {
      console.warn("‚ö†Ô∏è No assigned items found. Continuing with empty list.");
    } else if (!itemsRes.ok) {
      throw new Error("Failed to fetch assigned items.");
    } else {
      const data = await itemsRes.json();
      items = data.items || [];
      console.log("üì¶ Fetched Assigned Items:", items);

      // üëá Force laborCost as total for imported items
      items.forEach(item => {
        // If laborCost is missing but total is correct, use total as laborCost
        if (typeof item.laborCost === "undefined" && typeof item.total !== "undefined") {
          item.laborCost = item.total;
        }
        // Always use laborCost as total for imported items
        if (typeof item.laborCost !== "undefined") {
          item.total = item.laborCost;
        }
      });
    }

    // 2. Group items by estimateId and adjust the total
    const estimateMap = new Map();
    items.forEach(item => {
      if (item.estimateId) {
        if (!estimateMap.has(item.estimateId)) {
          estimateMap.set(item.estimateId, []);
        }
        estimateMap.get(item.estimateId).push(item);
      }
    });

    if (estimateMap.size === 0) {
      estimateSelect.innerHTML = `<option value="">-- No Assigned Estimates --</option>`;
      showToast("‚ö†Ô∏è No estimates with assigned items found.");
      return;
    }

    // 3. Fetch estimates for project
    const estRes = await fetch(`/api/estimates?projectId=${projectId}`);
    if (!estRes.ok) throw new Error("Failed to fetch estimates.");
    const { estimates } = await estRes.json();
    console.log("üìã Fetched Estimates:", estimates);

    let matchedEstimates = 0;

    estimates.forEach(est => {
      if (estimateMap.has(est._id)) {
        const option = document.createElement("option");
        const label = est.title || `Estimate #${est.invoiceNumber}`;
        option.value = est._id;
        option.textContent = label;
        option.setAttribute("data-invoice-number", est.invoiceNumber || `EST-${Math.floor(Math.random() * 10000)}`);
        estimateSelect.appendChild(option);
        matchedEstimates++;
      }
    });

    if (matchedEstimates === 0) {
      estimateSelect.innerHTML = `<option value="">-- No Assigned Estimates Found --</option>`;
      showToast("‚ö†Ô∏è No estimates assigned to you in this project.");
      return;
    }

    // 4. Replace old estimate dropdown with new one to reset listeners
    const newEstimateSelect = estimateSelect.cloneNode(true);
    estimateSelect.parentNode.replaceChild(newEstimateSelect, estimateSelect);

    // 5. Handle estimate selection
    newEstimateSelect.addEventListener("change", function () {
      const estimateId = this.value;
      const selectedOption = this.options[this.selectedIndex];
      const invoiceNumber = selectedOption.getAttribute("data-invoice-number");

      console.log(`üì¶ Selected Estimate: ${estimateId} | Invoice Number: ${invoiceNumber}`);

      if (estimateId) {
        const assignedItems = estimateMap.get(estimateId) || [];
        console.log("üì¶ Assigned Items for Selected Estimate:", assignedItems);
        displayLineItems(assignedItems);
      } else {
        lineItemSelect.innerHTML = '';
      }
    });

  } catch (err) {
    console.error("‚ùå Error fetching estimates:", err);
    showToast("‚ùå Could not fetch estimates.");
  }
}



async function importLineItems() {
  const checkboxes = Array.from(document.querySelectorAll('#lineItemCheckboxList input[type="checkbox"]:checked'));
  if (checkboxes.length === 0) {
    showToast("Please select at least one line item to import.", "warning");
    return;
  }
  const vendorId = localStorage.getItem("vendorId");
  if (!vendorId) {
    showToast("Missing vendor ID");
    return;
  }

  // Fetch all previously submitted line item IDs for this vendor
  const usedIds = await getPreviouslySubmittedLineItemIds(vendorId);

  let duplicateCount = 0;
  checkboxes.forEach(box => {
    const item = JSON.parse(box.dataset.details);

    // Only check for duplicates if the item has a unique _id
    if (item._id && usedIds.has(item._id)) {
      duplicateCount++;
      showToast(`‚ö†Ô∏è  "${item.name}" already Submitted.`, "error");
      return;
    }

    // Prevent adding the same item twice in the same invoice
    const alreadyInCurrent = lineItems.some(existing =>
      existing._id && item._id && existing._id === item._id
    );
    if (alreadyInCurrent) {
      duplicateCount++;
      showToast(`‚ö†Ô∏è "${item.name}" already Submitted.`, "error");
      return;
    }

    addItemToTable(item, true);
  });

  if (duplicateCount === 0) {
    showToast('Imported selected line items.');
  }
}


async function getPreviouslySubmittedLineItemIds(vendorId) {
  try {
    const res = await fetch(`/api/vendors/${vendorId}/used-line-item-ids`);
    if (!res.ok) throw new Error("Failed to fetch previous line item IDs");
    const data = await res.json();
    // data.usedIds is an array of IDs (strings)
    return new Set(data.usedIds || []);
  } catch (err) {
    console.error("‚ùå Error fetching previous line item IDs:", err);
    return new Set();
  }
}


// Display line items in the checkbox list
async function displayLineItems(items) {
  const container = document.getElementById('lineItemCheckboxList');
  container.innerHTML = '';

  // Fetch all previously submitted line item IDs for this vendor
  const vendorId = localStorage.getItem("vendorId");
  const usedIds = vendorId ? await getPreviouslySubmittedLineItemIds(vendorId) : new Set();

  // Only show items that are "approved" or "completed" and NOT already submitted
  items
    .filter(item => {
      const status = String(item.status || '').toLowerCase();
      return (status === 'approved' || status === 'completed') && !(item._id && usedIds.has(item._id));
    })
    .forEach((item, idx) => {
      const id = `lineitem-checkbox-${idx}`;
      const total = typeof item.total !== "undefined"
        ? parseFloat(item.total)
        : (typeof item.laborCost !== "undefined"
            ? parseFloat(item.laborCost)
            : (parseFloat(item.unitPrice) * parseFloat(item.quantity) || 0));
      const label = `
        <span><strong>${item.name || 'Unnamed'}</strong></span>
        <span style="color:#64748b; margin-left:8px;">${item.description || 'No description'}</span>
      `;
      const wrapper = document.createElement('div');
      wrapper.style.marginBottom = '6px';
      wrapper.style.display = 'flex';
      wrapper.style.alignItems = 'center';
      wrapper.innerHTML = `
        <input type="checkbox" id="${id}" data-details='${JSON.stringify(item)}' style="margin-right: 8px;">
        <label for="${id}" style="cursor:pointer; flex:1; display:flex; align-items:center; gap:10px;">${label}</label>
      `;
      container.appendChild(wrapper);
    });
}








// Enable live suggestions
document.getElementById('itemName').addEventListener('input', showLaborSuggestions);

// Show labor cost suggestions
function showLaborSuggestions() {
  const input = document.getElementById('itemName');
  const value = input.value.toLowerCase();
  let box = document.getElementById('suggestionBox');

  if (!box) {
    box = document.createElement('div');
    box.id = 'suggestionBox';
    box.style.position = 'absolute';
    box.style.background = '#fff';
    box.style.border = '1px solid #ccc';
    box.style.borderRadius = '6px';
    box.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
    box.style.maxHeight = '150px';
    box.style.overflowY = 'auto';
    box.style.zIndex = '1000';
    document.getElementById('itemName').parentNode.appendChild(box);
  }

  box.innerHTML = '';
  if (!value) {
    box.style.display = 'none';
    return;
  }

  const matches = laborCostList.filter(item =>
    item.name.toLowerCase().includes(value)
  );

  if (matches.length === 0) {
    box.style.display = 'none';
    return;
  }

  matches.forEach(item => {
    const option = document.createElement('div');
    option.innerHTML = `
      <small style="color: #64748b;"><strong>Code:</strong> ${item.costCode || '-'}</small><br>
      <strong>${item.name}</strong><br>
      <small>${item.description}</small>
    `;
    option.style.padding = '8px';
    option.style.cursor = 'pointer';
    option.style.borderBottom = '1px solid #eee';

    option.onmouseenter = () => (option.style.background = '#f1f5f9');
    option.onmouseleave = () => (option.style.background = '#fff');

    option.onclick = () => {
      document.getElementById('itemName').value = item.name;
      document.getElementById('itemDesc').value = item.description;
      // ‚úÖ No longer touching the unit price (itemPrice)
      if (document.getElementById('itemCostCode')) {
        document.getElementById('itemCostCode').value = item.costCode || 'Uncategorized';
      }
      box.style.display = 'none';
    };

    box.appendChild(option);
  });

  // Correct positioning
  const rect = input.getBoundingClientRect();
  box.style.top = `${input.offsetTop + input.offsetHeight}px`;
  box.style.left = `${input.offsetLeft}px`;
  box.style.width = `${input.offsetWidth}px`;
  box.style.display = 'block';
}





// Add manual item (auto-includes cost code now!)
function addManualItem() {
  const item = {
    costCode: document.getElementById('itemCostCode').value.trim() || "Uncategorized",
    name: document.getElementById('itemName').value.trim(),
    description: document.getElementById('itemDesc').value.trim(),
    quantity: Number(document.getElementById('itemQty').value),
    unitPrice: Number(document.getElementById('itemPrice').value)
  };

  
  
  addItemToTable(item, false);

  // Clear input fields
  document.getElementById('itemCostCode').value = '';
  document.getElementById('itemName').value = '';
  document.getElementById('itemDesc').value = '';
  document.getElementById('itemQty').value = '';
  document.getElementById('itemPrice').value = '';
  
  const suggestionBox = document.getElementById('suggestionBox');
  if (suggestionBox) suggestionBox.style.display = 'none';

  showToast('‚úÖ Added manual line item.');
}




function addItemToTable(item, isImported = false) {
  const cleaned = {
    _id: item._id, // preserve unique line item ID
    name: item.name,
    description: item.description,
    quantity: Number(item.quantity) || 0,
    costCode: item.costCode || 'Uncategorized',
    unitPrice: parseFloat(item.unitPrice) || 0,
    total: isImported
      ? (typeof item.laborCost !== "undefined" ? parseFloat(item.laborCost) || 0 : 0)
      : (Number(item.quantity) * (parseFloat(item.unitPrice) || 0)),
    estimateId: item.estimateId || undefined, // <-- ADD
    itemId: item.itemId || item._id || undefined // <-- ADD (itemId or fallback to _id)
  };

  console.log(`‚úÖ Item Added - ${isImported ? "Imported" : "Manual"}:`, cleaned);
  lineItems.push(cleaned);
  renderLineItems();
}




function renderLineItems() {
  const tbody = document.getElementById('lineItemsTable');
  tbody.innerHTML = '';

  lineItems.forEach((item, index) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${item.costCode}</td>
      <td>${item.name}</td>
      <td>${item.description}</td>
      <td>${item.quantity}</td>
      <td>$${(parseFloat(item.total) || 0).toFixed(2)}</td>
      <td>
        <div class="dropdown">
          <button class="dropdown-btn">‚ãÆ</button>
          <div class="dropdown-content">
            <a href="#" onclick="editItem(${index})">Edit</a>
            <a href="#" onclick="deleteItem(${index})">Delete</a>
          </div>
        </div>
      </td>
    `;
    tbody.appendChild(row);
  });
}

  




    function editItem(index) {
      const item = lineItems[index];
      document.getElementById('itemCostCode').value = item.costCode;
      document.getElementById('itemName').value = item.name;
      document.getElementById('itemDesc').value = item.description;
      document.getElementById('itemQty').value = item.quantity;
      document.getElementById('itemPrice').value = item.unitPrice;
      deleteItem(index);
      showToast('Editing item ‚Äî re-enter details.');
        // ‚úÖ Scroll smoothly to the manual entry section
  const manualEntrySection = document.getElementById('itemName');
  if (manualEntrySection) {
    manualEntrySection.scrollIntoView({ behavior: 'smooth', block: 'center' });
    setTimeout(() => {
      manualEntrySection.focus(); // After scrolling, focus the input
    }, 400); // slight delay to ensure scroll completes
  }
    }

    
    function deleteItem(index) {
      lineItems.splice(index, 1);
      renderLineItems();
      showToast('Deleted item.');
    }


    async function fetchVendorName() {
  const vendorId = localStorage.getItem("vendorId");
  if (!vendorId) return;

  try {
    const res = await fetch(`/api/vendors/${vendorId}`);
    if (!res.ok) throw new Error("Failed to fetch vendor");

    const vendor = await res.json();
    vendorName = vendor.name || "Unnamed Vendor";
  } catch (err) {
    console.error("‚ùå Error fetching vendor name:", err);
  }
}

function getSelectedProjectAddress() {
  const projectSelect = document.getElementById("projectSelect");
  const selectedOption = projectSelect.options[projectSelect.selectedIndex];
  return selectedOption?.dataset?.address || "N/A";
}


function openInvoicePreview(savedInvoice) {
  const projectAddress = getSelectedProjectAddress();
  const manualServiceAddress = document.getElementById('recipientAddress')?.value || 'N/A';
  const finalServiceAddress = projectAddress === 'N/A' ? manualServiceAddress : projectAddress;

  const projectName = document.getElementById('projectSelect').selectedOptions[0]?.text || 'Project Name';
  const email = document.getElementById('invoiceEmail').value || 'example@email.com';
  const invoiceNumber = savedInvoice?.invoiceNumber || 'N/A';
  const invoiceDate = savedInvoice?.date
    ? new Date(savedInvoice.date).toLocaleDateString()
    : 'N/A';

  // Get estimate title from savedInvoice or from the dropdown if not present
  let estimateTitle = savedInvoice?.estimateTitle;
  if (!estimateTitle) {
    const estimateSelect = document.getElementById('estimateSelect');
    const selectedEstimateOption = estimateSelect?.options[estimateSelect.selectedIndex];
    estimateTitle = selectedEstimateOption ? selectedEstimateOption.textContent : '';
  }

  // üëá Use item.total (which is laborCost for imported items)
  const total = lineItems.reduce((sum, i) => sum + (parseFloat(i.total) || 0), 0);
  const tax = 0;
  const grandTotal = total + tax;

  const preview = document.getElementById('invoicePreviewContent');

  preview.innerHTML = `
    <div style="font-family: 'Segoe UI', sans-serif; padding: 24px 0 0 0;">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap;">
        <div>
          <h2 style="color: #007bff; margin: 0;"><strong>Subcontractor Name:</strong> ${vendorName}</h2>
          <div style="margin-bottom: 8px;">
            <strong>Project:</strong> <span>${projectName}</span>
          </div>
          <div style="margin-bottom: 8px;">
            <strong>Service Address:</strong> <span>${finalServiceAddress}</span>
          </div>
           <div style="margin-bottom: 8px;">
            <strong>Estimate:</strong> <span>${estimateTitle || 'N/A'}</span>
          </div>
        </div>
        <div style="text-align: right;">
          <div style="margin-bottom: 8px;">
            <strong>Invoice #:</strong> <span>${invoiceNumber}</span>
          </div>
          <div style="margin-bottom: 8px;">
            <strong>Date:</strong> <span>${invoiceDate}</span>
          </div>
        </div>
      </div>
      <hr style="margin: 18px 0 18px 0; border-color: #e5e7eb;" />

      <h3>Line Items</h3>
      <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <thead>
          <tr style="background: #f0f4f8;">
            <th style="border: 1px solid #ccc; padding: 10px;">COST CODE</th>
            <th style="border: 1px solid #ccc; padding: 10px;">ITEM</th>
            <th style="border: 1px solid #ccc; padding: 10px;">DESCRIPTION</th>
            <th style="border: 1px solid #ccc; padding: 10px;">QUANTITY</th>
            <th style="border: 1px solid #ccc; padding: 10px;">TOTAL</th>
          </tr>
        </thead>
        <tbody>
          ${lineItems.map(item => {
            const unitPrice = parseFloat(item.unitPrice) || 0;
            const total = (parseFloat(item.total) || 0).toFixed(2); // Always use .total
            return `
              <tr>
                <td style="border: 1px solid #ccc; padding: 8px;">${item.costCode || 'N/A'}</td>
                <td style="border: 1px solid #ccc; padding: 8px;">${item.name}</td>
                <td style="border: 1px solid #ccc; padding: 8px;">${item.description}</td>
                <td style="border: 1px solid #ccc; padding: 8px;">${item.quantity}</td>
                <td style="border: 1px solid #ccc; padding: 8px;">$${(
                  typeof item.total !== "undefined"
                    ? parseFloat(item.total)
                    : (typeof item.laborCost !== "undefined"
                        ? parseFloat(item.laborCost)
                        : (parseFloat(item.unitPrice) * parseFloat(item.quantity) || 0))
                ).toFixed(2)}</td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>

      <div style="margin-top: 30px; border: 1px solid #ccc; border-radius: 10px; padding: 20px; background: #f9fbfd;">
        <h3>Summary</h3>
        <p><strong>Subtotal:</strong> $${total.toFixed(2)}</p>
        <p><strong>Tax:</strong> $${tax.toFixed(2)}</p>
        <p><strong style="font-size: 18px;">Total:</strong> <span style="color: #007bff; font-weight: bold;">$${grandTotal.toFixed(2)}</span></p>
      </div>
    </div>
  `;

  document.getElementById('invoiceModal').style.display = 'flex';
}




function closeInvoicePreview() {
  document.getElementById('invoiceModal').style.display = 'none';
}

function printInvoice() {
  const modalContent = document.querySelector('#invoiceModal .modal-content');
  const clonedContent = modalContent.cloneNode(true);

  // Remove buttons and close modal icons
  const toRemove = clonedContent.querySelectorAll('.no-print, .close-modal, #printBtn');
  toRemove.forEach(el => el.remove());

  let printContainer = document.getElementById('print-container');
  if (!printContainer) {
    printContainer = document.createElement('div');
    printContainer.id = 'print-container';
    document.body.appendChild(printContainer);
  }

  printContainer.innerHTML = '';
  printContainer.appendChild(clonedContent);

  const style = document.createElement('style');
  style.textContent = `
    @media print {
      html, body {
        margin: 0;
        padding: 0;
        overflow: visible;
      }

      body * {
        visibility: hidden;
      }

      #print-container, #print-container * {
        visibility: visible;
      }

      #print-container {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        padding: 20px;
        background: white;
        z-index: 9999;
      }

      #print-container .modal-content {
        width: 100% !important;
        max-width: 80% !important;
        box-shadow: none !important;
        overflow: visible !important;
      }

      #print-container table {
        width: 100% !important;
        table-layout: fixed !important;
        border-collapse: collapse !important;
      }

      #print-container th,
      #print-container td {
        font-size: 12pt;
        padding: 5px;
        word-break: break-word;
        white-space: normal !important;
      }

      #print-container th {
        white-space: nowrap !important;
        font-size: 11pt;
      }

      /* ‚úÖ Final column widths adjusted for 6 columns */
      #print-container th:nth-child(1),
      #print-container td:nth-child(1) {
        width: 16%;
      }

      #print-container th:nth-child(2),
      #print-container td:nth-child(2) {
        width: 24%;
      }

      #print-container th:nth-child(3),
      #print-container td:nth-child(3) {
        width: 24%;
      }

      #print-container th:nth-child(4),
      #print-container td:nth-child(4) {
        width: 8%;
      }

      #print-container th:nth-child(5),
      #print-container td:nth-child(5) {
        width: 14%;
      }

      #print-container th:nth-child(6),
      #print-container td:nth-child(6) {
        width: 14%;
      }

      @page {
        margin: 12mm;
      }

      header, footer {
        display: none !important;
      }
    }
  `;
  document.head.appendChild(style);

  setTimeout(() => {
    window.print();
    setTimeout(() => {
      document.head.removeChild(style);
      printContainer.remove();
    }, 500);
  }, 200);
}








document.addEventListener("DOMContentLoaded", () => {
  const dateInput = document.getElementById("invoiceDate");
  if (dateInput && !dateInput.value) {
    const today = new Date().toISOString().split("T")[0];
    dateInput.value = today;
  }
});





function generateInvoiceNumber() {
  const randomNum = Math.floor(1000 + Math.random() * 9000); // 4-digit random number
  const today = new Date();
  const dateSuffix = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
  return `INV-${randomNum}-${dateSuffix}`; // Result: INV-3842-20250327
}



async function submitInvoice() {
  const vendorId = localStorage.getItem('vendorId');
  const inputDate = document.getElementById('invoiceDate').value;
  const todayISO = new Date().toISOString();
  const invoiceDate = inputDate || todayISO;

  // Ensure each line item has a total property and includes estimateId/itemId
  const lineItemsWithTotal = lineItems.map(item => ({
    ...item,
    total: typeof item.total !== "undefined"
      ? Number(item.total)
      : (typeof item.laborCost !== "undefined"
          ? Number(item.laborCost)
          : (Number(item.quantity) * (parseFloat(item.unitPrice) || 0))),
    estimateId: item.estimateId || undefined, // <-- ADD
    itemId: item.itemId || item._id || undefined // <-- ADD
  }));

  const invoiceData = {
    vendorId,
    projectId: document.getElementById('projectSelect').value,
    email: document.getElementById('invoiceEmail').value || "jleonel3915@gmail.com",
    invoiceNumber: generateInvoiceNumber(),
    date: invoiceDate,
    lineItems: lineItemsWithTotal, // <-- use the new array
    total: lineItemsWithTotal.reduce((sum, i) => sum + (parseFloat(i.total) || 0), 0),
    from: {
      company: document.getElementById('companyName').value,
      address: document.getElementById('companyAddress').value,
      cityZip: document.getElementById('companyCityZip').value,
      phoneFax: document.getElementById('companyPhoneFax').value,
    },
    to: {
      company: document.getElementById('recipientCompany').value
    }
  };

  if (!invoiceData.projectId || !lineItems.length) {
    showToast('‚ùå Please select a project and add at least one line item.');
    return;
  }
  showLoader(); // üëà START
  try {
    // ‚úÖ 1. Save invoice to backend
    const res = await fetch('/api/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(invoiceData)
    });

    if (!res.ok) throw new Error('Failed to save invoice');
    const savedInvoice = await res.json();
    console.log("‚úÖ Saved Invoice:", savedInvoice);

    // ‚úÖ 2. Render preview content so it's visible and populated
    openInvoicePreview(savedInvoice); // Pass actual saved data
    await new Promise(resolve => setTimeout(resolve, 400)); // Wait for layout/paint

    const invoiceModal = document.getElementById('invoiceModal');
    const invoiceContent = document.getElementById('invoicePreviewContent');
    const buttonsToHide = invoiceContent.querySelectorAll('.no-print');
    invoiceModal.style.display = 'flex';

    // ‚úÖ Hide UI buttons temporarily
    buttonsToHide.forEach(el => el.style.display = 'none');

    // ‚úÖ Flush layout to avoid Safari bugs
    invoiceContent.scrollTop = 0;
    window.scrollTo(0, 0);
    await new Promise(resolve => setTimeout(resolve, 300));

    // ‚úÖ 3. Generate PDF blob
    const opt = {
      margin: 0.5,
      filename: `${savedInvoice.invoiceNumber}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: {
        scale: 2,
        useCORS: true,
        scrollY: 0,
        scrollX: 0,
        windowWidth: document.body.scrollWidth,
        windowHeight: document.body.scrollHeight
      },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };

    const pdfBlob = await html2pdf().from(invoiceContent).set(opt).outputPdf('blob');

    // ‚úÖ Restore hidden buttons
    buttonsToHide.forEach(el => el.style.display = 'block');

    const pdfFile = new File([pdfBlob], `${savedInvoice.invoiceNumber}.pdf`, {
      type: 'application/pdf',
      lastModified: Date.now()
    });

    if (!pdfFile || !pdfFile.size) {
      showToast("‚ùå PDF generation failed");
      return;
    }

    // ‚úÖ 4. Send email with PDF attached
    const formData = new FormData();
    formData.append('invoiceId', savedInvoice._id);
    formData.append('email', invoiceData.email);
    formData.append('pdf', pdfFile);

    const sendRes = await fetch('/api/send', {
      method: 'POST',
      body: formData
    });

    if (!sendRes.ok) throw new Error('Failed to send invoice email');

    // ‚úÖ 5. Final UI updates
    showToast('‚úÖ Invoice submitted!');
    displayInvoiceHistory(invoiceData);
    lineItems = [];
    renderLineItems();
    closeInvoicePreview();
  } catch (err) {
    showToast('‚ùå Error submitting invoice.');
    console.error("‚ùå submitInvoice() Error:", err);
  } finally {
    hideLoader(); // üëà END
  }
}







async function fetchInvoiceHistory(vendorId) {
  showLoader(); // üëà START
  try {
    const res = await fetch(`/history?vendorId=${vendorId}`);
    const data = await res.json();
    data.forEach(displayInvoiceHistory);
  } catch (err) {
    console.error('Error loading history:', err);
  } finally {
    hideLoader(); // üëà END
  }
}




    async function displayInvoiceHistory(invoice) {
  const row = document.createElement('tr');

  let projectAddress = 'N/A';

  if (typeof invoice.projectId === 'object' && invoice.projectId.address) {
    const a = invoice.projectId.address;
    projectAddress = `${a.addressLine1 || ''}, ${a.city || ''}, ${a.state || ''}, ${a.zip || ''}`;
  } else if (typeof invoice.projectId === 'string') {
    try {
      const res = await fetch(`/api/projects/${invoice.projectId}`);
      if (res.ok) {
        const { project } = await res.json();
        const a = project.address || {};
        projectAddress = `${a.addressLine1 || ''}, ${a.city || ''}, ${a.state || ''}, ${a.zip || ''}`;
      }
    } catch (err) {
      console.error('‚ùå Failed to fetch project:', err);
    }
  }

  const formattedDate = invoice.date
    ? new Date(invoice.date).toLocaleDateString()
    : 'N/A';

  row.innerHTML = `
    <td>
      <a href="#" onclick="openSavedInvoiceModal('${invoice.invoiceNumber}')" style="color: #007bff; text-decoration: underline;">
        ${invoice.invoiceNumber || 'N/A'}
      </a>
    </td>
    <td>${projectAddress}</td>
    <td>${formattedDate}</td>
    <td>$${invoice.total.toFixed(2)}</td>
    <td>
      <div class="dropdown">
        <button class="dropdown-btn">‚ãÆ</button>
        <div class="dropdown-content">
          <a href="#" onclick="openSavedInvoiceModal('${invoice.invoiceNumber}')">View</a>
          <a href="#" onclick="deleteInvoice('${invoice._id}', this)">Delete</a>
        </div>
      </div>
    </td>
  `;

  document.getElementById('invoiceHistoryTable').prepend(row);
}



document.addEventListener('click', function(e) {
  document.querySelectorAll('.dropdown').forEach(drop => {
    if (drop.contains(e.target)) {
      drop.classList.toggle('open');
    } else {
      drop.classList.remove('open');
    }
  });
});


let currentSort = { column: null, direction: 1 };

document.querySelectorAll('th[data-sort]').forEach(header => {
  header.addEventListener('click', () => {
    const column = header.getAttribute('data-sort');
    const rows = Array.from(document.querySelectorAll('#invoiceHistoryTable tr'));

    // Toggle sort direction
    if (currentSort.column === column) {
      currentSort.direction *= -1;
    } else {
      currentSort.column = column;
      currentSort.direction = 1;
    }

    // Determine column index
    const colIndex = Array.from(header.parentElement.children).indexOf(header);

    // Sort rows
    rows.sort((a, b) => {
      const cellA = a.children[colIndex].textContent.trim();
      const cellB = b.children[colIndex].textContent.trim();

      // Try numeric sort first
      const numA = parseFloat(cellA.replace(/[^0-9.]/g, ''));
      const numB = parseFloat(cellB.replace(/[^0-9.]/g, ''));
      if (!isNaN(numA) && !isNaN(numB)) {
        return (numA - numB) * currentSort.direction;
      }

      // Fallback: string sort
      return cellA.localeCompare(cellB) * currentSort.direction;
    });

    // Re-append sorted rows
    const tbody = document.getElementById('invoiceHistoryTable');
    rows.forEach(row => tbody.appendChild(row));

    // Visual indicator (optional)
    document.querySelectorAll('.sort-indicator').forEach(i => i.textContent = '');
    header.querySelector('.sort-indicator').textContent = currentSort.direction === 1 ? '‚ñ≤' : '‚ñº';
  });
});


async function openSavedInvoiceModal(invoiceNumber) {
  const preview = document.getElementById('invoicePreviewContent');
  showLoader(); // üëà START
  try {
    const res = await fetch(`/api/invoices/by-number/${invoiceNumber}`);
    if (!res.ok) throw new Error("Failed to fetch invoice");
    const { invoice } = await res.json();

    let projectName = 'Unnamed Project';
    let projectAddress = 'N/A';

    if (invoice.projectId) {
      const projectRes = await fetch(`/api/projects/${invoice.projectId}`);
      if (projectRes.ok) {
        const { project } = await projectRes.json();
        const a = project.address || {};
        projectAddress = `${a.addressLine1 || ''}, ${a.city || ''}, ${a.state || ''}, ${a.zip || ''}`;
        projectName = project.name || 'Unnamed Project';
      }
    }

    let vendorName = "Vendor";
    if (invoice.vendorId) {
      const vendorRes = await fetch(`/api/vendors/${invoice.vendorId}`);
      if (vendorRes.ok) {
        const vendorData = await vendorRes.json();
        vendorName = vendorData.name || vendorData.vendor?.name || "Vendor";
      }
    }

    const displayDate = invoice.date
      ? new Date(invoice.date).toLocaleDateString(undefined, {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        })
      : "N/A";

    const total = invoice.total.toFixed(2);
    const tax = 0;
    const grandTotal = (invoice.total + tax).toFixed(2);

    preview.innerHTML = `
      <div style="font-family: 'Segoe UI', sans-serif; padding: 0px;">
        <h2 style="color: #007bff; margin-bottom: 30px;">Invoice</h2>
        <h2 style="color: #007bff; margin: 0;"><strong>Subcontractor Name:</strong> ${vendorName}</h2>
        <p><strong>Service Address:</strong> ${projectAddress}</p>
        <p><strong>Project Name:</strong> ${projectName}</p>
        <p><strong>Invoice #:</strong> ${invoice.invoiceNumber}</p>
        <p><strong>Date:</strong> ${displayDate}</p>
        <hr style="margin: 5px 0; border-color: #ccc;" />

        <h3>Line Items</h3>
        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
          <thead>
            <tr style="background: #f0f4f8;">
              <th style="border: 1px solid #ccc; padding: 10px;">COST CODE</th>
              <th style="border: 1px solid #ccc; padding: 10px;">ITEM</th>
              <th style="border: 1px solid #ccc; padding: 10px;">DESCRIPTION</th>
              <th style="border: 1px solid #ccc; padding: 10px;">Qty</th>
             
              <th style="border: 1px solid #ccc; padding: 10px;">TOTAL</th>
            </tr>
          </thead>
<tbody>
  ${invoice.lineItems.map(item => `
    <tr>
      <td style="border: 1px solid #ccc; padding: 8px;">${item.costCode || 'N/A'}</td>
      <td style="border: 1px solid #ccc; padding: 8px;">${item.name}</td>
      <td style="border: 1px solid #ccc; padding: 8px;">${item.description}</td>
      <td style="border: 1px solid #ccc; padding: 8px;">${item.quantity}</td>
      
      <td style="border: 1px solid #ccc; padding: 8px;">$${(parseFloat(item.total) || 0).toFixed(2)}</td>
    </tr>
  `).join('')}
</tbody>
        </table>

        <div style="margin-top: 30px; border: 1px solid #ccc; border-radius: 10px; padding: 20px; background: #f9fbfd;">
          <h3>Summary</h3>
          <p><strong>Subtotal:</strong> $${total}</p>
          <p><strong>Tax:</strong> $${tax.toFixed(2)}</p>
          <p><strong style="font-size: 18px;">Total:</strong> <span style="color: #007bff; font-weight: bold;">$${grandTotal}</span></p>
        </div>
      </div>

      <div class="modal-footer no-print" style="text-align: right; margin-top: 20px;">
        <button class="btn" onclick="printInvoice()">üñ®Ô∏è Print Invoice</button>
        <button class="btn" onclick="shareInvoice('${invoice.invoiceNumber}')">üîó Share</button>
      </div>
    `;

    document.getElementById('invoiceModal').style.display = 'flex';

  } catch (err) {
    console.error("‚ùå Error displaying saved invoice:", err);
    preview.innerHTML = "<p style='color:red;'>Failed to load invoice.</p>";
  } finally {
    hideLoader(); // üëà END
  }
}




async function shareInvoice(invoiceNumber) {
  const invoiceModal = document.getElementById('invoiceModal');
  const invoiceContent = document.querySelector('#invoicePreviewContent');
  const buttonsToHide = invoiceContent.querySelectorAll('.no-print');

  if (!invoiceContent) {
    showToast("‚ùå Invoice content not found");
    return;
  }

  // Ensure modal is visible
  invoiceModal.style.display = 'flex';

  // Hide print/share buttons
  buttonsToHide.forEach(el => el.style.display = 'none');

  // Force repaint and scroll to top before rendering (helps iOS/Safari)
  await new Promise(resolve => requestAnimationFrame(resolve));
  invoiceContent.scrollTop = 0;
  window.scrollTo(0, 0);

  // Extra delay to allow layout recalculation
  await new Promise(resolve => setTimeout(resolve, 300));

  try {
    const opt = {
      margin: 0.5,
      filename: `${invoiceNumber}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: {
        scale: 2,
        useCORS: true,
        scrollY: 0,
        scrollX: 0,
        windowWidth: document.body.scrollWidth,
        windowHeight: document.body.scrollHeight
      },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };

    const pdfBlob = await html2pdf().from(invoiceContent).set(opt).outputPdf('blob');
    const file = new File([pdfBlob], `${invoiceNumber}.pdf`, { type: 'application/pdf' });

    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      await navigator.share({
        title: `Invoice: ${invoiceNumber}`,
        text: `Please find attached invoice ${invoiceNumber}`,
        files: [file]
      });
      showToast("‚úÖ Invoice shared as PDF");
    } else {
      html2pdf().from(invoiceContent).set(opt).save();
      showToast("üìÑ Invoice downloaded (file sharing not supported)");
    }
  } catch (err) {
    console.error("‚ùå Error sharing invoice:", err);
    showToast("‚ùå Could not share invoice");
  } finally {
    // Restore hidden buttons
    buttonsToHide.forEach(el => el.style.display = 'block');
  }
}









function closeInvoicePreview() {
  document.getElementById('invoiceModal').style.display = 'none';
}

async function fetchVendorNameAndAutofill() {
  const vendorId = localStorage.getItem("vendorId");
  if (!vendorId) return;

  try {
    const res = await fetch(`/api/vendors/${vendorId}`);
    if (!res.ok) throw new Error("Failed to fetch vendor info");

    const data = await res.json();
    console.log("üë§ Vendor Response:", data);

    const vendor = data.vendor || data; // fallback in case it returns vendor directly
    document.getElementById("companyName").value = vendor.name || "Vendor";

  } catch (err) {
    console.error("‚ùå Error fetching vendor:", err);
  }
}


async function deleteInvoice(invoiceId, element) {
  if (!confirm("Are you sure you want to delete this invoice?")) return;
  showLoader(); // üëà START
  try {
    const res = await fetch(`/api/invoices/${invoiceId}`, {
      method: "DELETE",
    });

    if (!res.ok) throw new Error("Failed to delete");

    // Remove row from table
    const row = element.closest("tr");
    row.remove();

    showToast("‚úÖ Invoice deleted.");
  } catch (err) {
    console.error("Error deleting invoice:", err);
    showToast("‚ùå Failed to delete invoice.");
  } finally {
    hideLoader(); // üëà END
  }
}


// Floating Help Button Logic
document.getElementById('help-fab').onclick = function() {
  document.getElementById('helpModal').style.display = 'flex';
  document.getElementById('helpOptions').style.display = 'block';
  document.getElementById('helpVideoContainer').style.display = 'none';
};

function closeHelpModal() {
  document.getElementById('helpModal').style.display = 'none';
  // Pause video if open
  const vid = document.getElementById('helpVideo');
  if (vid) vid.pause();
}

function showHelpVideo(type) {
  const videoMap = {
    import: '/files/submmit.mp4', // Replace with your actual video URL
    submit: 'files/submmit.mp4'    // Replace with your actual video URL
  };
  document.getElementById('helpOptions').style.display = 'none';
  document.getElementById('helpVideoContainer').style.display = 'block';
  const vid = document.getElementById('helpVideo');
  const src = document.getElementById('helpVideoSource');
  src.src = videoMap[type] || '';
  vid.load();
  vid.play();
}

function closeHelpVideo() {
  document.getElementById('helpOptions').style.display = 'block';
  document.getElementById('helpVideoContainer').style.display = 'none';
  const vid = document.getElementById('helpVideo');
  if (vid) vid.pause();
}
  </script>
</body>
</html>


